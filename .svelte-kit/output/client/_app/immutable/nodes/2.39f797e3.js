import{s as Vr,n as sr,e as _n,f as _s,b as sa,r as Mu,h as Ql,i as Wl,o as xT,j as sP,k as aP}from"../chunks/scheduler.ebeace2f.js";import{S as jr,i as Gr,g as gt,h as yt,j as vt,f as nt,k as tt,l as xe,a as hi,y as ur,e as Go,z as Qn,A as tr,B as or,x as W,m as qe,s as me,r as Zi,H as rc,n as Ze,c as _e,C as Ur,u as Hi,D as oc,v as Wi,o as Ai,d as wi,t as Mi,w as $i,E as mo,p as of,b as sf,F as bT,G as aa,I as Ha,J as Nd,K as $l}from"../chunks/index.42fb1a3d.js";import{w as pr,r as Eu,d as Su}from"../chunks/index.e813bca0.js";function Yn(f){return(f==null?void 0:f.length)!==void 0?f:Array.from(f)}let tc=pr("999999"),F_=pr(""),wT=pr("asdf"),Y_=pr("100043587"),lP=pr(""),K_=pr("Select a counter to begin."),TT=pr(!0),cP=pr(""),MT=pr(""),ET=pr("");function Ud(f,m){return f==null||m==null?NaN:f<m?-1:f>m?1:f>=m?0:NaN}function uP(f,m){return f==null||m==null?NaN:m<f?-1:m>f?1:m>=f?0:NaN}function ug(f){let m,v,w;f.length!==2?(m=Ud,v=(P,I)=>Ud(f(P),I),w=(P,I)=>f(P)-I):(m=f===Ud||f===uP?f:hP,v=f,w=f);function A(P,I,B=0,V=P.length){if(B<V){if(m(I,I)!==0)return V;do{const j=B+V>>>1;v(P[j],I)<0?B=j+1:V=j}while(B<V)}return B}function C(P,I,B=0,V=P.length){if(B<V){if(m(I,I)!==0)return V;do{const j=B+V>>>1;v(P[j],I)<=0?B=j+1:V=j}while(B<V)}return B}function k(P,I,B=0,V=P.length){const j=A(P,I,B,V-1);return j>B&&w(P[j-1],I)>-w(P[j],I)?j-1:j}return{left:A,center:k,right:C}}function hP(){return 0}function dP(f){return f===null?NaN:+f}const fP=ug(Ud),pP=fP.right;ug(dP).center;const mP=pP;function _P(f,m){let v,w;if(m===void 0)for(const A of f)A!=null&&(v===void 0?A>=A&&(v=w=A):(v>A&&(v=A),w<A&&(w=A)));else{let A=-1;for(let C of f)(C=m(C,++A,f))!=null&&(v===void 0?C>=C&&(v=w=C):(v>C&&(v=C),w<C&&(w=C)))}return[v,w]}class l2 extends Map{constructor(m,v=vP){if(super(),Object.defineProperties(this,{_intern:{value:new Map},_key:{value:v}}),m!=null)for(const[w,A]of m)this.set(w,A)}get(m){return super.get(c2(this,m))}has(m){return super.has(c2(this,m))}set(m,v){return super.set(gP(this,m),v)}delete(m){return super.delete(yP(this,m))}}function c2({_intern:f,_key:m},v){const w=m(v);return f.has(w)?f.get(w):v}function gP({_intern:f,_key:m},v){const w=m(v);return f.has(w)?f.get(w):(f.set(w,v),v)}function yP({_intern:f,_key:m},v){const w=m(v);return f.has(w)&&(v=f.get(w),f.delete(w)),v}function vP(f){return f!==null&&typeof f=="object"?f.valueOf():f}const xP=Math.sqrt(50),bP=Math.sqrt(10),wP=Math.sqrt(2);function Wd(f,m,v){const w=(m-f)/Math.max(0,v),A=Math.floor(Math.log10(w)),C=w/Math.pow(10,A),k=C>=xP?10:C>=bP?5:C>=wP?2:1;let P,I,B;return A<0?(B=Math.pow(10,-A)/k,P=Math.round(f*B),I=Math.round(m*B),P/B<f&&++P,I/B>m&&--I,B=-B):(B=Math.pow(10,A)*k,P=Math.round(f/B),I=Math.round(m/B),P*B<f&&++P,I*B>m&&--I),I<P&&.5<=v&&v<2?Wd(f,m,v*2):[P,I,B]}function TP(f,m,v){if(m=+m,f=+f,v=+v,!(v>0))return[];if(f===m)return[f];const w=m<f,[A,C,k]=w?Wd(m,f,v):Wd(f,m,v);if(!(C>=A))return[];const P=C-A+1,I=new Array(P);if(w)if(k<0)for(let B=0;B<P;++B)I[B]=(C-B)/-k;else for(let B=0;B<P;++B)I[B]=(C-B)*k;else if(k<0)for(let B=0;B<P;++B)I[B]=(A+B)/-k;else for(let B=0;B<P;++B)I[B]=(A+B)*k;return I}function J_(f,m,v){return m=+m,f=+f,v=+v,Wd(f,m,v)[2]}function Q_(f,m,v){m=+m,f=+f,v=+v;const w=m<f,A=w?J_(m,f,v):J_(f,m,v);return(w?-1:1)*(A<0?1/-A:A)}function MP(f,m){let v;if(m===void 0)for(const w of f)w!=null&&(v<w||v===void 0&&w>=w)&&(v=w);else{let w=-1;for(let A of f)(A=m(A,++w,f))!=null&&(v<A||v===void 0&&A>=A)&&(v=A)}return v}function hg(f,m,v){f.prototype=m.prototype=v,v.constructor=f}function ST(f,m){var v=Object.create(f.prototype);for(var w in m)v[w]=m[w];return v}function Au(){}var vu=.7,$d=1/vu,Kl="\\s*([+-]?\\d+)\\s*",xu="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)\\s*",jo="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)%\\s*",EP=/^#([0-9a-f]{3,8})$/,SP=new RegExp(`^rgb\\(${Kl},${Kl},${Kl}\\)$`),AP=new RegExp(`^rgb\\(${jo},${jo},${jo}\\)$`),IP=new RegExp(`^rgba\\(${Kl},${Kl},${Kl},${xu}\\)$`),CP=new RegExp(`^rgba\\(${jo},${jo},${jo},${xu}\\)$`),DP=new RegExp(`^hsl\\(${xu},${jo},${jo}\\)$`),PP=new RegExp(`^hsla\\(${xu},${jo},${jo},${xu}\\)$`),u2={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074};hg(Au,bu,{copy(f){return Object.assign(new this.constructor,this,f)},displayable(){return this.rgb().displayable()},hex:h2,formatHex:h2,formatHex8:kP,formatHsl:zP,formatRgb:d2,toString:d2});function h2(){return this.rgb().formatHex()}function kP(){return this.rgb().formatHex8()}function zP(){return AT(this).formatHsl()}function d2(){return this.rgb().formatRgb()}function bu(f){var m,v;return f=(f+"").trim().toLowerCase(),(m=EP.exec(f))?(v=m[1].length,m=parseInt(m[1],16),v===6?f2(m):v===3?new kr(m>>8&15|m>>4&240,m>>4&15|m&240,(m&15)<<4|m&15,1):v===8?Ld(m>>24&255,m>>16&255,m>>8&255,(m&255)/255):v===4?Ld(m>>12&15|m>>8&240,m>>8&15|m>>4&240,m>>4&15|m&240,((m&15)<<4|m&15)/255):null):(m=SP.exec(f))?new kr(m[1],m[2],m[3],1):(m=AP.exec(f))?new kr(m[1]*255/100,m[2]*255/100,m[3]*255/100,1):(m=IP.exec(f))?Ld(m[1],m[2],m[3],m[4]):(m=CP.exec(f))?Ld(m[1]*255/100,m[2]*255/100,m[3]*255/100,m[4]):(m=DP.exec(f))?_2(m[1],m[2]/100,m[3]/100,1):(m=PP.exec(f))?_2(m[1],m[2]/100,m[3]/100,m[4]):u2.hasOwnProperty(f)?f2(u2[f]):f==="transparent"?new kr(NaN,NaN,NaN,0):null}function f2(f){return new kr(f>>16&255,f>>8&255,f&255,1)}function Ld(f,m,v,w){return w<=0&&(f=m=v=NaN),new kr(f,m,v,w)}function LP(f){return f instanceof Au||(f=bu(f)),f?(f=f.rgb(),new kr(f.r,f.g,f.b,f.opacity)):new kr}function tg(f,m,v,w){return arguments.length===1?LP(f):new kr(f,m,v,w??1)}function kr(f,m,v,w){this.r=+f,this.g=+m,this.b=+v,this.opacity=+w}hg(kr,tg,ST(Au,{brighter(f){return f=f==null?$d:Math.pow($d,f),new kr(this.r*f,this.g*f,this.b*f,this.opacity)},darker(f){return f=f==null?vu:Math.pow(vu,f),new kr(this.r*f,this.g*f,this.b*f,this.opacity)},rgb(){return this},clamp(){return new kr(Za(this.r),Za(this.g),Za(this.b),Xd(this.opacity))},displayable(){return-.5<=this.r&&this.r<255.5&&-.5<=this.g&&this.g<255.5&&-.5<=this.b&&this.b<255.5&&0<=this.opacity&&this.opacity<=1},hex:p2,formatHex:p2,formatHex8:RP,formatRgb:m2,toString:m2}));function p2(){return`#${qa(this.r)}${qa(this.g)}${qa(this.b)}`}function RP(){return`#${qa(this.r)}${qa(this.g)}${qa(this.b)}${qa((isNaN(this.opacity)?1:this.opacity)*255)}`}function m2(){const f=Xd(this.opacity);return`${f===1?"rgb(":"rgba("}${Za(this.r)}, ${Za(this.g)}, ${Za(this.b)}${f===1?")":`, ${f})`}`}function Xd(f){return isNaN(f)?1:Math.max(0,Math.min(1,f))}function Za(f){return Math.max(0,Math.min(255,Math.round(f)||0))}function qa(f){return f=Za(f),(f<16?"0":"")+f.toString(16)}function _2(f,m,v,w){return w<=0?f=m=v=NaN:v<=0||v>=1?f=m=NaN:m<=0&&(f=NaN),new po(f,m,v,w)}function AT(f){if(f instanceof po)return new po(f.h,f.s,f.l,f.opacity);if(f instanceof Au||(f=bu(f)),!f)return new po;if(f instanceof po)return f;f=f.rgb();var m=f.r/255,v=f.g/255,w=f.b/255,A=Math.min(m,v,w),C=Math.max(m,v,w),k=NaN,P=C-A,I=(C+A)/2;return P?(m===C?k=(v-w)/P+(v<w)*6:v===C?k=(w-m)/P+2:k=(m-v)/P+4,P/=I<.5?C+A:2-C-A,k*=60):P=I>0&&I<1?0:k,new po(k,P,I,f.opacity)}function OP(f,m,v,w){return arguments.length===1?AT(f):new po(f,m,v,w??1)}function po(f,m,v,w){this.h=+f,this.s=+m,this.l=+v,this.opacity=+w}hg(po,OP,ST(Au,{brighter(f){return f=f==null?$d:Math.pow($d,f),new po(this.h,this.s,this.l*f,this.opacity)},darker(f){return f=f==null?vu:Math.pow(vu,f),new po(this.h,this.s,this.l*f,this.opacity)},rgb(){var f=this.h%360+(this.h<0)*360,m=isNaN(f)||isNaN(this.s)?0:this.s,v=this.l,w=v+(v<.5?v:1-v)*m,A=2*v-w;return new kr(N_(f>=240?f-240:f+120,A,w),N_(f,A,w),N_(f<120?f+240:f-120,A,w),this.opacity)},clamp(){return new po(g2(this.h),Rd(this.s),Rd(this.l),Xd(this.opacity))},displayable(){return(0<=this.s&&this.s<=1||isNaN(this.s))&&0<=this.l&&this.l<=1&&0<=this.opacity&&this.opacity<=1},formatHsl(){const f=Xd(this.opacity);return`${f===1?"hsl(":"hsla("}${g2(this.h)}, ${Rd(this.s)*100}%, ${Rd(this.l)*100}%${f===1?")":`, ${f})`}`}}));function g2(f){return f=(f||0)%360,f<0?f+360:f}function Rd(f){return Math.max(0,Math.min(1,f||0))}function N_(f,m,v){return(f<60?m+(v-m)*f/60:f<180?v:f<240?m+(v-m)*(240-f)/60:m)*255}const dg=f=>()=>f;function BP(f,m){return function(v){return f+v*m}}function FP(f,m,v){return f=Math.pow(f,v),m=Math.pow(m,v)-f,v=1/v,function(w){return Math.pow(f+w*m,v)}}function NP(f){return(f=+f)==1?IT:function(m,v){return v-m?FP(m,v,f):dg(isNaN(m)?v:m)}}function IT(f,m){var v=m-f;return v?BP(f,v):dg(isNaN(f)?m:f)}const y2=function f(m){var v=NP(m);function w(A,C){var k=v((A=tg(A)).r,(C=tg(C)).r),P=v(A.g,C.g),I=v(A.b,C.b),B=IT(A.opacity,C.opacity);return function(V){return A.r=k(V),A.g=P(V),A.b=I(V),A.opacity=B(V),A+""}}return w.gamma=f,w}(1);function UP(f,m){m||(m=[]);var v=f?Math.min(m.length,f.length):0,w=m.slice(),A;return function(C){for(A=0;A<v;++A)w[A]=f[A]*(1-C)+m[A]*C;return w}}function VP(f){return ArrayBuffer.isView(f)&&!(f instanceof DataView)}function jP(f,m){var v=m?m.length:0,w=f?Math.min(v,f.length):0,A=new Array(w),C=new Array(v),k;for(k=0;k<w;++k)A[k]=fg(f[k],m[k]);for(;k<v;++k)C[k]=m[k];return function(P){for(k=0;k<w;++k)C[k]=A[k](P);return C}}function GP(f,m){var v=new Date;return f=+f,m=+m,function(w){return v.setTime(f*(1-w)+m*w),v}}function Yd(f,m){return f=+f,m=+m,function(v){return f*(1-v)+m*v}}function qP(f,m){var v={},w={},A;(f===null||typeof f!="object")&&(f={}),(m===null||typeof m!="object")&&(m={});for(A in m)A in f?v[A]=fg(f[A],m[A]):w[A]=m[A];return function(C){for(A in v)w[A]=v[A](C);return w}}var eg=/[-+]?(?:\d+\.?\d*|\.?\d+)(?:[eE][-+]?\d+)?/g,U_=new RegExp(eg.source,"g");function ZP(f){return function(){return f}}function HP(f){return function(m){return f(m)+""}}function WP(f,m){var v=eg.lastIndex=U_.lastIndex=0,w,A,C,k=-1,P=[],I=[];for(f=f+"",m=m+"";(w=eg.exec(f))&&(A=U_.exec(m));)(C=A.index)>v&&(C=m.slice(v,C),P[k]?P[k]+=C:P[++k]=C),(w=w[0])===(A=A[0])?P[k]?P[k]+=A:P[++k]=A:(P[++k]=null,I.push({i:k,x:Yd(w,A)})),v=U_.lastIndex;return v<m.length&&(C=m.slice(v),P[k]?P[k]+=C:P[++k]=C),P.length<2?I[0]?HP(I[0].x):ZP(m):(m=I.length,function(B){for(var V=0,j;V<m;++V)P[(j=I[V]).i]=j.x(B);return P.join("")})}function fg(f,m){var v=typeof m,w;return m==null||v==="boolean"?dg(m):(v==="number"?Yd:v==="string"?(w=bu(m))?(m=w,y2):WP:m instanceof bu?y2:m instanceof Date?GP:VP(m)?UP:Array.isArray(m)?jP:typeof m.valueOf!="function"&&typeof m.toString!="function"||isNaN(m)?qP:Yd)(f,m)}function $P(f,m){return f=+f,m=+m,function(v){return Math.round(f*(1-v)+m*v)}}const ig=Math.PI,ng=2*ig,Ga=1e-6,XP=ng-Ga;function CT(f){this._+=f[0];for(let m=1,v=f.length;m<v;++m)this._+=arguments[m]+f[m]}function YP(f){let m=Math.floor(f);if(!(m>=0))throw new Error(`invalid digits: ${f}`);if(m>15)return CT;const v=10**m;return function(w){this._+=w[0];for(let A=1,C=w.length;A<C;++A)this._+=Math.round(arguments[A]*v)/v+w[A]}}class KP{constructor(m){this._x0=this._y0=this._x1=this._y1=null,this._="",this._append=m==null?CT:YP(m)}moveTo(m,v){this._append`M${this._x0=this._x1=+m},${this._y0=this._y1=+v}`}closePath(){this._x1!==null&&(this._x1=this._x0,this._y1=this._y0,this._append`Z`)}lineTo(m,v){this._append`L${this._x1=+m},${this._y1=+v}`}quadraticCurveTo(m,v,w,A){this._append`Q${+m},${+v},${this._x1=+w},${this._y1=+A}`}bezierCurveTo(m,v,w,A,C,k){this._append`C${+m},${+v},${+w},${+A},${this._x1=+C},${this._y1=+k}`}arcTo(m,v,w,A,C){if(m=+m,v=+v,w=+w,A=+A,C=+C,C<0)throw new Error(`negative radius: ${C}`);let k=this._x1,P=this._y1,I=w-m,B=A-v,V=k-m,j=P-v,Q=V*V+j*j;if(this._x1===null)this._append`M${this._x1=m},${this._y1=v}`;else if(Q>Ga)if(!(Math.abs(j*I-B*V)>Ga)||!C)this._append`L${this._x1=m},${this._y1=v}`;else{let et=w-k,it=A-P,lt=I*I+B*B,_t=et*et+it*it,ht=Math.sqrt(lt),Bt=Math.sqrt(Q),dt=C*Math.tan((ig-Math.acos((lt+Q-_t)/(2*ht*Bt)))/2),It=dt/Bt,Wt=dt/ht;Math.abs(It-1)>Ga&&this._append`L${m+It*V},${v+It*j}`,this._append`A${C},${C},0,0,${+(j*et>V*it)},${this._x1=m+Wt*I},${this._y1=v+Wt*B}`}}arc(m,v,w,A,C,k){if(m=+m,v=+v,w=+w,k=!!k,w<0)throw new Error(`negative radius: ${w}`);let P=w*Math.cos(A),I=w*Math.sin(A),B=m+P,V=v+I,j=1^k,Q=k?A-C:C-A;this._x1===null?this._append`M${B},${V}`:(Math.abs(this._x1-B)>Ga||Math.abs(this._y1-V)>Ga)&&this._append`L${B},${V}`,w&&(Q<0&&(Q=Q%ng+ng),Q>XP?this._append`A${w},${w},0,1,${j},${m-P},${v-I}A${w},${w},0,1,${j},${this._x1=B},${this._y1=V}`:Q>Ga&&this._append`A${w},${w},0,${+(Q>=ig)},${j},${this._x1=m+w*Math.cos(C)},${this._y1=v+w*Math.sin(C)}`)}rect(m,v,w,A){this._append`M${this._x0=this._x1=+m},${this._y0=this._y1=+v}h${w=+w}v${+A}h${-w}Z`}toString(){return this._}}function JP(f){return Math.abs(f=Math.round(f))>=1e21?f.toLocaleString("en").replace(/,/g,""):f.toString(10)}function Kd(f,m){if((v=(f=m?f.toExponential(m-1):f.toExponential()).indexOf("e"))<0)return null;var v,w=f.slice(0,v);return[w.length>1?w[0]+w.slice(2):w,+f.slice(v+1)]}function ec(f){return f=Kd(Math.abs(f)),f?f[1]:NaN}function QP(f,m){return function(v,w){for(var A=v.length,C=[],k=0,P=f[0],I=0;A>0&&P>0&&(I+P+1>w&&(P=Math.max(1,w-I)),C.push(v.substring(A-=P,A+P)),!((I+=P+1)>w));)P=f[k=(k+1)%f.length];return C.reverse().join(m)}}function tk(f){return function(m){return m.replace(/[0-9]/g,function(v){return f[+v]})}}var ek=/^(?:(.)?([<>=^]))?([+\-( ])?([$#])?(0)?(\d+)?(,)?(\.\d+)?(~)?([a-z%])?$/i;function Jd(f){if(!(m=ek.exec(f)))throw new Error("invalid format: "+f);var m;return new pg({fill:m[1],align:m[2],sign:m[3],symbol:m[4],zero:m[5],width:m[6],comma:m[7],precision:m[8]&&m[8].slice(1),trim:m[9],type:m[10]})}Jd.prototype=pg.prototype;function pg(f){this.fill=f.fill===void 0?" ":f.fill+"",this.align=f.align===void 0?">":f.align+"",this.sign=f.sign===void 0?"-":f.sign+"",this.symbol=f.symbol===void 0?"":f.symbol+"",this.zero=!!f.zero,this.width=f.width===void 0?void 0:+f.width,this.comma=!!f.comma,this.precision=f.precision===void 0?void 0:+f.precision,this.trim=!!f.trim,this.type=f.type===void 0?"":f.type+""}pg.prototype.toString=function(){return this.fill+this.align+this.sign+this.symbol+(this.zero?"0":"")+(this.width===void 0?"":Math.max(1,this.width|0))+(this.comma?",":"")+(this.precision===void 0?"":"."+Math.max(0,this.precision|0))+(this.trim?"~":"")+this.type};function ik(f){t:for(var m=f.length,v=1,w=-1,A;v<m;++v)switch(f[v]){case".":w=A=v;break;case"0":w===0&&(w=v),A=v;break;default:if(!+f[v])break t;w>0&&(w=0);break}return w>0?f.slice(0,w)+f.slice(A+1):f}var DT;function nk(f,m){var v=Kd(f,m);if(!v)return f+"";var w=v[0],A=v[1],C=A-(DT=Math.max(-8,Math.min(8,Math.floor(A/3)))*3)+1,k=w.length;return C===k?w:C>k?w+new Array(C-k+1).join("0"):C>0?w.slice(0,C)+"."+w.slice(C):"0."+new Array(1-C).join("0")+Kd(f,Math.max(0,m+C-1))[0]}function v2(f,m){var v=Kd(f,m);if(!v)return f+"";var w=v[0],A=v[1];return A<0?"0."+new Array(-A).join("0")+w:w.length>A+1?w.slice(0,A+1)+"."+w.slice(A+1):w+new Array(A-w.length+2).join("0")}const x2={"%":(f,m)=>(f*100).toFixed(m),b:f=>Math.round(f).toString(2),c:f=>f+"",d:JP,e:(f,m)=>f.toExponential(m),f:(f,m)=>f.toFixed(m),g:(f,m)=>f.toPrecision(m),o:f=>Math.round(f).toString(8),p:(f,m)=>v2(f*100,m),r:v2,s:nk,X:f=>Math.round(f).toString(16).toUpperCase(),x:f=>Math.round(f).toString(16)};function b2(f){return f}var w2=Array.prototype.map,T2=["y","z","a","f","p","n","µ","m","","k","M","G","T","P","E","Z","Y"];function rk(f){var m=f.grouping===void 0||f.thousands===void 0?b2:QP(w2.call(f.grouping,Number),f.thousands+""),v=f.currency===void 0?"":f.currency[0]+"",w=f.currency===void 0?"":f.currency[1]+"",A=f.decimal===void 0?".":f.decimal+"",C=f.numerals===void 0?b2:tk(w2.call(f.numerals,String)),k=f.percent===void 0?"%":f.percent+"",P=f.minus===void 0?"−":f.minus+"",I=f.nan===void 0?"NaN":f.nan+"";function B(j){j=Jd(j);var Q=j.fill,et=j.align,it=j.sign,lt=j.symbol,_t=j.zero,ht=j.width,Bt=j.comma,dt=j.precision,It=j.trim,Wt=j.type;Wt==="n"?(Bt=!0,Wt="g"):x2[Wt]||(dt===void 0&&(dt=12),It=!0,Wt="g"),(_t||Q==="0"&&et==="=")&&(_t=!0,Q="0",et="=");var zt=lt==="$"?v:lt==="#"&&/[boxX]/.test(Wt)?"0"+Wt.toLowerCase():"",Zt=lt==="$"?w:/[%p]/.test(Wt)?k:"",$t=x2[Wt],G=/[defgprs%]/.test(Wt);dt=dt===void 0?6:/[gprs]/.test(Wt)?Math.max(1,Math.min(21,dt)):Math.max(0,Math.min(20,dt));function Tt(mt){var Ot=zt,wt=Zt,ne,ai,Re;if(Wt==="c")wt=$t(mt)+wt,mt="";else{mt=+mt;var Je=mt<0||1/mt<0;if(mt=isNaN(mt)?I:$t(Math.abs(mt),dt),It&&(mt=ik(mt)),Je&&+mt==0&&it!=="+"&&(Je=!1),Ot=(Je?it==="("?it:P:it==="-"||it==="("?"":it)+Ot,wt=(Wt==="s"?T2[8+DT/3]:"")+wt+(Je&&it==="("?")":""),G){for(ne=-1,ai=mt.length;++ne<ai;)if(Re=mt.charCodeAt(ne),48>Re||Re>57){wt=(Re===46?A+mt.slice(ne+1):mt.slice(ne))+wt,mt=mt.slice(0,ne);break}}}Bt&&!_t&&(mt=m(mt,1/0));var We=Ot.length+mt.length+wt.length,Pe=We<ht?new Array(ht-We+1).join(Q):"";switch(Bt&&_t&&(mt=m(Pe+mt,Pe.length?ht-wt.length:1/0),Pe=""),et){case"<":mt=Ot+mt+wt+Pe;break;case"=":mt=Ot+Pe+mt+wt;break;case"^":mt=Pe.slice(0,We=Pe.length>>1)+Ot+mt+wt+Pe.slice(We);break;default:mt=Pe+Ot+mt+wt;break}return C(mt)}return Tt.toString=function(){return j+""},Tt}function V(j,Q){var et=B((j=Jd(j),j.type="f",j)),it=Math.max(-8,Math.min(8,Math.floor(ec(Q)/3)))*3,lt=Math.pow(10,-it),_t=T2[8+it/3];return function(ht){return et(lt*ht)+_t}}return{format:B,formatPrefix:V}}var Od,la,PT;ok({thousands:",",grouping:[3],currency:["$",""]});function ok(f){return Od=rk(f),la=Od.format,PT=Od.formatPrefix,Od}function sk(f){return Math.max(0,-ec(Math.abs(f)))}function ak(f,m){return Math.max(0,Math.max(-8,Math.min(8,Math.floor(ec(m)/3)))*3-ec(Math.abs(f)))}function lk(f,m){return f=Math.abs(f),m=Math.abs(m)-f,Math.max(0,ec(m)-ec(f))+1}function af(f,m){switch(arguments.length){case 0:break;case 1:this.range(f);break;default:this.range(m).domain(f);break}return this}const M2=Symbol("implicit");function kT(){var f=new l2,m=[],v=[],w=M2;function A(C){let k=f.get(C);if(k===void 0){if(w!==M2)return w;f.set(C,k=m.push(C)-1)}return v[k%v.length]}return A.domain=function(C){if(!arguments.length)return m.slice();m=[],f=new l2;for(const k of C)f.has(k)||f.set(k,m.push(k)-1);return A},A.range=function(C){return arguments.length?(v=Array.from(C),A):v.slice()},A.unknown=function(C){return arguments.length?(w=C,A):w},A.copy=function(){return kT(m,v).unknown(w)},af.apply(A,arguments),A}function ck(f){return function(){return f}}function uk(f){return+f}var E2=[0,1];function Vo(f){return f}function rg(f,m){return(m-=f=+f)?function(v){return(v-f)/m}:ck(isNaN(m)?NaN:.5)}function hk(f,m){var v;return f>m&&(v=f,f=m,m=v),function(w){return Math.max(f,Math.min(m,w))}}function dk(f,m,v){var w=f[0],A=f[1],C=m[0],k=m[1];return A<w?(w=rg(A,w),C=v(k,C)):(w=rg(w,A),C=v(C,k)),function(P){return C(w(P))}}function fk(f,m,v){var w=Math.min(f.length,m.length)-1,A=new Array(w),C=new Array(w),k=-1;for(f[w]<f[0]&&(f=f.slice().reverse(),m=m.slice().reverse());++k<w;)A[k]=rg(f[k],f[k+1]),C[k]=v(m[k],m[k+1]);return function(P){var I=mP(f,P,1,w)-1;return C[I](A[I](P))}}function mg(f,m){return m.domain(f.domain()).range(f.range()).interpolate(f.interpolate()).clamp(f.clamp()).unknown(f.unknown())}function zT(){var f=E2,m=E2,v=fg,w,A,C,k=Vo,P,I,B;function V(){var Q=Math.min(f.length,m.length);return k!==Vo&&(k=hk(f[0],f[Q-1])),P=Q>2?fk:dk,I=B=null,j}function j(Q){return Q==null||isNaN(Q=+Q)?C:(I||(I=P(f.map(w),m,v)))(w(k(Q)))}return j.invert=function(Q){return k(A((B||(B=P(m,f.map(w),Yd)))(Q)))},j.domain=function(Q){return arguments.length?(f=Array.from(Q,uk),V()):f.slice()},j.range=function(Q){return arguments.length?(m=Array.from(Q),V()):m.slice()},j.rangeRound=function(Q){return m=Array.from(Q),v=$P,V()},j.clamp=function(Q){return arguments.length?(k=Q?!0:Vo,V()):k!==Vo},j.interpolate=function(Q){return arguments.length?(v=Q,V()):v},j.unknown=function(Q){return arguments.length?(C=Q,j):C},function(Q,et){return w=Q,A=et,V()}}function LT(){return zT()(Vo,Vo)}function pk(f,m,v,w){var A=Q_(f,m,v),C;switch(w=Jd(w??",f"),w.type){case"s":{var k=Math.max(Math.abs(f),Math.abs(m));return w.precision==null&&!isNaN(C=ak(A,k))&&(w.precision=C),PT(w,k)}case"":case"e":case"g":case"p":case"r":{w.precision==null&&!isNaN(C=lk(A,Math.max(Math.abs(f),Math.abs(m))))&&(w.precision=C-(w.type==="e"));break}case"f":case"%":{w.precision==null&&!isNaN(C=sk(A))&&(w.precision=C-(w.type==="%")*2);break}}return la(w)}function RT(f){var m=f.domain;return f.ticks=function(v){var w=m();return TP(w[0],w[w.length-1],v??10)},f.tickFormat=function(v,w){var A=m();return pk(A[0],A[A.length-1],v??10,w)},f.nice=function(v){v==null&&(v=10);var w=m(),A=0,C=w.length-1,k=w[A],P=w[C],I,B,V=10;for(P<k&&(B=k,k=P,P=B,B=A,A=C,C=B);V-- >0;){if(B=J_(k,P,v),B===I)return w[A]=k,w[C]=P,m(w);if(B>0)k=Math.floor(k/B)*B,P=Math.ceil(P/B)*B;else if(B<0)k=Math.ceil(k*B)/B,P=Math.floor(P*B)/B;else break;I=B}return f},f}function og(){var f=LT();return f.copy=function(){return mg(f,og())},af.apply(f,arguments),RT(f)}function mk(f,m){f=f.slice();var v=0,w=f.length-1,A=f[v],C=f[w],k;return C<A&&(k=v,v=w,w=k,k=A,A=C,C=k),f[v]=m.floor(A),f[w]=m.ceil(C),f}function S2(f){return function(m){return m<0?-Math.pow(-m,f):Math.pow(m,f)}}function _k(f){return f<0?-Math.sqrt(-f):Math.sqrt(f)}function gk(f){return f<0?-f*f:f*f}function yk(f){var m=f(Vo,Vo),v=1;function w(){return v===1?f(Vo,Vo):v===.5?f(_k,gk):f(S2(v),S2(1/v))}return m.exponent=function(A){return arguments.length?(v=+A,w()):v},RT(m)}function OT(){var f=yk(zT());return f.copy=function(){return mg(f,OT()).exponent(f.exponent())},af.apply(f,arguments),f}function vk(){return OT.apply(null,arguments).exponent(.5)}const V_=new Date,j_=new Date;function rr(f,m,v,w){function A(C){return f(C=arguments.length===0?new Date:new Date(+C)),C}return A.floor=C=>(f(C=new Date(+C)),C),A.ceil=C=>(f(C=new Date(C-1)),m(C,1),f(C),C),A.round=C=>{const k=A(C),P=A.ceil(C);return C-k<P-C?k:P},A.offset=(C,k)=>(m(C=new Date(+C),k==null?1:Math.floor(k)),C),A.range=(C,k,P)=>{const I=[];if(C=A.ceil(C),P=P==null?1:Math.floor(P),!(C<k)||!(P>0))return I;let B;do I.push(B=new Date(+C)),m(C,P),f(C);while(B<C&&C<k);return I},A.filter=C=>rr(k=>{if(k>=k)for(;f(k),!C(k);)k.setTime(k-1)},(k,P)=>{if(k>=k)if(P<0)for(;++P<=0;)for(;m(k,-1),!C(k););else for(;--P>=0;)for(;m(k,1),!C(k););}),v&&(A.count=(C,k)=>(V_.setTime(+C),j_.setTime(+k),f(V_),f(j_),Math.floor(v(V_,j_))),A.every=C=>(C=Math.floor(C),!isFinite(C)||!(C>0)?null:C>1?A.filter(w?k=>w(k)%C===0:k=>A.count(0,k)%C===0):A)),A}const Qd=rr(()=>{},(f,m)=>{f.setTime(+f+m)},(f,m)=>m-f);Qd.every=f=>(f=Math.floor(f),!isFinite(f)||!(f>0)?null:f>1?rr(m=>{m.setTime(Math.floor(m/f)*f)},(m,v)=>{m.setTime(+m+v*f)},(m,v)=>(v-m)/f):Qd);Qd.range;const gs=1e3,eo=gs*60,ys=eo*60,xs=ys*24,_g=xs*7,A2=xs*30,G_=xs*365,Xl=rr(f=>{f.setTime(f-f.getMilliseconds())},(f,m)=>{f.setTime(+f+m*gs)},(f,m)=>(m-f)/gs,f=>f.getUTCSeconds());Xl.range;const xk=rr(f=>{f.setTime(f-f.getMilliseconds()-f.getSeconds()*gs)},(f,m)=>{f.setTime(+f+m*eo)},(f,m)=>(m-f)/eo,f=>f.getMinutes());xk.range;const gg=rr(f=>{f.setUTCSeconds(0,0)},(f,m)=>{f.setTime(+f+m*eo)},(f,m)=>(m-f)/eo,f=>f.getUTCMinutes());gg.range;const bk=rr(f=>{f.setTime(f-f.getMilliseconds()-f.getSeconds()*gs-f.getMinutes()*eo)},(f,m)=>{f.setTime(+f+m*ys)},(f,m)=>(m-f)/ys,f=>f.getHours());bk.range;const yg=rr(f=>{f.setUTCMinutes(0,0,0)},(f,m)=>{f.setTime(+f+m*ys)},(f,m)=>(m-f)/ys,f=>f.getUTCHours());yg.range;const vg=rr(f=>f.setHours(0,0,0,0),(f,m)=>f.setDate(f.getDate()+m),(f,m)=>(m-f-(m.getTimezoneOffset()-f.getTimezoneOffset())*eo)/xs,f=>f.getDate()-1);vg.range;const lf=rr(f=>{f.setUTCHours(0,0,0,0)},(f,m)=>{f.setUTCDate(f.getUTCDate()+m)},(f,m)=>(m-f)/xs,f=>f.getUTCDate()-1);lf.range;const BT=rr(f=>{f.setUTCHours(0,0,0,0)},(f,m)=>{f.setUTCDate(f.getUTCDate()+m)},(f,m)=>(m-f)/xs,f=>Math.floor(f/xs));BT.range;function Xa(f){return rr(m=>{m.setDate(m.getDate()-(m.getDay()+7-f)%7),m.setHours(0,0,0,0)},(m,v)=>{m.setDate(m.getDate()+v*7)},(m,v)=>(v-m-(v.getTimezoneOffset()-m.getTimezoneOffset())*eo)/_g)}const FT=Xa(0),tf=Xa(1),wk=Xa(2),Tk=Xa(3),ic=Xa(4),Mk=Xa(5),Ek=Xa(6);FT.range;tf.range;wk.range;Tk.range;ic.range;Mk.range;Ek.range;function Ya(f){return rr(m=>{m.setUTCDate(m.getUTCDate()-(m.getUTCDay()+7-f)%7),m.setUTCHours(0,0,0,0)},(m,v)=>{m.setUTCDate(m.getUTCDate()+v*7)},(m,v)=>(v-m)/_g)}const cf=Ya(0),ef=Ya(1),Sk=Ya(2),Ak=Ya(3),nc=Ya(4),Ik=Ya(5),Ck=Ya(6);cf.range;ef.range;Sk.range;Ak.range;nc.range;Ik.range;Ck.range;const Dk=rr(f=>{f.setDate(1),f.setHours(0,0,0,0)},(f,m)=>{f.setMonth(f.getMonth()+m)},(f,m)=>m.getMonth()-f.getMonth()+(m.getFullYear()-f.getFullYear())*12,f=>f.getMonth());Dk.range;const xg=rr(f=>{f.setUTCDate(1),f.setUTCHours(0,0,0,0)},(f,m)=>{f.setUTCMonth(f.getUTCMonth()+m)},(f,m)=>m.getUTCMonth()-f.getUTCMonth()+(m.getUTCFullYear()-f.getUTCFullYear())*12,f=>f.getUTCMonth());xg.range;const Wa=rr(f=>{f.setMonth(0,1),f.setHours(0,0,0,0)},(f,m)=>{f.setFullYear(f.getFullYear()+m)},(f,m)=>m.getFullYear()-f.getFullYear(),f=>f.getFullYear());Wa.every=f=>!isFinite(f=Math.floor(f))||!(f>0)?null:rr(m=>{m.setFullYear(Math.floor(m.getFullYear()/f)*f),m.setMonth(0,1),m.setHours(0,0,0,0)},(m,v)=>{m.setFullYear(m.getFullYear()+v*f)});Wa.range;const bs=rr(f=>{f.setUTCMonth(0,1),f.setUTCHours(0,0,0,0)},(f,m)=>{f.setUTCFullYear(f.getUTCFullYear()+m)},(f,m)=>m.getUTCFullYear()-f.getUTCFullYear(),f=>f.getUTCFullYear());bs.every=f=>!isFinite(f=Math.floor(f))||!(f>0)?null:rr(m=>{m.setUTCFullYear(Math.floor(m.getUTCFullYear()/f)*f),m.setUTCMonth(0,1),m.setUTCHours(0,0,0,0)},(m,v)=>{m.setUTCFullYear(m.getUTCFullYear()+v*f)});bs.range;function Pk(f,m,v,w,A,C){const k=[[Xl,1,gs],[Xl,5,5*gs],[Xl,15,15*gs],[Xl,30,30*gs],[C,1,eo],[C,5,5*eo],[C,15,15*eo],[C,30,30*eo],[A,1,ys],[A,3,3*ys],[A,6,6*ys],[A,12,12*ys],[w,1,xs],[w,2,2*xs],[v,1,_g],[m,1,A2],[m,3,3*A2],[f,1,G_]];function P(B,V,j){const Q=V<B;Q&&([B,V]=[V,B]);const et=j&&typeof j.range=="function"?j:I(B,V,j),it=et?et.range(B,+V+1):[];return Q?it.reverse():it}function I(B,V,j){const Q=Math.abs(V-B)/j,et=ug(([,,_t])=>_t).right(k,Q);if(et===k.length)return f.every(Q_(B/G_,V/G_,j));if(et===0)return Qd.every(Math.max(Q_(B,V,j),1));const[it,lt]=k[Q/k[et-1][2]<k[et][2]/Q?et-1:et];return it.every(lt)}return[P,I]}const[kk,zk]=Pk(bs,xg,cf,BT,yg,gg);function q_(f){if(0<=f.y&&f.y<100){var m=new Date(-1,f.m,f.d,f.H,f.M,f.S,f.L);return m.setFullYear(f.y),m}return new Date(f.y,f.m,f.d,f.H,f.M,f.S,f.L)}function Z_(f){if(0<=f.y&&f.y<100){var m=new Date(Date.UTC(-1,f.m,f.d,f.H,f.M,f.S,f.L));return m.setUTCFullYear(f.y),m}return new Date(Date.UTC(f.y,f.m,f.d,f.H,f.M,f.S,f.L))}function mu(f,m,v){return{y:f,m,d:v,H:0,M:0,S:0,L:0}}function Lk(f){var m=f.dateTime,v=f.date,w=f.time,A=f.periods,C=f.days,k=f.shortDays,P=f.months,I=f.shortMonths,B=_u(A),V=gu(A),j=_u(C),Q=gu(C),et=_u(k),it=gu(k),lt=_u(P),_t=gu(P),ht=_u(I),Bt=gu(I),dt={a:Je,A:We,b:Pe,B:be,c:null,d:z2,e:z2,f:nz,g:fz,G:mz,H:tz,I:ez,j:iz,L:NT,m:rz,M:oz,p:Lt,q:Fe,Q:O2,s:B2,S:sz,u:az,U:lz,V:cz,w:uz,W:hz,x:null,X:null,y:dz,Y:pz,Z:_z,"%":R2},It={a:Me,A:Ii,b:Oi,B:Vt,c:null,d:L2,e:L2,f:xz,g:Dz,G:kz,H:gz,I:yz,j:vz,L:VT,m:bz,M:wz,p:Ve,q:rn,Q:O2,s:B2,S:Tz,u:Mz,U:Ez,V:Sz,w:Az,W:Iz,x:null,X:null,y:Cz,Y:Pz,Z:zz,"%":R2},Wt={a:Tt,A:mt,b:Ot,B:wt,c:ne,d:P2,e:P2,f:Yk,g:D2,G:C2,H:k2,I:k2,j:Hk,L:Xk,m:Zk,M:Wk,p:G,q:qk,Q:Jk,s:Qk,S:$k,u:Nk,U:Uk,V:Vk,w:Fk,W:jk,x:ai,X:Re,y:D2,Y:C2,Z:Gk,"%":Kk};dt.x=zt(v,dt),dt.X=zt(w,dt),dt.c=zt(m,dt),It.x=zt(v,It),It.X=zt(w,It),It.c=zt(m,It);function zt(ae,Te){return function(Oe){var Jt=[],Xe=-1,mi=0,gi=ae.length,Dt,F,q;for(Oe instanceof Date||(Oe=new Date(+Oe));++Xe<gi;)ae.charCodeAt(Xe)===37&&(Jt.push(ae.slice(mi,Xe)),(F=I2[Dt=ae.charAt(++Xe)])!=null?Dt=ae.charAt(++Xe):F=Dt==="e"?" ":"0",(q=Te[Dt])&&(Dt=q(Oe,F)),Jt.push(Dt),mi=Xe+1);return Jt.push(ae.slice(mi,Xe)),Jt.join("")}}function Zt(ae,Te){return function(Oe){var Jt=mu(1900,void 0,1),Xe=$t(Jt,ae,Oe+="",0),mi,gi;if(Xe!=Oe.length)return null;if("Q"in Jt)return new Date(Jt.Q);if("s"in Jt)return new Date(Jt.s*1e3+("L"in Jt?Jt.L:0));if(Te&&!("Z"in Jt)&&(Jt.Z=0),"p"in Jt&&(Jt.H=Jt.H%12+Jt.p*12),Jt.m===void 0&&(Jt.m="q"in Jt?Jt.q:0),"V"in Jt){if(Jt.V<1||Jt.V>53)return null;"w"in Jt||(Jt.w=1),"Z"in Jt?(mi=Z_(mu(Jt.y,0,1)),gi=mi.getUTCDay(),mi=gi>4||gi===0?ef.ceil(mi):ef(mi),mi=lf.offset(mi,(Jt.V-1)*7),Jt.y=mi.getUTCFullYear(),Jt.m=mi.getUTCMonth(),Jt.d=mi.getUTCDate()+(Jt.w+6)%7):(mi=q_(mu(Jt.y,0,1)),gi=mi.getDay(),mi=gi>4||gi===0?tf.ceil(mi):tf(mi),mi=vg.offset(mi,(Jt.V-1)*7),Jt.y=mi.getFullYear(),Jt.m=mi.getMonth(),Jt.d=mi.getDate()+(Jt.w+6)%7)}else("W"in Jt||"U"in Jt)&&("w"in Jt||(Jt.w="u"in Jt?Jt.u%7:"W"in Jt?1:0),gi="Z"in Jt?Z_(mu(Jt.y,0,1)).getUTCDay():q_(mu(Jt.y,0,1)).getDay(),Jt.m=0,Jt.d="W"in Jt?(Jt.w+6)%7+Jt.W*7-(gi+5)%7:Jt.w+Jt.U*7-(gi+6)%7);return"Z"in Jt?(Jt.H+=Jt.Z/100|0,Jt.M+=Jt.Z%100,Z_(Jt)):q_(Jt)}}function $t(ae,Te,Oe,Jt){for(var Xe=0,mi=Te.length,gi=Oe.length,Dt,F;Xe<mi;){if(Jt>=gi)return-1;if(Dt=Te.charCodeAt(Xe++),Dt===37){if(Dt=Te.charAt(Xe++),F=Wt[Dt in I2?Te.charAt(Xe++):Dt],!F||(Jt=F(ae,Oe,Jt))<0)return-1}else if(Dt!=Oe.charCodeAt(Jt++))return-1}return Jt}function G(ae,Te,Oe){var Jt=B.exec(Te.slice(Oe));return Jt?(ae.p=V.get(Jt[0].toLowerCase()),Oe+Jt[0].length):-1}function Tt(ae,Te,Oe){var Jt=et.exec(Te.slice(Oe));return Jt?(ae.w=it.get(Jt[0].toLowerCase()),Oe+Jt[0].length):-1}function mt(ae,Te,Oe){var Jt=j.exec(Te.slice(Oe));return Jt?(ae.w=Q.get(Jt[0].toLowerCase()),Oe+Jt[0].length):-1}function Ot(ae,Te,Oe){var Jt=ht.exec(Te.slice(Oe));return Jt?(ae.m=Bt.get(Jt[0].toLowerCase()),Oe+Jt[0].length):-1}function wt(ae,Te,Oe){var Jt=lt.exec(Te.slice(Oe));return Jt?(ae.m=_t.get(Jt[0].toLowerCase()),Oe+Jt[0].length):-1}function ne(ae,Te,Oe){return $t(ae,m,Te,Oe)}function ai(ae,Te,Oe){return $t(ae,v,Te,Oe)}function Re(ae,Te,Oe){return $t(ae,w,Te,Oe)}function Je(ae){return k[ae.getDay()]}function We(ae){return C[ae.getDay()]}function Pe(ae){return I[ae.getMonth()]}function be(ae){return P[ae.getMonth()]}function Lt(ae){return A[+(ae.getHours()>=12)]}function Fe(ae){return 1+~~(ae.getMonth()/3)}function Me(ae){return k[ae.getUTCDay()]}function Ii(ae){return C[ae.getUTCDay()]}function Oi(ae){return I[ae.getUTCMonth()]}function Vt(ae){return P[ae.getUTCMonth()]}function Ve(ae){return A[+(ae.getUTCHours()>=12)]}function rn(ae){return 1+~~(ae.getUTCMonth()/3)}return{format:function(ae){var Te=zt(ae+="",dt);return Te.toString=function(){return ae},Te},parse:function(ae){var Te=Zt(ae+="",!1);return Te.toString=function(){return ae},Te},utcFormat:function(ae){var Te=zt(ae+="",It);return Te.toString=function(){return ae},Te},utcParse:function(ae){var Te=Zt(ae+="",!0);return Te.toString=function(){return ae},Te}}}var I2={"-":"",_:" ",0:"0"},ar=/^\s*\d+/,Rk=/^%/,Ok=/[\\^$*+?|[\]().{}]/g;function an(f,m,v){var w=f<0?"-":"",A=(w?-f:f)+"",C=A.length;return w+(C<v?new Array(v-C+1).join(m)+A:A)}function Bk(f){return f.replace(Ok,"\\$&")}function _u(f){return new RegExp("^(?:"+f.map(Bk).join("|")+")","i")}function gu(f){return new Map(f.map((m,v)=>[m.toLowerCase(),v]))}function Fk(f,m,v){var w=ar.exec(m.slice(v,v+1));return w?(f.w=+w[0],v+w[0].length):-1}function Nk(f,m,v){var w=ar.exec(m.slice(v,v+1));return w?(f.u=+w[0],v+w[0].length):-1}function Uk(f,m,v){var w=ar.exec(m.slice(v,v+2));return w?(f.U=+w[0],v+w[0].length):-1}function Vk(f,m,v){var w=ar.exec(m.slice(v,v+2));return w?(f.V=+w[0],v+w[0].length):-1}function jk(f,m,v){var w=ar.exec(m.slice(v,v+2));return w?(f.W=+w[0],v+w[0].length):-1}function C2(f,m,v){var w=ar.exec(m.slice(v,v+4));return w?(f.y=+w[0],v+w[0].length):-1}function D2(f,m,v){var w=ar.exec(m.slice(v,v+2));return w?(f.y=+w[0]+(+w[0]>68?1900:2e3),v+w[0].length):-1}function Gk(f,m,v){var w=/^(Z)|([+-]\d\d)(?::?(\d\d))?/.exec(m.slice(v,v+6));return w?(f.Z=w[1]?0:-(w[2]+(w[3]||"00")),v+w[0].length):-1}function qk(f,m,v){var w=ar.exec(m.slice(v,v+1));return w?(f.q=w[0]*3-3,v+w[0].length):-1}function Zk(f,m,v){var w=ar.exec(m.slice(v,v+2));return w?(f.m=w[0]-1,v+w[0].length):-1}function P2(f,m,v){var w=ar.exec(m.slice(v,v+2));return w?(f.d=+w[0],v+w[0].length):-1}function Hk(f,m,v){var w=ar.exec(m.slice(v,v+3));return w?(f.m=0,f.d=+w[0],v+w[0].length):-1}function k2(f,m,v){var w=ar.exec(m.slice(v,v+2));return w?(f.H=+w[0],v+w[0].length):-1}function Wk(f,m,v){var w=ar.exec(m.slice(v,v+2));return w?(f.M=+w[0],v+w[0].length):-1}function $k(f,m,v){var w=ar.exec(m.slice(v,v+2));return w?(f.S=+w[0],v+w[0].length):-1}function Xk(f,m,v){var w=ar.exec(m.slice(v,v+3));return w?(f.L=+w[0],v+w[0].length):-1}function Yk(f,m,v){var w=ar.exec(m.slice(v,v+6));return w?(f.L=Math.floor(w[0]/1e3),v+w[0].length):-1}function Kk(f,m,v){var w=Rk.exec(m.slice(v,v+1));return w?v+w[0].length:-1}function Jk(f,m,v){var w=ar.exec(m.slice(v));return w?(f.Q=+w[0],v+w[0].length):-1}function Qk(f,m,v){var w=ar.exec(m.slice(v));return w?(f.s=+w[0],v+w[0].length):-1}function z2(f,m){return an(f.getDate(),m,2)}function tz(f,m){return an(f.getHours(),m,2)}function ez(f,m){return an(f.getHours()%12||12,m,2)}function iz(f,m){return an(1+vg.count(Wa(f),f),m,3)}function NT(f,m){return an(f.getMilliseconds(),m,3)}function nz(f,m){return NT(f,m)+"000"}function rz(f,m){return an(f.getMonth()+1,m,2)}function oz(f,m){return an(f.getMinutes(),m,2)}function sz(f,m){return an(f.getSeconds(),m,2)}function az(f){var m=f.getDay();return m===0?7:m}function lz(f,m){return an(FT.count(Wa(f)-1,f),m,2)}function UT(f){var m=f.getDay();return m>=4||m===0?ic(f):ic.ceil(f)}function cz(f,m){return f=UT(f),an(ic.count(Wa(f),f)+(Wa(f).getDay()===4),m,2)}function uz(f){return f.getDay()}function hz(f,m){return an(tf.count(Wa(f)-1,f),m,2)}function dz(f,m){return an(f.getFullYear()%100,m,2)}function fz(f,m){return f=UT(f),an(f.getFullYear()%100,m,2)}function pz(f,m){return an(f.getFullYear()%1e4,m,4)}function mz(f,m){var v=f.getDay();return f=v>=4||v===0?ic(f):ic.ceil(f),an(f.getFullYear()%1e4,m,4)}function _z(f){var m=f.getTimezoneOffset();return(m>0?"-":(m*=-1,"+"))+an(m/60|0,"0",2)+an(m%60,"0",2)}function L2(f,m){return an(f.getUTCDate(),m,2)}function gz(f,m){return an(f.getUTCHours(),m,2)}function yz(f,m){return an(f.getUTCHours()%12||12,m,2)}function vz(f,m){return an(1+lf.count(bs(f),f),m,3)}function VT(f,m){return an(f.getUTCMilliseconds(),m,3)}function xz(f,m){return VT(f,m)+"000"}function bz(f,m){return an(f.getUTCMonth()+1,m,2)}function wz(f,m){return an(f.getUTCMinutes(),m,2)}function Tz(f,m){return an(f.getUTCSeconds(),m,2)}function Mz(f){var m=f.getUTCDay();return m===0?7:m}function Ez(f,m){return an(cf.count(bs(f)-1,f),m,2)}function jT(f){var m=f.getUTCDay();return m>=4||m===0?nc(f):nc.ceil(f)}function Sz(f,m){return f=jT(f),an(nc.count(bs(f),f)+(bs(f).getUTCDay()===4),m,2)}function Az(f){return f.getUTCDay()}function Iz(f,m){return an(ef.count(bs(f)-1,f),m,2)}function Cz(f,m){return an(f.getUTCFullYear()%100,m,2)}function Dz(f,m){return f=jT(f),an(f.getUTCFullYear()%100,m,2)}function Pz(f,m){return an(f.getUTCFullYear()%1e4,m,4)}function kz(f,m){var v=f.getUTCDay();return f=v>=4||v===0?nc(f):nc.ceil(f),an(f.getUTCFullYear()%1e4,m,4)}function zz(){return"+0000"}function R2(){return"%"}function O2(f){return+f}function B2(f){return Math.floor(+f/1e3)}var Zl,nf;Lz({dateTime:"%x, %X",date:"%-m/%-d/%Y",time:"%-I:%M:%S %p",periods:["AM","PM"],days:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],shortDays:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],months:["January","February","March","April","May","June","July","August","September","October","November","December"],shortMonths:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]});function Lz(f){return Zl=Lk(f),Zl.format,Zl.parse,nf=Zl.utcFormat,Zl.utcParse,Zl}function Rz(f){return new Date(f)}function Oz(f){return f instanceof Date?+f:+new Date(+f)}function GT(f,m,v,w,A,C,k,P,I,B){var V=LT(),j=V.invert,Q=V.domain,et=B(".%L"),it=B(":%S"),lt=B("%I:%M"),_t=B("%I %p"),ht=B("%a %d"),Bt=B("%b %d"),dt=B("%B"),It=B("%Y");function Wt(zt){return(I(zt)<zt?et:P(zt)<zt?it:k(zt)<zt?lt:C(zt)<zt?_t:w(zt)<zt?A(zt)<zt?ht:Bt:v(zt)<zt?dt:It)(zt)}return V.invert=function(zt){return new Date(j(zt))},V.domain=function(zt){return arguments.length?Q(Array.from(zt,Oz)):Q().map(Rz)},V.ticks=function(zt){var Zt=Q();return f(Zt[0],Zt[Zt.length-1],zt??10)},V.tickFormat=function(zt,Zt){return Zt==null?Wt:B(Zt)},V.nice=function(zt){var Zt=Q();return(!zt||typeof zt.range!="function")&&(zt=m(Zt[0],Zt[Zt.length-1],zt??10)),zt?Q(mk(Zt,zt)):V},V.copy=function(){return mg(V,GT(f,m,v,w,A,C,k,P,I,B))},V}function Bz(){return af.apply(GT(kk,zk,bs,xg,cf,lf,yg,gg,Xl,nf).domain([Date.UTC(2e3,0,1),Date.UTC(2e3,0,2)]),arguments)}function Xn(f){return function(){return f}}const F2=Math.abs,fr=Math.atan2,ja=Math.cos,Fz=Math.max,H_=Math.min,Uo=Math.sin,Yl=Math.sqrt,Pr=1e-12,wu=Math.PI,rf=wu/2,Vd=2*wu;function Nz(f){return f>1?0:f<-1?wu:Math.acos(f)}function N2(f){return f>=1?rf:f<=-1?-rf:Math.asin(f)}function qT(f){let m=3;return f.digits=function(v){if(!arguments.length)return m;if(v==null)m=null;else{const w=Math.floor(v);if(!(w>=0))throw new RangeError(`invalid digits: ${v}`);m=w}return f},()=>new KP(m)}function Uz(f){return f.innerRadius}function Vz(f){return f.outerRadius}function jz(f){return f.startAngle}function Gz(f){return f.endAngle}function qz(f){return f&&f.padAngle}function Zz(f,m,v,w,A,C,k,P){var I=v-f,B=w-m,V=k-A,j=P-C,Q=j*I-V*B;if(!(Q*Q<Pr))return Q=(V*(m-C)-j*(f-A))/Q,[f+Q*I,m+Q*B]}function Bd(f,m,v,w,A,C,k){var P=f-v,I=m-w,B=(k?C:-C)/Yl(P*P+I*I),V=B*I,j=-B*P,Q=f+V,et=m+j,it=v+V,lt=w+j,_t=(Q+it)/2,ht=(et+lt)/2,Bt=it-Q,dt=lt-et,It=Bt*Bt+dt*dt,Wt=A-C,zt=Q*lt-it*et,Zt=(dt<0?-1:1)*Yl(Fz(0,Wt*Wt*It-zt*zt)),$t=(zt*dt-Bt*Zt)/It,G=(-zt*Bt-dt*Zt)/It,Tt=(zt*dt+Bt*Zt)/It,mt=(-zt*Bt+dt*Zt)/It,Ot=$t-_t,wt=G-ht,ne=Tt-_t,ai=mt-ht;return Ot*Ot+wt*wt>ne*ne+ai*ai&&($t=Tt,G=mt),{cx:$t,cy:G,x01:-V,y01:-j,x11:$t*(A/Wt-1),y11:G*(A/Wt-1)}}function U2(){var f=Uz,m=Vz,v=Xn(0),w=null,A=jz,C=Gz,k=qz,P=null,I=qT(B);function B(){var V,j,Q=+f.apply(this,arguments),et=+m.apply(this,arguments),it=A.apply(this,arguments)-rf,lt=C.apply(this,arguments)-rf,_t=F2(lt-it),ht=lt>it;if(P||(P=V=I()),et<Q&&(j=et,et=Q,Q=j),!(et>Pr))P.moveTo(0,0);else if(_t>Vd-Pr)P.moveTo(et*ja(it),et*Uo(it)),P.arc(0,0,et,it,lt,!ht),Q>Pr&&(P.moveTo(Q*ja(lt),Q*Uo(lt)),P.arc(0,0,Q,lt,it,ht));else{var Bt=it,dt=lt,It=it,Wt=lt,zt=_t,Zt=_t,$t=k.apply(this,arguments)/2,G=$t>Pr&&(w?+w.apply(this,arguments):Yl(Q*Q+et*et)),Tt=H_(F2(et-Q)/2,+v.apply(this,arguments)),mt=Tt,Ot=Tt,wt,ne;if(G>Pr){var ai=N2(G/Q*Uo($t)),Re=N2(G/et*Uo($t));(zt-=ai*2)>Pr?(ai*=ht?1:-1,It+=ai,Wt-=ai):(zt=0,It=Wt=(it+lt)/2),(Zt-=Re*2)>Pr?(Re*=ht?1:-1,Bt+=Re,dt-=Re):(Zt=0,Bt=dt=(it+lt)/2)}var Je=et*ja(Bt),We=et*Uo(Bt),Pe=Q*ja(Wt),be=Q*Uo(Wt);if(Tt>Pr){var Lt=et*ja(dt),Fe=et*Uo(dt),Me=Q*ja(It),Ii=Q*Uo(It),Oi;if(_t<wu)if(Oi=Zz(Je,We,Me,Ii,Lt,Fe,Pe,be)){var Vt=Je-Oi[0],Ve=We-Oi[1],rn=Lt-Oi[0],ae=Fe-Oi[1],Te=1/Uo(Nz((Vt*rn+Ve*ae)/(Yl(Vt*Vt+Ve*Ve)*Yl(rn*rn+ae*ae)))/2),Oe=Yl(Oi[0]*Oi[0]+Oi[1]*Oi[1]);mt=H_(Tt,(Q-Oe)/(Te-1)),Ot=H_(Tt,(et-Oe)/(Te+1))}else mt=Ot=0}Zt>Pr?Ot>Pr?(wt=Bd(Me,Ii,Je,We,et,Ot,ht),ne=Bd(Lt,Fe,Pe,be,et,Ot,ht),P.moveTo(wt.cx+wt.x01,wt.cy+wt.y01),Ot<Tt?P.arc(wt.cx,wt.cy,Ot,fr(wt.y01,wt.x01),fr(ne.y01,ne.x01),!ht):(P.arc(wt.cx,wt.cy,Ot,fr(wt.y01,wt.x01),fr(wt.y11,wt.x11),!ht),P.arc(0,0,et,fr(wt.cy+wt.y11,wt.cx+wt.x11),fr(ne.cy+ne.y11,ne.cx+ne.x11),!ht),P.arc(ne.cx,ne.cy,Ot,fr(ne.y11,ne.x11),fr(ne.y01,ne.x01),!ht))):(P.moveTo(Je,We),P.arc(0,0,et,Bt,dt,!ht)):P.moveTo(Je,We),!(Q>Pr)||!(zt>Pr)?P.lineTo(Pe,be):mt>Pr?(wt=Bd(Pe,be,Lt,Fe,Q,-mt,ht),ne=Bd(Je,We,Me,Ii,Q,-mt,ht),P.lineTo(wt.cx+wt.x01,wt.cy+wt.y01),mt<Tt?P.arc(wt.cx,wt.cy,mt,fr(wt.y01,wt.x01),fr(ne.y01,ne.x01),!ht):(P.arc(wt.cx,wt.cy,mt,fr(wt.y01,wt.x01),fr(wt.y11,wt.x11),!ht),P.arc(0,0,Q,fr(wt.cy+wt.y11,wt.cx+wt.x11),fr(ne.cy+ne.y11,ne.cx+ne.x11),ht),P.arc(ne.cx,ne.cy,mt,fr(ne.y11,ne.x11),fr(ne.y01,ne.x01),!ht))):P.arc(0,0,Q,Wt,It,ht)}if(P.closePath(),V)return P=null,V+""||null}return B.centroid=function(){var V=(+f.apply(this,arguments)+ +m.apply(this,arguments))/2,j=(+A.apply(this,arguments)+ +C.apply(this,arguments))/2-wu/2;return[ja(j)*V,Uo(j)*V]},B.innerRadius=function(V){return arguments.length?(f=typeof V=="function"?V:Xn(+V),B):f},B.outerRadius=function(V){return arguments.length?(m=typeof V=="function"?V:Xn(+V),B):m},B.cornerRadius=function(V){return arguments.length?(v=typeof V=="function"?V:Xn(+V),B):v},B.padRadius=function(V){return arguments.length?(w=V==null?null:typeof V=="function"?V:Xn(+V),B):w},B.startAngle=function(V){return arguments.length?(A=typeof V=="function"?V:Xn(+V),B):A},B.endAngle=function(V){return arguments.length?(C=typeof V=="function"?V:Xn(+V),B):C},B.padAngle=function(V){return arguments.length?(k=typeof V=="function"?V:Xn(+V),B):k},B.context=function(V){return arguments.length?(P=V??null,B):P},B}function ZT(f){return typeof f=="object"&&"length"in f?f:Array.from(f)}function HT(f){this._context=f}HT.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._point=0},lineEnd:function(){(this._line||this._line!==0&&this._point===1)&&this._context.closePath(),this._line=1-this._line},point:function(f,m){switch(f=+f,m=+m,this._point){case 0:this._point=1,this._line?this._context.lineTo(f,m):this._context.moveTo(f,m);break;case 1:this._point=2;default:this._context.lineTo(f,m);break}}};function Hz(f){return new HT(f)}function Wz(f){return f[0]}function $z(f){return f[1]}function V2(f,m){var v=Xn(!0),w=null,A=Hz,C=null,k=qT(P);f=typeof f=="function"?f:f===void 0?Wz:Xn(f),m=typeof m=="function"?m:m===void 0?$z:Xn(m);function P(I){var B,V=(I=ZT(I)).length,j,Q=!1,et;for(w==null&&(C=A(et=k())),B=0;B<=V;++B)!(B<V&&v(j=I[B],B,I))===Q&&((Q=!Q)?C.lineStart():C.lineEnd()),Q&&C.point(+f(j,B,I),+m(j,B,I));if(et)return C=null,et+""||null}return P.x=function(I){return arguments.length?(f=typeof I=="function"?I:Xn(+I),P):f},P.y=function(I){return arguments.length?(m=typeof I=="function"?I:Xn(+I),P):m},P.defined=function(I){return arguments.length?(v=typeof I=="function"?I:Xn(!!I),P):v},P.curve=function(I){return arguments.length?(A=I,w!=null&&(C=A(w)),P):A},P.context=function(I){return arguments.length?(I==null?w=C=null:C=A(w=I),P):w},P}function Xz(f,m){return m<f?-1:m>f?1:m>=f?0:NaN}function Yz(f){return f}function Kz(){var f=Yz,m=Xz,v=null,w=Xn(0),A=Xn(Vd),C=Xn(0);function k(P){var I,B=(P=ZT(P)).length,V,j,Q=0,et=new Array(B),it=new Array(B),lt=+w.apply(this,arguments),_t=Math.min(Vd,Math.max(-Vd,A.apply(this,arguments)-lt)),ht,Bt=Math.min(Math.abs(_t)/B,C.apply(this,arguments)),dt=Bt*(_t<0?-1:1),It;for(I=0;I<B;++I)(It=it[et[I]=I]=+f(P[I],I,P))>0&&(Q+=It);for(m!=null?et.sort(function(Wt,zt){return m(it[Wt],it[zt])}):v!=null&&et.sort(function(Wt,zt){return v(P[Wt],P[zt])}),I=0,j=Q?(_t-B*dt)/Q:0;I<B;++I,lt=ht)V=et[I],It=it[V],ht=lt+(It>0?It*j:0)+dt,it[V]={data:P[V],index:I,value:It,startAngle:lt,endAngle:ht,padAngle:Bt};return it}return k.value=function(P){return arguments.length?(f=typeof P=="function"?P:Xn(+P),k):f},k.sortValues=function(P){return arguments.length?(m=P,v=null,k):m},k.sort=function(P){return arguments.length?(v=P,m=null,k):v},k.startAngle=function(P){return arguments.length?(w=typeof P=="function"?P:Xn(+P),k):w},k.endAngle=function(P){return arguments.length?(A=typeof P=="function"?P:Xn(+P),k):A},k.padAngle=function(P){return arguments.length?(C=typeof P=="function"?P:Xn(+P),k):C},k}function yu(f,m,v){this.k=f,this.x=m,this.y=v}yu.prototype={constructor:yu,scale:function(f){return f===1?this:new yu(this.k*f,this.x,this.y)},translate:function(f,m){return f===0&m===0?this:new yu(this.k,this.x+this.k*f,this.y+this.k*m)},apply:function(f){return[f[0]*this.k+this.x,f[1]*this.k+this.y]},applyX:function(f){return f*this.k+this.x},applyY:function(f){return f*this.k+this.y},invert:function(f){return[(f[0]-this.x)/this.k,(f[1]-this.y)/this.k]},invertX:function(f){return(f-this.x)/this.k},invertY:function(f){return(f-this.y)/this.k},rescaleX:function(f){return f.copy().domain(f.range().map(this.invertX,this).map(f.invert,f))},rescaleY:function(f){return f.copy().domain(f.range().map(this.invertY,this).map(f.invert,f))},toString:function(){return"translate("+this.x+","+this.y+") scale("+this.k+")"}};yu.prototype;var Jz=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Qz(f){return f&&f.__esModule&&Object.prototype.hasOwnProperty.call(f,"default")?f.default:f}var WT={exports:{}};(function(f,m){(function(v,w){f.exports=w()})(Jz,function(){var v,w,A;function C(P,I){if(!v)v=I;else if(!w)w=I;else{var B="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+v+")(sharedChunk); ("+w+")(sharedChunk); self.onerror = null;",V={};v(V),A=I(V),typeof window<"u"&&window&&window.URL&&window.URL.createObjectURL&&(A.workerUrl=window.URL.createObjectURL(new Blob([B],{type:"text/javascript"})))}}C(["exports"],function(P){var I=typeof self<"u"?self:{},B="3.1.2";let V;const j={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){if(V==null){const e=/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i;try{V={NVM_INC:"/Users/rudi/.nvm/versions/node/v20.11.1/include/node",MANPATH:"/Users/rudi/.nvm/versions/node/v20.11.1/share/man:/opt/homebrew/share/man:/usr/share/man:/usr/local/share/man:/Users/rudi/.nvm/versions/node/v20.11.1/share/man:/opt/homebrew/share/man::",TERM_PROGRAM:"vscode",NODE:"/Users/rudi/.nvm/versions/node/v20.11.1/bin/node",INIT_CWD:"/Users/rudi/Documents/GitHub/active_travel_new",NVM_CD_FLAGS:"-q",TERM:"xterm-256color",SHELL:"/bin/zsh",HOMEBREW_REPOSITORY:"/opt/homebrew",TMPDIR:"/var/folders/c6/jsjxnj0j6vqbnpqy37npy5dw0000gn/T/",npm_config_global_prefix:"/Users/rudi/.nvm/versions/node/v20.11.1",TERM_PROGRAM_VERSION:"1.93.1",ZDOTDIR:"/Users/rudi",ORIGINAL_XDG_CURRENT_DESKTOP:"undefined",MallocNanoZone:"0",COLOR:"1",npm_config_noproxy:"",npm_config_local_prefix:"/Users/rudi/Documents/GitHub/active_travel_new",NVM_DIR:"/Users/rudi/.nvm",USER:"rudi",COMMAND_MODE:"unix2003",npm_config_globalconfig:"/Users/rudi/.nvm/versions/node/v20.11.1/etc/npmrc",SSH_AUTH_SOCK:"/private/tmp/com.apple.launchd.FFteYWhD7t/Listeners",__CF_USER_TEXT_ENCODING:"0x1F5:0:2",npm_execpath:"/Users/rudi/.nvm/versions/node/v20.11.1/lib/node_modules/npm/bin/npm-cli.js",STARDOG_HOME:"/var/stardog",PATH:"/Users/rudi/Documents/GitHub/active_travel_new/node_modules/.bin:/Users/rudi/Documents/GitHub/node_modules/.bin:/Users/rudi/Documents/node_modules/.bin:/Users/rudi/node_modules/.bin:/Users/node_modules/.bin:/node_modules/.bin:/Users/rudi/.nvm/versions/node/v20.11.1/lib/node_modules/npm/node_modules/@npmcli/run-script/lib/node-gyp-bin:/opt/homebrew/opt/openjdk/bin:/opt/homebrew/opt/openjdk/bin:/Users/rudi/.nvm/versions/node/v20.11.1/bin:/opt/homebrew/bin:/opt/homebrew/sbin:/Library/Frameworks/Python.framework/Versions/3.9/bin:/usr/local/bin:/System/Cryptexes/App/usr/bin:/usr/bin:/bin:/usr/sbin:/sbin:/var/run/com.apple.security.cryptexd/codex.system/bootstrap/usr/local/bin:/var/run/com.apple.security.cryptexd/codex.system/bootstrap/usr/bin:/var/run/com.apple.security.cryptexd/codex.system/bootstrap/usr/appleinternal/bin:/opt/homebrew/opt/openjdk/bin:/Users/rudi/.nvm/versions/node/v20.11.1/bin:/opt/homebrew/bin:/opt/homebrew/sbin:/Library/Frameworks/Python.framework/Versions/3.9/bin",npm_package_json:"/Users/rudi/Documents/GitHub/active_travel_new/package.json",_:"/Users/rudi/Documents/GitHub/active_travel_new/node_modules/.bin/vite",npm_config_userconfig:"/Users/rudi/.npmrc",npm_config_init_module:"/Users/rudi/.npm-init.js",USER_ZDOTDIR:"/Users/rudi",__CFBundleIdentifier:"com.microsoft.VSCode",npm_command:"run-script",PWD:"/Users/rudi/Documents/GitHub/active_travel_new",npm_lifecycle_event:"build",EDITOR:"vi",npm_package_name:"dataviz-project-starter-kit",LANG:"en_US.UTF-8",npm_config_npm_version:"10.2.4",VSCODE_GIT_ASKPASS_EXTRA_ARGS:"",XPC_FLAGS:"0x0",npm_config_node_gyp:"/Users/rudi/.nvm/versions/node/v20.11.1/lib/node_modules/npm/node_modules/node-gyp/bin/node-gyp.js",npm_package_version:"0.3.0",XPC_SERVICE_NAME:"0",VSCODE_INJECTION:"1",SHLVL:"2",HOME:"/Users/rudi",VSCODE_GIT_ASKPASS_MAIN:"/Applications/Visual Studio Code.app/Contents/Resources/app/extensions/git/dist/askpass-main.js",HOMEBREW_PREFIX:"/opt/homebrew",npm_config_cache:"/Users/rudi/.npm",LOGNAME:"rudi",npm_lifecycle_script:"vite build",VSCODE_GIT_IPC_HANDLE:"/var/folders/c6/jsjxnj0j6vqbnpqy37npy5dw0000gn/T/vscode-git-92b83a983c.sock",NVM_BIN:"/Users/rudi/.nvm/versions/node/v20.11.1/bin",npm_config_user_agent:"npm/10.2.4 node/v20.11.1 darwin arm64 workspaces/false",VSCODE_GIT_ASKPASS_NODE:"/Applications/Visual Studio Code.app/Contents/Frameworks/Code Helper (Plugin).app/Contents/MacOS/Code Helper (Plugin)",GIT_ASKPASS:"/Applications/Visual Studio Code.app/Contents/Resources/app/extensions/git/dist/askpass.sh",INFOPATH:"/opt/homebrew/share/info:/opt/homebrew/share/info:",HOMEBREW_CELLAR:"/opt/homebrew/Cellar",npm_node_execpath:"/Users/rudi/.nvm/versions/node/v20.11.1/bin/node",npm_config_prefix:"/Users/rudi/.nvm/versions/node/v20.11.1",COLORTERM:"truecolor",NODE_ENV:"production"}.API_URL_REGEX!=null?new RegExp({NVM_INC:"/Users/rudi/.nvm/versions/node/v20.11.1/include/node",MANPATH:"/Users/rudi/.nvm/versions/node/v20.11.1/share/man:/opt/homebrew/share/man:/usr/share/man:/usr/local/share/man:/Users/rudi/.nvm/versions/node/v20.11.1/share/man:/opt/homebrew/share/man::",TERM_PROGRAM:"vscode",NODE:"/Users/rudi/.nvm/versions/node/v20.11.1/bin/node",INIT_CWD:"/Users/rudi/Documents/GitHub/active_travel_new",NVM_CD_FLAGS:"-q",TERM:"xterm-256color",SHELL:"/bin/zsh",HOMEBREW_REPOSITORY:"/opt/homebrew",TMPDIR:"/var/folders/c6/jsjxnj0j6vqbnpqy37npy5dw0000gn/T/",npm_config_global_prefix:"/Users/rudi/.nvm/versions/node/v20.11.1",TERM_PROGRAM_VERSION:"1.93.1",ZDOTDIR:"/Users/rudi",ORIGINAL_XDG_CURRENT_DESKTOP:"undefined",MallocNanoZone:"0",COLOR:"1",npm_config_noproxy:"",npm_config_local_prefix:"/Users/rudi/Documents/GitHub/active_travel_new",NVM_DIR:"/Users/rudi/.nvm",USER:"rudi",COMMAND_MODE:"unix2003",npm_config_globalconfig:"/Users/rudi/.nvm/versions/node/v20.11.1/etc/npmrc",SSH_AUTH_SOCK:"/private/tmp/com.apple.launchd.FFteYWhD7t/Listeners",__CF_USER_TEXT_ENCODING:"0x1F5:0:2",npm_execpath:"/Users/rudi/.nvm/versions/node/v20.11.1/lib/node_modules/npm/bin/npm-cli.js",STARDOG_HOME:"/var/stardog",PATH:"/Users/rudi/Documents/GitHub/active_travel_new/node_modules/.bin:/Users/rudi/Documents/GitHub/node_modules/.bin:/Users/rudi/Documents/node_modules/.bin:/Users/rudi/node_modules/.bin:/Users/node_modules/.bin:/node_modules/.bin:/Users/rudi/.nvm/versions/node/v20.11.1/lib/node_modules/npm/node_modules/@npmcli/run-script/lib/node-gyp-bin:/opt/homebrew/opt/openjdk/bin:/opt/homebrew/opt/openjdk/bin:/Users/rudi/.nvm/versions/node/v20.11.1/bin:/opt/homebrew/bin:/opt/homebrew/sbin:/Library/Frameworks/Python.framework/Versions/3.9/bin:/usr/local/bin:/System/Cryptexes/App/usr/bin:/usr/bin:/bin:/usr/sbin:/sbin:/var/run/com.apple.security.cryptexd/codex.system/bootstrap/usr/local/bin:/var/run/com.apple.security.cryptexd/codex.system/bootstrap/usr/bin:/var/run/com.apple.security.cryptexd/codex.system/bootstrap/usr/appleinternal/bin:/opt/homebrew/opt/openjdk/bin:/Users/rudi/.nvm/versions/node/v20.11.1/bin:/opt/homebrew/bin:/opt/homebrew/sbin:/Library/Frameworks/Python.framework/Versions/3.9/bin",npm_package_json:"/Users/rudi/Documents/GitHub/active_travel_new/package.json",_:"/Users/rudi/Documents/GitHub/active_travel_new/node_modules/.bin/vite",npm_config_userconfig:"/Users/rudi/.npmrc",npm_config_init_module:"/Users/rudi/.npm-init.js",USER_ZDOTDIR:"/Users/rudi",__CFBundleIdentifier:"com.microsoft.VSCode",npm_command:"run-script",PWD:"/Users/rudi/Documents/GitHub/active_travel_new",npm_lifecycle_event:"build",EDITOR:"vi",npm_package_name:"dataviz-project-starter-kit",LANG:"en_US.UTF-8",npm_config_npm_version:"10.2.4",VSCODE_GIT_ASKPASS_EXTRA_ARGS:"",XPC_FLAGS:"0x0",npm_config_node_gyp:"/Users/rudi/.nvm/versions/node/v20.11.1/lib/node_modules/npm/node_modules/node-gyp/bin/node-gyp.js",npm_package_version:"0.3.0",XPC_SERVICE_NAME:"0",VSCODE_INJECTION:"1",SHLVL:"2",HOME:"/Users/rudi",VSCODE_GIT_ASKPASS_MAIN:"/Applications/Visual Studio Code.app/Contents/Resources/app/extensions/git/dist/askpass-main.js",HOMEBREW_PREFIX:"/opt/homebrew",npm_config_cache:"/Users/rudi/.npm",LOGNAME:"rudi",npm_lifecycle_script:"vite build",VSCODE_GIT_IPC_HANDLE:"/var/folders/c6/jsjxnj0j6vqbnpqy37npy5dw0000gn/T/vscode-git-92b83a983c.sock",NVM_BIN:"/Users/rudi/.nvm/versions/node/v20.11.1/bin",npm_config_user_agent:"npm/10.2.4 node/v20.11.1 darwin arm64 workspaces/false",VSCODE_GIT_ASKPASS_NODE:"/Applications/Visual Studio Code.app/Contents/Frameworks/Code Helper (Plugin).app/Contents/MacOS/Code Helper (Plugin)",GIT_ASKPASS:"/Applications/Visual Studio Code.app/Contents/Resources/app/extensions/git/dist/askpass.sh",INFOPATH:"/opt/homebrew/share/info:/opt/homebrew/share/info:",HOMEBREW_CELLAR:"/opt/homebrew/Cellar",npm_node_execpath:"/Users/rudi/.nvm/versions/node/v20.11.1/bin/node",npm_config_prefix:"/Users/rudi/.nvm/versions/node/v20.11.1",COLORTERM:"truecolor",NODE_ENV:"production"}.API_URL_REGEX):e}catch{V=e}}return V},get API_TILEJSON_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/v[0-9]*\/.*\.json.*$)/i},get API_SPRITE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*\/sprite.*\..*$)/i},get API_FONTS_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/fonts\/v[0-9]*\/)(.*\.pbf.*$)/i},get API_STYLE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*$)/i},get API_CDN_URL_REGEX(){return/^((https?:)?\/\/)?api\.mapbox\.c(n|om)(\/mapbox-gl-js\/)(.*$)/i},get EVENTS_URL(){if(!j.API_URL)return null;try{const e=new URL(j.API_URL);return e.hostname==="api.mapbox.cn"?"https://events.mapbox.cn/events/v2":e.hostname==="api.mapbox.com"?"https://events.mapbox.com/events/v2":null}catch{return null}},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,DEFAULT_STYLE:"mapbox://styles/mapbox/standard",MAX_PARALLEL_IMAGE_REQUESTS:16,DRACO_URL:"https://api.mapbox.com/mapbox-gl-js/draco_decoder_gltf_v1.5.6.wasm",GLYPHS_URL:"mapbox://fonts/mapbox/{fontstack}/{range}.pbf"},Q={supported:!1,testSupport:function(e){!lt&&it&&(_t?ht(e):et=e)}};let et,it,lt=!1,_t=!1;function ht(e){const t=e.createTexture();e.bindTexture(e.TEXTURE_2D,t);try{if(e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,it),e.isContextLost())return;Q.supported=!0}catch{}e.deleteTexture(t),lt=!0}I.document&&(it=I.document.createElement("img"),it.onload=function(){et&&ht(et),et=null,_t=!0},it.onerror=function(){lt=!0,et=null},it.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");const Bt="01";function dt(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var It=Wt;function Wt(e,t,i,n){this.cx=3*e,this.bx=3*(i-e)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*t,this.by=3*(n-t)-this.cy,this.ay=1-this.cy-this.by,this.p1x=e,this.p1y=t,this.p2x=i,this.p2y=n}Wt.prototype={sampleCurveX:function(e){return((this.ax*e+this.bx)*e+this.cx)*e},sampleCurveY:function(e){return((this.ay*e+this.by)*e+this.cy)*e},sampleCurveDerivativeX:function(e){return(3*this.ax*e+2*this.bx)*e+this.cx},solveCurveX:function(e,t){if(t===void 0&&(t=1e-6),e<0)return 0;if(e>1)return 1;for(var i=e,n=0;n<8;n++){var r=this.sampleCurveX(i)-e;if(Math.abs(r)<t)return i;var o=this.sampleCurveDerivativeX(i);if(Math.abs(o)<1e-6)break;i-=r/o}var s=0,a=1;for(i=e,n=0;n<20&&(r=this.sampleCurveX(i),!(Math.abs(r-e)<t));n++)e>r?s=i:a=i,i=.5*(a-s)+s;return i},solve:function(e,t){return this.sampleCurveY(this.solveCurveX(e,t))}};var zt=dt(It),Zt=$t;function $t(e,t){this.x=e,this.y=t}$t.prototype={clone:function(){return new $t(this.x,this.y)},add:function(e){return this.clone()._add(e)},sub:function(e){return this.clone()._sub(e)},multByPoint:function(e){return this.clone()._multByPoint(e)},divByPoint:function(e){return this.clone()._divByPoint(e)},mult:function(e){return this.clone()._mult(e)},div:function(e){return this.clone()._div(e)},rotate:function(e){return this.clone()._rotate(e)},rotateAround:function(e,t){return this.clone()._rotateAround(e,t)},matMult:function(e){return this.clone()._matMult(e)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(e){return this.x===e.x&&this.y===e.y},dist:function(e){return Math.sqrt(this.distSqr(e))},distSqr:function(e){var t=e.x-this.x,i=e.y-this.y;return t*t+i*i},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(e){return Math.atan2(this.y-e.y,this.x-e.x)},angleWith:function(e){return this.angleWithSep(e.x,e.y)},angleWithSep:function(e,t){return Math.atan2(this.x*t-this.y*e,this.x*e+this.y*t)},_matMult:function(e){var t=e[2]*this.x+e[3]*this.y;return this.x=e[0]*this.x+e[1]*this.y,this.y=t,this},_add:function(e){return this.x+=e.x,this.y+=e.y,this},_sub:function(e){return this.x-=e.x,this.y-=e.y,this},_mult:function(e){return this.x*=e,this.y*=e,this},_div:function(e){return this.x/=e,this.y/=e,this},_multByPoint:function(e){return this.x*=e.x,this.y*=e.y,this},_divByPoint:function(e){return this.x/=e.x,this.y/=e.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var e=this.y;return this.y=this.x,this.x=-e,this},_rotate:function(e){var t=Math.cos(e),i=Math.sin(e),n=i*this.x+t*this.y;return this.x=t*this.x-i*this.y,this.y=n,this},_rotateAround:function(e,t){var i=Math.cos(e),n=Math.sin(e),r=t.y+n*(this.x-t.x)+i*(this.y-t.y);return this.x=t.x+i*(this.x-t.x)-n*(this.y-t.y),this.y=r,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},$t.convert=function(e){return e instanceof $t?e:Array.isArray(e)?new $t(e[0],e[1]):e};var G=dt(Zt);function Tt(e,t){if(Array.isArray(e)){if(!Array.isArray(t)||e.length!==t.length)return!1;for(let i=0;i<e.length;i++)if(!Tt(e[i],t[i]))return!1;return!0}if(typeof e=="object"&&e!==null&&t!==null){if(typeof t!="object"||Object.keys(e).length!==Object.keys(t).length)return!1;for(const i in e)if(!Tt(e[i],t[i]))return!1;return!0}return e===t}const mt=Math.PI/180,Ot=180/Math.PI;function wt(e){return e*mt}function ne(e){return e*Ot}const ai=[[0,0],[1,0],[1,1],[0,1]];function Re(e){if(e<=0)return 0;if(e>=1)return 1;const t=e*e,i=t*e;return 4*(e<.5?i:3*(e-t)+i-.75)}function Je(e){let t=1/0,i=1/0,n=-1/0,r=-1/0;for(const o of e)t=Math.min(t,o.x),i=Math.min(i,o.y),n=Math.max(n,o.x),r=Math.max(r,o.y);return{min:new G(t,i),max:new G(n,r)}}function We(e,t,i=0,n=!0){const r=new G(i,i),o=e.sub(r),s=t.add(r),a=[o,new G(s.x,o.y),s,new G(o.x,s.y)];return n&&a.push(o.clone()),a}function Pe(e,t,i,n){const r=new zt(e,t,i,n);return function(o){return r.solve(o)}}const be=Pe(.25,.1,.25,1);function Lt(e,t,i){return Math.min(i,Math.max(t,e))}function Fe(e,t,i){return(i=Lt((i-e)/(t-e),0,1))*i*(3-2*i)}function Me(e,t,i){const n=i-t,r=((e-t)%n+n)%n+t;return r===t?i:r}function Ii(e,t,i){if(!e.length)return i(null,[]);let n=e.length;const r=new Array(e.length);let o=null;e.forEach((s,a)=>{t(s,(l,c)=>{l&&(o=l),r[a]=c,--n==0&&i(o,r)})})}function Oi(e){const t=[];for(const i in e)t.push(e[i]);return t}function Vt(e,...t){for(const i of t)for(const n in i)e[n]=i[n];return e}function Ve(e,t){const i={};for(let n=0;n<t.length;n++){const r=t[n];r in e&&(i[r]=e[r])}return i}let rn=1;function ae(){return rn++}function Te(){return function e(t){return t?(t^Math.random()*(16>>t/4)).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,e)}()}function Oe(e){return e<=1?1:Math.pow(2,Math.ceil(Math.log(e)/Math.LN2))}function Jt(e){return!!e&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)}function Xe(e,t){e.forEach(i=>{t[i]&&(t[i]=t[i].bind(t))})}function mi(e,t){return e.indexOf(t,e.length-t.length)!==-1}function gi(e,t,i){const n={};for(const r in e)n[r]=t.call(i||this,e[r],r,e);return n}function Dt(e,t,i){const n={};for(const r in e)t.call(i||this,e[r],r,e)&&(n[r]=e[r]);return n}function F(e){return Array.isArray(e)?e.map(F):typeof e=="object"&&e?gi(e,F):e}const q={};function J(e){q[e]||(typeof console<"u"&&console.warn(e),q[e]=!0)}function At(e,t,i){return(i.y-e.y)*(t.x-e.x)>(t.y-e.y)*(i.x-e.x)}function Ct(e){let t=0;for(let i,n,r=0,o=e.length,s=o-1;r<o;s=r++)i=e[r],n=e[s],t+=(n.x-i.x)*(i.y+n.y);return t}function ee([e,t,i]){const n=wt(t+90),r=wt(i);return{x:e*Math.cos(n)*Math.sin(r),y:e*Math.sin(n)*Math.sin(r),z:e*Math.cos(r),azimuthal:t,polar:i}}function ie(e,t,i){const n=Math.sqrt(e*e+t*t+i*i),r=n>0?Math.acos(i/n)*Ot:0;let o=e!==0||t!==0?Math.atan2(-t,-e)*Ot+90:0;return o<0&&(o+=360),[n,o,r]}function Pt(){return typeof WorkerGlobalScope<"u"&&typeof self<"u"&&self instanceof WorkerGlobalScope}function Xt(e){const t={};if(e.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(i,n,r,o)=>{const s=r||o;return t[n]=!s||s.toLowerCase(),""}),t["max-age"]){const i=parseInt(t["max-age"],10);isNaN(i)?delete t["max-age"]:t["max-age"]=i}return t}let ue=null;function de(){return!!I.document.fullscreenElement||!!I.document.webkitFullscreenElement}function di(e){try{const t=I[e];return t.setItem("_mapbox_test_",1),t.removeItem("_mapbox_test_"),!0}catch{return!1}}function Ci(e,t){return[e[4*t],e[4*t+1],e[4*t+2],e[4*t+3]]}function Xi(e,t,i){e[4*t+0]=i[0],e[4*t+1]=i[1],e[4*t+2]=i[2],e[4*t+3]=i[3]}function ri(e,t){return[Math.pow(e[0],2.2)*t,Math.pow(e[1],2.2)*t,Math.pow(e[2],2.2)*t]}function Vi(e){return[Math.pow(e[0],1/2.2),Math.pow(e[1],1/2.2),Math.pow(e[2],1/2.2)]}const Ei="mapbox-tiles";let tn=500,ln=50,hn,Be;function Di(){try{return I.caches}catch{}}function Ji(){Di()&&!hn&&(hn=I.caches.open(Ei))}function Un(e){const t=e.indexOf("?");if(t<0)return e;const i=function(r){const o=r.indexOf("?");return o>0?r.slice(o+1).split("&"):[]}(e),n=i.filter(r=>{const o=r.split("=");return o[0]==="language"||o[0]==="worldview"});return n.length?`${e.slice(0,t)}?${n.join("&")}`:e.slice(0,t)}let Vn=1/0;function Bn(e){Vn++,Vn>ln&&(e.getActor().send("enforceCacheSizeLimit",tn),Vn=0)}const xt={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Image:"Image",Model:"Model"};typeof Object.freeze=="function"&&Object.freeze(xt);class St extends Error{constructor(t,i,n){i===401&&Ki(n)&&(t+=": you may have provided an invalid Mapbox access token. See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes"),super(t),this.status=i,this.url=n}toString(){return`${this.name}: ${this.message} (${this.status}): ${this.url}`}}const Rt=Pt()?()=>self.worker&&self.worker.referrer:()=>(I.location.protocol==="blob:"?I.parent:I).location.href,Ft=function(e,t){if(!(/^file:/.test(i=e.url)||/^file:/.test(Rt())&&!/^\w+:/.test(i))){if(I.fetch&&I.Request&&I.AbortController&&I.Request.prototype.hasOwnProperty("signal"))return function(n,r){const o=new I.AbortController,s=new I.Request(n.url,{method:n.method||"GET",body:n.body,credentials:n.credentials,headers:n.headers,referrer:Rt(),referrerPolicy:n.referrerPolicy,signal:o.signal});let a=!1,l=!1;const c=(u=s.url).indexOf("sku=")>0&&Ki(u);var u;n.type==="json"&&s.headers.set("Accept","application/json");const h=(p,_,g)=>{if(l)return;if(p&&p.message!=="SecurityError"&&J(p.toString()),_&&g)return d(_);const y=Date.now();I.fetch(s).then(x=>{if(x.ok){const b=c?x.clone():null;return d(x,b,y)}return r(new St(x.statusText,x.status,n.url))}).catch(x=>{x.name!=="AbortError"&&r(new Error(`${x.message} ${n.url}`))})},d=(p,_,g)=>{(n.type==="arrayBuffer"?p.arrayBuffer():n.type==="json"?p.json():p.text()).then(y=>{l||(_&&g&&function(x,b,M){if(Ji(),!hn)return;const E={status:b.status,statusText:b.statusText,headers:new I.Headers};b.headers.forEach((D,z)=>E.headers.set(z,D));const T=Xt(b.headers.get("Cache-Control")||"");if(T["no-store"])return;T["max-age"]&&E.headers.set("Expires",new Date(M+1e3*T["max-age"]).toUTCString());const S=E.headers.get("Expires");S&&(new Date(S).getTime()-M<42e4||function(D,z){if(Be===void 0)try{new Response(new ReadableStream),Be=!0}catch{Be=!1}Be?z(D.body):D.blob().then(z)}(b,D=>{const z=new I.Response(D,E);Ji(),hn&&hn.then(L=>L.put(Un(x.url),z)).catch(L=>J(L.message))}))}(s,_,g),a=!0,r(null,y,p.headers.get("Cache-Control"),p.headers.get("Expires")))}).catch(y=>{l||r(new Error(y.message))})};return c?function(p,_){if(Ji(),!hn)return _(null);const g=Un(p.url);hn.then(y=>{y.match(g).then(x=>{const b=function(M){if(!M)return!1;const E=new Date(M.headers.get("Expires")||0),T=Xt(M.headers.get("Cache-Control")||"");return E>Date.now()&&!T["no-cache"]}(x);y.delete(g),b&&y.put(g,x.clone()),_(null,x,b)}).catch(_)}).catch(_)}(s,h):h(null,null),{cancel:()=>{l=!0,a||o.abort()}}}(e,t);if(Pt()&&self.worker&&self.worker.actor)return self.worker.actor.send("getResource",e,t,void 0,!0)}var i;return function(n,r){const o=new I.XMLHttpRequest;o.open(n.method||"GET",n.url,!0),n.type==="arrayBuffer"&&(o.responseType="arraybuffer");for(const s in n.headers)o.setRequestHeader(s,n.headers[s]);return n.type==="json"&&(o.responseType="text",o.setRequestHeader("Accept","application/json")),o.withCredentials=n.credentials==="include",o.onerror=()=>{r(new Error(o.statusText))},o.onload=()=>{if((o.status>=200&&o.status<300||o.status===0)&&o.response!==null){let s=o.response;if(n.type==="json")try{s=JSON.parse(o.response)}catch(a){return r(a)}r(null,s,o.getResponseHeader("Cache-Control"),o.getResponseHeader("Expires"))}else r(new St(o.statusText,o.status,n.url))},o.send(n.body),{cancel:()=>o.abort()}}(e,t)},Ut=function(e,t){return Ft(Vt(e,{type:"json"}),t)},Ht=function(e,t){return Ft(Vt(e,{type:"arrayBuffer"}),t)};function Kt(e){const t=I.document.createElement("a");return t.href=e,t.protocol===I.document.location.protocol&&t.host===I.document.location.host}const qt="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";let se,Yt;se=[],Yt=0;const Ee=function(e,t){if(Q.supported&&(e.headers||(e.headers={}),e.headers.accept="image/webp,*/*"),Yt>=j.MAX_PARALLEL_IMAGE_REQUESTS){const o={requestParameters:e,callback:t,cancelled:!1,cancel(){this.cancelled=!0}};return se.push(o),o}Yt++;let i=!1;const n=()=>{if(!i)for(i=!0,Yt--;se.length&&Yt<j.MAX_PARALLEL_IMAGE_REQUESTS;){const o=se.shift(),{requestParameters:s,callback:a,cancelled:l}=o;l||(o.cancel=Ee(s,a).cancel)}},r=Ht(e,(o,s,a,l)=>{n(),o?t(o):s&&(I.createImageBitmap?function(c,u){const h=new I.Blob([new Uint8Array(c)],{type:"image/png"});I.createImageBitmap(h).then(d=>{u(null,d)}).catch(d=>{u(new Error(`Could not load image because of ${d.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))})}(s,(c,u)=>t(c,u,a,l)):function(c,u){const h=new I.Image,d=I.URL;h.onload=()=>{u(null,h),d.revokeObjectURL(h.src),h.onload=null,I.requestAnimationFrame(()=>{h.src=qt})},h.onerror=()=>u(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const p=new I.Blob([new Uint8Array(c)],{type:"image/png"});h.src=c.byteLength?d.createObjectURL(p):qt}(s,(c,u)=>t(c,u,a,l)))});return{cancel:()=>{r.cancel(),n()}}},yi="NO_ACCESS_TOKEN";class fe{constructor(t,i,n){this._transformRequestFn=t,this._customAccessToken=i,this._silenceAuthErrors=!!n,this._createSkuToken()}_createSkuToken(){const t=function(){let i="";for(let n=0;n<10;n++)i+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1",Bt,i].join(""),tokenExpiresAt:Date.now()+432e5}}();this._skuToken=t.token,this._skuTokenExpiresAt=t.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(t,i){return this._transformRequestFn&&this._transformRequestFn(t,i)||{url:t}}normalizeStyleURL(t,i){if(!li(t))return t;const n=xn(t);return n.params.push(`sdk=js-${B}`),n.path=`/styles/v1${n.path}`,this._makeAPIURL(n,this._customAccessToken||i)}normalizeGlyphsURL(t,i){if(!li(t))return t;const n=xn(t);return n.path=`/fonts/v1${n.path}`,this._makeAPIURL(n,this._customAccessToken||i)}normalizeModelURL(t,i){if(!li(t))return t;const n=xn(t);return n.path=`/models/v1${n.path}`,this._makeAPIURL(n,this._customAccessToken||i)}normalizeSourceURL(t,i,n,r){if(!li(t))return t;const o=xn(t);return o.path=`/v4/${o.authority}.json`,o.params.push("secure"),n&&o.params.push(`language=${n}`),r&&o.params.push(`worldview=${r}`),this._makeAPIURL(o,this._customAccessToken||i)}normalizeSpriteURL(t,i,n,r){const o=xn(t);return li(t)?(o.path=`/styles/v1${o.path}/sprite${i}${n}`,this._makeAPIURL(o,this._customAccessToken||r)):(o.path+=`${i}${n}`,gn(o))}normalizeTileURL(t,i,n){if(this._isSkuTokenExpired()&&this._createSkuToken(),t&&!li(t))return t;const r=xn(t);r.path=r.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${i||n&&r.authority!=="raster"&&n===512?"@2x":""}${Q.supported?".webp":"$1"}`),r.authority==="raster"?r.path=`/${j.RASTER_URL_PREFIX}${r.path}`:(r.path=r.path.replace(/^.+\/v4\//,"/"),r.path=`/${j.TILE_URL_VERSION}${r.path}`);const o=this._customAccessToken||function(s){for(const a of s){const l=a.match(/^access_token=(.*)$/);if(l)return l[1]}return null}(r.params)||j.ACCESS_TOKEN;return j.REQUIRE_ACCESS_TOKEN&&o&&this._skuToken&&r.params.push(`sku=${this._skuToken}`),this._makeAPIURL(r,o)}canonicalizeTileURL(t,i){const n=xn(t);if(!n.path.match(/^(\/v4\/|\/raster\/v1\/)/)||!n.path.match(/\.[\w]+$/))return t;let r="mapbox://";n.path.match(/^\/raster\/v1\//)?r+=`raster/${n.path.replace(`/${j.RASTER_URL_PREFIX}/`,"")}`:r+=`tiles/${n.path.replace(`/${j.TILE_URL_VERSION}/`,"")}`;let o=n.params;return i&&(o=o.filter(s=>!s.match(/^access_token=/))),o.length&&(r+=`?${o.join("&")}`),r}canonicalizeTileset(t,i){const n=!!i&&li(i),r=[];for(const o of t.tiles||[])Ki(o)?r.push(this.canonicalizeTileURL(o,n)):r.push(o);return r}_makeAPIURL(t,i){const n="See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes",r=xn(j.API_URL);if(t.protocol=r.protocol,t.authority=r.authority,t.protocol==="http"){const o=t.params.indexOf("secure");o>=0&&t.params.splice(o,1)}if(r.path!=="/"&&(t.path=`${r.path}${t.path}`),!j.REQUIRE_ACCESS_TOKEN)return gn(t);if(i=i||j.ACCESS_TOKEN,!this._silenceAuthErrors){if(!i)throw new Error(`An API access token is required to use Mapbox GL. ${n}`);if(i[0]==="s")throw new Error(`Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ${n}`)}return t.params=t.params.filter(o=>o.indexOf("access_token")===-1),t.params.push(`access_token=${i||""}`),gn(t)}}function li(e){return e.indexOf("mapbox:")===0}function Ki(e){return j.API_URL_REGEX.test(e)}function ki(e){return j.API_CDN_URL_REGEX.test(e)}function Qi(e){return j.API_STYLE_REGEX.test(e)&&!vn(e)}function vn(e){return j.API_SPRITE_REGEX.test(e)}const Gn=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function xn(e){const t=e.match(Gn);if(!t)throw new Error("Unable to parse URL object");return{protocol:t[1],authority:t[2],path:t[3]||"/",params:t[4]?t[4].split("&"):[]}}function gn(e){const t=e.params.length?`?${e.params.join("&")}`:"";return`${e.protocol}://${e.authority}${e.path}${t}`}const kn="mapbox.eventData";function qo(e){if(!e)return null;const t=e.split(".");if(!t||t.length!==3)return null;try{return JSON.parse(decodeURIComponent(I.atob(t[1]).split("").map(i=>"%"+("00"+i.charCodeAt(0).toString(16)).slice(-2)).join("")))}catch{return null}}class qr{constructor(t){this.type=t,this.anonId=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(t){const i=qo(j.ACCESS_TOKEN);let n="";return n=i&&i.u?I.btoa(encodeURIComponent(i.u).replace(/%([0-9A-F]{2})/g,(r,o)=>String.fromCharCode(+("0x"+o)))):j.ACCESS_TOKEN||"",t?`${kn}.${t}:${n}`:`${kn}:${n}`}fetchEventData(){const t=di("localStorage"),i=this.getStorageKey(),n=this.getStorageKey("uuid");if(t)try{const r=I.localStorage.getItem(i);r&&(this.eventData=JSON.parse(r));const o=I.localStorage.getItem(n);o&&(this.anonId=o)}catch{J("Unable to read from LocalStorage")}}saveEventData(){const t=di("localStorage"),i=this.getStorageKey(),n=this.getStorageKey("uuid");if(t)try{I.localStorage.setItem(n,this.anonId),Object.keys(this.eventData).length>=1&&I.localStorage.setItem(i,JSON.stringify(this.eventData))}catch{J("Unable to write to LocalStorage")}}processRequests(t){}postEvent(t,i,n,r){if(!j.EVENTS_URL)return;const o=xn(j.EVENTS_URL);o.params.push(`access_token=${r||j.ACCESS_TOKEN||""}`);const s={event:this.type,created:new Date(t).toISOString()},a=i?Vt(s,i):s,l={url:gn(o),headers:{"Content-Type":"text/plain"},body:JSON.stringify([a])};this.pendingRequest=function(c,u){return Ft(Vt(c,{method:"POST"}),u)}(l,c=>{this.pendingRequest=null,n(c),this.saveEventData(),this.processRequests(r)})}queueRequest(t,i){this.queue.push(t),this.processRequests(i)}}const yr=new class extends qr{constructor(e){super("appUserTurnstile"),this._customAccessToken=e}postTurnstileEvent(e,t){j.EVENTS_URL&&j.ACCESS_TOKEN&&Array.isArray(e)&&e.some(i=>li(i)||Ki(i))&&this.queueRequest(Date.now(),t)}processRequests(e){if(this.pendingRequest||this.queue.length===0)return;this.anonId&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();const t=qo(j.ACCESS_TOKEN),i=t?t.u:j.ACCESS_TOKEN;let n=i!==this.eventData.tokenU;Jt(this.anonId)||(this.anonId=Te(),n=!0);const r=this.queue.shift();if(this.eventData.lastSuccess){const o=new Date(this.eventData.lastSuccess),s=new Date(r),a=(r-this.eventData.lastSuccess)/864e5;n=n||a>=1||a<-1||o.getDate()!==s.getDate()}else n=!0;n?this.postEvent(r,{sdkIdentifier:"mapbox-gl-js",sdkVersion:B,skuId:Bt,"enabled.telemetry":!1,userId:this.anonId},o=>{o||(this.eventData.lastSuccess=r,this.eventData.tokenU=i)},e):this.processRequests()}},Zo=yr.postTurnstileEvent.bind(yr),ca=new class extends qr{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(e,t,i,n){this.skuToken=t,this.errorCb=n,j.EVENTS_URL&&(i||j.ACCESS_TOKEN?this.queueRequest({id:e,timestamp:Date.now()},i):this.errorCb(new Error(yi)))}processRequests(e){if(this.pendingRequest||this.queue.length===0)return;const{id:t,timestamp:i}=this.queue.shift();t&&this.success[t]||(this.anonId||this.fetchEventData(),Jt(this.anonId)||(this.anonId=Te()),this.postEvent(i,{sdkIdentifier:"mapbox-gl-js",sdkVersion:B,skuId:Bt,skuToken:this.skuToken,userId:this.anonId},n=>{n?this.errorCb(n):t&&(this.success[t]=!0)},e))}},ws=ca.postMapLoadEvent.bind(ca),_o=new class extends qr{constructor(){super("gljs.performance")}postPerformanceEvent(e,t){j.EVENTS_URL&&(e||j.ACCESS_TOKEN)&&this.queueRequest({timestamp:Date.now(),performanceData:t},e)}processRequests(e){if(this.pendingRequest||this.queue.length===0)return;const{timestamp:t,performanceData:i}=this.queue.shift(),n=function(r){const o=I.performance.getEntriesByType("resource"),s=I.performance.getEntriesByType("mark"),a=function(d){const p={};if(d){for(const _ in d)if(_!=="other")for(const g of d[_]){const y=`${_}ResolveRangeMin`,x=`${_}ResolveRangeMax`,b=`${_}RequestCount`,M=`${_}RequestCachedCount`;p[y]=Math.min(p[y]||1/0,g.startTime),p[x]=Math.max(p[x]||-1/0,g.responseEnd);const E=T=>{p[T]===void 0&&(p[T]=0),++p[T]};g.transferSize!==void 0&&g.transferSize===0&&E(M),E(b)}}return p}(function(d,p){const _={};if(d)for(const g of d){const y=p(g);_[y]===void 0&&(_[y]=[]),_[y].push(g)}return _}(o,Ts)),l=I.devicePixelRatio,c=I.navigator.connection||I.navigator.mozConnection||I.navigator.webkitConnection,u={counters:[],metadata:[],attributes:[]},h=(d,p,_)=>{_!=null&&d.push({name:p,value:_.toString()})};for(const d in a)h(u.counters,d,a[d]);if(r.interactionRange[0]!==1/0&&r.interactionRange[1]!==-1/0&&(h(u.counters,"interactionRangeMin",r.interactionRange[0]),h(u.counters,"interactionRangeMax",r.interactionRange[1])),s)for(const d of Object.keys(Zr)){const p=Zr[d],_=s.find(g=>g.name===p);_&&h(u.counters,p,_.startTime)}return h(u.counters,"visibilityHidden",r.visibilityHidden),h(u.attributes,"style",function(d){if(d)for(const p of d){const _=p.name.split("?")[0];if(Qi(_)){const g=_.split("/").slice(-2);if(g.length===2)return`mapbox://styles/${g[0]}/${g[1]}`}}}(o)),h(u.attributes,"terrainEnabled",r.terrainEnabled?"true":"false"),h(u.attributes,"fogEnabled",r.fogEnabled?"true":"false"),h(u.attributes,"projection",r.projection),h(u.attributes,"zoom",r.zoom),h(u.metadata,"devicePixelRatio",l),h(u.metadata,"connectionEffectiveType",c?c.effectiveType:void 0),h(u.metadata,"navigatorUserAgent",I.navigator.userAgent),h(u.metadata,"screenWidth",I.screen.width),h(u.metadata,"screenHeight",I.screen.height),h(u.metadata,"windowWidth",I.innerWidth),h(u.metadata,"windowHeight",I.innerHeight),h(u.metadata,"mapWidth",r.width/l),h(u.metadata,"mapHeight",r.height/l),h(u.metadata,"webglRenderer",r.renderer),h(u.metadata,"webglVendor",r.vendor),h(u.metadata,"sdkVersion",B),h(u.metadata,"sdkIdentifier","mapbox-gl-js"),u}(i);for(const r of n.metadata);for(const r of n.counters);for(const r of n.attributes);this.postEvent(t,n,()=>{},e)}},sc=_o.postPerformanceEvent.bind(_o),go=new class extends qr{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(e,t,i,n){if(!j.API_URL||!j.SESSION_PATH)return;const r=xn(j.API_URL+j.SESSION_PATH);r.params.push(`sku=${t||""}`),r.params.push(`access_token=${n||j.ACCESS_TOKEN||""}`);const o={url:gn(r),headers:{"Content-Type":"text/plain"}};this.pendingRequest=function(s,a){return Ft(Vt(s,{method:"GET"}),a)}(o,s=>{this.pendingRequest=null,i(s),this.saveEventData(),this.processRequests(n)})}getSessionAPI(e,t,i,n){this.skuToken=t,this.errorCb=n,j.SESSION_PATH&&j.API_URL&&(i||j.ACCESS_TOKEN?this.queueRequest({id:e,timestamp:Date.now()},i):this.errorCb(new Error(yi)))}processRequests(e){if(this.pendingRequest||this.queue.length===0)return;const{id:t,timestamp:i}=this.queue.shift();t&&this.success[t]||this.getSession(i,this.skuToken,n=>{n?this.errorCb(n):t&&(this.success[t]=!0)},e)}},ua=go.getSessionAPI.bind(go),Ho=new Set;function Wo(e,t){t?Ho.add(e):Ho.delete(e)}const Zr={create:"create",load:"load",fullLoad:"fullLoad"},Ka={mark(e){I.performance.mark(e)},measure(e,t,i){I.performance.measure(e,t,i)}};function Ts(e){const t=e.name.split("?")[0];return ki(t)&&t.includes("mapbox-gl.js")?"javascript":ki(t)&&t.includes("mapbox-gl.css")?"css":function(i){return j.API_FONTS_REGEX.test(i)}(t)?"fontRange":vn(t)?"sprite":Qi(t)?"style":function(i){return j.API_TILEJSON_REGEX.test(i)}(t)?"tilejson":"other"}const yo=I.performance;function $o(e){const t=e?e.url.toString():void 0;return yo.getEntriesByName(t)}var Ms=Es;function Es(e){return!function(t){return typeof window>"u"||typeof document>"u"?"not a browser":Array.prototype&&Array.prototype.every&&Array.prototype.filter&&Array.prototype.forEach&&Array.prototype.indexOf&&Array.prototype.lastIndexOf&&Array.prototype.map&&Array.prototype.some&&Array.prototype.reduce&&Array.prototype.reduceRight&&Array.isArray?Function.prototype&&Function.prototype.bind?Object.keys&&Object.create&&Object.getPrototypeOf&&Object.getOwnPropertyNames&&Object.isSealed&&Object.isFrozen&&Object.isExtensible&&Object.getOwnPropertyDescriptor&&Object.defineProperty&&Object.defineProperties&&Object.seal&&Object.freeze&&Object.preventExtensions?"JSON"in window&&"parse"in JSON&&"stringify"in JSON?function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var n,r,o=new Blob([""],{type:"text/javascript"}),s=URL.createObjectURL(o);try{r=new Worker(s),n=!0}catch{n=!1}return r&&r.terminate(),URL.revokeObjectURL(s),n}()?"Uint8ClampedArray"in window?ArrayBuffer.isView?function(){var n=document.createElement("canvas");n.width=n.height=1;var r=n.getContext("2d");if(!r)return!1;var o=r.getImageData(0,0,1,1);return o&&o.width===n.width}()?(ha[i=t&&t.failIfMajorPerformanceCaveat]===void 0&&(ha[i]=function(n){var r,o=function(s){var a=document.createElement("canvas"),l=Object.create(Es.webGLContextAttributes);return l.failIfMajorPerformanceCaveat=s,a.getContext("webgl",l)||a.getContext("experimental-webgl",l)}(n);if(!o)return!1;try{r=o.createShader(o.VERTEX_SHADER)}catch{return!1}return!(!r||o.isContextLost())&&(o.shaderSource(r,"void main() {}"),o.compileShader(r),o.getShaderParameter(r,o.COMPILE_STATUS)===!0)}(i)),ha[i]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL support"):"insufficient Canvas/getImageData support":"insufficient ArrayBuffer support":"insufficient Uint8ClampedArray support":"insufficient worker support":"insufficient JSON support":"insufficient Object support":"insufficient Function support":"insufficent Array support";var i}(e)}var ha={};let vo,xo,zn,Ss,bo;function ac(){return vo==null&&(vo=I.OffscreenCanvas&&new I.OffscreenCanvas(1,1).getContext("2d")&&typeof I.createImageBitmap=="function"),vo}Es.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0};const ke={now:()=>Ss!==void 0?Ss:I.performance.now(),setNow(e){Ss=e},restoreNow(){Ss=void 0},frame(e){const t=I.requestAnimationFrame(e);return{cancel:()=>I.cancelAnimationFrame(t)}},getImageData(e,t=0){const{width:i,height:n}=e;bo||(bo=I.document.createElement("canvas"));const r=bo.getContext("2d",{willReadFrequently:!0});if(!r)throw new Error("failed to create canvas 2d context");return(i>bo.width||n>bo.height)&&(bo.width=i,bo.height=n),r.clearRect(-t,-t,i+2*t,n+2*t),r.drawImage(e,0,0,i,n),r.getImageData(-t,-t,i+2*t,n+2*t)},resolveURL:e=>(xo||(xo=I.document.createElement("a")),xo.href=e,xo.href),get devicePixelRatio(){return I.devicePixelRatio},get prefersReducedMotion(){return!!I.matchMedia&&(zn==null&&(zn=I.matchMedia("(prefers-reduced-motion: reduce)")),zn.matches)},hasCanvasFingerprintNoise(){if(!ac())return!1;const e=new I.OffscreenCanvas(85,1),t=e.getContext("2d",{willReadFrequently:!0});let i=0;for(let r=0;r<e.width;++r)t.fillStyle=`rgba(${i++},${i++},${i++}, 255)`,t.fillRect(r,0,1,1);const n=t.getImageData(0,0,e.width,e.height);i=0;for(let r=0;r<n.data.length;++r)if(r%4!=3&&i++!==n.data[r])return!0;return!1}};function vi(e,t,i){const n=I.document.createElement(e);return t!==void 0&&(n.className=t),i&&i.appendChild(n),n}function Se(e,t,i){const n=I.document.createElementNS("http://www.w3.org/2000/svg",e);for(const r of Object.keys(t))n.setAttributeNS(null,r,t[r]);return i&&i.appendChild(n),n}const ji=I.document&&I.document.documentElement.style,wo=ji&&ji.userSelect!==void 0?"userSelect":"WebkitUserSelect";let lc;function da(){ji&&wo&&(lc=ji[wo],ji[wo]="none")}function cc(){ji&&wo&&(ji[wo]=lc)}function Ja(e){e.preventDefault(),e.stopPropagation(),I.removeEventListener("click",Ja,!0)}function To(){I.addEventListener("click",Ja,!0),I.setTimeout(()=>{I.removeEventListener("click",Ja,!0)},0)}function Xo(e,t){const i=e.getBoundingClientRect();return uc(e,i,t)}function fa(e,t){const i=e.getBoundingClientRect(),n=[];for(let r=0;r<t.length;r++)n.push(uc(e,i,t[r]));return n}function Qa(e){return I.InstallTrigger!==void 0&&e.button===2&&e.ctrlKey&&I.navigator.platform.toUpperCase().indexOf("MAC")>=0?0:e.button}function uc(e,t,i){const n=e.offsetWidth===t.width?1:e.offsetWidth/t.width;return new G((i.clientX-t.left)*n,(i.clientY-t.top)*n)}function pa(e,t,i){i[e]&&i[e].indexOf(t)!==-1||(i[e]=i[e]||[],i[e].push(t))}function As(e,t,i){if(i&&i[e]){const n=i[e].indexOf(t);n!==-1&&i[e].splice(n,1)}}class jt{constructor(t,i={}){Vt(this,i),this.type=t}}class Ae extends jt{constructor(t,i={}){super("error",Vt({error:t},i))}}class Mn{on(t,i){return this._listeners=this._listeners||{},pa(t,i,this._listeners),this}off(t,i){return As(t,i,this._listeners),As(t,i,this._oneTimeListeners),this}once(t,i){return i?(this._oneTimeListeners=this._oneTimeListeners||{},pa(t,i,this._oneTimeListeners),this):new Promise(n=>this.once(t,n))}fire(t,i){typeof t=="string"&&(t=new jt(t,i||{}));const n=t.type;if(this.listens(n)){t.target=this;const r=this._listeners&&this._listeners[n]?this._listeners[n].slice():[];for(const a of r)a.call(this,t);const o=this._oneTimeListeners&&this._oneTimeListeners[n]?this._oneTimeListeners[n].slice():[];for(const a of o)As(n,a,this._oneTimeListeners),a.call(this,t);const s=this._eventedParent;s&&(Vt(t,typeof this._eventedParentData=="function"?this._eventedParentData():this._eventedParentData),s.fire(t))}else t instanceof Ae&&console.error(t.error);return this}listens(t){return!!(this._listeners&&this._listeners[t]&&this._listeners[t].length>0||this._oneTimeListeners&&this._oneTimeListeners[t]&&this._oneTimeListeners[t].length>0||this._eventedParent&&this._eventedParent.listens(t))}setEventedParent(t,i){return this._eventedParent=t,this._eventedParentData=i,this}}var rt=JSON.parse('{"$version":8,"$root":{"version":{"required":true,"type":"enum","values":[8]},"fragment":{"type":"boolean"},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360},"pitch":{"type":"number","default":0},"light":{"type":"light"},"lights":{"required":false,"type":"array","value":"light-3d"},"terrain":{"type":"terrain","optional":true},"fog":{"type":"fog"},"camera":{"type":"camera"},"imports":{"type":"array","value":"import"},"schema":{"type":"schema"},"sources":{"required":true,"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string","default":"mapbox://fonts/mapbox/{fontstack}/{range}.pbf"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"required":true,"type":"array","value":"layer"},"models":{"type":"models"}},"model":{"type":"string","required":true},"import":{"id":{"type":"string","required":true},"url":{"type":"string","required":true},"config":{"type":"config"},"data":{"type":"$root"}},"config":{"*":{"type":"*"}},"schema":{"*":{"type":"option"}},"option":{"default":{"type":"*","required":true},"type":{"type":"enum","values":{"string":1,"number":1,"boolean":1,"color":1}},"array":{"type":"boolean"},"minValue":{"type":"number"},"maxValue":{"type":"number"},"stepValue":{"type":"number"},"values":{"type":"array","value":"*"},"metadata":{"type":"*"}},"models":{"*":{"type":"model"}},"light-3d":{"id":{"type":"string","required":true},"properties":{"type":"properties"},"type":{"type":"enum","values":{"ambient":{},"directional":{},"flat":{}}}},"properties":["properties_light_directional","properties_light_ambient","properties_light_flat"],"properties_light_directional":{"direction":{"type":"array","default":[210,30],"minimum":[0,0],"maximum":[360,90],"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"cast-shadows":{"type":"boolean","default":false,"expression":{},"property-type":"data-constant"},"shadow-intensity":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_ambient":{"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_flat":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"property-type":"data-constant","expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_raster_array","source_geojson","source_video","source_image","source_model"],"source_vector":{"type":{"required":true,"type":"enum","values":{"vector":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"required":true,"type":"enum","values":{"raster":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"required":true,"type":"enum","values":{"raster-dem":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":1,"mapbox":1},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_array":{"type":{"required":true,"type":"enum","values":{"raster-array":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"rasterLayers":{"type":"*"},"*":{"type":"*"}},"source_geojson":{"type":{"required":true,"type":"enum","values":{"geojson":1}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"}},"source_video":{"type":{"required":true,"type":"enum","values":{"video":1}},"urls":{"required":true,"type":"array","value":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"required":true,"type":"enum","values":{"image":1}},"url":{"required":false,"type":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_model":{"type":{"required":true,"type":"enum","values":{"model":1,"batched-model":1}},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"tiles":{"type":"array","value":"string"}},"layer":{"id":{"type":"string","required":true},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"raster":{},"hillshade":{},"model":{},"background":{},"sky":{},"slot":{}},"required":true},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"slot":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"}},"layout":["layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_hillshade","layout_background","layout_sky","layout_model"],"layout_background":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_model":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"model-id":{"type":"string","default":"","property-type":"data-driven","expression":{"parameters":["zoom","feature"]}}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"fill-extrusion-edge-radius":{"type":"number","private":true,"default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"constant"}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":1,"round":1,"square":1},"default":"butt","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":1,"round":1,"miter":1},"default":"miter","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-round-limit":{"type":"number","default":1.05,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":1,"line":1,"line-center":1},"default":"point","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-spacing":{"type":"number","default":250,"minimum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":1,"viewport-y":1,"source":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-z-elevate":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-size":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit":{"type":"enum","values":{"none":1,"width":1,"height":1,"both":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-image":{"type":"resolvedImage","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-keep-upright":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-width":{"type":"number","default":10,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":1,"left":1,"center":1,"right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","default":0,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":1,"vertical":1},"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-keep-upright":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-transform":{"type":"enum","values":{"none":1,"uppercase":1,"lowercase":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":1,"!=":1,">":1,">=":1,"<":1,"<=":1,"in":1,"!in":1,"all":1,"any":1,"none":1,"has":1,"!has":1}},"geometry_type":{"type":"enum","values":{"Point":1,"LineString":1,"Polygon":1}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":1,"exponential":1,"interval":1,"categorical":1},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":1,"lab":1,"hcl":1},"default":"rgb"},"default":{"type":"*","required":false}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"high-color":{"type":"color","property-type":"data-constant","default":"#245cdf","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"space-color":{"type":"color","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,"#010b19",7,"#367ab9"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"horizon-blend":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,0.2,7,0.1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"star-intensity":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],5,0.35,6,0],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vertical-range":{"type":"array","default":[0,0],"minimum":0,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}}},"camera":{"camera-projection":{"type":"enum","values":{"perspective":1,"orthographic":1},"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"default":"perspective","property-type":"data-constant"}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"property-type":"data-constant","expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":1,"equalEarth":1,"equirectangular":1,"lambertConformalConic":1,"mercator":1,"naturalEarth":1,"winkelTripel":1,"globe":1},"default":"mercator","required":true},"center":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-180,-90],"maximum":[180,90]},"parallels":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-90,-90],"maximum":[90,90]}},"terrain":{"source":{"type":"string","required":true},"exaggeration":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_hillshade","paint_background","paint_sky","paint_model"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-ambient-occlusion-intensity":{"property-type":"data-constant","type":"number","private":true,"default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-radius":{"property-type":"data-constant","type":"number","private":true,"default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-wall-radius":{"property-type":"data-constant","type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-radius":{"property-type":"data-constant","type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-attenuation":{"property-type":"data-constant","type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-flood-light-color":{"property-type":"data-constant","type":"color","default":"#ffffff","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-intensity":{"property-type":"data-constant","type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-wall-radius":{"property-type":"data-driven","type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-radius":{"property-type":"data-driven","type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-attenuation":{"property-type":"data-constant","type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-vertical-scale":{"property-type":"data-constant","type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-rounded-roof":{"property-type":"data-constant","type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"fill-extrusion-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-gradient":{"type":"color","expression":{"interpolated":true,"parameters":["line-progress"]},"property-type":"color-ramp"},"line-trim-offset":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"property-type":"constant"},"line-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"line-border-width":{"type":"number","private":true,"default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-border-color":{"type":"color","private":true,"default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"expression":{"interpolated":true,"parameters":["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-driven"},"text-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-image-cross-fade":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"transition":true},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","transition":true,"overridable":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-color-saturation":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{},"property-type":"data-constant"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-color":{"type":"color","expression":{"interpolated":true,"parameters":["raster-value"]},"property-type":"color-ramp"},"raster-color-mix":{"type":"array","default":[0.2126,0.7152,0.0722,0],"length":4,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color-range":{"type":"array","default":[0,1],"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-resampling":{"type":"enum","values":{"linear":1,"nearest":1},"default":"linear","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"raster-array-band":{"type":"string","required":false,"property-type":"data-constant"},"raster-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-accent-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_background":{"background-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":1,"atmosphere":1},"default":"atmosphere","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun-intensity":{"type":"number","default":10,"minimum":0,"maximum":100,"property-type":"data-constant"},"sky-gradient-center":{"type":"array","value":"number","default":[0,0],"length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient-radius":{"type":"number","default":90,"minimum":0,"maximum":180,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"expression":{"interpolated":true,"parameters":["sky-radial-progress"]},"property-type":"color-ramp"},"sky-atmosphere-halo-color":{"type":"color","default":"white","property-type":"data-constant"},"sky-atmosphere-color":{"type":"color","default":"white","property-type":"data-constant"},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_model":{"model-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"model-rotation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-scale":{"type":"array","value":"number","length":3,"default":[1,1,1],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-translation":{"type":"array","value":"number","length":3,"default":[0,0,0],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-color":{"type":"color","default":"#ffffff","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light","zoom"]},"transition":true},"model-color-mix-intensity":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-type":{"type":"enum","values":{"common-3d":1,"location-indicator":1},"default":"common-3d","property-type":"data-constant"},"model-cast-shadows":{"type":"boolean","default":true,"expression":{},"property-type":"data-constant"},"model-receive-shadows":{"type":"boolean","default":true,"expression":{},"property-type":"data-constant"},"model-ambient-occlusion-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant","transition":true},"model-emissive-strength":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-roughness":{"type":"number","default":1,"minimum":0,"maximum":1,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state"]},"transition":true},"model-height-based-emissive-strength-multiplier":{"type":"array","default":[1,1,1,1,0],"length":5,"value":"number","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"}},"transition":{"duration":{"type":"number","default":300,"minimum":0},"delay":{"type":"number","default":0,"minimum":0}},"property-type":{"data-driven":{"type":"property-type"},"color-ramp":{"type":"property-type"},"data-constant":{"type":"property-type"},"constant":{"type":"property-type"}},"promoteId":{"*":{"type":"string"}}}');class le{constructor(t,i,n,r){this.message=(t?`${t}: `:"")+n,r&&(this.identifier=r),i!=null&&i.__line__&&(this.line=i.__line__)}}class Mo extends le{}function zr(e,...t){for(const i of t)for(const n in i)e[n]=i[n];return e}function Cn(e){return e instanceof Number||e instanceof String||e instanceof Boolean?e.valueOf():e}function vr(e){if(Array.isArray(e))return e.map(vr);if(e instanceof Object&&!(e instanceof Number||e instanceof String||e instanceof Boolean)){const t={};for(const i in e)t[i]=vr(e[i]);return t}return Cn(e)}class hc extends Error{constructor(t,i){super(i),this.message=i,this.key=t}}var lr=hc;class ma{constructor(t,i=[]){this.parent=t,this.bindings={};for(const[n,r]of i)this.bindings[n]=r}concat(t){return new ma(this,t)}get(t){if(this.bindings[t])return this.bindings[t];if(this.parent)return this.parent.get(t);throw new Error(`${t} not found in scope.`)}has(t){return!!this.bindings[t]||!!this.parent&&this.parent.has(t)}}var Iu=ma;const Eo={kind:"null"},re={kind:"number"},ci={kind:"string"},xi={kind:"boolean"},hr={kind:"color"},Lr={kind:"object"},_i={kind:"value"},_a={kind:"collator"},Yo={kind:"formatted"},Is={kind:"resolvedImage"};function er(e,t){return{kind:"array",itemType:e,N:t}}function bn(e){if(e.kind==="array"){const t=bn(e.itemType);return typeof e.N=="number"?`array<${t}, ${e.N}>`:e.itemType.kind==="value"?"array":`array<${t}>`}return e.kind}const Cs=[Eo,re,ci,xi,hr,Yo,Lr,er(_i),Is];function Ko(e,t){if(t.kind==="error")return null;if(e.kind==="array"){if(t.kind==="array"&&(t.N===0&&t.itemType.kind==="value"||!Ko(e.itemType,t.itemType))&&(typeof e.N!="number"||e.N===t.N))return null}else{if(e.kind===t.kind)return null;if(e.kind==="value"){for(const i of Cs)if(!Ko(i,t))return null}}return`Expected ${bn(e)} but found ${bn(t)} instead.`}function tl(e,t){return t.some(i=>i.kind===e.kind)}function Jo(e,t){return t.some(i=>i==="null"?e===null:i==="array"?Array.isArray(e):i==="object"?e&&!Array.isArray(e)&&typeof e=="object":i===typeof e)}var el,dc={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function Qo(e){return(e=Math.round(e))<0?0:e>255?255:e}function il(e){return Qo(e[e.length-1]==="%"?parseFloat(e)/100*255:parseInt(e))}function ga(e){return(t=e[e.length-1]==="%"?parseFloat(e)/100:parseFloat(e))<0?0:t>1?1:t;var t}function hf(e,t,i){return i<0?i+=1:i>1&&(i-=1),6*i<1?e+(t-e)*i*6:2*i<1?t:3*i<2?e+(t-e)*(2/3-i)*6:e}try{el={}.parseCSSColor=function(e){var t,i=e.replace(/ /g,"").toLowerCase();if(i in dc)return dc[i].slice();if(i[0]==="#")return i.length===4?(t=parseInt(i.substr(1),16))>=0&&t<=4095?[(3840&t)>>4|(3840&t)>>8,240&t|(240&t)>>4,15&t|(15&t)<<4,1]:null:i.length===7&&(t=parseInt(i.substr(1),16))>=0&&t<=16777215?[(16711680&t)>>16,(65280&t)>>8,255&t,1]:null;var n=i.indexOf("("),r=i.indexOf(")");if(n!==-1&&r+1===i.length){var o=i.substr(0,n),s=i.substr(n+1,r-(n+1)).split(","),a=1;switch(o){case"rgba":if(s.length!==4)return null;a=ga(s.pop());case"rgb":return s.length!==3?null:[il(s[0]),il(s[1]),il(s[2]),a];case"hsla":if(s.length!==4)return null;a=ga(s.pop());case"hsl":if(s.length!==3)return null;var l=(parseFloat(s[0])%360+360)%360/360,c=ga(s[1]),u=ga(s[2]),h=u<=.5?u*(c+1):u+c-u*c,d=2*u-h;return[Qo(255*hf(d,h,l+1/3)),Qo(255*hf(d,h,l)),Qo(255*hf(d,h,l-1/3)),a];default:return null}}return null}}catch{}class xr{constructor(t,i,n,r=1){this.r=t,this.g=i,this.b=n,this.a=r}static parse(t){if(!t)return;if(t instanceof xr)return t;if(typeof t!="string")return;const i=el(t);return i?new xr(i[0]/255*i[3],i[1]/255*i[3],i[2]/255*i[3],i[3]):void 0}toString(){const[t,i,n,r]=this.toArray();return`rgba(${Math.round(t)},${Math.round(i)},${Math.round(n)},${r})`}toArray(){const{r:t,g:i,b:n,a:r}=this;return r===0?[0,0,0,0]:[255*t/r,255*i/r,255*n/r,r]}toArray01(){const{r:t,g:i,b:n,a:r}=this;return r===0?[0,0,0,0]:[t/r,i/r,n/r,r]}toArray01Scaled(t){const{r:i,g:n,b:r,a:o}=this;return o===0?[0,0,0]:[i/o*t,n/o*t,r/o*t]}toArray01PremultipliedAlpha(){const{r:t,g:i,b:n,a:r}=this;return[t,i,n,r]}toArray01Linear(){const{r:t,g:i,b:n,a:r}=this;return r===0?[0,0,0,0]:[Math.pow(t/r,2.2),Math.pow(i/r,2.2),Math.pow(n/r,2.2),r]}}xr.black=new xr(0,0,0,1),xr.white=new xr(1,1,1,1),xr.transparent=new xr(0,0,0,0),xr.red=new xr(1,0,0,1),xr.blue=new xr(0,0,1,1);var Ye=xr;class df{constructor(t,i,n){this.sensitivity=t?i?"variant":"case":i?"accent":"base",this.locale=n,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(t,i){return this.collator.compare(t,i)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class ff{constructor(t,i,n,r,o){this.text=t.normalize?t.normalize():t,this.image=i,this.scale=n,this.fontStack=r,this.textColor=o}}class br{constructor(t){this.sections=t}static fromString(t){return new br([new ff(t,null,null,null,null)])}isEmpty(){return this.sections.length===0||!this.sections.some(t=>t.text.length!==0||t.image&&t.image.namePrimary.length!==0)}static factory(t){return t instanceof br?t:br.fromString(t)}toString(){return this.sections.length===0?"":this.sections.map(t=>t.text).join("")}serialize(){const t=["format"];for(const i of this.sections){if(i.image){t.push(["image",i.image.namePrimary]);continue}t.push(i.text);const n={};i.fontStack&&(n["text-font"]=["literal",i.fontStack.split(",")]),i.scale&&(n["font-scale"]=i.scale),i.textColor&&(n["text-color"]=["rgba"].concat(i.textColor.toArray())),t.push(n)}return t}}class Hr{constructor(t){this.namePrimary=t.namePrimary,t.nameSecondary&&(this.nameSecondary=t.nameSecondary),this.available=t.available}toString(){return this.nameSecondary?`[${this.namePrimary},${this.nameSecondary}]`:this.namePrimary}static fromString(t,i){return t?new Hr({namePrimary:t,nameSecondary:i,available:!1}):null}serialize(){return this.nameSecondary?["image",this.namePrimary,this.nameSecondary]:["image",this.namePrimary]}}function Tg(e,t,i,n){return typeof e=="number"&&e>=0&&e<=255&&typeof t=="number"&&t>=0&&t<=255&&typeof i=="number"&&i>=0&&i<=255?n===void 0||typeof n=="number"&&n>=0&&n<=1?null:`Invalid rgba value [${[e,t,i,n].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${(typeof n=="number"?[e,t,i,n]:[e,t,i]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function nl(e){if(e===null||typeof e=="string"||typeof e=="boolean"||typeof e=="number"||e instanceof Ye||e instanceof df||e instanceof br||e instanceof Hr)return!0;if(Array.isArray(e)){for(const t of e)if(!nl(t))return!1;return!0}if(typeof e=="object"){for(const t in e)if(!nl(e[t]))return!1;return!0}return!1}function qn(e){if(e===null)return Eo;if(typeof e=="string")return ci;if(typeof e=="boolean")return xi;if(typeof e=="number")return re;if(e instanceof Ye)return hr;if(e instanceof df)return _a;if(e instanceof br)return Yo;if(e instanceof Hr)return Is;if(Array.isArray(e)){const t=e.length;let i;for(const n of e){const r=qn(n);if(i){if(i===r)continue;i=_i;break}i=r}return er(i||_i,t)}return Lr}function fc(e){const t=typeof e;return e===null?"":t==="string"||t==="number"||t==="boolean"?String(e):e instanceof Ye||e instanceof br||e instanceof Hr?e.toString():JSON.stringify(e)}class pf{constructor(t,i){this.type=t,this.value=i}static parse(t,i){if(t.length!==2)return i.error(`'literal' expression requires exactly one argument, but found ${t.length-1} instead.`);if(!nl(t[1]))return i.error("invalid value");const n=t[1];let r=qn(n);const o=i.expectedType;return r.kind!=="array"||r.N!==0||!o||o.kind!=="array"||typeof o.N=="number"&&o.N!==0||(r=o),new pf(r,n)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return this.type.kind==="array"||this.type.kind==="object"?["literal",this.value]:this.value instanceof Ye?["rgba"].concat(this.value.toArray()):this.value instanceof br?this.value.serialize():this.value}}var pc=pf,Kn=class{constructor(e){this.name="ExpressionEvaluationError",this.message=e}toJSON(){return this.message}};const mf={string:ci,number:re,boolean:xi,object:Lr};class _f{constructor(t,i){this.type=t,this.args=i}static parse(t,i){if(t.length<2)return i.error("Expected at least one argument.");let n,r=1;const o=t[0];if(o==="array"){let a,l;if(t.length>2){const c=t[1];if(typeof c!="string"||!(c in mf)||c==="object")return i.error('The item type argument of "array" must be one of string, number, boolean',1);a=mf[c],r++}else a=_i;if(t.length>3){if(t[2]!==null&&(typeof t[2]!="number"||t[2]<0||t[2]!==Math.floor(t[2])))return i.error('The length argument to "array" must be a positive integer literal',2);l=t[2],r++}n=er(a,l)}else n=mf[o];const s=[];for(;r<t.length;r++){const a=i.parse(t[r],r,_i);if(!a)return null;s.push(a)}return new _f(n,s)}evaluate(t){for(let i=0;i<this.args.length;i++){const n=this.args[i].evaluate(t);if(!Ko(this.type,qn(n)))return n;if(i===this.args.length-1)throw new Kn(`Expected value to be of type ${bn(this.type)}, but found ${bn(qn(n))} instead.`)}return null}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every(t=>t.outputDefined())}serialize(){const t=this.type,i=[t.kind];if(t.kind==="array"){const n=t.itemType;if(n.kind==="string"||n.kind==="number"||n.kind==="boolean"){i.push(n.kind);const r=t.N;(typeof r=="number"||this.args.length>1)&&i.push(r)}}return i.concat(this.args.map(n=>n.serialize()))}}var ts=_f;class mc{constructor(t){this.type=Yo,this.sections=t}static parse(t,i){if(t.length<2)return i.error("Expected at least one argument.");const n=t[1];if(!Array.isArray(n)&&typeof n=="object")return i.error("First argument must be an image or text section.");const r=[];let o=!1;for(let s=1;s<=t.length-1;++s){const a=t[s];if(o&&typeof a=="object"&&!Array.isArray(a)){o=!1;let l=null;if(a["font-scale"]&&(l=i.parse(a["font-scale"],1,re),!l))return null;let c=null;if(a["text-font"]&&(c=i.parse(a["text-font"],1,er(ci)),!c))return null;let u=null;if(a["text-color"]&&(u=i.parse(a["text-color"],1,hr),!u))return null;const h=r[r.length-1];h.scale=l,h.font=c,h.textColor=u}else{const l=i.parse(t[s],1,_i);if(!l)return null;const c=l.type.kind;if(c!=="string"&&c!=="value"&&c!=="null"&&c!=="resolvedImage")return i.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");o=!0,r.push({content:l,scale:null,font:null,textColor:null})}}return new mc(r)}evaluate(t){return new br(this.sections.map(i=>{const n=i.content.evaluate(t);return qn(n)===Is?new ff("",n,null,null,null):new ff(fc(n),null,i.scale?i.scale.evaluate(t):null,i.font?i.font.evaluate(t).join(","):null,i.textColor?i.textColor.evaluate(t):null)}))}eachChild(t){for(const i of this.sections)t(i.content),i.scale&&t(i.scale),i.font&&t(i.font),i.textColor&&t(i.textColor)}outputDefined(){return!1}serialize(){const t=["format"];for(const i of this.sections){t.push(i.content.serialize());const n={};i.scale&&(n["font-scale"]=i.scale.serialize()),i.font&&(n["text-font"]=i.font.serialize()),i.textColor&&(n["text-color"]=i.textColor.serialize()),t.push(n)}return t}}class _c{constructor(t,i){this.type=Is,this.inputPrimary=t,this.inputSecondary=i}static parse(t,i){if(t.length<2)return i.error("Expected two or more arguments.");const n=i.parse(t[1],1,ci);if(!n)return i.error("No image name provided.");if(t.length===2)return new _c(n);const r=i.parse(t[2],1,ci);return r?new _c(n,r):i.error("Secondary image variant is not a string.")}evaluate(t){const i=Hr.fromString(this.inputPrimary.evaluate(t),this.inputSecondary?this.inputSecondary.evaluate(t):void 0);return i&&t.availableImages&&(i.available=t.availableImages.indexOf(i.namePrimary)>-1,i.nameSecondary&&i.available&&t.availableImages&&(i.available=t.availableImages.indexOf(i.nameSecondary)>-1)),i}eachChild(t){t(this.inputPrimary),this.inputSecondary&&t(this.inputSecondary)}outputDefined(){return!1}serialize(){return this.inputSecondary?["image",this.inputPrimary.serialize(),this.inputSecondary.serialize()]:["image",this.inputPrimary.serialize()]}}function Bi(e){return e instanceof Number?"number":e instanceof String?"string":e instanceof Boolean?"boolean":Array.isArray(e)?"array":e===null?"null":typeof e}const YT={"to-boolean":xi,"to-color":hr,"to-number":re,"to-string":ci};class gf{constructor(t,i){this.type=t,this.args=i}static parse(t,i){if(t.length<2)return i.error("Expected at least one argument.");const n=t[0],r=[];let o=Eo;if(n==="to-array"){if(!Array.isArray(t[1]))return null;const s=t[1].length;if(i.expectedType){if(i.expectedType.kind!=="array")return i.error(`Expected ${i.expectedType.kind} but found array.`);o=er(i.expectedType.itemType,s)}else{if(!(s>0&&nl(t[1][0])))return null;o=er(qn(t[1][0]),s)}for(let a=0;a<s;a++){const l=t[1][a];let c;if(Bi(l)==="array")c=i.parse(l,void 0,o.itemType);else{const u=Bi(l);if(u!==o.itemType.kind)return i.error(`Expected ${o.itemType.kind} but found ${u}.`);c=i.registry.literal.parse(["literal",l===void 0?null:l],i)}if(!c)return null;r.push(c)}}else{if((n==="to-boolean"||n==="to-string")&&t.length!==2)return i.error("Expected one argument.");o=YT[n];for(let s=1;s<t.length;s++){const a=i.parse(t[s],s,_i);if(!a)return null;r.push(a)}}return new gf(o,r)}evaluate(t){if(this.type.kind==="boolean")return!!this.args[0].evaluate(t);if(this.type.kind==="color"){let i,n;for(const r of this.args){if(i=r.evaluate(t),n=null,i instanceof Ye)return i;if(typeof i=="string"){const o=t.parseColor(i);if(o)return o}else if(Array.isArray(i)&&(n=i.length<3||i.length>4?`Invalid rbga value ${JSON.stringify(i)}: expected an array containing either three or four numeric values.`:Tg(i[0],i[1],i[2],i[3]),!n))return new Ye(i[0]/255,i[1]/255,i[2]/255,i[3])}throw new Kn(n||`Could not parse color from value '${typeof i=="string"?i:String(JSON.stringify(i))}'`)}if(this.type.kind==="number"){let i=null;for(const n of this.args){if(i=n.evaluate(t),i===null)return 0;const r=Number(i);if(!isNaN(r))return r}throw new Kn(`Could not convert ${JSON.stringify(i)} to number.`)}return this.type.kind==="formatted"?br.fromString(fc(this.args[0].evaluate(t))):this.type.kind==="resolvedImage"?Hr.fromString(fc(this.args[0].evaluate(t))):this.type.kind==="array"?this.args.map(i=>i.evaluate(t)):fc(this.args[0].evaluate(t))}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every(t=>t.outputDefined())}serialize(){if(this.type.kind==="formatted")return new mc([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if(this.type.kind==="resolvedImage")return new _c(this.args[0]).serialize();const t=this.type.kind==="array"?[]:[`to-${this.type.kind}`];return this.eachChild(i=>{t.push(i.serialize())}),t}}var ya=gf;const KT=["Unknown","Point","LineString","Polygon"];var Mg=class{constructor(e){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null,this.options=e}id(){return this.feature&&this.feature.id!==void 0?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?KT[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}measureLight(e){return this.globals.brightness||0}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const e=this.featureDistanceData.center,t=this.featureDistanceData.scale,{x:i,y:n}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(i*t-e[0])+this.featureDistanceData.bearing[1]*(n*t-e[1])}return 0}parseColor(e){let t=this._parseColorCache[e];return t||(t=this._parseColorCache[e]=Ye.parse(e)),t}getConfig(e){return this.options?this.options.get(e):null}};class va{constructor(t,i,n,r,o){this.name=t,this.type=i,this._evaluate=n,this.args=r,this._overloadIndex=o}evaluate(t){if(!this._evaluate){const i=va.definitions[this.name];this._evaluate=Array.isArray(i)?i[2]:i.overloads[this._overloadIndex][1]}return this._evaluate(t,this.args)}eachChild(t){this.args.forEach(t)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map(t=>t.serialize()))}static parse(t,i){const n=t[0],r=va.definitions[n];if(!r)return i.error(`Unknown expression "${n}". If you wanted a literal array, use ["literal", [...]].`,0);const o=Array.isArray(r)?r[0]:r.type,s=Array.isArray(r)?[[r[1],r[2]]]:r.overloads,a=[];let l=null,c=-1;for(const[u,h]of s){if(Array.isArray(u)&&u.length!==t.length-1)continue;a.push(u),c++,l=new Vg(i.registry,i.path,null,i.scope,void 0,i.options);const d=[];let p=!1;for(let _=1;_<t.length;_++){const g=t[_],y=Array.isArray(u)?u[_-1]:u.type,x=l.parse(g,1+d.length,y);if(!x){p=!0;break}d.push(x)}if(!p)if(Array.isArray(u)&&u.length!==d.length)l.error(`Expected ${u.length} arguments, but found ${d.length} instead.`);else{for(let _=0;_<d.length;_++){const g=Array.isArray(u)?u[_]:u.type,y=d[_];l.concat(_+1).checkSubtype(g,y.type)}if(l.errors.length===0)return new va(n,o,h,d,c)}}if(a.length===1)i.errors.push(...l.errors);else{const u=(a.length?a:s.map(([d])=>d)).map(JT).join(" | "),h=[];for(let d=1;d<t.length;d++){const p=i.parse(t[d],1+h.length);if(!p)return null;h.push(bn(p.type))}i.error(`Expected arguments of type ${u}, but found (${h.join(", ")}) instead.`)}return null}static register(t,i){va.definitions=i;for(const n in i)t[n]=va}}function JT(e){return Array.isArray(e)?`(${e.map(bn).join(", ")})`:`(${bn(e.type)}...)`}var So=va;class Cu{constructor(t,i,n){this.type=_a,this.locale=n,this.caseSensitive=t,this.diacriticSensitive=i}static parse(t,i){if(t.length!==2)return i.error("Expected one argument.");const n=t[1];if(typeof n!="object"||Array.isArray(n))return i.error("Collator options argument must be an object.");const r=i.parse(n["case-sensitive"]!==void 0&&n["case-sensitive"],1,xi);if(!r)return null;const o=i.parse(n["diacritic-sensitive"]!==void 0&&n["diacritic-sensitive"],1,xi);if(!o)return null;let s=null;return n.locale&&(s=i.parse(n.locale,1,ci),!s)?null:new Cu(r,o,s)}evaluate(t){return new df(this.caseSensitive.evaluate(t),this.diacriticSensitive.evaluate(t),this.locale?this.locale.evaluate(t):null)}eachChild(t){t(this.caseSensitive),t(this.diacriticSensitive),this.locale&&t(this.locale)}outputDefined(){return!1}serialize(){const t={};return t["case-sensitive"]=this.caseSensitive.serialize(),t["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(t.locale=this.locale.serialize()),["collator",t]}}var Eg={exports:{}};Eg.exports=function(){function e(n,r,o,s,a){for(;s>o;){if(s-o>600){var l=s-o+1,c=r-o+1,u=Math.log(l),h=.5*Math.exp(2*u/3),d=.5*Math.sqrt(u*h*(l-h)/l)*(c-l/2<0?-1:1);e(n,r,Math.max(o,Math.floor(r-c*h/l+d)),Math.min(s,Math.floor(r+(l-c)*h/l+d)),a)}var p=n[r],_=o,g=s;for(t(n,o,r),a(n[s],p)>0&&t(n,o,s);_<g;){for(t(n,_,g),_++,g--;a(n[_],p)<0;)_++;for(;a(n[g],p)>0;)g--}a(n[o],p)===0?t(n,o,g):t(n,++g,s),g<=r&&(o=g+1),r<=g&&(s=g-1)}}function t(n,r,o){var s=n[r];n[r]=n[o],n[o]=s}function i(n,r){return n<r?-1:n>r?1:0}return function(n,r,o,s,a){e(n,r,o||0,s||n.length-1,a||i)}}();var QT=dt(Eg.exports);function tM(e){let t=0;for(let i,n,r=0,o=e.length,s=o-1;r<o;s=r++)i=e[r],n=e[s],t+=(n.x-i.x)*(i.y+n.y);return t}function gc(e,t){e[0]=Math.min(e[0],t[0]),e[1]=Math.min(e[1],t[1]),e[2]=Math.max(e[2],t[0]),e[3]=Math.max(e[3],t[1])}function yc(e,t){return!(e[0]<=t[0]||e[2]>=t[2]||e[1]<=t[1]||e[3]>=t[3])}function eM(e,t,i){const n=e[0]-t[0],r=e[1]-t[1],o=e[0]-i[0],s=e[1]-i[1];return n*s-o*r==0&&n*o<=0&&r*s<=0}function rl(e,t,i=!1){let n=!1;for(let a=0,l=t.length;a<l;a++){const c=t[a];for(let u=0,h=c.length,d=h-1;u<h;d=u++){const p=c[d],_=c[u];if(eM(e,p,_))return i;(o=p)[1]>(r=e)[1]!=(s=_)[1]>r[1]&&r[0]<(s[0]-o[0])*(r[1]-o[1])/(s[1]-o[1])+o[0]&&(n=!n)}}var r,o,s;return n}function Sg(e,t,i,n){const r=n[0]-i[0],o=n[1]-i[1],s=(e[0]-i[0])*o-r*(e[1]-i[1]),a=(t[0]-i[0])*o-r*(t[1]-i[1]);return s>0&&a<0||s<0&&a>0}function Du(e,t,i,n){return(r=[n[0]-i[0],n[1]-i[1]])[0]*(o=[t[0]-e[0],t[1]-e[1]])[1]-r[1]*o[0]!=0&&!(!Sg(e,t,i,n)||!Sg(i,n,e,t));var r,o}const Ds=8192;function iM(e,t){const i=(180+e[0])/360,n=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+e[1]*Math.PI/360)))/360,r=Math.pow(2,t.z);return[Math.round(i*r*Ds),Math.round(n*r*Ds)]}function nM(e,t){for(let i=0;i<t.length;i++)if(rl(e,t[i]))return!0;return!1}function rM(e,t,i){for(const n of i)for(let r=0,o=n.length,s=o-1;r<o;s=r++)if(Du(e,t,n[s],n[r]))return!0;return!1}function Ag(e,t){for(let i=0;i<e.length;++i)if(!rl(e[i],t))return!1;for(let i=0;i<e.length-1;++i)if(rM(e[i],e[i+1],t))return!1;return!0}function oM(e,t){for(let i=0;i<t.length;i++)if(Ag(e,t[i]))return!0;return!1}function yf(e,t,i){const n=[];for(let r=0;r<e.length;r++){const o=[];for(let s=0;s<e[r].length;s++){const a=iM(e[r][s],i);gc(t,a),o.push(a)}n.push(o)}return n}function Ig(e,t,i){const n=[];for(let r=0;r<e.length;r++){const o=yf(e[r],t,i);n.push(o)}return n}function Cg(e,t,i,n){if(e[0]<i[0]||e[0]>i[2]){const r=.5*n;let o=e[0]-i[0]>r?-n:i[0]-e[0]>r?n:0;o===0&&(o=e[0]-i[2]>r?-n:i[2]-e[0]>r?n:0),e[0]+=o}gc(t,e)}function Dg(e,t,i,n){const r=Math.pow(2,n.z)*Ds,o=[n.x*Ds,n.y*Ds],s=[];if(!e)return s;for(const a of e)for(const l of a){const c=[l.x+o[0],l.y+o[1]];Cg(c,t,i,r),s.push(c)}return s}function Pg(e,t,i,n){const r=Math.pow(2,n.z)*Ds,o=[n.x*Ds,n.y*Ds],s=[];if(!e)return s;for(const l of e){const c=[];for(const u of l){const h=[u.x+o[0],u.y+o[1]];gc(t,h),c.push(h)}s.push(c)}if(t[2]-t[0]<=r/2){(a=t)[0]=a[1]=1/0,a[2]=a[3]=-1/0;for(const l of s)for(const c of l)Cg(c,t,i,r)}var a;return s}class vc{constructor(t,i){this.type=xi,this.geojson=t,this.geometries=i}static parse(t,i){if(t.length!==2)return i.error(`'within' expression requires exactly one argument, but found ${t.length-1} instead.`);if(nl(t[1])){const n=t[1];if(n.type==="FeatureCollection")for(let r=0;r<n.features.length;++r){const o=n.features[r].geometry.type;if(o==="Polygon"||o==="MultiPolygon")return new vc(n,n.features[r].geometry)}else if(n.type==="Feature"){const r=n.geometry.type;if(r==="Polygon"||r==="MultiPolygon")return new vc(n,n.geometry)}else if(n.type==="Polygon"||n.type==="MultiPolygon")return new vc(n,n)}return i.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(t){if(t.geometry()!=null&&t.canonicalID()!=null){if(t.geometryType()==="Point")return function(i,n){const r=[1/0,1/0,-1/0,-1/0],o=[1/0,1/0,-1/0,-1/0],s=i.canonicalID();if(!s)return!1;if(n.type==="Polygon"){const a=yf(n.coordinates,o,s),l=Dg(i.geometry(),r,o,s);if(!yc(r,o))return!1;for(const c of l)if(!rl(c,a))return!1}if(n.type==="MultiPolygon"){const a=Ig(n.coordinates,o,s),l=Dg(i.geometry(),r,o,s);if(!yc(r,o))return!1;for(const c of l)if(!nM(c,a))return!1}return!0}(t,this.geometries);if(t.geometryType()==="LineString")return function(i,n){const r=[1/0,1/0,-1/0,-1/0],o=[1/0,1/0,-1/0,-1/0],s=i.canonicalID();if(!s)return!1;if(n.type==="Polygon"){const a=yf(n.coordinates,o,s),l=Pg(i.geometry(),r,o,s);if(!yc(r,o))return!1;for(const c of l)if(!Ag(c,a))return!1}if(n.type==="MultiPolygon"){const a=Ig(n.coordinates,o,s),l=Pg(i.geometry(),r,o,s);if(!yc(r,o))return!1;for(const c of l)if(!oM(c,a))return!1}return!0}(t,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}var vf=vc,kg={exports:{}};kg.exports=function(){var e={kilometers:1,miles:.621371192237334,nauticalmiles:.5399568034557235,meters:1e3,metres:1e3,yards:1093.6132983377079,feet:3280.839895013123,inches:39370.078740157485},t=1/298.257223563,i=t*(2-t),n=Math.PI/180,r=function(c,u){if(c===void 0)throw new Error("No latitude given.");if(u&&!e[u])throw new Error("Unknown unit "+u+". Use one of: "+Object.keys(e).join(", "));var h=6378.137*n*(u?e[u]:1),d=Math.cos(c*n),p=1/(1-i*(1-d*d)),_=Math.sqrt(p);this.kx=h*_*d,this.ky=h*_*p*(1-i)},o={units:{configurable:!0}};function s(c,u){return c[0]===u[0]&&c[1]===u[1]}function a(c,u,h){var d=l(u[0]-c[0]);return[c[0]+d*h,c[1]+(u[1]-c[1])*h]}function l(c){for(;c<-180;)c+=360;for(;c>180;)c-=360;return c}return r.fromTile=function(c,u,h){var d=Math.PI*(1-2*(c+.5)/Math.pow(2,u)),p=Math.atan(.5*(Math.exp(d)-Math.exp(-d)))/n;return new r(p,h)},o.units.get=function(){return e},r.prototype.distance=function(c,u){var h=l(c[0]-u[0])*this.kx,d=(c[1]-u[1])*this.ky;return Math.sqrt(h*h+d*d)},r.prototype.bearing=function(c,u){var h=l(u[0]-c[0])*this.kx;return Math.atan2(h,(u[1]-c[1])*this.ky)/n},r.prototype.destination=function(c,u,h){var d=h*n;return this.offset(c,Math.sin(d)*u,Math.cos(d)*u)},r.prototype.offset=function(c,u,h){return[c[0]+u/this.kx,c[1]+h/this.ky]},r.prototype.lineDistance=function(c){for(var u=0,h=0;h<c.length-1;h++)u+=this.distance(c[h],c[h+1]);return u},r.prototype.area=function(c){for(var u=0,h=0;h<c.length;h++)for(var d=c[h],p=0,_=d.length,g=_-1;p<_;g=p++)u+=l(d[p][0]-d[g][0])*(d[p][1]+d[g][1])*(h?-1:1);return Math.abs(u)/2*this.kx*this.ky},r.prototype.along=function(c,u){var h=0;if(u<=0)return c[0];for(var d=0;d<c.length-1;d++){var p=c[d],_=c[d+1],g=this.distance(p,_);if((h+=g)>u)return a(p,_,(u-(h-g))/g)}return c[c.length-1]},r.prototype.pointToSegmentDistance=function(c,u,h){var d=u[0],p=u[1],_=l(h[0]-d)*this.kx,g=(h[1]-p)*this.ky,y=0;return _===0&&g===0||((y=(l(c[0]-d)*this.kx*_+(c[1]-p)*this.ky*g)/(_*_+g*g))>1?(d=h[0],p=h[1]):y>0&&(d+=_/this.kx*y,p+=g/this.ky*y)),_=l(c[0]-d)*this.kx,g=(c[1]-p)*this.ky,Math.sqrt(_*_+g*g)},r.prototype.pointOnLine=function(c,u){for(var h,d,p,_,g=1/0,y=0;y<c.length-1;y++){var x=c[y][0],b=c[y][1],M=l(c[y+1][0]-x)*this.kx,E=(c[y+1][1]-b)*this.ky,T=0;M===0&&E===0||((T=(l(u[0]-x)*this.kx*M+(u[1]-b)*this.ky*E)/(M*M+E*E))>1?(x=c[y+1][0],b=c[y+1][1]):T>0&&(x+=M/this.kx*T,b+=E/this.ky*T));var S=(M=l(u[0]-x)*this.kx)*M+(E=(u[1]-b)*this.ky)*E;S<g&&(g=S,h=x,d=b,p=y,_=T)}return{point:[h,d],index:p,t:Math.max(0,Math.min(1,_))}},r.prototype.lineSlice=function(c,u,h){var d=this.pointOnLine(h,c),p=this.pointOnLine(h,u);if(d.index>p.index||d.index===p.index&&d.t>p.t){var _=d;d=p,p=_}var g=[d.point],y=d.index+1,x=p.index;!s(h[y],g[0])&&y<=x&&g.push(h[y]);for(var b=y+1;b<=x;b++)g.push(h[b]);return s(h[x],p.point)||g.push(p.point),g},r.prototype.lineSliceAlong=function(c,u,h){for(var d=0,p=[],_=0;_<h.length-1;_++){var g=h[_],y=h[_+1],x=this.distance(g,y);if((d+=x)>c&&p.length===0&&p.push(a(g,y,(c-(d-x))/x)),d>=u)return p.push(a(g,y,(u-(d-x))/x)),p;d>c&&p.push(y)}return p},r.prototype.bufferPoint=function(c,u){var h=u/this.ky,d=u/this.kx;return[c[0]-d,c[1]-h,c[0]+d,c[1]+h]},r.prototype.bufferBBox=function(c,u){var h=u/this.ky,d=u/this.kx;return[c[0]-d,c[1]-h,c[2]+d,c[3]+h]},r.prototype.insideBBox=function(c,u){return l(c[0]-u[0])>=0&&l(c[0]-u[2])<=0&&c[1]>=u[1]&&c[1]<=u[3]},Object.defineProperties(r,o),r}();var xf=dt(kg.exports),zg={exports:{}};zg.exports=function(){var e=function(i,n){if(i===void 0&&(i=[]),n===void 0&&(n=t),this.data=i,this.length=this.data.length,this.compare=n,this.length>0)for(var r=(this.length>>1)-1;r>=0;r--)this._down(r)};function t(i,n){return i<n?-1:i>n?1:0}return e.prototype.push=function(i){this.data.push(i),this.length++,this._up(this.length-1)},e.prototype.pop=function(){if(this.length!==0){var i=this.data[0],n=this.data.pop();return this.length--,this.length>0&&(this.data[0]=n,this._down(0)),i}},e.prototype.peek=function(){return this.data[0]},e.prototype._up=function(i){for(var n=this.data,r=this.compare,o=n[i];i>0;){var s=i-1>>1,a=n[s];if(r(o,a)>=0)break;n[i]=a,i=s}n[i]=o},e.prototype._down=function(i){for(var n=this.data,r=this.compare,o=this.length>>1,s=n[i];i<o;){var a=1+(i<<1),l=n[a],c=a+1;if(c<this.length&&r(n[c],l)<0&&(a=c,l=n[c]),r(l,s)>=0)break;n[i]=l,i=a}n[i]=s},e}();var bf=dt(zg.exports),pt=8192;function Lg(e,t){return t.dist-e.dist}const wf=100,Tf=50;function Rg(e){const t=[1/0,1/0,-1/0,-1/0];if(t.length!==e.length)return!1;for(let i=0;i<t.length;i++)if(t[i]!==e[i])return!1;return!0}function Pu(e){return e[1]-e[0]+1}function es(e,t){const i=e[1]>=e[0]&&e[1]<t;return i||console.warn("Distance Expression: Index is out of range"),i}function Mf(e,t){if(e[0]>e[1])return[null,null];const i=Pu(e);if(t){if(i===2)return[e,null];const n=Math.floor(i/2);return[[e[0],e[0]+n],[e[0]+n,e[1]]]}{if(i===1)return[e,null];const n=Math.floor(i/2)-1;return[[e[0],e[0]+n],[e[0]+n+1,e[1]]]}}function xa(e,t){const i=[1/0,1/0,-1/0,-1/0];if(!es(t,e.length))return i;for(let n=t[0];n<=t[1];++n)gc(i,e[n]);return i}function ku(e){const t=[1/0,1/0,-1/0,-1/0];for(let i=0;i<e.length;++i)for(let n=0;n<e[i].length;++n)gc(t,e[i][n]);return t}function ol(e,t,i){if(Rg(e)||Rg(t))return NaN;let n=0,r=0;return e[2]<t[0]&&(n=t[0]-e[2]),e[0]>t[2]&&(n=e[0]-t[2]),e[1]>t[3]&&(r=e[1]-t[3]),e[3]<t[1]&&(r=t[1]-e[3]),i.distance([0,0],[n,r])}function Ef(e,t){const i=Math.pow(2,t.z);return[(r=(e.x/pt+t.x)/i,360*r-180),(n=(e.y/pt+t.y)/i,360/Math.PI*Math.atan(Math.exp((180-360*n)*Math.PI/180))-90)];var n,r}function sM(e,t){const i=[];for(let n=0;n<e.length;++n)i.push(Ef(e[n],t));return i}function Og(e,t,i){const n=i.pointOnLine(t,e).point;return i.distance(e,n)}function Bg(e,t,i,n,r){const o=i.slice(n[0],n[1]+1);let s=1/0;for(let a=t[0];a<=t[1];++a)if((s=Math.min(s,Og(e[a],o,r)))===0)return 0;return s}function Sf(e,t,i,n,r){const o=Math.min(r.pointToSegmentDistance(e,i,n),r.pointToSegmentDistance(t,i,n)),s=Math.min(r.pointToSegmentDistance(i,e,t),r.pointToSegmentDistance(n,e,t));return Math.min(o,s)}function aM(e,t,i,n,r){if(!es(t,e.length)||!es(n,i.length))return NaN;let o=1/0;for(let s=t[0];s<t[1];++s)for(let a=n[0];a<n[1];++a){if(Du(e[s],e[s+1],i[a],i[a+1]))return 0;o=Math.min(o,Sf(e[s],e[s+1],i[a],i[a+1],r))}return o}function lM(e,t,i,n,r){if(!es(t,e.length)||!es(n,i.length))return NaN;let o=1/0;for(let s=t[0];s<=t[1];++s)for(let a=n[0];a<=n[1];++a)if((o=Math.min(o,r.distance(e[s],i[a])))===0)return o;return o}function cM(e,t,i){if(rl(e,t,!0))return 0;let n=1/0;for(const r of t){const o=r.length;if(o<2)return console.warn("Distance Expression: Invalid polygon!"),NaN;if(r[0]!==r[o-1]&&(n=Math.min(n,i.pointToSegmentDistance(e,r[o-1],r[0])))===0||(n=Math.min(n,Og(e,r,i)))===0)return n}return n}function uM(e,t,i,n){if(!es(t,e.length))return NaN;for(let o=t[0];o<=t[1];++o)if(rl(e[o],i,!0))return 0;let r=1/0;for(let o=t[0];o<t[1];++o)for(const s of i)for(let a=0,l=s.length,c=l-1;a<l;c=a++){if(Du(e[o],e[o+1],s[c],s[a]))return 0;r=Math.min(r,Sf(e[o],e[o+1],s[c],s[a],n))}return r}function Fg(e,t){for(const i of e)for(let n=0;n<=i.length-1;++n)if(rl(i[n],t,!0))return!0;return!1}function hM(e,t,i,n=1/0){const r=ku(e),o=ku(t);if(n!==1/0&&ol(r,o,i)>=n)return n;if(yc(r,o)){if(Fg(e,t))return 0}else if(Fg(t,e))return 0;let s=n;for(const a of e)for(let l=0,c=a.length,u=c-1;l<c;u=l++)for(const h of t)for(let d=0,p=h.length,_=p-1;d<p;_=d++){if(Du(a[u],a[l],h[_],h[d]))return 0;s=Math.min(s,Sf(a[u],a[l],h[_],h[d],i))}return s}function zu(e,t,i,n,r,o,s){if(o===null||s===null)return;const a=ol(xa(n,o),xa(r,s),i);a<t&&e.push({dist:a,range1:o,range2:s})}function dM(e,t,i,n,r=1/0){let o=Math.min(n.distance(e[0],i[0][0]),r);if(o===0)return o;const s=new bf([{dist:0,range1:[0,e.length-1],range2:[0,0]}],Lg),a=t?Tf:wf,l=ku(i);for(;s.length;){const c=s.pop();if(c.dist>=o)continue;const u=c.range1;if(Pu(u)<=a){if(!es(u,e.length))return NaN;if(t){const h=uM(e,u,i,n);if((o=Math.min(o,h))===0)return o}else for(let h=u[0];h<=u[1];++h){const d=cM(e[h],i,n);if((o=Math.min(o,d))===0)return o}}else{const h=Mf(u,t);if(h[0]!==null){const d=ol(xa(e,h[0]),l,n);d<o&&s.push({dist:d,range1:h[0],range2:[0,0]})}if(h[1]!==null){const d=ol(xa(e,h[1]),l,n);d<o&&s.push({dist:d,range1:h[1],range2:[0,0]})}}}return o}function Ng(e,t,i,n,r,o=1/0){let s=Math.min(o,r.distance(e[0],i[0]));if(s===0)return s;const a=new bf([{dist:0,range1:[0,e.length-1],range2:[0,i.length-1]}],Lg),l=t?Tf:wf,c=n?Tf:wf;for(;a.length;){const u=a.pop();if(u.dist>=s)continue;const h=u.range1,d=u.range2;if(Pu(h)<=l&&Pu(d)<=c){if(!es(h,e.length)||!es(d,i.length))return NaN;if(t&&n?s=Math.min(s,aM(e,h,i,d,r)):t||n?t&&!n?s=Math.min(s,Bg(i,d,e,h,r)):!t&&n&&(s=Math.min(s,Bg(e,h,i,d,r))):s=Math.min(s,lM(e,h,i,d,r)),s===0)return s}else{const p=Mf(h,t),_=Mf(d,n);zu(a,s,r,e,i,p[0],_[0]),zu(a,s,r,e,i,p[0],_[1]),zu(a,s,r,e,i,p[1],_[0]),zu(a,s,r,e,i,p[1],_[1])}}return s}function Af(e,t,i,n,r=1/0){let o=r;const s=xa(e,[0,e.length-1]);for(const a of i)if(!(o!==1/0&&ol(s,xa(a,[0,a.length-1]),n)>=o)&&(o=Math.min(o,Ng(e,t,a,!0,n,o)),o===0))return o;return o}function Lu(e,t,i,n,r=1/0){let o=r;const s=xa(e,[0,e.length-1]);for(const a of i){if(o!==1/0&&ol(s,ku(a),n)>=o)continue;const l=dM(e,t,a,n,o);if(isNaN(l))return l;if((o=Math.min(o,l))===0)return o}return o}function If(e){return e==="Point"||e==="MultiPoint"||e==="LineString"||e==="MultiLineString"||e==="Polygon"||e==="MultiPolygon"}class xc{constructor(t,i){this.type=re,this.geojson=t,this.geometries=i}static parse(t,i){if(t.length!==2)return i.error(`'distance' expression requires either one argument, but found ' ${t.length-1} instead.`);if(nl(t[1])){const n=t[1];if(n.type==="FeatureCollection"){for(let r=0;r<n.features.length;++r)if(If(n.features[r].geometry.type))return new xc(n,n.features[r].geometry)}else if(n.type==="Feature"){if(If(n.geometry.type))return new xc(n,n.geometry)}else if(If(n.type))return new xc(n,n)}return i.error("'distance' expression needs to be an array with format ['Distance', GeoJSONObj].")}evaluate(t){const i=t.geometry(),n=t.canonicalID();if(i!=null&&n!=null){if(t.geometryType()==="Point")return function(r,o,s){const a=[];for(const c of r)for(const u of c)a.push(Ef(u,o));const l=new xf(a[0][1],"meters");return s.type==="Point"||s.type==="MultiPoint"||s.type==="LineString"?Ng(a,!1,s.type==="Point"?[s.coordinates]:s.coordinates,s.type==="LineString",l):s.type==="MultiLineString"?Af(a,!1,s.coordinates,l):s.type==="Polygon"||s.type==="MultiPolygon"?Lu(a,!1,s.type==="Polygon"?[s.coordinates]:s.coordinates,l):null}(i,n,this.geometries);if(t.geometryType()==="LineString")return function(r,o,s){const a=[];for(const c of r){const u=[];for(const h of c)u.push(Ef(h,o));a.push(u)}const l=new xf(a[0][0][1],"meters");if(s.type==="Point"||s.type==="MultiPoint"||s.type==="LineString")return Af(s.type==="Point"?[s.coordinates]:s.coordinates,s.type==="LineString",a,l);if(s.type==="MultiLineString"){let c=1/0;for(let u=0;u<s.coordinates.length;u++){const h=Af(s.coordinates[u],!0,a,l,c);if(isNaN(h))return h;if((c=Math.min(c,h))===0)return c}return c}if(s.type==="Polygon"||s.type==="MultiPolygon"){let c=1/0;for(let u=0;u<a.length;u++){const h=Lu(a[u],!0,s.type==="Polygon"?[s.coordinates]:s.coordinates,l,c);if(isNaN(h))return h;if((c=Math.min(c,h))===0)return c}return c}return null}(i,n,this.geometries);if(t.geometryType()==="Polygon")return function(r,o,s){const a=[];for(const c of function(u,h){const d=u.length;if(d<=1)return[u];const p=[];let _,g;for(let y=0;y<d;y++){const x=tM(u[y]);x!==0&&(u[y].area=Math.abs(x),g===void 0&&(g=x<0),g===x<0?(_&&p.push(_),_=[u[y]]):_.push(u[y]))}return _&&p.push(_),p}(r)){const u=[];for(let h=0;h<c.length;++h)u.push(sM(c[h],o));a.push(u)}const l=new xf(a[0][0][0][1],"meters");if(s.type==="Point"||s.type==="MultiPoint"||s.type==="LineString")return Lu(s.type==="Point"?[s.coordinates]:s.coordinates,s.type==="LineString",a,l);if(s.type==="MultiLineString"){let c=1/0;for(let u=0;u<s.coordinates.length;u++){const h=Lu(s.coordinates[u],!0,a,l,c);if(isNaN(h))return h;if((c=Math.min(c,h))===0)return c}return c}return s.type==="Polygon"||s.type==="MultiPolygon"?function(c,u,h){let d=1/0;for(const p of c)for(const _ of u){const g=hM(p,_,h,d);if(isNaN(g))return g;if((d=Math.min(d,g))===0)return d}return d}(s.type==="Polygon"?[s.coordinates]:s.coordinates,a,l):null}(i,n,this.geometries);console.warn("Distance Expression: currently only evaluates valid Point/LineString/Polygon geometries.")}else console.warn("Distance Expression: requirs valid feature and canonical information.");return null}eachChild(){}outputDefined(){return!0}serialize(){return["distance",this.geojson]}}var Cf=xc;function sl(e){if(e instanceof So&&(e.name==="get"&&e.args.length===1||e.name==="feature-state"||e.name==="has"&&e.args.length===1||e.name==="properties"||e.name==="geometry-type"||e.name==="id"||/^filter-/.test(e.name))||e instanceof vf||e instanceof Cf)return!1;let t=!0;return e.eachChild(i=>{t&&!sl(i)&&(t=!1)}),t}function bc(e){if(e instanceof So&&e.name==="feature-state")return!1;let t=!0;return e.eachChild(i=>{t&&!bc(i)&&(t=!1)}),t}function Df(e){if(e instanceof So&&e.name==="config")return!1;let t=!0;return e.eachChild(i=>{t&&!Df(i)&&(t=!1)}),t}function al(e,t){if(e instanceof So&&t.indexOf(e.name)>=0)return!1;let i=!0;return e.eachChild(n=>{i&&!al(n,t)&&(i=!1)}),i}class Pf{constructor(t,i){this.type=i.type,this.name=t,this.boundExpression=i}static parse(t,i){if(t.length!==2||typeof t[1]!="string")return i.error("'var' expression requires exactly one string literal argument.");const n=t[1];return i.scope.has(n)?new Pf(n,i.scope.get(n)):i.error(`Unknown variable "${n}". Make sure "${n}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(t){return this.boundExpression.evaluate(t)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}var Ug=Pf;class kf{constructor(t,i=[],n,r=new Iu,o=[],s){this.registry=t,this.path=i,this.key=i.map(a=>`[${a}]`).join(""),this.scope=r,this.errors=o,this.expectedType=n,this.options=s}parse(t,i,n,r,o={}){return i||n?this.concat(i,n,r)._parse(t,o):this._parse(t,o)}_parse(t,i){function n(r,o,s){return s==="assert"?new ts(o,[r]):s==="coerce"?new ya(o,[r]):r}if(t!==null&&typeof t!="string"&&typeof t!="boolean"&&typeof t!="number"||(t=["literal",t]),Array.isArray(t)){if(t.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const r=typeof t[0]=="string"?this.registry[t[0]]:void 0;if(r){let o=r.parse(t,this);if(!o)return null;if(this.expectedType){const s=this.expectedType,a=o.type;if(s.kind!=="string"&&s.kind!=="number"&&s.kind!=="boolean"&&s.kind!=="object"&&s.kind!=="array"||a.kind!=="value")if(s.kind!=="color"&&s.kind!=="formatted"&&s.kind!=="resolvedImage"||a.kind!=="value"&&a.kind!=="string"){if(this.checkSubtype(s,a))return null}else o=n(o,s,i.typeAnnotation||"coerce");else o=n(o,s,i.typeAnnotation||"assert")}if(!(o instanceof pc)&&o.type.kind!=="resolvedImage"&&zf(o)){const s=new Mg(this.options);try{o=new pc(o.type,o.evaluate(s))}catch(a){return this.error(a.message),null}}return o}return ya.parse(["to-array",t],this)}return this.error(t===void 0?"'undefined' value invalid. Use null instead.":typeof t=="object"?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof t} instead.`)}concat(t,i,n){const r=typeof t=="number"?this.path.concat(t):this.path,o=n?this.scope.concat(n):this.scope;return new kf(this.registry,r,i||null,o,this.errors,this.options)}error(t,...i){const n=`${this.key}${i.map(r=>`[${r}]`).join("")}`;this.errors.push(new lr(n,t))}checkSubtype(t,i){const n=Ko(t,i);return n&&this.error(n),n}}var Vg=kf;function zf(e){if(e instanceof Ug)return zf(e.boundExpression);if(e instanceof So&&e.name==="error"||e instanceof So&&e.name==="config"||e instanceof Cu||e instanceof vf||e instanceof Cf)return!1;const t=e instanceof ya||e instanceof ts;let i=!0;return e.eachChild(n=>{i=t?i&&zf(n):i&&n instanceof pc}),!!i&&sl(e)&&al(e,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light"])}function Ru(e,t){const i=e.length-1;let n,r,o=0,s=i,a=0;for(;o<=s;)if(a=Math.floor((o+s)/2),n=e[a],r=e[a+1],n<=t){if(a===i||t<r)return a;o=a+1}else{if(!(n>t))throw new Kn("Input is not a number.");s=a-1}return 0}class Lf{constructor(t,i,n){this.type=t,this.input=i,this.labels=[],this.outputs=[];for(const[r,o]of n)this.labels.push(r),this.outputs.push(o)}static parse(t,i){if(t.length-1<4)return i.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if((t.length-1)%2!=0)return i.error("Expected an even number of arguments.");const n=i.parse(t[1],1,re);if(!n)return null;const r=[];let o=null;i.expectedType&&i.expectedType.kind!=="value"&&(o=i.expectedType);for(let s=1;s<t.length;s+=2){const a=s===1?-1/0:t[s],l=t[s+1],c=s,u=s+1;if(typeof a!="number")return i.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',c);if(r.length&&r[r.length-1][0]>=a)return i.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',c);const h=i.parse(l,u,o);if(!h)return null;o=o||h.type,r.push([a,h])}return new Lf(o,n,r)}evaluate(t){const i=this.labels,n=this.outputs;if(i.length===1)return n[0].evaluate(t);const r=this.input.evaluate(t);if(r<=i[0])return n[0].evaluate(t);const o=i.length;return r>=i[o-1]?n[o-1].evaluate(t):n[Ru(i,r)].evaluate(t)}eachChild(t){t(this.input);for(const i of this.outputs)t(i)}outputDefined(){return this.outputs.every(t=>t.outputDefined())}serialize(){const t=["step",this.input.serialize()];for(let i=0;i<this.labels.length;i++)i>0&&t.push(this.labels[i]),t.push(this.outputs[i].serialize());return t}}var Rf=Lf;function ze(e,t,i){return e*(1-i)+t*i}function jg(e,t,i){return e.map((n,r)=>ze(n,t[r],i))}var Ou=Object.freeze({__proto__:null,array:jg,color:function(e,t,i){return new Ye(ze(e.r,t.r,i),ze(e.g,t.g,i),ze(e.b,t.b,i),ze(e.a,t.a,i))},number:ze});const Gg=.95047,qg=1.08883,Zg=4/29,ll=6/29,Hg=3*ll*ll,fM=ll*ll*ll,pM=Math.PI/180,mM=180/Math.PI;function Of(e){return e>fM?Math.pow(e,1/3):e/Hg+Zg}function Bf(e){return e>ll?e*e*e:Hg*(e-Zg)}function Ff(e){return 255*(e<=.0031308?12.92*e:1.055*Math.pow(e,1/2.4)-.055)}function Nf(e){return(e/=255)<=.04045?e/12.92:Math.pow((e+.055)/1.055,2.4)}function Wg(e){const t=Nf(e.r),i=Nf(e.g),n=Nf(e.b),r=Of((.4124564*t+.3575761*i+.1804375*n)/Gg),o=Of((.2126729*t+.7151522*i+.072175*n)/1);return{l:116*o-16,a:500*(r-o),b:200*(o-Of((.0193339*t+.119192*i+.9503041*n)/qg)),alpha:e.a}}function $g(e){let t=(e.l+16)/116,i=isNaN(e.a)?t:t+e.a/500,n=isNaN(e.b)?t:t-e.b/200;return t=1*Bf(t),i=Gg*Bf(i),n=qg*Bf(n),new Ye(Ff(3.2404542*i-1.5371385*t-.4985314*n),Ff(-.969266*i+1.8760108*t+.041556*n),Ff(.0556434*i-.2040259*t+1.0572252*n),e.alpha)}function _M(e,t,i){const n=t-e;return e+i*(n>180||n<-180?n-360*Math.round(n/360):n)}const wc={forward:Wg,reverse:$g,interpolate:function(e,t,i){return{l:ze(e.l,t.l,i),a:ze(e.a,t.a,i),b:ze(e.b,t.b,i),alpha:ze(e.alpha,t.alpha,i)}}},Tc={forward:function(e){const{l:t,a:i,b:n}=Wg(e),r=Math.atan2(n,i)*mM;return{h:r<0?r+360:r,c:Math.sqrt(i*i+n*n),l:t,alpha:e.a}},reverse:function(e){const t=e.h*pM,i=e.c;return $g({l:e.l,a:Math.cos(t)*i,b:Math.sin(t)*i,alpha:e.alpha})},interpolate:function(e,t,i){return{h:_M(e.h,t.h,i),c:ze(e.c,t.c,i),l:ze(e.l,t.l,i),alpha:ze(e.alpha,t.alpha,i)}}};var Xg=Object.freeze({__proto__:null,hcl:Tc,lab:wc});class Bu{constructor(t,i,n,r,o){this.type=t,this.operator=i,this.interpolation=n,this.input=r,this.labels=[],this.outputs=[];for(const[s,a]of o)this.labels.push(s),this.outputs.push(a)}static interpolationFactor(t,i,n,r){let o=0;if(t.name==="exponential")o=Uf(i,t.base,n,r);else if(t.name==="linear")o=Uf(i,1,n,r);else if(t.name==="cubic-bezier"){const s=t.controlPoints;o=new zt(s[0],s[1],s[2],s[3]).solve(Uf(i,1,n,r))}return o}static parse(t,i){let[n,r,o,...s]=t;if(!Array.isArray(r)||r.length===0)return i.error("Expected an interpolation type expression.",1);if(r[0]==="linear")r={name:"linear"};else if(r[0]==="exponential"){const c=r[1];if(typeof c!="number")return i.error("Exponential interpolation requires a numeric base.",1,1);r={name:"exponential",base:c}}else{if(r[0]!=="cubic-bezier")return i.error(`Unknown interpolation type ${String(r[0])}`,1,0);{const c=r.slice(1);if(c.length!==4||c.some(u=>typeof u!="number"||u<0||u>1))return i.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);r={name:"cubic-bezier",controlPoints:c}}}if(t.length-1<4)return i.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if((t.length-1)%2!=0)return i.error("Expected an even number of arguments.");if(o=i.parse(o,2,re),!o)return null;const a=[];let l=null;n==="interpolate-hcl"||n==="interpolate-lab"?l=hr:i.expectedType&&i.expectedType.kind!=="value"&&(l=i.expectedType);for(let c=0;c<s.length;c+=2){const u=s[c],h=s[c+1],d=c+3,p=c+4;if(typeof u!="number")return i.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',d);if(a.length&&a[a.length-1][0]>=u)return i.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',d);const _=i.parse(h,p,l);if(!_)return null;l=l||_.type,a.push([u,_])}return l.kind==="number"||l.kind==="color"||l.kind==="array"&&l.itemType.kind==="number"&&typeof l.N=="number"?new Bu(l,n,r,o,a):i.error(`Type ${bn(l)} is not interpolatable.`)}evaluate(t){const i=this.labels,n=this.outputs;if(i.length===1)return n[0].evaluate(t);const r=this.input.evaluate(t);if(r<=i[0])return n[0].evaluate(t);const o=i.length;if(r>=i[o-1])return n[o-1].evaluate(t);const s=Ru(i,r),a=Bu.interpolationFactor(this.interpolation,r,i[s],i[s+1]),l=n[s].evaluate(t),c=n[s+1].evaluate(t);return this.operator==="interpolate"?Ou[this.type.kind.toLowerCase()](l,c,a):this.operator==="interpolate-hcl"?Tc.reverse(Tc.interpolate(Tc.forward(l),Tc.forward(c),a)):wc.reverse(wc.interpolate(wc.forward(l),wc.forward(c),a))}eachChild(t){t(this.input);for(const i of this.outputs)t(i)}outputDefined(){return this.outputs.every(t=>t.outputDefined())}serialize(){let t;t=this.interpolation.name==="linear"?["linear"]:this.interpolation.name==="exponential"?this.interpolation.base===1?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier"].concat(this.interpolation.controlPoints);const i=[this.operator,t,this.input.serialize()];for(let n=0;n<this.labels.length;n++)i.push(this.labels[n],this.outputs[n].serialize());return i}}function Uf(e,t,i,n){const r=n-i,o=e-i;return r===0?0:t===1?o/r:(Math.pow(t,o)-1)/(Math.pow(t,r)-1)}var Ao=Bu;class Vf{constructor(t,i){this.type=t,this.args=i}static parse(t,i){if(t.length<2)return i.error("Expectected at least one argument.");let n=null;const r=i.expectedType;r&&r.kind!=="value"&&(n=r);const o=[];for(const a of t.slice(1)){const l=i.parse(a,1+o.length,n,void 0,{typeAnnotation:"omit"});if(!l)return null;n=n||l.type,o.push(l)}const s=r&&o.some(a=>Ko(r,a.type));return new Vf(s?_i:n,o)}evaluate(t){let i,n=null,r=0;for(const o of this.args){if(r++,n=o.evaluate(t),n&&n instanceof Hr&&!n.available&&(i||(i=n),n=null,r===this.args.length))return i;if(n!==null)break}return n}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every(t=>t.outputDefined())}serialize(){const t=["coalesce"];return this.eachChild(i=>{t.push(i.serialize())}),t}}var Yg=Vf;class jf{constructor(t,i){this.type=i.type,this.bindings=[].concat(t),this.result=i}evaluate(t){return this.result.evaluate(t)}eachChild(t){for(const i of this.bindings)t(i[1]);t(this.result)}static parse(t,i){if(t.length<4)return i.error(`Expected at least 3 arguments, but found ${t.length-1} instead.`);const n=[];for(let o=1;o<t.length-1;o+=2){const s=t[o];if(typeof s!="string")return i.error(`Expected string, but found ${typeof s} instead.`,o);if(/[^a-zA-Z0-9_]/.test(s))return i.error("Variable names must contain only alphanumeric characters or '_'.",o);const a=i.parse(t[o+1],o+1);if(!a)return null;n.push([s,a])}const r=i.parse(t[t.length-1],t.length-1,i.expectedType,n);return r?new jf(n,r):null}outputDefined(){return this.result.outputDefined()}serialize(){const t=["let"];for(const[i,n]of this.bindings)t.push(i,n.serialize());return t.push(this.result.serialize()),t}}var Kg=jf;class Gf{constructor(t,i,n){this.type=t,this.index=i,this.input=n}static parse(t,i){if(t.length!==3)return i.error(`Expected 2 arguments, but found ${t.length-1} instead.`);const n=i.parse(t[1],1,re),r=i.parse(t[2],2,er(i.expectedType||_i));return n&&r?new Gf(r.type.itemType,n,r):null}evaluate(t){const i=this.index.evaluate(t),n=this.input.evaluate(t);if(i<0)throw new Kn(`Array index out of bounds: ${i} < 0.`);if(i>=n.length)throw new Kn(`Array index out of bounds: ${i} > ${n.length-1}.`);if(i!==Math.floor(i))throw new Kn(`Array index must be an integer, but found ${i} instead.`);return n[i]}eachChild(t){t(this.index),t(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}var gM=Gf;class qf{constructor(t,i){this.type=xi,this.needle=t,this.haystack=i}static parse(t,i){if(t.length!==3)return i.error(`Expected 2 arguments, but found ${t.length-1} instead.`);const n=i.parse(t[1],1,_i),r=i.parse(t[2],2,_i);return n&&r?tl(n.type,[xi,ci,re,Eo,_i])?new qf(n,r):i.error(`Expected first argument to be of type boolean, string, number or null, but found ${bn(n.type)} instead`):null}evaluate(t){const i=this.needle.evaluate(t),n=this.haystack.evaluate(t);if(n==null)return!1;if(!Jo(i,["boolean","string","number","null"]))throw new Kn(`Expected first argument to be of type boolean, string, number or null, but found ${bn(qn(i))} instead.`);if(!Jo(n,["string","array"]))throw new Kn(`Expected second argument to be of type array or string, but found ${bn(qn(n))} instead.`);return n.indexOf(i)>=0}eachChild(t){t(this.needle),t(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}var yM=qf;class Fu{constructor(t,i,n){this.type=re,this.needle=t,this.haystack=i,this.fromIndex=n}static parse(t,i){if(t.length<=2||t.length>=5)return i.error(`Expected 3 or 4 arguments, but found ${t.length-1} instead.`);const n=i.parse(t[1],1,_i),r=i.parse(t[2],2,_i);if(!n||!r)return null;if(!tl(n.type,[xi,ci,re,Eo,_i]))return i.error(`Expected first argument to be of type boolean, string, number or null, but found ${bn(n.type)} instead`);if(t.length===4){const o=i.parse(t[3],3,re);return o?new Fu(n,r,o):null}return new Fu(n,r)}evaluate(t){const i=this.needle.evaluate(t),n=this.haystack.evaluate(t);if(!Jo(i,["boolean","string","number","null"]))throw new Kn(`Expected first argument to be of type boolean, string, number or null, but found ${bn(qn(i))} instead.`);if(!Jo(n,["string","array"]))throw new Kn(`Expected second argument to be of type array or string, but found ${bn(qn(n))} instead.`);if(this.fromIndex){const r=this.fromIndex.evaluate(t);return n.indexOf(i,r)}return n.indexOf(i)}eachChild(t){t(this.needle),t(this.haystack),this.fromIndex&&t(this.fromIndex)}outputDefined(){return!1}serialize(){if(this.fromIndex!=null&&this.fromIndex!==void 0){const t=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),t]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}var vM=Fu;class Zf{constructor(t,i,n,r,o,s){this.inputType=t,this.type=i,this.input=n,this.cases=r,this.outputs=o,this.otherwise=s}static parse(t,i){if(t.length<5)return i.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if(t.length%2!=1)return i.error("Expected an even number of arguments.");let n,r;i.expectedType&&i.expectedType.kind!=="value"&&(r=i.expectedType);const o={},s=[];for(let c=2;c<t.length-1;c+=2){let u=t[c];const h=t[c+1];Array.isArray(u)||(u=[u]);const d=i.concat(c);if(u.length===0)return d.error("Expected at least one branch label.");for(const _ of u){if(typeof _!="number"&&typeof _!="string")return d.error("Branch labels must be numbers or strings.");if(typeof _=="number"&&Math.abs(_)>Number.MAX_SAFE_INTEGER)return d.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if(typeof _=="number"&&Math.floor(_)!==_)return d.error("Numeric branch labels must be integer values.");if(n){if(d.checkSubtype(n,qn(_)))return null}else n=qn(_);if(o[String(_)]!==void 0)return d.error("Branch labels must be unique.");o[String(_)]=s.length}const p=i.parse(h,c,r);if(!p)return null;r=r||p.type,s.push(p)}const a=i.parse(t[1],1,_i);if(!a)return null;const l=i.parse(t[t.length-1],t.length-1,r);return l?a.type.kind!=="value"&&i.concat(1).checkSubtype(n,a.type)?null:new Zf(n,r,a,o,s,l):null}evaluate(t){const i=this.input.evaluate(t);return(qn(i)===this.inputType&&this.outputs[this.cases[i]]||this.otherwise).evaluate(t)}eachChild(t){t(this.input),this.outputs.forEach(t),t(this.otherwise)}outputDefined(){return this.outputs.every(t=>t.outputDefined())&&this.otherwise.outputDefined()}serialize(){const t=["match",this.input.serialize()],i=Object.keys(this.cases).sort(),n=[],r={};for(const s of i){const a=r[this.cases[s]];a===void 0?(r[this.cases[s]]=n.length,n.push([this.cases[s],[s]])):n[a][1].push(s)}const o=s=>this.inputType.kind==="number"?Number(s):s;for(const[s,a]of n)t.push(a.length===1?o(a[0]):a.map(o)),t.push(this.outputs[s].serialize());return t.push(this.otherwise.serialize()),t}}var xM=Zf;class Hf{constructor(t,i,n){this.type=t,this.branches=i,this.otherwise=n}static parse(t,i){if(t.length<4)return i.error(`Expected at least 3 arguments, but found only ${t.length-1}.`);if(t.length%2!=0)return i.error("Expected an odd number of arguments.");let n;i.expectedType&&i.expectedType.kind!=="value"&&(n=i.expectedType);const r=[];for(let s=1;s<t.length-1;s+=2){const a=i.parse(t[s],s,xi);if(!a)return null;const l=i.parse(t[s+1],s+1,n);if(!l)return null;r.push([a,l]),n=n||l.type}const o=i.parse(t[t.length-1],t.length-1,n);return o?new Hf(n,r,o):null}evaluate(t){for(const[i,n]of this.branches)if(i.evaluate(t))return n.evaluate(t);return this.otherwise.evaluate(t)}eachChild(t){for(const[i,n]of this.branches)t(i),t(n);t(this.otherwise)}outputDefined(){return this.branches.every(([t,i])=>i.outputDefined())&&this.otherwise.outputDefined()}serialize(){const t=["case"];return this.eachChild(i=>{t.push(i.serialize())}),t}}var bM=Hf;class Nu{constructor(t,i,n,r){this.type=t,this.input=i,this.beginIndex=n,this.endIndex=r}static parse(t,i){if(t.length<=2||t.length>=5)return i.error(`Expected 3 or 4 arguments, but found ${t.length-1} instead.`);const n=i.parse(t[1],1,_i),r=i.parse(t[2],2,re);if(!n||!r)return null;if(!tl(n.type,[er(_i),ci,_i]))return i.error(`Expected first argument to be of type array or string, but found ${bn(n.type)} instead`);if(t.length===4){const o=i.parse(t[3],3,re);return o?new Nu(n.type,n,r,o):null}return new Nu(n.type,n,r)}evaluate(t){const i=this.input.evaluate(t),n=this.beginIndex.evaluate(t);if(!Jo(i,["string","array"]))throw new Kn(`Expected first argument to be of type array or string, but found ${bn(qn(i))} instead.`);if(this.endIndex){const r=this.endIndex.evaluate(t);return i.slice(n,r)}return i.slice(n)}eachChild(t){t(this.input),t(this.beginIndex),this.endIndex&&t(this.endIndex)}outputDefined(){return!1}serialize(){if(this.endIndex!=null&&this.endIndex!==void 0){const t=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),t]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}var wM=Nu;function Jg(e,t){return e==="=="||e==="!="?t.kind==="boolean"||t.kind==="string"||t.kind==="number"||t.kind==="null"||t.kind==="value":t.kind==="string"||t.kind==="number"||t.kind==="value"}function Qg(e,t,i,n){return n.compare(t,i)===0}function cl(e,t,i){const n=e!=="=="&&e!=="!=";return class $T{constructor(o,s,a){this.type=xi,this.lhs=o,this.rhs=s,this.collator=a,this.hasUntypedArgument=o.type.kind==="value"||s.type.kind==="value"}static parse(o,s){if(o.length!==3&&o.length!==4)return s.error("Expected two or three arguments.");const a=o[0];let l=s.parse(o[1],1,_i);if(!l)return null;if(!Jg(a,l.type))return s.concat(1).error(`"${a}" comparisons are not supported for type '${bn(l.type)}'.`);let c=s.parse(o[2],2,_i);if(!c)return null;if(!Jg(a,c.type))return s.concat(2).error(`"${a}" comparisons are not supported for type '${bn(c.type)}'.`);if(l.type.kind!==c.type.kind&&l.type.kind!=="value"&&c.type.kind!=="value")return s.error(`Cannot compare types '${bn(l.type)}' and '${bn(c.type)}'.`);n&&(l.type.kind==="value"&&c.type.kind!=="value"?l=new ts(c.type,[l]):l.type.kind!=="value"&&c.type.kind==="value"&&(c=new ts(l.type,[c])));let u=null;if(o.length===4){if(l.type.kind!=="string"&&c.type.kind!=="string"&&l.type.kind!=="value"&&c.type.kind!=="value")return s.error("Cannot use collator to compare non-string types.");if(u=s.parse(o[3],3,_a),!u)return null}return new $T(l,c,u)}evaluate(o){const s=this.lhs.evaluate(o),a=this.rhs.evaluate(o);if(n&&this.hasUntypedArgument){const l=qn(s),c=qn(a);if(l.kind!==c.kind||l.kind!=="string"&&l.kind!=="number")throw new Kn(`Expected arguments for "${e}" to be (string, string) or (number, number), but found (${l.kind}, ${c.kind}) instead.`)}if(this.collator&&!n&&this.hasUntypedArgument){const l=qn(s),c=qn(a);if(l.kind!=="string"||c.kind!=="string")return t(o,s,a)}return this.collator?i(o,s,a,this.collator.evaluate(o)):t(o,s,a)}eachChild(o){o(this.lhs),o(this.rhs),this.collator&&o(this.collator)}outputDefined(){return!0}serialize(){const o=[e];return this.eachChild(s=>{o.push(s.serialize())}),o}}}const TM=cl("==",function(e,t,i){return t===i},Qg),MM=cl("!=",function(e,t,i){return t!==i},function(e,t,i,n){return!Qg(0,t,i,n)}),EM=cl("<",function(e,t,i){return t<i},function(e,t,i,n){return n.compare(t,i)<0}),SM=cl(">",function(e,t,i){return t>i},function(e,t,i,n){return n.compare(t,i)>0}),AM=cl("<=",function(e,t,i){return t<=i},function(e,t,i,n){return n.compare(t,i)<=0}),IM=cl(">=",function(e,t,i){return t>=i},function(e,t,i,n){return n.compare(t,i)>=0});class Wf{constructor(t,i,n,r,o,s){this.type=ci,this.number=t,this.locale=i,this.currency=n,this.unit=r,this.minFractionDigits=o,this.maxFractionDigits=s}static parse(t,i){if(t.length!==3)return i.error("Expected two arguments.");const n=i.parse(t[1],1,re);if(!n)return null;const r=t[2];if(typeof r!="object"||Array.isArray(r))return i.error("NumberFormat options argument must be an object.");let o=null;if(r.locale&&(o=i.parse(r.locale,1,ci),!o))return null;let s=null;if(r.currency&&(s=i.parse(r.currency,1,ci),!s))return null;let a=null;if(r.unit&&(a=i.parse(r.unit,1,ci),!a))return null;let l=null;if(r["min-fraction-digits"]&&(l=i.parse(r["min-fraction-digits"],1,re),!l))return null;let c=null;return r["max-fraction-digits"]&&(c=i.parse(r["max-fraction-digits"],1,re),!c)?null:new Wf(n,o,s,a,l,c)}evaluate(t){return new Intl.NumberFormat(this.locale?this.locale.evaluate(t):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(t):void 0,unit:this.unit?this.unit.evaluate(t):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(t):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(t):void 0}).format(this.number.evaluate(t))}eachChild(t){t(this.number),this.locale&&t(this.locale),this.currency&&t(this.currency),this.unit&&t(this.unit),this.minFractionDigits&&t(this.minFractionDigits),this.maxFractionDigits&&t(this.maxFractionDigits)}outputDefined(){return!1}serialize(){const t={};return this.locale&&(t.locale=this.locale.serialize()),this.currency&&(t.currency=this.currency.serialize()),this.unit&&(t.unit=this.unit.serialize()),this.minFractionDigits&&(t["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(t["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),t]}}class $f{constructor(t){this.type=re,this.input=t}static parse(t,i){if(t.length!==2)return i.error(`Expected 1 argument, but found ${t.length-1} instead.`);const n=i.parse(t[1],1);return n?n.type.kind!=="array"&&n.type.kind!=="string"&&n.type.kind!=="value"?i.error(`Expected argument of type string or array, but found ${bn(n.type)} instead.`):new $f(n):null}evaluate(t){const i=this.input.evaluate(t);if(typeof i=="string"||Array.isArray(i))return i.length;throw new Kn(`Expected value to be of type string or array, but found ${bn(qn(i))} instead.`)}eachChild(t){t(this.input)}outputDefined(){return!1}serialize(){const t=["length"];return this.eachChild(i=>{t.push(i.serialize())}),t}}function Xf(e){return function(){e=1831565813+(e|=0)|0;let t=Math.imul(e^e>>>15,1|e);return t=t+Math.imul(t^t>>>7,61|t)^t,((t^t>>>14)>>>0)/4294967296}}const t0={"==":TM,"!=":MM,">":SM,"<":EM,">=":IM,"<=":AM,array:ts,at:gM,boolean:ts,case:bM,coalesce:Yg,collator:Cu,format:mc,image:_c,in:yM,"index-of":vM,interpolate:Ao,"interpolate-hcl":Ao,"interpolate-lab":Ao,length:$f,let:Kg,literal:pc,match:xM,number:ts,"number-format":Wf,object:ts,slice:wM,step:Rf,string:ts,"to-boolean":ya,"to-color":ya,"to-number":ya,"to-string":ya,var:Ug,within:vf,distance:Cf};function e0(e,[t,i,n,r]){t=t.evaluate(e),i=i.evaluate(e),n=n.evaluate(e);const o=r?r.evaluate(e):1,s=Tg(t,i,n,o);if(s)throw new Kn(s);return new Ye(t/255*o,i/255*o,n/255*o,o)}function i0(e,[t,i,n,r]){t=t.evaluate(e),i=i.evaluate(e),n=n.evaluate(e);const o=r?r.evaluate(e):1,s=function(c,u,h,d){return typeof c=="number"&&c>=0&&c<=360?typeof u=="number"&&u>=0&&u<=100&&typeof h=="number"&&h>=0&&h<=100?d===void 0||typeof d=="number"&&d>=0&&d<=1?null:`Invalid hsla value [${[c,u,h,d].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid hsla value [${(typeof d=="number"?[c,u,h,d]:[c,u,h]).join(", ")}]: 's', and 'l' must be between 0 and 100.`:`Invalid hsla value [${(typeof d=="number"?[c,u,h,d]:[c,u,h]).join(", ")}]: 'h' must be between 0 and 360.`}(t,i,n,o);if(s)throw new Kn(s);const a=`hsla(${t}, ${i}%, ${n}%, ${o})`,l=Ye.parse(a);if(!l)throw new Kn(`Failed to parse HSLA color: ${a}`);return l}function n0(e,t){return e in t}function Yf(e,t){const i=t[e];return i===void 0?null:i}function r0(e,t){switch(e){case"string":return String(t);case"number":return+t;case"boolean":return!!t;case"color":return Ye.parse(t)}return t}function o0(e,t,i,n){return n!==void 0&&(e=n*Math.round(e/n)),t!==void 0&&e<t&&(e=t),i!==void 0&&e>i&&(e=i),e}function s0(e,t,i){i.length&&(t+=`${i}`);const n=e.getConfig(t);if(!n)return null;const{type:r,value:o,values:s,minValue:a,maxValue:l,stepValue:c}=n,u=n.default.evaluate(e);let h=o?o.evaluate(e):u;return r&&(h=r0(r,h)),o!==void 0&&h!==void 0&&s&&!s.includes(h)&&(h=u,r&&(h=r0(r,h))),h===void 0||a===void 0&&l===void 0&&c===void 0||(typeof h=="number"?h=o0(h,a,l,c):Array.isArray(h)&&(h=h.map(d=>typeof d=="number"?o0(d,a,l,c):d))),h}function ba(e){return{type:e}}So.register(t0,{error:[{kind:"error"},[ci],(e,[t])=>{throw new Kn(t.evaluate(e))}],typeof:[ci,[_i],(e,[t])=>bn(qn(t.evaluate(e)))],"to-rgba":[er(re,4),[hr],(e,[t])=>t.evaluate(e).toArray()],rgb:[hr,[re,re,re],e0],rgba:[hr,[re,re,re,re],e0],hsl:[hr,[re,re,re],i0],hsla:[hr,[re,re,re,re],i0],has:{type:xi,overloads:[[[ci],(e,[t])=>n0(t.evaluate(e),e.properties())],[[ci,Lr],(e,[t,i])=>n0(t.evaluate(e),i.evaluate(e))]]},get:{type:_i,overloads:[[[ci],(e,[t])=>Yf(t.evaluate(e),e.properties())],[[ci,Lr],(e,[t,i])=>Yf(t.evaluate(e),i.evaluate(e))]]},config:{type:_i,overloads:[[[ci],(e,[t])=>s0(e,t.evaluate(e),"")],[[ci,ci],(e,[t,i])=>s0(e,t.evaluate(e),i.evaluate(e))]]},"feature-state":[_i,[ci],(e,[t])=>Yf(t.evaluate(e),e.featureState||{})],properties:[Lr,[],e=>e.properties()],"geometry-type":[ci,[],e=>e.geometryType()],id:[_i,[],e=>e.id()],zoom:[re,[],e=>e.globals.zoom],pitch:[re,[],e=>e.globals.pitch||0],"distance-from-center":[re,[],e=>e.distanceFromCenter()],"measure-light":[re,[ci],(e,[t])=>e.measureLight(t.evaluate(e))],"heatmap-density":[re,[],e=>e.globals.heatmapDensity||0],"line-progress":[re,[],e=>e.globals.lineProgress||0],"raster-value":[re,[],e=>e.globals.rasterValue||0],"sky-radial-progress":[re,[],e=>e.globals.skyRadialProgress||0],accumulated:[_i,[],e=>e.globals.accumulated===void 0?null:e.globals.accumulated],"+":[re,ba(re),(e,t)=>{let i=0;for(const n of t)i+=n.evaluate(e);return i}],"*":[re,ba(re),(e,t)=>{let i=1;for(const n of t)i*=n.evaluate(e);return i}],"-":{type:re,overloads:[[[re,re],(e,[t,i])=>t.evaluate(e)-i.evaluate(e)],[[re],(e,[t])=>-t.evaluate(e)]]},"/":[re,[re,re],(e,[t,i])=>t.evaluate(e)/i.evaluate(e)],"%":[re,[re,re],(e,[t,i])=>t.evaluate(e)%i.evaluate(e)],ln2:[re,[],()=>Math.LN2],pi:[re,[],()=>Math.PI],e:[re,[],()=>Math.E],"^":[re,[re,re],(e,[t,i])=>Math.pow(t.evaluate(e),i.evaluate(e))],sqrt:[re,[re],(e,[t])=>Math.sqrt(t.evaluate(e))],log10:[re,[re],(e,[t])=>Math.log(t.evaluate(e))/Math.LN10],ln:[re,[re],(e,[t])=>Math.log(t.evaluate(e))],log2:[re,[re],(e,[t])=>Math.log(t.evaluate(e))/Math.LN2],sin:[re,[re],(e,[t])=>Math.sin(t.evaluate(e))],cos:[re,[re],(e,[t])=>Math.cos(t.evaluate(e))],tan:[re,[re],(e,[t])=>Math.tan(t.evaluate(e))],asin:[re,[re],(e,[t])=>Math.asin(t.evaluate(e))],acos:[re,[re],(e,[t])=>Math.acos(t.evaluate(e))],atan:[re,[re],(e,[t])=>Math.atan(t.evaluate(e))],min:[re,ba(re),(e,t)=>Math.min(...t.map(i=>i.evaluate(e)))],max:[re,ba(re),(e,t)=>Math.max(...t.map(i=>i.evaluate(e)))],abs:[re,[re],(e,[t])=>Math.abs(t.evaluate(e))],round:[re,[re],(e,[t])=>{const i=t.evaluate(e);return i<0?-Math.round(-i):Math.round(i)}],floor:[re,[re],(e,[t])=>Math.floor(t.evaluate(e))],ceil:[re,[re],(e,[t])=>Math.ceil(t.evaluate(e))],"filter-==":[xi,[ci,_i],(e,[t,i])=>e.properties()[t.value]===i.value],"filter-id-==":[xi,[_i],(e,[t])=>e.id()===t.value],"filter-type-==":[xi,[ci],(e,[t])=>e.geometryType()===t.value],"filter-<":[xi,[ci,_i],(e,[t,i])=>{const n=e.properties()[t.value],r=i.value;return typeof n==typeof r&&n<r}],"filter-id-<":[xi,[_i],(e,[t])=>{const i=e.id(),n=t.value;return typeof i==typeof n&&i<n}],"filter->":[xi,[ci,_i],(e,[t,i])=>{const n=e.properties()[t.value],r=i.value;return typeof n==typeof r&&n>r}],"filter-id->":[xi,[_i],(e,[t])=>{const i=e.id(),n=t.value;return typeof i==typeof n&&i>n}],"filter-<=":[xi,[ci,_i],(e,[t,i])=>{const n=e.properties()[t.value],r=i.value;return typeof n==typeof r&&n<=r}],"filter-id-<=":[xi,[_i],(e,[t])=>{const i=e.id(),n=t.value;return typeof i==typeof n&&i<=n}],"filter->=":[xi,[ci,_i],(e,[t,i])=>{const n=e.properties()[t.value],r=i.value;return typeof n==typeof r&&n>=r}],"filter-id->=":[xi,[_i],(e,[t])=>{const i=e.id(),n=t.value;return typeof i==typeof n&&i>=n}],"filter-has":[xi,[_i],(e,[t])=>t.value in e.properties()],"filter-has-id":[xi,[],e=>e.id()!==null&&e.id()!==void 0],"filter-type-in":[xi,[er(ci)],(e,[t])=>t.value.indexOf(e.geometryType())>=0],"filter-id-in":[xi,[er(_i)],(e,[t])=>t.value.indexOf(e.id())>=0],"filter-in-small":[xi,[ci,er(_i)],(e,[t,i])=>i.value.indexOf(e.properties()[t.value])>=0],"filter-in-large":[xi,[ci,er(_i)],(e,[t,i])=>function(n,r,o,s){for(;o<=s;){const a=o+s>>1;if(r[a]===n)return!0;r[a]>n?s=a-1:o=a+1}return!1}(e.properties()[t.value],i.value,0,i.value.length-1)],all:{type:xi,overloads:[[[xi,xi],(e,[t,i])=>t.evaluate(e)&&i.evaluate(e)],[ba(xi),(e,t)=>{for(const i of t)if(!i.evaluate(e))return!1;return!0}]]},any:{type:xi,overloads:[[[xi,xi],(e,[t,i])=>t.evaluate(e)||i.evaluate(e)],[ba(xi),(e,t)=>{for(const i of t)if(i.evaluate(e))return!0;return!1}]]},"!":[xi,[xi],(e,[t])=>!t.evaluate(e)],"is-supported-script":[xi,[ci],(e,[t])=>{const i=e.globals&&e.globals.isSupportedScript;return!i||i(t.evaluate(e))}],upcase:[ci,[ci],(e,[t])=>t.evaluate(e).toUpperCase()],downcase:[ci,[ci],(e,[t])=>t.evaluate(e).toLowerCase()],concat:[ci,ba(_i),(e,t)=>t.map(i=>fc(i.evaluate(e))).join("")],"resolved-locale":[ci,[_a],(e,[t])=>t.evaluate(e).resolvedLocale()],random:[re,[re,re,_i],(e,t)=>{const[i,n,r]=t.map(s=>s.evaluate(e));if(i>n||i===n)return i;let o;if(typeof r=="string")o=function(s){let a=0;if(s.length===0)return a;for(let l=0;l<s.length;l++)a=(a<<5)-a+s.charCodeAt(l),a&=a;return a}(r);else{if(typeof r!="number")throw new Kn(`Invalid seed input: ${r}`);o=r}return i+Xf(o)()*(n-i)}]});var Mc=t0;function a0(e){return{result:"success",value:e}}function wa(e){return{result:"error",value:e}}function l0(e,t){return!!e&&!!e.parameters&&e.parameters.indexOf(t)>-1}function Ta(e){return e["property-type"]==="data-driven"}function c0(e){return l0(e.expression,"measure-light")}function Kf(e){return l0(e.expression,"zoom")}function Jf(e){return!!e.expression&&e.expression.interpolated}function Uu(e){return typeof e=="object"&&e!==null&&!Array.isArray(e)}function CM(e){return e}function u0(e,t){const i=t.type==="color",n=e.stops&&typeof e.stops[0][0]=="object",r=n||!(n||e.property!==void 0),o=e.type||(Jf(t)?"exponential":"interval");if(i&&((e=zr({},e)).stops&&(e.stops=e.stops.map(c=>[c[0],Ye.parse(c[1])])),e.default=Ye.parse(e.default?e.default:t.default)),e.colorSpace&&e.colorSpace!=="rgb"&&!Xg[e.colorSpace])throw new Error(`Unknown color space: ${e.colorSpace}`);let s,a,l;if(o==="exponential")s=h0;else if(o==="interval")s=PM;else if(o==="categorical"){s=DM,a=Object.create(null);for(const c of e.stops)a[c[0]]=c[1];l=typeof e.stops[0][0]}else{if(o!=="identity")throw new Error(`Unknown function type "${o}"`);s=kM}if(n){const c={},u=[];for(let p=0;p<e.stops.length;p++){const _=e.stops[p],g=_[0].zoom;c[g]===void 0&&(c[g]={zoom:g,type:e.type,property:e.property,default:e.default,stops:[]},u.push(g)),c[g].stops.push([_[0].value,_[1]])}const h=[];for(const p of u)h.push([c[p].zoom,u0(c[p],t)]);const d={name:"linear"};return{kind:"composite",interpolationType:d,interpolationFactor:Ao.interpolationFactor.bind(void 0,d),zoomStops:h.map(p=>p[0]),evaluate:({zoom:p},_)=>h0({stops:h,base:e.base},t,p).evaluate(p,_)}}if(r){const c=o==="exponential"?{name:"exponential",base:e.base!==void 0?e.base:1}:null;return{kind:"camera",interpolationType:c,interpolationFactor:Ao.interpolationFactor.bind(void 0,c),zoomStops:e.stops.map(u=>u[0]),evaluate:({zoom:u})=>s(e,t,u,a,l)}}return{kind:"source",evaluate(c,u){const h=u&&u.properties?u.properties[e.property]:void 0;return h===void 0?Ec(e.default,t.default):s(e,t,h,a,l)}}}function Ec(e,t,i){return e!==void 0?e:t!==void 0?t:i!==void 0?i:void 0}function DM(e,t,i,n,r){return Ec(typeof i===r?n[i]:void 0,e.default,t.default)}function PM(e,t,i){if(Bi(i)!=="number")return Ec(e.default,t.default);const n=e.stops.length;if(n===1||i<=e.stops[0][0])return e.stops[0][1];if(i>=e.stops[n-1][0])return e.stops[n-1][1];const r=Ru(e.stops.map(o=>o[0]),i);return e.stops[r][1]}function h0(e,t,i){const n=e.base!==void 0?e.base:1;if(Bi(i)!=="number")return Ec(e.default,t.default);const r=e.stops.length;if(r===1||i<=e.stops[0][0])return e.stops[0][1];if(i>=e.stops[r-1][0])return e.stops[r-1][1];const o=Ru(e.stops.map(u=>u[0]),i),s=function(u,h,d,p){const _=p-d,g=u-d;return _===0?0:h===1?g/_:(Math.pow(h,g)-1)/(Math.pow(h,_)-1)}(i,n,e.stops[o][0],e.stops[o+1][0]),a=e.stops[o][1],l=e.stops[o+1][1];let c=Ou[t.type]||CM;if(e.colorSpace&&e.colorSpace!=="rgb"){const u=Xg[e.colorSpace];c=(h,d)=>u.reverse(u.interpolate(u.forward(h),u.forward(d),s))}return typeof a.evaluate=="function"?{evaluate(...u){const h=a.evaluate.apply(void 0,u),d=l.evaluate.apply(void 0,u);if(h!==void 0&&d!==void 0)return c(h,d,s)}}:c(a,l,s)}function kM(e,t,i){return t.type==="color"?i=Ye.parse(i):t.type==="formatted"?i=br.fromString(i.toString()):t.type==="resolvedImage"?i=Hr.fromString(i.toString()):Bi(i)===t.type||t.type==="enum"&&t.values[i]||(i=void 0),Ec(i,e.default,t.default)}class Qf{constructor(t,i,n){this.expression=t,this._warningHistory={},this._evaluator=new Mg(n),this._defaultValue=i?function(r){return r.type==="color"&&(Uu(r.default)||Array.isArray(r.default))?new Ye(0,0,0,0):r.type==="color"?Ye.parse(r.default)||null:r.default===void 0?null:r.default}(i):null,this._enumValues=i&&i.type==="enum"?i.values:null}evaluateWithoutErrorHandling(t,i,n,r,o,s,a,l){return this._evaluator.globals=t,this._evaluator.feature=i,this._evaluator.featureState=n,this._evaluator.canonical=r||null,this._evaluator.availableImages=o||null,this._evaluator.formattedSection=s,this._evaluator.featureTileCoord=a||null,this._evaluator.featureDistanceData=l||null,this.expression.evaluate(this._evaluator)}evaluate(t,i,n,r,o,s,a,l){this._evaluator.globals=t,this._evaluator.feature=i||null,this._evaluator.featureState=n||null,this._evaluator.canonical=r||null,this._evaluator.availableImages=o||null,this._evaluator.formattedSection=s||null,this._evaluator.featureTileCoord=a||null,this._evaluator.featureDistanceData=l||null;try{const c=this.expression.evaluate(this._evaluator);if(c==null||typeof c=="number"&&c!=c)return this._defaultValue;if(this._enumValues&&!(c in this._enumValues))throw new Kn(`Expected value to be one of ${Object.keys(this._enumValues).map(u=>JSON.stringify(u)).join(", ")}, but found ${JSON.stringify(c)} instead.`);return c}catch(c){return this._warningHistory[c.message]||(this._warningHistory[c.message]=!0,typeof console<"u"&&console.warn(c.message)),this._defaultValue}}}function Vu(e){return Array.isArray(e)&&e.length>0&&typeof e[0]=="string"&&e[0]in Mc}function Ps(e,t,i){const n=new Vg(Mc,[],t?function(o){const s={color:hr,string:ci,number:re,enum:ci,boolean:xi,formatted:Yo,resolvedImage:Is};return o.type==="array"?er(s[o.value]||_i,o.length):s[o.type]}(t):void 0,void 0,void 0,i),r=n.parse(e,void 0,void 0,void 0,t&&t.type==="string"?{typeAnnotation:"coerce"}:void 0);return r?a0(new Qf(r,t,i)):wa(n.errors)}class tp{constructor(t,i,n){this.kind=t,this._styleExpression=i,this.isLightConstant=n,this.isStateDependent=t!=="constant"&&!bc(i.expression),this.isConfigDependent=!Df(i.expression)}evaluateWithoutErrorHandling(t,i,n,r,o,s){return this._styleExpression.evaluateWithoutErrorHandling(t,i,n,r,o,s)}evaluate(t,i,n,r,o,s){return this._styleExpression.evaluate(t,i,n,r,o,s)}}class ks{constructor(t,i,n,r,o){this.kind=t,this.zoomStops=n,this._styleExpression=i,this.isStateDependent=t!=="camera"&&!bc(i.expression),this.isLightConstant=o,this.isConfigDependent=!Df(i.expression),this.interpolationType=r}evaluateWithoutErrorHandling(t,i,n,r,o,s){return this._styleExpression.evaluateWithoutErrorHandling(t,i,n,r,o,s)}evaluate(t,i,n,r,o,s){return this._styleExpression.evaluate(t,i,n,r,o,s)}interpolationFactor(t,i,n){return this.interpolationType?Ao.interpolationFactor(this.interpolationType,t,i,n):0}}function ep(e,t,i){if((e=Ps(e,t,i)).result==="error")return e;const n=e.value.expression,r=sl(n);if(!r&&!Ta(t))return wa([new lr("","data expressions not supported")]);const o=al(n,["zoom","pitch","distance-from-center"]);if(!o&&!Kf(t))return wa([new lr("","zoom expressions not supported")]);const s=al(n,["measure-light"]);if(!s&&!c0(t))return wa([new lr("","measure-light expression not supported")]);const a=t.expression&&t.expression.relaxZoomRestriction,l=Gu(n);return l||o||a?l instanceof lr?wa([l]):l instanceof Ao&&!Jf(t)?wa([new lr("",'"interpolate" expressions cannot be used with this property')]):a0(l?new ks(r?"camera":"composite",e.value,l.labels,l instanceof Ao?l.interpolation:void 0,s):new tp(r?"constant":"source",e.value,s)):wa([new lr("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression, or in the properties of atmosphere.')])}class ju{constructor(t,i){this._parameters=t,this._specification=i,zr(this,u0(this._parameters,this._specification))}static deserialize(t){return new ju(t._parameters,t._specification)}static serialize(t){return{_parameters:t._parameters,_specification:t._specification}}}function Gu(e){let t=null;if(e instanceof Kg)t=Gu(e.result);else if(e instanceof Yg){for(const i of e.args)if(t=Gu(i),t)break}else(e instanceof Rf||e instanceof Ao)&&e.input instanceof So&&e.input.name==="zoom"&&(t=e);return t instanceof lr||e.eachChild(i=>{const n=Gu(i);n instanceof lr?t=n:t&&n&&t!==n&&(t=new lr("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),t}function Wr(e){const t=e.key,i=e.value,n=e.valueSpec||{},r=e.objectElementValidators||{},o=e.style,s=e.styleSpec;let a=[];const l=Bi(i);if(l!=="object")return[new le(t,i,`object expected, ${l} found`)];for(const c in i){const u=c.split(".")[0];let h;r[u]?h=r[u]:n[u]?h=ir:r["*"]?h=r["*"]:n["*"]&&(h=ir),h?a=a.concat(h({key:(t&&`${t}.`)+c,value:i[c],valueSpec:n[u]||n["*"],style:o,styleSpec:s,object:i,objectKey:c},i)):a.push(new Mo(t,i[c],`unknown property "${c}"`))}for(const c in n)r[c]||n[c].required&&n[c].default===void 0&&i[c]===void 0&&a.push(new le(t,i,`missing required property "${c}"`));return a}function d0(e){const t=e.value,i=e.valueSpec,n=e.style,r=e.styleSpec,o=e.key,s=e.arrayElementValidator||ir;if(Bi(t)!=="array")return[new le(o,t,`array expected, ${Bi(t)} found`)];if(i.length&&t.length!==i.length)return[new le(o,t,`array length ${i.length} expected, length ${t.length} found`)];if(i["min-length"]&&t.length<i["min-length"])return[new le(o,t,`array length at least ${i["min-length"]} expected, length ${t.length} found`)];let a={type:i.value,values:i.values,minimum:i.minimum,maximum:i.maximum,function:void 0};r.$version<7&&(a.function=i.function),Bi(i.value)==="object"&&(a=i.value);let l=[];for(let c=0;c<t.length;c++)l=l.concat(s({array:t,arrayIndex:c,value:t[c],valueSpec:a,style:n,styleSpec:r,key:`${o}[${c}]`},!0));return l}function f0(e){const t=e.key,i=e.value,n=e.valueSpec;let r=Bi(i);if(r==="number"&&i!=i&&(r="NaN"),r!=="number")return[new le(t,i,`number expected, ${r} found`)];if("minimum"in n){let o=n.minimum;if(Bi(n.minimum)==="array"&&(o=n.minimum[e.arrayIndex]),i<o)return[new le(t,i,`${i} is less than the minimum value ${o}`)]}if("maximum"in n){let o=n.maximum;if(Bi(n.maximum)==="array"&&(o=n.maximum[e.arrayIndex]),i>o)return[new le(t,i,`${i} is greater than the maximum value ${o}`)]}return[]}function p0(e){const t=e.valueSpec,i=Cn(e.value.type);let n,r,o,s={};const a=i!=="categorical"&&e.value.property===void 0,l=!a,c=Bi(e.value.stops)==="array"&&Bi(e.value.stops[0])==="array"&&Bi(e.value.stops[0][0])==="object",u=Wr({key:e.key,value:e.value,valueSpec:e.styleSpec.function,style:e.style,styleSpec:e.styleSpec,objectElementValidators:{stops:function(p){if(i==="identity")return[new le(p.key,p.value,'identity function may not have a "stops" property')];let _=[];const g=p.value;return _=_.concat(d0({key:p.key,value:g,valueSpec:p.valueSpec,style:p.style,styleSpec:p.styleSpec,arrayElementValidator:h})),Bi(g)==="array"&&g.length===0&&_.push(new le(p.key,g,"array must have at least one stop")),_},default:function(p){return ir({key:p.key,value:p.value,valueSpec:t,style:p.style,styleSpec:p.styleSpec})}}});return i==="identity"&&a&&u.push(new le(e.key,e.value,'missing required property "property"')),i==="identity"||e.value.stops||u.push(new le(e.key,e.value,'missing required property "stops"')),i==="exponential"&&e.valueSpec.expression&&!Jf(e.valueSpec)&&u.push(new le(e.key,e.value,"exponential functions not supported")),e.styleSpec.$version>=8&&(l&&!Ta(e.valueSpec)?u.push(new le(e.key,e.value,"property functions not supported")):a&&!Kf(e.valueSpec)&&u.push(new le(e.key,e.value,"zoom functions not supported"))),i!=="categorical"&&!c||e.value.property!==void 0||u.push(new le(e.key,e.value,'"property" property is required')),u;function h(p){let _=[];const g=p.value,y=p.key;if(Bi(g)!=="array")return[new le(y,g,`array expected, ${Bi(g)} found`)];if(g.length!==2)return[new le(y,g,`array length 2 expected, length ${g.length} found`)];if(c){if(Bi(g[0])!=="object")return[new le(y,g,`object expected, ${Bi(g[0])} found`)];if(g[0].zoom===void 0)return[new le(y,g,"object stop key must have zoom")];if(g[0].value===void 0)return[new le(y,g,"object stop key must have value")];const x=Cn(g[0].zoom);if(typeof x!="number")return[new le(y,g[0].zoom,"stop zoom values must be numbers")];if(o&&o>x)return[new le(y,g[0].zoom,"stop zoom values must appear in ascending order")];x!==o&&(o=x,r=void 0,s={}),_=_.concat(Wr({key:`${y}[0]`,value:g[0],valueSpec:{zoom:{}},style:p.style,styleSpec:p.styleSpec,objectElementValidators:{zoom:f0,value:d}}))}else _=_.concat(d({key:`${y}[0]`,value:g[0],valueSpec:{},style:p.style,styleSpec:p.styleSpec},g));return Vu(vr(g[1]))?_.concat([new le(`${y}[1]`,g[1],"expressions are not allowed in function stops.")]):_.concat(ir({key:`${y}[1]`,value:g[1],valueSpec:t,style:p.style,styleSpec:p.styleSpec}))}function d(p,_){const g=Bi(p.value),y=Cn(p.value),x=p.value!==null?p.value:_;if(n){if(g!==n)return[new le(p.key,x,`${g} stop domain type must match previous stop domain type ${n}`)]}else n=g;if(g!=="number"&&g!=="string"&&g!=="boolean"&&typeof y!="number"&&typeof y!="string"&&typeof y!="boolean")return[new le(p.key,x,"stop domain value must be a number, string, or boolean")];if(g!=="number"&&i!=="categorical"){let b=`number expected, ${g} found`;return Ta(t)&&i===void 0&&(b+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new le(p.key,x,b)]}return i!=="categorical"||g!=="number"||typeof y=="number"&&isFinite(y)&&Math.floor(y)===y?i!=="categorical"&&g==="number"&&typeof y=="number"&&typeof r=="number"&&r!==void 0&&y<r?[new le(p.key,x,"stop domain values must appear in ascending order")]:(r=y,i==="categorical"&&y in s?[new le(p.key,x,"stop domain values must be unique")]:(s[y]=!0,[])):[new le(p.key,x,`integer expected, found ${String(y)}`)]}}function Ma(e){const t=(e.expressionContext==="property"?ep:Ps)(vr(e.value),e.valueSpec);if(t.result==="error")return t.value.map(n=>new le(`${e.key}${n.key}`,e.value,n.message));const i=t.value.expression||t.value._styleExpression.expression;if(e.expressionContext==="property"&&e.propertyKey==="text-font"&&!i.outputDefined())return[new le(e.key,e.value,`Invalid data expression for "${e.propertyKey}". Output values must be contained as literals within the expression.`)];if(e.expressionContext==="property"&&e.propertyType==="layout"&&!bc(i))return[new le(e.key,e.value,'"feature-state" data expressions are not supported with layout properties.')];if(e.expressionContext==="filter")return m0(i,e);if(e.expressionContext&&e.expressionContext.indexOf("cluster")===0){if(!al(i,["zoom","feature-state"]))return[new le(e.key,e.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if(e.expressionContext==="cluster-initial"&&!sl(i))return[new le(e.key,e.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function m0(e,t){const i=new Set(["zoom","feature-state","pitch","distance-from-center"]);if(t.valueSpec&&t.valueSpec.expression)for(const r of t.valueSpec.expression.parameters)i.delete(r);if(i.size===0)return[];const n=[];return e instanceof So&&i.has(e.name)?[new le(t.key,t.value,`["${e.name}"] expression is not supported in a filter for a ${t.object.type} layer with id: ${t.object.id}`)]:(e.eachChild(r=>{n.push(...m0(r,t))}),n)}function qu(e){const t=e.key,i=e.value,n=e.valueSpec,r=[];return Array.isArray(n.values)?n.values.indexOf(Cn(i))===-1&&r.push(new le(t,i,`expected one of [${n.values.join(", ")}], ${JSON.stringify(i)} found`)):Object.keys(n.values).indexOf(Cn(i))===-1&&r.push(new le(t,i,`expected one of [${Object.keys(n.values).join(", ")}], ${JSON.stringify(i)} found`)),r}function ip(e){if(e===!0||e===!1)return!0;if(!Array.isArray(e)||e.length===0)return!1;switch(e[0]){case"has":return e.length>=2&&e[1]!=="$id"&&e[1]!=="$type";case"in":return e.length>=3&&(typeof e[1]!="string"||Array.isArray(e[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return e.length!==3||Array.isArray(e[1])||Array.isArray(e[2]);case"any":case"all":for(const t of e.slice(1))if(!ip(t)&&typeof t!="boolean")return!1;return!0;default:return!0}}function Zu(e,t="fill"){if(e==null)return{filter:()=>!0,needGeometry:!1,needFeature:!1};ip(e)||(e=Hu(e));const i=e;let n=!0;try{n=function(c){if(!ul(c))return c;let u=vr(c);return g0(u),u=_0(u),u}(i)}catch{console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.
This is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md
and paste the contents of this message in the report.
Thank you!
Filter Expression:
${JSON.stringify(i,null,2)}
        `)}const r=rt[`filter_${t}`],o=Ps(n,r);let s=null;if(o.result==="error")throw new Error(o.value.map(c=>`${c.key}: ${c.message}`).join(", "));s=(c,u,h)=>o.value.evaluate(c,u,{},h);let a=null,l=null;if(n!==i){const c=Ps(i,r);if(c.result==="error")throw new Error(c.value.map(u=>`${u.key}: ${u.message}`).join(", "));a=(u,h,d,p,_)=>c.value.evaluate(u,h,{},d,void 0,void 0,p,_),l=!sl(c.value.expression)}return{filter:s,dynamicFilter:a||void 0,needGeometry:y0(n),needFeature:!!l}}function _0(e){if(!Array.isArray(e))return e;const t=function(i){if(zM.has(i[0])){for(let n=1;n<i.length;n++)if(ul(i[n]))return!0}return i}(e);return t===!0?t:t.map(i=>_0(i))}function g0(e){let t=!1;const i=[];if(e[0]==="case"){for(let n=1;n<e.length-1;n+=2)t=t||ul(e[n]),i.push(e[n+1]);i.push(e[e.length-1])}else if(e[0]==="match"){t=t||ul(e[1]);for(let n=2;n<e.length-1;n+=2)i.push(e[n+1]);i.push(e[e.length-1])}else if(e[0]==="step"){t=t||ul(e[1]);for(let n=1;n<e.length-1;n+=2)i.push(e[n+1])}t&&(e.length=0,e.push("any",...i));for(let n=1;n<e.length;n++)g0(e[n])}function ul(e){if(!Array.isArray(e))return!1;if((t=e[0])==="pitch"||t==="distance-from-center")return!0;var t;for(let i=1;i<e.length;i++)if(ul(e[i]))return!0;return!1}const zM=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function LM(e,t){return e<t?-1:e>t?1:0}function y0(e){if(!Array.isArray(e))return!1;if(e[0]==="within"||e[0]==="distance")return!0;for(let t=1;t<e.length;t++)if(y0(e[t]))return!0;return!1}function Hu(e){if(!e)return!0;const t=e[0];return e.length<=1?t!=="any":t==="=="?np(e[1],e[2],"=="):t==="!="?Wu(np(e[1],e[2],"==")):t==="<"||t===">"||t==="<="||t===">="?np(e[1],e[2],t):t==="any"?(i=e.slice(1),["any"].concat(i.map(Hu))):t==="all"?["all"].concat(e.slice(1).map(Hu)):t==="none"?["all"].concat(e.slice(1).map(Hu).map(Wu)):t==="in"?v0(e[1],e.slice(2)):t==="!in"?Wu(v0(e[1],e.slice(2))):t==="has"?x0(e[1]):t!=="!has"||Wu(x0(e[1]));var i}function np(e,t,i){switch(e){case"$type":return[`filter-type-${i}`,t];case"$id":return[`filter-id-${i}`,t];default:return[`filter-${i}`,e,t]}}function v0(e,t){if(t.length===0)return!1;switch(e){case"$type":return["filter-type-in",["literal",t]];case"$id":return["filter-id-in",["literal",t]];default:return t.length>200&&!t.some(i=>typeof i!=typeof t[0])?["filter-in-large",e,["literal",t.sort(LM)]]:["filter-in-small",e,["literal",t]]}}function x0(e){switch(e){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",e]}}function Wu(e){return["!",e]}function rp(e){return ip(vr(e.value))?Ma(zr({},e,{expressionContext:"filter",valueSpec:e.styleSpec[`filter_${e.layerType||"fill"}`]})):b0(e)}function b0(e){const t=e.value,i=e.key;if(Bi(t)!=="array")return[new le(i,t,`array expected, ${Bi(t)} found`)];const n=e.styleSpec;let r,o=[];if(t.length<1)return[new le(i,t,"filter array must have at least 1 element")];switch(o=o.concat(qu({key:`${i}[0]`,value:t[0],valueSpec:n.filter_operator,style:e.style,styleSpec:e.styleSpec})),Cn(t[0])){case"<":case"<=":case">":case">=":t.length>=2&&Cn(t[1])==="$type"&&o.push(new le(i,t,`"$type" cannot be use with operator "${t[0]}"`));case"==":case"!=":t.length!==3&&o.push(new le(i,t,`filter array for operator "${t[0]}" must have 3 elements`));case"in":case"!in":t.length>=2&&(r=Bi(t[1]),r!=="string"&&o.push(new le(`${i}[1]`,t[1],`string expected, ${r} found`)));for(let s=2;s<t.length;s++)r=Bi(t[s]),Cn(t[1])==="$type"?o=o.concat(qu({key:`${i}[${s}]`,value:t[s],valueSpec:n.geometry_type,style:e.style,styleSpec:e.styleSpec})):r!=="string"&&r!=="number"&&r!=="boolean"&&o.push(new le(`${i}[${s}]`,t[s],`string, number, or boolean expected, ${r} found`));break;case"any":case"all":case"none":for(let s=1;s<t.length;s++)o=o.concat(b0({key:`${i}[${s}]`,value:t[s],style:e.style,styleSpec:e.styleSpec}));break;case"has":case"!has":r=Bi(t[1]),t.length!==2?o.push(new le(i,t,`filter array for "${t[0]}" operator must have 2 elements`)):r!=="string"&&o.push(new le(`${i}[1]`,t[1],`string expected, ${r} found`))}return o}function w0(e,t){const i=e.key,n=e.style,r=e.layer,o=e.styleSpec,s=e.value,a=e.objectKey,l=o[`${t}_${e.layerType}`];if(!l)return[];const c=a.match(/^(.*)-transition$/);if(t==="paint"&&c&&l[c[1]]&&l[c[1]].transition)return ir({key:i,value:s,valueSpec:o.transition,style:n,styleSpec:o});const u=e.valueSpec||l[a];if(!u)return[new Mo(i,s,`unknown property "${a}"`)];let h;if(Bi(s)==="string"&&Ta(u)&&!u.tokens&&(h=/^{([^}]+)}$/.exec(s))){const p=`\`{ "type": "identity", "property": ${h?JSON.stringify(h[1]):'"_"'} }\``;return[new le(i,s,`"${a}" does not support interpolation syntax
Use an identity property function instead: ${p}.`)]}const d=[];if(e.layerType==="symbol")a!=="text-field"||!n||n.glyphs||n.imports||d.push(new le(i,s,'use of "text-field" requires a style "glyphs" property')),a==="text-font"&&Uu(vr(s))&&Cn(s.type)==="identity"&&d.push(new le(i,s,'"text-font" does not support identity functions'));else if(e.layerType==="model"&&t==="paint"&&r&&r.layout&&r.layout.hasOwnProperty("model-id")&&Ta(u)&&(c0(u)||Kf(u))){const p=ep(vr(s),u),_=p.value.expression||p.value._styleExpression.expression;_&&!al(_,["measure-light"])&&(a==="model-emissive-strength"&&sl(_)&&bc(_)||d.push(new le(i,s,`${a} does not support measure-light expressions when the model layer source is vector tile or GeoJSON.`)))}return d.concat(ir({key:e.key,value:s,valueSpec:u,style:n,styleSpec:o,expressionContext:"property",propertyType:t,propertyKey:a}))}function T0(e){return w0(e,"paint")}function M0(e){return w0(e,"layout")}function E0(e){let t=[];const i=e.value,n=e.key,r=e.style,o=e.styleSpec;i.type||i.ref||t.push(new le(n,i,'either "type" or "ref" is required'));let s=Cn(i.type);const a=Cn(i.ref);if(i.id){const l=Cn(i.id);for(let c=0;c<e.arrayIndex;c++){const u=r.layers[c];Cn(u.id)===l&&t.push(new le(n,i.id,`duplicate layer id "${i.id}", previously used at line ${u.id.__line__}`))}}if("ref"in i){let l;["type","source","source-layer","filter","layout"].forEach(c=>{c in i&&t.push(new le(n,i[c],`"${c}" is prohibited for ref layers`))}),r.layers.forEach(c=>{Cn(c.id)===a&&(l=c)}),l?l.ref?t.push(new le(n,i.ref,"ref cannot reference another ref layer")):s=Cn(l.type):typeof a=="string"&&t.push(new le(n,i.ref,`ref layer "${a}" not found`))}else if(s!=="background"&&s!=="sky"&&s!=="slot")if(i.source){const l=r.sources&&r.sources[i.source],c=l&&Cn(l.type);l?c==="vector"&&s==="raster"?t.push(new le(n,i.source,`layer "${i.id}" requires a raster source`)):c==="raster"&&s!=="raster"?t.push(new le(n,i.source,`layer "${i.id}" requires a vector source`)):c!=="vector"||i["source-layer"]?c==="raster-dem"&&s!=="hillshade"?t.push(new le(n,i.source,"raster-dem source can only be used with layer type 'hillshade'.")):s!=="line"||!i.paint||!i.paint["line-gradient"]&&!i.paint["line-trim-offset"]||c==="geojson"&&l.lineMetrics||t.push(new le(n,i,`layer "${i.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):t.push(new le(n,i,`layer "${i.id}" must specify a "source-layer"`)):t.push(new le(n,i.source,`source "${i.source}" not found`))}else t.push(new le(n,i,'missing required property "source"'));return t=t.concat(Wr({key:n,value:i,valueSpec:o.layer,style:e.style,styleSpec:e.styleSpec,objectElementValidators:{"*":()=>[],type:()=>ir({key:`${n}.type`,value:i.type,valueSpec:o.layer.type,style:e.style,styleSpec:e.styleSpec,object:i,objectKey:"type"}),filter:l=>rp(zr({layerType:s},l)),layout:l=>Wr({layer:i,key:l.key,value:l.value,valueSpec:{},style:l.style,styleSpec:l.styleSpec,objectElementValidators:{"*":c=>M0(zr({layerType:s},c))}}),paint:l=>Wr({layer:i,key:l.key,value:l.value,valueSpec:{},style:l.style,styleSpec:l.styleSpec,objectElementValidators:{"*":c=>T0(zr({layerType:s,layer:i},c))}})}})),t}function hl(e){const t=e.value,i=e.key,n=Bi(t);return n!=="string"?[new le(i,t,`string expected, ${n} found`)]:[]}const S0={promoteId:function({key:e,value:t}){if(Bi(t)==="string")return hl({key:e,value:t});{const i=[];for(const n in t)i.push(...hl({key:`${e}.${n}`,value:t[n]}));return i}}};function A0(e){const t=e.value,i=e.key,n=e.styleSpec,r=e.style;if(!t.type)return[new le(i,t,'"type" is required')];const o=Cn(t.type);let s=[];switch(["vector","raster","raster-dem"].includes(o)&&(t.url||t.tiles||s.push(new le(i,t,'Either "url" or "tiles" is required.'))),o){case"vector":case"raster":case"raster-dem":return s=s.concat(Wr({key:i,value:t,valueSpec:n[`source_${o.replace("-","_")}`],style:e.style,styleSpec:n,objectElementValidators:S0})),s;case"geojson":if(s=Wr({key:i,value:t,valueSpec:n.source_geojson,style:r,styleSpec:n,objectElementValidators:S0}),t.cluster)for(const a in t.clusterProperties){const[l,c]=t.clusterProperties[a],u=typeof l=="string"?[l,["accumulated"],["get",a]]:l;s.push(...Ma({key:`${i}.${a}.map`,value:c,expressionContext:"cluster-map"})),s.push(...Ma({key:`${i}.${a}.reduce`,value:u,expressionContext:"cluster-reduce"}))}return s;case"video":return Wr({key:i,value:t,valueSpec:n.source_video,style:r,styleSpec:n});case"image":return Wr({key:i,value:t,valueSpec:n.source_image,style:r,styleSpec:n});case"canvas":return[new le(i,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return qu({key:`${i}.type`,value:t.type,valueSpec:{values:RM(n)},style:r,styleSpec:n})}}function RM(e){return e.source.reduce((t,i)=>{const n=e[i];return n.type.type==="enum"&&(t=t.concat(Object.keys(n.type.values))),t},[])}function I0(e){const t=e.value;let i=[];if(!t)return i;const n=Bi(t);return n!=="string"?(i=i.concat([new le(e.key,t,`string expected, "${n}" found`)]),i):(function(r){const o=r.indexOf("://")===-1;try{return new URL(r,o?"http://example.com":void 0),!0}catch{return!1}}(t)||(i=i.concat([new le(e.key,t,`invalid url "${t}"`)])),i)}function C0(e){const t=e.value,i=e.styleSpec,n=i.light,r=e.style;let o=[];const s=Bi(t);if(t===void 0)return o;if(s!=="object")return o=o.concat([new le("light",t,`object expected, ${s} found`)]),o;for(const a in t){const l=a.match(/^(.*)-transition$/);o=o.concat(l&&n[l[1]]&&n[l[1]].transition?ir({key:a,value:t[a],valueSpec:i.transition,style:r,styleSpec:i}):n[a]?ir({key:a,value:t[a],valueSpec:n[a],style:r,styleSpec:i}):[new le(a,t[a],`unknown property "${a}"`)])}return o}function D0(e){const t=e.value;let i=[];if(!t)return i;const n=Bi(t);if(n!=="object")return i=i.concat([new le("light-3d",t,`object expected, ${n} found`)]),i;const r=e.styleSpec,o=r["light-3d"],s=e.key,a=e.style,l=e.style.lights;for(const h of["type","id"])if(!(h in t))return i=i.concat([new le("light-3d",t,`missing property ${h} on light`)]),i;if(t.type&&l)for(let h=0;h<e.arrayIndex;h++){const d=Cn(t.type),p=l[h];Cn(p.type)===d&&i.push(new le(s,t.id,`duplicate light type "${t.type}", previously defined at line ${p.id.__line__}`))}const c=`properties_light_${t.type}`;if(!(c in r))return i=i.concat([new le("light-3d",t,`Invalid light type ${t.type}`)]),i;const u=r[c];for(const h in t)if(h==="properties"){const d=t[h],p=Bi(d);if(p!=="object")return i=i.concat([new le("properties",d,`object expected, ${p} found`)]),i;for(const _ in d)i=i.concat(u[_]?ir({key:_,value:d[_],valueSpec:u[_],style:a,styleSpec:r}):[new Mo(e.key,d[_],`unknown property "${_}"`)])}else{const d=h.match(/^(.*)-transition$/);i=i.concat(d&&o[d[1]]&&o[d[1]].transition?ir({key:h,value:t[h],valueSpec:r.transition,style:a,styleSpec:r}):o[h]?ir({key:h,value:t[h],valueSpec:o[h],style:a,styleSpec:r}):[new Mo(h,t[h],`unknown property "${h}"`)])}return i}function P0(e){const t=e.value,i=e.key,n=e.style,r=e.styleSpec,o=r.terrain;let s=[];const a=Bi(t);if(t===void 0||a==="null")return s;if(a!=="object")return s=s.concat([new le("terrain",t,`object expected, ${a} found`)]),s;for(const l in t){const c=l.match(/^(.*)-transition$/);s=s.concat(c&&o[c[1]]&&o[c[1]].transition?ir({key:l,value:t[l],valueSpec:r.transition,style:n,styleSpec:r}):o[l]?ir({key:l,value:t[l],valueSpec:o[l],style:n,styleSpec:r}):[new Mo(l,t[l],`unknown property "${l}"`)])}if(t.source){const l=n.sources&&n.sources[t.source],c=l&&Cn(l.type);l?c!=="raster-dem"&&s.push(new le(i,t.source,`terrain cannot be used with a source of type ${String(c)}, it only be used with a "raster-dem" source type`)):s.push(new le(i,t.source,`source "${t.source}" not found`))}else s.push(new le(i,t,'terrain is missing required property "source"'));return s}function k0(e){const t=e.value,i=e.style,n=e.styleSpec,r=n.fog;let o=[];const s=Bi(t);if(t===void 0)return o;if(s!=="object")return o=o.concat([new le("fog",t,`object expected, ${s} found`)]),o;for(const a in t){const l=a.match(/^(.*)-transition$/);o=o.concat(l&&r[l[1]]&&r[l[1]].transition?ir({key:a,value:t[a],valueSpec:n.transition,style:i,styleSpec:n}):r[a]?ir({key:a,value:t[a],valueSpec:r[a],style:i,styleSpec:n}):[new Mo(a,t[a],`unknown property "${a}"`)])}return o}const z0={"*":()=>[],array:d0,boolean:function(e){const t=e.value,i=e.key,n=Bi(t);return n!=="boolean"?[new le(i,t,`boolean expected, ${n} found`)]:[]},number:f0,color:function(e){const t=e.key,i=e.value,n=Bi(i);return n!=="string"?[new le(t,i,`color expected, ${n} found`)]:el(i)===null?[new le(t,i,`color expected, "${i}" found`)]:[]},enum:qu,filter:rp,function:p0,layer:E0,object:Wr,source:A0,model:I0,light:C0,"light-3d":D0,terrain:P0,fog:k0,string:hl,formatted:function(e){return hl(e).length===0?[]:Ma(e)},resolvedImage:function(e){return hl(e).length===0?[]:Ma(e)},projection:function(e){const t=e.value,i=e.styleSpec,n=i.projection,r=e.style;let o=[];const s=Bi(t);if(s==="object")for(const a in t)o=o.concat(ir({key:a,value:t[a],valueSpec:n[a],style:r,styleSpec:i}));else s!=="string"&&(o=o.concat([new le("projection",t,`object or string expected, ${s} found`)]));return o},import:function(e){const{value:t,styleSpec:i}=e,{data:n,...r}=t;Object.defineProperty(r,"__line__",{value:t.__line__,enumerable:!1});let o=Wr(zr({},e,{value:r,valueSpec:i.import}));return Cn(r.id)===""&&o.push(new le(`${e.key}.id`,r,"import id can't be an empty string")),n&&(o=o.concat(L0(n,i,{key:`${e.key}.data`}))),o}};function ir(e,t=!1){const i=e.value,n=e.valueSpec,r=e.styleSpec;if(n.expression&&Uu(Cn(i)))return p0(e);if(n.expression&&Vu(vr(i)))return Ma(e);if(n.type&&z0[n.type]){const o=z0[n.type](e);return t===!0&&o.length>0&&Bi(e.value)==="array"?Ma(e):o}return Wr(zr({},e,{valueSpec:n.type?r[n.type]:n}))}function OM(e){const t=e.value,i=e.key,n=hl(e);return n.length||(t.indexOf("{fontstack}")===-1&&n.push(new le(i,t,'"glyphs" url must include a "{fontstack}" token')),t.indexOf("{range}")===-1&&n.push(new le(i,t,'"glyphs" url must include a "{range}" token'))),n}function L0(e,t=rt,i={}){return ir({key:i.key||"",value:e,valueSpec:t.$root,styleSpec:t,style:e,objectElementValidators:{glyphs:OM,"*":()=>[]}})}function dl(e,t=rt){return no(L0(e,t))}const BM=e=>no(A0(e)),FM=e=>no(C0(e)),NM=e=>no(D0(e)),UM=e=>no(P0(e)),VM=e=>no(k0(e)),jM=e=>no(E0(e)),op=e=>no(rp(e)),GM=e=>no(T0(e)),qM=e=>no(M0(e)),ZM=e=>no(I0(e));function no(e){return e.slice().sort((t,i)=>t.line&&i.line?t.line-i.line:0)}function $u(e,t){let i=!1;if(t&&t.length)for(const n of t)n instanceof Mo?J(n.message):(e.fire(new Ae(new Error(n.message))),i=!0);return i}var HM=Io,zs=3;function Io(e,t,i){var n=this.cells=[];if(e instanceof ArrayBuffer){this.arrayBuffer=e;var r=new Int32Array(this.arrayBuffer);e=r[0],this.d=(t=r[1])+2*(i=r[2]);for(var o=0;o<this.d*this.d;o++){var s=r[zs+o],a=r[zs+o+1];n.push(s===a?null:r.subarray(s,a))}var l=r[zs+n.length+1];this.keys=r.subarray(r[zs+n.length],l),this.bboxes=r.subarray(l),this.insert=this._insertReadonly}else{this.d=t+2*i;for(var c=0;c<this.d*this.d;c++)n.push([]);this.keys=[],this.bboxes=[]}this.n=t,this.extent=e,this.padding=i,this.scale=t/e,this.uid=0;var u=i/t*e;this.min=-u,this.max=e+u}Io.prototype.insert=function(e,t,i,n,r){this._forEachCell(t,i,n,r,this._insertCell,this.uid++),this.keys.push(e),this.bboxes.push(t),this.bboxes.push(i),this.bboxes.push(n),this.bboxes.push(r)},Io.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},Io.prototype._insertCell=function(e,t,i,n,r,o){this.cells[r].push(o)},Io.prototype.query=function(e,t,i,n,r){var o=this.min,s=this.max;if(e<=o&&t<=o&&s<=i&&s<=n&&!r)return Array.prototype.slice.call(this.keys);var a=[];return this._forEachCell(e,t,i,n,this._queryCell,a,{},r),a},Io.prototype._queryCell=function(e,t,i,n,r,o,s,a){var l=this.cells[r];if(l!==null)for(var c=this.keys,u=this.bboxes,h=0;h<l.length;h++){var d=l[h];if(s[d]===void 0){var p=4*d;(a?a(u[p+0],u[p+1],u[p+2],u[p+3]):e<=u[p+2]&&t<=u[p+3]&&i>=u[p+0]&&n>=u[p+1])?(s[d]=!0,o.push(c[d])):s[d]=!1}}},Io.prototype._forEachCell=function(e,t,i,n,r,o,s,a){for(var l=this._convertToCellCoord(e),c=this._convertToCellCoord(t),u=this._convertToCellCoord(i),h=this._convertToCellCoord(n),d=l;d<=u;d++)for(var p=c;p<=h;p++){var _=this.d*p+d;if((!a||a(this._convertFromCellCoord(d),this._convertFromCellCoord(p),this._convertFromCellCoord(d+1),this._convertFromCellCoord(p+1)))&&r.call(this,e,t,i,n,_,o,s,a))return}},Io.prototype._convertFromCellCoord=function(e){return(e-this.padding)/this.scale},Io.prototype._convertToCellCoord=function(e){return Math.max(0,Math.min(this.d-1,Math.floor(e*this.scale)+this.padding))},Io.prototype.toArrayBuffer=function(){if(this.arrayBuffer)return this.arrayBuffer;for(var e=this.cells,t=zs+this.cells.length+1+1,i=0,n=0;n<this.cells.length;n++)i+=this.cells[n].length;var r=new Int32Array(t+i+this.keys.length+this.bboxes.length);r[0]=this.extent,r[1]=this.n,r[2]=this.padding;for(var o=t,s=0;s<e.length;s++){var a=e[s];r[zs+s]=o,r.set(a,o),o+=a.length}return r[zs+e.length]=o,r.set(this.keys,o),r[zs+e.length+1]=o+=this.keys.length,r.set(this.bboxes,o),o+=this.bboxes.length,r.buffer};var fl=dt(HM);const Xu={};function he(e,t,i={}){Object.defineProperty(e,"_classRegistryKey",{value:t,writeable:!1}),Xu[t]={klass:e,omit:i.omit||[]}}he(Object,"Object"),fl.serialize=function(e,t){const i=e.toArrayBuffer();return t&&t.add(i),{buffer:i}},fl.deserialize=function(e){return new fl(e.buffer)},Object.defineProperty(fl,"name",{value:"Grid"}),he(fl,"Grid"),he(Ye,"Color"),he(Error,"Error"),he(St,"AJAXError"),he(Hr,"ResolvedImage"),he(ju,"StylePropertyFunction"),he(Qf,"StyleExpression",{omit:["_evaluator"]}),he(ks,"ZoomDependentExpression"),he(tp,"ZoomConstantExpression"),he(So,"CompoundExpression",{omit:["_evaluate"]});for(const e in Mc)Xu[Mc[e]._classRegistryKey]||he(Mc[e],`Expression${e}`);function R0(e){return e&&typeof ArrayBuffer<"u"&&(e instanceof ArrayBuffer||e.constructor&&e.constructor.name==="ArrayBuffer")}function O0(e){return I.ImageBitmap&&e instanceof I.ImageBitmap}function pl(e,t){if(e==null||typeof e=="boolean"||typeof e=="number"||typeof e=="string"||e instanceof Boolean||e instanceof Number||e instanceof String||e instanceof Date||e instanceof RegExp)return e;if(R0(e)||O0(e))return t&&t.add(e),e;if(ArrayBuffer.isView(e)){const i=e;return t&&t.add(i.buffer),i}if(e instanceof I.ImageData)return t&&t.add(e.data.buffer),e;if(Array.isArray(e)){const i=[];for(const n of e)i.push(pl(n,t));return i}if(e instanceof Map){const i={$name:"Map"};for(const[n,r]of e.entries())i[n]=pl(r);return i}if(typeof e=="object"){const i=e.constructor,n=i._classRegistryKey;if(!n)throw new Error(`can't serialize object of unregistered class ${n}`);const r=i.serialize?i.serialize(e,t):{};if(!i.serialize){for(const o in e)e.hasOwnProperty(o)&&(Xu[n].omit.indexOf(o)>=0||(r[o]=pl(e[o],t)));e instanceof Error&&(r.message=e.message)}if(r.$name)throw new Error("$name property is reserved for worker serialization logic.");return n!=="Object"&&(r.$name=n),r}throw new Error("can't serialize object of type "+typeof e)}function ml(e){if(e==null||typeof e=="boolean"||typeof e=="number"||typeof e=="string"||e instanceof Boolean||e instanceof Number||e instanceof String||e instanceof Date||e instanceof RegExp||R0(e)||O0(e)||ArrayBuffer.isView(e)||e instanceof I.ImageData)return e;if(Array.isArray(e))return e.map(ml);if(typeof e=="object"){const t=e.$name||"Object";if(t==="Map"){const r=new Map;for(const o of Object.keys(e))o!=="$name"&&r.set(o,ml(e[o]));return r}const{klass:i}=Xu[t];if(!i)throw new Error(`can't deserialize unregistered class ${t}`);if(i.deserialize)return i.deserialize(e);const n=Object.create(i.prototype);for(const r of Object.keys(e))r!=="$name"&&(n[r]=ml(e[r]));return n}throw new Error("can't deserialize object of type "+typeof e)}const pe={"Latin-1 Supplement":e=>e>=128&&e<=255,Arabic:e=>e>=1536&&e<=1791,"Arabic Supplement":e=>e>=1872&&e<=1919,"Arabic Extended-A":e=>e>=2208&&e<=2303,"Hangul Jamo":e=>e>=4352&&e<=4607,"Unified Canadian Aboriginal Syllabics":e=>e>=5120&&e<=5759,Khmer:e=>e>=6016&&e<=6143,"Unified Canadian Aboriginal Syllabics Extended":e=>e>=6320&&e<=6399,"General Punctuation":e=>e>=8192&&e<=8303,"Letterlike Symbols":e=>e>=8448&&e<=8527,"Number Forms":e=>e>=8528&&e<=8591,"Miscellaneous Technical":e=>e>=8960&&e<=9215,"Control Pictures":e=>e>=9216&&e<=9279,"Optical Character Recognition":e=>e>=9280&&e<=9311,"Enclosed Alphanumerics":e=>e>=9312&&e<=9471,"Geometric Shapes":e=>e>=9632&&e<=9727,"Miscellaneous Symbols":e=>e>=9728&&e<=9983,"Miscellaneous Symbols and Arrows":e=>e>=11008&&e<=11263,"CJK Radicals Supplement":e=>e>=11904&&e<=12031,"Kangxi Radicals":e=>e>=12032&&e<=12255,"Ideographic Description Characters":e=>e>=12272&&e<=12287,"CJK Symbols and Punctuation":e=>e>=12288&&e<=12351,Hiragana:e=>e>=12352&&e<=12447,Katakana:e=>e>=12448&&e<=12543,Bopomofo:e=>e>=12544&&e<=12591,"Hangul Compatibility Jamo":e=>e>=12592&&e<=12687,Kanbun:e=>e>=12688&&e<=12703,"Bopomofo Extended":e=>e>=12704&&e<=12735,"CJK Strokes":e=>e>=12736&&e<=12783,"Katakana Phonetic Extensions":e=>e>=12784&&e<=12799,"Enclosed CJK Letters and Months":e=>e>=12800&&e<=13055,"CJK Compatibility":e=>e>=13056&&e<=13311,"CJK Unified Ideographs Extension A":e=>e>=13312&&e<=19903,"Yijing Hexagram Symbols":e=>e>=19904&&e<=19967,"CJK Unified Ideographs":e=>e>=19968&&e<=40959,"Yi Syllables":e=>e>=40960&&e<=42127,"Yi Radicals":e=>e>=42128&&e<=42191,"Hangul Jamo Extended-A":e=>e>=43360&&e<=43391,"Hangul Syllables":e=>e>=44032&&e<=55215,"Hangul Jamo Extended-B":e=>e>=55216&&e<=55295,"Private Use Area":e=>e>=57344&&e<=63743,"CJK Compatibility Ideographs":e=>e>=63744&&e<=64255,"Arabic Presentation Forms-A":e=>e>=64336&&e<=65023,"Vertical Forms":e=>e>=65040&&e<=65055,"CJK Compatibility Forms":e=>e>=65072&&e<=65103,"Small Form Variants":e=>e>=65104&&e<=65135,"Arabic Presentation Forms-B":e=>e>=65136&&e<=65279,"Halfwidth and Fullwidth Forms":e=>e>=65280&&e<=65519,"CJK Unified Ideographs Extension B":e=>e>=131072&&e<=173791};function sp(e){for(const t of e)if(ap(t.charCodeAt(0)))return!0;return!1}function WM(e){for(const t of e)if(!$M(t.charCodeAt(0)))return!1;return!0}function $M(e){return!(pe.Arabic(e)||pe["Arabic Supplement"](e)||pe["Arabic Extended-A"](e)||pe["Arabic Presentation Forms-A"](e)||pe["Arabic Presentation Forms-B"](e))}function ap(e){return!(e!==746&&e!==747&&(e<4352||!(pe["Bopomofo Extended"](e)||pe.Bopomofo(e)||pe["CJK Compatibility Forms"](e)&&!(e>=65097&&e<=65103)||pe["CJK Compatibility Ideographs"](e)||pe["CJK Compatibility"](e)||pe["CJK Radicals Supplement"](e)||pe["CJK Strokes"](e)||!(!pe["CJK Symbols and Punctuation"](e)||e>=12296&&e<=12305||e>=12308&&e<=12319||e===12336)||pe["CJK Unified Ideographs Extension A"](e)||pe["CJK Unified Ideographs"](e)||pe["Enclosed CJK Letters and Months"](e)||pe["Hangul Compatibility Jamo"](e)||pe["Hangul Jamo Extended-A"](e)||pe["Hangul Jamo Extended-B"](e)||pe["Hangul Jamo"](e)||pe["Hangul Syllables"](e)||pe.Hiragana(e)||pe["Ideographic Description Characters"](e)||pe.Kanbun(e)||pe["Kangxi Radicals"](e)||pe["Katakana Phonetic Extensions"](e)||pe.Katakana(e)&&e!==12540||!(!pe["Halfwidth and Fullwidth Forms"](e)||e===65288||e===65289||e===65293||e>=65306&&e<=65310||e===65339||e===65341||e===65343||e>=65371&&e<=65503||e===65507||e>=65512&&e<=65519)||!(!pe["Small Form Variants"](e)||e>=65112&&e<=65118||e>=65123&&e<=65126)||pe["Unified Canadian Aboriginal Syllabics"](e)||pe["Unified Canadian Aboriginal Syllabics Extended"](e)||pe["Vertical Forms"](e)||pe["Yijing Hexagram Symbols"](e)||pe["Yi Syllables"](e)||pe["Yi Radicals"](e))))}function B0(e){return!(ap(e)||function(t){return!!(pe["Latin-1 Supplement"](t)&&(t===167||t===169||t===174||t===177||t===188||t===189||t===190||t===215||t===247)||pe["General Punctuation"](t)&&(t===8214||t===8224||t===8225||t===8240||t===8241||t===8251||t===8252||t===8258||t===8263||t===8264||t===8265||t===8273)||pe["Letterlike Symbols"](t)||pe["Number Forms"](t)||pe["Miscellaneous Technical"](t)&&(t>=8960&&t<=8967||t>=8972&&t<=8991||t>=8996&&t<=9e3||t===9003||t>=9085&&t<=9114||t>=9150&&t<=9165||t===9167||t>=9169&&t<=9179||t>=9186&&t<=9215)||pe["Control Pictures"](t)&&t!==9251||pe["Optical Character Recognition"](t)||pe["Enclosed Alphanumerics"](t)||pe["Geometric Shapes"](t)||pe["Miscellaneous Symbols"](t)&&!(t>=9754&&t<=9759)||pe["Miscellaneous Symbols and Arrows"](t)&&(t>=11026&&t<=11055||t>=11088&&t<=11097||t>=11192&&t<=11243)||pe["CJK Symbols and Punctuation"](t)||pe.Katakana(t)||pe["Private Use Area"](t)||pe["CJK Compatibility Forms"](t)||pe["Small Form Variants"](t)||pe["Halfwidth and Fullwidth Forms"](t)||t===8734||t===8756||t===8757||t>=9984&&t<=10087||t>=10102&&t<=10131||t===65532||t===65533)}(e))}function F0(e){return e>=1424&&e<=2303||pe["Arabic Presentation Forms-A"](e)||pe["Arabic Presentation Forms-B"](e)}function XM(e,t){return!(!t&&F0(e)||e>=2304&&e<=3583||e>=3840&&e<=4255||pe.Khmer(e))}function YM(e){for(const t of e)if(F0(t.charCodeAt(0)))return!0;return!1}const lp="deferred",cp="loading",up="loaded";let hp=null,wr="unavailable",Ls=null;const N0=function(e){e&&typeof e=="string"&&e.indexOf("NetworkError")>-1&&(wr="error"),hp&&hp(e)};function dp(){fp.fire(new jt("pluginStateChange",{pluginStatus:wr,pluginURL:Ls}))}const fp=new Mn,pp=function(){return wr},U0=function(){if(wr!==lp||!Ls)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");wr=cp,dp(),Ls&&Ht({url:Ls},e=>{e?N0(e):(wr=up,dp())})},$r={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>wr===up||$r.applyArabicShaping!=null,isLoading:()=>wr===cp,setState(e){wr=e.pluginStatus,Ls=e.pluginURL},isParsed:()=>$r.applyArabicShaping!=null&&$r.processBidirectionalText!=null&&$r.processStyledBidirectionalText!=null,getPluginURL:()=>Ls};class dn{constructor(t,i){this.zoom=t,i?(this.now=i.now,this.fadeDuration=i.fadeDuration,this.transition=i.transition,this.pitch=i.pitch,this.brightness=i.brightness):(this.now=0,this.fadeDuration=0,this.transition={},this.pitch=0,this.brightness=0)}isSupportedScript(t){return function(i,n){for(const r of i)if(!XM(r.charCodeAt(0),n))return!1;return!0}(t,$r.isLoaded())}}class Yu{constructor(t,i,n){this.property=t,this.value=i,this.expression=function(r,o,s){if(Uu(r))return new ju(r,o);if(Vu(r)||Array.isArray(r)&&r.length>0){const a=ep(r,o,s);if(a.result==="error")throw new Error(a.value.map(l=>`${l.key}: ${l.message}`).join(", "));return a.value}{let a=r;return typeof r=="string"&&o.type==="color"&&(a=Ye.parse(r)),{kind:"constant",isConfigDependent:!1,evaluate:()=>a}}}(i===void 0?t.specification.default:i,t.specification,n)}isDataDriven(){return this.expression.kind==="source"||this.expression.kind==="composite"}possiblyEvaluate(t,i,n){return this.property.possiblyEvaluate(this,t,i,n)}}class mp{constructor(t,i){this.property=t,this.value=new Yu(t,void 0,i)}transitioned(t,i){return new V0(this.property,this.value,i,Vt({},t.transition,this.transition),t.now)}untransitioned(){return new V0(this.property,this.value,null,{},0)}}class Sc{constructor(t,i){this._properties=t,this._values=Object.create(t.defaultTransitionablePropertyValues),this._options=i,this.isConfigDependent=!1}getValue(t){return F(this._values[t].value.value)}setValue(t,i){this._values.hasOwnProperty(t)||(this._values[t]=new mp(this._values[t].property,this._options)),this._values[t].value=new Yu(this._values[t].property,i===null?void 0:F(i),this._options),this.isConfigDependent=this.isConfigDependent||this._values[t].value.expression.isConfigDependent}setTransitionOrValue(t,i){i&&(this._options=i);const n=this._properties.properties;if(t)for(const r in t){const o=t[r];if(mi(r,"-transition")){const s=r.slice(0,-11);n[s]&&this.setTransition(s,o)}else n[r]&&this.setValue(r,o)}}getTransition(t){return F(this._values[t].transition)}setTransition(t,i){this._values.hasOwnProperty(t)||(this._values[t]=new mp(this._values[t].property)),this._values[t].transition=F(i)||void 0}serialize(){const t={};for(const i of Object.keys(this._values)){const n=this.getValue(i);n!==void 0&&(t[i]=n);const r=this.getTransition(i);r!==void 0&&(t[`${i}-transition`]=r)}return t}transitioned(t,i){const n=new j0(this._properties);for(const r of Object.keys(this._values))n._values[r]=this._values[r].transitioned(t,i._values[r]);return n}untransitioned(){const t=new j0(this._properties);for(const i of Object.keys(this._values))t._values[i]=this._values[i].untransitioned();return t}}class V0{constructor(t,i,n,r,o){const s=r.delay||0,a=r.duration||0;o=o||0,this.property=t,this.value=i,this.begin=o+s,this.end=this.begin+a,t.specification.transition&&(r.delay||r.duration)&&(this.prior=n)}possiblyEvaluate(t,i,n){const r=t.now||0,o=this.value.possiblyEvaluate(t,i,n),s=this.prior;if(s){if(r>this.end)return this.prior=null,o;if(this.value.isDataDriven())return this.prior=null,o;if(r<this.begin)return s.possiblyEvaluate(t,i,n);{const a=(r-this.begin)/(this.end-this.begin);return this.property.interpolate(s.possiblyEvaluate(t,i,n),o,Re(a))}}return o}}class j0{constructor(t){this._properties=t,this._values=Object.create(t.defaultTransitioningPropertyValues)}possiblyEvaluate(t,i,n){const r=new Ac(this._properties);for(const o of Object.keys(this._values))r._values[o]=this._values[o].possiblyEvaluate(t,i,n);return r}hasTransition(){for(const t of Object.keys(this._values))if(this._values[t].prior)return!0;return!1}}class KM{constructor(t,i){this._properties=t,this._values=Object.create(t.defaultPropertyValues),this._options=i,this.isConfigDependent=!1}getValue(t){return F(this._values[t].value)}setValue(t,i){this._values[t]=new Yu(this._values[t].property,i===null?void 0:F(i),this._options),this.isConfigDependent=this.isConfigDependent||this._values[t].expression.isConfigDependent}serialize(){const t={};for(const i of Object.keys(this._values)){const n=this.getValue(i);n!==void 0&&(t[i]=n)}return t}possiblyEvaluate(t,i,n){const r=new Ac(this._properties);for(const o of Object.keys(this._values))r._values[o]=this._values[o].possiblyEvaluate(t,i,n);return r}}class _l{constructor(t,i,n){this.property=t,this.value=i,this.parameters=n}isConstant(){return this.value.kind==="constant"}constantOr(t){return this.value.kind==="constant"?this.value.value:t}evaluate(t,i,n,r){return this.property.evaluate(this.value,this.parameters,t,i,n,r)}}class Ac{constructor(t){this._properties=t,this._values=Object.create(t.defaultPossiblyEvaluatedValues)}get(t){return this._values[t]}}class Gt{constructor(t){this.specification=t}possiblyEvaluate(t,i){return t.expression.evaluate(i)}interpolate(t,i,n){const r=Ou[this.specification.type];return r?r(t,i,n):t}}class ve{constructor(t,i){this.specification=t,this.overrides=i}possiblyEvaluate(t,i,n,r){return new _l(this,t.expression.kind==="constant"||t.expression.kind==="camera"?{kind:"constant",value:t.expression.evaluate(i,null,{},n,r)}:t.expression,i)}interpolate(t,i,n){if(t.value.kind!=="constant"||i.value.kind!=="constant")return t;if(t.value.value===void 0||i.value.value===void 0)return new _l(this,{kind:"constant",value:void 0},t.parameters);const r=Ou[this.specification.type];return r?new _l(this,{kind:"constant",value:r(t.value.value,i.value.value,n)},t.parameters):t}evaluate(t,i,n,r,o,s){return t.kind==="constant"?t.value:t.evaluate(i,n,r,o,s)}}class Ic{constructor(t){this.specification=t}possiblyEvaluate(t,i,n,r){return!!t.expression.evaluate(i,null,{},n,r)}interpolate(){return!1}}class wn{constructor(t){this.properties=t,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];const i=new dn(0,{});for(const n in t){const r=t[n];r.specification.overridable&&this.overridableProperties.push(n);const o=this.defaultPropertyValues[n]=new Yu(r,void 0),s=this.defaultTransitionablePropertyValues[n]=new mp(r);this.defaultTransitioningPropertyValues[n]=s.untransitioned(),this.defaultPossiblyEvaluatedValues[n]=o.possiblyEvaluate(i)}}}he(ve,"DataDrivenProperty"),he(Gt,"DataConstantProperty"),he(Ic,"ColorRampProperty");const Ku="";function G0(e){return e.indexOf(Ku)>=0}function cr(e,t){return t?`${e}${Ku}${t}`:e}function Ju(e){const t=e.indexOf(Ku);return t>=0?e.slice(0,t):e}const q0="-transition";class Rr extends Mn{constructor(t,i,n){if(super(),this.id=t.id,this.type=t.type,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,this.isConfigDependent=!1,t.type!=="custom"&&(this.metadata=t.metadata,this.minzoom=t.minzoom,this.maxzoom=t.maxzoom,t.type!=="background"&&t.type!=="sky"&&t.type!=="slot"&&(this.source=t.source,this.sourceLayer=t["source-layer"],this.filter=t.filter),this.options=n,t.slot&&(this.slot=t.slot),i.layout&&(this._unevaluatedLayout=new KM(i.layout,n),this.isConfigDependent=this.isConfigDependent||this._unevaluatedLayout.isConfigDependent),i.paint)){this._transitionablePaint=new Sc(i.paint,n);for(const r in t.paint)this.setPaintProperty(r,t.paint[r],{validate:!1});for(const r in t.layout)this.setLayoutProperty(r,t.layout[r],{validate:!1});this.isConfigDependent=this.isConfigDependent||this._transitionablePaint.isConfigDependent,this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new Ac(i.paint)}}setScope(t){this.scope=t,this.fqid=cr(this.id,t)}getLayoutProperty(t){return t==="visibility"?this.visibility:this._unevaluatedLayout.getValue(t)}setLayoutProperty(t,i,n={}){if(i!=null&&this._validate(qM,`layers.${this.id}.layout.${t}`,t,i,n))return;if(this.type==="custom"&&t==="visibility")return void(this.visibility=i);const r=this._unevaluatedLayout;r._properties.properties[t]&&(r.setValue(t,i),this.isConfigDependent=this.isConfigDependent||r.isConfigDependent,t==="visibility"&&this.possiblyEvaluateVisibility())}possiblyEvaluateVisibility(){this.visibility=this._unevaluatedLayout._values.visibility.possiblyEvaluate({zoom:0})}getPaintProperty(t){return mi(t,q0)?this._transitionablePaint.getTransition(t.slice(0,-11)):this._transitionablePaint.getValue(t)}setPaintProperty(t,i,n={}){if(i!=null&&this._validate(GM,`layers.${this.id}.paint.${t}`,t,i,n))return!1;const r=this._transitionablePaint,o=r._properties.properties;if(mi(t,q0)){const d=t.slice(0,-11);return o[d]&&r.setTransition(d,i||void 0),!1}if(!o[t])return!1;const s=r._values[t],a=s.value.isDataDriven(),l=s.value;r.setValue(t,i),this.isConfigDependent=this.isConfigDependent||r.isConfigDependent,this._handleSpecialPaintPropertyUpdate(t);const c=r._values[t].value,u=c.isDataDriven(),h=mi(t,"pattern")||t==="line-dasharray";return u||a||h||this._handleOverridablePaintPropertyUpdate(t,l,c)}_handleSpecialPaintPropertyUpdate(t){}getProgramIds(){return null}getDefaultProgramParams(t,i){return null}_handleOverridablePaintPropertyUpdate(t,i,n){return!1}isHidden(t){return!!(this.minzoom&&t<this.minzoom)||!!(this.maxzoom&&t>=this.maxzoom)||this.visibility==="none"}updateTransitions(t){this._transitioningPaint=this._transitionablePaint.transitioned(t,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(t,i){this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(t,void 0,i)),this.paint=this._transitioningPaint.possiblyEvaluate(t,void 0,i)}serialize(){return Dt({id:this.id,type:this.type,slot:this.slot,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()},(t,i)=>!(t===void 0||i==="layout"&&!Object.keys(t).length||i==="paint"&&!Object.keys(t).length))}_validate(t,i,n,r,o={}){return(!o||o.validate!==!1)&&$u(this,t.call(dl,{key:i,layerType:this.type,objectKey:n,value:r,styleSpec:rt,style:{glyphs:!0,sprite:!0}}))}is3D(){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}hasShadowPass(){return!1}canCastShadows(){return!1}hasLightBeamPass(){return!1}cutoffRange(){return 0}resize(){}isStateDependent(){for(const t in this.paint._values){const i=this.paint.get(t);if(i instanceof _l&&Ta(i.property.specification)&&(i.value.kind==="source"||i.value.kind==="composite")&&i.value.isStateDependent)return!0}return!1}compileFilter(){this._filterCompiled||(this._featureFilter=Zu(this.filter),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}getLayerRenderingStats(){return this._stats}resetLayerRenderingStats(){this._stats&&(this._stats.numRenderedVerticesInShadowPass=0,this._stats.numRenderedVerticesInTransparentPass=0)}}class JM{constructor(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps=new Set,this._updatedImages=new Set}isDirty(){return this._changed}setDirty(){this._changed=!0}getUpdatedSourceCaches(){return this._updatedSourceCaches}updateSourceCache(t,i){this._updatedSourceCaches[t]=i,this.setDirty()}discardSourceCacheUpdate(t){delete this._updatedSourceCaches[t]}updateLayer(t){const i=t.scope;this._updatedLayers[i]=this._updatedLayers[i]||new Set,this._updatedLayers[i].add(t.id),this.setDirty()}removeLayer(t){const i=t.scope;this._removedLayers[i]=this._removedLayers[i]||{},this._updatedLayers[i]=this._updatedLayers[i]||new Set,this._removedLayers[i][t.id]=t,this._updatedLayers[i].delete(t.id),this._updatedPaintProps.delete(t.fqid),this.setDirty()}getRemovedLayer(t){return this._removedLayers[t.scope]?this._removedLayers[t.scope][t.id]:null}discardLayerRemoval(t){this._removedLayers[t.scope]&&delete this._removedLayers[t.scope][t.id]}getLayerUpdatesByScope(){const t={};for(const i in this._updatedLayers)t[i]=t[i]||{},t[i].updatedIds=Array.from(this._updatedLayers[i].values());for(const i in this._removedLayers)t[i]=t[i]||{},t[i].removedIds=Object.keys(this._removedLayers[i]);return t}getUpdatedPaintProperties(){return this._updatedPaintProps}updatePaintProperties(t){this._updatedPaintProps.add(t.fqid),this.setDirty()}getUpdatedImages(){return Array.from(this._updatedImages.values())}updateImage(t){this._updatedImages.add(t),this.setDirty()}resetUpdatedImages(){this._updatedImages.clear()}reset(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps.clear(),this._updatedImages.clear()}}const QM={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class Qu{constructor(t,i){this._structArray=t,this._pos1=i*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class fn{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(t,i){return t._trim(),i&&(t.isTransferred=!0,i.add(t.arrayBuffer)),{length:t.length,arrayBuffer:t.arrayBuffer}}static deserialize(t){const i=Object.create(this.prototype);return i.arrayBuffer=t.arrayBuffer,i.length=t.length,i.capacity=t.arrayBuffer.byteLength/i.bytesPerElement,i._refreshViews(),i}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(t){this.reserve(t),this.length=t}reserve(t){if(t>this.capacity){this.capacity=Math.max(t,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const i=this.uint8;this._refreshViews(),i&&this.uint8.set(i)}}_refreshViews(){throw new Error("_refreshViews() must be implemented by each concrete StructArray layout")}destroy(){this.int8=this.uint8=this.int16=this.uint16=this.int32=this.uint32=this.float32=null,this.arrayBuffer=null}}function zi(e,t=1){let i=0,n=0;return{members:e.map(r=>{const o=QM[r.type].BYTES_PER_ELEMENT,s=i=Z0(i,Math.max(t,o)),a=r.components||1;return n=Math.max(n,o),i+=o*a,{name:r.name,type:r.type,components:a,offset:s}}),size:Z0(i,Math.max(n,t)),alignment:t}}function Z0(e,t){return Math.ceil(e/t)*t}class Tr extends fn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,i){const n=this.length;return this.resize(n+1),this.emplace(n,t,i)}emplace(t,i,n){const r=2*t;return this.int16[r+0]=i,this.int16[r+1]=n,t}}Tr.prototype.bytesPerElement=4,he(Tr,"StructArrayLayout2i4");class th extends fn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,i,n){const r=this.length;return this.resize(r+1),this.emplace(r,t,i,n)}emplace(t,i,n,r){const o=3*t;return this.int16[o+0]=i,this.int16[o+1]=n,this.int16[o+2]=r,t}}th.prototype.bytesPerElement=6,he(th,"StructArrayLayout3i6");class Ea extends fn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,i,n,r){const o=this.length;return this.resize(o+1),this.emplace(o,t,i,n,r)}emplace(t,i,n,r,o){const s=4*t;return this.int16[s+0]=i,this.int16[s+1]=n,this.int16[s+2]=r,this.int16[s+3]=o,t}}Ea.prototype.bytesPerElement=8,he(Ea,"StructArrayLayout4i8");class _p extends fn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,i,n,r,o){const s=this.length;return this.resize(s+1),this.emplace(s,t,i,n,r,o)}emplace(t,i,n,r,o,s){const a=5*t;return this.int16[a+0]=i,this.int16[a+1]=n,this.int16[a+2]=r,this.int16[a+3]=o,this.int16[a+4]=s,t}}_p.prototype.bytesPerElement=10,he(_p,"StructArrayLayout5i10");class gp extends fn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,i,n,r,o,s,a){const l=this.length;return this.resize(l+1),this.emplace(l,t,i,n,r,o,s,a)}emplace(t,i,n,r,o,s,a,l){const c=6*t,u=12*t,h=3*t;return this.int16[c+0]=i,this.int16[c+1]=n,this.uint8[u+4]=r,this.uint8[u+5]=o,this.uint8[u+6]=s,this.uint8[u+7]=a,this.float32[h+2]=l,t}}gp.prototype.bytesPerElement=12,he(gp,"StructArrayLayout2i4ub1f12");class is extends fn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,i,n,r){const o=this.length;return this.resize(o+1),this.emplace(o,t,i,n,r)}emplace(t,i,n,r,o){const s=4*t;return this.float32[s+0]=i,this.float32[s+1]=n,this.float32[s+2]=r,this.float32[s+3]=o,t}}is.prototype.bytesPerElement=16,he(is,"StructArrayLayout4f16");class Rs extends fn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,i,n,r,o){const s=this.length;return this.resize(s+1),this.emplace(s,t,i,n,r,o)}emplace(t,i,n,r,o,s){const a=6*t,l=3*t;return this.uint16[a+0]=i,this.uint16[a+1]=n,this.uint16[a+2]=r,this.uint16[a+3]=o,this.float32[l+2]=s,t}}Rs.prototype.bytesPerElement=12,he(Rs,"StructArrayLayout4ui1f12");class eh extends fn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,i,n,r){const o=this.length;return this.resize(o+1),this.emplace(o,t,i,n,r)}emplace(t,i,n,r,o){const s=4*t;return this.uint16[s+0]=i,this.uint16[s+1]=n,this.uint16[s+2]=r,this.uint16[s+3]=o,t}}eh.prototype.bytesPerElement=8,he(eh,"StructArrayLayout4ui8");class ih extends fn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,i,n,r,o,s){const a=this.length;return this.resize(a+1),this.emplace(a,t,i,n,r,o,s)}emplace(t,i,n,r,o,s,a){const l=6*t;return this.int16[l+0]=i,this.int16[l+1]=n,this.int16[l+2]=r,this.int16[l+3]=o,this.int16[l+4]=s,this.int16[l+5]=a,t}}ih.prototype.bytesPerElement=12,he(ih,"StructArrayLayout6i12");class yp extends fn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,i,n,r,o,s,a,l,c,u,h,d){const p=this.length;return this.resize(p+1),this.emplace(p,t,i,n,r,o,s,a,l,c,u,h,d)}emplace(t,i,n,r,o,s,a,l,c,u,h,d,p){const _=12*t;return this.int16[_+0]=i,this.int16[_+1]=n,this.int16[_+2]=r,this.int16[_+3]=o,this.uint16[_+4]=s,this.uint16[_+5]=a,this.uint16[_+6]=l,this.uint16[_+7]=c,this.int16[_+8]=u,this.int16[_+9]=h,this.int16[_+10]=d,this.int16[_+11]=p,t}}yp.prototype.bytesPerElement=24,he(yp,"StructArrayLayout4i4ui4i24");class vp extends fn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,i,n,r,o,s){const a=this.length;return this.resize(a+1),this.emplace(a,t,i,n,r,o,s)}emplace(t,i,n,r,o,s,a){const l=10*t,c=5*t;return this.int16[l+0]=i,this.int16[l+1]=n,this.int16[l+2]=r,this.float32[c+2]=o,this.float32[c+3]=s,this.float32[c+4]=a,t}}vp.prototype.bytesPerElement=20,he(vp,"StructArrayLayout3i3f20");class xp extends fn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(t){const i=this.length;return this.resize(i+1),this.emplace(i,t)}emplace(t,i){return this.uint32[1*t+0]=i,t}}xp.prototype.bytesPerElement=4,he(xp,"StructArrayLayout1ul4");class Os extends fn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,i){const n=this.length;return this.resize(n+1),this.emplace(n,t,i)}emplace(t,i,n){const r=2*t;return this.uint16[r+0]=i,this.uint16[r+1]=n,t}}Os.prototype.bytesPerElement=4,he(Os,"StructArrayLayout2ui4");class bp extends fn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,i,n,r,o,s,a,l,c,u,h,d,p){const _=this.length;return this.resize(_+1),this.emplace(_,t,i,n,r,o,s,a,l,c,u,h,d,p)}emplace(t,i,n,r,o,s,a,l,c,u,h,d,p,_){const g=20*t,y=10*t;return this.int16[g+0]=i,this.int16[g+1]=n,this.int16[g+2]=r,this.int16[g+3]=o,this.int16[g+4]=s,this.float32[y+3]=a,this.float32[y+4]=l,this.float32[y+5]=c,this.float32[y+6]=u,this.int16[g+14]=h,this.uint32[y+8]=d,this.uint16[g+18]=p,this.uint16[g+19]=_,t}}bp.prototype.bytesPerElement=40,he(bp,"StructArrayLayout5i4f1i1ul2ui40");class nh extends fn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,i,n,r,o,s,a){const l=this.length;return this.resize(l+1),this.emplace(l,t,i,n,r,o,s,a)}emplace(t,i,n,r,o,s,a,l){const c=8*t;return this.int16[c+0]=i,this.int16[c+1]=n,this.int16[c+2]=r,this.int16[c+4]=o,this.int16[c+5]=s,this.int16[c+6]=a,this.int16[c+7]=l,t}}nh.prototype.bytesPerElement=16,he(nh,"StructArrayLayout3i2i2i16");class wp extends fn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,i,n,r,o){const s=this.length;return this.resize(s+1),this.emplace(s,t,i,n,r,o)}emplace(t,i,n,r,o,s){const a=4*t,l=8*t;return this.float32[a+0]=i,this.float32[a+1]=n,this.float32[a+2]=r,this.int16[l+6]=o,this.int16[l+7]=s,t}}wp.prototype.bytesPerElement=16,he(wp,"StructArrayLayout2f1f2i16");class Tp extends fn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,i,n,r){const o=this.length;return this.resize(o+1),this.emplace(o,t,i,n,r)}emplace(t,i,n,r,o){const s=12*t,a=3*t;return this.uint8[s+0]=i,this.uint8[s+1]=n,this.float32[a+1]=r,this.float32[a+2]=o,t}}Tp.prototype.bytesPerElement=12,he(Tp,"StructArrayLayout2ub2f12");class Rn extends fn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,i,n){const r=this.length;return this.resize(r+1),this.emplace(r,t,i,n)}emplace(t,i,n,r){const o=3*t;return this.uint16[o+0]=i,this.uint16[o+1]=n,this.uint16[o+2]=r,t}}Rn.prototype.bytesPerElement=6,he(Rn,"StructArrayLayout3ui6");class Mp extends fn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(t,i,n,r,o,s,a,l,c,u,h,d,p,_,g,y,x,b,M,E,T){const S=this.length;return this.resize(S+1),this.emplace(S,t,i,n,r,o,s,a,l,c,u,h,d,p,_,g,y,x,b,M,E,T)}emplace(t,i,n,r,o,s,a,l,c,u,h,d,p,_,g,y,x,b,M,E,T,S){const D=30*t,z=15*t,L=60*t;return this.int16[D+0]=i,this.int16[D+1]=n,this.int16[D+2]=r,this.float32[z+2]=o,this.float32[z+3]=s,this.uint16[D+8]=a,this.uint16[D+9]=l,this.uint32[z+5]=c,this.uint32[z+6]=u,this.uint32[z+7]=h,this.uint16[D+16]=d,this.uint16[D+17]=p,this.uint16[D+18]=_,this.float32[z+10]=g,this.float32[z+11]=y,this.uint8[L+48]=x,this.uint8[L+49]=b,this.uint8[L+50]=M,this.uint32[z+13]=E,this.int16[D+28]=T,this.uint8[L+58]=S,t}}Mp.prototype.bytesPerElement=60,he(Mp,"StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60");class Ep extends fn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(t,i,n,r,o,s,a,l,c,u,h,d,p,_,g,y,x,b,M,E,T,S,D,z,L,R,N,U,H,O,X,K){const ot=this.length;return this.resize(ot+1),this.emplace(ot,t,i,n,r,o,s,a,l,c,u,h,d,p,_,g,y,x,b,M,E,T,S,D,z,L,R,N,U,H,O,X,K)}emplace(t,i,n,r,o,s,a,l,c,u,h,d,p,_,g,y,x,b,M,E,T,S,D,z,L,R,N,U,H,O,X,K,ot){const $=20*t,Y=40*t,at=80*t;return this.float32[$+0]=i,this.float32[$+1]=n,this.int16[Y+4]=r,this.int16[Y+5]=o,this.int16[Y+6]=s,this.int16[Y+7]=a,this.int16[Y+8]=l,this.int16[Y+9]=c,this.int16[Y+10]=u,this.int16[Y+11]=h,this.int16[Y+12]=d,this.uint16[Y+13]=p,this.uint16[Y+14]=_,this.uint16[Y+15]=g,this.uint16[Y+16]=y,this.uint16[Y+17]=x,this.uint16[Y+18]=b,this.uint16[Y+19]=M,this.uint16[Y+20]=E,this.uint16[Y+21]=T,this.uint16[Y+22]=S,this.uint16[Y+23]=D,this.uint16[Y+24]=z,this.uint16[Y+25]=L,this.uint16[Y+26]=R,this.uint16[Y+27]=N,this.uint32[$+14]=U,this.float32[$+15]=H,this.float32[$+16]=O,this.float32[$+17]=X,this.float32[$+18]=K,this.uint8[at+76]=ot,t}}Ep.prototype.bytesPerElement=80,he(Ep,"StructArrayLayout2f9i15ui1ul4f1ub80");class Cc extends fn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t){const i=this.length;return this.resize(i+1),this.emplace(i,t)}emplace(t,i){return this.float32[1*t+0]=i,t}}Cc.prototype.bytesPerElement=4,he(Cc,"StructArrayLayout1f4");class Sa extends fn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,i,n,r,o){const s=this.length;return this.resize(s+1),this.emplace(s,t,i,n,r,o)}emplace(t,i,n,r,o,s){const a=5*t;return this.float32[a+0]=i,this.float32[a+1]=n,this.float32[a+2]=r,this.float32[a+3]=o,this.float32[a+4]=s,t}}Sa.prototype.bytesPerElement=20,he(Sa,"StructArrayLayout5f20");class Sp extends fn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,i,n,r,o,s,a){const l=this.length;return this.resize(l+1),this.emplace(l,t,i,n,r,o,s,a)}emplace(t,i,n,r,o,s,a,l){const c=7*t;return this.float32[c+0]=i,this.float32[c+1]=n,this.float32[c+2]=r,this.float32[c+3]=o,this.float32[c+4]=s,this.float32[c+5]=a,this.float32[c+6]=l,t}}Sp.prototype.bytesPerElement=28,he(Sp,"StructArrayLayout7f28");class Ap extends fn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,i,n,r){const o=this.length;return this.resize(o+1),this.emplace(o,t,i,n,r)}emplace(t,i,n,r,o){const s=6*t;return this.uint32[3*t+0]=i,this.uint16[s+2]=n,this.uint16[s+3]=r,this.uint16[s+4]=o,t}}Ap.prototype.bytesPerElement=12,he(Ap,"StructArrayLayout1ul3ui12");class Dc extends fn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t){const i=this.length;return this.resize(i+1),this.emplace(i,t)}emplace(t,i){return this.uint16[1*t+0]=i,t}}Dc.prototype.bytesPerElement=2,he(Dc,"StructArrayLayout1ui2");class Aa extends fn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,i,n){const r=this.length;return this.resize(r+1),this.emplace(r,t,i,n)}emplace(t,i,n,r){const o=3*t;return this.float32[o+0]=i,this.float32[o+1]=n,this.float32[o+2]=r,t}}Aa.prototype.bytesPerElement=12,he(Aa,"StructArrayLayout3f12");class Pc extends fn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,i){const n=this.length;return this.resize(n+1),this.emplace(n,t,i)}emplace(t,i,n){const r=2*t;return this.float32[r+0]=i,this.float32[r+1]=n,t}}Pc.prototype.bytesPerElement=8,he(Pc,"StructArrayLayout2f8");class Ip extends fn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,i,n,r,o,s,a,l,c,u,h,d,p,_,g,y){const x=this.length;return this.resize(x+1),this.emplace(x,t,i,n,r,o,s,a,l,c,u,h,d,p,_,g,y)}emplace(t,i,n,r,o,s,a,l,c,u,h,d,p,_,g,y,x){const b=16*t;return this.float32[b+0]=i,this.float32[b+1]=n,this.float32[b+2]=r,this.float32[b+3]=o,this.float32[b+4]=s,this.float32[b+5]=a,this.float32[b+6]=l,this.float32[b+7]=c,this.float32[b+8]=u,this.float32[b+9]=h,this.float32[b+10]=d,this.float32[b+11]=p,this.float32[b+12]=_,this.float32[b+13]=g,this.float32[b+14]=y,this.float32[b+15]=x,t}}Ip.prototype.bytesPerElement=64,he(Ip,"StructArrayLayout16f64");class rh extends fn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,i,n,r,o,s,a){const l=this.length;return this.resize(l+1),this.emplace(l,t,i,n,r,o,s,a)}emplace(t,i,n,r,o,s,a,l){const c=10*t,u=5*t;return this.uint16[c+0]=i,this.uint16[c+1]=n,this.uint16[c+2]=r,this.uint16[c+3]=o,this.float32[u+2]=s,this.float32[u+3]=a,this.float32[u+4]=l,t}}rh.prototype.bytesPerElement=20,he(rh,"StructArrayLayout4ui3f20");class Cp extends fn{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer)}emplaceBack(t){const i=this.length;return this.resize(i+1),this.emplace(i,t)}emplace(t,i){return this.uint8[1*t+0]=i,t}}Cp.prototype.bytesPerElement=1,he(Cp,"StructArrayLayout1ub1");class H0 extends Qu{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}}H0.prototype.size=40;class Dp extends bp{get(t){return new H0(this,t)}}he(Dp,"CollisionBoxArray");class W0 extends Qu{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(t){this._structArray.uint8[this._pos1+49]=t}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(t){this._structArray.uint8[this._pos1+50]=t}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(t){this._structArray.uint32[this._pos4+13]=t}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(t){this._structArray.uint8[this._pos1+58]=t}}W0.prototype.size=60;class $0 extends Mp{get(t){return new W0(this,t)}}he($0,"PlacedSymbolArray");class X0 extends Qu{get tileAnchorX(){return this._structArray.float32[this._pos4+0]}get tileAnchorY(){return this._structArray.float32[this._pos4+1]}get projectedAnchorX(){return this._structArray.int16[this._pos2+4]}get projectedAnchorY(){return this._structArray.int16[this._pos2+5]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+6]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+7]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+11]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get key(){return this._structArray.uint16[this._pos2+13]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+14]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+15]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+17]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+19]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+21]}get featureIndex(){return this._structArray.uint16[this._pos2+22]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+23]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numIconVertices(){return this._structArray.uint16[this._pos2+25]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+26]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+27]}get crossTileID(){return this._structArray.uint32[this._pos4+14]}set crossTileID(t){this._structArray.uint32[this._pos4+14]=t}get textOffset0(){return this._structArray.float32[this._pos4+15]}get textOffset1(){return this._structArray.float32[this._pos4+16]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+17]}get zOffset(){return this._structArray.float32[this._pos4+18]}set zOffset(t){this._structArray.float32[this._pos4+18]=t}get hasIconTextFit(){return this._structArray.uint8[this._pos1+76]}}X0.prototype.size=80;class Y0 extends Ep{get(t){return new X0(this,t)}}he(Y0,"SymbolInstanceArray");class K0 extends Cc{getoffsetX(t){return this.float32[1*t+0]}}he(K0,"GlyphOffsetArray");class J0 extends Tr{getx(t){return this.int16[2*t+0]}gety(t){return this.int16[2*t+1]}}he(J0,"SymbolLineVertexArray");class Q0 extends Qu{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}}Q0.prototype.size=12;class ty extends Ap{get(t){return new Q0(this,t)}}he(ty,"FeatureIndexArray");class ey extends Os{geta_centroid_pos0(t){return this.uint16[2*t+0]}geta_centroid_pos1(t){return this.uint16[2*t+1]}}he(ey,"FillExtrusionCentroidArray");const tE=zi([{name:"a_pos",components:2,type:"Int16"}],4),eE=zi([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]);class Fi{constructor(t=[]){this.segments=t}_prepareSegment(t,i,n,r){let o=this.segments[this.segments.length-1];return t>Fi.MAX_VERTEX_ARRAY_LENGTH&&J(`Max vertices per segment is ${Fi.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${t}`),(!o||o.vertexLength+t>Fi.MAX_VERTEX_ARRAY_LENGTH||o.sortKey!==r)&&(o={vertexOffset:i,primitiveOffset:n,vertexLength:0,primitiveLength:0},r!==void 0&&(o.sortKey=r),this.segments.push(o)),o}prepareSegment(t,i,n,r){return this._prepareSegment(t,i.length,n.length,r)}get(){return this.segments}destroy(){for(const t of this.segments)for(const i in t.vaos)t.vaos[i].destroy()}static simpleSegment(t,i,n,r){return new Fi([{vertexOffset:t,primitiveOffset:i,vertexLength:n,primitiveLength:r,vaos:{},sortKey:0}])}}function iy(e,t){return 256*(e=Lt(Math.floor(e),0,255))+Lt(Math.floor(t),0,255)}Fi.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,he(Fi,"SegmentVector");const iE=zi([{name:"a_pattern",components:4,type:"Uint16"},{name:"a_pixel_ratio",components:1,type:"Float32"}]),nE=zi([{name:"a_dash",components:4,type:"Uint16"}]);var oh={exports:{}},ny={exports:{}};(function(e){e.exports=function(t,i){var n,r,o,s,a,l,c,u;for(r=t.length-(n=3&t.length),o=i,a=3432918353,l=461845907,u=0;u<r;)c=255&t.charCodeAt(u)|(255&t.charCodeAt(++u))<<8|(255&t.charCodeAt(++u))<<16|(255&t.charCodeAt(++u))<<24,++u,o=27492+(65535&(s=5*(65535&(o=(o^=c=(65535&(c=(c=(65535&c)*a+(((c>>>16)*a&65535)<<16)&4294967295)<<15|c>>>17))*l+(((c>>>16)*l&65535)<<16)&4294967295)<<13|o>>>19))+((5*(o>>>16)&65535)<<16)&4294967295))+((58964+(s>>>16)&65535)<<16);switch(c=0,n){case 3:c^=(255&t.charCodeAt(u+2))<<16;case 2:c^=(255&t.charCodeAt(u+1))<<8;case 1:o^=c=(65535&(c=(c=(65535&(c^=255&t.charCodeAt(u)))*a+(((c>>>16)*a&65535)<<16)&4294967295)<<15|c>>>17))*l+(((c>>>16)*l&65535)<<16)&4294967295}return o^=t.length,o=2246822507*(65535&(o^=o>>>16))+((2246822507*(o>>>16)&65535)<<16)&4294967295,o=3266489909*(65535&(o^=o>>>13))+((3266489909*(o>>>16)&65535)<<16)&4294967295,(o^=o>>>16)>>>0}})(ny);var rE=ny.exports,ry={exports:{}};(function(e){e.exports=function(t,i){for(var n,r=t.length,o=i^r,s=0;r>=4;)n=1540483477*(65535&(n=255&t.charCodeAt(s)|(255&t.charCodeAt(++s))<<8|(255&t.charCodeAt(++s))<<16|(255&t.charCodeAt(++s))<<24))+((1540483477*(n>>>16)&65535)<<16),o=1540483477*(65535&o)+((1540483477*(o>>>16)&65535)<<16)^(n=1540483477*(65535&(n^=n>>>24))+((1540483477*(n>>>16)&65535)<<16)),r-=4,++s;switch(r){case 3:o^=(255&t.charCodeAt(s+2))<<16;case 2:o^=(255&t.charCodeAt(s+1))<<8;case 1:o=1540483477*(65535&(o^=255&t.charCodeAt(s)))+((1540483477*(o>>>16)&65535)<<16)}return o=1540483477*(65535&(o^=o>>>13))+((1540483477*(o>>>16)&65535)<<16),(o^=o>>>15)>>>0}})(ry);var oy=rE,oE=ry.exports;oh.exports=oy,oh.exports.murmur3=oy,oh.exports.murmur2=oE;var Pp=dt(oh.exports);class kc{constructor(){this.ids=[],this.uniqueIds=[],this.positions=[],this.indexed=!1}add(t,i,n,r){this.ids.push(sy(t)),this.positions.push(i,n,r)}eachPosition(t,i){const n=sy(t);let r=0,o=this.ids.length-1;for(;r<o;){const s=r+o>>1;this.ids[s]>=n?o=s:r=s+1}for(;this.ids[r]===n;)i(this.positions[3*r],this.positions[3*r+1],this.positions[3*r+2]),r++}static serialize(t,i){const n=new Float64Array(t.ids),r=new Uint32Array(t.positions);return kp(n,r,0,n.length-1),i&&(i.add(n.buffer),i.add(r.buffer)),{ids:n,positions:r}}static deserialize(t){const i=new kc;let n;i.ids=t.ids,i.positions=t.positions;for(const r of i.ids)r!==n&&i.uniqueIds.push(r),n=r;return i.indexed=!0,i}}function sy(e){const t=+e;return!isNaN(t)&&Number.MIN_SAFE_INTEGER<=t&&t<=Number.MAX_SAFE_INTEGER?t:Pp(String(e))}function kp(e,t,i,n){for(;i<n;){const r=e[i+n>>1];let o=i-1,s=n+1;for(;;){do o++;while(e[o]<r);do s--;while(e[s]>r);if(o>=s)break;sh(e,o,s),sh(t,3*o,3*s),sh(t,3*o+1,3*s+1),sh(t,3*o+2,3*s+2)}s-i<n-s?(kp(e,t,i,s),i=s+1):(kp(e,t,s+1,n),n=s)}}function sh(e,t,i){const n=e[t];e[t]=e[i],e[i]=n}he(kc,"FeaturePositionMap");class ns{constructor(t){this.gl=t.gl,this.initialized=!1}fetchUniformLocation(t,i){return this.location||this.initialized||(this.location=this.gl.getUniformLocation(t,i),this.initialized=!0),!!this.location}}class ei extends ns{constructor(t){super(t),this.current=0}set(t,i,n){this.fetchUniformLocation(t,i)&&this.current!==n&&(this.current=n,this.gl.uniform1i(this.location,n))}}class Nt extends ns{constructor(t){super(t),this.current=0}set(t,i,n){this.fetchUniformLocation(t,i)&&this.current!==n&&(this.current=n,this.gl.uniform1f(this.location,n))}}class ii extends ns{constructor(t){super(t),this.current=[0,0]}set(t,i,n){this.fetchUniformLocation(t,i)&&(n[0]===this.current[0]&&n[1]===this.current[1]||(this.current=n,this.gl.uniform2f(this.location,n[0],n[1])))}}class je extends ns{constructor(t){super(t),this.current=[0,0,0]}set(t,i,n){this.fetchUniformLocation(t,i)&&(n[0]===this.current[0]&&n[1]===this.current[1]&&n[2]===this.current[2]||(this.current=n,this.gl.uniform3f(this.location,n[0],n[1],n[2])))}}class Mr extends ns{constructor(t){super(t),this.current=[0,0,0,0]}set(t,i,n){this.fetchUniformLocation(t,i)&&(n[0]===this.current[0]&&n[1]===this.current[1]&&n[2]===this.current[2]&&n[3]===this.current[3]||(this.current=n,this.gl.uniform4f(this.location,n[0],n[1],n[2],n[3])))}}class gl extends ns{constructor(t){super(t),this.current=Ye.transparent}set(t,i,n){this.fetchUniformLocation(t,i)&&(n.r===this.current.r&&n.g===this.current.g&&n.b===this.current.b&&n.a===this.current.a||(this.current=n,this.gl.uniform4f(this.location,n.r,n.g,n.b,n.a)))}}const sE=new Float32Array(16);class Ne extends ns{constructor(t){super(t),this.current=sE}set(t,i,n){if(this.fetchUniformLocation(t,i)){if(n[12]!==this.current[12]||n[0]!==this.current[0])return this.current=n,void this.gl.uniformMatrix4fv(this.location,!1,n);for(let r=1;r<16;r++)if(n[r]!==this.current[r]){this.current=n,this.gl.uniformMatrix4fv(this.location,!1,n);break}}}}const aE=new Float32Array(9);class zp extends ns{constructor(t){super(t),this.current=aE}set(t,i,n){if(this.fetchUniformLocation(t,i)){for(let r=0;r<9;r++)if(n[r]!==this.current[r]){this.current=n,this.gl.uniformMatrix3fv(this.location,!1,n);break}}}}const lE=new Float32Array(4);class Lp extends ns{constructor(t){super(t),this.current=lE}set(t,i,n){if(this.fetchUniformLocation(t,i)){for(let r=0;r<4;r++)if(n[r]!==this.current[r]){this.current=n,this.gl.uniformMatrix2fv(this.location,!1,n);break}}}}function Rp(e){return[iy(255*e.r,255*e.g),iy(255*e.b,255*e.a)]}class zc{constructor(t,i,n){this.value=t,this.uniformNames=i.map(r=>`u_${r}`),this.type=n}setUniform(t,i,n,r,o){i.set(t,o,r.constantOr(this.value))}getBinding(t,i){return this.type==="color"?new gl(t):new Nt(t)}}class yl{constructor(t,i){this.uniformNames=i.map(n=>`u_${n}`),this.pattern=null,this.pixelRatio=1}setConstantPatternPositions(t){this.pixelRatio=t.pixelRatio||1,this.pattern=t.tl.concat(t.br)}setUniform(t,i,n,r,o){const s=o==="u_pattern"||o==="u_dash"?this.pattern:o==="u_pixel_ratio"?this.pixelRatio:null;s&&i.set(t,o,s)}getBinding(t,i){return i==="u_pattern"||i==="u_dash"?new Mr(t):new Nt(t)}}class rs{constructor(t,i,n,r){this.expression=t,this.type=n,this.maxValue=0,this.paintVertexAttributes=i.map(o=>({name:`a_${o}`,type:"Float32",components:n==="color"?2:1,offset:0})),this.paintVertexArray=new r}populatePaintArray(t,i,n,r,o,s,a){const l=this.paintVertexArray.length,c=this.expression.evaluate(new dn(0,{brightness:s}),i,{},o,r,a);this.paintVertexArray.resize(t),this._setPaintValue(l,t,c)}updatePaintArray(t,i,n,r,o,s,a){const l=this.expression.evaluate({zoom:0,brightness:a},n,r,void 0,o);this._setPaintValue(t,i,l)}_setPaintValue(t,i,n){if(this.type==="color"){const r=Rp(n);for(let o=t;o<i;o++)this.paintVertexArray.emplace(o,r[0],r[1])}else{for(let r=t;r<i;r++)this.paintVertexArray.emplace(r,n);this.maxValue=Math.max(this.maxValue,Math.abs(n))}}upload(t){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=t.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class ro{constructor(t,i,n,r,o,s){this.expression=t,this.uniformNames=i.map(a=>`u_${a}_t`),this.type=n,this.useIntegerZoom=r,this.zoom=o,this.maxValue=0,this.paintVertexAttributes=i.map(a=>({name:`a_${a}`,type:"Float32",components:n==="color"?4:2,offset:0})),this.paintVertexArray=new s}populatePaintArray(t,i,n,r,o,s,a){const l=this.expression.evaluate(new dn(this.zoom,{brightness:s}),i,{},o,r,a),c=this.expression.evaluate(new dn(this.zoom+1,{brightness:s}),i,{},o,r,a),u=this.paintVertexArray.length;this.paintVertexArray.resize(t),this._setPaintValue(u,t,l,c)}updatePaintArray(t,i,n,r,o,s,a){const l=this.expression.evaluate({zoom:this.zoom,brightness:a},n,r,void 0,o),c=this.expression.evaluate({zoom:this.zoom+1,brightness:a},n,r,void 0,o);this._setPaintValue(t,i,l,c)}_setPaintValue(t,i,n,r){if(this.type==="color"){const o=Rp(n),s=Rp(r);for(let a=t;a<i;a++)this.paintVertexArray.emplace(a,o[0],o[1],s[0],s[1])}else{for(let o=t;o<i;o++)this.paintVertexArray.emplace(o,n,r);this.maxValue=Math.max(this.maxValue,Math.abs(n),Math.abs(r))}}upload(t){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=t.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(t,i,n,r,o){const s=this.useIntegerZoom?Math.floor(n.zoom):n.zoom,a=Lt(this.expression.interpolationFactor(s,this.zoom,this.zoom+1),0,1);i.set(t,o,a)}getBinding(t,i){return new Nt(t)}}class Bs{constructor(t,i,n,r,o){this.expression=t,this.layerId=o,this.paintVertexAttributes=(n==="array"?nE:iE).members;for(let s=0;s<i.length;++s);this.paintVertexArray=new r}populatePaintArray(t,i,n){const r=this.paintVertexArray.length;this.paintVertexArray.resize(t),this._setPaintValues(r,t,i.patterns&&i.patterns[this.layerId],n)}updatePaintArray(t,i,n,r,o,s,a){this._setPaintValues(t,i,n.patterns&&n.patterns[this.layerId],s)}_setPaintValues(t,i,n,r){if(!r||!n)return;const o=r[n];if(!o)return;const{tl:s,br:a,pixelRatio:l}=o;for(let c=t;c<i;c++)this.paintVertexArray.emplace(c,s[0],s[1],a[0],a[1],l)}upload(t){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer=t.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class Ia{constructor(t,i,n=()=>!0){this.binders={},this._buffers=[];const r=[];for(const o in t.paint._values){const s=t.paint.get(o);if(!n(o)||!(s instanceof _l&&Ta(s.property.specification)))continue;const a=uE(o,t.type),l=s.value,c=s.property.specification.type,u=!!s.property.useIntegerZoom,h=o==="line-dasharray"||o.endsWith("pattern"),d=o==="line-dasharray"&&t.layout.get("line-cap").value.kind!=="constant";if(l.kind!=="constant"||d)if(l.kind==="source"||d||h){const p=ay(o,c,"source");this.binders[o]=h?new Bs(l,a,c,p,t.id):new rs(l,a,c,p),r.push(`/a_${o}`)}else{const p=ay(o,c,"composite");this.binders[o]=new ro(l,a,c,u,i,p),r.push(`/z_${o}`)}else this.binders[o]=h?new yl(l.value,a):new zc(l.value,a,c),r.push(`/u_${o}`)}this.cacheKey=r.sort().join("")}getMaxValue(t){const i=this.binders[t];return i instanceof rs||i instanceof ro?i.maxValue:0}populatePaintArrays(t,i,n,r,o,s,a){for(const l in this.binders){const c=this.binders[l];(c instanceof rs||c instanceof ro||c instanceof Bs)&&c.populatePaintArray(t,i,n,r,o,s,a)}}setConstantPatternPositions(t){for(const i in this.binders){const n=this.binders[i];n instanceof yl&&n.setConstantPatternPositions(t)}}updatePaintArrays(t,i,n,r,o,s,a,l){let c=!1;const u=Object.keys(t),h=u.length!==0,d=h?u:i.uniqueIds;for(const p in this.binders){const _=this.binders[p];if((_ instanceof rs||_ instanceof ro||_ instanceof Bs)&&(_.expression.isStateDependent===!0||_.expression.isLightConstant===!1)){const g=o.paint.get(p);_.expression=g.value;for(const y of d){const x=t[y.toString()];i.eachPosition(y,(b,M,E)=>{const T=r.feature(b);_.updatePaintArray(M,E,T,x,s,a,l)})}if(!h)for(const y of n.uniqueIds){const x=t[y.toString()];n.eachPosition(y,(b,M,E)=>{const T=r.feature(b);_.updatePaintArray(M,E,T,x,s,a,l)})}c=!0}}return c}defines(){const t=[];for(const i in this.binders){const n=this.binders[i];(n instanceof zc||n instanceof yl)&&t.push(...n.uniformNames.map(r=>`#define HAS_UNIFORM_${r}`))}return t}getBinderAttributes(){const t=[];for(const i in this.binders){const n=this.binders[i];if(n instanceof rs||n instanceof ro||n instanceof Bs)for(let r=0;r<n.paintVertexAttributes.length;r++)t.push(n.paintVertexAttributes[r].name)}return t}getBinderUniforms(){const t=[];for(const i in this.binders){const n=this.binders[i];if(n instanceof zc||n instanceof yl||n instanceof ro)for(const r of n.uniformNames)t.push(r)}return t}getPaintVertexBuffers(){return this._buffers}getUniforms(t){const i=[];for(const n in this.binders){const r=this.binders[n];if(r instanceof zc||r instanceof yl||r instanceof ro)for(const o of r.uniformNames)i.push({name:o,property:n,binding:r.getBinding(t,o)})}return i}setUniforms(t,i,n,r,o){for(const{name:s,property:a,binding:l}of n)this.binders[a].setUniform(t,l,o,r.get(a),s)}updatePaintBuffers(){this._buffers=[];for(const t in this.binders){const i=this.binders[t];(i instanceof rs||i instanceof ro||i instanceof Bs)&&i.paintVertexBuffer&&this._buffers.push(i.paintVertexBuffer)}}upload(t){for(const i in this.binders){const n=this.binders[i];(n instanceof rs||n instanceof ro||n instanceof Bs)&&n.upload(t)}this.updatePaintBuffers()}destroy(){for(const t in this.binders){const i=this.binders[t];(i instanceof rs||i instanceof ro||i instanceof Bs)&&i.destroy()}}}class Fs{constructor(t,i,n=()=>!0){this.programConfigurations={};for(const r of t)this.programConfigurations[r.id]=new Ia(r,i,n);this.needsUpload=!1,this._featureMap=new kc,this._featureMapWithoutIds=new kc,this._bufferOffset=0,this._idlessCounter=0}populatePaintArrays(t,i,n,r,o,s,a,l){for(const c in this.programConfigurations)this.programConfigurations[c].populatePaintArrays(t,i,r,o,s,a,l);i.id!==void 0?this._featureMap.add(i.id,n,this._bufferOffset,t):(this._featureMapWithoutIds.add(this._idlessCounter,n,this._bufferOffset,t),this._idlessCounter+=1),this._bufferOffset=t,this.needsUpload=!0}updatePaintArrays(t,i,n,r,o,s){for(const a of n)this.needsUpload=this.programConfigurations[a.id].updatePaintArrays(t,this._featureMap,this._featureMapWithoutIds,i,a,r,o,s||0)||this.needsUpload}get(t){return this.programConfigurations[t]}upload(t){if(this.needsUpload){for(const i in this.programConfigurations)this.programConfigurations[i].upload(t);this.needsUpload=!1}}destroy(){for(const t in this.programConfigurations)this.programConfigurations[t].destroy()}}const cE={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-emissive-strength":["emissive_strength"],"icon-emissive-strength":["emissive_strength"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"line-gap-width":["gapwidth"],"line-pattern":["pattern","pixel_ratio"],"fill-pattern":["pattern","pixel_ratio"],"fill-extrusion-pattern":["pattern","pixel_ratio"],"line-dasharray":["dash"]};function uE(e,t){return cE[e]||[e.replace(`${t}-`,"").replace(/-/g,"_")]}const hE={"line-pattern":{source:Rs,composite:Rs},"fill-pattern":{source:Rs,composite:Rs},"fill-extrusion-pattern":{source:Rs,composite:Rs},"line-dasharray":{source:eh,composite:eh}},dE={color:{source:Pc,composite:is},number:{source:Cc,composite:Pc}};function ay(e,t,i){const n=hE[e];return n&&n[i]||dE[t][i]}he(zc,"ConstantBinder"),he(yl,"PatternConstantBinder"),he(rs,"SourceExpressionBinder"),he(Bs,"PatternCompositeBinder"),he(ro,"CompositeExpressionBinder"),he(Ia,"ProgramConfiguration",{omit:["_buffers"]}),he(Fs,"ProgramConfigurationSet");class Er{constructor(t,i){t&&(i?this.setSouthWest(t).setNorthEast(i):t.length===4?this.setSouthWest([t[0],t[1]]).setNorthEast([t[2],t[3]]):this.setSouthWest(t[0]).setNorthEast(t[1]))}setNorthEast(t){return this._ne=t instanceof Le?new Le(t.lng,t.lat):Le.convert(t),this}setSouthWest(t){return this._sw=t instanceof Le?new Le(t.lng,t.lat):Le.convert(t),this}extend(t){const i=this._sw,n=this._ne;let r,o;if(t instanceof Le)r=t,o=t;else{if(!(t instanceof Er))return Array.isArray(t)?t.length===4||t.every(Array.isArray)?this.extend(Er.convert(t)):this.extend(Le.convert(t)):typeof t=="object"&&t!==null&&t.hasOwnProperty("lat")&&(t.hasOwnProperty("lon")||t.hasOwnProperty("lng"))?this.extend(Le.convert(t)):this;if(r=t._sw,o=t._ne,!r||!o)return this}return i||n?(i.lng=Math.min(r.lng,i.lng),i.lat=Math.min(r.lat,i.lat),n.lng=Math.max(o.lng,n.lng),n.lat=Math.max(o.lat,n.lat)):(this._sw=new Le(r.lng,r.lat),this._ne=new Le(o.lng,o.lat)),this}getCenter(){return new Le((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new Le(this.getWest(),this.getNorth())}getSouthEast(){return new Le(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(t){const{lng:i,lat:n}=Le.convert(t);let r=this._sw.lng<=i&&i<=this._ne.lng;return this._sw.lng>this._ne.lng&&(r=this._sw.lng>=i&&i>=this._ne.lng),this._sw.lat<=n&&n<=this._ne.lat&&r}static convert(t){return!t||t instanceof Er?t:new Er(t)}}var Zn={},Hn={};Object.defineProperty(Hn,"__esModule",{value:!0}),Hn.setMatrixArrayType=function(e){Hn.ARRAY_TYPE=cy=e},Hn.toRadian=function(e){return e*pE},Hn.equals=function(e,t){return Math.abs(e-t)<=ly*Math.max(1,Math.abs(e),Math.abs(t))},Hn.RANDOM=Hn.ARRAY_TYPE=Hn.EPSILON=void 0;var ly=1e-6;Hn.EPSILON=ly;var cy=typeof Float32Array<"u"?Float32Array:Array;Hn.ARRAY_TYPE=cy;var fE=Math.random;Hn.RANDOM=fE;var pE=Math.PI/180;Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)});var pn={};function Op(e){return Op=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Op(e)}Object.defineProperty(pn,"__esModule",{value:!0}),pn.create=function(){var e=new Ns.ARRAY_TYPE(4);return Ns.ARRAY_TYPE!=Float32Array&&(e[1]=0,e[2]=0),e[0]=1,e[3]=1,e},pn.clone=function(e){var t=new Ns.ARRAY_TYPE(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},pn.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},pn.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e},pn.fromValues=function(e,t,i,n){var r=new Ns.ARRAY_TYPE(4);return r[0]=e,r[1]=t,r[2]=i,r[3]=n,r},pn.set=function(e,t,i,n,r){return e[0]=t,e[1]=i,e[2]=n,e[3]=r,e},pn.transpose=function(e,t){if(e===t){var i=t[1];e[1]=t[2],e[2]=i}else e[0]=t[0],e[1]=t[2],e[2]=t[1],e[3]=t[3];return e},pn.invert=function(e,t){var i=t[0],n=t[1],r=t[2],o=t[3],s=i*o-r*n;return s?(e[0]=o*(s=1/s),e[1]=-n*s,e[2]=-r*s,e[3]=i*s,e):null},pn.adjoint=function(e,t){var i=t[0];return e[0]=t[3],e[1]=-t[1],e[2]=-t[2],e[3]=i,e},pn.determinant=function(e){return e[0]*e[3]-e[2]*e[1]},pn.multiply=hy,pn.rotate=function(e,t,i){var n=t[0],r=t[1],o=t[2],s=t[3],a=Math.sin(i),l=Math.cos(i);return e[0]=n*l+o*a,e[1]=r*l+s*a,e[2]=n*-a+o*l,e[3]=r*-a+s*l,e},pn.scale=function(e,t,i){var n=t[1],r=t[2],o=t[3],s=i[0],a=i[1];return e[0]=t[0]*s,e[1]=n*s,e[2]=r*a,e[3]=o*a,e},pn.fromRotation=function(e,t){var i=Math.sin(t),n=Math.cos(t);return e[0]=n,e[1]=i,e[2]=-i,e[3]=n,e},pn.fromScaling=function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=t[1],e},pn.str=function(e){return"mat2("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},pn.frob=function(e){return Math.hypot(e[0],e[1],e[2],e[3])},pn.LDU=function(e,t,i,n){return e[2]=n[2]/n[0],i[0]=n[0],i[1]=n[1],i[3]=n[3]-e[2]*i[1],[e,t,i]},pn.add=function(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e[3]=t[3]+i[3],e},pn.subtract=dy,pn.exactEquals=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]},pn.equals=function(e,t){var i=e[0],n=e[1],r=e[2],o=e[3],s=t[0],a=t[1],l=t[2],c=t[3];return Math.abs(i-s)<=Ns.EPSILON*Math.max(1,Math.abs(i),Math.abs(s))&&Math.abs(n-a)<=Ns.EPSILON*Math.max(1,Math.abs(n),Math.abs(a))&&Math.abs(r-l)<=Ns.EPSILON*Math.max(1,Math.abs(r),Math.abs(l))&&Math.abs(o-c)<=Ns.EPSILON*Math.max(1,Math.abs(o),Math.abs(c))},pn.multiplyScalar=function(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e},pn.multiplyScalarAndAdd=function(e,t,i,n){return e[0]=t[0]+i[0]*n,e[1]=t[1]+i[1]*n,e[2]=t[2]+i[2]*n,e[3]=t[3]+i[3]*n,e},pn.sub=pn.mul=void 0;var Ns=function(e,t){if(e&&e.__esModule)return e;if(e===null||Op(e)!=="object"&&typeof e!="function")return{default:e};var i=uy(void 0);if(i&&i.has(e))return i.get(e);var n={},r=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if(o!=="default"&&Object.prototype.hasOwnProperty.call(e,o)){var s=r?Object.getOwnPropertyDescriptor(e,o):null;s&&(s.get||s.set)?Object.defineProperty(n,o,s):n[o]=e[o]}return n.default=e,i&&i.set(e,n),n}(Hn);function uy(e){if(typeof WeakMap!="function")return null;var t=new WeakMap,i=new WeakMap;return(uy=function(n){return n?i:t})(e)}function hy(e,t,i){var n=t[0],r=t[1],o=t[2],s=t[3],a=i[0],l=i[1],c=i[2],u=i[3];return e[0]=n*a+o*l,e[1]=r*a+s*l,e[2]=n*c+o*u,e[3]=r*c+s*u,e}function dy(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e[3]=t[3]-i[3],e}pn.mul=hy,pn.sub=dy;var yn={};function Bp(e){return Bp=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Bp(e)}Object.defineProperty(yn,"__esModule",{value:!0}),yn.create=function(){var e=new Co.ARRAY_TYPE(6);return Co.ARRAY_TYPE!=Float32Array&&(e[1]=0,e[2]=0,e[4]=0,e[5]=0),e[0]=1,e[3]=1,e},yn.clone=function(e){var t=new Co.ARRAY_TYPE(6);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t},yn.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e},yn.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e[4]=0,e[5]=0,e},yn.fromValues=function(e,t,i,n,r,o){var s=new Co.ARRAY_TYPE(6);return s[0]=e,s[1]=t,s[2]=i,s[3]=n,s[4]=r,s[5]=o,s},yn.set=function(e,t,i,n,r,o,s){return e[0]=t,e[1]=i,e[2]=n,e[3]=r,e[4]=o,e[5]=s,e},yn.invert=function(e,t){var i=t[0],n=t[1],r=t[2],o=t[3],s=t[4],a=t[5],l=i*o-n*r;return l?(e[0]=o*(l=1/l),e[1]=-n*l,e[2]=-r*l,e[3]=i*l,e[4]=(r*a-o*s)*l,e[5]=(n*s-i*a)*l,e):null},yn.determinant=function(e){return e[0]*e[3]-e[1]*e[2]},yn.multiply=py,yn.rotate=function(e,t,i){var n=t[0],r=t[1],o=t[2],s=t[3],a=t[4],l=t[5],c=Math.sin(i),u=Math.cos(i);return e[0]=n*u+o*c,e[1]=r*u+s*c,e[2]=n*-c+o*u,e[3]=r*-c+s*u,e[4]=a,e[5]=l,e},yn.scale=function(e,t,i){var n=t[1],r=t[2],o=t[3],s=t[4],a=t[5],l=i[0],c=i[1];return e[0]=t[0]*l,e[1]=n*l,e[2]=r*c,e[3]=o*c,e[4]=s,e[5]=a,e},yn.translate=function(e,t,i){var n=t[0],r=t[1],o=t[2],s=t[3],a=t[4],l=t[5],c=i[0],u=i[1];return e[0]=n,e[1]=r,e[2]=o,e[3]=s,e[4]=n*c+o*u+a,e[5]=r*c+s*u+l,e},yn.fromRotation=function(e,t){var i=Math.sin(t),n=Math.cos(t);return e[0]=n,e[1]=i,e[2]=-i,e[3]=n,e[4]=0,e[5]=0,e},yn.fromScaling=function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=t[1],e[4]=0,e[5]=0,e},yn.fromTranslation=function(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e[4]=t[0],e[5]=t[1],e},yn.str=function(e){return"mat2d("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+")"},yn.frob=function(e){return Math.hypot(e[0],e[1],e[2],e[3],e[4],e[5],1)},yn.add=function(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e[3]=t[3]+i[3],e[4]=t[4]+i[4],e[5]=t[5]+i[5],e},yn.subtract=my,yn.multiplyScalar=function(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e[4]=t[4]*i,e[5]=t[5]*i,e},yn.multiplyScalarAndAdd=function(e,t,i,n){return e[0]=t[0]+i[0]*n,e[1]=t[1]+i[1]*n,e[2]=t[2]+i[2]*n,e[3]=t[3]+i[3]*n,e[4]=t[4]+i[4]*n,e[5]=t[5]+i[5]*n,e},yn.exactEquals=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]},yn.equals=function(e,t){var i=e[0],n=e[1],r=e[2],o=e[3],s=e[4],a=e[5],l=t[0],c=t[1],u=t[2],h=t[3],d=t[4],p=t[5];return Math.abs(i-l)<=Co.EPSILON*Math.max(1,Math.abs(i),Math.abs(l))&&Math.abs(n-c)<=Co.EPSILON*Math.max(1,Math.abs(n),Math.abs(c))&&Math.abs(r-u)<=Co.EPSILON*Math.max(1,Math.abs(r),Math.abs(u))&&Math.abs(o-h)<=Co.EPSILON*Math.max(1,Math.abs(o),Math.abs(h))&&Math.abs(s-d)<=Co.EPSILON*Math.max(1,Math.abs(s),Math.abs(d))&&Math.abs(a-p)<=Co.EPSILON*Math.max(1,Math.abs(a),Math.abs(p))},yn.sub=yn.mul=void 0;var Co=function(e,t){if(e&&e.__esModule)return e;if(e===null||Bp(e)!=="object"&&typeof e!="function")return{default:e};var i=fy(void 0);if(i&&i.has(e))return i.get(e);var n={},r=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if(o!=="default"&&Object.prototype.hasOwnProperty.call(e,o)){var s=r?Object.getOwnPropertyDescriptor(e,o):null;s&&(s.get||s.set)?Object.defineProperty(n,o,s):n[o]=e[o]}return n.default=e,i&&i.set(e,n),n}(Hn);function fy(e){if(typeof WeakMap!="function")return null;var t=new WeakMap,i=new WeakMap;return(fy=function(n){return n?i:t})(e)}function py(e,t,i){var n=t[0],r=t[1],o=t[2],s=t[3],a=t[4],l=t[5],c=i[0],u=i[1],h=i[2],d=i[3],p=i[4],_=i[5];return e[0]=n*c+o*u,e[1]=r*c+s*u,e[2]=n*h+o*d,e[3]=r*h+s*d,e[4]=n*p+o*_+a,e[5]=r*p+s*_+l,e}function my(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e[3]=t[3]-i[3],e[4]=t[4]-i[4],e[5]=t[5]-i[5],e}yn.mul=py,yn.sub=my;var Yi={};function Fp(e){return Fp=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Fp(e)}Object.defineProperty(Yi,"__esModule",{value:!0}),Yi.create=function(){var e=new Or.ARRAY_TYPE(9);return Or.ARRAY_TYPE!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[5]=0,e[6]=0,e[7]=0),e[0]=1,e[4]=1,e[8]=1,e},Yi.fromMat4=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10],e},Yi.clone=function(e){var t=new Or.ARRAY_TYPE(9);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},Yi.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},Yi.fromValues=function(e,t,i,n,r,o,s,a,l){var c=new Or.ARRAY_TYPE(9);return c[0]=e,c[1]=t,c[2]=i,c[3]=n,c[4]=r,c[5]=o,c[6]=s,c[7]=a,c[8]=l,c},Yi.set=function(e,t,i,n,r,o,s,a,l,c){return e[0]=t,e[1]=i,e[2]=n,e[3]=r,e[4]=o,e[5]=s,e[6]=a,e[7]=l,e[8]=c,e},Yi.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},Yi.transpose=function(e,t){if(e===t){var i=t[1],n=t[2],r=t[5];e[1]=t[3],e[2]=t[6],e[3]=i,e[5]=t[7],e[6]=n,e[7]=r}else e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8];return e},Yi.invert=function(e,t){var i=t[0],n=t[1],r=t[2],o=t[3],s=t[4],a=t[5],l=t[6],c=t[7],u=t[8],h=u*s-a*c,d=-u*o+a*l,p=c*o-s*l,_=i*h+n*d+r*p;return _?(e[0]=h*(_=1/_),e[1]=(-u*n+r*c)*_,e[2]=(a*n-r*s)*_,e[3]=d*_,e[4]=(u*i-r*l)*_,e[5]=(-a*i+r*o)*_,e[6]=p*_,e[7]=(-c*i+n*l)*_,e[8]=(s*i-n*o)*_,e):null},Yi.adjoint=function(e,t){var i=t[0],n=t[1],r=t[2],o=t[3],s=t[4],a=t[5],l=t[6],c=t[7],u=t[8];return e[0]=s*u-a*c,e[1]=r*c-n*u,e[2]=n*a-r*s,e[3]=a*l-o*u,e[4]=i*u-r*l,e[5]=r*o-i*a,e[6]=o*c-s*l,e[7]=n*l-i*c,e[8]=i*s-n*o,e},Yi.determinant=function(e){var t=e[3],i=e[4],n=e[5],r=e[6],o=e[7],s=e[8];return e[0]*(s*i-n*o)+e[1]*(-s*t+n*r)+e[2]*(o*t-i*r)},Yi.multiply=gy,Yi.translate=function(e,t,i){var n=t[0],r=t[1],o=t[2],s=t[3],a=t[4],l=t[5],c=t[6],u=t[7],h=t[8],d=i[0],p=i[1];return e[0]=n,e[1]=r,e[2]=o,e[3]=s,e[4]=a,e[5]=l,e[6]=d*n+p*s+c,e[7]=d*r+p*a+u,e[8]=d*o+p*l+h,e},Yi.rotate=function(e,t,i){var n=t[0],r=t[1],o=t[2],s=t[3],a=t[4],l=t[5],c=t[6],u=t[7],h=t[8],d=Math.sin(i),p=Math.cos(i);return e[0]=p*n+d*s,e[1]=p*r+d*a,e[2]=p*o+d*l,e[3]=p*s-d*n,e[4]=p*a-d*r,e[5]=p*l-d*o,e[6]=c,e[7]=u,e[8]=h,e},Yi.scale=function(e,t,i){var n=i[0],r=i[1];return e[0]=n*t[0],e[1]=n*t[1],e[2]=n*t[2],e[3]=r*t[3],e[4]=r*t[4],e[5]=r*t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},Yi.fromTranslation=function(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=t[0],e[7]=t[1],e[8]=1,e},Yi.fromRotation=function(e,t){var i=Math.sin(t),n=Math.cos(t);return e[0]=n,e[1]=i,e[2]=0,e[3]=-i,e[4]=n,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},Yi.fromScaling=function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=t[1],e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},Yi.fromMat2d=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=0,e[3]=t[2],e[4]=t[3],e[5]=0,e[6]=t[4],e[7]=t[5],e[8]=1,e},Yi.fromQuat=function(e,t){var i=t[0],n=t[1],r=t[2],o=t[3],s=i+i,a=n+n,l=r+r,c=i*s,u=n*s,h=n*a,d=r*s,p=r*a,_=r*l,g=o*s,y=o*a,x=o*l;return e[0]=1-h-_,e[3]=u-x,e[6]=d+y,e[1]=u+x,e[4]=1-c-_,e[7]=p-g,e[2]=d-y,e[5]=p+g,e[8]=1-c-h,e},Yi.normalFromMat4=function(e,t){var i=t[0],n=t[1],r=t[2],o=t[3],s=t[4],a=t[5],l=t[6],c=t[7],u=t[8],h=t[9],d=t[10],p=t[11],_=t[12],g=t[13],y=t[14],x=t[15],b=i*a-n*s,M=i*l-r*s,E=i*c-o*s,T=n*l-r*a,S=n*c-o*a,D=r*c-o*l,z=u*g-h*_,L=u*y-d*_,R=u*x-p*_,N=h*y-d*g,U=h*x-p*g,H=d*x-p*y,O=b*H-M*U+E*N+T*R-S*L+D*z;return O?(e[0]=(a*H-l*U+c*N)*(O=1/O),e[1]=(l*R-s*H-c*L)*O,e[2]=(s*U-a*R+c*z)*O,e[3]=(r*U-n*H-o*N)*O,e[4]=(i*H-r*R+o*L)*O,e[5]=(n*R-i*U-o*z)*O,e[6]=(g*D-y*S+x*T)*O,e[7]=(y*E-_*D-x*M)*O,e[8]=(_*S-g*E+x*b)*O,e):null},Yi.projection=function(e,t,i){return e[0]=2/t,e[1]=0,e[2]=0,e[3]=0,e[4]=-2/i,e[5]=0,e[6]=-1,e[7]=1,e[8]=1,e},Yi.str=function(e){return"mat3("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+")"},Yi.frob=function(e){return Math.hypot(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8])},Yi.add=function(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e[3]=t[3]+i[3],e[4]=t[4]+i[4],e[5]=t[5]+i[5],e[6]=t[6]+i[6],e[7]=t[7]+i[7],e[8]=t[8]+i[8],e},Yi.subtract=yy,Yi.multiplyScalar=function(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e[4]=t[4]*i,e[5]=t[5]*i,e[6]=t[6]*i,e[7]=t[7]*i,e[8]=t[8]*i,e},Yi.multiplyScalarAndAdd=function(e,t,i,n){return e[0]=t[0]+i[0]*n,e[1]=t[1]+i[1]*n,e[2]=t[2]+i[2]*n,e[3]=t[3]+i[3]*n,e[4]=t[4]+i[4]*n,e[5]=t[5]+i[5]*n,e[6]=t[6]+i[6]*n,e[7]=t[7]+i[7]*n,e[8]=t[8]+i[8]*n,e},Yi.exactEquals=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]},Yi.equals=function(e,t){var i=e[0],n=e[1],r=e[2],o=e[3],s=e[4],a=e[5],l=e[6],c=e[7],u=e[8],h=t[0],d=t[1],p=t[2],_=t[3],g=t[4],y=t[5],x=t[6],b=t[7],M=t[8];return Math.abs(i-h)<=Or.EPSILON*Math.max(1,Math.abs(i),Math.abs(h))&&Math.abs(n-d)<=Or.EPSILON*Math.max(1,Math.abs(n),Math.abs(d))&&Math.abs(r-p)<=Or.EPSILON*Math.max(1,Math.abs(r),Math.abs(p))&&Math.abs(o-_)<=Or.EPSILON*Math.max(1,Math.abs(o),Math.abs(_))&&Math.abs(s-g)<=Or.EPSILON*Math.max(1,Math.abs(s),Math.abs(g))&&Math.abs(a-y)<=Or.EPSILON*Math.max(1,Math.abs(a),Math.abs(y))&&Math.abs(l-x)<=Or.EPSILON*Math.max(1,Math.abs(l),Math.abs(x))&&Math.abs(c-b)<=Or.EPSILON*Math.max(1,Math.abs(c),Math.abs(b))&&Math.abs(u-M)<=Or.EPSILON*Math.max(1,Math.abs(u),Math.abs(M))},Yi.sub=Yi.mul=void 0;var Or=function(e,t){if(e&&e.__esModule)return e;if(e===null||Fp(e)!=="object"&&typeof e!="function")return{default:e};var i=_y(void 0);if(i&&i.has(e))return i.get(e);var n={},r=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if(o!=="default"&&Object.prototype.hasOwnProperty.call(e,o)){var s=r?Object.getOwnPropertyDescriptor(e,o):null;s&&(s.get||s.set)?Object.defineProperty(n,o,s):n[o]=e[o]}return n.default=e,i&&i.set(e,n),n}(Hn);function _y(e){if(typeof WeakMap!="function")return null;var t=new WeakMap,i=new WeakMap;return(_y=function(n){return n?i:t})(e)}function gy(e,t,i){var n=t[0],r=t[1],o=t[2],s=t[3],a=t[4],l=t[5],c=t[6],u=t[7],h=t[8],d=i[0],p=i[1],_=i[2],g=i[3],y=i[4],x=i[5],b=i[6],M=i[7],E=i[8];return e[0]=d*n+p*s+_*c,e[1]=d*r+p*a+_*u,e[2]=d*o+p*l+_*h,e[3]=g*n+y*s+x*c,e[4]=g*r+y*a+x*u,e[5]=g*o+y*l+x*h,e[6]=b*n+M*s+E*c,e[7]=b*r+M*a+E*u,e[8]=b*o+M*l+E*h,e}function yy(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e[3]=t[3]-i[3],e[4]=t[4]-i[4],e[5]=t[5]-i[5],e[6]=t[6]-i[6],e[7]=t[7]-i[7],e[8]=t[8]-i[8],e}Yi.mul=gy,Yi.sub=yy;var He={};function Np(e){return Np=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Np(e)}Object.defineProperty(He,"__esModule",{value:!0}),He.create=function(){var e=new En.ARRAY_TYPE(16);return En.ARRAY_TYPE!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e},He.clone=function(e){var t=new En.ARRAY_TYPE(16);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},He.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},He.fromValues=function(e,t,i,n,r,o,s,a,l,c,u,h,d,p,_,g){var y=new En.ARRAY_TYPE(16);return y[0]=e,y[1]=t,y[2]=i,y[3]=n,y[4]=r,y[5]=o,y[6]=s,y[7]=a,y[8]=l,y[9]=c,y[10]=u,y[11]=h,y[12]=d,y[13]=p,y[14]=_,y[15]=g,y},He.set=function(e,t,i,n,r,o,s,a,l,c,u,h,d,p,_,g,y){return e[0]=t,e[1]=i,e[2]=n,e[3]=r,e[4]=o,e[5]=s,e[6]=a,e[7]=l,e[8]=c,e[9]=u,e[10]=h,e[11]=d,e[12]=p,e[13]=_,e[14]=g,e[15]=y,e},He.identity=xy,He.transpose=function(e,t){if(e===t){var i=t[1],n=t[2],r=t[3],o=t[6],s=t[7],a=t[11];e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=i,e[6]=t[9],e[7]=t[13],e[8]=n,e[9]=o,e[11]=t[14],e[12]=r,e[13]=s,e[14]=a}else e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15];return e},He.invert=function(e,t){var i=t[0],n=t[1],r=t[2],o=t[3],s=t[4],a=t[5],l=t[6],c=t[7],u=t[8],h=t[9],d=t[10],p=t[11],_=t[12],g=t[13],y=t[14],x=t[15],b=i*a-n*s,M=i*l-r*s,E=i*c-o*s,T=n*l-r*a,S=n*c-o*a,D=r*c-o*l,z=u*g-h*_,L=u*y-d*_,R=u*x-p*_,N=h*y-d*g,U=h*x-p*g,H=d*x-p*y,O=b*H-M*U+E*N+T*R-S*L+D*z;return O?(e[0]=(a*H-l*U+c*N)*(O=1/O),e[1]=(r*U-n*H-o*N)*O,e[2]=(g*D-y*S+x*T)*O,e[3]=(d*S-h*D-p*T)*O,e[4]=(l*R-s*H-c*L)*O,e[5]=(i*H-r*R+o*L)*O,e[6]=(y*E-_*D-x*M)*O,e[7]=(u*D-d*E+p*M)*O,e[8]=(s*U-a*R+c*z)*O,e[9]=(n*R-i*U-o*z)*O,e[10]=(_*S-g*E+x*b)*O,e[11]=(h*E-u*S-p*b)*O,e[12]=(a*L-s*N-l*z)*O,e[13]=(i*N-n*L+r*z)*O,e[14]=(g*M-_*T-y*b)*O,e[15]=(u*T-h*M+d*b)*O,e):null},He.adjoint=function(e,t){var i=t[0],n=t[1],r=t[2],o=t[3],s=t[4],a=t[5],l=t[6],c=t[7],u=t[8],h=t[9],d=t[10],p=t[11],_=t[12],g=t[13],y=t[14],x=t[15];return e[0]=a*(d*x-p*y)-h*(l*x-c*y)+g*(l*p-c*d),e[1]=-(n*(d*x-p*y)-h*(r*x-o*y)+g*(r*p-o*d)),e[2]=n*(l*x-c*y)-a*(r*x-o*y)+g*(r*c-o*l),e[3]=-(n*(l*p-c*d)-a*(r*p-o*d)+h*(r*c-o*l)),e[4]=-(s*(d*x-p*y)-u*(l*x-c*y)+_*(l*p-c*d)),e[5]=i*(d*x-p*y)-u*(r*x-o*y)+_*(r*p-o*d),e[6]=-(i*(l*x-c*y)-s*(r*x-o*y)+_*(r*c-o*l)),e[7]=i*(l*p-c*d)-s*(r*p-o*d)+u*(r*c-o*l),e[8]=s*(h*x-p*g)-u*(a*x-c*g)+_*(a*p-c*h),e[9]=-(i*(h*x-p*g)-u*(n*x-o*g)+_*(n*p-o*h)),e[10]=i*(a*x-c*g)-s*(n*x-o*g)+_*(n*c-o*a),e[11]=-(i*(a*p-c*h)-s*(n*p-o*h)+u*(n*c-o*a)),e[12]=-(s*(h*y-d*g)-u*(a*y-l*g)+_*(a*d-l*h)),e[13]=i*(h*y-d*g)-u*(n*y-r*g)+_*(n*d-r*h),e[14]=-(i*(a*y-l*g)-s*(n*y-r*g)+_*(n*l-r*a)),e[15]=i*(a*d-l*h)-s*(n*d-r*h)+u*(n*l-r*a),e},He.determinant=function(e){var t=e[0],i=e[1],n=e[2],r=e[3],o=e[4],s=e[5],a=e[6],l=e[7],c=e[8],u=e[9],h=e[10],d=e[11],p=e[12],_=e[13],g=e[14],y=e[15];return(t*s-i*o)*(h*y-d*g)-(t*a-n*o)*(u*y-d*_)+(t*l-r*o)*(u*g-h*_)+(i*a-n*s)*(c*y-d*p)-(i*l-r*s)*(c*g-h*p)+(n*l-r*a)*(c*_-u*p)},He.multiply=by,He.translate=function(e,t,i){var n,r,o,s,a,l,c,u,h,d,p,_,g=i[0],y=i[1],x=i[2];return t===e?(e[12]=t[0]*g+t[4]*y+t[8]*x+t[12],e[13]=t[1]*g+t[5]*y+t[9]*x+t[13],e[14]=t[2]*g+t[6]*y+t[10]*x+t[14],e[15]=t[3]*g+t[7]*y+t[11]*x+t[15]):(r=t[1],o=t[2],s=t[3],a=t[4],l=t[5],c=t[6],u=t[7],h=t[8],d=t[9],p=t[10],_=t[11],e[0]=n=t[0],e[1]=r,e[2]=o,e[3]=s,e[4]=a,e[5]=l,e[6]=c,e[7]=u,e[8]=h,e[9]=d,e[10]=p,e[11]=_,e[12]=n*g+a*y+h*x+t[12],e[13]=r*g+l*y+d*x+t[13],e[14]=o*g+c*y+p*x+t[14],e[15]=s*g+u*y+_*x+t[15]),e},He.scale=function(e,t,i){var n=i[0],r=i[1],o=i[2];return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e[4]=t[4]*r,e[5]=t[5]*r,e[6]=t[6]*r,e[7]=t[7]*r,e[8]=t[8]*o,e[9]=t[9]*o,e[10]=t[10]*o,e[11]=t[11]*o,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},He.rotate=function(e,t,i,n){var r,o,s,a,l,c,u,h,d,p,_,g,y,x,b,M,E,T,S,D,z,L,R,N,U=n[0],H=n[1],O=n[2],X=Math.hypot(U,H,O);return X<En.EPSILON?null:(U*=X=1/X,H*=X,O*=X,r=Math.sin(i),o=Math.cos(i),l=t[1],c=t[2],u=t[3],d=t[5],p=t[6],_=t[7],y=t[9],x=t[10],b=t[11],S=U*H*(s=1-o)-O*r,D=H*H*s+o,z=O*H*s+U*r,L=U*O*s+H*r,R=H*O*s-U*r,N=O*O*s+o,e[0]=(a=t[0])*(M=U*U*s+o)+(h=t[4])*(E=H*U*s+O*r)+(g=t[8])*(T=O*U*s-H*r),e[1]=l*M+d*E+y*T,e[2]=c*M+p*E+x*T,e[3]=u*M+_*E+b*T,e[4]=a*S+h*D+g*z,e[5]=l*S+d*D+y*z,e[6]=c*S+p*D+x*z,e[7]=u*S+_*D+b*z,e[8]=a*L+h*R+g*N,e[9]=l*L+d*R+y*N,e[10]=c*L+p*R+x*N,e[11]=u*L+_*R+b*N,t!==e&&(e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e)},He.rotateX=function(e,t,i){var n=Math.sin(i),r=Math.cos(i),o=t[4],s=t[5],a=t[6],l=t[7],c=t[8],u=t[9],h=t[10],d=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=o*r+c*n,e[5]=s*r+u*n,e[6]=a*r+h*n,e[7]=l*r+d*n,e[8]=c*r-o*n,e[9]=u*r-s*n,e[10]=h*r-a*n,e[11]=d*r-l*n,e},He.rotateY=function(e,t,i){var n=Math.sin(i),r=Math.cos(i),o=t[0],s=t[1],a=t[2],l=t[3],c=t[8],u=t[9],h=t[10],d=t[11];return t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=o*r-c*n,e[1]=s*r-u*n,e[2]=a*r-h*n,e[3]=l*r-d*n,e[8]=o*n+c*r,e[9]=s*n+u*r,e[10]=a*n+h*r,e[11]=l*n+d*r,e},He.rotateZ=function(e,t,i){var n=Math.sin(i),r=Math.cos(i),o=t[0],s=t[1],a=t[2],l=t[3],c=t[4],u=t[5],h=t[6],d=t[7];return t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=o*r+c*n,e[1]=s*r+u*n,e[2]=a*r+h*n,e[3]=l*r+d*n,e[4]=c*r-o*n,e[5]=u*r-s*n,e[6]=h*r-a*n,e[7]=d*r-l*n,e},He.fromTranslation=function(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1,e},He.fromScaling=function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t[1],e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},He.fromRotation=function(e,t,i){var n,r,o,s=i[0],a=i[1],l=i[2],c=Math.hypot(s,a,l);return c<En.EPSILON?null:(s*=c=1/c,a*=c,l*=c,n=Math.sin(t),r=Math.cos(t),e[0]=s*s*(o=1-r)+r,e[1]=a*s*o+l*n,e[2]=l*s*o-a*n,e[3]=0,e[4]=s*a*o-l*n,e[5]=a*a*o+r,e[6]=l*a*o+s*n,e[7]=0,e[8]=s*l*o+a*n,e[9]=a*l*o-s*n,e[10]=l*l*o+r,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e)},He.fromXRotation=function(e,t){var i=Math.sin(t),n=Math.cos(t);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=n,e[6]=i,e[7]=0,e[8]=0,e[9]=-i,e[10]=n,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},He.fromYRotation=function(e,t){var i=Math.sin(t),n=Math.cos(t);return e[0]=n,e[1]=0,e[2]=-i,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=i,e[9]=0,e[10]=n,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},He.fromZRotation=function(e,t){var i=Math.sin(t),n=Math.cos(t);return e[0]=n,e[1]=i,e[2]=0,e[3]=0,e[4]=-i,e[5]=n,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},He.fromRotationTranslation=wy,He.fromQuat2=function(e,t){var i=new En.ARRAY_TYPE(3),n=-t[0],r=-t[1],o=-t[2],s=t[3],a=t[4],l=t[5],c=t[6],u=t[7],h=n*n+r*r+o*o+s*s;return h>0?(i[0]=2*(a*s+u*n+l*o-c*r)/h,i[1]=2*(l*s+u*r+c*n-a*o)/h,i[2]=2*(c*s+u*o+a*r-l*n)/h):(i[0]=2*(a*s+u*n+l*o-c*r),i[1]=2*(l*s+u*r+c*n-a*o),i[2]=2*(c*s+u*o+a*r-l*n)),wy(e,t,i),e},He.getTranslation=function(e,t){return e[0]=t[12],e[1]=t[13],e[2]=t[14],e},He.getScaling=Ty,He.getRotation=function(e,t){var i=new En.ARRAY_TYPE(3);Ty(i,t);var n=1/i[0],r=1/i[1],o=1/i[2],s=t[0]*n,a=t[1]*r,l=t[2]*o,c=t[4]*n,u=t[5]*r,h=t[6]*o,d=t[8]*n,p=t[9]*r,_=t[10]*o,g=s+u+_,y=0;return g>0?(y=2*Math.sqrt(g+1),e[3]=.25*y,e[0]=(h-p)/y,e[1]=(d-l)/y,e[2]=(a-c)/y):s>u&&s>_?(y=2*Math.sqrt(1+s-u-_),e[3]=(h-p)/y,e[0]=.25*y,e[1]=(a+c)/y,e[2]=(d+l)/y):u>_?(y=2*Math.sqrt(1+u-s-_),e[3]=(d-l)/y,e[0]=(a+c)/y,e[1]=.25*y,e[2]=(h+p)/y):(y=2*Math.sqrt(1+_-s-u),e[3]=(a-c)/y,e[0]=(d+l)/y,e[1]=(h+p)/y,e[2]=.25*y),e},He.fromRotationTranslationScale=function(e,t,i,n){var r=t[0],o=t[1],s=t[2],a=t[3],l=r+r,c=o+o,u=s+s,h=r*l,d=r*c,p=r*u,_=o*c,g=o*u,y=s*u,x=a*l,b=a*c,M=a*u,E=n[0],T=n[1],S=n[2];return e[0]=(1-(_+y))*E,e[1]=(d+M)*E,e[2]=(p-b)*E,e[3]=0,e[4]=(d-M)*T,e[5]=(1-(h+y))*T,e[6]=(g+x)*T,e[7]=0,e[8]=(p+b)*S,e[9]=(g-x)*S,e[10]=(1-(h+_))*S,e[11]=0,e[12]=i[0],e[13]=i[1],e[14]=i[2],e[15]=1,e},He.fromRotationTranslationScaleOrigin=function(e,t,i,n,r){var o=t[0],s=t[1],a=t[2],l=t[3],c=o+o,u=s+s,h=a+a,d=o*c,p=o*u,_=o*h,g=s*u,y=s*h,x=a*h,b=l*c,M=l*u,E=l*h,T=n[0],S=n[1],D=n[2],z=r[0],L=r[1],R=r[2],N=(1-(g+x))*T,U=(p+E)*T,H=(_-M)*T,O=(p-E)*S,X=(1-(d+x))*S,K=(y+b)*S,ot=(_+M)*D,$=(y-b)*D,Y=(1-(d+g))*D;return e[0]=N,e[1]=U,e[2]=H,e[3]=0,e[4]=O,e[5]=X,e[6]=K,e[7]=0,e[8]=ot,e[9]=$,e[10]=Y,e[11]=0,e[12]=i[0]+z-(N*z+O*L+ot*R),e[13]=i[1]+L-(U*z+X*L+$*R),e[14]=i[2]+R-(H*z+K*L+Y*R),e[15]=1,e},He.fromQuat=function(e,t){var i=t[0],n=t[1],r=t[2],o=t[3],s=i+i,a=n+n,l=r+r,c=i*s,u=n*s,h=n*a,d=r*s,p=r*a,_=r*l,g=o*s,y=o*a,x=o*l;return e[0]=1-h-_,e[1]=u+x,e[2]=d-y,e[3]=0,e[4]=u-x,e[5]=1-c-_,e[6]=p+g,e[7]=0,e[8]=d+y,e[9]=p-g,e[10]=1-c-h,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},He.frustum=function(e,t,i,n,r,o,s){var a=1/(i-t),l=1/(r-n),c=1/(o-s);return e[0]=2*o*a,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=2*o*l,e[6]=0,e[7]=0,e[8]=(i+t)*a,e[9]=(r+n)*l,e[10]=(s+o)*c,e[11]=-1,e[12]=0,e[13]=0,e[14]=s*o*2*c,e[15]=0,e},He.perspectiveNO=My,He.perspectiveZO=function(e,t,i,n,r){var o,s=1/Math.tan(t/2);return e[0]=s/i,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=s,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,r!=null&&r!==1/0?(e[10]=r*(o=1/(n-r)),e[14]=r*n*o):(e[10]=-1,e[14]=-n),e},He.perspectiveFromFieldOfView=function(e,t,i,n){var r=Math.tan(t.upDegrees*Math.PI/180),o=Math.tan(t.downDegrees*Math.PI/180),s=Math.tan(t.leftDegrees*Math.PI/180),a=Math.tan(t.rightDegrees*Math.PI/180),l=2/(s+a),c=2/(r+o);return e[0]=l,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=c,e[6]=0,e[7]=0,e[8]=-(s-a)*l*.5,e[9]=(r-o)*c*.5,e[10]=n/(i-n),e[11]=-1,e[12]=0,e[13]=0,e[14]=n*i/(i-n),e[15]=0,e},He.orthoNO=Ey,He.orthoZO=function(e,t,i,n,r,o,s){var a=1/(t-i),l=1/(n-r),c=1/(o-s);return e[0]=-2*a,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*l,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=c,e[11]=0,e[12]=(t+i)*a,e[13]=(r+n)*l,e[14]=o*c,e[15]=1,e},He.lookAt=function(e,t,i,n){var r,o,s,a,l,c,u,h,d,p,_=t[0],g=t[1],y=t[2],x=n[0],b=n[1],M=n[2],E=i[0],T=i[1],S=i[2];return Math.abs(_-E)<En.EPSILON&&Math.abs(g-T)<En.EPSILON&&Math.abs(y-S)<En.EPSILON?xy(e):(u=_-E,h=g-T,d=y-S,r=b*(d*=p=1/Math.hypot(u,h,d))-M*(h*=p),o=M*(u*=p)-x*d,s=x*h-b*u,(p=Math.hypot(r,o,s))?(r*=p=1/p,o*=p,s*=p):(r=0,o=0,s=0),a=h*s-d*o,l=d*r-u*s,c=u*o-h*r,(p=Math.hypot(a,l,c))?(a*=p=1/p,l*=p,c*=p):(a=0,l=0,c=0),e[0]=r,e[1]=a,e[2]=u,e[3]=0,e[4]=o,e[5]=l,e[6]=h,e[7]=0,e[8]=s,e[9]=c,e[10]=d,e[11]=0,e[12]=-(r*_+o*g+s*y),e[13]=-(a*_+l*g+c*y),e[14]=-(u*_+h*g+d*y),e[15]=1,e)},He.targetTo=function(e,t,i,n){var r=t[0],o=t[1],s=t[2],a=n[0],l=n[1],c=n[2],u=r-i[0],h=o-i[1],d=s-i[2],p=u*u+h*h+d*d;p>0&&(u*=p=1/Math.sqrt(p),h*=p,d*=p);var _=l*d-c*h,g=c*u-a*d,y=a*h-l*u;return(p=_*_+g*g+y*y)>0&&(_*=p=1/Math.sqrt(p),g*=p,y*=p),e[0]=_,e[1]=g,e[2]=y,e[3]=0,e[4]=h*y-d*g,e[5]=d*_-u*y,e[6]=u*g-h*_,e[7]=0,e[8]=u,e[9]=h,e[10]=d,e[11]=0,e[12]=r,e[13]=o,e[14]=s,e[15]=1,e},He.str=function(e){return"mat4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+", "+e[9]+", "+e[10]+", "+e[11]+", "+e[12]+", "+e[13]+", "+e[14]+", "+e[15]+")"},He.frob=function(e){return Math.hypot(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15])},He.add=function(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e[3]=t[3]+i[3],e[4]=t[4]+i[4],e[5]=t[5]+i[5],e[6]=t[6]+i[6],e[7]=t[7]+i[7],e[8]=t[8]+i[8],e[9]=t[9]+i[9],e[10]=t[10]+i[10],e[11]=t[11]+i[11],e[12]=t[12]+i[12],e[13]=t[13]+i[13],e[14]=t[14]+i[14],e[15]=t[15]+i[15],e},He.subtract=Sy,He.multiplyScalar=function(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e[4]=t[4]*i,e[5]=t[5]*i,e[6]=t[6]*i,e[7]=t[7]*i,e[8]=t[8]*i,e[9]=t[9]*i,e[10]=t[10]*i,e[11]=t[11]*i,e[12]=t[12]*i,e[13]=t[13]*i,e[14]=t[14]*i,e[15]=t[15]*i,e},He.multiplyScalarAndAdd=function(e,t,i,n){return e[0]=t[0]+i[0]*n,e[1]=t[1]+i[1]*n,e[2]=t[2]+i[2]*n,e[3]=t[3]+i[3]*n,e[4]=t[4]+i[4]*n,e[5]=t[5]+i[5]*n,e[6]=t[6]+i[6]*n,e[7]=t[7]+i[7]*n,e[8]=t[8]+i[8]*n,e[9]=t[9]+i[9]*n,e[10]=t[10]+i[10]*n,e[11]=t[11]+i[11]*n,e[12]=t[12]+i[12]*n,e[13]=t[13]+i[13]*n,e[14]=t[14]+i[14]*n,e[15]=t[15]+i[15]*n,e},He.exactEquals=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]&&e[9]===t[9]&&e[10]===t[10]&&e[11]===t[11]&&e[12]===t[12]&&e[13]===t[13]&&e[14]===t[14]&&e[15]===t[15]},He.equals=function(e,t){var i=e[0],n=e[1],r=e[2],o=e[3],s=e[4],a=e[5],l=e[6],c=e[7],u=e[8],h=e[9],d=e[10],p=e[11],_=e[12],g=e[13],y=e[14],x=e[15],b=t[0],M=t[1],E=t[2],T=t[3],S=t[4],D=t[5],z=t[6],L=t[7],R=t[8],N=t[9],U=t[10],H=t[11],O=t[12],X=t[13],K=t[14],ot=t[15];return Math.abs(i-b)<=En.EPSILON*Math.max(1,Math.abs(i),Math.abs(b))&&Math.abs(n-M)<=En.EPSILON*Math.max(1,Math.abs(n),Math.abs(M))&&Math.abs(r-E)<=En.EPSILON*Math.max(1,Math.abs(r),Math.abs(E))&&Math.abs(o-T)<=En.EPSILON*Math.max(1,Math.abs(o),Math.abs(T))&&Math.abs(s-S)<=En.EPSILON*Math.max(1,Math.abs(s),Math.abs(S))&&Math.abs(a-D)<=En.EPSILON*Math.max(1,Math.abs(a),Math.abs(D))&&Math.abs(l-z)<=En.EPSILON*Math.max(1,Math.abs(l),Math.abs(z))&&Math.abs(c-L)<=En.EPSILON*Math.max(1,Math.abs(c),Math.abs(L))&&Math.abs(u-R)<=En.EPSILON*Math.max(1,Math.abs(u),Math.abs(R))&&Math.abs(h-N)<=En.EPSILON*Math.max(1,Math.abs(h),Math.abs(N))&&Math.abs(d-U)<=En.EPSILON*Math.max(1,Math.abs(d),Math.abs(U))&&Math.abs(p-H)<=En.EPSILON*Math.max(1,Math.abs(p),Math.abs(H))&&Math.abs(_-O)<=En.EPSILON*Math.max(1,Math.abs(_),Math.abs(O))&&Math.abs(g-X)<=En.EPSILON*Math.max(1,Math.abs(g),Math.abs(X))&&Math.abs(y-K)<=En.EPSILON*Math.max(1,Math.abs(y),Math.abs(K))&&Math.abs(x-ot)<=En.EPSILON*Math.max(1,Math.abs(x),Math.abs(ot))},He.sub=He.mul=He.ortho=He.perspective=void 0;var En=function(e,t){if(e&&e.__esModule)return e;if(e===null||Np(e)!=="object"&&typeof e!="function")return{default:e};var i=vy(void 0);if(i&&i.has(e))return i.get(e);var n={},r=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if(o!=="default"&&Object.prototype.hasOwnProperty.call(e,o)){var s=r?Object.getOwnPropertyDescriptor(e,o):null;s&&(s.get||s.set)?Object.defineProperty(n,o,s):n[o]=e[o]}return n.default=e,i&&i.set(e,n),n}(Hn);function vy(e){if(typeof WeakMap!="function")return null;var t=new WeakMap,i=new WeakMap;return(vy=function(n){return n?i:t})(e)}function xy(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function by(e,t,i){var n=t[0],r=t[1],o=t[2],s=t[3],a=t[4],l=t[5],c=t[6],u=t[7],h=t[8],d=t[9],p=t[10],_=t[11],g=t[12],y=t[13],x=t[14],b=t[15],M=i[0],E=i[1],T=i[2],S=i[3];return e[0]=M*n+E*a+T*h+S*g,e[1]=M*r+E*l+T*d+S*y,e[2]=M*o+E*c+T*p+S*x,e[3]=M*s+E*u+T*_+S*b,e[4]=(M=i[4])*n+(E=i[5])*a+(T=i[6])*h+(S=i[7])*g,e[5]=M*r+E*l+T*d+S*y,e[6]=M*o+E*c+T*p+S*x,e[7]=M*s+E*u+T*_+S*b,e[8]=(M=i[8])*n+(E=i[9])*a+(T=i[10])*h+(S=i[11])*g,e[9]=M*r+E*l+T*d+S*y,e[10]=M*o+E*c+T*p+S*x,e[11]=M*s+E*u+T*_+S*b,e[12]=(M=i[12])*n+(E=i[13])*a+(T=i[14])*h+(S=i[15])*g,e[13]=M*r+E*l+T*d+S*y,e[14]=M*o+E*c+T*p+S*x,e[15]=M*s+E*u+T*_+S*b,e}function wy(e,t,i){var n=t[0],r=t[1],o=t[2],s=t[3],a=n+n,l=r+r,c=o+o,u=n*a,h=n*l,d=n*c,p=r*l,_=r*c,g=o*c,y=s*a,x=s*l,b=s*c;return e[0]=1-(p+g),e[1]=h+b,e[2]=d-x,e[3]=0,e[4]=h-b,e[5]=1-(u+g),e[6]=_+y,e[7]=0,e[8]=d+x,e[9]=_-y,e[10]=1-(u+p),e[11]=0,e[12]=i[0],e[13]=i[1],e[14]=i[2],e[15]=1,e}function Ty(e,t){var i=t[4],n=t[5],r=t[6],o=t[8],s=t[9],a=t[10];return e[0]=Math.hypot(t[0],t[1],t[2]),e[1]=Math.hypot(i,n,r),e[2]=Math.hypot(o,s,a),e}function My(e,t,i,n,r){var o,s=1/Math.tan(t/2);return e[0]=s/i,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=s,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,r!=null&&r!==1/0?(e[10]=(r+n)*(o=1/(n-r)),e[14]=2*r*n*o):(e[10]=-1,e[14]=-2*n),e}function Ey(e,t,i,n,r,o,s){var a=1/(t-i),l=1/(n-r),c=1/(o-s);return e[0]=-2*a,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*l,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*c,e[11]=0,e[12]=(t+i)*a,e[13]=(r+n)*l,e[14]=(s+o)*c,e[15]=1,e}function Sy(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e[3]=t[3]-i[3],e[4]=t[4]-i[4],e[5]=t[5]-i[5],e[6]=t[6]-i[6],e[7]=t[7]-i[7],e[8]=t[8]-i[8],e[9]=t[9]-i[9],e[10]=t[10]-i[10],e[11]=t[11]-i[11],e[12]=t[12]-i[12],e[13]=t[13]-i[13],e[14]=t[14]-i[14],e[15]=t[15]-i[15],e}He.perspective=My,He.ortho=Ey,He.mul=by,He.sub=Sy;var Ue={},Ge={};function Up(e){return Up=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Up(e)}Object.defineProperty(Ge,"__esModule",{value:!0}),Ge.create=Iy,Ge.clone=function(e){var t=new os.ARRAY_TYPE(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},Ge.length=Cy,Ge.fromValues=function(e,t,i){var n=new os.ARRAY_TYPE(3);return n[0]=e,n[1]=t,n[2]=i,n},Ge.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e},Ge.set=function(e,t,i,n){return e[0]=t,e[1]=i,e[2]=n,e},Ge.add=function(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e},Ge.subtract=Dy,Ge.multiply=Py,Ge.divide=ky,Ge.ceil=function(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e},Ge.floor=function(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e},Ge.min=function(e,t,i){return e[0]=Math.min(t[0],i[0]),e[1]=Math.min(t[1],i[1]),e[2]=Math.min(t[2],i[2]),e},Ge.max=function(e,t,i){return e[0]=Math.max(t[0],i[0]),e[1]=Math.max(t[1],i[1]),e[2]=Math.max(t[2],i[2]),e},Ge.round=function(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e[2]=Math.round(t[2]),e},Ge.scale=function(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e},Ge.scaleAndAdd=function(e,t,i,n){return e[0]=t[0]+i[0]*n,e[1]=t[1]+i[1]*n,e[2]=t[2]+i[2]*n,e},Ge.distance=zy,Ge.squaredDistance=Ly,Ge.squaredLength=Ry,Ge.negate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e},Ge.inverse=function(e,t){return e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e},Ge.normalize=function(e,t){var i=t[0],n=t[1],r=t[2],o=i*i+n*n+r*r;return o>0&&(o=1/Math.sqrt(o)),e[0]=t[0]*o,e[1]=t[1]*o,e[2]=t[2]*o,e},Ge.dot=Oy,Ge.cross=function(e,t,i){var n=t[0],r=t[1],o=t[2],s=i[0],a=i[1],l=i[2];return e[0]=r*l-o*a,e[1]=o*s-n*l,e[2]=n*a-r*s,e},Ge.lerp=function(e,t,i,n){var r=t[0],o=t[1],s=t[2];return e[0]=r+n*(i[0]-r),e[1]=o+n*(i[1]-o),e[2]=s+n*(i[2]-s),e},Ge.hermite=function(e,t,i,n,r,o){var s=o*o,a=s*(2*o-3)+1,l=s*(o-2)+o,c=s*(o-1),u=s*(3-2*o);return e[0]=t[0]*a+i[0]*l+n[0]*c+r[0]*u,e[1]=t[1]*a+i[1]*l+n[1]*c+r[1]*u,e[2]=t[2]*a+i[2]*l+n[2]*c+r[2]*u,e},Ge.bezier=function(e,t,i,n,r,o){var s=1-o,a=s*s,l=o*o,c=a*s,u=3*o*a,h=3*l*s,d=l*o;return e[0]=t[0]*c+i[0]*u+n[0]*h+r[0]*d,e[1]=t[1]*c+i[1]*u+n[1]*h+r[1]*d,e[2]=t[2]*c+i[2]*u+n[2]*h+r[2]*d,e},Ge.random=function(e,t){t=t||1;var i=2*os.RANDOM()*Math.PI,n=2*os.RANDOM()-1,r=Math.sqrt(1-n*n)*t;return e[0]=Math.cos(i)*r,e[1]=Math.sin(i)*r,e[2]=n*t,e},Ge.transformMat4=function(e,t,i){var n=t[0],r=t[1],o=t[2],s=i[3]*n+i[7]*r+i[11]*o+i[15];return e[0]=(i[0]*n+i[4]*r+i[8]*o+i[12])/(s=s||1),e[1]=(i[1]*n+i[5]*r+i[9]*o+i[13])/s,e[2]=(i[2]*n+i[6]*r+i[10]*o+i[14])/s,e},Ge.transformMat3=function(e,t,i){var n=t[0],r=t[1],o=t[2];return e[0]=n*i[0]+r*i[3]+o*i[6],e[1]=n*i[1]+r*i[4]+o*i[7],e[2]=n*i[2]+r*i[5]+o*i[8],e},Ge.transformQuat=function(e,t,i){var n=i[0],r=i[1],o=i[2],s=t[0],a=t[1],l=t[2],c=r*l-o*a,u=o*s-n*l,h=n*a-r*s,d=r*h-o*u,p=o*c-n*h,_=n*u-r*c,g=2*i[3];return u*=g,h*=g,p*=2,_*=2,e[0]=s+(c*=g)+(d*=2),e[1]=a+u+p,e[2]=l+h+_,e},Ge.rotateX=function(e,t,i,n){var r=[],o=[];return r[0]=t[0]-i[0],r[1]=t[1]-i[1],r[2]=t[2]-i[2],o[0]=r[0],o[1]=r[1]*Math.cos(n)-r[2]*Math.sin(n),o[2]=r[1]*Math.sin(n)+r[2]*Math.cos(n),e[0]=o[0]+i[0],e[1]=o[1]+i[1],e[2]=o[2]+i[2],e},Ge.rotateY=function(e,t,i,n){var r=[],o=[];return r[0]=t[0]-i[0],r[1]=t[1]-i[1],r[2]=t[2]-i[2],o[0]=r[2]*Math.sin(n)+r[0]*Math.cos(n),o[1]=r[1],o[2]=r[2]*Math.cos(n)-r[0]*Math.sin(n),e[0]=o[0]+i[0],e[1]=o[1]+i[1],e[2]=o[2]+i[2],e},Ge.rotateZ=function(e,t,i,n){var r=[],o=[];return r[0]=t[0]-i[0],r[1]=t[1]-i[1],r[2]=t[2]-i[2],o[0]=r[0]*Math.cos(n)-r[1]*Math.sin(n),o[1]=r[0]*Math.sin(n)+r[1]*Math.cos(n),o[2]=r[2],e[0]=o[0]+i[0],e[1]=o[1]+i[1],e[2]=o[2]+i[2],e},Ge.angle=function(e,t){var i=e[0],n=e[1],r=e[2],o=t[0],s=t[1],a=t[2],l=Math.sqrt(i*i+n*n+r*r)*Math.sqrt(o*o+s*s+a*a),c=l&&Oy(e,t)/l;return Math.acos(Math.min(Math.max(c,-1),1))},Ge.zero=function(e){return e[0]=0,e[1]=0,e[2]=0,e},Ge.str=function(e){return"vec3("+e[0]+", "+e[1]+", "+e[2]+")"},Ge.exactEquals=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]},Ge.equals=function(e,t){var i=e[0],n=e[1],r=e[2],o=t[0],s=t[1],a=t[2];return Math.abs(i-o)<=os.EPSILON*Math.max(1,Math.abs(i),Math.abs(o))&&Math.abs(n-s)<=os.EPSILON*Math.max(1,Math.abs(n),Math.abs(s))&&Math.abs(r-a)<=os.EPSILON*Math.max(1,Math.abs(r),Math.abs(a))},Ge.forEach=Ge.sqrLen=Ge.len=Ge.sqrDist=Ge.dist=Ge.div=Ge.mul=Ge.sub=void 0;var os=function(e,t){if(e&&e.__esModule)return e;if(e===null||Up(e)!=="object"&&typeof e!="function")return{default:e};var i=Ay(void 0);if(i&&i.has(e))return i.get(e);var n={},r=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if(o!=="default"&&Object.prototype.hasOwnProperty.call(e,o)){var s=r?Object.getOwnPropertyDescriptor(e,o):null;s&&(s.get||s.set)?Object.defineProperty(n,o,s):n[o]=e[o]}return n.default=e,i&&i.set(e,n),n}(Hn);function Ay(e){if(typeof WeakMap!="function")return null;var t=new WeakMap,i=new WeakMap;return(Ay=function(n){return n?i:t})(e)}function Iy(){var e=new os.ARRAY_TYPE(3);return os.ARRAY_TYPE!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function Cy(e){return Math.hypot(e[0],e[1],e[2])}function Dy(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e}function Py(e,t,i){return e[0]=t[0]*i[0],e[1]=t[1]*i[1],e[2]=t[2]*i[2],e}function ky(e,t,i){return e[0]=t[0]/i[0],e[1]=t[1]/i[1],e[2]=t[2]/i[2],e}function zy(e,t){return Math.hypot(t[0]-e[0],t[1]-e[1],t[2]-e[2])}function Ly(e,t){var i=t[0]-e[0],n=t[1]-e[1],r=t[2]-e[2];return i*i+n*n+r*r}function Ry(e){var t=e[0],i=e[1],n=e[2];return t*t+i*i+n*n}function Oy(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}Ge.sub=Dy,Ge.mul=Py,Ge.div=ky,Ge.dist=zy,Ge.sqrDist=Ly,Ge.len=Cy,Ge.sqrLen=Ry;var ss,mE=(ss=Iy(),function(e,t,i,n,r,o){var s,a;for(t||(t=3),i||(i=0),a=n?Math.min(n*t+i,e.length):e.length,s=i;s<a;s+=t)ss[0]=e[s],ss[1]=e[s+1],ss[2]=e[s+2],r(ss,ss,o),e[s]=ss[0],e[s+1]=ss[1],e[s+2]=ss[2];return e});Ge.forEach=mE;var oi={};function Vp(e){return Vp=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Vp(e)}Object.defineProperty(oi,"__esModule",{value:!0}),oi.create=Fy,oi.clone=function(e){var t=new Xr.ARRAY_TYPE(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},oi.fromValues=function(e,t,i,n){var r=new Xr.ARRAY_TYPE(4);return r[0]=e,r[1]=t,r[2]=i,r[3]=n,r},oi.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},oi.set=function(e,t,i,n,r){return e[0]=t,e[1]=i,e[2]=n,e[3]=r,e},oi.add=function(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e[3]=t[3]+i[3],e},oi.subtract=Ny,oi.multiply=Uy,oi.divide=Vy,oi.ceil=function(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e[3]=Math.ceil(t[3]),e},oi.floor=function(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e[3]=Math.floor(t[3]),e},oi.min=function(e,t,i){return e[0]=Math.min(t[0],i[0]),e[1]=Math.min(t[1],i[1]),e[2]=Math.min(t[2],i[2]),e[3]=Math.min(t[3],i[3]),e},oi.max=function(e,t,i){return e[0]=Math.max(t[0],i[0]),e[1]=Math.max(t[1],i[1]),e[2]=Math.max(t[2],i[2]),e[3]=Math.max(t[3],i[3]),e},oi.round=function(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e[2]=Math.round(t[2]),e[3]=Math.round(t[3]),e},oi.scale=function(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e},oi.scaleAndAdd=function(e,t,i,n){return e[0]=t[0]+i[0]*n,e[1]=t[1]+i[1]*n,e[2]=t[2]+i[2]*n,e[3]=t[3]+i[3]*n,e},oi.distance=jy,oi.squaredDistance=Gy,oi.length=qy,oi.squaredLength=Zy,oi.negate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e},oi.inverse=function(e,t){return e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e[3]=1/t[3],e},oi.normalize=function(e,t){var i=t[0],n=t[1],r=t[2],o=t[3],s=i*i+n*n+r*r+o*o;return s>0&&(s=1/Math.sqrt(s)),e[0]=i*s,e[1]=n*s,e[2]=r*s,e[3]=o*s,e},oi.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]},oi.cross=function(e,t,i,n){var r=i[0]*n[1]-i[1]*n[0],o=i[0]*n[2]-i[2]*n[0],s=i[0]*n[3]-i[3]*n[0],a=i[1]*n[2]-i[2]*n[1],l=i[1]*n[3]-i[3]*n[1],c=i[2]*n[3]-i[3]*n[2],u=t[0],h=t[1],d=t[2],p=t[3];return e[0]=h*c-d*l+p*a,e[1]=-u*c+d*s-p*o,e[2]=u*l-h*s+p*r,e[3]=-u*a+h*o-d*r,e},oi.lerp=function(e,t,i,n){var r=t[0],o=t[1],s=t[2],a=t[3];return e[0]=r+n*(i[0]-r),e[1]=o+n*(i[1]-o),e[2]=s+n*(i[2]-s),e[3]=a+n*(i[3]-a),e},oi.random=function(e,t){var i,n,r,o,s,a;t=t||1;do s=(i=2*Xr.RANDOM()-1)*i+(n=2*Xr.RANDOM()-1)*n;while(s>=1);do a=(r=2*Xr.RANDOM()-1)*r+(o=2*Xr.RANDOM()-1)*o;while(a>=1);var l=Math.sqrt((1-s)/a);return e[0]=t*i,e[1]=t*n,e[2]=t*r*l,e[3]=t*o*l,e},oi.transformMat4=function(e,t,i){var n=t[0],r=t[1],o=t[2],s=t[3];return e[0]=i[0]*n+i[4]*r+i[8]*o+i[12]*s,e[1]=i[1]*n+i[5]*r+i[9]*o+i[13]*s,e[2]=i[2]*n+i[6]*r+i[10]*o+i[14]*s,e[3]=i[3]*n+i[7]*r+i[11]*o+i[15]*s,e},oi.transformQuat=function(e,t,i){var n=t[0],r=t[1],o=t[2],s=i[0],a=i[1],l=i[2],c=i[3],u=c*n+a*o-l*r,h=c*r+l*n-s*o,d=c*o+s*r-a*n,p=-s*n-a*r-l*o;return e[0]=u*c+p*-s+h*-l-d*-a,e[1]=h*c+p*-a+d*-s-u*-l,e[2]=d*c+p*-l+u*-a-h*-s,e[3]=t[3],e},oi.zero=function(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=0,e},oi.str=function(e){return"vec4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},oi.exactEquals=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]},oi.equals=function(e,t){var i=e[0],n=e[1],r=e[2],o=e[3],s=t[0],a=t[1],l=t[2],c=t[3];return Math.abs(i-s)<=Xr.EPSILON*Math.max(1,Math.abs(i),Math.abs(s))&&Math.abs(n-a)<=Xr.EPSILON*Math.max(1,Math.abs(n),Math.abs(a))&&Math.abs(r-l)<=Xr.EPSILON*Math.max(1,Math.abs(r),Math.abs(l))&&Math.abs(o-c)<=Xr.EPSILON*Math.max(1,Math.abs(o),Math.abs(c))},oi.forEach=oi.sqrLen=oi.len=oi.sqrDist=oi.dist=oi.div=oi.mul=oi.sub=void 0;var Xr=function(e,t){if(e&&e.__esModule)return e;if(e===null||Vp(e)!=="object"&&typeof e!="function")return{default:e};var i=By(void 0);if(i&&i.has(e))return i.get(e);var n={},r=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if(o!=="default"&&Object.prototype.hasOwnProperty.call(e,o)){var s=r?Object.getOwnPropertyDescriptor(e,o):null;s&&(s.get||s.set)?Object.defineProperty(n,o,s):n[o]=e[o]}return n.default=e,i&&i.set(e,n),n}(Hn);function By(e){if(typeof WeakMap!="function")return null;var t=new WeakMap,i=new WeakMap;return(By=function(n){return n?i:t})(e)}function Fy(){var e=new Xr.ARRAY_TYPE(4);return Xr.ARRAY_TYPE!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}function Ny(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e[3]=t[3]-i[3],e}function Uy(e,t,i){return e[0]=t[0]*i[0],e[1]=t[1]*i[1],e[2]=t[2]*i[2],e[3]=t[3]*i[3],e}function Vy(e,t,i){return e[0]=t[0]/i[0],e[1]=t[1]/i[1],e[2]=t[2]/i[2],e[3]=t[3]/i[3],e}function jy(e,t){return Math.hypot(t[0]-e[0],t[1]-e[1],t[2]-e[2],t[3]-e[3])}function Gy(e,t){var i=t[0]-e[0],n=t[1]-e[1],r=t[2]-e[2],o=t[3]-e[3];return i*i+n*n+r*r+o*o}function qy(e){return Math.hypot(e[0],e[1],e[2],e[3])}function Zy(e){var t=e[0],i=e[1],n=e[2],r=e[3];return t*t+i*i+n*n+r*r}oi.sub=Ny,oi.mul=Uy,oi.div=Vy,oi.dist=jy,oi.sqrDist=Gy,oi.len=qy,oi.sqrLen=Zy;var _E=function(){var e=Fy();return function(t,i,n,r,o,s){var a,l;for(i||(i=4),n||(n=0),l=r?Math.min(r*i+n,t.length):t.length,a=n;a<l;a+=i)e[0]=t[a],e[1]=t[a+1],e[2]=t[a+2],e[3]=t[a+3],o(e,e,s),t[a]=e[0],t[a+1]=e[1],t[a+2]=e[2],t[a+3]=e[3];return t}}();function jp(e){return jp=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},jp(e)}oi.forEach=_E,Object.defineProperty(Ue,"__esModule",{value:!0}),Ue.create=Gp,Ue.identity=function(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e},Ue.setAxisAngle=Wy,Ue.getAxisAngle=function(e,t){var i=2*Math.acos(t[3]),n=Math.sin(i/2);return n>Ca.EPSILON?(e[0]=t[0]/n,e[1]=t[1]/n,e[2]=t[2]/n):(e[0]=1,e[1]=0,e[2]=0),i},Ue.getAngle=function(e,t){var i=Qy(e,t);return Math.acos(2*i*i-1)},Ue.multiply=$y,Ue.rotateX=function(e,t,i){i*=.5;var n=t[0],r=t[1],o=t[2],s=t[3],a=Math.sin(i),l=Math.cos(i);return e[0]=n*l+s*a,e[1]=r*l+o*a,e[2]=o*l-r*a,e[3]=s*l-n*a,e},Ue.rotateY=function(e,t,i){i*=.5;var n=t[0],r=t[1],o=t[2],s=t[3],a=Math.sin(i),l=Math.cos(i);return e[0]=n*l-o*a,e[1]=r*l+s*a,e[2]=o*l+n*a,e[3]=s*l-r*a,e},Ue.rotateZ=function(e,t,i){i*=.5;var n=t[0],r=t[1],o=t[2],s=t[3],a=Math.sin(i),l=Math.cos(i);return e[0]=n*l+r*a,e[1]=r*l-n*a,e[2]=o*l+s*a,e[3]=s*l-o*a,e},Ue.calculateW=function(e,t){var i=t[0],n=t[1],r=t[2];return e[0]=i,e[1]=n,e[2]=r,e[3]=Math.sqrt(Math.abs(1-i*i-n*n-r*r)),e},Ue.exp=Xy,Ue.ln=Yy,Ue.pow=function(e,t,i){return Yy(e,t),Jy(e,e,i),Xy(e,e),e},Ue.slerp=lh,Ue.random=function(e){var t=Ca.RANDOM(),i=Ca.RANDOM(),n=Ca.RANDOM(),r=Math.sqrt(1-t),o=Math.sqrt(t);return e[0]=r*Math.sin(2*Math.PI*i),e[1]=r*Math.cos(2*Math.PI*i),e[2]=o*Math.sin(2*Math.PI*n),e[3]=o*Math.cos(2*Math.PI*n),e},Ue.invert=function(e,t){var i=t[0],n=t[1],r=t[2],o=t[3],s=i*i+n*n+r*r+o*o,a=s?1/s:0;return e[0]=-i*a,e[1]=-n*a,e[2]=-r*a,e[3]=o*a,e},Ue.conjugate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e},Ue.fromMat3=Ky,Ue.fromEuler=function(e,t,i,n){var r=.5*Math.PI/180;t*=r,i*=r,n*=r;var o=Math.sin(t),s=Math.cos(t),a=Math.sin(i),l=Math.cos(i),c=Math.sin(n),u=Math.cos(n);return e[0]=o*l*u-s*a*c,e[1]=s*a*u+o*l*c,e[2]=s*l*c-o*a*u,e[3]=s*l*u+o*a*c,e},Ue.str=function(e){return"quat("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},Ue.setAxes=Ue.sqlerp=Ue.rotationTo=Ue.equals=Ue.exactEquals=Ue.normalize=Ue.sqrLen=Ue.squaredLength=Ue.len=Ue.length=Ue.lerp=Ue.dot=Ue.scale=Ue.mul=Ue.add=Ue.set=Ue.copy=Ue.fromValues=Ue.clone=void 0;var Ca=ah(Hn),gE=ah(Yi),as=ah(Ge),Br=ah(oi);function Hy(e){if(typeof WeakMap!="function")return null;var t=new WeakMap,i=new WeakMap;return(Hy=function(n){return n?i:t})(e)}function ah(e,t){if(!t&&e&&e.__esModule)return e;if(e===null||jp(e)!=="object"&&typeof e!="function")return{default:e};var i=Hy(t);if(i&&i.has(e))return i.get(e);var n={},r=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if(o!=="default"&&Object.prototype.hasOwnProperty.call(e,o)){var s=r?Object.getOwnPropertyDescriptor(e,o):null;s&&(s.get||s.set)?Object.defineProperty(n,o,s):n[o]=e[o]}return n.default=e,i&&i.set(e,n),n}function Gp(){var e=new Ca.ARRAY_TYPE(4);return Ca.ARRAY_TYPE!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}function Wy(e,t,i){i*=.5;var n=Math.sin(i);return e[0]=n*t[0],e[1]=n*t[1],e[2]=n*t[2],e[3]=Math.cos(i),e}function $y(e,t,i){var n=t[0],r=t[1],o=t[2],s=t[3],a=i[0],l=i[1],c=i[2],u=i[3];return e[0]=n*u+s*a+r*c-o*l,e[1]=r*u+s*l+o*a-n*c,e[2]=o*u+s*c+n*l-r*a,e[3]=s*u-n*a-r*l-o*c,e}function Xy(e,t){var i=t[0],n=t[1],r=t[2],o=t[3],s=Math.sqrt(i*i+n*n+r*r),a=Math.exp(o),l=s>0?a*Math.sin(s)/s:0;return e[0]=i*l,e[1]=n*l,e[2]=r*l,e[3]=a*Math.cos(s),e}function Yy(e,t){var i=t[0],n=t[1],r=t[2],o=t[3],s=Math.sqrt(i*i+n*n+r*r),a=s>0?Math.atan2(s,o)/s:0;return e[0]=i*a,e[1]=n*a,e[2]=r*a,e[3]=.5*Math.log(i*i+n*n+r*r+o*o),e}function lh(e,t,i,n){var r,o,s,a,l,c=t[0],u=t[1],h=t[2],d=t[3],p=i[0],_=i[1],g=i[2],y=i[3];return(o=c*p+u*_+h*g+d*y)<0&&(o=-o,p=-p,_=-_,g=-g,y=-y),1-o>Ca.EPSILON?(r=Math.acos(o),s=Math.sin(r),a=Math.sin((1-n)*r)/s,l=Math.sin(n*r)/s):(a=1-n,l=n),e[0]=a*c+l*p,e[1]=a*u+l*_,e[2]=a*h+l*g,e[3]=a*d+l*y,e}function Ky(e,t){var i,n=t[0]+t[4]+t[8];if(n>0)i=Math.sqrt(n+1),e[3]=.5*i,e[0]=(t[5]-t[7])*(i=.5/i),e[1]=(t[6]-t[2])*i,e[2]=(t[1]-t[3])*i;else{var r=0;t[4]>t[0]&&(r=1),t[8]>t[3*r+r]&&(r=2);var o=(r+1)%3,s=(r+2)%3;i=Math.sqrt(t[3*r+r]-t[3*o+o]-t[3*s+s]+1),e[r]=.5*i,e[3]=(t[3*o+s]-t[3*s+o])*(i=.5/i),e[o]=(t[3*o+r]+t[3*r+o])*i,e[s]=(t[3*s+r]+t[3*r+s])*i}return e}Ue.clone=Br.clone,Ue.fromValues=Br.fromValues,Ue.copy=Br.copy,Ue.set=Br.set,Ue.add=Br.add,Ue.mul=$y;var Jy=Br.scale;Ue.scale=Jy;var Qy=Br.dot;Ue.dot=Qy,Ue.lerp=Br.lerp;var t1=Br.length;Ue.length=t1,Ue.len=t1;var e1=Br.squaredLength;Ue.squaredLength=e1,Ue.sqrLen=e1;var qp=Br.normalize;Ue.normalize=qp,Ue.exactEquals=Br.exactEquals,Ue.equals=Br.equals;var oo,i1,n1,yE=(oo=as.create(),i1=as.fromValues(1,0,0),n1=as.fromValues(0,1,0),function(e,t,i){var n=as.dot(t,i);return n<-.999999?(as.cross(oo,i1,t),as.len(oo)<1e-6&&as.cross(oo,n1,t),as.normalize(oo,oo),Wy(e,oo,Math.PI),e):n>.999999?(e[0]=0,e[1]=0,e[2]=0,e[3]=1,e):(as.cross(oo,t,i),e[0]=oo[0],e[1]=oo[1],e[2]=oo[2],e[3]=1+n,qp(e,e))});Ue.rotationTo=yE;var Zp,Hp,vE=(Zp=Gp(),Hp=Gp(),function(e,t,i,n,r,o){return lh(Zp,t,r,o),lh(Hp,i,n,o),lh(e,Zp,Hp,2*o*(1-o)),e});Ue.sqlerp=vE;var so,xE=(so=gE.create(),function(e,t,i,n){return so[0]=i[0],so[3]=i[1],so[6]=i[2],so[1]=n[0],so[4]=n[1],so[7]=n[2],so[2]=-t[0],so[5]=-t[1],so[8]=-t[2],qp(e,Ky(e,so))});Ue.setAxes=xE;var fi={};function Wp(e){return Wp=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Wp(e)}Object.defineProperty(fi,"__esModule",{value:!0}),fi.create=function(){var e=new mr.ARRAY_TYPE(8);return mr.ARRAY_TYPE!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[4]=0,e[5]=0,e[6]=0,e[7]=0),e[3]=1,e},fi.clone=function(e){var t=new mr.ARRAY_TYPE(8);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t},fi.fromValues=function(e,t,i,n,r,o,s,a){var l=new mr.ARRAY_TYPE(8);return l[0]=e,l[1]=t,l[2]=i,l[3]=n,l[4]=r,l[5]=o,l[6]=s,l[7]=a,l},fi.fromRotationTranslationValues=function(e,t,i,n,r,o,s){var a=new mr.ARRAY_TYPE(8);a[0]=e,a[1]=t,a[2]=i,a[3]=n;var l=.5*r,c=.5*o,u=.5*s;return a[4]=l*n+c*i-u*t,a[5]=c*n+u*e-l*i,a[6]=u*n+l*t-c*e,a[7]=-l*e-c*t-u*i,a},fi.fromRotationTranslation=s1,fi.fromTranslation=function(e,t){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e[4]=.5*t[0],e[5]=.5*t[1],e[6]=.5*t[2],e[7]=0,e},fi.fromRotation=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=0,e[5]=0,e[6]=0,e[7]=0,e},fi.fromMat4=function(e,t){var i=ls.create();r1.getRotation(i,t);var n=new mr.ARRAY_TYPE(3);return r1.getTranslation(n,t),s1(e,i,n),e},fi.copy=a1,fi.identity=function(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e[4]=0,e[5]=0,e[6]=0,e[7]=0,e},fi.set=function(e,t,i,n,r,o,s,a,l){return e[0]=t,e[1]=i,e[2]=n,e[3]=r,e[4]=o,e[5]=s,e[6]=a,e[7]=l,e},fi.getDual=function(e,t){return e[0]=t[4],e[1]=t[5],e[2]=t[6],e[3]=t[7],e},fi.setDual=function(e,t){return e[4]=t[0],e[5]=t[1],e[6]=t[2],e[7]=t[3],e},fi.getTranslation=function(e,t){var i=t[4],n=t[5],r=t[6],o=t[7],s=-t[0],a=-t[1],l=-t[2],c=t[3];return e[0]=2*(i*c+o*s+n*l-r*a),e[1]=2*(n*c+o*a+r*s-i*l),e[2]=2*(r*c+o*l+i*a-n*s),e},fi.translate=function(e,t,i){var n=t[0],r=t[1],o=t[2],s=t[3],a=.5*i[0],l=.5*i[1],c=.5*i[2],u=t[4],h=t[5],d=t[6],p=t[7];return e[0]=n,e[1]=r,e[2]=o,e[3]=s,e[4]=s*a+r*c-o*l+u,e[5]=s*l+o*a-n*c+h,e[6]=s*c+n*l-r*a+d,e[7]=-n*a-r*l-o*c+p,e},fi.rotateX=function(e,t,i){var n=-t[0],r=-t[1],o=-t[2],s=t[3],a=t[4],l=t[5],c=t[6],u=t[7],h=a*s+u*n+l*o-c*r,d=l*s+u*r+c*n-a*o,p=c*s+u*o+a*r-l*n,_=u*s-a*n-l*r-c*o;return ls.rotateX(e,t,i),e[4]=h*(s=e[3])+_*(n=e[0])+d*(o=e[2])-p*(r=e[1]),e[5]=d*s+_*r+p*n-h*o,e[6]=p*s+_*o+h*r-d*n,e[7]=_*s-h*n-d*r-p*o,e},fi.rotateY=function(e,t,i){var n=-t[0],r=-t[1],o=-t[2],s=t[3],a=t[4],l=t[5],c=t[6],u=t[7],h=a*s+u*n+l*o-c*r,d=l*s+u*r+c*n-a*o,p=c*s+u*o+a*r-l*n,_=u*s-a*n-l*r-c*o;return ls.rotateY(e,t,i),e[4]=h*(s=e[3])+_*(n=e[0])+d*(o=e[2])-p*(r=e[1]),e[5]=d*s+_*r+p*n-h*o,e[6]=p*s+_*o+h*r-d*n,e[7]=_*s-h*n-d*r-p*o,e},fi.rotateZ=function(e,t,i){var n=-t[0],r=-t[1],o=-t[2],s=t[3],a=t[4],l=t[5],c=t[6],u=t[7],h=a*s+u*n+l*o-c*r,d=l*s+u*r+c*n-a*o,p=c*s+u*o+a*r-l*n,_=u*s-a*n-l*r-c*o;return ls.rotateZ(e,t,i),e[4]=h*(s=e[3])+_*(n=e[0])+d*(o=e[2])-p*(r=e[1]),e[5]=d*s+_*r+p*n-h*o,e[6]=p*s+_*o+h*r-d*n,e[7]=_*s-h*n-d*r-p*o,e},fi.rotateByQuatAppend=function(e,t,i){var n=i[0],r=i[1],o=i[2],s=i[3],a=t[0],l=t[1],c=t[2],u=t[3];return e[0]=a*s+u*n+l*o-c*r,e[1]=l*s+u*r+c*n-a*o,e[2]=c*s+u*o+a*r-l*n,e[3]=u*s-a*n-l*r-c*o,e[4]=(a=t[4])*s+(u=t[7])*n+(l=t[5])*o-(c=t[6])*r,e[5]=l*s+u*r+c*n-a*o,e[6]=c*s+u*o+a*r-l*n,e[7]=u*s-a*n-l*r-c*o,e},fi.rotateByQuatPrepend=function(e,t,i){var n=t[0],r=t[1],o=t[2],s=t[3],a=i[0],l=i[1],c=i[2],u=i[3];return e[0]=n*u+s*a+r*c-o*l,e[1]=r*u+s*l+o*a-n*c,e[2]=o*u+s*c+n*l-r*a,e[3]=s*u-n*a-r*l-o*c,e[4]=n*(u=i[7])+s*(a=i[4])+r*(c=i[6])-o*(l=i[5]),e[5]=r*u+s*l+o*a-n*c,e[6]=o*u+s*c+n*l-r*a,e[7]=s*u-n*a-r*l-o*c,e},fi.rotateAroundAxis=function(e,t,i,n){if(Math.abs(n)<mr.EPSILON)return a1(e,t);var r=Math.hypot(i[0],i[1],i[2]);n*=.5;var o=Math.sin(n),s=o*i[0]/r,a=o*i[1]/r,l=o*i[2]/r,c=Math.cos(n),u=t[0],h=t[1],d=t[2],p=t[3];e[0]=u*c+p*s+h*l-d*a,e[1]=h*c+p*a+d*s-u*l,e[2]=d*c+p*l+u*a-h*s,e[3]=p*c-u*s-h*a-d*l;var _=t[4],g=t[5],y=t[6],x=t[7];return e[4]=_*c+x*s+g*l-y*a,e[5]=g*c+x*a+y*s-_*l,e[6]=y*c+x*l+_*a-g*s,e[7]=x*c-_*s-g*a-y*l,e},fi.add=function(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e[3]=t[3]+i[3],e[4]=t[4]+i[4],e[5]=t[5]+i[5],e[6]=t[6]+i[6],e[7]=t[7]+i[7],e},fi.multiply=l1,fi.scale=function(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e[4]=t[4]*i,e[5]=t[5]*i,e[6]=t[6]*i,e[7]=t[7]*i,e},fi.lerp=function(e,t,i,n){var r=1-n;return c1(t,i)<0&&(n=-n),e[0]=t[0]*r+i[0]*n,e[1]=t[1]*r+i[1]*n,e[2]=t[2]*r+i[2]*n,e[3]=t[3]*r+i[3]*n,e[4]=t[4]*r+i[4]*n,e[5]=t[5]*r+i[5]*n,e[6]=t[6]*r+i[6]*n,e[7]=t[7]*r+i[7]*n,e},fi.invert=function(e,t){var i=ch(t);return e[0]=-t[0]/i,e[1]=-t[1]/i,e[2]=-t[2]/i,e[3]=t[3]/i,e[4]=-t[4]/i,e[5]=-t[5]/i,e[6]=-t[6]/i,e[7]=t[7]/i,e},fi.conjugate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e[4]=-t[4],e[5]=-t[5],e[6]=-t[6],e[7]=t[7],e},fi.normalize=function(e,t){var i=ch(t);if(i>0){i=Math.sqrt(i);var n=t[0]/i,r=t[1]/i,o=t[2]/i,s=t[3]/i,a=t[4],l=t[5],c=t[6],u=t[7],h=n*a+r*l+o*c+s*u;e[0]=n,e[1]=r,e[2]=o,e[3]=s,e[4]=(a-n*h)/i,e[5]=(l-r*h)/i,e[6]=(c-o*h)/i,e[7]=(u-s*h)/i}return e},fi.str=function(e){return"quat2("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+")"},fi.exactEquals=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]},fi.equals=function(e,t){var i=e[0],n=e[1],r=e[2],o=e[3],s=e[4],a=e[5],l=e[6],c=e[7],u=t[0],h=t[1],d=t[2],p=t[3],_=t[4],g=t[5],y=t[6],x=t[7];return Math.abs(i-u)<=mr.EPSILON*Math.max(1,Math.abs(i),Math.abs(u))&&Math.abs(n-h)<=mr.EPSILON*Math.max(1,Math.abs(n),Math.abs(h))&&Math.abs(r-d)<=mr.EPSILON*Math.max(1,Math.abs(r),Math.abs(d))&&Math.abs(o-p)<=mr.EPSILON*Math.max(1,Math.abs(o),Math.abs(p))&&Math.abs(s-_)<=mr.EPSILON*Math.max(1,Math.abs(s),Math.abs(_))&&Math.abs(a-g)<=mr.EPSILON*Math.max(1,Math.abs(a),Math.abs(g))&&Math.abs(l-y)<=mr.EPSILON*Math.max(1,Math.abs(l),Math.abs(y))&&Math.abs(c-x)<=mr.EPSILON*Math.max(1,Math.abs(c),Math.abs(x))},fi.sqrLen=fi.squaredLength=fi.len=fi.length=fi.dot=fi.mul=fi.setReal=fi.getReal=void 0;var mr=$p(Hn),ls=$p(Ue),r1=$p(He);function o1(e){if(typeof WeakMap!="function")return null;var t=new WeakMap,i=new WeakMap;return(o1=function(n){return n?i:t})(e)}function $p(e,t){if(!t&&e&&e.__esModule)return e;if(e===null||Wp(e)!=="object"&&typeof e!="function")return{default:e};var i=o1(t);if(i&&i.has(e))return i.get(e);var n={},r=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if(o!=="default"&&Object.prototype.hasOwnProperty.call(e,o)){var s=r?Object.getOwnPropertyDescriptor(e,o):null;s&&(s.get||s.set)?Object.defineProperty(n,o,s):n[o]=e[o]}return n.default=e,i&&i.set(e,n),n}function s1(e,t,i){var n=.5*i[0],r=.5*i[1],o=.5*i[2],s=t[0],a=t[1],l=t[2],c=t[3];return e[0]=s,e[1]=a,e[2]=l,e[3]=c,e[4]=n*c+r*l-o*a,e[5]=r*c+o*s-n*l,e[6]=o*c+n*a-r*s,e[7]=-n*s-r*a-o*l,e}function a1(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e}function l1(e,t,i){var n=t[0],r=t[1],o=t[2],s=t[3],a=i[4],l=i[5],c=i[6],u=i[7],h=t[4],d=t[5],p=t[6],_=t[7],g=i[0],y=i[1],x=i[2],b=i[3];return e[0]=n*b+s*g+r*x-o*y,e[1]=r*b+s*y+o*g-n*x,e[2]=o*b+s*x+n*y-r*g,e[3]=s*b-n*g-r*y-o*x,e[4]=n*u+s*a+r*c-o*l+h*b+_*g+d*x-p*y,e[5]=r*u+s*l+o*a-n*c+d*b+_*y+p*g-h*x,e[6]=o*u+s*c+n*l-r*a+p*b+_*x+h*y-d*g,e[7]=s*u-n*a-r*l-o*c+_*b-h*g-d*y-p*x,e}fi.getReal=ls.copy,fi.setReal=ls.copy,fi.mul=l1;var c1=ls.dot;fi.dot=c1;var u1=ls.length;fi.length=u1,fi.len=u1;var ch=ls.squaredLength;fi.squaredLength=ch,fi.sqrLen=ch;var Qe={};function Xp(e){return Xp=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Xp(e)}Object.defineProperty(Qe,"__esModule",{value:!0}),Qe.create=d1,Qe.clone=function(e){var t=new Da.ARRAY_TYPE(2);return t[0]=e[0],t[1]=e[1],t},Qe.fromValues=function(e,t){var i=new Da.ARRAY_TYPE(2);return i[0]=e,i[1]=t,i},Qe.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e},Qe.set=function(e,t,i){return e[0]=t,e[1]=i,e},Qe.add=function(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e},Qe.subtract=f1,Qe.multiply=p1,Qe.divide=m1,Qe.ceil=function(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e},Qe.floor=function(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e},Qe.min=function(e,t,i){return e[0]=Math.min(t[0],i[0]),e[1]=Math.min(t[1],i[1]),e},Qe.max=function(e,t,i){return e[0]=Math.max(t[0],i[0]),e[1]=Math.max(t[1],i[1]),e},Qe.round=function(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e},Qe.scale=function(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e},Qe.scaleAndAdd=function(e,t,i,n){return e[0]=t[0]+i[0]*n,e[1]=t[1]+i[1]*n,e},Qe.distance=_1,Qe.squaredDistance=g1,Qe.length=y1,Qe.squaredLength=v1,Qe.negate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e},Qe.inverse=function(e,t){return e[0]=1/t[0],e[1]=1/t[1],e},Qe.normalize=function(e,t){var i=t[0],n=t[1],r=i*i+n*n;return r>0&&(r=1/Math.sqrt(r)),e[0]=t[0]*r,e[1]=t[1]*r,e},Qe.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]},Qe.cross=function(e,t,i){var n=t[0]*i[1]-t[1]*i[0];return e[0]=e[1]=0,e[2]=n,e},Qe.lerp=function(e,t,i,n){var r=t[0],o=t[1];return e[0]=r+n*(i[0]-r),e[1]=o+n*(i[1]-o),e},Qe.random=function(e,t){t=t||1;var i=2*Da.RANDOM()*Math.PI;return e[0]=Math.cos(i)*t,e[1]=Math.sin(i)*t,e},Qe.transformMat2=function(e,t,i){var n=t[0],r=t[1];return e[0]=i[0]*n+i[2]*r,e[1]=i[1]*n+i[3]*r,e},Qe.transformMat2d=function(e,t,i){var n=t[0],r=t[1];return e[0]=i[0]*n+i[2]*r+i[4],e[1]=i[1]*n+i[3]*r+i[5],e},Qe.transformMat3=function(e,t,i){var n=t[0],r=t[1];return e[0]=i[0]*n+i[3]*r+i[6],e[1]=i[1]*n+i[4]*r+i[7],e},Qe.transformMat4=function(e,t,i){var n=t[0],r=t[1];return e[0]=i[0]*n+i[4]*r+i[12],e[1]=i[1]*n+i[5]*r+i[13],e},Qe.rotate=function(e,t,i,n){var r=t[0]-i[0],o=t[1]-i[1],s=Math.sin(n),a=Math.cos(n);return e[0]=r*a-o*s+i[0],e[1]=r*s+o*a+i[1],e},Qe.angle=function(e,t){var i=e[0],n=e[1],r=t[0],o=t[1],s=Math.sqrt(i*i+n*n)*Math.sqrt(r*r+o*o);return Math.acos(Math.min(Math.max(s&&(i*r+n*o)/s,-1),1))},Qe.zero=function(e){return e[0]=0,e[1]=0,e},Qe.str=function(e){return"vec2("+e[0]+", "+e[1]+")"},Qe.exactEquals=function(e,t){return e[0]===t[0]&&e[1]===t[1]},Qe.equals=function(e,t){var i=e[0],n=e[1],r=t[0],o=t[1];return Math.abs(i-r)<=Da.EPSILON*Math.max(1,Math.abs(i),Math.abs(r))&&Math.abs(n-o)<=Da.EPSILON*Math.max(1,Math.abs(n),Math.abs(o))},Qe.forEach=Qe.sqrLen=Qe.sqrDist=Qe.dist=Qe.div=Qe.mul=Qe.sub=Qe.len=void 0;var Da=function(e,t){if(e&&e.__esModule)return e;if(e===null||Xp(e)!=="object"&&typeof e!="function")return{default:e};var i=h1(void 0);if(i&&i.has(e))return i.get(e);var n={},r=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if(o!=="default"&&Object.prototype.hasOwnProperty.call(e,o)){var s=r?Object.getOwnPropertyDescriptor(e,o):null;s&&(s.get||s.set)?Object.defineProperty(n,o,s):n[o]=e[o]}return n.default=e,i&&i.set(e,n),n}(Hn);function h1(e){if(typeof WeakMap!="function")return null;var t=new WeakMap,i=new WeakMap;return(h1=function(n){return n?i:t})(e)}function d1(){var e=new Da.ARRAY_TYPE(2);return Da.ARRAY_TYPE!=Float32Array&&(e[0]=0,e[1]=0),e}function f1(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e}function p1(e,t,i){return e[0]=t[0]*i[0],e[1]=t[1]*i[1],e}function m1(e,t,i){return e[0]=t[0]/i[0],e[1]=t[1]/i[1],e}function _1(e,t){return Math.hypot(t[0]-e[0],t[1]-e[1])}function g1(e,t){var i=t[0]-e[0],n=t[1]-e[1];return i*i+n*n}function y1(e){return Math.hypot(e[0],e[1])}function v1(e){var t=e[0],i=e[1];return t*t+i*i}Qe.len=y1,Qe.sub=f1,Qe.mul=p1,Qe.div=m1,Qe.dist=_1,Qe.sqrDist=g1,Qe.sqrLen=v1;var bE=function(){var e=d1();return function(t,i,n,r,o,s){var a,l;for(i||(i=2),n||(n=0),l=r?Math.min(r*i+n,t.length):t.length,a=n;a<l;a+=i)e[0]=t[a],e[1]=t[a+1],o(e,e,s),t[a]=e[0],t[a+1]=e[1];return t}}();function Yp(e){return Yp=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Yp(e)}Qe.forEach=bE,Object.defineProperty(Zn,"__esModule",{value:!0});var Ni=Zn.vec4=Z=Zn.vec3=Zn.vec2=Zn.quat2=nr=Zn.quat=st=Zn.mat4=_r=Zn.mat3=Zn.mat2d=vl=Zn.mat2=Zn.glMatrix=void 0,wE=Do(Hn);Zn.glMatrix=wE;var TE=Do(pn),vl=Zn.mat2=TE,ME=Do(yn);Zn.mat2d=ME;var EE=Do(Yi),_r=Zn.mat3=EE,SE=Do(He),st=Zn.mat4=SE,AE=Do(Ue),nr=Zn.quat=AE,IE=Do(fi);Zn.quat2=IE;var CE=Do(Qe);Zn.vec2=CE;var DE=Do(Ge),Z=Zn.vec3=DE,PE=Do(oi);function x1(e){if(typeof WeakMap!="function")return null;var t=new WeakMap,i=new WeakMap;return(x1=function(n){return n?i:t})(e)}function Do(e,t){if(!t&&e&&e.__esModule)return e;if(e===null||Yp(e)!=="object"&&typeof e!="function")return{default:e};var i=x1(t);if(i&&i.has(e))return i.get(e);var n={},r=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if(o!=="default"&&Object.prototype.hasOwnProperty.call(e,o)){var s=r?Object.getOwnPropertyDescriptor(e,o):null;s&&(s.get||s.set)?Object.defineProperty(n,o,s):n[o]=e[o]}return n.default=e,i&&i.set(e,n),n}Ni=Zn.vec4=PE;const kE=zi([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:uh}=kE,b1=zi([{name:"a_pos_3",components:3,type:"Int16"}]);var Us=zi([{name:"a_pos",type:"Int16",components:2}]),w1={};(function(e,t){(function(i){function n(o,s,a){var l=r(256*o,256*(s=Math.pow(2,a)-s-1),a),c=r(256*(o+1),256*(s+1),a);return l[0]+","+l[1]+","+c[0]+","+c[1]}function r(o,s,a){var l=2*Math.PI*6378137/256/Math.pow(2,a);return[o*l-2*Math.PI*6378137/2,s*l-2*Math.PI*6378137/2]}i.getURL=function(o,s,a,l,c,u){return u=u||{},o+"?"+["bbox="+n(a,l,c),"format="+(u.format||"image/png"),"service="+(u.service||"WMS"),"version="+(u.version||"1.1.1"),"request="+(u.request||"GetMap"),"srs="+(u.srs||"EPSG:3857"),"width="+(u.width||256),"height="+(u.height||256),"layers="+s].join("&")},i.getTileBBox=n,i.getMercCoords=r,Object.defineProperty(i,"__esModule",{value:!0})})(t)})(0,w1);var zE=w1;class Yr{constructor(t,i,n){this.z=t,this.x=i,this.y=n,this.key=Lc(0,t,t,i,n)}equals(t){return this.z===t.z&&this.x===t.x&&this.y===t.y}url(t,i){const n=zE.getTileBBox(this.x,this.y,this.z),r=function(o,s,a){let l,c="";for(let u=o;u>0;u--)l=1<<u-1,c+=(s&l?1:0)+(a&l?2:0);return c}(this.z,this.x,this.y);return t[(this.x+this.y)%t.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String(i==="tms"?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",r).replace("{bbox-epsg-3857}",n)}toString(){return`${this.z}/${this.x}/${this.y}`}}class Kp{constructor(t,i){this.wrap=t,this.canonical=i,this.key=Lc(t,i.z,i.z,i.x,i.y)}}class Si{constructor(t,i,n,r,o){this.overscaledZ=t,this.wrap=i,this.canonical=new Yr(n,+r,+o),this.key=i===0&&t===n?this.canonical.key:Lc(i,t,n,r,o)}equals(t){return this.overscaledZ===t.overscaledZ&&this.wrap===t.wrap&&this.canonical.equals(t.canonical)}scaledTo(t){const i=this.canonical.z-t;return t>this.canonical.z?new Si(t,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new Si(t,this.wrap,t,this.canonical.x>>i,this.canonical.y>>i)}calculateScaledKey(t,i=!0){if(this.overscaledZ===t&&i)return this.key;if(t>this.canonical.z)return Lc(this.wrap*+i,t,this.canonical.z,this.canonical.x,this.canonical.y);{const n=this.canonical.z-t;return Lc(this.wrap*+i,t,t,this.canonical.x>>n,this.canonical.y>>n)}}isChildOf(t){if(t.wrap!==this.wrap)return!1;const i=this.canonical.z-t.canonical.z;return t.overscaledZ===0||t.overscaledZ<this.overscaledZ&&t.canonical.z<this.canonical.z&&t.canonical.x===this.canonical.x>>i&&t.canonical.y===this.canonical.y>>i}children(t){if(this.overscaledZ>=t)return[new Si(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const i=this.canonical.z+1,n=2*this.canonical.x,r=2*this.canonical.y;return[new Si(i,this.wrap,i,n,r),new Si(i,this.wrap,i,n+1,r),new Si(i,this.wrap,i,n,r+1),new Si(i,this.wrap,i,n+1,r+1)]}isLessThan(t){return this.wrap<t.wrap||!(this.wrap>t.wrap)&&(this.overscaledZ<t.overscaledZ||!(this.overscaledZ>t.overscaledZ)&&(this.canonical.x<t.canonical.x||!(this.canonical.x>t.canonical.x)&&this.canonical.y<t.canonical.y))}wrapped(){return new Si(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(t){return new Si(this.overscaledZ,t,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new Kp(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}}function Lc(e,t,i,n,r){const o=1<<Math.min(i,22);let s=o*(r%o)+n%o;return e&&i<22&&(s+=o*o*((e<0?-2*e-1:2*e)%(1<<2*(22-i)))),16*(32*s+i)+(t-i)}const T1=[e=>{let t=e.canonical.x-1,i=e.wrap;return t<0&&(t=(1<<e.canonical.z)-1,i--),new Si(e.overscaledZ,i,e.canonical.z,t,e.canonical.y)},e=>{let t=e.canonical.x+1,i=e.wrap;return t===1<<e.canonical.z&&(t=0,i++),new Si(e.overscaledZ,i,e.canonical.z,t,e.canonical.y)},e=>new Si(e.overscaledZ,e.wrap,e.canonical.z,e.canonical.x,(e.canonical.y===0?1<<e.canonical.z:e.canonical.y)-1),e=>new Si(e.overscaledZ,e.wrap,e.canonical.z,e.canonical.x,e.canonical.y===(1<<e.canonical.z)-1?0:e.canonical.y+1)];he(Yr,"CanonicalTileID"),he(Si,"OverscaledTileID",{omit:["projMatrix","expandedProjMatrix"]});class hh{constructor(t,i){this.pos=t,this.dir=i}intersectsPlane(t,i,n){const r=Z.dot(i,this.dir);if(Math.abs(r)<1e-6)return!1;const o=((t[0]-this.pos[0])*i[0]+(t[1]-this.pos[1])*i[1]+(t[2]-this.pos[2])*i[2])/r;return n[0]=this.pos[0]+this.dir[0]*o,n[1]=this.pos[1]+this.dir[1]*o,n[2]=this.pos[2]+this.dir[2]*o,!0}closestPointOnSphere(t,i,n){if(Z.equals(this.pos,t)||i===0)return n[0]=n[1]=n[2]=0,!1;const[r,o,s]=this.dir,a=this.pos[0]-t[0],l=this.pos[1]-t[1],c=this.pos[2]-t[2],u=r*r+o*o+s*s,h=2*(a*r+l*o+c*s),d=h*h-4*u*(a*a+l*l+c*c-i*i);if(d<0){const p=Math.max(-h/2,0),_=a+r*p,g=l+o*p,y=c+s*p,x=Math.hypot(_,g,y);return n[0]=_*i/x,n[1]=g*i/x,n[2]=y*i/x,!1}{const p=(-h-Math.sqrt(d))/(2*u);if(p<0){const _=Math.hypot(a,l,c);return n[0]=a*i/_,n[1]=l*i/_,n[2]=c*i/_,!1}return n[0]=a+r*p,n[1]=l+o*p,n[2]=c+s*p,!0}}}class Jp{constructor(t,i,n,r,o){this.TL=t,this.TR=i,this.BR=n,this.BL=r,this.horizon=o}static fromInvProjectionMatrix(t,i,n){const r=[-1,1,1],o=[1,1,1],s=[1,-1,1],a=[-1,-1,1],l=Z.transformMat4(r,r,t),c=Z.transformMat4(o,o,t),u=Z.transformMat4(s,s,t),h=Z.transformMat4(a,a,t);return new Jp(l,c,u,h,i/n)}}function Rc(e,t,i){let n=1/0,r=-1/0;const o=[];for(const s of e){Z.sub(o,s,t);const a=Z.dot(o,i);n=Math.min(n,a),r=Math.max(r,a)}return[n,r]}function M1(e,t){let i=!0;for(let n=0;n<e.planes.length;n++){const r=e.planes[n];let o=0;for(let s=0;s<t.length;s++)o+=Z.dot(r,t[s])+r[3]>=0;if(o===0)return 0;o!==t.length&&(i=!1)}return i?2:1}function E1(e,t){for(const i of e.projections){const n=Rc(t,e.points[0],i.axis);if(i.projection[1]<n[0]||i.projection[0]>n[1])return 0}return 1}function S1(e,t){let i=0;const n=[0,0,0,0];for(let r=0;r<e.length;r++)n[0]=e[r][0],n[1]=e[r][1],n[2]=e[r][2],n[3]=1,Ni.dot(n,t)>=0&&i++;return i}class cs{constructor(t,i){this.points=t||new Array(8).fill([0,0,0]),this.planes=i||new Array(6).fill([0,0,0,0]),this.bounds=en.fromPoints(this.points),this.projections=[],this.frustumEdges=[Z.sub([],this.points[2],this.points[3]),Z.sub([],this.points[0],this.points[3]),Z.sub([],this.points[4],this.points[0]),Z.sub([],this.points[5],this.points[1]),Z.sub([],this.points[6],this.points[2]),Z.sub([],this.points[7],this.points[3])];for(const n of this.frustumEdges){const r=[0,-n[2],n[1]],o=[n[2],0,-n[0]];this.projections.push({axis:r,projection:Rc(this.points,this.points[0],r)}),this.projections.push({axis:o,projection:Rc(this.points,this.points[0],o)})}}static fromInvProjectionMatrix(t,i,n,r){const o=Math.pow(2,n),s=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map(c=>{const u=Ni.transformMat4([],c,t),h=1/u[3]/i*o;return Ni.mul(u,u,[h,h,r?1/u[3]:h,h])}),a=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map(c=>{const u=Z.sub([],s[c[0]],s[c[1]]),h=Z.sub([],s[c[2]],s[c[1]]),d=Z.normalize([],Z.cross([],u,h)),p=-Z.dot(d,s[c[1]]);return d.concat(p)}),l=[];for(let c=0;c<s.length;c++)l.push([s[c][0],s[c][1],s[c][2]]);return new cs(l,a)}intersectsPrecise(t,i,n){for(let r=0;r<i.length;r++)if(!S1(t,i[r]))return 0;for(let r=0;r<this.planes.length;r++)if(!S1(t,this.planes[r]))return 0;for(const r of n)for(const o of this.frustumEdges){const s=Z.cross([],r,o),a=Z.length(s);if(a===0)continue;Z.scale(s,s,1/a);const l=Rc(this.points,this.points[0],s),c=Rc(t,this.points[0],s);if(l[0]>c[1]||c[0]>l[1])return 0}return 1}}class en{static fromPoints(t){const i=[1/0,1/0,1/0],n=[-1/0,-1/0,-1/0];for(const r of t)Z.min(i,i,r),Z.max(n,n,r);return new en(i,n)}static fromTileIdAndHeight(t,i,n){const r=1<<t.canonical.z,o=t.canonical.x,s=t.canonical.y;return new en([o/r,s/r,i],[(o+1)/r,(s+1)/r,n])}static applyTransform(t,i){const n=t.getCorners();for(let r=0;r<n.length;++r)Z.transformMat4(n[r],n[r],i);return en.fromPoints(n)}static projectAabbCorners(t,i){const n=t.getCorners();for(let r=0;r<n.length;++r)Z.transformMat4(n[r],n[r],i);return n}constructor(t,i){this.min=t,this.max=i,this.center=Z.scale([],Z.add([],this.min,this.max),.5)}quadrant(t){const i=[t%2==0,t<2],n=Z.clone(this.min),r=Z.clone(this.max);for(let o=0;o<i.length;o++)n[o]=i[o]?this.min[o]:this.center[o],r[o]=i[o]?this.center[o]:this.max[o];return r[2]=this.max[2],new en(n,r)}distanceX(t){return Math.max(Math.min(this.max[0],t[0]),this.min[0])-t[0]}distanceY(t){return Math.max(Math.min(this.max[1],t[1]),this.min[1])-t[1]}distanceZ(t){return Math.max(Math.min(this.max[2],t[2]),this.min[2])-t[2]}getCorners(){const t=this.min,i=this.max;return[[t[0],t[1],t[2]],[i[0],t[1],t[2]],[i[0],i[1],t[2]],[t[0],i[1],t[2]],[t[0],t[1],i[2]],[i[0],t[1],i[2]],[i[0],i[1],i[2]],[t[0],i[1],i[2]]]}intersects(t){return this.intersectsAabb(t.bounds)?M1(t,this.getCorners()):0}intersectsFlat(t){return this.intersectsAabb(t.bounds)?M1(t,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsPrecise(t,i){return i||this.intersects(t)?E1(t,this.getCorners()):0}intersectsPreciseFlat(t,i){return i||this.intersectsFlat(t)?E1(t,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsAabb(t){for(let i=0;i<3;++i)if(this.min[i]>t.max[i]||t.min[i]>this.max[i])return!1;return!0}intersectsAabbXY(t){return!(this.min[0]>t.max[0]||t.min[0]>this.max[0]||this.min[1]>t.max[1]||t.min[1]>this.max[1])}encapsulate(t){for(let i=0;i<3;i++)this.min[i]=Math.min(this.min[i],t.min[i]),this.max[i]=Math.max(this.max[i],t.max[i])}encapsulatePoint(t){for(let i=0;i<3;i++)this.min[i]=Math.min(this.min[i],t[i]),this.max[i]=Math.max(this.max[i],t[i])}closestPoint(t){return[Math.max(Math.min(this.max[0],t[0]),this.min[0]),Math.max(Math.min(this.max[1],t[1]),this.min[1]),Math.max(Math.min(this.max[2],t[2]),this.min[2])]}}he(en,"Aabb");const Oc=5,Vs=6,dr=pt/Math.PI/2,LE=16383,xl=64,Qp=[xl,32,16],Kr=-dr,Jr=dr,RE=[new en([Kr,Kr,Kr],[Jr,Jr,Jr]),new en([Kr,Kr,Kr],[0,0,Jr]),new en([0,Kr,Kr],[Jr,0,Jr]),new en([Kr,0,Kr],[0,Jr,Jr]),new en([0,0,Kr],[Jr,Jr,Jr])];function dh(e){return e*dr/wl}function A1(e,t,i,n=!0){const r=Z.scale([],e._camera.position,e.worldSize),o=[t,i,1,1];Ni.transformMat4(o,o,e.pixelMatrixInverse),Ni.scale(o,o,1/o[3]);const s=Z.sub([],o,r),a=Z.normalize([],s),l=e.globeMatrix,c=[l[12],l[13],l[14]],u=Z.sub([],c,r),h=Z.length(u),d=Z.normalize([],u),p=e.worldSize/(2*Math.PI),_=Z.dot(d,a),g=Math.asin(p/h);if(g<Math.acos(_)){if(!n)return null;const N=[],U=[];Z.scale(N,a,h/_),Z.normalize(U,Z.sub(U,N,u)),Z.normalize(a,Z.add(a,u,Z.scale(a,U,Math.tan(g)*h)))}const y=[];new hh(r,a).closestPointOnSphere(c,p,y);const x=Z.normalize([],Ci(l,0)),b=Z.normalize([],Ci(l,1)),M=Z.normalize([],Ci(l,2)),E=Z.dot(x,y),T=Z.dot(b,y),S=Z.dot(M,y),D=ne(Math.asin(-T/p));let z=ne(Math.atan2(E,S));z=e.center.lng+function(N,U){const H=(U-N+180)%360-180;return H<-180?H+360:H}(e.center.lng,z);const L=Fn(z),R=Lt(jn(D),0,1);return new ui(L,R)}class OE{constructor(t,i,n){this.a=Z.sub([],t,n),this.b=Z.sub([],i,n),this.center=n;const r=Z.normalize([],this.a),o=Z.normalize([],this.b);this.angle=Math.acos(Z.dot(r,o))}}function tm(e,t){if(e.angle===0)return null;let i;return i=e.a[t]===0?1/e.angle*.5*Math.PI:1/e.angle*Math.atan(e.b[t]/e.a[t]/Math.sin(e.angle)-1/Math.tan(e.angle)),i<0||i>1?null:function(n,r,o,s){const a=Math.sin(o);return n*(Math.sin((1-s)*o)/a)+r*(Math.sin(s*o)/a)}(e.a[t],e.b[t],e.angle,Lt(i,0,1))+e.center[t]}function Fr(e){if(e.z<=1)return RE[e.z+2*e.y+e.x];const t=im(fh(e));return en.fromPoints(t)}function us(e,t,i){return Z.scale(e,e,1-i),Z.scaleAndAdd(e,e,t,i)}function I1(e,t){const i=Wn(t.zoom);if(i===0)return Fr(e);const n=fh(e),r=im(n),o=Fn(n.getWest())*t.worldSize,s=Fn(n.getEast())*t.worldSize,a=jn(n.getNorth())*t.worldSize,l=jn(n.getSouth())*t.worldSize,c=[o,a,0],u=[s,a,0],h=[o,l,0],d=[s,l,0],p=st.invert([],t.globeMatrix);return Z.transformMat4(c,c,p),Z.transformMat4(u,u,p),Z.transformMat4(h,h,p),Z.transformMat4(d,d,p),r[0]=us(r[0],h,i),r[1]=us(r[1],d,i),r[2]=us(r[2],u,i),r[3]=us(r[3],c,i),en.fromPoints(r)}function C1(e,t,i){for(const n of e)Z.transformMat4(n,n,t),Z.scale(n,n,i)}function em(e,t,i,n){const r=t/e.worldSize,o=e.globeMatrix;if(i.z<=1){const L=Fr(i).getCorners();return C1(L,o,r),en.fromPoints(L)}const s=fh(i,n),a=im(s);C1(a,o,r);const l=Number.MAX_VALUE,c=[-l,-l,-l],u=[l,l,l];if(s.contains(e.center)){for(const N of a)Z.min(u,u,N),Z.max(c,c,N);c[2]=0;const L=e.point,R=[L.x*r,L.y*r,0];return Z.min(u,u,R),Z.max(c,c,R),new en(u,c)}const h=[o[12]*r,o[13]*r,o[14]*r],d=s.getCenter(),p=Lt(e.center.lat,-Sn,Sn),_=Lt(d.lat,-Sn,Sn),g=Fn(e.center.lng),y=jn(p);let x=g-Fn(d.lng);const b=y-jn(_);x>.5?x-=1:x<-.5&&(x+=1);let M=0;if(Math.abs(x)>Math.abs(b))M=x>=0?1:3;else{M=b>=0?0:2;const L=[o[4]*r,o[5]*r,o[6]*r],R=-Math.sin(wt(b>=0?s.getSouth():s.getNorth()))*dr;Z.scaleAndAdd(h,h,L,R)}const E=a[M],T=a[(M+1)%4],S=new OE(E,T,h),D=[tm(S,0)||E[0],tm(S,1)||E[1],tm(S,2)||E[2]],z=Wn(e.zoom);if(z>0){const L=function({x:N,y:U,z:H},O,X,K,ot){const $=1/(1<<H);let Y=N*$,at=Y+$,ut=U*$,ct=ut+$,bt=0;const Mt=(Y+at)/2-K;return Mt>.5?bt=-1:Mt<-.5&&(bt=1),Y=((Y+bt)*O-(K*=O))*X+K,at=((at+bt)*O-K)*X+K,ut=(ut*O-(ot*=O))*X+ot,ct=(ct*O-ot)*X+ot,[[Y,ct,0],[at,ct,0],[at,ut,0],[Y,ut,0]]}(i,t,e._pixelsPerMercatorPixel,g,y);for(let N=0;N<a.length;N++)us(a[N],L[N],z);const R=Z.add([],L[M],L[(M+1)%4]);Z.scale(R,R,.5),us(D,R,z)}for(const L of a)Z.min(u,u,L),Z.max(c,c,L);return u[2]=Math.min(E[2],T[2]),Z.min(u,u,D),Z.max(c,c,D),new en(u,c)}function fh({x:e,y:t,z:i},n=!1){const r=1/(1<<i),o=new Le(Sr(e*r),t===(1<<i)-1&&n?-90:On((t+1)*r)),s=new Le(Sr((e+1)*r),t===0&&n?90:On(t*r));return new Er(o,s)}function im(e){const t=wt(e.getNorth()),i=wt(e.getSouth()),n=Math.cos(t),r=Math.cos(i),o=Math.sin(t),s=Math.sin(i),a=e.getWest(),l=e.getEast();return[bl(r,s,a),bl(r,s,l),bl(n,o,l),bl(n,o,a)]}function bl(e,t,i,n=dr){return i=wt(i),[e*Math.sin(i)*n,-t*n,e*Math.cos(i)*n]}function gr(e,t,i){return bl(Math.cos(wt(e)),Math.sin(wt(e)),t,i)}function Bc(e,t,i,n){const r=1<<i.z,o=(e/pt+i.x)/r;return gr(On((t/pt+i.y)/r),Sr(o),n)}function ph({min:e,max:t}){return LE/Math.max(t[0]-e[0],t[1]-e[1],t[2]-e[2])}const D1=new Float64Array(16);function js(e){const t=ph(e),i=st.fromScaling(D1,[t,t,t]);return st.translate(i,i,Z.negate([],e.min))}function nm(e){const t=st.fromTranslation(D1,e.min),i=1/ph(e);return st.scale(t,t,[i,i,i])}function rm(e){const t=pt/(2*Math.PI);return e/(2*Math.PI)/t}function P1(e,t){return pt/(512*Math.pow(2,e))*ph(Fr(t))}function k1(e,t,i,n,r){const o=rm(i),s=[e,t,-i/(2*Math.PI)],a=st.identity(new Float64Array(16));return st.translate(a,a,s),st.scale(a,a,[o,o,o]),st.rotateX(a,a,wt(-r)),st.rotateY(a,a,wt(-n)),a}function z1(e){const t=e.pixelsPerMeter,i=t/Gi(1,e.center.lat),n=st.identity(new Float64Array(16));return st.translate(n,n,[e.point.x,e.point.y,0]),st.scale(n,n,[i,i,t]),Float32Array.from(n)}function Wn(e){return Fe(Oc,Vs,e)}function L1(e,t,i){const n=st.identity(new Float64Array(16)),r=(t/(1<<e)-.5)*Math.PI*2;return st.rotateY(n,i.globeMatrix,r),Float32Array.from(n)}function R1(e,t,i){const n=Wn(i.zoom),r=e.style.map._antialias,o=t.options.extStandardDerivativesForceOff||e.terrain&&e.terrain.exaggeration()>0;return n===0&&!r&&!o}function O1(e,t,i,n){const r=t.getNorth(),o=t.getSouth(),s=t.getWest(),a=t.getEast(),l=1<<e.z,c=a-s,u=r-o,h=c/xl,d=-u/Qp[i],p=[0,h,0,d,0,0,r,s,0];if(e.z>0){const _=180/n;_r.multiply(p,p,[_/c+1,0,0,0,_/u+1,0,-.5*_/h,.5*_/d,1])}return p[2]=l,p[5]=e.x,p[8]=e.y,p}function BE(e){const t=Sn-5;e=Lt(e,-t,t)/t*90;const i=Math.pow(Math.abs(Math.sin(wt(e))),3);return Math.round(i*(Qp.length-1))}function B1(e){const t=[0,0,0],i=st.identity(new Float64Array(16));return st.multiply(i,e.pixelMatrix,e.globeMatrix),Z.transformMat4(t,t,i),new G(t[0],t[1])}function F1(e,t){const i=gr(t.lat,t.lng),n=function(o){const s=gr(o._center.lat,o._center.lng),a=Z.fromValues(0,1,0);let l=Z.cross([],a,s);const c=st.fromRotation([],-o.angle,s);l=Z.transformMat4(l,l,c),st.fromRotation(c,-o._pitch,l);const u=Z.normalize([],s);return Z.scale(u,u,dh(o.cameraToCenterDistance/o.pixelsPerMeter)),Z.transformMat4(u,u,c),Z.add([],s,u)}(e),r=Z.subtract([],n,i);return Z.angle(r,i)}function mh(e,t){return F1(e,t)>Math.PI/2*1.01}const N1=wt(85),FE=Math.cos(N1),NE=Math.sin(N1);class UE{constructor(t){this._createGrid(t),this._createPoles(t)}destroy(){this._poleIndexBuffer.destroy(),this._gridBuffer.destroy(),this._gridIndexBuffer.destroy(),this._poleNorthVertexBuffer.destroy(),this._poleSouthVertexBuffer.destroy();for(const t of this._poleSegments)t.destroy();for(const t of this._gridSegments)t.withSkirts.destroy(),t.withoutSkirts.destroy()}_fillGridMeshWithLods(t,i){const n=new Tr,r=new Rn,o=[],s=t+1+2,a=i[0]+1,l=i[0]+1+(1+i.length),c=(u,h,d)=>{let p=u===s-1?u-2:u===0?u:u-1;return p+=d?24575:0,[p,h]};for(let u=0;u<s;++u)n.emplaceBack(...c(u,0,!0));for(let u=0;u<a;++u)for(let h=0;h<s;++h)n.emplaceBack(...c(h,u,(h===0||h===s-1)&&!0));for(let u=0;u<i.length;++u){const h=i[u];for(let d=0;d<s;++d)n.emplaceBack(...c(d,h,!0))}for(let u=0;u<i.length;++u){const h=r.length,d=i[u]+1+2,p=new Rn;for(let y=0;y<d-1;y++){const x=y===d-2,b=x?s*(l-i.length+u-y):s;for(let M=0;M<s-1;M++){const E=y*s+M;y===0||x||M===0||M===s-2?(p.emplaceBack(E+1,E,E+b),p.emplaceBack(E+b,E+b+1,E+1)):(r.emplaceBack(E+1,E,E+b),r.emplaceBack(E+b,E+b+1,E+1))}}const _=Fi.simpleSegment(0,h,n.length,r.length-h);for(let y=0;y<p.uint16.length;y+=3)r.emplaceBack(p.uint16[y],p.uint16[y+1],p.uint16[y+2]);const g=Fi.simpleSegment(0,h,n.length,r.length-h);o.push({withoutSkirts:_,withSkirts:g})}return{vertices:n,indices:r,segments:o}}_createGrid(t){const i=this._fillGridMeshWithLods(xl,Qp);this._gridSegments=i.segments,this._gridBuffer=t.createVertexBuffer(i.vertices,Us.members),this._gridIndexBuffer=t.createIndexBuffer(i.indices,!0)}_createPoles(t){const i=new Rn;for(let a=0;a<=xl;a++)i.emplaceBack(0,a+1,a+2);this._poleIndexBuffer=t.createIndexBuffer(i,!0);const n=new Sa,r=new Sa,o=new Sa,s=new Sa;this._poleSegments=[];for(let a=0,l=0;a<Oc;a++){const c=360/(1<<a);n.emplaceBack(0,-dr,0,.5,0),r.emplaceBack(0,-dr,0,.5,1),o.emplaceBack(0,-dr,0,.5,.5),s.emplaceBack(0,-dr,0,.5,.5);for(let u=0;u<=xl;u++){let h=u/xl,d=0;const p=ze(0,c,h),[_,g,y]=bl(FE,NE,p,dr);n.emplaceBack(_,g,y,h,d),r.emplaceBack(_,g,y,h,1-d);const x=wt(p);h=.5+.5*Math.sin(x),d=.5+.5*Math.cos(x),o.emplaceBack(_,g,y,h,d),s.emplaceBack(_,g,y,h,1-d)}this._poleSegments.push(Fi.simpleSegment(l,0,66,64)),l+=66}this._poleNorthVertexBuffer=t.createVertexBuffer(n,uh,!1),this._poleSouthVertexBuffer=t.createVertexBuffer(r,uh,!1),this._texturedPoleNorthVertexBuffer=t.createVertexBuffer(o,uh,!1),this._texturedPoleSouthVertexBuffer=t.createVertexBuffer(s,uh,!1)}getGridBuffers(t,i){return[this._gridBuffer,this._gridIndexBuffer,i?this._gridSegments[t].withSkirts:this._gridSegments[t].withoutSkirts]}getPoleBuffers(t,i){return[i?this._texturedPoleNorthVertexBuffer:this._poleNorthVertexBuffer,i?this._texturedPoleSouthVertexBuffer:this._poleSouthVertexBuffer,this._poleIndexBuffer,this._poleSegments[t]]}}const wl=63710088e-1,om=2*Math.PI*wl;class Gs{constructor(t,i){if(isNaN(t)||isNaN(i))throw new Error(`Invalid LngLat object: (${t}, ${i})`);if(this.lng=+t,this.lat=+i,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new Gs(Me(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(t){const i=Math.PI/180,n=this.lat*i,r=t.lat*i,o=Math.sin(n)*Math.sin(r)+Math.cos(n)*Math.cos(r)*Math.cos((t.lng-this.lng)*i);return wl*Math.acos(Math.min(o,1))}toBounds(t=0){const i=360*t/40075017,n=i/Math.cos(Math.PI/180*this.lat);return new Er(new Gs(this.lng-n,this.lat-i),new Gs(this.lng+n,this.lat+i))}toEcef(t){const i=dh(t);return gr(this.lat,this.lng,dr+i)}static convert(t){if(t instanceof Gs)return t;if(Array.isArray(t)&&(t.length===2||t.length===3))return new Gs(Number(t[0]),Number(t[1]));if(!Array.isArray(t)&&typeof t=="object"&&t!==null)return new Gs(Number("lng"in t?t.lng:t.lon),Number(t.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}var Le=Gs;const VE=0,jE=25.5;function _h(e){return om*Math.cos(e*Math.PI/180)}function Fn(e){return(180+e)/360}function jn(e){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+e*Math.PI/360)))/360}function Gi(e,t){return e/_h(t)}function Sr(e){return 360*e-180}function On(e){return 360/Math.PI*Math.atan(Math.exp((180-360*e)*Math.PI/180))-90}function U1(e,t){return e*_h(On(t))}const Sn=85.051129;function V1(e){return Math.cos(wt(Lt(e,-Sn,Sn)))}function qs(e,t){const i=Lt(t,VE,jE),n=Math.pow(2,i);return V1(e)*om/(512*n)}function sm(e){return 1/Math.cos(e*Math.PI/180)}function Fc(e,t=0){const i=Math.exp(Math.PI*(1-(e.y+t/pt)/(1<<e.z)*2));return 80150034*i/(i*i+1)/pt/(1<<e.z)}class ui{constructor(t,i,n=0){this.x=+t,this.y=+i,this.z=+n}static fromLngLat(t,i=0){const n=Le.convert(t);return new ui(Fn(n.lng),jn(n.lat),Gi(i,n.lat))}toLngLat(){return new Le(Sr(this.x),On(this.y))}toAltitude(){return U1(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/om*sm(On(this.y))}}function am(e,t,i,n,r,o,s,a,l){const c=(t+n)/2,u=(i+r)/2,h=new G(c,u);a(h),function(d,p,_,g,y,x){const b=_-y,M=g-x;return Math.abs((g-p)*b-(_-d)*M)/Math.hypot(b,M)}(h.x,h.y,o.x,o.y,s.x,s.y)>=l?(am(e,t,i,c,u,o,h,a,l),am(e,c,u,n,r,h,s,a,l)):e.push(s)}function j1(e,t,i){let n=e[0],r=n.x,o=n.y;t(n);const s=[n];for(let a=1;a<e.length;a++){const l=e[a],{x:c,y:u}=l;t(l),am(s,r,o,c,u,n,l,t,i),r=c,o=u,n=l}return s}function lm(e,t,i,n){if(n(t,i)){const r=t.add(i)._mult(.5);lm(e,t,r,n),lm(e,r,i,n)}else e.push(i)}function GE(e,t){let i=e[0];const n=[i];for(let r=1;r<e.length;r++){const o=e[r];lm(n,i,o,t),i=o}return n}const cm=Math.pow(2,14)-1,G1=-cm-1;function qE(e,t){const i=Math.round(e.x*t),n=Math.round(e.y*t);return e.x=Lt(i,G1,cm),e.y=Lt(n,G1,cm),(i<e.x||i>e.x+1||n<e.y||n>e.y+1)&&J("Geometry exceeds allowed extent, reduce your vector tile buffer size"),e}function Po(e,t,i){const n=e.loadGeometry(),r=e.extent,o=pt/r;if(t&&i&&i.projection.isReprojectedInTileSpace){const s=1<<t.z,{scale:a,x:l,y:c,projection:u}=i,h=d=>{const p=Sr((t.x+d.x/r)/s),_=On((t.y+d.y/r)/s),g=u.project(p,_);d.x=(g.x*a-l)*r,d.y=(g.y*a-c)*r};for(let d=0;d<n.length;d++)if(e.type!==1)n[d]=j1(n[d],h,1);else{const p=[];for(const _ of n[d])_.x<0||_.x>=r||_.y<0||_.y>=r||(h(_),p.push(_));n[d]=p}}for(const s of n)for(const a of s)qE(a,o);return n}function Zs(e,t){return{type:e.type,id:e.id,properties:e.properties,geometry:t?Po(e):[]}}function gh(e,t,i,n,r){e.emplaceBack(2*t+(n+1)/2,2*i+(r+1)/2)}function yh(e,t,i){e.emplaceBack(t.x,t.y,t.z,i[0]*16384,i[1]*16384,i[2]*16384)}class um{constructor(t){this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(i=>i.fqid),this.index=t.index,this.hasPattern=!1,this.projection=t.projection,this.layoutVertexArray=new Tr,this.indexArray=new Rn,this.segments=new Fi,this.programConfigurations=new Fs(t.layers,t.zoom),this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id)}populate(t,i,n,r){const o=this.layers[0],s=[];let a=null;o.type==="circle"&&(a=o.layout.get("circle-sort-key"));for(const{feature:c,id:u,index:h,sourceLayerIndex:d}of t){const p=this.layers[0]._featureFilter.needGeometry,_=Zs(c,p);if(!this.layers[0]._featureFilter.filter(new dn(this.zoom),_,n))continue;const g=a?a.evaluate(_,{},n):void 0,y={id:u,properties:c.properties,type:c.type,sourceLayerIndex:d,index:h,geometry:p?_.geometry:Po(c,n,r),patterns:{},sortKey:g};s.push(y)}a&&s.sort((c,u)=>c.sortKey-u.sortKey);let l=null;r.projection.name==="globe"&&(this.globeExtVertexArray=new ih,l=r.projection);for(const c of s){const{geometry:u,index:h,sourceLayerIndex:d}=c,p=t[h].feature;this.addFeature(c,u,h,i.availableImages,n,l,i.brightness),i.featureIndex.insert(p,u,h,d,this.index)}}update(t,i,n,r,o){const s=Object.keys(t).length!==0;s&&!this.stateDependentLayers.length||this.programConfigurations.updatePaintArrays(t,i,s?this.stateDependentLayers:this.layers,n,r,o)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(t){this.uploaded||(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,tE.members),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.globeExtVertexArray&&(this.globeExtVertexBuffer=t.createVertexBuffer(this.globeExtVertexArray,eE.members))),this.programConfigurations.upload(t),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy())}addFeature(t,i,n,r,o,s,a){for(const l of i)for(const c of l){const u=c.x,h=c.y;if(u<0||u>=pt||h<0||h>=pt)continue;if(s){const _=s.projectTilePoint(u,h,o),g=s.upVector(o,u,h),y=this.globeExtVertexArray;yh(y,_,g),yh(y,_,g),yh(y,_,g),yh(y,_,g)}const d=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,t.sortKey),p=d.vertexLength;gh(this.layoutVertexArray,u,h,-1,-1),gh(this.layoutVertexArray,u,h,1,-1),gh(this.layoutVertexArray,u,h,1,1),gh(this.layoutVertexArray,u,h,-1,1),this.indexArray.emplaceBack(p,p+1,p+2),this.indexArray.emplaceBack(p,p+2,p+3),d.vertexLength+=4,d.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,n,{},r,o,a)}}function q1(e,t){for(let i=0;i<e.length;i++)if(Hs(t,e[i]))return!0;for(let i=0;i<t.length;i++)if(Hs(e,t[i]))return!0;return!!hm(e,t)}function ZE(e,t,i){return!!Hs(e,t)||!!dm(t,e,i)}function Z1(e,t){if(e.length===1)return W1(t,e[0]);for(let i=0;i<t.length;i++){const n=t[i];for(let r=0;r<n.length;r++)if(Hs(e,n[r]))return!0}for(let i=0;i<e.length;i++)if(W1(t,e[i]))return!0;for(let i=0;i<t.length;i++)if(hm(e,t[i]))return!0;return!1}function HE(e,t,i){if(e.length>1){if(hm(e,t))return!0;for(let n=0;n<t.length;n++)if(dm(t[n],e,i))return!0}for(let n=0;n<e.length;n++)if(dm(e[n],t,i))return!0;return!1}function hm(e,t){if(e.length===0||t.length===0)return!1;for(let i=0;i<e.length-1;i++){const n=e[i],r=e[i+1];for(let o=0;o<t.length-1;o++)if(WE(n,r,t[o],t[o+1]))return!0}return!1}function WE(e,t,i,n){return At(e,i,n)!==At(t,i,n)&&At(e,t,i)!==At(e,t,n)}function dm(e,t,i){const n=i*i;if(t.length===1)return e.distSqr(t[0])<n;for(let r=1;r<t.length;r++)if(H1(e,t[r-1],t[r])<n)return!0;return!1}function H1(e,t,i){const n=t.distSqr(i);if(n===0)return e.distSqr(t);const r=((e.x-t.x)*(i.x-t.x)+(e.y-t.y)*(i.y-t.y))/n;return e.distSqr(r<0?t:r>1?i:i.sub(t)._mult(r)._add(t))}function W1(e,t){let i,n,r,o=!1;for(let s=0;s<e.length;s++){i=e[s];for(let a=0,l=i.length-1;a<i.length;l=a++)n=i[a],r=i[l],n.y>t.y!=r.y>t.y&&t.x<(r.x-n.x)*(t.y-n.y)/(r.y-n.y)+n.x&&(o=!o)}return o}function Hs(e,t){let i=!1;for(let n=0,r=e.length-1;n<e.length;r=n++){const o=e[n],s=e[r];o.y>t.y!=s.y>t.y&&t.x<(s.x-o.x)*(t.y-o.y)/(s.y-o.y)+o.x&&(i=!i)}return i}function $1(e,t,i,n,r){for(const s of e)if(t<=s.x&&i<=s.y&&n>=s.x&&r>=s.y)return!0;const o=[new G(t,i),new G(t,r),new G(n,r),new G(n,i)];if(e.length>2){for(const s of o)if(Hs(e,s))return!0}for(let s=0;s<e.length-1;s++)if($E(e[s],e[s+1],o))return!0;return!1}function $E(e,t,i){const n=i[0],r=i[2];if(e.x<n.x&&t.x<n.x||e.x>r.x&&t.x>r.x||e.y<n.y&&t.y<n.y||e.y>r.y&&t.y>r.y)return!1;const o=At(e,t,i[0]);return o!==At(e,t,i[1])||o!==At(e,t,i[2])||o!==At(e,t,i[3])}function Tl(e,t,i,n,r,o){let s=t.y-e.y,a=e.x-t.x;if(o=o||0){const l=s*s+a*a;if(l===0)return!0;const c=Math.sqrt(l);s/=c,a/=c}return!((i.x-e.x)*s+(i.y-e.y)*a-o<0||(n.x-e.x)*s+(n.y-e.y)*a-o<0||(r.x-e.x)*s+(r.y-e.y)*a-o<0)}function fm(e,t,i,n,r,o,s){return!(Tl(e,t,n,r,o,s)||Tl(t,i,n,r,o,s)||Tl(i,e,n,r,o,s)||Tl(n,r,e,t,i,s)||Tl(r,o,e,t,i,s)||Tl(o,n,e,t,i,s))}function Ml(e,t,i){const n=t.paint.get(e).value;return n.kind==="constant"?n.value:i.programConfigurations.get(t.id).getMaxValue(e)}function vh(e){return Math.sqrt(e[0]*e[0]+e[1]*e[1])}function X1(e,t,i,n,r){if(!t[0]&&!t[1])return e;const o=G.convert(t)._mult(r);i==="viewport"&&o._rotate(-n);const s=[];for(let a=0;a<e.length;a++)s.push(e[a].sub(o));return s}function Y1(e,t,i,n){const r=G.convert(e)._mult(n);return t==="viewport"&&r._rotate(-i),r}he(um,"CircleBucket",{omit:["layers"]});const XE=new wn({"circle-sort-key":new ve(rt.layout_circle["circle-sort-key"]),visibility:new Gt(rt.layout_circle.visibility)});var YE={paint:new wn({"circle-radius":new ve(rt.paint_circle["circle-radius"]),"circle-color":new ve(rt.paint_circle["circle-color"]),"circle-blur":new ve(rt.paint_circle["circle-blur"]),"circle-opacity":new ve(rt.paint_circle["circle-opacity"]),"circle-translate":new Gt(rt.paint_circle["circle-translate"]),"circle-translate-anchor":new Gt(rt.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new Gt(rt.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new Gt(rt.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new ve(rt.paint_circle["circle-stroke-width"]),"circle-stroke-color":new ve(rt.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new ve(rt.paint_circle["circle-stroke-opacity"]),"circle-emissive-strength":new Gt(rt.paint_circle["circle-emissive-strength"])}),layout:XE};const KE=st.create(),JE=(e,t,i,n,r,o)=>{const s=e.transform,a=s.projection.name==="globe";let l;if(o.paint.get("circle-pitch-alignment")==="map")if(a){const u=P1(s.zoom,t.canonical)*s._pixelsPerMercatorPixel;l=Float32Array.from([u,0,0,u])}else l=s.calculatePixelsToTileUnitsMatrix(i);else l=new Float32Array([s.pixelsToGLUnits[0],0,0,s.pixelsToGLUnits[1]]);const c={u_camera_to_center_distance:e.transform.getCameraToCenterDistance(s.projection),u_matrix:e.translatePosMatrix(t.projMatrix,i,o.paint.get("circle-translate"),o.paint.get("circle-translate-anchor")),u_device_pixel_ratio:ke.devicePixelRatio,u_extrude_scale:l,u_inv_rot_matrix:KE,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0],u_emissive_strength:o.paint.get("circle-emissive-strength")};if(a){c.u_inv_rot_matrix=n,c.u_merc_center=r,c.u_tile_id=[t.canonical.x,t.canonical.y,1<<t.canonical.z],c.u_zoom_transition=Wn(s.zoom);const u=r[0]*pt,h=r[1]*pt;c.u_up_dir=s.projection.upVector(new Yr(0,0,0),u,h)}return c},K1=e=>{const t=[];return e.paint.get("circle-pitch-alignment")==="map"&&t.push("PITCH_WITH_MAP"),e.paint.get("circle-pitch-scale")==="map"&&t.push("SCALE_WITH_MAP"),t};function J1(e,t,i,n,r,o,s,a,l){if(o&&e.queryGeometry.isAboveHorizon)return!1;o&&(l*=e.pixelToTileUnitsFactor);const c=e.tileID.canonical,u=i.projection.upVectorScale(c,i.center.lat,i.worldSize).metersToTile;for(const h of t)for(const d of h){const p=d.add(a),_=r&&i.elevation?i.elevation.exaggeration()*r.getElevationAt(p.x,p.y,!0):0,g=i.projection.projectTilePoint(p.x,p.y,c);if(_>0){const M=i.projection.upVector(c,p.x,p.y);g.x+=M[0]*u*_,g.y+=M[1]*u*_,g.z+=M[2]*u*_}const y=o?p:QE(g.x,g.y,g.z,n),x=o?e.tilespaceRays.map(M=>eS(M,_)):e.queryGeometry.screenGeometry,b=Ni.transformMat4([],[g.x,g.y,g.z,1],n);if(!s&&o?l*=b[3]/i.cameraToCenterDistance:s&&!o&&(l*=i.cameraToCenterDistance/b[3]),o){const M=On((d.y/pt+c.y)/(1<<c.z));l/=i.projection.pixelsPerMeter(M,1)/Gi(1,M)}if(ZE(x,y,l))return!0}return!1}function QE(e,t,i,n){const r=Ni.transformMat4([],[e,t,i,1],n);return new G(r[0]/r[3],r[1]/r[3])}const Q1=Z.fromValues(0,0,0),tS=Z.fromValues(0,0,1);function eS(e,t){const i=Z.create();return Q1[2]=t,e.intersectsPlane(Q1,tS,i),new G(i[0],i[1])}class tv extends um{}function ev(e,{width:t,height:i},n,r){if(r){if(r instanceof Uint8ClampedArray)r=new Uint8Array(r.buffer);else if(r.length!==t*i*n)throw new RangeError("mismatched image size")}else r=new Uint8Array(t*i*n);return e.width=t,e.height=i,e.data=r,e}function iv(e,t,i){const{width:n,height:r}=t;n===e.width&&r===e.height||(pm(e,t,{x:0,y:0},{x:0,y:0},{width:Math.min(e.width,n),height:Math.min(e.height,r)},i),e.width=n,e.height=r,e.data=t.data)}function pm(e,t,i,n,r,o){if(r.width===0||r.height===0)return t;if(r.width>e.width||r.height>e.height||i.x>e.width-r.width||i.y>e.height-r.height)throw new RangeError("out of range source coordinates for image copy");if(r.width>t.width||r.height>t.height||n.x>t.width-r.width||n.y>t.height-r.height)throw new RangeError("out of range destination coordinates for image copy");const s=e.data,a=t.data;for(let l=0;l<r.height;l++){const c=((i.y+l)*e.width+i.x)*o,u=((n.y+l)*t.width+n.x)*o;for(let h=0;h<r.width*o;h++)a[u+h]=s[c+h]}return t}he(tv,"HeatmapBucket",{omit:["layers"]});class hs{constructor(t,i){ev(this,t,1,i)}resize(t){iv(this,new hs(t),1)}clone(){return new hs({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(t,i,n,r,o){pm(t,i,n,r,o,1)}}class Ln{constructor(t,i){ev(this,t,4,i)}resize(t){iv(this,new Ln(t),4)}replace(t,i){i?this.data.set(t):this.data=t instanceof Uint8ClampedArray?new Uint8Array(t.buffer):t}clone(){return new Ln({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(t,i,n,r,o){pm(t,i,n,r,o,4)}}class nv{constructor(t,i){this.width=t.width,this.height=t.height,this.data=i instanceof Uint8Array?new Float32Array(i.buffer):i}}he(hs,"AlphaImage"),he(Ln,"RGBAImage");const iS=new wn({visibility:new Gt(rt.layout_heatmap.visibility)});var nS={paint:new wn({"heatmap-radius":new ve(rt.paint_heatmap["heatmap-radius"]),"heatmap-weight":new ve(rt.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new Gt(rt.paint_heatmap["heatmap-intensity"]),"heatmap-color":new Ic(rt.paint_heatmap["heatmap-color"]),"heatmap-opacity":new Gt(rt.paint_heatmap["heatmap-opacity"])}),layout:iS};function xh(e){const t={},i=e.resolution||256,n=e.clips?e.clips.length:1,r=e.image||new Ln({width:i,height:n}),o=(s,a,l)=>{t[e.evaluationKey]=l;const c=e.expression.evaluate(t);c&&(r.data[s+a+0]=Math.floor(255*c.r/c.a),r.data[s+a+1]=Math.floor(255*c.g/c.a),r.data[s+a+2]=Math.floor(255*c.b/c.a),r.data[s+a+3]=Math.floor(255*c.a))};if(e.clips)for(let s=0,a=0;s<n;++s,a+=4*i)for(let l=0,c=0;l<i;l++,c+=4){const u=l/(i-1),{start:h,end:d}=e.clips[s];o(a,c,h*(1-u)+d*u)}else for(let s=0,a=0;s<i;s++,a+=4)o(0,a,s/(i-1));return r}const rS=new wn({visibility:new Gt(rt.layout_hillshade.visibility)});var oS={paint:new wn({"hillshade-illumination-direction":new Gt(rt.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new Gt(rt.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new Gt(rt.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new Gt(rt.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new Gt(rt.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new Gt(rt.paint_hillshade["hillshade-accent-color"]),"hillshade-emissive-strength":new Gt(rt.paint_hillshade["hillshade-emissive-strength"])}),layout:rS};const sS=zi([{name:"a_pos",components:2,type:"Int16"}],4),{members:aS}=sS;var mm={exports:{}};function bh(e,t,i){i=i||2;var n,r,o,s,a,l,c,u=t&&t.length,h=u?t[0]*i:e.length,d=rv(e,0,h,i,!0),p=[];if(!d||d.next===d.prev)return p;if(u&&(d=function(g,y,x,b){var M,E,T,S=[];for(M=0,E=y.length;M<E;M++)(T=rv(g,y[M]*b,M<E-1?y[M+1]*b:g.length,b,!1))===T.next&&(T.steiner=!0),S.push(mS(T));for(S.sort(dS),M=0;M<S.length;M++)x=fS(S[M],x);return x}(e,t,d,i)),e.length>80*i){n=o=e[0],r=s=e[1];for(var _=i;_<h;_+=i)(a=e[_])<n&&(n=a),(l=e[_+1])<r&&(r=l),a>o&&(o=a),l>s&&(s=l);c=(c=Math.max(o-n,s-r))!==0?32767/c:0}return Nc(d,p,i,n,r,c,0),p}function rv(e,t,i,n,r){var o,s;if(r===ym(e,t,i,n)>0)for(o=t;o<i;o+=n)s=av(o,e[o],e[o+1],s);else for(o=i-n;o>=t;o-=n)s=av(o,e[o],e[o+1],s);return s&&wh(s,s.next)&&(Vc(s),s=s.next),s}function Pa(e,t){if(!e)return e;t||(t=e);var i,n=e;do if(i=!1,n.steiner||!wh(n,n.next)&&Nn(n.prev,n,n.next)!==0)n=n.next;else{if(Vc(n),(n=t=n.prev)===n.next)break;i=!0}while(i||n!==t);return t}function Nc(e,t,i,n,r,o,s){if(e){!s&&o&&function(u,h,d,p){var _=u;do _.z===0&&(_.z=_m(_.x,_.y,h,d,p)),_.prevZ=_.prev,_.nextZ=_.next,_=_.next;while(_!==u);_.prevZ.nextZ=null,_.prevZ=null,function(g){var y,x,b,M,E,T,S,D,z=1;do{for(x=g,g=null,E=null,T=0;x;){for(T++,b=x,S=0,y=0;y<z&&(S++,b=b.nextZ);y++);for(D=z;S>0||D>0&&b;)S!==0&&(D===0||!b||x.z<=b.z)?(M=x,x=x.nextZ,S--):(M=b,b=b.nextZ,D--),E?E.nextZ=M:g=M,M.prevZ=E,E=M;x=b}E.nextZ=null,z*=2}while(T>1)}(_)}(e,n,r,o);for(var a,l,c=e;e.prev!==e.next;)if(a=e.prev,l=e.next,o?cS(e,n,r,o):lS(e))t.push(a.i/i|0),t.push(e.i/i|0),t.push(l.i/i|0),Vc(e),e=l.next,c=l.next;else if((e=l)===c){s?s===1?Nc(e=uS(Pa(e),t,i),t,i,n,r,o,2):s===2&&hS(e,t,i,n,r,o):Nc(Pa(e),t,i,n,r,o,1);break}}}function lS(e){var t=e.prev,i=e,n=e.next;if(Nn(t,i,n)>=0)return!1;for(var r=t.x,o=i.x,s=n.x,a=t.y,l=i.y,c=n.y,u=r<o?r<s?r:s:o<s?o:s,h=a<l?a<c?a:c:l<c?l:c,d=r>o?r>s?r:s:o>s?o:s,p=a>l?a>c?a:c:l>c?l:c,_=n.next;_!==t;){if(_.x>=u&&_.x<=d&&_.y>=h&&_.y<=p&&El(r,a,o,l,s,c,_.x,_.y)&&Nn(_.prev,_,_.next)>=0)return!1;_=_.next}return!0}function cS(e,t,i,n){var r=e.prev,o=e,s=e.next;if(Nn(r,o,s)>=0)return!1;for(var a=r.x,l=o.x,c=s.x,u=r.y,h=o.y,d=s.y,p=a<l?a<c?a:c:l<c?l:c,_=u<h?u<d?u:d:h<d?h:d,g=a>l?a>c?a:c:l>c?l:c,y=u>h?u>d?u:d:h>d?h:d,x=_m(p,_,t,i,n),b=_m(g,y,t,i,n),M=e.prevZ,E=e.nextZ;M&&M.z>=x&&E&&E.z<=b;){if(M.x>=p&&M.x<=g&&M.y>=_&&M.y<=y&&M!==r&&M!==s&&El(a,u,l,h,c,d,M.x,M.y)&&Nn(M.prev,M,M.next)>=0||(M=M.prevZ,E.x>=p&&E.x<=g&&E.y>=_&&E.y<=y&&E!==r&&E!==s&&El(a,u,l,h,c,d,E.x,E.y)&&Nn(E.prev,E,E.next)>=0))return!1;E=E.nextZ}for(;M&&M.z>=x;){if(M.x>=p&&M.x<=g&&M.y>=_&&M.y<=y&&M!==r&&M!==s&&El(a,u,l,h,c,d,M.x,M.y)&&Nn(M.prev,M,M.next)>=0)return!1;M=M.prevZ}for(;E&&E.z<=b;){if(E.x>=p&&E.x<=g&&E.y>=_&&E.y<=y&&E!==r&&E!==s&&El(a,u,l,h,c,d,E.x,E.y)&&Nn(E.prev,E,E.next)>=0)return!1;E=E.nextZ}return!0}function uS(e,t,i){var n=e;do{var r=n.prev,o=n.next.next;!wh(r,o)&&ov(r,n,n.next,o)&&Uc(r,o)&&Uc(o,r)&&(t.push(r.i/i|0),t.push(n.i/i|0),t.push(o.i/i|0),Vc(n),Vc(n.next),n=e=o),n=n.next}while(n!==e);return Pa(n)}function hS(e,t,i,n,r,o){var s=e;do{for(var a=s.next.next;a!==s.prev;){if(s.i!==a.i&&_S(s,a)){var l=sv(s,a);return s=Pa(s,s.next),l=Pa(l,l.next),Nc(s,t,i,n,r,o,0),void Nc(l,t,i,n,r,o,0)}a=a.next}s=s.next}while(s!==e)}function dS(e,t){return e.x-t.x}function fS(e,t){var i=function(r,o){var s,a=o,l=r.x,c=r.y,u=-1/0;do{if(c<=a.y&&c>=a.next.y&&a.next.y!==a.y){var h=a.x+(c-a.y)*(a.next.x-a.x)/(a.next.y-a.y);if(h<=l&&h>u&&(u=h,s=a.x<a.next.x?a:a.next,h===l))return s}a=a.next}while(a!==o);if(!s)return null;var d,p=s,_=s.x,g=s.y,y=1/0;a=s;do l>=a.x&&a.x>=_&&l!==a.x&&El(c<g?l:u,c,_,g,c<g?u:l,c,a.x,a.y)&&(d=Math.abs(c-a.y)/(l-a.x),Uc(a,r)&&(d<y||d===y&&(a.x>s.x||a.x===s.x&&pS(s,a)))&&(s=a,y=d)),a=a.next;while(a!==p);return s}(e,t);if(!i)return t;var n=sv(i,e);return Pa(n,n.next),Pa(i,i.next)}function pS(e,t){return Nn(e.prev,e,t.prev)<0&&Nn(t.next,e,e.next)<0}function _m(e,t,i,n,r){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-i)*r|0)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-n)*r|0)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function mS(e){var t=e,i=e;do(t.x<i.x||t.x===i.x&&t.y<i.y)&&(i=t),t=t.next;while(t!==e);return i}function El(e,t,i,n,r,o,s,a){return(r-s)*(t-a)>=(e-s)*(o-a)&&(e-s)*(n-a)>=(i-s)*(t-a)&&(i-s)*(o-a)>=(r-s)*(n-a)}function _S(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(i,n){var r=i;do{if(r.i!==i.i&&r.next.i!==i.i&&r.i!==n.i&&r.next.i!==n.i&&ov(r,r.next,i,n))return!0;r=r.next}while(r!==i);return!1}(e,t)&&(Uc(e,t)&&Uc(t,e)&&function(i,n){var r=i,o=!1,s=(i.x+n.x)/2,a=(i.y+n.y)/2;do r.y>a!=r.next.y>a&&r.next.y!==r.y&&s<(r.next.x-r.x)*(a-r.y)/(r.next.y-r.y)+r.x&&(o=!o),r=r.next;while(r!==i);return o}(e,t)&&(Nn(e.prev,e,t.prev)||Nn(e,t.prev,t))||wh(e,t)&&Nn(e.prev,e,e.next)>0&&Nn(t.prev,t,t.next)>0)}function Nn(e,t,i){return(t.y-e.y)*(i.x-t.x)-(t.x-e.x)*(i.y-t.y)}function wh(e,t){return e.x===t.x&&e.y===t.y}function ov(e,t,i,n){var r=Mh(Nn(e,t,i)),o=Mh(Nn(e,t,n)),s=Mh(Nn(i,n,e)),a=Mh(Nn(i,n,t));return r!==o&&s!==a||!(r!==0||!Th(e,i,t))||!(o!==0||!Th(e,n,t))||!(s!==0||!Th(i,e,n))||!(a!==0||!Th(i,t,n))}function Th(e,t,i){return t.x<=Math.max(e.x,i.x)&&t.x>=Math.min(e.x,i.x)&&t.y<=Math.max(e.y,i.y)&&t.y>=Math.min(e.y,i.y)}function Mh(e){return e>0?1:e<0?-1:0}function Uc(e,t){return Nn(e.prev,e,e.next)<0?Nn(e,t,e.next)>=0&&Nn(e,e.prev,t)>=0:Nn(e,t,e.prev)<0||Nn(e,e.next,t)<0}function sv(e,t){var i=new gm(e.i,e.x,e.y),n=new gm(t.i,t.x,t.y),r=e.next,o=t.prev;return e.next=t,t.prev=e,i.next=r,r.prev=i,n.next=i,i.prev=n,o.next=n,n.prev=o,n}function av(e,t,i,n){var r=new gm(e,t,i);return n?(r.next=n.next,r.prev=n,n.next.prev=r,n.next=r):(r.prev=r,r.next=r),r}function Vc(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function gm(e,t,i){this.i=e,this.x=t,this.y=i,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function ym(e,t,i,n){for(var r=0,o=t,s=i-n;o<i;o+=n)r+=(e[s]-e[o])*(e[o+1]+e[s+1]),s=o;return r}mm.exports=bh,mm.exports.default=bh,bh.deviation=function(e,t,i,n){var r=t&&t.length,o=Math.abs(ym(e,0,r?t[0]*i:e.length,i));if(r)for(var s=0,a=t.length;s<a;s++)o-=Math.abs(ym(e,t[s]*i,s<a-1?t[s+1]*i:e.length,i));var l=0;for(s=0;s<n.length;s+=3){var c=n[s]*i,u=n[s+1]*i,h=n[s+2]*i;l+=Math.abs((e[c]-e[h])*(e[u+1]-e[c+1])-(e[c]-e[u])*(e[h+1]-e[c+1]))}return o===0&&l===0?0:Math.abs((l-o)/o)},bh.flatten=function(e){for(var t=e[0][0].length,i={vertices:[],holes:[],dimensions:t},n=0,r=0;r<e.length;r++){for(var o=0;o<e[r].length;o++)for(var s=0;s<t;s++)i.vertices.push(e[r][o][s]);r>0&&i.holes.push(n+=e[r-1].length)}return i};var Eh=dt(mm.exports);function vm(e,t){const i=e.length;if(i<=1)return[e];const n=[];let r,o;for(let s=0;s<i;s++){const a=Ct(e[s]);a!==0&&(e[s].area=Math.abs(a),o===void 0&&(o=a<0),o===a<0?(r&&n.push(r),r=[e[s]]):r.push(e[s]))}if(r&&n.push(r),t>1)for(let s=0;s<n.length;s++)n[s].length<=t||(QT(n[s],t,1,n[s].length-1,gS),n[s]=n[s].slice(0,t));return n}function gS(e,t){return t.area-e.area}function xm(e,t,i){const n=i.patternDependencies;let r=!1;for(const o of t){const s=o.paint.get(`${e}-pattern`);s.isConstant()||(r=!0);const a=s.constantOr(null);a&&(r=!0,n[a]=!0)}return r}function bm(e,t,i,n,r){const o=r.patternDependencies;for(const s of t){const a=s.paint.get(`${e}-pattern`).value;if(a.kind!=="constant"){let l=a.evaluate({zoom:n},i,{},r.availableImages);l=l&&l.name?l.name:l,o[l]=!0,i.patterns[s.id]=l}}return i}class Sh{constructor(t){this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(i=>i.fqid),this.index=t.index,this.hasPattern=!1,this.patternFeatures=[],this.layoutVertexArray=new Tr,this.indexArray=new Rn,this.indexArray2=new Os,this.programConfigurations=new Fs(t.layers,t.zoom),this.segments=new Fi,this.segments2=new Fi,this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.projection=t.projection}populate(t,i,n,r){this.hasPattern=xm("fill",this.layers,i);const o=this.layers[0].layout.get("fill-sort-key"),s=[];for(const{feature:a,id:l,index:c,sourceLayerIndex:u}of t){const h=this.layers[0]._featureFilter.needGeometry,d=Zs(a,h);if(!this.layers[0]._featureFilter.filter(new dn(this.zoom),d,n))continue;const p=o?o.evaluate(d,{},n,i.availableImages):void 0,_={id:l,properties:a.properties,type:a.type,sourceLayerIndex:u,index:c,geometry:h?d.geometry:Po(a,n,r),patterns:{},sortKey:p};s.push(_)}o&&s.sort((a,l)=>a.sortKey-l.sortKey);for(const a of s){const{geometry:l,index:c,sourceLayerIndex:u}=a;if(this.hasPattern){const h=bm("fill",this.layers,a,this.zoom,i);this.patternFeatures.push(h)}else this.addFeature(a,l,c,n,{},i.availableImages,i.brightness);i.featureIndex.insert(t[c].feature,l,c,u,this.index)}}update(t,i,n,r,o){const s=Object.keys(t).length!==0;s&&!this.stateDependentLayers.length||this.programConfigurations.updatePaintArrays(t,i,s?this.stateDependentLayers:this.layers,n,r,o)}addFeatures(t,i,n,r,o,s){for(const a of this.patternFeatures)this.addFeature(a,a.geometry,a.index,i,n,r,s)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(t){this.uploaded||(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,aS),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.indexBuffer2=t.createIndexBuffer(this.indexArray2)),this.programConfigurations.upload(t),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.indexBuffer2.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.segments2.destroy())}addFeature(t,i,n,r,o,s=[],a){for(const l of vm(i,500)){let c=0;for(const g of l)c+=g.length;const u=this.segments.prepareSegment(c,this.layoutVertexArray,this.indexArray),h=u.vertexLength,d=[],p=[];for(const g of l){if(g.length===0)continue;g!==l[0]&&p.push(d.length/2);const y=this.segments2.prepareSegment(g.length,this.layoutVertexArray,this.indexArray2),x=y.vertexLength;this.layoutVertexArray.emplaceBack(g[0].x,g[0].y),this.indexArray2.emplaceBack(x+g.length-1,x),d.push(g[0].x),d.push(g[0].y);for(let b=1;b<g.length;b++)this.layoutVertexArray.emplaceBack(g[b].x,g[b].y),this.indexArray2.emplaceBack(x+b-1,x+b),d.push(g[b].x),d.push(g[b].y);y.vertexLength+=g.length,y.primitiveLength+=g.length}const _=Eh(d,p);for(let g=0;g<_.length;g+=3)this.indexArray.emplaceBack(h+_[g],h+_[g+1],h+_[g+2]);u.vertexLength+=c,u.primitiveLength+=_.length/3}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,n,o,s,r,a)}}he(Sh,"FillBucket",{omit:["layers","patternFeatures"]});const yS=new wn({"fill-sort-key":new ve(rt.layout_fill["fill-sort-key"]),visibility:new Gt(rt.layout_fill.visibility)});var vS={paint:new wn({"fill-antialias":new Gt(rt.paint_fill["fill-antialias"]),"fill-opacity":new ve(rt.paint_fill["fill-opacity"]),"fill-color":new ve(rt.paint_fill["fill-color"]),"fill-outline-color":new ve(rt.paint_fill["fill-outline-color"]),"fill-translate":new Gt(rt.paint_fill["fill-translate"]),"fill-translate-anchor":new Gt(rt.paint_fill["fill-translate-anchor"]),"fill-pattern":new ve(rt.paint_fill["fill-pattern"]),"fill-emissive-strength":new Gt(rt.paint_fill["fill-emissive-strength"])}),layout:yS};const xS=zi([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),bS=zi([{name:"a_pos_end",components:4,type:"Int16"},{name:"a_angular_offset_factor",components:1,type:"Int16"}]),wS=zi([{name:"a_centroid_pos",components:2,type:"Uint16"}]),TS=zi([{name:"a_hidden_by_landmark",components:1,type:"Uint8"}]),MS=zi([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]),{members:ES}=xS;var Ah={},SS=Zt,lv=Sl;function Sl(e,t,i,n,r){this.properties={},this.extent=i,this.type=0,this._pbf=e,this._geometry=-1,this._keys=n,this._values=r,e.readFields(AS,this,t)}function AS(e,t,i){e==1?t.id=i.readVarint():e==2?function(n,r){for(var o=n.readVarint()+n.pos;n.pos<o;){var s=r._keys[n.readVarint()],a=r._values[n.readVarint()];r.properties[s]=a}}(i,t):e==3?t.type=i.readVarint():e==4&&(t._geometry=i.pos)}function IS(e){for(var t,i,n=0,r=0,o=e.length,s=o-1;r<o;s=r++)n+=((i=e[s]).x-(t=e[r]).x)*(t.y+i.y);return n}Sl.types=["Unknown","Point","LineString","Polygon"],Sl.prototype.loadGeometry=function(){var e=this._pbf;e.pos=this._geometry;for(var t,i=e.readVarint()+e.pos,n=1,r=0,o=0,s=0,a=[];e.pos<i;){if(r<=0){var l=e.readVarint();n=7&l,r=l>>3}if(r--,n===1||n===2)o+=e.readSVarint(),s+=e.readSVarint(),n===1&&(t&&a.push(t),t=[]),t.push(new SS(o,s));else{if(n!==7)throw new Error("unknown command "+n);t&&t.push(t[0].clone())}}return t&&a.push(t),a},Sl.prototype.bbox=function(){var e=this._pbf;e.pos=this._geometry;for(var t=e.readVarint()+e.pos,i=1,n=0,r=0,o=0,s=1/0,a=-1/0,l=1/0,c=-1/0;e.pos<t;){if(n<=0){var u=e.readVarint();i=7&u,n=u>>3}if(n--,i===1||i===2)(r+=e.readSVarint())<s&&(s=r),r>a&&(a=r),(o+=e.readSVarint())<l&&(l=o),o>c&&(c=o);else if(i!==7)throw new Error("unknown command "+i)}return[s,l,a,c]},Sl.prototype.toGeoJSON=function(e,t,i){var n,r,o=this.extent*Math.pow(2,i),s=this.extent*e,a=this.extent*t,l=this.loadGeometry(),c=Sl.types[this.type];function u(p){for(var _=0;_<p.length;_++){var g=p[_];p[_]=[360*(g.x+s)/o-180,360/Math.PI*Math.atan(Math.exp((180-360*(g.y+a)/o)*Math.PI/180))-90]}}switch(this.type){case 1:var h=[];for(n=0;n<l.length;n++)h[n]=l[n][0];u(l=h);break;case 2:for(n=0;n<l.length;n++)u(l[n]);break;case 3:for(l=function(p){var _=p.length;if(_<=1)return[p];for(var g,y,x=[],b=0;b<_;b++){var M=IS(p[b]);M!==0&&(y===void 0&&(y=M<0),y===M<0?(g&&x.push(g),g=[p[b]]):g.push(p[b]))}return g&&x.push(g),x}(l),n=0;n<l.length;n++)for(r=0;r<l[n].length;r++)u(l[n][r])}l.length===1?l=l[0]:c="Multi"+c;var d={type:"Feature",geometry:{type:c,coordinates:l},properties:this.properties};return"id"in this&&(d.id=this.id),d};var CS=lv,cv=uv;function uv(e,t){this.version=1,this.name=null,this.extent=4096,this.length=0,this._pbf=e,this._keys=[],this._values=[],this._features=[],e.readFields(DS,this,t),this.length=this._features.length}function DS(e,t,i){e===15?t.version=i.readVarint():e===1?t.name=i.readString():e===5?t.extent=i.readVarint():e===2?t._features.push(i.pos):e===3?t._keys.push(i.readString()):e===4&&t._values.push(function(n){for(var r=null,o=n.readVarint()+n.pos;n.pos<o;){var s=n.readVarint()>>3;r=s===1?n.readString():s===2?n.readFloat():s===3?n.readDouble():s===4?n.readVarint64():s===5?n.readVarint():s===6?n.readSVarint():s===7?n.readBoolean():null}return r}(i))}uv.prototype.feature=function(e){if(e<0||e>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[e];var t=this._pbf.readVarint()+this._pbf.pos;return new CS(this._pbf,t,this.extent,this._keys,this._values)};var PS=cv;function kS(e,t,i){if(e===3){var n=new PS(i,i.readVarint()+i.pos);n.length&&(t[n.name]=n)}}var wm=Ah.VectorTile=function(e,t){this.layers=e.readFields(kS,{},t)},Ih=Ah.VectorTileFeature=lv;function Ch(e,t,i,n){const r=[],o=n===0?(s,a,l,c,u,h)=>{s.push(new G(h,l+(h-a)/(c-a)*(u-l)))}:(s,a,l,c,u,h)=>{s.push(new G(a+(h-l)/(u-l)*(c-a),h))};for(const s of e){const a=[];for(const l of s){if(l.length<=2)continue;const c=[];for(let d=0;d<l.length-1;d++){const p=l[d].x,_=l[d].y,g=l[d+1].x,y=l[d+1].y,x=n===0?p:_,b=n===0?g:y;x<t?b>t&&o(c,p,_,g,y,t):x>i?b<i&&o(c,p,_,g,y,i):c.push(l[d]),b<t&&x>=t&&o(c,p,_,g,y,t),b>i&&x<=i&&o(c,p,_,g,y,i)}let u=l[l.length-1];const h=n===0?u.x:u.y;h>=t&&h<=i&&c.push(u),c.length&&(u=c[c.length-1],c[0].x===u.x&&c[0].y===u.y||c.push(c[0]),a.push(c))}a.length&&r.push(a)}return r}Ah.VectorTileLayer=cv;class hv{constructor(t){this._stringToNumber={},this._numberToString=[];for(let i=0;i<t.length;i++){const n=t[i];this._stringToNumber[n]=i,this._numberToString[i]=n}}encode(t){return this._stringToNumber[t]}decode(t){return this._numberToString[t]}}var zS={read:function(e,t,i,n,r){var o,s,a=8*r-n-1,l=(1<<a)-1,c=l>>1,u=-7,h=i?r-1:0,d=i?-1:1,p=e[t+h];for(h+=d,o=p&(1<<-u)-1,p>>=-u,u+=a;u>0;o=256*o+e[t+h],h+=d,u-=8);for(s=o&(1<<-u)-1,o>>=-u,u+=n;u>0;s=256*s+e[t+h],h+=d,u-=8);if(o===0)o=1-c;else{if(o===l)return s?NaN:1/0*(p?-1:1);s+=Math.pow(2,n),o-=c}return(p?-1:1)*s*Math.pow(2,o-n)},write:function(e,t,i,n,r,o){var s,a,l,c=8*o-r-1,u=(1<<c)-1,h=u>>1,d=r===23?Math.pow(2,-24)-Math.pow(2,-77):0,p=n?0:o-1,_=n?1:-1,g=t<0||t===0&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,s=u):(s=Math.floor(Math.log(t)/Math.LN2),t*(l=Math.pow(2,-s))<1&&(s--,l*=2),(t+=s+h>=1?d/l:d*Math.pow(2,1-h))*l>=2&&(s++,l/=2),s+h>=u?(a=0,s=u):s+h>=1?(a=(t*l-1)*Math.pow(2,r),s+=h):(a=t*Math.pow(2,h-1)*Math.pow(2,r),s=0));r>=8;e[i+p]=255&a,p+=_,a/=256,r-=8);for(s=s<<r|a,c+=r;c>0;e[i+p]=255&s,p+=_,s/=256,c-=8);e[i+p-_]|=128*g}},dv=cn,Dh=zS;function cn(e){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(e)?e:new Uint8Array(e||0),this.pos=0,this.type=0,this.length=this.buf.length}cn.Varint=0,cn.Fixed64=1,cn.Bytes=2,cn.Fixed32=5;var Tm=4294967296,fv=1/Tm,pv=typeof TextDecoder>"u"?null:new TextDecoder("utf8");function ds(e){return e.type===cn.Bytes?e.readVarint()+e.pos:e.pos+1}function Al(e,t,i){return i?4294967296*t+(e>>>0):4294967296*(t>>>0)+(e>>>0)}function mv(e,t,i){var n=t<=16383?1:t<=2097151?2:t<=268435455?3:Math.floor(Math.log(t)/(7*Math.LN2));i.realloc(n);for(var r=i.pos-1;r>=e;r--)i.buf[r+n]=i.buf[r]}function LS(e,t){for(var i=0;i<e.length;i++)t.writeVarint(e[i])}function RS(e,t){for(var i=0;i<e.length;i++)t.writeSVarint(e[i])}function OS(e,t){for(var i=0;i<e.length;i++)t.writeFloat(e[i])}function BS(e,t){for(var i=0;i<e.length;i++)t.writeDouble(e[i])}function FS(e,t){for(var i=0;i<e.length;i++)t.writeBoolean(e[i])}function NS(e,t){for(var i=0;i<e.length;i++)t.writeFixed32(e[i])}function US(e,t){for(var i=0;i<e.length;i++)t.writeSFixed32(e[i])}function VS(e,t){for(var i=0;i<e.length;i++)t.writeFixed64(e[i])}function jS(e,t){for(var i=0;i<e.length;i++)t.writeSFixed64(e[i])}function Ph(e,t){return(e[t]|e[t+1]<<8|e[t+2]<<16)+16777216*e[t+3]}function Il(e,t,i){e[i]=t,e[i+1]=t>>>8,e[i+2]=t>>>16,e[i+3]=t>>>24}function _v(e,t){return(e[t]|e[t+1]<<8|e[t+2]<<16)+(e[t+3]<<24)}cn.prototype={destroy:function(){this.buf=null},readFields:function(e,t,i){for(i=i||this.length;this.pos<i;){var n=this.readVarint(),r=n>>3,o=this.pos;this.type=7&n,e(r,t,this),this.pos===o&&this.skip(n)}return t},readMessage:function(e,t){return this.readFields(e,t,this.readVarint()+this.pos)},readFixed32:function(){var e=Ph(this.buf,this.pos);return this.pos+=4,e},readSFixed32:function(){var e=_v(this.buf,this.pos);return this.pos+=4,e},readFixed64:function(){var e=Ph(this.buf,this.pos)+Ph(this.buf,this.pos+4)*Tm;return this.pos+=8,e},readSFixed64:function(){var e=Ph(this.buf,this.pos)+_v(this.buf,this.pos+4)*Tm;return this.pos+=8,e},readFloat:function(){var e=Dh.read(this.buf,this.pos,!0,23,4);return this.pos+=4,e},readDouble:function(){var e=Dh.read(this.buf,this.pos,!0,52,8);return this.pos+=8,e},readVarint:function(e){var t,i,n=this.buf;return t=127&(i=n[this.pos++]),i<128?t:(t|=(127&(i=n[this.pos++]))<<7,i<128?t:(t|=(127&(i=n[this.pos++]))<<14,i<128?t:(t|=(127&(i=n[this.pos++]))<<21,i<128?t:function(r,o,s){var a,l,c=s.buf;if(a=(112&(l=c[s.pos++]))>>4,l<128||(a|=(127&(l=c[s.pos++]))<<3,l<128)||(a|=(127&(l=c[s.pos++]))<<10,l<128)||(a|=(127&(l=c[s.pos++]))<<17,l<128)||(a|=(127&(l=c[s.pos++]))<<24,l<128)||(a|=(1&(l=c[s.pos++]))<<31,l<128))return Al(r,a,o);throw new Error("Expected varint not more than 10 bytes")}(t|=(15&(i=n[this.pos]))<<28,e,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var e=this.readVarint();return e%2==1?(e+1)/-2:e/2},readBoolean:function(){return!!this.readVarint()},readString:function(){var e=this.readVarint()+this.pos,t=this.pos;return this.pos=e,e-t>=12&&pv?function(i,n,r){return pv.decode(i.subarray(n,r))}(this.buf,t,e):function(i,n,r){for(var o="",s=n;s<r;){var a,l,c,u=i[s],h=null,d=u>239?4:u>223?3:u>191?2:1;if(s+d>r)break;d===1?u<128&&(h=u):d===2?(192&(a=i[s+1]))==128&&(h=(31&u)<<6|63&a)<=127&&(h=null):d===3?(l=i[s+2],(192&(a=i[s+1]))==128&&(192&l)==128&&((h=(15&u)<<12|(63&a)<<6|63&l)<=2047||h>=55296&&h<=57343)&&(h=null)):d===4&&(l=i[s+2],c=i[s+3],(192&(a=i[s+1]))==128&&(192&l)==128&&(192&c)==128&&((h=(15&u)<<18|(63&a)<<12|(63&l)<<6|63&c)<=65535||h>=1114112)&&(h=null)),h===null?(h=65533,d=1):h>65535&&(h-=65536,o+=String.fromCharCode(h>>>10&1023|55296),h=56320|1023&h),o+=String.fromCharCode(h),s+=d}return o}(this.buf,t,e)},readBytes:function(){var e=this.readVarint()+this.pos,t=this.buf.subarray(this.pos,e);return this.pos=e,t},readPackedVarint:function(e,t){if(this.type!==cn.Bytes)return e.push(this.readVarint(t));var i=ds(this);for(e=e||[];this.pos<i;)e.push(this.readVarint(t));return e},readPackedSVarint:function(e){if(this.type!==cn.Bytes)return e.push(this.readSVarint());var t=ds(this);for(e=e||[];this.pos<t;)e.push(this.readSVarint());return e},readPackedBoolean:function(e){if(this.type!==cn.Bytes)return e.push(this.readBoolean());var t=ds(this);for(e=e||[];this.pos<t;)e.push(this.readBoolean());return e},readPackedFloat:function(e){if(this.type!==cn.Bytes)return e.push(this.readFloat());var t=ds(this);for(e=e||[];this.pos<t;)e.push(this.readFloat());return e},readPackedDouble:function(e){if(this.type!==cn.Bytes)return e.push(this.readDouble());var t=ds(this);for(e=e||[];this.pos<t;)e.push(this.readDouble());return e},readPackedFixed32:function(e){if(this.type!==cn.Bytes)return e.push(this.readFixed32());var t=ds(this);for(e=e||[];this.pos<t;)e.push(this.readFixed32());return e},readPackedSFixed32:function(e){if(this.type!==cn.Bytes)return e.push(this.readSFixed32());var t=ds(this);for(e=e||[];this.pos<t;)e.push(this.readSFixed32());return e},readPackedFixed64:function(e){if(this.type!==cn.Bytes)return e.push(this.readFixed64());var t=ds(this);for(e=e||[];this.pos<t;)e.push(this.readFixed64());return e},readPackedSFixed64:function(e){if(this.type!==cn.Bytes)return e.push(this.readSFixed64());var t=ds(this);for(e=e||[];this.pos<t;)e.push(this.readSFixed64());return e},skip:function(e){var t=7&e;if(t===cn.Varint)for(;this.buf[this.pos++]>127;);else if(t===cn.Bytes)this.pos=this.readVarint()+this.pos;else if(t===cn.Fixed32)this.pos+=4;else{if(t!==cn.Fixed64)throw new Error("Unimplemented type: "+t);this.pos+=8}},writeTag:function(e,t){this.writeVarint(e<<3|t)},realloc:function(e){for(var t=this.length||16;t<this.pos+e;)t*=2;if(t!==this.length){var i=new Uint8Array(t);i.set(this.buf),this.buf=i,this.length=t}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(e){this.realloc(4),Il(this.buf,e,this.pos),this.pos+=4},writeSFixed32:function(e){this.realloc(4),Il(this.buf,e,this.pos),this.pos+=4},writeFixed64:function(e){this.realloc(8),Il(this.buf,-1&e,this.pos),Il(this.buf,Math.floor(e*fv),this.pos+4),this.pos+=8},writeSFixed64:function(e){this.realloc(8),Il(this.buf,-1&e,this.pos),Il(this.buf,Math.floor(e*fv),this.pos+4),this.pos+=8},writeVarint:function(e){(e=+e||0)>268435455||e<0?function(t,i){var n,r;if(t>=0?(n=t%4294967296|0,r=t/4294967296|0):(r=~(-t/4294967296),4294967295^(n=~(-t%4294967296))?n=n+1|0:(n=0,r=r+1|0)),t>=18446744073709552e3||t<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");i.realloc(10),function(o,s,a){a.buf[a.pos++]=127&o|128,o>>>=7,a.buf[a.pos++]=127&o|128,o>>>=7,a.buf[a.pos++]=127&o|128,o>>>=7,a.buf[a.pos++]=127&o|128,a.buf[a.pos]=127&(o>>>=7)}(n,0,i),function(o,s){var a=(7&o)<<4;s.buf[s.pos++]|=a|((o>>>=3)?128:0),o&&(s.buf[s.pos++]=127&o|((o>>>=7)?128:0),o&&(s.buf[s.pos++]=127&o|((o>>>=7)?128:0),o&&(s.buf[s.pos++]=127&o|((o>>>=7)?128:0),o&&(s.buf[s.pos++]=127&o|((o>>>=7)?128:0),o&&(s.buf[s.pos++]=127&o)))))}(r,i)}(e,this):(this.realloc(4),this.buf[this.pos++]=127&e|(e>127?128:0),e<=127||(this.buf[this.pos++]=127&(e>>>=7)|(e>127?128:0),e<=127||(this.buf[this.pos++]=127&(e>>>=7)|(e>127?128:0),e<=127||(this.buf[this.pos++]=e>>>7&127))))},writeSVarint:function(e){this.writeVarint(e<0?2*-e-1:2*e)},writeBoolean:function(e){this.writeVarint(!!e)},writeString:function(e){e=String(e),this.realloc(4*e.length),this.pos++;var t=this.pos;this.pos=function(n,r,o){for(var s,a,l=0;l<r.length;l++){if((s=r.charCodeAt(l))>55295&&s<57344){if(!a){s>56319||l+1===r.length?(n[o++]=239,n[o++]=191,n[o++]=189):a=s;continue}if(s<56320){n[o++]=239,n[o++]=191,n[o++]=189,a=s;continue}s=a-55296<<10|s-56320|65536,a=null}else a&&(n[o++]=239,n[o++]=191,n[o++]=189,a=null);s<128?n[o++]=s:(s<2048?n[o++]=s>>6|192:(s<65536?n[o++]=s>>12|224:(n[o++]=s>>18|240,n[o++]=s>>12&63|128),n[o++]=s>>6&63|128),n[o++]=63&s|128)}return o}(this.buf,e,this.pos);var i=this.pos-t;i>=128&&mv(t,i,this),this.pos=t-1,this.writeVarint(i),this.pos+=i},writeFloat:function(e){this.realloc(4),Dh.write(this.buf,e,this.pos,!0,23,4),this.pos+=4},writeDouble:function(e){this.realloc(8),Dh.write(this.buf,e,this.pos,!0,52,8),this.pos+=8},writeBytes:function(e){var t=e.length;this.writeVarint(t),this.realloc(t);for(var i=0;i<t;i++)this.buf[this.pos++]=e[i]},writeRawMessage:function(e,t){this.pos++;var i=this.pos;e(t,this);var n=this.pos-i;n>=128&&mv(i,n,this),this.pos=i-1,this.writeVarint(n),this.pos+=n},writeMessage:function(e,t,i){this.writeTag(e,cn.Bytes),this.writeRawMessage(t,i)},writePackedVarint:function(e,t){t.length&&this.writeMessage(e,LS,t)},writePackedSVarint:function(e,t){t.length&&this.writeMessage(e,RS,t)},writePackedBoolean:function(e,t){t.length&&this.writeMessage(e,FS,t)},writePackedFloat:function(e,t){t.length&&this.writeMessage(e,OS,t)},writePackedDouble:function(e,t){t.length&&this.writeMessage(e,BS,t)},writePackedFixed32:function(e,t){t.length&&this.writeMessage(e,NS,t)},writePackedSFixed32:function(e,t){t.length&&this.writeMessage(e,US,t)},writePackedFixed64:function(e,t){t.length&&this.writeMessage(e,VS,t)},writePackedSFixed64:function(e,t){t.length&&this.writeMessage(e,jS,t)},writeBytesField:function(e,t){this.writeTag(e,cn.Bytes),this.writeBytes(t)},writeFixed32Field:function(e,t){this.writeTag(e,cn.Fixed32),this.writeFixed32(t)},writeSFixed32Field:function(e,t){this.writeTag(e,cn.Fixed32),this.writeSFixed32(t)},writeFixed64Field:function(e,t){this.writeTag(e,cn.Fixed64),this.writeFixed64(t)},writeSFixed64Field:function(e,t){this.writeTag(e,cn.Fixed64),this.writeSFixed64(t)},writeVarintField:function(e,t){this.writeTag(e,cn.Varint),this.writeVarint(t)},writeSVarintField:function(e,t){this.writeTag(e,cn.Varint),this.writeSVarint(t)},writeStringField:function(e,t){this.writeTag(e,cn.Bytes),this.writeString(t)},writeFloatField:function(e,t){this.writeTag(e,cn.Fixed32),this.writeFloat(t)},writeDoubleField:function(e,t){this.writeTag(e,cn.Fixed64),this.writeDouble(t)},writeBooleanField:function(e,t){this.writeVarintField(e,!!t)}};var kh=dt(dv);const GS=["tile","layer","source","sourceLayer","state"];class gv{constructor(t,i,n,r,o){this.type="Feature",this._vectorTileFeature=t,this._z=i,this._x=n,this._y=r,this.properties=t.properties,this.id=o}get geometry(){return this._geometry===void 0&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._x,this._y,this._z).geometry),this._geometry}set geometry(t){this._geometry=t}toJSON(){const t={type:"Feature",state:void 0,geometry:this.geometry,properties:this.properties};this.id!==void 0&&(t.id=this.id);for(const i of GS)this[i]!==void 0&&(t[i]=this[i]);return t}}class qS{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(t,i,n){const r=String(i);if(this.stateChanges[t]=this.stateChanges[t]||{},this.stateChanges[t][r]=this.stateChanges[t][r]||{},Vt(this.stateChanges[t][r],n),this.deletedStates[t]===null){this.deletedStates[t]={};for(const o in this.state[t])o!==r&&(this.deletedStates[t][o]=null)}else if(this.deletedStates[t]&&this.deletedStates[t][r]===null){this.deletedStates[t][r]={};for(const o in this.state[t][r])n[o]||(this.deletedStates[t][r][o]=null)}else for(const o in n)this.deletedStates[t]&&this.deletedStates[t][r]&&this.deletedStates[t][r][o]===null&&delete this.deletedStates[t][r][o]}removeFeatureState(t,i,n){if(this.deletedStates[t]===null)return;const r=String(i);if(this.deletedStates[t]=this.deletedStates[t]||{},n&&i!==void 0)this.deletedStates[t][r]!==null&&(this.deletedStates[t][r]=this.deletedStates[t][r]||{},this.deletedStates[t][r][n]=null);else if(i!==void 0)if(this.stateChanges[t]&&this.stateChanges[t][r])for(n in this.deletedStates[t][r]={},this.stateChanges[t][r])this.deletedStates[t][r][n]=null;else this.deletedStates[t][r]=null;else this.deletedStates[t]=null}getState(t,i){const n=String(i),r=Vt({},(this.state[t]||{})[n],(this.stateChanges[t]||{})[n]);if(this.deletedStates[t]===null)return{};if(this.deletedStates[t]){const o=this.deletedStates[t][i];if(o===null)return{};for(const s in o)delete r[s]}return r}initializeTileState(t,i){t.setFeatureState(this.state,i)}coalesceChanges(t,i){const n={};for(const r in this.stateChanges){this.state[r]=this.state[r]||{};const o={};for(const s in this.stateChanges[r])this.state[r][s]||(this.state[r][s]={}),Vt(this.state[r][s],this.stateChanges[r][s]),o[s]=this.state[r][s];n[r]=o}for(const r in this.deletedStates){this.state[r]=this.state[r]||{};const o={};if(this.deletedStates[r]===null)for(const s in this.state[r])o[s]={},this.state[r][s]={};else for(const s in this.deletedStates[r]){if(this.deletedStates[r][s]===null)this.state[r][s]={};else if(this.state[r][s])for(const a of Object.keys(this.deletedStates[r][s]))delete this.state[r][s][a];o[s]=this.state[r][s]}n[r]=n[r]||{},Vt(n[r],o)}if(this.stateChanges={},this.deletedStates={},Object.keys(n).length!==0)for(const r in t)t[r].setFeatureState(n,i)}}class yv{constructor(t){this.size=t,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(t,i){const n=this.toIdx(t,i);return{min:this.minimums[n],max:this.maximums[n]}}isLeaf(t,i){return this.leaves[this.toIdx(t,i)]}toIdx(t,i){return i*this.size+t}}function vv(e,t,i,n){let r=0,o=Number.MAX_VALUE;for(let s=0;s<3;s++)if(Math.abs(n[s])<1e-15){if(i[s]<e[s]||i[s]>t[s])return null}else{const a=1/n[s];let l=(e[s]-i[s])*a,c=(t[s]-i[s])*a;if(l>c){const u=l;l=c,c=u}if(l>r&&(r=l),c<o&&(o=c),r>o)return null}return r}function xv(e,t,i,n,r,o,s,a,l,c,u){const h=n-e,d=r-t,p=o-i,_=s-e,g=a-t,y=l-i,x=u[1]*y-u[2]*g,b=u[2]*_-u[0]*y,M=u[0]*g-u[1]*_,E=h*x+d*b+p*M;if(Math.abs(E)<1e-15)return null;const T=1/E,S=c[0]-e,D=c[1]-t,z=c[2]-i,L=(S*x+D*b+z*M)*T;if(L<0||L>1)return null;const R=D*p-z*d,N=z*h-S*p,U=S*d-D*h,H=(u[0]*R+u[1]*N+u[2]*U)*T;return H<0||L+H>1?null:(_*R+g*N+y*U)*T}function bv(e,t,i){return(e-t)/(i-t)}function wv(e,t,i,n,r,o,s,a,l){const c=1<<i,u=o-n,h=s-r,d=(e+1)/c*u+n,p=(t+0)/c*h+r,_=(t+1)/c*h+r;a[0]=(e+0)/c*u+n,a[1]=p,l[0]=d,l[1]=_}class Tv{constructor(t){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=t,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;const i=function(o){const s=Math.ceil(Math.log2(o.dim/8)),a=[];let l=Math.ceil(Math.pow(2,s));const c=1/l,u=(p,_,g,y,x)=>{const b=y?1:0,M=(p+1)*g-b,E=_*g,T=(_+1)*g-b;x[0]=p*g,x[1]=E,x[2]=M,x[3]=T};let h=new yv(l);const d=[];for(let p=0;p<l*l;p++){u(p%l,Math.floor(p/l),c,!1,d);const _=Ws(d[0],d[1],o),g=Ws(d[2],d[1],o),y=Ws(d[2],d[3],o),x=Ws(d[0],d[3],o);h.minimums.push(Math.min(_,g,y,x)),h.maximums.push(Math.max(_,g,y,x)),h.leaves.push(1)}for(a.push(h),l/=2;l>=1;l/=2){const p=a[a.length-1];h=new yv(l);for(let _=0;_<l*l;_++){u(_%l,Math.floor(_/l),2,!0,d);const g=p.getElevation(d[0],d[1]),y=p.getElevation(d[2],d[1]),x=p.getElevation(d[2],d[3]),b=p.getElevation(d[0],d[3]),M=p.isLeaf(d[0],d[1]),E=p.isLeaf(d[2],d[1]),T=p.isLeaf(d[2],d[3]),S=p.isLeaf(d[0],d[3]),D=Math.min(g.min,y.min,x.min,b.min),z=Math.max(g.max,y.max,x.max,b.max),L=M&&E&&T&&S;h.maximums.push(z),h.minimums.push(D),h.leaves.push(z-D<=5&&L?1:0)}a.push(h)}return a}(this.dem),n=i.length-1,r=i[n];this._addNode(r.minimums[0],r.maximums[0],r.leaves[0]),this._construct(i,0,0,n,0)}raycastRoot(t,i,n,r,o,s,a=1){return vv([t,i,-100],[n,r,this.maximums[0]*a],o,s)}raycast(t,i,n,r,o,s,a=1){if(!this.nodeCount)return null;const l=this.raycastRoot(t,i,n,r,o,s,a);if(l==null)return null;const c=[],u=[],h=[],d=[],p=[{idx:0,t:l,nodex:0,nodey:0,depth:0}];for(;p.length>0;){const{idx:_,t:g,nodex:y,nodey:x,depth:b}=p.pop();if(this.leaves[_]){wv(y,x,b,t,i,n,r,h,d);const E=1<<b,T=(y+0)/E,S=(y+1)/E,D=(x+0)/E,z=(x+1)/E,L=Ws(T,D,this.dem)*a,R=Ws(S,D,this.dem)*a,N=Ws(S,z,this.dem)*a,U=Ws(T,z,this.dem)*a,H=xv(h[0],h[1],L,d[0],h[1],R,d[0],d[1],N,o,s),O=xv(d[0],d[1],N,h[0],d[1],U,h[0],h[1],L,o,s),X=Math.min(H!==null?H:Number.MAX_VALUE,O!==null?O:Number.MAX_VALUE);if(X!==Number.MAX_VALUE)return X;{const K=Z.scaleAndAdd([],o,s,g);if(Mv(L,R,U,N,bv(K[0],h[0],d[0]),bv(K[1],h[1],d[1]))>=K[2])return g}continue}let M=0;for(let E=0;E<this._siblingOffset.length;E++){wv((y<<1)+this._siblingOffset[E][0],(x<<1)+this._siblingOffset[E][1],b+1,t,i,n,r,h,d),h[2]=-100,d[2]=this.maximums[this.childOffsets[_]+E]*a;const T=vv(h,d,o,s);if(T!=null){const S=T;c[E]=S;let D=!1;for(let z=0;z<M&&!D;z++)S>=c[u[z]]&&(u.splice(z,0,E),D=!0);D||(u[M]=E),M++}}for(let E=0;E<M;E++){const T=u[E];p.push({idx:this.childOffsets[_]+T,t:c[T],nodex:(y<<1)+this._siblingOffset[T][0],nodey:(x<<1)+this._siblingOffset[T][1],depth:b+1})}}return null}_addNode(t,i,n){return this.minimums.push(t),this.maximums.push(i),this.leaves.push(n),this.childOffsets.push(0),this.nodeCount++}_construct(t,i,n,r,o){if(t[r].isLeaf(i,n)===1)return;this.childOffsets[o]||(this.childOffsets[o]=this.nodeCount);const s=r-1,a=t[s];let l=0,c=0;for(let u=0;u<this._siblingOffset.length;u++){const h=2*i+this._siblingOffset[u][0],d=2*n+this._siblingOffset[u][1],p=a.getElevation(h,d),_=a.isLeaf(h,d),g=this._addNode(p.min,p.max,_);_&&(l|=1<<u),c||(c=g)}for(let u=0;u<this._siblingOffset.length;u++)l&1<<u||this._construct(t,2*i+this._siblingOffset[u][0],2*n+this._siblingOffset[u][1],s,c+u)}}function Mv(e,t,i,n,r,o){return ze(ze(e,i,o),ze(t,n,o),r)}function Ws(e,t,i){const n=i.dim,r=Lt(e*n-.5,0,n-1),o=Lt(t*n-.5,0,n-1),s=Math.floor(r),a=Math.floor(o),l=Math.min(s+1,n-1),c=Math.min(a+1,n-1);return Mv(i.get(s,a),i.get(l,a),i.get(s,c),i.get(l,c),r-s,o-a)}const ZS={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};function HS(e,t,i){return(256*e*256+256*t+i)/10-1e4}function WS(e,t,i){return 256*e+t+i/256-32768}class zh{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(t,i,n,r=!1){if(this.uid=t,i.height!==i.width)throw new RangeError("DEM tiles must be square");if(n&&n!=="mapbox"&&n!=="terrarium")return J(`"${n}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=i.height;const o=this.dim=i.height-2,s=new Uint32Array(i.data.buffer);if(this.pixels=new Uint8Array(i.data.buffer),this.floatView=new Float32Array(i.data.buffer),this.borderReady=r,this._modifiedForSources={},!r){for(let l=0;l<o;l++)s[this._idx(-1,l)]=s[this._idx(0,l)],s[this._idx(o,l)]=s[this._idx(o-1,l)],s[this._idx(l,-1)]=s[this._idx(l,0)],s[this._idx(l,o)]=s[this._idx(l,o-1)];s[this._idx(-1,-1)]=s[this._idx(0,0)],s[this._idx(o,-1)]=s[this._idx(o-1,0)],s[this._idx(-1,o)]=s[this._idx(0,o-1)],s[this._idx(o,o)]=s[this._idx(o-1,o-1)]}const a=n==="terrarium"?WS:HS;for(let l=0;l<s.length;++l){const c=4*l;this.floatView[l]=a(this.pixels[c],this.pixels[c+1],this.pixels[c+2])}this._timestamp=ke.now()}_buildQuadTree(){this._tree=new Tv(this)}get(t,i,n=!1){n&&(t=Lt(t,-1,this.dim),i=Lt(i,-1,this.dim));const r=this._idx(t,i);return this.floatView[r]}set(t,i,n){const r=this._idx(t,i),o=this.floatView[r];return this.floatView[r]=n,n-o}static getUnpackVector(t){return ZS[t]}_idx(t,i){if(t<-1||t>=this.dim+1||i<-1||i>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(i+1)*this.stride+(t+1)}static pack(t,i){const n=[0,0,0,0],r=zh.getUnpackVector(i);let o=Math.floor((t+r[3])/r[2]);return n[2]=o%256,o=Math.floor(o/256),n[1]=o%256,o=Math.floor(o/256),n[0]=o,n}getPixels(){return new nv({width:this.stride,height:this.stride},this.pixels)}backfillBorder(t,i,n){if(this.dim!==t.dim)throw new Error("dem dimension mismatch");let r=i*this.dim,o=i*this.dim+this.dim,s=n*this.dim,a=n*this.dim+this.dim;switch(i){case-1:r=o-1;break;case 1:o=r+1}switch(n){case-1:s=a-1;break;case 1:a=s+1}const l=-i*this.dim,c=-n*this.dim;for(let u=s;u<a;u++)for(let h=r;h<o;h++){const d=4*this._idx(h,u),p=4*this._idx(h+l,u+c);this.pixels[d+0]=t.pixels[p+0],this.pixels[d+1]=t.pixels[p+1],this.pixels[d+2]=t.pixels[p+2],this.pixels[d+3]=t.pixels[p+3]}}onDeserialize(){this._tree&&(this._tree.dem=this)}}he(zh,"DEMData"),he(Tv,"DemMinMaxQuadTree",{omit:["dem"]});class $S{isDataAvailableAtPoint(t){const i=this._source();if(this.isUsingMockSource()||!i||t.y<0||t.y>1)return!1;const n=i.getSource().maxzoom,r=1<<n,o=Math.floor(t.x),s=Math.floor((t.x-o)*r),a=Math.floor(t.y*r),l=this.findDEMTileFor(new Si(n,o,n,s,a));return!(!l||!l.dem)}getAtPointOrZero(t,i=0){return this.getAtPoint(t,i)||0}getAtPoint(t,i,n=!0){if(this.isUsingMockSource())return null;i==null&&(i=null);const r=this._source();if(!r||t.y<0||t.y>1)return i;const o=r.getSource().maxzoom,s=1<<o,a=Math.floor(t.x),l=t.x-a,c=new Si(o,a,o,Math.floor(l*s),Math.floor(t.y*s)),u=this.findDEMTileFor(c);if(!u||!u.dem)return i;const h=u.dem,d=1<<u.tileID.canonical.z,p=(l*d-u.tileID.canonical.x)*h.dim,_=(t.y*d-u.tileID.canonical.y)*h.dim,g=Math.floor(p),y=Math.floor(_);return(n?this.exaggeration():1)*ze(ze(h.get(g,y),h.get(g,y+1),_-y),ze(h.get(g+1,y),h.get(g+1,y+1),_-y),p-g)}getAtTileOffset(t,i,n){const r=1<<t.canonical.z;return this.getAtPointOrZero(new ui(t.wrap+(t.canonical.x+i/pt)/r,(t.canonical.y+n/pt)/r))}getAtTileOffsetFunc(t,i,n,r){return o=>{const s=this.getAtTileOffset(t,o.x,o.y),a=r.upVector(t.canonical,o.x,o.y),l=r.upVectorScale(t.canonical,i,n).metersToTile;return Z.scale(a,a,s*l),a}}getForTilePoints(t,i,n,r){if(this.isUsingMockSource())return!1;const o=Cl.create(this,t,r);return!!o&&(i.forEach(s=>{s[2]=this.exaggeration()*o.getElevationAt(s[0],s[1],n)}),!0)}getMinMaxForTile(t){if(this.isUsingMockSource())return null;const i=this.findDEMTileFor(t);if(!i||!i.dem)return null;const n=i.dem.tree,r=i.tileID,o=1<<t.canonical.z-r.canonical.z;let s=t.canonical.x/o-r.canonical.x,a=t.canonical.y/o-r.canonical.y,l=0;for(let c=0;c<t.canonical.z-r.canonical.z&&!n.leaves[l];c++){s*=2,a*=2;const u=2*Math.floor(a)+Math.floor(s);l=n.childOffsets[l]+u,s%=1,a%=1}return{min:this.exaggeration()*n.minimums[l],max:this.exaggeration()*n.maximums[l]}}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.")}raycast(t,i,n){throw new Error("Pure virtual method called.")}pointCoordinate(t){throw new Error("Pure virtual method called.")}_source(){throw new Error("Pure virtual method called.")}isUsingMockSource(){throw new Error("Pure virtual method called.")}exaggeration(){throw new Error("Pure virtual method called.")}findDEMTileFor(t){throw new Error("Pure virtual method called.")}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.")}getMinMaxForVisibleTiles(){const t=this.visibleDemTiles;if(t.length===0)return null;let i=!1,n=Number.MAX_VALUE,r=Number.MIN_VALUE;for(const o of t){const s=this.getMinMaxForTile(o.tileID);s&&(n=Math.min(n,s.min),r=Math.max(r,s.max),i=!0)}return i?{min:n,max:r}:null}}class Cl{constructor(t,i,n){this._demTile=t,this._dem=this._demTile.dem,this._scale=i,this._offset=n}static create(t,i,n){const r=n||t.findDEMTileFor(i);if(!r||!r.dem)return;const o=r.dem,s=r.tileID,a=1<<i.canonical.z-s.canonical.z;return new Cl(r,o.dim/pt/a,[(i.canonical.x/a-s.canonical.x)*o.dim,(i.canonical.y/a-s.canonical.y)*o.dim])}tileCoordToPixel(t,i){const n=i*this._scale+this._offset[1],r=Math.floor(t*this._scale+this._offset[0]),o=Math.floor(n);return new G(r,o)}getElevationAt(t,i,n,r){const o=t*this._scale+this._offset[0],s=i*this._scale+this._offset[1],a=Math.floor(o),l=Math.floor(s),c=this._dem;return r=!!r,n?ze(ze(c.get(a,l,r),c.get(a,l+1,r),s-l),ze(c.get(a+1,l,r),c.get(a+1,l+1,r),s-l),o-a):c.get(a,l,r)}getElevationAtPixel(t,i,n){return this._dem.get(t,i,!!n)}getMeterToDEM(t){return(1<<this._demTile.tileID.canonical.z)*Gi(1,t)*this._dem.stride}}class Mm{constructor(t,i){this.tileID=t,this.x=t.canonical.x,this.y=t.canonical.y,this.z=t.canonical.z,this.grid=new fl(pt,16,0),this.featureIndexArray=new ty,this.promoteId=i}insert(t,i,n,r,o,s=0){const a=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(n,r,o,s);const l=this.grid;for(let c=0;c<i.length;c++){const u=i[c],h=[1/0,1/0,-1/0,-1/0];for(let d=0;d<u.length;d++){const p=u[d];h[0]=Math.min(h[0],p.x),h[1]=Math.min(h[1],p.y),h[2]=Math.max(h[2],p.x),h[3]=Math.max(h[3],p.y)}h[0]<pt&&h[1]<pt&&h[2]>=0&&h[3]>=0&&l.insert(a,h[0],h[1],h[2],h[3])}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new wm(new kh(this.rawTileData)).layers,this.sourceLayerCoder=new hv(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(const t in this.vtLayers)this.vtFeatures[t]=[]}return this.vtLayers}query(t,i,n,r){this.loadVTLayers();const o=t.params||{},s=Zu(o.filter),a=t.tileResult,l=t.transform,c=a.bufferedTilespaceBounds,u=this.grid.query(c.min.x,c.min.y,c.max.x,c.max.y,(_,g,y,x)=>$1(a.bufferedTilespaceGeometry,_,g,y,x));u.sort(XS);let h=null;l.elevation&&u.length>0&&(h=Cl.create(l.elevation,this.tileID));const d={};let p;for(let _=0;_<u.length;_++){const g=u[_];if(g===p)continue;p=g;const y=this.featureIndexArray.get(g);let x=null;this.loadMatchingFeature(d,y,s,o.layers,o.availableImages,i,n,r,(b,M,E,T=0)=>(x||(x=Po(b,this.tileID.canonical,t.tileTransform)),M.queryIntersectsFeature(a,b,E,x,this.z,t.transform,t.pixelPosMatrix,h,T)))}return d}loadMatchingFeature(t,i,n,r,o,s,a,l,c){const{featureIndex:u,bucketIndex:h,sourceLayerIndex:d,layoutVertexArrayOffset:p}=i,_=this.bucketLayerIDs[h];if(r&&!function(b,M){for(let E=0;E<b.length;E++)if(M.indexOf(b[E])>=0)return!0;return!1}(r,_))return;const g=this.sourceLayerCoder.decode(d),y=this.vtLayers[g].feature(u);if(n.needGeometry){const b=Zs(y,!0);if(!n.filter(new dn(this.tileID.overscaledZ),b,this.tileID.canonical))return}else if(!n.filter(new dn(this.tileID.overscaledZ),y))return;const x=this.getId(y,g);for(let b=0;b<_.length;b++){const M=_[b];if(r&&r.indexOf(M)<0)continue;const E=s[M];if(!E)continue;let T={};x!==void 0&&l&&(T=l.getState(E.sourceLayer||"_geojsonTileLayer",x));const S=Vt({},a[M]);S.paint=Ev(S.paint,E.paint,y,T,o),S.layout=Ev(S.layout,E.layout,y,T,o);const D=!c||c(y,E,T,p);if(!D)continue;const z=new gv(y,this.z,this.x,this.y,x);z.layer=S;let L=t[M];L===void 0&&(L=t[M]=[]),L.push({featureIndex:u,feature:z,intersectionZ:D})}}lookupSymbolFeatures(t,i,n,r,o,s,a,l){const c={};this.loadVTLayers();const u=Zu(o);for(const h of t)this.loadMatchingFeature(c,{bucketIndex:n,sourceLayerIndex:r,featureIndex:h,layoutVertexArrayOffset:0},u,s,a,l,i);return c}loadFeature(t){const{featureIndex:i,sourceLayerIndex:n}=t;this.loadVTLayers();const r=this.sourceLayerCoder.decode(n),o=this.vtFeatures[r];if(o[i])return o[i];const s=this.vtLayers[r].feature(i);return o[i]=s,s}hasLayer(t){for(const i of this.bucketLayerIDs)for(const n of i)if(t===n)return!0;return!1}getId(t,i){let n=t.id;if(this.promoteId){const r=typeof this.promoteId=="string"?this.promoteId:this.promoteId[i];r!=null&&(n=t.properties[r]),typeof n=="boolean"&&(n=Number(n))}return n}}function Ev(e,t,i,n,r){return gi(e,(o,s)=>{const a=t instanceof Ac?t.get(s):null;return a&&a.evaluate?a.evaluate(i,n,r):a})}function XS(e,t){return t-e}he(Mm,"FeatureIndex",{omit:["rawTileData","sourceLayerCoder"]});const YS=zi([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),KS=zi([{name:"a_globe_anchor",components:3,type:"Int16"},{name:"a_globe_normal",components:3,type:"Float32"}],4),JS=zi([{name:"a_projected_pos",components:4,type:"Float32"}],4);zi([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const QS=zi([{name:"a_z_offset",components:1,type:"Float32"}],4),tA=zi([{name:"a_texb",components:2,type:"Uint16"}]),eA=zi([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"}]),iA=zi([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"},{name:"a_z_offset",components:1,type:"Float32"}]);zi([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const Sv=zi([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),nA=zi([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);zi([{name:"triangle",components:3,type:"Uint16"}]),zi([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),zi([{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Float32",name:"zOffset"},{type:"Uint8",name:"hasIconTextFit"}]),zi([{type:"Float32",name:"offsetX"}]),zi([{type:"Int16",name:"x"},{type:"Int16",name:"y"}]);var $n=24;const ao=128;function Em(e,t){const{expression:i}=t;if(i.kind==="constant")return{kind:"constant",layoutSize:i.evaluate(new dn(e+1))};if(i.kind==="source")return{kind:"source"};{const{zoomStops:n,interpolationType:r}=i;let o=0;for(;o<n.length&&n[o]<=e;)o++;o=Math.max(0,o-1);let s=o;for(;s<n.length&&n[s]<e+1;)s++;s=Math.min(n.length-1,s);const a=n[o],l=n[s];return i.kind==="composite"?{kind:"composite",minZoom:a,maxZoom:l,interpolationType:r}:{kind:"camera",minZoom:a,maxZoom:l,minSize:i.evaluate(new dn(a)),maxSize:i.evaluate(new dn(l)),interpolationType:r}}}function jc(e,{uSize:t,uSizeT:i},{lowerSize:n,upperSize:r}){return e.kind==="source"?n/ao:e.kind==="composite"?ze(n/ao,r/ao,i):t}function ko(e,t){let i=0,n=0;if(e.kind==="constant")n=e.layoutSize;else if(e.kind!=="source"){const{interpolationType:r,minZoom:o,maxZoom:s}=e,a=r?Lt(Ao.interpolationFactor(r,t,o,s),0,1):0;e.kind==="camera"?n=ze(e.minSize,e.maxSize,a):i=a}return{uSizeT:i,uSize:n}}var rA=Object.freeze({__proto__:null,SIZE_PACK_FACTOR:ao,evaluateSizeForFeature:jc,evaluateSizeForZoom:ko,getSizeData:Em});function oA(e,t,i){return e.sections.forEach(n=>{n.text=function(r,o,s){const a=o.layout.get("text-transform").evaluate(s,{});return a==="uppercase"?r=r.toLocaleUpperCase():a==="lowercase"&&(r=r.toLocaleLowerCase()),$r.applyArabicShaping&&(r=$r.applyArabicShaping(r)),r}(n.text,t,i)}),e}const Gc={"!":"︕","#":"＃",$:"＄","%":"％","&":"＆","(":"︵",")":"︶","*":"＊","+":"＋",",":"︐","-":"︲",".":"・","/":"／",":":"︓",";":"︔","<":"︿","=":"＝",">":"﹀","?":"︖","@":"＠","[":"﹇","\\":"＼","]":"﹈","^":"＾",_:"︳","`":"｀","{":"︷","|":"―","}":"︸","~":"～","¢":"￠","£":"￡","¥":"￥","¦":"￤","¬":"￢","¯":"￣","–":"︲","—":"︱","‘":"﹃","’":"﹄","“":"﹁","”":"﹂","…":"︙","‧":"・","₩":"￦","、":"︑","。":"︒","〈":"︿","〉":"﹀","《":"︽","》":"︾","「":"﹁","」":"﹂","『":"﹃","』":"﹄","【":"︻","】":"︼","〔":"︹","〕":"︺","〖":"︗","〗":"︘","！":"︕","（":"︵","）":"︶","，":"︐","－":"︲","．":"・","：":"︓","；":"︔","＜":"︿","＞":"﹀","？":"︖","［":"﹇","］":"﹈","＿":"︳","｛":"︷","｜":"―","｝":"︸","｟":"︵","｠":"︶","｡":"︒","｢":"﹁","｣":"﹂","←":"↑","→":"↓"};function sA(e){return e==="︶"||e==="﹈"||e==="︸"||e==="﹄"||e==="﹂"||e==="︾"||e==="︼"||e==="︺"||e==="︘"||e==="﹀"||e==="︐"||e==="︓"||e==="︔"||e==="｀"||e==="￣"||e==="︑"||e==="︒"}function aA(e){return e==="︵"||e==="﹇"||e==="︷"||e==="﹃"||e==="﹁"||e==="︽"||e==="︻"||e==="︹"||e==="︗"||e==="︿"}const Sm=3;function lA(e,t,i){t.glyphs=[],e===1&&i.readMessage(cA,t)}function cA(e,t,i){if(e===3){const{id:n,bitmap:r,width:o,height:s,left:a,top:l,advance:c}=i.readMessage(uA,{});t.glyphs.push({id:n,bitmap:new hs({width:o+2*Sm,height:s+2*Sm},r),metrics:{width:o,height:s,left:a,top:l,advance:c}})}else e===4?t.ascender=i.readSVarint():e===5&&(t.descender=i.readSVarint())}function uA(e,t,i){e===1?t.id=i.readVarint():e===2?t.bitmap=i.readBytes():e===3?t.width=i.readVarint():e===4?t.height=i.readVarint():e===5?t.left=i.readSVarint():e===6?t.top=i.readSVarint():e===7&&(t.advance=i.readVarint())}const Av=Sm,un={horizontal:1,vertical:2,horizontalOnly:3},Iv=-17;class qc{constructor(){this.scale=1,this.fontStack="",this.imageName=null}static forText(t,i){const n=new qc;return n.scale=t||1,n.fontStack=i,n}static forImage(t){const i=new qc;return i.imageName=t,i}}class Dl{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(t,i){const n=new Dl;for(let r=0;r<t.sections.length;r++){const o=t.sections[r];o.image?n.addImageSection(o):n.addTextSection(o,i)}return n}length(){return this.text.length}getSection(t){return this.sections[this.sectionIndex[t]]}getSections(){return this.sections}getSectionIndex(t){return this.sectionIndex[t]}getCodePoint(t){return this.text.codePointAt(t)}verticalizePunctuation(t){this.text=function(i,n){let r="";for(let o=0;o<i.length;o++){const s=i.charCodeAt(o+1)||null,a=i.charCodeAt(o-1)||null;r+=!n&&(s&&B0(s)&&!Gc[i[o+1]]||a&&B0(a)&&!Gc[i[o-1]])||!Gc[i[o]]?i[o]:Gc[i[o]]}return r}(this.text,t)}trim(){let t=0;for(let n=0;n<this.text.length&&Lh[this.text.charCodeAt(n)];n++)t++;let i=this.text.length;for(let n=this.text.length-1;n>=0&&n>=t&&Lh[this.text.charCodeAt(n)];n--)i--;this.text=this.text.substring(t,i),this.sectionIndex=this.sectionIndex.slice(t,i)}substring(t,i){const n=new Dl;return n.text=this.text.substring(t,i),n.sectionIndex=this.sectionIndex.slice(t,i),n.sections=this.sections,n}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce((t,i)=>Math.max(t,this.sections[i].scale),0)}addTextSection(t,i){this.text+=t.text,this.sections.push(qc.forText(t.scale,t.fontStack||i));const n=this.sections.length-1;for(let r=0;r<t.text.length;++r)this.sectionIndex.push(n)}addImageSection(t){const i=t.image?t.image.namePrimary:"";if(i.length===0)return void J("Can't add FormattedSection with an empty image.");const n=this.getNextImageSectionCharCode();n?(this.text+=String.fromCodePoint(n),this.sections.push(qc.forImage(i)),this.sectionIndex.push(this.sections.length-1)):J("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function Am(e,t,i,n,r,o,s,a,l,c,u,h,d,p,_){const g=Dl.fromFeature(e,r);h===un.vertical&&g.verticalizePunctuation(d);let y=[];const x=function(S,D,z,L,R,N){if(!S)return[];const U=[],H=function(ot,$,Y,at,ut,ct){let bt=0;for(let Mt=0;Mt<ot.length();Mt++){const Et=ot.getSection(Mt);bt+=Cv(ot.getCodePoint(Mt),Et,at,ut,$,ct)}return bt/Math.max(1,Math.ceil(bt/Y))}(S,D,z,L,R,N),O=S.text.indexOf("​")>=0;let X=0;for(let ot=0;ot<S.length();ot++){const $=S.getSection(ot),Y=S.getCodePoint(ot);if(Lh[Y]||(X+=Cv(Y,$,L,R,D,N)),ot<S.length()-1){const at=!((K=Y)<11904||!(pe["Bopomofo Extended"](K)||pe.Bopomofo(K)||pe["CJK Compatibility Forms"](K)||pe["CJK Compatibility Ideographs"](K)||pe["CJK Compatibility"](K)||pe["CJK Radicals Supplement"](K)||pe["CJK Strokes"](K)||pe["CJK Symbols and Punctuation"](K)||pe["CJK Unified Ideographs Extension A"](K)||pe["CJK Unified Ideographs"](K)||pe["Enclosed CJK Letters and Months"](K)||pe["Halfwidth and Fullwidth Forms"](K)||pe.Hiragana(K)||pe["Ideographic Description Characters"](K)||pe["Kangxi Radicals"](K)||pe["Katakana Phonetic Extensions"](K)||pe.Katakana(K)||pe["Vertical Forms"](K)||pe["Yi Radicals"](K)||pe["Yi Syllables"](K)));(hA[Y]||at||$.imageName)&&U.push(Pv(ot+1,X,H,U,dA(Y,S.getCodePoint(ot+1),at&&O),!1))}}var K;return kv(Pv(S.length(),X,H,U,0,!0))}(g,c,o,t,n,p),{processBidirectionalText:b,processStyledBidirectionalText:M}=$r;if(b&&g.sections.length===1){const S=b(g.toString(),x);for(const D of S){const z=new Dl;z.text=D,z.sections=g.sections;for(let L=0;L<D.length;L++)z.sectionIndex.push(0);y.push(z)}}else if(M){const S=M(g.text,g.sectionIndex,x);for(const D of S){const z=new Dl;z.text=D[0],z.sectionIndex=D[1],z.sections=g.sections,y.push(z)}}else y=function(S,D){const z=[],L=S.text;let R=0;for(const N of D)z.push(S.substring(R,N)),R=N;return R<L.length&&z.push(S.substring(R,L.length)),z}(g,x);const E=[],T={positionedLines:E,text:g.toString(),top:u[1],bottom:u[1],left:u[0],right:u[0],writingMode:h,iconsInText:!1,verticalizable:!1,hasBaseline:!1};return function(S,D,z,L,R,N,U,H,O,X,K,ot){let $=0,Y=0,at=0;const ut=H==="right"?1:H==="left"?0:.5;let ct=!1;for(const Qt of R){const te=Qt.getSections();for(const oe of te){if(oe.imageName)continue;const ce=D[oe.fontStack];if(ce&&(ct=ce.ascender!==void 0&&ce.descender!==void 0,!ct))break}if(!ct)break}let bt=0;for(const Qt of R){Qt.trim();const te=Qt.getMaxScale(),oe=(te-1)*$n,ce={positionedGlyphs:[],lineOffset:0};S.positionedLines[bt]=ce;const Ce=ce.positionedGlyphs;let ge=0;if(!Qt.length()){Y+=N,++bt;continue}let bi=0,ni=0;for(let we=0;we<Qt.length();we++){const ye=Qt.getSection(we),si=Qt.getSectionIndex(we),pi=Qt.getCodePoint(we);let $e=ye.scale,qi=null,An=null,Ui=null,nn=$n,Dn=0;const In=!(O===un.horizontal||!K&&!ap(pi)||K&&(Lh[pi]||(Mt=pi,pe.Arabic(Mt)||pe["Arabic Supplement"](Mt)||pe["Arabic Extended-A"](Mt)||pe["Arabic Presentation Forms-A"](Mt)||pe["Arabic Presentation Forms-B"](Mt))));if(ye.imageName){const sn=L[ye.imageName];if(!sn)continue;Ui=ye.imageName,S.iconsInText=S.iconsInText||!0,An=sn.paddedRect;const Ri=sn.displaySize;$e=$e*$n/ot,qi={width:Ri[0],height:Ri[1],left:0,top:-Av,advance:In?Ri[1]:Ri[0],localGlyph:!1},Dn=ct?-qi.height*$e:Iv+te*$n-Ri[1]*$e,nn=qi.advance;const Jn=(In?Ri[0]:Ri[1])*$e-$n*te;Jn>0&&Jn>ge&&(ge=Jn)}else{const sn=z[ye.fontStack];if(!sn)continue;sn[pi]&&(An=sn[pi]);const Ri=D[ye.fontStack];if(!Ri)continue;const Jn=Ri.glyphs[pi];if(!Jn)continue;if(qi=Jn.metrics,nn=pi!==8203?$n:0,ct){const Fo=Ri.ascender!==void 0?Math.abs(Ri.ascender):0,ps=Ri.descender!==void 0?Math.abs(Ri.descender):0,ms=(Fo+ps)*$e;bi<ms&&(bi=ms,ni=(Fo-ps)/2*$e),Dn=-Fo*$e}else Dn=Iv+(te-$e)*$n}In?(S.verticalizable=!0,Ce.push({glyph:pi,imageName:Ui,x:$,y:Y+Dn,vertical:In,scale:$e,localGlyph:qi.localGlyph,fontStack:ye.fontStack,sectionIndex:si,metrics:qi,rect:An}),$+=nn*$e+X):(Ce.push({glyph:pi,imageName:Ui,x:$,y:Y+Dn,vertical:In,scale:$e,localGlyph:qi.localGlyph,fontStack:ye.fontStack,sectionIndex:si,metrics:qi,rect:An}),$+=qi.advance*$e+X)}Ce.length!==0&&(at=Math.max($-X,at),ct?zv(Ce,ut,ge,ni,N*te/2):zv(Ce,ut,ge,0,N/2)),$=0;const De=N*te+ge;ce.lineOffset=Math.max(ge,oe),Y+=De,++bt}var Mt;const Et=Y,{horizontalAlign:ft,verticalAlign:kt}=Rh(U);(function(Qt,te,oe,ce,Ce,ge){const bi=(te-oe)*Ce,ni=-ge*ce;for(const De of Qt)for(const we of De.positionedGlyphs)we.x+=bi,we.y+=ni})(S.positionedLines,ut,ft,kt,at,Et),S.top+=-kt*Et,S.bottom=S.top+Et,S.left+=-ft*at,S.right=S.left+at,S.hasBaseline=ct}(T,t,i,n,y,s,a,l,h,c,d,_),!function(S){for(const D of S)if(D.positionedGlyphs.length!==0)return!1;return!0}(E)&&T}const Lh={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},hA={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function Cv(e,t,i,n,r,o){if(t.imageName){const s=n[t.imageName];return s?s.displaySize[0]*t.scale*$n/o+r:0}{const s=i[t.fontStack],a=s&&s.glyphs[e];return a?a.metrics.advance*t.scale+r:0}}function Dv(e,t,i,n){const r=Math.pow(e-t,2);return n?e<t?r/2:2*r:r+Math.abs(i)*i}function dA(e,t,i){let n=0;return e===10&&(n-=1e4),i&&(n+=150),e!==40&&e!==65288||(n+=50),t!==41&&t!==65289||(n+=50),n}function Pv(e,t,i,n,r,o){let s=null,a=Dv(t,i,r,o);for(const l of n){const c=Dv(t-l.x,i,r,o)+l.badness;c<=a&&(s=l,a=c)}return{index:e,x:t,priorBreak:s,badness:a}}function kv(e){return e?kv(e.priorBreak).concat(e.index):[]}function Rh(e){let t=.5,i=.5;switch(e){case"right":case"top-right":case"bottom-right":t=1;break;case"left":case"top-left":case"bottom-left":t=0}switch(e){case"bottom":case"bottom-right":case"bottom-left":i=1;break;case"top":case"top-right":case"top-left":i=0}return{horizontalAlign:t,verticalAlign:i}}function zv(e,t,i,n,r){if(!(t||i||n||r))return;const o=e.length-1,s=e[o],a=(s.x+s.metrics.advance*s.scale)*t;for(let l=0;l<=o;l++)e[l].x-=a,e[l].y+=i+n+r}function fA(e,t,i,n){const{horizontalAlign:r,verticalAlign:o}=Rh(n),s=i[0]-e.displaySize[0]*r,a=i[1]-e.displaySize[1]*o;return{imagePrimary:e,imageSecondary:t,top:a,bottom:a+e.displaySize[1],left:s,right:s+e.displaySize[0]}}function Lv(e,t,i,n,r,o){const s=e.imagePrimary;let a;if(s.content){const y=s.content,x=s.pixelRatio||1;a=[y[0]/x,y[1]/x,s.displaySize[0]-y[2]/x,s.displaySize[1]-y[3]/x]}const l=t.left*o,c=t.right*o;let u,h,d,p;i==="width"||i==="both"?(p=r[0]+l-n[3],h=r[0]+c+n[1]):(p=r[0]+(l+c-s.displaySize[0])/2,h=p+s.displaySize[0]);const _=t.top*o,g=t.bottom*o;return i==="height"||i==="both"?(u=r[1]+_-n[0],d=r[1]+g+n[2]):(u=r[1]+(_+g-s.displaySize[1])/2,d=u+s.displaySize[1]),{imagePrimary:s,imageSecondary:void 0,top:u,right:h,bottom:d,left:p,collisionPadding:a}}class fs extends G{constructor(t,i,n,r,o){super(t,i),this.angle=r,this.z=n,o!==void 0&&(this.segment=o)}clone(){return new fs(this.x,this.y,this.z,this.angle,this.segment)}}function Rv(e,t,i,n,r){if(t.segment===void 0)return!0;let o=t,s=t.segment+1,a=0;for(;a>-i/2;){if(s--,s<0)return!1;a-=e[s].dist(o),o=e[s]}a+=e[s].dist(e[s+1]),s++;const l=[];let c=0;for(;a<i/2;){const u=e[s],h=e[s+1];if(!h)return!1;let d=e[s-1].angleTo(u)-u.angleTo(h);for(d=Math.abs((d+3*Math.PI)%(2*Math.PI)-Math.PI),l.push({distance:a,angleDelta:d}),c+=d;a-l[0].distance>n;)c-=l.shift().angleDelta;if(c>r)return!1;s++,a+=u.dist(h)}return!0}function Ov(e){let t=0;for(let i=0;i<e.length-1;i++)t+=e[i].dist(e[i+1]);return t}function Bv(e,t,i){return e?.6*t*i:0}function Fv(e,t){return Math.max(e?e.right-e.left:0,t?t.right-t.left:0)}function pA(e,t,i,n,r,o){const s=Bv(i,r,o),a=Fv(i,n)*o;let l=0;const c=Ov(e)/2;for(let u=0;u<e.length-1;u++){const h=e[u],d=e[u+1],p=h.dist(d);if(l+p>c){const _=(c-l)/p,g=ze(h.x,d.x,_),y=ze(h.y,d.y,_),x=new fs(g,y,0,d.angleTo(h),u);return!s||Rv(e,x,a,s,t)?x:void 0}l+=p}}function mA(e,t,i,n,r,o,s,a,l){const c=Bv(n,o,s),u=Fv(n,r),h=u*s,d=e[0].x===0||e[0].x===l||e[0].y===0||e[0].y===l;return t-h<t/4&&(t=h+t/4),Nv(e,d?t/2*a%t:(u/2+2*o)*s*a%t,t,c,i,h,d,!1,l)}function Nv(e,t,i,n,r,o,s,a,l){const c=o/2,u=Ov(e);let h=0,d=t-i,p=[];for(let _=0;_<e.length-1;_++){const g=e[_],y=e[_+1],x=g.dist(y),b=y.angleTo(g);for(;d+i<h+x;){d+=i;const M=(d-h)/x,E=ze(g.x,y.x,M),T=ze(g.y,y.y,M);if(E>=0&&E<l&&T>=0&&T<l&&d-c>=0&&d+c<=u){const S=new fs(E,T,0,b,_);n&&!Rv(e,S,o,n,r)||p.push(S)}}h+=x}return a||p.length||s||(p=Nv(e,h/2,i,n,r,o,s,!0,l)),p}function Uv(e,t,i,n,r){const o=[];for(let s=0;s<e.length;s++){const a=e[s];let l;for(let c=0;c<a.length-1;c++){let u=a[c],h=a[c+1];u.x<t&&h.x<t||(u.x<t?u=new G(t,u.y+(t-u.x)/(h.x-u.x)*(h.y-u.y))._round():h.x<t&&(h=new G(t,u.y+(t-u.x)/(h.x-u.x)*(h.y-u.y))._round()),u.y<i&&h.y<i||(u.y<i?u=new G(u.x+(i-u.y)/(h.y-u.y)*(h.x-u.x),i)._round():h.y<i&&(h=new G(u.x+(i-u.y)/(h.y-u.y)*(h.x-u.x),i)._round()),u.x>=n&&h.x>=n||(u.x>=n?u=new G(n,u.y+(n-u.x)/(h.x-u.x)*(h.y-u.y))._round():h.x>=n&&(h=new G(n,u.y+(n-u.x)/(h.x-u.x)*(h.y-u.y))._round()),u.y>=r&&h.y>=r||(u.y>=r?u=new G(u.x+(r-u.y)/(h.y-u.y)*(h.x-u.x),r)._round():h.y>=r&&(h=new G(u.x+(r-u.y)/(h.y-u.y)*(h.x-u.x),r)._round()),l&&u.equals(l[l.length-1])||(l=[u],o.push(l)),l.push(h)))))}}return o}function Im(e){let t=0,i=0;for(const s of e)t+=s.w*s.h,i=Math.max(i,s.w);e.sort((s,a)=>a.h-s.h);const n=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(t/.95)),i),h:1/0}];let r=0,o=0;for(const s of e)for(let a=n.length-1;a>=0;a--){const l=n[a];if(!(s.w>l.w||s.h>l.h)){if(s.x=l.x,s.y=l.y,o=Math.max(o,s.y+s.h),r=Math.max(r,s.x+s.w),s.w===l.w&&s.h===l.h){const c=n.pop();a<n.length&&(n[a]=c)}else s.h===l.h?(l.x+=s.w,l.w-=s.w):s.w===l.w?(l.y+=s.h,l.h-=s.h):(n.push({x:l.x+s.w,y:l.y,w:l.w-s.w,h:s.h}),l.y+=s.h,l.h-=s.h);break}}return{w:r,h:o,fill:t/(r*o)||0}}he(fs,"Anchor");const Ar=1;class Cm{constructor(t,{pixelRatio:i,version:n,stretchX:r,stretchY:o,content:s}){this.paddedRect=t,this.pixelRatio=i,this.stretchX=r,this.stretchY=o,this.content=s,this.version=n}get tl(){return[this.paddedRect.x+Ar,this.paddedRect.y+Ar]}get br(){return[this.paddedRect.x+this.paddedRect.w-Ar,this.paddedRect.y+this.paddedRect.h-Ar]}get displaySize(){return[(this.paddedRect.w-2*Ar)/this.pixelRatio,(this.paddedRect.h-2*Ar)/this.pixelRatio]}}class Vv{constructor(t,i){const n={},r={};this.haveRenderCallbacks=[];const o=[];this.addImages(t,n,o),this.addImages(i,r,o);const{w:s,h:a}=Im(o),l=new Ln({width:s||1,height:a||1});for(const c in t){const u=t[c],h=n[c].paddedRect;Ln.copy(u.data,l,{x:0,y:0},{x:h.x+Ar,y:h.y+Ar},u.data)}for(const c in i){const u=i[c],h=r[c].paddedRect,d=h.x+Ar,p=h.y+Ar,_=u.data.width,g=u.data.height;Ln.copy(u.data,l,{x:0,y:0},{x:d,y:p},u.data),Ln.copy(u.data,l,{x:0,y:g-1},{x:d,y:p-1},{width:_,height:1}),Ln.copy(u.data,l,{x:0,y:0},{x:d,y:p+g},{width:_,height:1}),Ln.copy(u.data,l,{x:_-1,y:0},{x:d-1,y:p},{width:1,height:g}),Ln.copy(u.data,l,{x:0,y:0},{x:d+_,y:p},{width:1,height:g})}this.image=l,this.iconPositions=n,this.patternPositions=r}addImages(t,i,n){for(const r in t){const o=t[r],s={x:0,y:0,w:o.data.width+2*Ar,h:o.data.height+2*Ar};n.push(s),i[r]=new Cm(s,o),o.hasRenderCallback&&this.haveRenderCallbacks.push(r)}}patchUpdatedImages(t,i,n){this.haveRenderCallbacks=this.haveRenderCallbacks.filter(r=>t.hasImage(r,n)),t.dispatchRenderCallbacks(this.haveRenderCallbacks,n);for(const r in t.getUpdatedImages(n))this.patchUpdatedImage(this.iconPositions[r],t.getImage(r,n),i),this.patchUpdatedImage(this.patternPositions[r],t.getImage(r,n),i)}patchUpdatedImage(t,i,n){if(!t||!i||t.version===i.version)return;t.version=i.version;const[r,o]=t.tl;n.update(i.data,void 0,{x:r,y:o})}}he(Cm,"ImagePosition"),he(Vv,"ImageAtlas");const Zc=1e20;function jv(e,t,i,n,r,o,s,a,l){for(let c=t;c<t+n;c++)Gv(e,i*o+c,o,r,s,a,l);for(let c=i;c<i+r;c++)Gv(e,c*o+t,1,n,s,a,l)}function Gv(e,t,i,n,r,o,s){o[0]=0,s[0]=-Zc,s[1]=Zc,r[0]=e[t];for(let a=1,l=0,c=0;a<n;a++){r[a]=e[t+a*i];const u=a*a;do{const h=o[l];c=(r[a]-r[h]+u-h*h)/(a-h)/2}while(c<=s[l]&&--l>-1);l++,o[l]=a,s[l]=c,s[l+1]=Zc}for(let a=0,l=0;a<n;a++){for(;s[l+1]<a;)l++;const c=o[l],u=a-c;e[t+a*i]=r[c]+u*u}}const lo=2;class Pl{constructor(t,i,n){this.requestManager=t,this.localGlyphMode=i,this.localFontFamily=n,this.urls={},this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(t,i){this.urls[i]=t}getGlyphs(t,i,n){const r=[],o=this.urls[i]||j.GLYPHS_URL;for(const s in t)for(const a of t[s])r.push({stack:s,id:a});Ii(r,({stack:s,id:a},l)=>{let c=this.entries[s];c||(c=this.entries[s]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let u=c.glyphs[a];if(u!==void 0)return void l(null,{stack:s,id:a,glyph:u});if(u=this._tinySDF(c,s,a),u)return c.glyphs[a]=u,void l(null,{stack:s,id:a,glyph:u});const h=Math.floor(a/256);if(256*h>65535)return void l(new Error("glyphs > 65535 not supported"));if(c.ranges[h])return void l(null,{stack:s,id:a,glyph:u});let d=c.requests[h];d||(d=c.requests[h]=[],Pl.loadGlyphRange(s,h,o,this.requestManager,(p,_)=>{if(_){c.ascender=_.ascender,c.descender=_.descender;for(const g in _.glyphs)this._doesCharSupportLocalGlyph(+g)||(c.glyphs[+g]=_.glyphs[+g]);c.ranges[h]=!0}for(const g of d)g(p,_);delete c.requests[h]})),d.push((p,_)=>{p?l(p):_&&l(null,{stack:s,id:a,glyph:_.glyphs[a]||null})})},(s,a)=>{if(s)n(s);else if(a){const l={};for(const{stack:c,id:u,glyph:h}of a)l[c]===void 0&&(l[c]={}),l[c].glyphs===void 0&&(l[c].glyphs={}),l[c].glyphs[u]=h&&{id:h.id,bitmap:h.bitmap.clone(),metrics:h.metrics},l[c].ascender=this.entries[c].ascender,l[c].descender=this.entries[c].descender;n(null,l)}})}_doesCharSupportLocalGlyph(t){return this.localGlyphMode!==0&&(this.localGlyphMode===2?!!this.localFontFamily:!!this.localFontFamily&&(pe["CJK Unified Ideographs"](t)||pe["Hangul Syllables"](t)||pe.Hiragana(t)||pe.Katakana(t)||pe["CJK Symbols and Punctuation"](t)||pe["CJK Unified Ideographs Extension A"](t)||pe["CJK Unified Ideographs Extension B"](t)))}_tinySDF(t,i,n){const r=this.localFontFamily;if(!r||!this._doesCharSupportLocalGlyph(n))return;let o=t.tinySDF;if(!o){let g="400";/bold/i.test(i)?g="900":/medium/i.test(i)?g="500":/light/i.test(i)&&(g="200"),o=t.tinySDF=new Pl.TinySDF({fontFamily:r,fontWeight:g,fontSize:24*lo,buffer:3*lo,radius:8*lo}),o.fontWeight=g}if(this.localGlyphs[o.fontWeight][n])return this.localGlyphs[o.fontWeight][n];const s=String.fromCodePoint(n),{data:a,width:l,height:c,glyphWidth:u,glyphHeight:h,glyphLeft:d,glyphTop:p,glyphAdvance:_}=o.draw(s);return this.localGlyphs[o.fontWeight][n]={id:n,bitmap:new hs({width:l,height:c},a),metrics:{width:u/lo,height:h/lo,left:d/lo,top:p/lo-27,advance:_/lo,localGlyph:!0}}}}Pl.loadGlyphRange=function(e,t,i,n,r){const o=256*t,s=o+255,a=n.transformRequest(n.normalizeGlyphsURL(i).replace("{fontstack}",e).replace("{range}",`${o}-${s}`),xt.Glyphs);Ht(a,(l,c)=>{if(l)r(l);else if(c){const u={},h=function(d){return new kh(d).readFields(lA,{})}(c);for(const d of h.glyphs)u[d.id]=d;r(null,{glyphs:u,ascender:h.ascender,descender:h.descender})}})},Pl.TinySDF=class{constructor({fontSize:e=24,buffer:t=3,radius:i=8,cutoff:n=.25,fontFamily:r="sans-serif",fontWeight:o="normal",fontStyle:s="normal"}={}){this.buffer=t,this.cutoff=n,this.radius=i;const a=this.size=e+4*t,l=this._createCanvas(a),c=this.ctx=l.getContext("2d",{willReadFrequently:!0});c.font=`${s} ${o} ${e}px ${r}`,c.textBaseline="alphabetic",c.textAlign="left",c.fillStyle="black",this.gridOuter=new Float64Array(a*a),this.gridInner=new Float64Array(a*a),this.f=new Float64Array(a),this.z=new Float64Array(a+1),this.v=new Uint16Array(a)}_createCanvas(e){const t=document.createElement("canvas");return t.width=t.height=e,t}draw(e){const{width:t,actualBoundingBoxAscent:i,actualBoundingBoxDescent:n,actualBoundingBoxLeft:r,actualBoundingBoxRight:o}=this.ctx.measureText(e),s=Math.ceil(i),a=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(o-r))),l=Math.min(this.size-this.buffer,s+Math.ceil(n)),c=a+2*this.buffer,u=l+2*this.buffer,h=Math.max(c*u,0),d=new Uint8ClampedArray(h),p={data:d,width:c,height:u,glyphWidth:a,glyphHeight:l,glyphTop:s,glyphLeft:0,glyphAdvance:t};if(a===0||l===0)return p;const{ctx:_,buffer:g,gridInner:y,gridOuter:x}=this;_.clearRect(g,g,a,l),_.fillText(e,g,g+s);const b=_.getImageData(g,g,a,l);x.fill(Zc,0,h),y.fill(0,0,h);for(let M=0;M<l;M++)for(let E=0;E<a;E++){const T=b.data[4*(M*a+E)+3]/255;if(T===0)continue;const S=(M+g)*c+E+g;if(T===1)x[S]=0,y[S]=Zc;else{const D=.5-T;x[S]=D>0?D*D:0,y[S]=D<0?D*D:0}}jv(x,0,0,c,u,c,this.f,this.v,this.z),jv(y,g,g,a,l,c,this.f,this.v,this.z);for(let M=0;M<h;M++){const E=Math.sqrt(x[M])-Math.sqrt(y[M]);d[M]=Math.round(255-255*(E/this.radius+this.cutoff))}return p}};const $s=Ar;function qv(e,t,i,n){const r=[],o=e.imagePrimary,s=o.pixelRatio,a=o.paddedRect.w-2*$s,l=o.paddedRect.h-2*$s,c=e.right-e.left,u=e.bottom-e.top,h=o.stretchX||[[0,a]],d=o.stretchY||[[0,l]],p=(N,U)=>N+U[1]-U[0],_=h.reduce(p,0),g=d.reduce(p,0),y=a-_,x=l-g;let b=0,M=_,E=0,T=g,S=0,D=y,z=0,L=x;if(o.content&&n){const N=o.content;b=Oh(h,0,N[0]),E=Oh(d,0,N[1]),M=Oh(h,N[0],N[2]),T=Oh(d,N[1],N[3]),S=N[0]-b,z=N[1]-E,D=N[2]-N[0]-M,L=N[3]-N[1]-T}const R=(N,U,H,O)=>{const X=Bh(N.stretch-b,M,c,e.left),K=Fh(N.fixed-S,D,N.stretch,_),ot=Bh(U.stretch-E,T,u,e.top),$=Fh(U.fixed-z,L,U.stretch,g),Y=Bh(H.stretch-b,M,c,e.left),at=Fh(H.fixed-S,D,H.stretch,_),ut=Bh(O.stretch-E,T,u,e.top),ct=Fh(O.fixed-z,L,O.stretch,g),bt=new G(X,ot),Mt=new G(Y,ot),Et=new G(Y,ut),ft=new G(X,ut),kt=new G(K/s,$/s),Qt=new G(at/s,ct/s),te=t*Math.PI/180;if(te){const ni=Math.sin(te),De=Math.cos(te),we=[De,-ni,ni,De];bt._matMult(we),Mt._matMult(we),ft._matMult(we),Et._matMult(we)}const oe=N.stretch+N.fixed,ce=H.stretch+H.fixed,Ce=U.stretch+U.fixed,ge=O.stretch+O.fixed,bi=e.imageSecondary;return{tl:bt,tr:Mt,bl:ft,br:Et,texPrimary:{x:o.paddedRect.x+$s+oe,y:o.paddedRect.y+$s+Ce,w:ce-oe,h:ge-Ce},texSecondary:bi?{x:bi.paddedRect.x+$s+oe,y:bi.paddedRect.y+$s+Ce,w:ce-oe,h:ge-Ce}:void 0,writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:kt,pixelOffsetBR:Qt,minFontScaleX:D/s/c,minFontScaleY:L/s/u,isSDF:i}};if(n&&(o.stretchX||o.stretchY)){const N=Zv(h,y,_),U=Zv(d,x,g);for(let H=0;H<N.length-1;H++){const O=N[H],X=N[H+1];for(let K=0;K<U.length-1;K++)r.push(R(O,U[K],X,U[K+1]))}}else r.push(R({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:a+1},{fixed:0,stretch:l+1}));return r}function Oh(e,t,i){let n=0;for(const r of e)n+=Math.max(t,Math.min(i,r[1]))-Math.max(t,Math.min(i,r[0]));return n}function Zv(e,t,i){const n=[{fixed:-$s,stretch:0}];for(const[r,o]of e){const s=n[n.length-1];n.push({fixed:r-s.stretch,stretch:s.stretch}),n.push({fixed:r-s.stretch,stretch:s.stretch+(o-r)})}return n.push({fixed:t+$s,stretch:i}),n}function Bh(e,t,i,n){return e/t*i+n}function Fh(e,t,i,n){return e-t*i/n}function _A(e,t,i,n){const r=t+e.positionedLines[n].lineOffset;return n===0?i+r/2:i+(r+(t+e.positionedLines[n-1].lineOffset))/2}function gA(e,t=1,i=!1){let n=1/0,r=1/0,o=-1/0,s=-1/0;const a=e[0];for(let p=0;p<a.length;p++){const _=a[p];(!p||_.x<n)&&(n=_.x),(!p||_.y<r)&&(r=_.y),(!p||_.x>o)&&(o=_.x),(!p||_.y>s)&&(s=_.y)}const l=Math.min(o-n,s-r);let c=l/2;const u=new bf([],yA);if(l===0)return new G(n,r);for(let p=n;p<o;p+=l)for(let _=r;_<s;_+=l)u.push(new kl(p+c,_+c,c,e));let h=function(p){let _=0,g=0,y=0;const x=p[0];for(let b=0,M=x.length,E=M-1;b<M;E=b++){const T=x[b],S=x[E],D=T.x*S.y-S.x*T.y;g+=(T.x+S.x)*D,y+=(T.y+S.y)*D,_+=3*D}return new kl(g/_,y/_,0,p)}(e),d=u.length;for(;u.length;){const p=u.pop();(p.d>h.d||!h.d)&&(h=p,i&&console.log("found best %d after %d probes",Math.round(1e4*p.d)/1e4,d)),p.max-h.d<=t||(c=p.h/2,u.push(new kl(p.p.x-c,p.p.y-c,c,e)),u.push(new kl(p.p.x+c,p.p.y-c,c,e)),u.push(new kl(p.p.x-c,p.p.y+c,c,e)),u.push(new kl(p.p.x+c,p.p.y+c,c,e)),d+=4)}return i&&(console.log(`num probes: ${d}`),console.log(`best distance: ${h.d}`)),h.p}function yA(e,t){return t.max-e.max}class kl{constructor(t,i,n,r){this.p=new G(t,i),this.h=n,this.d=function(o,s){let a=!1,l=1/0;for(let c=0;c<s.length;c++){const u=s[c];for(let h=0,d=u.length,p=d-1;h<d;p=h++){const _=u[h],g=u[p];_.y>o.y!=g.y>o.y&&o.x<(g.x-_.x)*(o.y-_.y)/(g.y-_.y)+_.x&&(a=!a),l=Math.min(l,H1(o,_,g))}}return(a?1:-1)*Math.sqrt(l)}(this.p,r),this.max=this.d+this.h*Math.SQRT2}}const zl=7,Dm=Number.POSITIVE_INFINITY,vA=Math.sqrt(2);function Pm(e,[t,i]){let n=0,r=0;if(i===Dm){t<0&&(t=0);const o=t/vA;switch(e){case"top-right":case"top-left":r=o-zl;break;case"bottom-right":case"bottom-left":r=-o+zl;break;case"bottom":r=-t+zl;break;case"top":r=t-zl}switch(e){case"top-right":case"bottom-right":n=-o;break;case"top-left":case"bottom-left":n=o;break;case"left":n=t;break;case"right":n=-t}}else{switch(t=Math.abs(t),i=Math.abs(i),e){case"top-right":case"top-left":case"top":r=i-zl;break;case"bottom-right":case"bottom-left":case"bottom":r=-i+zl}switch(e){case"top-right":case"bottom-right":case"right":n=-t;break;case"top-left":case"bottom-left":case"left":n=t}}return[n,r]}function xA(e,t,i,n,r,o,s,a,l,c,u){e.createArrays(),e.tilePixelRatio=pt/(512*e.overscaling),e.compareText={},e.iconsNeedLinear=!1;const h=e.layers[0].layout,d=e.layers[0]._unevaluatedLayout._values,p={};if(e.textSizeData.kind==="composite"){const{minZoom:x,maxZoom:b}=e.textSizeData;p.compositeTextSizes=[d["text-size"].possiblyEvaluate(new dn(x),a),d["text-size"].possiblyEvaluate(new dn(b),a)]}if(e.iconSizeData.kind==="composite"){const{minZoom:x,maxZoom:b}=e.iconSizeData;p.compositeIconSizes=[d["icon-size"].possiblyEvaluate(new dn(x),a),d["icon-size"].possiblyEvaluate(new dn(b),a)]}p.layoutTextSize=d["text-size"].possiblyEvaluate(new dn(l+1),a),p.layoutIconSize=d["icon-size"].possiblyEvaluate(new dn(l+1),a),p.textMaxSize=d["text-size"].possiblyEvaluate(new dn(18),a);const _=h.get("text-rotation-alignment")==="map"&&h.get("symbol-placement")!=="point",g=h.get("text-size");let y=!1;for(const x of e.features)if(x.icon&&x.icon.nameSecondary){y=!0;break}for(const x of e.features){const b=h.get("text-font").evaluate(x,{},a).join(","),M=g.evaluate(x,{},a),E=p.layoutTextSize.evaluate(x,{},a),T=(p.layoutIconSize.evaluate(x,{},a),{horizontal:{},vertical:void 0}),S=x.text;let D,z=[0,0];if(S){const N=S.toString(),U=h.get("text-letter-spacing").evaluate(x,{},a)*$n,H=h.get("text-line-height").evaluate(x,{},a)*$n,O=WM(N)?U:0,X=h.get("text-anchor").evaluate(x,{},a),K=h.get("text-variable-anchor");if(!K){const ut=h.get("text-radial-offset").evaluate(x,{},a);z=ut?Pm(X,[ut*$n,Dm]):h.get("text-offset").evaluate(x,{},a).map(ct=>ct*$n)}let ot=_?"center":h.get("text-justify").evaluate(x,{},a);const $=h.get("symbol-placement")==="point",Y=$?h.get("text-max-width").evaluate(x,{},a)*$n:1/0,at=ut=>{e.allowVerticalPlacement&&sp(N)&&(T.vertical=Am(S,t,i,r,b,Y,H,X,ut,O,z,un.vertical,!0,E,M))};if(!_&&K){const ut=ot==="auto"?K.map(bt=>km(bt)):[ot];let ct=!1;for(let bt=0;bt<ut.length;bt++){const Mt=ut[bt];if(!T.horizontal[Mt])if(ct)T.horizontal[Mt]=T.horizontal[0];else{const Et=Am(S,t,i,r,b,Y,H,"center",Mt,O,z,un.horizontal,!1,E,M);Et&&(T.horizontal[Mt]=Et,ct=Et.positionedLines.length===1)}}at("left")}else{if(ot==="auto"&&(ot=km(X)),$||h.get("text-writing-mode").indexOf("horizontal")>=0||!sp(N)){const ut=Am(S,t,i,r,b,Y,H,X,ot,O,z,un.horizontal,!1,E,M);ut&&(T.horizontal[ot]=ut)}at($?"left":ot)}}let L=!1;if(x.icon&&x.icon.namePrimary){const N=n[x.icon.namePrimary];N&&(D=fA(r[x.icon.namePrimary],x.icon.nameSecondary?r[x.icon.nameSecondary]:void 0,h.get("icon-offset").evaluate(x,{},a),h.get("icon-anchor").evaluate(x,{},a)),L=N.sdf,e.sdfIcons===void 0?e.sdfIcons=N.sdf:e.sdfIcons!==N.sdf&&J("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(N.pixelRatio!==e.pixelRatio||h.get("icon-rotate").constantOr(1)!==0)&&(e.iconsNeedLinear=!0))}const R=Wv(T.horizontal)||T.vertical;e.iconsInText||(e.iconsInText=!!R&&R.iconsInText),(R||D)&&bA(e,x,T,D,n,p,E,0,z,L,s,a,c,u,y)}o&&e.generateCollisionDebugBuffers(l,e.collisionBoxArray)}function km(e){switch(e){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function bA(e,t,i,n,r,o,s,a,l,c,u,h,d,p,_){let g=o.textMaxSize.evaluate(t,{},h);g===void 0&&(g=s);const y=e.layers[0].layout,x=y.get("icon-offset").evaluate(t,{},h),b=Wv(i.horizontal)||i.vertical,M=d.name==="globe",E=$n,T=s/E,S=e.tilePixelRatio*g/E,D=(X=e.overscaling,e.zoom>18&&X>2&&(X>>=1),Math.max(pt/(512*X),1)*y.get("symbol-spacing")),z=y.get("text-padding")*e.tilePixelRatio,L=y.get("icon-padding")*e.tilePixelRatio,R=wt(y.get("text-max-angle")),N=y.get("text-rotation-alignment")==="map"&&y.get("symbol-placement")!=="point",U=y.get("icon-rotation-alignment")==="map"&&y.get("symbol-placement")!=="point",H=y.get("symbol-placement"),O=D/2;var X;const K=y.get("icon-text-fit").evaluate(t,{},h),ot=y.get("icon-text-fit-padding").evaluate(t,{},h),$=K!=="none";let Y;e.hasAnyIconTextFit===!1&&$&&(e.hasAnyIconTextFit=!0),n&&$&&(e.allowVerticalPlacement&&i.vertical&&(Y=Lv(n,i.vertical,K,ot,x,T)),b&&(n=Lv(n,b,K,ot,x,T)));const at=(ut,ct,bt)=>{if(ct.x<0||ct.x>=pt||ct.y<0||ct.y>=pt)return;let Mt=null;if(M){const{x:Et,y:ft,z:kt}=d.projectTilePoint(ct.x,ct.y,bt);Mt={anchor:new fs(Et,ft,kt,0,void 0),up:d.upVector(bt,ct.x,ct.y)}}(function(Et,ft,kt,Qt,te,oe,ce,Ce,ge,bi,ni,De,we,ye,si,pi,$e,qi,An,Ui,nn,Dn,In,sn,Ri,Jn,Fo){const ps=Et.addToLineVertexArray(ft,Qt);let ms,fu,pu,zd,Qw,t2,e2,i2=0,n2=0,r2=0,o2=0,k_=-1,z_=-1;const No={};let s2=Pp("");const Ua=kt?kt.anchor:ft,L_=ge.layout.get("icon-text-fit").evaluate(nn,{},Ri)!=="none";let R_=0,O_=0;if(ge._unevaluatedLayout.getValue("text-radial-offset")===void 0?[R_,O_]=ge.layout.get("text-offset").evaluate(nn,{},Ri).map(Cr=>Cr*$n):(R_=ge.layout.get("text-radial-offset").evaluate(nn,{},Ri)*$n,O_=Dm),Et.allowVerticalPlacement&&te.vertical){const Cr=te.vertical;if(si)t2=zm(Cr),Ce&&(e2=zm(Ce));else{const Dr=ge.layout.get("text-rotate").evaluate(nn,{},Ri)+90;pu=Nh(bi,Ua,ft,ni,De,we,Cr,ye,Dr,pi),Ce&&(zd=Nh(bi,Ua,ft,ni,De,we,Ce,qi,Dr))}}if(oe){const Cr=ge.layout.get("icon-rotate").evaluate(nn,{},Ri),Dr=qv(oe,Cr,In,L_),ql=Ce?qv(Ce,Cr,In,L_):void 0;fu=Nh(bi,Ua,ft,ni,De,we,oe,qi,Cr),i2=4*Dr.length;const a2=Et.iconSizeData;let Va=null;a2.kind==="source"?(Va=[ao*ge.layout.get("icon-size").evaluate(nn,{},Ri)],Va[0]>Xs&&J(`${Et.layerIds[0]}: Value for "icon-size" is >= ${Hc}. Reduce your "icon-size".`)):a2.kind==="composite"&&(Va=[ao*Dn.compositeIconSizes[0].evaluate(nn,{},Ri),ao*Dn.compositeIconSizes[1].evaluate(nn,{},Ri)],(Va[0]>Xs||Va[1]>Xs)&&J(`${Et.layerIds[0]}: Value for "icon-size" is >= ${Hc}. Reduce your "icon-size".`)),Et.addSymbols(Et.icon,Dr,Va,Ui,An,nn,!1,kt,ft,ps.lineStartIndex,ps.lineLength,-1,sn,Ri,Jn,Fo),k_=Et.icon.placedSymbolArray.length-1,ql&&(n2=4*ql.length,Et.addSymbols(Et.icon,ql,Va,Ui,An,nn,un.vertical,kt,ft,ps.lineStartIndex,ps.lineLength,-1,sn,Ri,Jn,Fo),z_=Et.icon.placedSymbolArray.length-1)}for(const Cr in te.horizontal){const Dr=te.horizontal[Cr];ms||(s2=Pp(Dr.text),si?Qw=zm(Dr):ms=Nh(bi,Ua,ft,ni,De,we,Dr,ye,ge.layout.get("text-rotate").evaluate(nn,{},Ri),pi));const ql=Dr.positionedLines.length===1;if(r2+=Hv(Et,kt,ft,Dr,ce,ge,si,nn,pi,ps,te.vertical?un.horizontal:un.horizontalOnly,ql?Object.keys(te.horizontal):[Cr],No,k_,Dn,sn,Ri,Jn),ql)break}te.vertical&&(o2+=Hv(Et,kt,ft,te.vertical,ce,ge,si,nn,pi,ps,un.vertical,["vertical"],No,z_,Dn,sn,Ri,Jn));let na=-1;const B_=(Cr,Dr)=>Cr?Math.max(Cr,Dr):Dr;na=B_(Qw,na),na=B_(t2,na),na=B_(e2,na);const oP=na>-1?1:0;Et.glyphOffsetArray.length>=Kc.MAX_GLYPHS&&J("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),nn.sortKey!==void 0&&Et.addToSortKeyRanges(Et.symbolInstances.length,nn.sortKey),Et.symbolInstances.emplaceBack(ft.x,ft.y,Ua.x,Ua.y,Ua.z,No.right>=0?No.right:-1,No.center>=0?No.center:-1,No.left>=0?No.left:-1,No.vertical>=0?No.vertical:-1,k_,z_,s2,ms!==void 0?ms:Et.collisionBoxArray.length,ms!==void 0?ms+1:Et.collisionBoxArray.length,pu!==void 0?pu:Et.collisionBoxArray.length,pu!==void 0?pu+1:Et.collisionBoxArray.length,fu!==void 0?fu:Et.collisionBoxArray.length,fu!==void 0?fu+1:Et.collisionBoxArray.length,zd||Et.collisionBoxArray.length,zd?zd+1:Et.collisionBoxArray.length,ni,r2,o2,i2,n2,oP,0,R_,O_,na,0,L_?1:0)})(e,ct,Mt,ut,i,n,r,Y,e.layers[0],e.collisionBoxArray,t.index,t.sourceLayerIndex,e.index,z,N,l,0,L,U,x,t,o,c,u,h,p,_)};if(H==="line")for(const ut of Uv(t.geometry,0,0,pt,pt)){const ct=mA(ut,D,R,i.vertical||b,n,E,S,e.overscaling,pt);for(const bt of ct)b&&wA(e,b.text,O,bt)||at(ut,bt,h)}else if(H==="line-center"){for(const ut of t.geometry)if(ut.length>1){const ct=pA(ut,R,i.vertical||b,n,E,S);ct&&at(ut,ct,h)}}else if(t.type==="Polygon")for(const ut of vm(t.geometry,0)){const ct=gA(ut,16);at(ut[0],new fs(ct.x,ct.y,0,0,void 0),h)}else if(t.type==="LineString")for(const ut of t.geometry)at(ut,new fs(ut[0].x,ut[0].y,0,0,void 0),h);else if(t.type==="Point")for(const ut of t.geometry)for(const ct of ut)at([ct],new fs(ct.x,ct.y,0,0,void 0),h)}const Hc=255,Xs=Hc*ao;function Hv(e,t,i,n,r,o,s,a,l,c,u,h,d,p,_,g,y,x){const b=function(T,S,D,z,L,R,N,U){const H=[];if(S.positionedLines.length===0)return H;const O=z.layout.get("text-rotate").evaluate(R,{})*Math.PI/180,X=function(at){const ut=at[0],ct=at[1],bt=ut*ct;return bt>0?[ut,-ct]:bt<0?[-ut,ct]:ut===0?[ct,ut]:[ct,-ut]}(D);let K=Math.abs(S.top-S.bottom);for(const at of S.positionedLines)K-=at.lineOffset;const ot=S.positionedLines.length,$=K/ot;let Y=S.top-D[1];for(let at=0;at<ot;++at){const ut=S.positionedLines[at];Y=_A(S,$,Y,at);for(const ct of ut.positionedGlyphs){if(!ct.rect)continue;const bt=ct.rect||{};let Mt=Av+1,Et=!0,ft=1,kt=0;if(ct.imageName){const Ui=N[ct.imageName];if(!Ui)continue;if(Ui.sdf){J("SDF images are not supported in formatted text and will be ignored.");continue}Et=!1,ft=Ui.pixelRatio,Mt=Ar/ft}const Qt=(L||U)&&ct.vertical,te=ct.metrics.advance*ct.scale/2,oe=ct.metrics,ce=ct.rect;if(ce===null)continue;U&&S.verticalizable&&(kt=ct.imageName?te-ct.metrics.width*ct.scale/2:0);const Ce=L?[ct.x+te,ct.y]:[0,0];let ge=[0,0],bi=[0,0],ni=!1;L||(Qt?(bi=[ct.x+te+X[0],ct.y+X[1]-kt],ni=!0):ge=[ct.x+te+D[0],ct.y+D[1]-kt]);const De=ce.w*ct.scale/(ft*(ct.localGlyph?lo:1)),we=ce.h*ct.scale/(ft*(ct.localGlyph?lo:1));let ye,si,pi,$e;if(Qt){const Ui=ct.y-Y,nn=new G(-te,te-Ui),Dn=-Math.PI/2,In=new G(...bi);ye=new G(-te+ge[0],ge[1]),ye._rotateAround(Dn,nn)._add(In),ye.x+=-Ui+te,ye.y-=(oe.left-Mt)*ct.scale;const sn=ct.imageName?oe.advance*ct.scale:$n*ct.scale,Ri=String.fromCodePoint(ct.glyph);sA(Ri)?ye.x+=(1-Mt)*ct.scale:aA(Ri)?ye.x+=sn-oe.height*ct.scale+(-Mt-1)*ct.scale:ye.x+=ct.imageName||oe.width+2*Mt===ce.w&&oe.height+2*Mt===ce.h?(sn-we)/2:(sn-(oe.height+2*Mt)*ct.scale)/2,si=new G(ye.x,ye.y-De),pi=new G(ye.x+we,ye.y),$e=new G(ye.x+we,ye.y-De)}else{const Ui=(oe.left-Mt)*ct.scale-te+ge[0],nn=(-oe.top-Mt)*ct.scale+ge[1],Dn=Ui+De,In=nn+we;ye=new G(Ui,nn),si=new G(Dn,nn),pi=new G(Ui,In),$e=new G(Dn,In)}if(O){let Ui;Ui=L?new G(0,0):ni?new G(X[0],X[1]):new G(D[0],D[1]),ye._rotateAround(O,Ui),si._rotateAround(O,Ui),pi._rotateAround(O,Ui),$e._rotateAround(O,Ui)}const qi=new G(0,0),An=new G(0,0);H.push({tl:ye,tr:si,bl:pi,br:$e,texPrimary:bt,texSecondary:void 0,writingMode:S.writingMode,glyphOffset:Ce,sectionIndex:ct.sectionIndex,isSDF:Et,pixelOffsetTL:qi,pixelOffsetBR:An,minFontScaleX:0,minFontScaleY:0})}}return H}(0,n,l,o,s,a,r,e.allowVerticalPlacement),M=e.textSizeData;let E=null;M.kind==="source"?(E=[ao*o.layout.get("text-size").evaluate(a,{},y)],E[0]>Xs&&J(`${e.layerIds[0]}: Value for "text-size" is >= ${Hc}. Reduce your "text-size".`)):M.kind==="composite"&&(E=[ao*_.compositeTextSizes[0].evaluate(a,{},y),ao*_.compositeTextSizes[1].evaluate(a,{},y)],(E[0]>Xs||E[1]>Xs)&&J(`${e.layerIds[0]}: Value for "text-size" is >= ${Hc}. Reduce your "text-size".`)),e.addSymbols(e.text,b,E,l,s,a,u,t,i,c.lineStartIndex,c.lineLength,p,g,y,x,!1);for(const T of h)d[T]=e.text.placedSymbolArray.length-1;return 4*b.length}function Wv(e){for(const t in e)return e[t];return null}function Nh(e,t,i,n,r,o,s,a,l,c){let u=s.top,h=s.bottom,d=s.left,p=s.right;const _=s.collisionPadding;if(_&&(d-=_[0],u-=_[1],p+=_[2],h+=_[3]),l){const g=new G(d,u),y=new G(p,u),x=new G(d,h),b=new G(p,h),M=wt(l);let E=new G(0,0);c&&(E=new G(c[0],c[1])),g._rotateAround(M,E),y._rotateAround(M,E),x._rotateAround(M,E),b._rotateAround(M,E),d=Math.min(g.x,y.x,x.x,b.x),p=Math.max(g.x,y.x,x.x,b.x),u=Math.min(g.y,y.y,x.y,b.y),h=Math.max(g.y,y.y,x.y,b.y)}return e.emplaceBack(t.x,t.y,t.z,i.x,i.y,d,u,p,h,a,n,r,o),e.length-1}function zm(e){e.collisionPadding&&(e.top-=e.collisionPadding[1],e.bottom+=e.collisionPadding[3]);const t=e.bottom-e.top;return t>0?Math.max(10,t):null}function wA(e,t,i,n){const r=e.compareText;if(t in r){const o=r[t];for(let s=o.length-1;s>=0;s--)if(n.dist(o[s])<i)return!0}else r[t]=[];return r[t].push(n),!1}function $v(e,t){const i=e.fovAboveCenter,n=e.elevation?e.elevation.getMinElevationBelowMSL()*t:0,r=(e._camera.position[2]*e.worldSize-n)/Math.cos(e._pitch),o=Math.sin(i)*r/Math.sin(Math.max(Math.PI/2-e._pitch-i,.01)),s=Math.sin(e._pitch)*o+r;return Math.min(1.01*s,r*(1/e._horizonShift))}function ka(e,t){if(!t.isReprojectedInTileSpace)return{scale:1<<e.z,x:e.x,y:e.y,x2:e.x+1,y2:e.y+1,projection:t};const i=Math.pow(2,-e.z),n=e.x*i,r=(e.x+1)*i,o=e.y*i,s=(e.y+1)*i,a=Sr(n),l=Sr(r),c=On(o),u=On(s),h=t.project(a,c),d=t.project(l,c),p=t.project(l,u),_=t.project(a,u);let g=Math.min(h.x,d.x,p.x,_.x),y=Math.min(h.y,d.y,p.y,_.y),x=Math.max(h.x,d.x,p.x,_.x),b=Math.max(h.y,d.y,p.y,_.y);const M=i/16;function E(S,D,z,L,R,N){const U=(z+R)/2,H=(L+N)/2,O=t.project(Sr(U),On(H)),X=Math.max(0,g-O.x,y-O.y,O.x-x,O.y-b);g=Math.min(g,O.x),x=Math.max(x,O.x),y=Math.min(y,O.y),b=Math.max(b,O.y),X>M&&(E(S,O,z,L,U,H),E(O,D,U,H,R,N))}E(h,d,n,o,r,o),E(d,p,r,o,r,s),E(p,_,r,s,n,s),E(_,h,n,s,n,o),g-=M,y-=M,x+=M,b+=M;const T=1/Math.max(x-g,b-y);return{scale:T,x:g*T,y:y*T,x2:x*T,y2:b*T,projection:t}}function Xv(e,t,i,n,r,o,s,a,l){if(l.name==="globe")return em(e,t,new Yr(i,n,r),!1);const c=ka({z:i,x:n,y:r},l);return new en([(o+c.x/c.scale)*t,t*(c.y/c.scale),s],[(o+c.x2/c.scale)*t,t*(c.y2/c.scale),a])}function Yv(e,{x:t,y:i},n=0){return new G(((t-n)*e.scale-e.x)*pt,(i*e.scale-e.y)*pt)}function Kv(e,t,i=0){return Z.fromValues(((t.x-i)*e.scale-e.x)*pt,(t.y*e.scale-e.y)*pt,U1(t.z,t.y))}const TA=st.identity(new Float32Array(16));class Ys{constructor(t){this.spec=t,this.name=t.name,this.wrap=!1,this.requiresDraping=!1,this.supportsWorldCopies=!1,this.supportsTerrain=!1,this.supportsFog=!1,this.supportsFreeCamera=!1,this.zAxisUnit="meters",this.isReprojectedInTileSpace=!0,this.unsupportedLayers=["custom"],this.center=[0,0],this.range=[3.5,7]}project(t,i){return{x:0,y:0,z:0}}unproject(t,i){return new Le(0,0)}projectTilePoint(t,i,n){return{x:t,y:i,z:0}}locationPoint(t,i,n=!0){return t._coordinatePoint(t.locationCoordinate(i),n)}pixelsPerMeter(t,i){return Gi(1,t)*i}pixelSpaceConversion(t,i,n){return 1}farthestPixelDistance(t){return $v(t,t.pixelsPerMeter)}pointCoordinate(t,i,n,r){const o=t.horizonLineFromTop(!1),s=new G(i,Math.max(o,n));return t.rayIntersectionCoordinate(t.pointRayIntersection(s,r))}pointCoordinate3D(t,i,n){const r=new G(i,n);if(t.elevation)return t.elevation.pointCoordinate(r);{const o=this.pointCoordinate(t,r.x,r.y,0);return[o.x,o.y,o.z]}}isPointAboveHorizon(t,i){if(t.elevation)return!this.pointCoordinate3D(t,i.x,i.y);const n=t.horizonLineFromTop();return i.y<n}createInversionMatrix(t,i){return TA}createTileMatrix(t,i,n){let r,o,s;const a=n.canonical,l=st.identity(new Float64Array(16));if(this.isReprojectedInTileSpace){const c=ka(a,this);r=1,o=c.x+n.wrap*c.scale,s=c.y,st.scale(l,l,[r/c.scale,r/c.scale,t.pixelsPerMeter/i])}else r=i/t.zoomScale(a.z),o=(a.x+Math.pow(2,a.z)*n.wrap)*r,s=a.y*r;return st.translate(l,l,[o,s,0]),st.scale(l,l,[r/pt,r/pt,1]),l}upVector(t,i,n){return[0,0,1]}upVectorScale(t,i,n){return{metersToTile:1}}}class MA extends Ys{constructor(t){super(t),this.range=[4,7],this.center=t.center||[-96,37.5];const[i,n]=this.parallels=t.parallels||[29.5,45.5],r=Math.sin(wt(i));this.n=(r+Math.sin(wt(n)))/2,this.c=1+r*(2*this.n-r),this.r0=Math.sqrt(this.c)/this.n}project(t,i){const{n,c:r,r0:o}=this,s=wt(t-this.center[0]),a=wt(i),l=Math.sqrt(r-2*n*Math.sin(a))/n;return{x:l*Math.sin(s*n),y:l*Math.cos(s*n)-o,z:0}}unproject(t,i){const{n,c:r,r0:o}=this,s=o+i;let a=Math.atan2(t,Math.abs(s))*Math.sign(s);s*n<0&&(a-=Math.PI*Math.sign(t)*Math.sign(s));const l=wt(this.center[0])*n;a=Me(a,-Math.PI-l,Math.PI-l);const c=Lt(ne(a/n)+this.center[0],-180,180),u=Math.asin(Lt((r-(t*t+s*s)*n*n)/(2*n),-1,1)),h=Lt(ne(u),-Sn,Sn);return new Le(c,h)}}const Wc=1.340264,$c=-.081106,Xc=893e-6,Yc=.003796,Uh=Math.sqrt(3)/2;class EA extends Ys{project(t,i){i=i/180*Math.PI,t=t/180*Math.PI;const n=Math.asin(Uh*Math.sin(i)),r=n*n,o=r*r*r;return{x:.5*(t*Math.cos(n)/(Uh*(Wc+3*$c*r+o*(7*Xc+9*Yc*r)))/Math.PI+.5),y:1-.5*(n*(Wc+$c*r+o*(Xc+Yc*r))/Math.PI+1),z:0}}unproject(t,i){t=(2*t-.5)*Math.PI;let n=i=(2*(1-i)-1)*Math.PI,r=n*n,o=r*r*r;for(let u,h,d,p=0;p<12&&(h=n*(Wc+$c*r+o*(Xc+Yc*r))-i,d=Wc+3*$c*r+o*(7*Xc+9*Yc*r),u=h/d,n=Lt(n-u,-Math.PI/3,Math.PI/3),r=n*n,o=r*r*r,!(Math.abs(u)<1e-12));++p);const s=Uh*t*(Wc+3*$c*r+o*(7*Xc+9*Yc*r))/Math.cos(n),a=Math.asin(Math.sin(n)/Uh),l=Lt(180*s/Math.PI,-180,180),c=Lt(180*a/Math.PI,-Sn,Sn);return new Le(l,c)}}class SA extends Ys{constructor(t){super(t),this.wrap=!0,this.supportsWorldCopies=!0}project(t,i){return{x:.5+t/360,y:.5-i/360,z:0}}unproject(t,i){const n=360*(t-.5),r=Lt(360*(.5-i),-Sn,Sn);return new Le(n,r)}}const Ll=Math.PI/2;function Vh(e){return Math.tan((Ll+e)/2)}class AA extends Ys{constructor(t){super(t),this.center=t.center||[0,30];const[i,n]=this.parallels=t.parallels||[30,30];let r=wt(i),o=wt(n);this.southernCenter=r+o<0,this.southernCenter&&(r=-r,o=-o);const s=Math.cos(r),a=Vh(r);this.n=r===o?Math.sin(r):Math.log(s/Math.cos(o))/Math.log(Vh(o)/a),this.f=s*Math.pow(Vh(r),this.n)/this.n}project(t,i){i=wt(i),this.southernCenter&&(i=-i),t=wt(t-this.center[0]);const n=1e-6,{n:r,f:o}=this;o>0?i<-Ll+n&&(i=-Ll+n):i>Ll-n&&(i=Ll-n);const s=o/Math.pow(Vh(i),r);let a=s*Math.sin(r*t),l=o-s*Math.cos(r*t);return a=.5*(a/Math.PI+.5),l=.5*(l/Math.PI+.5),{x:a,y:this.southernCenter?l:1-l,z:0}}unproject(t,i){t=(2*t-.5)*Math.PI,this.southernCenter&&(i=1-i),i=(2*(1-i)-.5)*Math.PI;const{n,f:r}=this,o=r-i,s=Math.sign(o),a=Math.sign(n)*Math.sqrt(t*t+o*o);let l=Math.atan2(t,Math.abs(o))*s;o*n<0&&(l-=Math.PI*Math.sign(t)*s);const c=Lt(ne(l/n)+this.center[0],-180,180),u=Lt(ne(2*Math.atan(Math.pow(r/a,1/n))-Ll),-Sn,Sn);return new Le(c,this.southernCenter?-u:u)}}class Jv extends Ys{constructor(t){super(t),this.wrap=!0,this.supportsWorldCopies=!0,this.supportsTerrain=!0,this.supportsFog=!0,this.supportsFreeCamera=!0,this.isReprojectedInTileSpace=!1,this.unsupportedLayers=[],this.range=null}project(t,i){return{x:Fn(t),y:jn(i),z:0}}unproject(t,i){const n=Sr(t),r=On(i);return new Le(n,r)}}const Qv=wt(Sn);class IA extends Ys{project(t,i){const n=(i=wt(i))*i,r=n*n;return{x:.5*((t=wt(t))*(.8707-.131979*n+r*(r*(.003971*n-.001529*r)-.013791))/Math.PI+.5),y:1-.5*(i*(1.007226+n*(.015085+r*(.028874*n-.044475-.005916*r)))/Math.PI+1),z:0}}unproject(t,i){t=(2*t-.5)*Math.PI;let n=i=(2*(1-i)-1)*Math.PI,r=25,o=0,s=n*n;do{s=n*n;const c=s*s;o=(n*(1.007226+s*(.015085+c*(.028874*s-.044475-.005916*c)))-i)/(1.007226+s*(.045255+c*(.259866*s-.311325-.005916*11*c))),n=Lt(n-o,-Qv,Qv)}while(Math.abs(o)>1e-6&&--r>0);s=n*n;const a=Lt(ne(t/(.8707+s*(s*(s*s*s*(.003971-.001529*s)-.013791)-.131979))),-180,180),l=ne(n);return new Le(a,l)}}const tx=wt(Sn);class CA extends Ys{project(t,i){i=wt(i),t=wt(t);const n=Math.cos(i),r=2/Math.PI,o=Math.acos(n*Math.cos(t/2)),s=Math.sin(o)/o,a=.5*(t*r+2*n*Math.sin(t/2)/s)||0,l=.5*(i+Math.sin(i)/s)||0;return{x:.5*(a/Math.PI+.5),y:1-.5*(l/Math.PI+1),z:0}}unproject(t,i){let n=t=(2*t-.5)*Math.PI,r=i=(2*(1-i)-1)*Math.PI,o=25;const s=1e-6;let a=0,l=0;do{const c=Math.cos(r),u=Math.sin(r),h=2*u*c,d=u*u,p=c*c,_=Math.cos(n/2),g=Math.sin(n/2),y=2*_*g,x=g*g,b=1-p*_*_,M=b?1/b:0,E=b?Math.acos(c*_)*Math.sqrt(1/b):0,T=.5*(2*E*c*g+2*n/Math.PI)-t,S=.5*(E*u+r)-i,D=.5*M*(p*x+E*c*_*d)+1/Math.PI,z=M*(y*h/4-E*u*g),L=.125*M*(h*g-E*u*p*y),R=.5*M*(d*_+E*x*c)+.5,N=z*L-R*D;a=(S*z-T*R)/N,l=(T*L-S*D)/N,n=Lt(n-a,-Math.PI,Math.PI),r=Lt(r-l,-tx,tx)}while((Math.abs(a)>s||Math.abs(l)>s)&&--o>0);return new Le(ne(n),ne(r))}}class ex extends Ys{constructor(t){super(t),this.center=t.center||[0,0],this.parallels=t.parallels||[0,0],this.cosPhi=Math.max(.01,Math.cos(wt(this.parallels[0]))),this.scale=1/(2*Math.max(Math.PI*this.cosPhi,1/this.cosPhi)),this.wrap=!0,this.supportsWorldCopies=!0}project(t,i){const{scale:n,cosPhi:r}=this;return{x:wt(t)*r*n+.5,y:-Math.sin(wt(i))/r*n+.5,z:0}}unproject(t,i){const{scale:n,cosPhi:r}=this,o=-(i-.5)/n,s=Lt(ne((t-.5)/n)/r,-180,180),a=Math.asin(Lt(o*r,-1,1)),l=Lt(ne(a),-Sn,Sn);return new Le(s,l)}}class DA extends Jv{constructor(t){super(t),this.requiresDraping=!0,this.supportsWorldCopies=!1,this.supportsFog=!0,this.zAxisUnit="pixels",this.unsupportedLayers=["debug"],this.range=[3,5]}projectTilePoint(t,i,n){const r=Bc(t,i,n),o=js(Fr(n));return Z.transformMat4(r,r,o),{x:r[0],y:r[1],z:r[2]}}locationPoint(t,i){const n=gr(i.lat,i.lng),r=Z.normalize([],n),o=t.elevation?t.elevation.getAtPointOrZero(t.locationCoordinate(i),t._centerAltitude):t._centerAltitude,s=Gi(1,0)*pt*o;Z.scaleAndAdd(n,n,r,s);const a=st.identity(new Float64Array(16));return st.multiply(a,t.pixelMatrix,t.globeMatrix),Z.transformMat4(n,n,a),new G(n[0],n[1])}pixelsPerMeter(t,i){return Gi(1,0)*i}pixelSpaceConversion(t,i,n){const r=Gi(1,t)*i,o=ze(Gi(1,45)*i,r,n);return this.pixelsPerMeter(t,i)/o}createTileMatrix(t,i,n){const r=nm(Fr(n.canonical));return st.multiply(new Float64Array(16),t.globeMatrix,r)}createInversionMatrix(t,i){const{center:n}=t,r=js(Fr(i));return st.rotateY(r,r,wt(n.lng)),st.rotateX(r,r,wt(n.lat)),st.scale(r,r,[t._pixelsPerMercatorPixel,t._pixelsPerMercatorPixel,1]),Float32Array.from(r)}pointCoordinate(t,i,n,r){return A1(t,i,n,!0)||new ui(0,0)}pointCoordinate3D(t,i,n){const r=this.pointCoordinate(t,i,n,0);return[r.x,r.y,r.z]}isPointAboveHorizon(t,i){return!A1(t,i.x,i.y,!1)}farthestPixelDistance(t){const i=function(r,o){const s=r.cameraToCenterDistance,a=r._centerAltitude*o,l=r._camera,c=r._camera.forward(),u=Z.add([],Z.scale([],c,-s),[0,0,a]),h=r.worldSize/(2*Math.PI),d=[0,0,-h],p=r.width/r.height,_=Math.tan(r.fovAboveCenter),g=Z.scale([],l.up(),_),y=Z.scale([],l.right(),_*p),x=Z.normalize([],Z.add([],Z.add([],c,g),y)),b=[];let M;if(new hh(u,x).closestPointOnSphere(d,h,b)){const E=Z.add([],b,d),T=Z.sub([],E,u);M=Math.cos(r.fovAboveCenter)*Z.length(T)}else{const E=Z.sub([],u,d),T=Z.sub([],d,u);Z.normalize(T,T);const S=Z.length(E)-h;M=Math.sqrt(S*(S+2*h));const D=Math.acos(M/(h+S))-Math.acos(Z.dot(c,T));M*=Math.cos(D)}return 1.01*M}(t,this.pixelsPerMeter(t.center.lat,t.worldSize)),n=Wn(t.zoom);if(n>0){const r=$v(t,Gi(1,t.center.lat)*t.worldSize),o=t.worldSize/(2*Math.PI),s=Math.max(t.width,t.height)/t.worldSize*Math.PI;return ze(i,r+o*(1-Math.cos(s)),Math.pow(n,10))}return i}upVector(t,i,n){return Bc(i,n,t,1)}upVectorScale(t){return{metersToTile:dh(ph(Fr(t)))}}}function jh(e){const t=e.parallels,i=!!t&&Math.abs(t[0]+t[1])<.01;switch(e.name){case"mercator":return new Jv(e);case"equirectangular":return new SA(e);case"naturalEarth":return new IA(e);case"equalEarth":return new EA(e);case"winkelTripel":return new CA(e);case"albers":return i?new ex(e):new MA(e);case"lambertConformalConic":return i?new ex(e):new AA(e);case"globe":return new DA(e)}throw new Error(`Invalid projection name: ${e.name}`)}const PA=new wn({"symbol-placement":new Gt(rt.layout_symbol["symbol-placement"]),"symbol-spacing":new Gt(rt.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new Gt(rt.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new ve(rt.layout_symbol["symbol-sort-key"]),"symbol-z-order":new Gt(rt.layout_symbol["symbol-z-order"]),"symbol-z-elevate":new Gt(rt.layout_symbol["symbol-z-elevate"]),"icon-allow-overlap":new Gt(rt.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new Gt(rt.layout_symbol["icon-ignore-placement"]),"icon-optional":new Gt(rt.layout_symbol["icon-optional"]),"icon-rotation-alignment":new Gt(rt.layout_symbol["icon-rotation-alignment"]),"icon-size":new ve(rt.layout_symbol["icon-size"]),"icon-text-fit":new ve(rt.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new ve(rt.layout_symbol["icon-text-fit-padding"]),"icon-image":new ve(rt.layout_symbol["icon-image"]),"icon-rotate":new ve(rt.layout_symbol["icon-rotate"]),"icon-padding":new Gt(rt.layout_symbol["icon-padding"]),"icon-keep-upright":new Gt(rt.layout_symbol["icon-keep-upright"]),"icon-offset":new ve(rt.layout_symbol["icon-offset"]),"icon-anchor":new ve(rt.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new Gt(rt.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new Gt(rt.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new Gt(rt.layout_symbol["text-rotation-alignment"]),"text-field":new ve(rt.layout_symbol["text-field"]),"text-font":new ve(rt.layout_symbol["text-font"]),"text-size":new ve(rt.layout_symbol["text-size"]),"text-max-width":new ve(rt.layout_symbol["text-max-width"]),"text-line-height":new ve(rt.layout_symbol["text-line-height"]),"text-letter-spacing":new ve(rt.layout_symbol["text-letter-spacing"]),"text-justify":new ve(rt.layout_symbol["text-justify"]),"text-radial-offset":new ve(rt.layout_symbol["text-radial-offset"]),"text-variable-anchor":new Gt(rt.layout_symbol["text-variable-anchor"]),"text-anchor":new ve(rt.layout_symbol["text-anchor"]),"text-max-angle":new Gt(rt.layout_symbol["text-max-angle"]),"text-writing-mode":new Gt(rt.layout_symbol["text-writing-mode"]),"text-rotate":new ve(rt.layout_symbol["text-rotate"]),"text-padding":new Gt(rt.layout_symbol["text-padding"]),"text-keep-upright":new Gt(rt.layout_symbol["text-keep-upright"]),"text-transform":new ve(rt.layout_symbol["text-transform"]),"text-offset":new ve(rt.layout_symbol["text-offset"]),"text-allow-overlap":new Gt(rt.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new Gt(rt.layout_symbol["text-ignore-placement"]),"text-optional":new Gt(rt.layout_symbol["text-optional"]),visibility:new Gt(rt.layout_symbol.visibility)});var Lm={paint:new wn({"icon-opacity":new ve(rt.paint_symbol["icon-opacity"]),"icon-emissive-strength":new ve(rt.paint_symbol["icon-emissive-strength"]),"text-emissive-strength":new ve(rt.paint_symbol["text-emissive-strength"]),"icon-color":new ve(rt.paint_symbol["icon-color"]),"icon-halo-color":new ve(rt.paint_symbol["icon-halo-color"]),"icon-halo-width":new ve(rt.paint_symbol["icon-halo-width"]),"icon-halo-blur":new ve(rt.paint_symbol["icon-halo-blur"]),"icon-translate":new Gt(rt.paint_symbol["icon-translate"]),"icon-translate-anchor":new Gt(rt.paint_symbol["icon-translate-anchor"]),"icon-image-cross-fade":new ve(rt.paint_symbol["icon-image-cross-fade"]),"text-opacity":new ve(rt.paint_symbol["text-opacity"]),"text-color":new ve(rt.paint_symbol["text-color"],{runtimeType:hr,getOverride:e=>e.textColor,hasOverride:e=>!!e.textColor}),"text-halo-color":new ve(rt.paint_symbol["text-halo-color"]),"text-halo-width":new ve(rt.paint_symbol["text-halo-width"]),"text-halo-blur":new ve(rt.paint_symbol["text-halo-blur"]),"text-translate":new Gt(rt.paint_symbol["text-translate"]),"text-translate-anchor":new Gt(rt.paint_symbol["text-translate-anchor"]),"icon-color-saturation":new Gt(rt.paint_symbol["icon-color-saturation"])}),layout:PA};class ix{constructor(t){this.type=t.property.overrides?t.property.overrides.runtimeType:Eo,this.defaultValue=t}evaluate(t){if(t.formattedSection){const i=this.defaultValue.property.overrides;if(i&&i.hasOverride(t.formattedSection))return i.getOverride(t.formattedSection)}return t.feature&&t.featureState?this.defaultValue.evaluate(t.feature,t.featureState):this.defaultValue.property.specification.default}eachChild(t){this.defaultValue.isConstant()||t(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}he(ix,"FormatSectionOverride",{omit:["defaultValue"]});class Gh extends Rr{constructor(t,i){super(t,Lm,i)}recalculate(t,i){super.recalculate(t,i),this.layout.get("icon-rotation-alignment")==="auto"&&(this.layout._values["icon-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-rotation-alignment")==="auto"&&(this.layout._values["text-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-pitch-alignment")==="auto"&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),this.layout.get("icon-pitch-alignment")==="auto"&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));const n=this.layout.get("text-writing-mode");if(n){const r=[];for(const o of n)r.indexOf(o)<0&&r.push(o);this.layout._values["text-writing-mode"]=r}else this.layout._values["text-writing-mode"]=this.layout.get("symbol-placement")==="point"?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getValueAndResolveTokens(t,i,n,r){const o=this.layout.get(t).evaluate(i,{},n,r),s=this._unevaluatedLayout._values[t];return s.isDataDriven()||Vu(s.value)||!o?o:function(a,l){return l.replace(/{([^{}]+)}/g,(c,u)=>u in a?String(a[u]):"")}(i.properties,o)}createBucket(t){return new Kc(t)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(const t of Lm.paint.overridableProperties){if(!Gh.hasPaintOverride(this.layout,t))continue;const i=this.paint.get(t),n=new ix(i),r=new Qf(n,i.property.specification);let o=null;o=i.value.kind==="constant"||i.value.kind==="source"?new tp("source",r):new ks("composite",r,i.value.zoomStops,i.value._interpolationType),this.paint._values[t]=new _l(i.property,o,i.parameters)}}_handleOverridablePaintPropertyUpdate(t,i,n){return!(!this.layout||i.isDataDriven()||n.isDataDriven())&&Gh.hasPaintOverride(this.layout,t)}static hasPaintOverride(t,i){const n=t.get("text-field"),r=Lm.paint.properties[i];let o=!1;const s=a=>{for(const l of a)if(r.overrides&&r.overrides.hasOverride(l))return void(o=!0)};if(n.value.kind==="constant"&&n.value.value instanceof br)s(n.value.value.sections);else if(n.value.kind==="source"){const a=c=>{o||(c instanceof pc&&qn(c.value)===Yo?s(c.value.sections):c instanceof mc?s(c.sections):c.eachChild(a))},l=n.value;l._styleExpression&&a(l._styleExpression.expression)}return o}getProgramIds(){const t=this.paint.get("icon-opacity").constantOr(1)!==0,i=this.paint.get("text-opacity").constantOr(1)!==0,n=[];return t&&n.push("symbolIcon"),i&&n.push("symbolSDF"),n}getDefaultProgramParams(t,i){return{config:new Ia(this,i),overrideFog:!1}}}const kA=Ih.types,zA=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function qh(e,t,i,n,r,o,s,a,l,c,u,h,d){const p=a?Math.min(Xs,Math.round(a[0])):0,_=a?Math.min(Xs,Math.round(a[1])):0;e.emplaceBack(t,i,Math.round(32*n),Math.round(32*r),o,s,(p<<1)+(l?1:0),_,16*c,16*u,256*h,256*d)}function Zh(e,t,i){e.emplaceBack(t,i)}function Hh(e,t,i,n,r,o,s){e.emplaceBack(t,i,n,r,o,s)}function Wh(e,t,i,n,r){const o=5*t+2;e.float32[o+0]=i,e.float32[o+1]=n,e.float32[o+2]=r}function Rl(e,t,i,n,r){e.emplaceBack(t,i,n,r),e.emplaceBack(t,i,n,r),e.emplaceBack(t,i,n,r),e.emplaceBack(t,i,n,r)}function LA(e){for(const t of e.sections)if(YM(t.text))return!0;return!1}class Rm{constructor(t){this.layoutVertexArray=new yp,this.indexArray=new Rn,this.programConfigurations=t,this.segments=new Fi,this.dynamicLayoutVertexArray=new is,this.opacityVertexArray=new xp,this.placedSymbolArray=new $0,this.iconTransitioningVertexArray=new Os,this.globeExtVertexArray=new vp,this.zOffsetVertexArray=new Cc}isEmpty(){return this.layoutVertexArray.length===0&&this.indexArray.length===0&&this.dynamicLayoutVertexArray.length===0&&this.opacityVertexArray.length===0&&this.iconTransitioningVertexArray.length===0}upload(t,i,n,r,o){this.isEmpty()||(n&&(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,YS.members),this.indexBuffer=t.createIndexBuffer(this.indexArray,i),this.dynamicLayoutVertexBuffer=t.createVertexBuffer(this.dynamicLayoutVertexArray,JS.members,!0),this.opacityVertexBuffer=t.createVertexBuffer(this.opacityVertexArray,zA,!0),this.iconTransitioningVertexArray.length>0&&(this.iconTransitioningVertexBuffer=t.createVertexBuffer(this.iconTransitioningVertexArray,tA.members,!0)),this.globeExtVertexArray.length>0&&(this.globeExtVertexBuffer=t.createVertexBuffer(this.globeExtVertexArray,KS.members,!0)),!this.zOffsetVertexBuffer&&(this.zOffsetVertexArray.length>0||o)&&(this.zOffsetVertexBuffer=t.createVertexBuffer(this.zOffsetVertexArray,QS.members,!0)),this.opacityVertexBuffer.itemSize=1),(n||r)&&this.programConfigurations.upload(t))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy(),this.iconTransitioningVertexBuffer&&this.iconTransitioningVertexBuffer.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy())}}he(Rm,"SymbolBuffers");class Om{constructor(t,i,n){this.layoutVertexArray=new t,this.layoutAttributes=i,this.indexArray=new n,this.segments=new Fi,this.collisionVertexArray=new Tp,this.collisionVertexArrayExt=new is}upload(t){this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=t.createVertexBuffer(this.collisionVertexArray,eA.members,!0),this.collisionVertexBufferExt=t.createVertexBuffer(this.collisionVertexArrayExt,iA.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}}he(Om,"CollisionBuffers");class $h{constructor(t){this.collisionBoxArray=t.collisionBoxArray,this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(s=>s.fqid),this.index=t.index,this.pixelRatio=t.pixelRatio,this.sourceLayerIndex=t.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.hasAnyIconTextFit=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=st.identity([]),this.placementViewportMatrix=st.identity([]);const i=this.layers[0]._unevaluatedLayout._values;this.textSizeData=Em(this.zoom,i["text-size"]),this.iconSizeData=Em(this.zoom,i["icon-size"]);const n=this.layers[0].layout,r=n.get("symbol-sort-key"),o=n.get("symbol-z-order");this.canOverlap=n.get("text-allow-overlap")||n.get("icon-allow-overlap")||n.get("text-ignore-placement")||n.get("icon-ignore-placement"),this.sortFeaturesByKey=o!=="viewport-y"&&r.constantOr(1)!==void 0,this.sortFeaturesByY=(o==="viewport-y"||o==="auto"&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=n.get("text-writing-mode").map(s=>un[s]),this.stateDependentLayerIds=this.layers.filter(s=>s.isStateDependent()).map(s=>s.id),this.sourceID=t.sourceID,this.projection=t.projection,this.hasAnyZOffset=!1,this.zOffsetSortDirty=!1,this.zOffsetBuffersNeedUpload=n.get("symbol-z-elevate")}createArrays(){this.text=new Rm(new Fs(this.layers,this.zoom,t=>/^text/.test(t))),this.icon=new Rm(new Fs(this.layers,this.zoom,t=>/^icon/.test(t))),this.glyphOffsetArray=new K0,this.lineVertexArray=new J0,this.symbolInstances=new Y0}calculateGlyphDependencies(t,i,n,r,o){for(let s=0;s<t.length;s++){const a=t.codePointAt(s);if(a===void 0)break;if(i[a]=!0,r&&o&&a<=65535){const l=Gc[t.charAt(s)];l&&(i[l.charCodeAt(0)]=!0)}}}populate(t,i,n,r){const o=this.layers[0],s=o.layout,a=this.projection.name==="globe",l=s.get("text-font"),c=s.get("text-field"),u=s.get("icon-image"),h=(c.value.kind!=="constant"||c.value.value instanceof br&&!c.value.value.isEmpty()||c.value.value.toString().length>0)&&(l.value.kind!=="constant"||l.value.value.length>0),d=u.value.kind!=="constant"||!!u.value.value||Object.keys(u.parameters).length>0,p=s.get("symbol-sort-key");if(this.features=[],!h&&!d)return;const _=i.iconDependencies,g=i.glyphDependencies,y=i.availableImages,x=new dn(this.zoom);for(const{feature:b,id:M,index:E,sourceLayerIndex:T}of t){const S=o._featureFilter.needGeometry,D=Zs(b,S);if(!o._featureFilter.filter(x,D,n))continue;if(S||(D.geometry=Po(b,n,r)),a&&b.type!==1&&n.z<=5){const N=D.geometry,U=.98078528056,H=(O,X)=>{const K=Bc(O.x,O.y,n,1),ot=Bc(X.x,X.y,n,1);return Z.dot(K,ot)<U};for(let O=0;O<N.length;O++)N[O]=GE(N[O],H)}let z,L;if(h){const N=o.getValueAndResolveTokens("text-field",D,n,y),U=br.factory(N);LA(U)&&(this.hasRTLText=!0),(!this.hasRTLText||pp()==="unavailable"||this.hasRTLText&&$r.isParsed())&&(z=oA(U,o,D))}if(d){const N=o.getValueAndResolveTokens("icon-image",D,n,y);L=N instanceof Hr?N:Hr.fromString(N)}if(!z&&!L)continue;const R=this.sortFeaturesByKey?p.evaluate(D,{},n):void 0;if(this.features.push({id:M,text:z,icon:L,index:E,sourceLayerIndex:T,geometry:D.geometry,properties:b.properties,type:kA[b.type],sortKey:R}),L&&(_[L.namePrimary]=!0,L.nameSecondary&&(_[L.nameSecondary]=!0)),z){const N=l.evaluate(D,{},n).join(","),U=s.get("text-rotation-alignment")==="map"&&s.get("symbol-placement")!=="point";this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(un.vertical)>=0;for(const H of z.sections)if(H.image)_[H.image.namePrimary]=!0;else{const O=sp(z.toString()),X=H.fontStack||N,K=g[X]=g[X]||{};this.calculateGlyphDependencies(H.text,K,U,this.allowVerticalPlacement,O)}}}s.get("symbol-placement")==="line"&&(this.features=function(b){const M={},E={},T=[];let S=0;function D(N){T.push(b[N]),S++}function z(N,U,H){const O=E[N];return delete E[N],E[U]=O,T[O].geometry[0].pop(),T[O].geometry[0]=T[O].geometry[0].concat(H[0]),O}function L(N,U,H){const O=M[U];return delete M[U],M[N]=O,T[O].geometry[0].shift(),T[O].geometry[0]=H[0].concat(T[O].geometry[0]),O}function R(N,U,H){const O=H?U[0][U[0].length-1]:U[0][0];return`${N}:${O.x}:${O.y}`}for(let N=0;N<b.length;N++){const U=b[N],H=U.geometry,O=U.text?U.text.toString():null;if(!O){D(N);continue}const X=R(O,H),K=R(O,H,!0);if(X in E&&K in M&&E[X]!==M[K]){const ot=L(X,K,H),$=z(X,K,T[ot].geometry);delete M[X],delete E[K],E[R(O,T[$].geometry,!0)]=$,T[ot].geometry=null}else X in E?z(X,K,H):K in M?L(X,K,H):(D(N),M[X]=S-1,E[K]=S-1)}return T.filter(N=>N.geometry)}(this.features)),this.sortFeaturesByKey&&this.features.sort((b,M)=>b.sortKey-M.sortKey)}update(t,i,n,r,o){const s=Object.keys(t).length!==0;if(s&&!this.stateDependentLayers.length)return;const a=s?this.stateDependentLayers:this.layers;this.text.programConfigurations.updatePaintArrays(t,i,a,n,r,o),this.icon.programConfigurations.updatePaintArrays(t,i,a,n,r,o)}updateZOffset(){const t=(o,s,a)=>{n+=s,n>o.length&&o.resize(n);for(let l=-s;l<0;l++)o.emplace(l+n,a)},i=(o,s,a)=>{r+=s,r>o.length&&o.resize(r);for(let l=-s;l<0;l++)o.emplace(l+r,a)};if(!this.zOffsetBuffersNeedUpload)return;this.zOffsetBuffersNeedUpload=!1;let n=0,r=0;for(let o=0;o<this.symbolInstances.length;o++){const s=this.symbolInstances.get(o),{numHorizontalGlyphVertices:a,numVerticalGlyphVertices:l,numIconVertices:c}=s,u=s.zOffset,h=c>0;if((a>0||l>0)&&(t(this.text.zOffsetVertexArray,a,u),t(this.text.zOffsetVertexArray,l,u)),h){const{placedIconSymbolIndex:d,verticalPlacedIconSymbolIndex:p}=s;d>=0&&i(this.icon.zOffsetVertexArray,c,u),p>=0&&i(this.icon.zOffsetVertexArray,s.numVerticalIconVertices,u)}}this.text.zOffsetVertexBuffer&&this.text.zOffsetVertexBuffer.updateData(this.text.zOffsetVertexArray),this.icon.zOffsetVertexBuffer&&this.icon.zOffsetVertexBuffer.updateData(this.icon.zOffsetVertexArray)}isEmpty(){return this.symbolInstances.length===0&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(t){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(t),this.iconCollisionBox.upload(t)),this.text.upload(t,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.icon.upload(t,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}getProjection(){return this.projectionInstance||(this.projectionInstance=jh(this.projection)),this.projectionInstance}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(t,i){const n=this.lineVertexArray.length;if(t.segment!==void 0)for(const{x:r,y:o}of i)this.lineVertexArray.emplaceBack(r,o);return{lineStartIndex:n,lineLength:this.lineVertexArray.length-n}}addSymbols(t,i,n,r,o,s,a,l,c,u,h,d,p,_,g,y){const x=t.indexArray,b=t.layoutVertexArray,M=t.globeExtVertexArray,E=t.segments.prepareSegment(4*i.length,b,x,this.canOverlap?s.sortKey:void 0),T=this.glyphOffsetArray.length,S=E.vertexLength,D=this.allowVerticalPlacement&&a===un.vertical?Math.PI/2:0,z=s.text&&s.text.sections;for(let R=0;R<i.length;R++){const{tl:N,tr:U,bl:H,br:O,texPrimary:X,texSecondary:K,pixelOffsetTL:ot,pixelOffsetBR:$,minFontScaleX:Y,minFontScaleY:at,glyphOffset:ut,isSDF:ct,sectionIndex:bt}=i[R],Mt=E.vertexLength,Et=ut[1];if(qh(b,c.x,c.y,N.x,Et+N.y,X.x,X.y,n,ct,ot.x,ot.y,Y,at),qh(b,c.x,c.y,U.x,Et+U.y,X.x+X.w,X.y,n,ct,$.x,ot.y,Y,at),qh(b,c.x,c.y,H.x,Et+H.y,X.x,X.y+X.h,n,ct,ot.x,$.y,Y,at),qh(b,c.x,c.y,O.x,Et+O.y,X.x+X.w,X.y+X.h,n,ct,$.x,$.y,Y,at),l){const{x:ft,y:kt,z:Qt}=l.anchor,[te,oe,ce]=l.up;Hh(M,ft,kt,Qt,te,oe,ce),Hh(M,ft,kt,Qt,te,oe,ce),Hh(M,ft,kt,Qt,te,oe,ce),Hh(M,ft,kt,Qt,te,oe,ce),Rl(t.dynamicLayoutVertexArray,ft,kt,Qt,D)}else Rl(t.dynamicLayoutVertexArray,c.x,c.y,c.z,D);if(y){const ft=K||X;Zh(t.iconTransitioningVertexArray,ft.x,ft.y),Zh(t.iconTransitioningVertexArray,ft.x+ft.w,ft.y),Zh(t.iconTransitioningVertexArray,ft.x,ft.y+ft.h),Zh(t.iconTransitioningVertexArray,ft.x+ft.w,ft.y+ft.h)}x.emplaceBack(Mt,Mt+1,Mt+2),x.emplaceBack(Mt+1,Mt+2,Mt+3),E.vertexLength+=4,E.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(ut[0]),R!==i.length-1&&bt===i[R+1].sectionIndex||t.programConfigurations.populatePaintArrays(b.length,s,s.index,{},p,_,g,z&&z[bt])}const L=l?l.anchor:c;t.placedSymbolArray.emplaceBack(L.x,L.y,L.z,c.x,c.y,T,this.glyphOffsetArray.length-T,S,u,h,c.segment,n?n[0]:0,n?n[1]:0,r[0],r[1],a,0,!1,0,d,0)}_commitLayoutVertex(t,i,n,r,o,s,a){t.emplaceBack(i,n,r,o,s,Math.round(a.x),Math.round(a.y))}_addCollisionDebugVertices(t,i,n,r,o,s,a){const l=n.segments.prepareSegment(4,n.layoutVertexArray,n.indexArray),c=l.vertexLength,u=a.tileAnchorX,h=a.tileAnchorY;for(let p=0;p<4;p++)n.collisionVertexArray.emplaceBack(0,0,0,0);this._commitDebugCollisionVertexUpdate(n.collisionVertexArrayExt,i,t.padding,a.zOffset),this._commitLayoutVertex(n.layoutVertexArray,r,o,s,u,h,new G(t.x1,t.y1)),this._commitLayoutVertex(n.layoutVertexArray,r,o,s,u,h,new G(t.x2,t.y1)),this._commitLayoutVertex(n.layoutVertexArray,r,o,s,u,h,new G(t.x2,t.y2)),this._commitLayoutVertex(n.layoutVertexArray,r,o,s,u,h,new G(t.x1,t.y2)),l.vertexLength+=4;const d=n.indexArray;d.emplaceBack(c,c+1),d.emplaceBack(c+1,c+2),d.emplaceBack(c+2,c+3),d.emplaceBack(c+3,c),l.primitiveLength+=4}_addTextDebugCollisionBoxes(t,i,n,r,o,s){for(let a=r;a<o;a++){const l=n.get(a),c=this.getSymbolInstanceTextSize(t,s,i,a);this._addCollisionDebugVertices(l,c,this.textCollisionBox,l.projectedAnchorX,l.projectedAnchorY,l.projectedAnchorZ,s)}}_addIconDebugCollisionBoxes(t,i,n,r,o,s){for(let a=r;a<o;a++){const l=n.get(a),c=this.getSymbolInstanceIconSize(t,i,s.placedIconSymbolIndex);this._addCollisionDebugVertices(l,c,this.iconCollisionBox,l.projectedAnchorX,l.projectedAnchorY,l.projectedAnchorZ,s)}}generateCollisionDebugBuffers(t,i){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new Om(nh,Sv.members,Os),this.iconCollisionBox=new Om(nh,Sv.members,Os);const n=ko(this.iconSizeData,t),r=ko(this.textSizeData,t);for(let o=0;o<this.symbolInstances.length;o++){const s=this.symbolInstances.get(o);this._addTextDebugCollisionBoxes(r,t,i,s.textBoxStartIndex,s.textBoxEndIndex,s),this._addTextDebugCollisionBoxes(r,t,i,s.verticalTextBoxStartIndex,s.verticalTextBoxEndIndex,s),this._addIconDebugCollisionBoxes(n,t,i,s.iconBoxStartIndex,s.iconBoxEndIndex,s),this._addIconDebugCollisionBoxes(n,t,i,s.verticalIconBoxStartIndex,s.verticalIconBoxEndIndex,s)}}getSymbolInstanceTextSize(t,i,n,r){const o=this.text.placedSymbolArray.get(i.rightJustifiedTextSymbolIndex>=0?i.rightJustifiedTextSymbolIndex:i.centerJustifiedTextSymbolIndex>=0?i.centerJustifiedTextSymbolIndex:i.leftJustifiedTextSymbolIndex>=0?i.leftJustifiedTextSymbolIndex:i.verticalPlacedTextSymbolIndex>=0?i.verticalPlacedTextSymbolIndex:r),s=jc(this.textSizeData,t,o)/$n;return this.tilePixelRatio*s}getSymbolInstanceIconSize(t,i,n){const r=this.icon.placedSymbolArray.get(n),o=jc(this.iconSizeData,t,r);return this.tilePixelRatio*o}_commitDebugCollisionVertexUpdate(t,i,n,r){t.emplaceBack(i,-n,-n,r),t.emplaceBack(i,n,-n,r),t.emplaceBack(i,n,n,r),t.emplaceBack(i,-n,n,r)}_updateTextDebugCollisionBoxes(t,i,n,r,o,s){for(let a=r;a<o;a++){const l=n.get(a),c=this.getSymbolInstanceTextSize(t,s,i,a);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,c,l.padding,s.zOffset)}}_updateIconDebugCollisionBoxes(t,i,n,r,o,s){for(let a=r;a<o;a++){const l=n.get(a),c=this.getSymbolInstanceIconSize(t,i,s.placedIconSymbolIndex);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,c,l.padding,s.zOffset)}}updateCollisionDebugBuffers(t,i){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();const n=ko(this.iconSizeData,t),r=ko(this.textSizeData,t);for(let o=0;o<this.symbolInstances.length;o++){const s=this.symbolInstances.get(o);this._updateTextDebugCollisionBoxes(r,t,i,s.textBoxStartIndex,s.textBoxEndIndex,s),this._updateTextDebugCollisionBoxes(r,t,i,s.verticalTextBoxStartIndex,s.verticalTextBoxEndIndex,s),this._updateIconDebugCollisionBoxes(n,t,i,s.iconBoxStartIndex,s.iconBoxEndIndex,s),this._updateIconDebugCollisionBoxes(n,t,i,s.verticalIconBoxStartIndex,s.verticalIconBoxEndIndex,s)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(t,i,n,r,o,s,a,l,c){const u={};if(i<n){const{x1:h,y1:d,x2:p,y2:_,padding:g,projectedAnchorX:y,projectedAnchorY:x,projectedAnchorZ:b,tileAnchorX:M,tileAnchorY:E,featureIndex:T}=t.get(i);u.textBox={x1:h,y1:d,x2:p,y2:_,padding:g,projectedAnchorX:y,projectedAnchorY:x,projectedAnchorZ:b,tileAnchorX:M,tileAnchorY:E},u.textFeatureIndex=T}if(r<o){const{x1:h,y1:d,x2:p,y2:_,padding:g,projectedAnchorX:y,projectedAnchorY:x,projectedAnchorZ:b,tileAnchorX:M,tileAnchorY:E,featureIndex:T}=t.get(r);u.verticalTextBox={x1:h,y1:d,x2:p,y2:_,padding:g,projectedAnchorX:y,projectedAnchorY:x,projectedAnchorZ:b,tileAnchorX:M,tileAnchorY:E},u.verticalTextFeatureIndex=T}if(s<a){const{x1:h,y1:d,x2:p,y2:_,padding:g,projectedAnchorX:y,projectedAnchorY:x,projectedAnchorZ:b,tileAnchorX:M,tileAnchorY:E,featureIndex:T}=t.get(s);u.iconBox={x1:h,y1:d,x2:p,y2:_,padding:g,projectedAnchorX:y,projectedAnchorY:x,projectedAnchorZ:b,tileAnchorX:M,tileAnchorY:E},u.iconFeatureIndex=T}if(l<c){const{x1:h,y1:d,x2:p,y2:_,padding:g,projectedAnchorX:y,projectedAnchorY:x,projectedAnchorZ:b,tileAnchorX:M,tileAnchorY:E,featureIndex:T}=t.get(l);u.verticalIconBox={x1:h,y1:d,x2:p,y2:_,padding:g,projectedAnchorX:y,projectedAnchorY:x,projectedAnchorZ:b,tileAnchorX:M,tileAnchorY:E},u.verticalIconFeatureIndex=T}return u}deserializeCollisionBoxes(t){this.collisionArrays=[];for(let i=0;i<this.symbolInstances.length;i++){const n=this.symbolInstances.get(i);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(t,n.textBoxStartIndex,n.textBoxEndIndex,n.verticalTextBoxStartIndex,n.verticalTextBoxEndIndex,n.iconBoxStartIndex,n.iconBoxEndIndex,n.verticalIconBoxStartIndex,n.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}hasIconTextFit(){return this.hasAnyIconTextFit}addIndicesForPlacedSymbol(t,i){const n=t.placedSymbolArray.get(i),r=n.vertexStartIndex+4*n.numGlyphs;for(let o=n.vertexStartIndex;o<r;o+=4)t.indexArray.emplaceBack(o,o+1,o+2),t.indexArray.emplaceBack(o+1,o+2,o+3)}getSortedSymbolIndexes(t){if(this.sortedAngle===t&&this.symbolInstanceIndexes!==void 0)return this.symbolInstanceIndexes;const i=Math.sin(t),n=Math.cos(t),r=[],o=[],s=[];for(let a=0;a<this.symbolInstances.length;++a){s.push(a);const l=this.symbolInstances.get(a);r.push(0|Math.round(i*l.tileAnchorX+n*l.tileAnchorY)),o.push(l.featureIndex)}return s.sort((a,l)=>r[a]-r[l]||o[l]-o[a]),s}getSortedIndexesByZOffset(){if(!this.zOffsetSortDirty)return this.symbolInstanceIndexesSortedZOffset;if(!this.symbolInstanceIndexesSortedZOffset){this.symbolInstanceIndexesSortedZOffset=[];for(let t=0;t<this.symbolInstances.length;++t)this.symbolInstanceIndexesSortedZOffset.push(t)}return this.zOffsetSortDirty=!1,this.symbolInstanceIndexesSortedZOffset.sort((t,i)=>this.symbolInstances.get(i).zOffset-this.symbolInstances.get(t).zOffset)}addToSortKeyRanges(t,i){const n=this.sortKeyRanges[this.sortKeyRanges.length-1];n&&n.sortKey===i?n.symbolInstanceEnd=t+1:this.sortKeyRanges.push({sortKey:i,symbolInstanceStart:t,symbolInstanceEnd:t+1})}sortFeatures(t){if(this.sortFeaturesByY&&this.sortedAngle!==t&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(t),this.sortedAngle=t,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const i of this.symbolInstanceIndexes){const n=this.symbolInstances.get(i);this.featureSortOrder.push(n.featureIndex);const{rightJustifiedTextSymbolIndex:r,centerJustifiedTextSymbolIndex:o,leftJustifiedTextSymbolIndex:s,verticalPlacedTextSymbolIndex:a,placedIconSymbolIndex:l,verticalPlacedIconSymbolIndex:c}=n;r>=0&&this.addIndicesForPlacedSymbol(this.text,r),o>=0&&o!==r&&this.addIndicesForPlacedSymbol(this.text,o),s>=0&&s!==o&&s!==r&&this.addIndicesForPlacedSymbol(this.text,s),a>=0&&this.addIndicesForPlacedSymbol(this.text,a),l>=0&&this.addIndicesForPlacedSymbol(this.icon,l),c>=0&&this.addIndicesForPlacedSymbol(this.icon,c)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}he($h,"SymbolBucket",{omit:["layers","collisionBoxArray","features","compareText"]}),$h.MAX_GLYPHS=65535,$h.addDynamicAttributes=Rl;var Kc=$h;const RA=zi([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),{members:OA}=RA,BA=zi([{name:"a_packed",components:4,type:"Float32"}]),{members:FA}=BA,NA=Ih.types,UA=Math.cos(Math.PI/180*37.5);class Xh{constructor(t){this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(i=>i.fqid),this.index=t.index,this.projection=t.projection,this.hasPattern=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach(i=>{this.gradients[i.id]={}}),this.layoutVertexArray=new gp,this.layoutVertexArray2=new is,this.indexArray=new Rn,this.programConfigurations=new Fs(t.layers,t.zoom),this.segments=new Fi,this.maxLineLength=0,this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id)}populate(t,i,n,r){this.hasPattern=xm("line",this.layers,i);const o=this.layers[0].layout.get("line-sort-key"),s=[];for(const{feature:u,id:h,index:d,sourceLayerIndex:p}of t){const _=this.layers[0]._featureFilter.needGeometry,g=Zs(u,_);if(!this.layers[0]._featureFilter.filter(new dn(this.zoom),g,n))continue;const y=o?o.evaluate(g,{},n):void 0,x={id:h,properties:u.properties,type:u.type,sourceLayerIndex:p,index:d,geometry:_?g.geometry:Po(u,n,r),patterns:{},sortKey:y};s.push(x)}o&&s.sort((u,h)=>u.sortKey-h.sortKey);const{lineAtlas:a,featureIndex:l}=i,c=this.addConstantDashes(a);for(const u of s){const{geometry:h,index:d,sourceLayerIndex:p}=u;if(c&&this.addFeatureDashes(u,a),this.hasPattern){const _=bm("line",this.layers,u,this.zoom,i);this.patternFeatures.push(_)}else this.addFeature(u,h,d,n,a.positions,i.availableImages,i.brightness);l.insert(t[d].feature,h,d,p,this.index)}}addConstantDashes(t){let i=!1;for(const n of this.layers){const r=n.paint.get("line-dasharray").value,o=n.layout.get("line-cap").value;if(r.kind!=="constant"||o.kind!=="constant")i=!0;else{const s=o.value,a=r.value;if(!a)continue;t.addDash(a,s)}}return i}addFeatureDashes(t,i){const n=this.zoom;for(const r of this.layers){const o=r.paint.get("line-dasharray").value,s=r.layout.get("line-cap").value;if(o.kind==="constant"&&s.kind==="constant")continue;let a,l;if(o.kind==="constant"){if(a=o.value,!a)continue}else a=o.evaluate({zoom:n},t);l=s.kind==="constant"?s.value:s.evaluate({zoom:n},t),i.addDash(a,l),t.patterns[r.id]=i.getKey(a,l)}}update(t,i,n,r,o){const s=Object.keys(t).length!==0;s&&!this.stateDependentLayers.length||this.programConfigurations.updatePaintArrays(t,i,s?this.stateDependentLayers:this.layers,n,r,o)}addFeatures(t,i,n,r,o,s){for(const a of this.patternFeatures)this.addFeature(a,a.geometry,a.index,i,n,r,s)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(t){this.uploaded||(this.layoutVertexArray2.length!==0&&(this.layoutVertexBuffer2=t.createVertexBuffer(this.layoutVertexArray2,FA)),this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,OA),this.indexBuffer=t.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(t),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(t){if(t.properties&&t.properties.hasOwnProperty("mapbox_clip_start")&&t.properties.hasOwnProperty("mapbox_clip_end"))return{start:+t.properties.mapbox_clip_start,end:+t.properties.mapbox_clip_end}}addFeature(t,i,n,r,o,s,a){const l=this.layers[0].layout,c=l.get("line-join").evaluate(t,{}),u=l.get("line-cap").evaluate(t,{}),h=l.get("line-miter-limit"),d=l.get("line-round-limit");this.lineClips=this.lineFeatureClips(t);for(const p of i)this.addLine(p,t,c,u,h,d);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,n,o,s,r,a)}addLine(t,i,n,r,o,s){if(this.distance=0,this.scaledDistance=0,this.totalDistance=0,this.lineSoFar=0,this.lineClips){this.lineClipsArray.push(this.lineClips);for(let x=0;x<t.length-1;x++)this.totalDistance+=t[x].dist(t[x+1]);this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}const a=NA[i.type]==="Polygon";let l=t.length;for(;l>=2&&t[l-1].equals(t[l-2]);)l--;let c=0;for(;c<l-1&&t[c].equals(t[c+1]);)c++;if(l<(a?3:2))return;n==="bevel"&&(o=1.05);const u=this.overscaling<=16?15*pt/(512*this.overscaling):0,h=this.segments.prepareSegment(10*l,this.layoutVertexArray,this.indexArray);let d,p,_,g,y;this.e1=this.e2=-1,a&&(d=t[l-2],y=t[c].sub(d)._unit()._perp());for(let x=c;x<l;x++){if(_=x===l-1?a?t[c+1]:void 0:t[x+1],_&&t[x].equals(_))continue;y&&(g=y),d&&(p=d),d=t[x],y=_?_.sub(d)._unit()._perp():g,g=g||y;let b=g.add(y);b.x===0&&b.y===0||b._unit();const M=g.x*y.x+g.y*y.y,E=b.x*y.x+b.y*y.y,T=E!==0?1/E:1/0,S=2*Math.sqrt(2-2*E),D=E<UA&&p&&_,z=g.x*y.y-g.y*y.x>0;if(D&&x>c){const N=d.dist(p);if(N>2*u){const U=d.sub(d.sub(p)._mult(u/N)._round());this.updateDistance(p,U),this.addCurrentVertex(U,g,0,0,h),p=U}}const L=p&&_;let R=L?n:a?"butt":r;if(L&&R==="round"&&(T<s?R="miter":T<=2&&(R="fakeround")),R==="miter"&&T>o&&(R="bevel"),R==="bevel"&&(T>2&&(R="flipbevel"),T<o&&(R="miter")),p&&this.updateDistance(p,d),R==="miter")b._mult(T),this.addCurrentVertex(d,b,0,0,h);else if(R==="flipbevel"){if(T>100)b=y.mult(-1);else{const N=T*g.add(y).mag()/g.sub(y).mag();b._perp()._mult(N*(z?-1:1))}this.addCurrentVertex(d,b,0,0,h),this.addCurrentVertex(d,b.mult(-1),0,0,h)}else if(R==="bevel"||R==="fakeround"){const N=-Math.sqrt(T*T-1),U=z?N:0,H=z?0:N;if(p&&this.addCurrentVertex(d,g,U,H,h),R==="fakeround"){const O=Math.round(180*S/Math.PI/20);for(let X=1;X<O;X++){let K=X/O;if(K!==.5){const $=K-.5;K+=K*$*(K-1)*((1.0904+M*(M*(3.55645-1.43519*M)-3.2452))*$*$+(.848013+M*(.215638*M-1.06021)))}const ot=y.sub(g)._mult(K)._add(g)._unit()._mult(z?-1:1);this.addHalfVertex(d,ot.x,ot.y,!1,z,0,h)}}_&&this.addCurrentVertex(d,y,-U,-H,h)}else if(R==="butt")this.addCurrentVertex(d,b,0,0,h);else if(R==="square"){const N=p?1:-1;p||this.addCurrentVertex(d,b,N,N,h),this.addCurrentVertex(d,b,0,0,h),p&&this.addCurrentVertex(d,b,N,N,h)}else R==="round"&&(p&&(this.addCurrentVertex(d,g,0,0,h),this.addCurrentVertex(d,g,1,1,h,!0)),_&&(this.addCurrentVertex(d,y,-1,-1,h,!0),this.addCurrentVertex(d,y,0,0,h)));if(D&&x<l-1){const N=d.dist(_);if(N>2*u){const U=d.add(_.sub(d)._mult(u/N)._round());this.updateDistance(d,U),this.addCurrentVertex(U,y,0,0,h),d=U}}}}addCurrentVertex(t,i,n,r,o,s=!1){const a=i.y*r-i.x,l=-i.y-i.x*r;this.addHalfVertex(t,i.x+i.y*n,i.y-i.x*n,s,!1,n,o),this.addHalfVertex(t,a,l,s,!0,-r,o)}addHalfVertex({x:t,y:i},n,r,o,s,a,l){this.layoutVertexArray.emplaceBack((t<<1)+(o?1:0),(i<<1)+(s?1:0),Math.round(63*n)+128,Math.round(63*r)+128,1+(a===0?0:a<0?-1:1),0,this.lineSoFar),this.lineClips&&this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,this.lineClips.start,this.lineClips.end);const c=l.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,c),l.primitiveLength++),s?this.e2=c:this.e1=c}updateScaledDistance(){if(this.lineClips){const t=this.totalDistance/(this.lineClips.end-this.lineClips.start);this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=t*this.lineClips.start+this.distance}else this.lineSoFar=this.distance}updateDistance(t,i){this.distance+=t.dist(i),this.updateScaledDistance()}}he(Xh,"LineBucket",{omit:["layers","patternFeatures"]});class mn{constructor(t,i,n,r){this.context=t,this.format=n,this.texture=t.gl.createTexture(),this.update(i,r)}update(t,i,n){const{width:r,height:o}=t,{context:s}=this,{gl:a}=s,{HTMLImageElement:l,HTMLCanvasElement:c,HTMLVideoElement:u,ImageData:h,ImageBitmap:d}=I;if(a.bindTexture(a.TEXTURE_2D,this.texture),s.pixelStoreUnpackFlipY.set(!1),s.pixelStoreUnpack.set(1),s.pixelStoreUnpackPremultiplyAlpha.set(this.format===a.RGBA&&(!i||i.premultiply!==!1)),n||this.size&&this.size[0]===r&&this.size[1]===o){const{x:p,y:_}=n||{x:0,y:0};if(t instanceof l||t instanceof c||t instanceof u||t instanceof h||d&&t instanceof d)a.texSubImage2D(a.TEXTURE_2D,0,p,_,a.RGBA,a.UNSIGNED_BYTE,t);else{let g=this.format,y=a.UNSIGNED_BYTE;this.format===a.R32F&&(g=a.RED,y=a.FLOAT),a.texSubImage2D(a.TEXTURE_2D,0,p,_,r,o,g,y,t.data)}}else if(this.size=[r,o],t instanceof l||t instanceof c||t instanceof u||t instanceof h||d&&t instanceof d){let p=this.format;this.format===a.R8&&(p=a.RED),a.texImage2D(a.TEXTURE_2D,0,this.format,p,a.UNSIGNED_BYTE,t)}else{let p=this.format,_=this.format,g=a.UNSIGNED_BYTE;this.format===a.DEPTH_COMPONENT&&(p=a.DEPTH_COMPONENT16,g=a.UNSIGNED_SHORT),this.format===a.R32F&&(g=a.FLOAT,_=a.RED),a.texImage2D(a.TEXTURE_2D,0,p,r,o,0,_,g,t.data)}this.useMipmap=!!(i&&i.useMipmap),this.useMipmap&&a.generateMipmap(a.TEXTURE_2D)}bind(t,i){const{context:n}=this,{gl:r}=n;r.bindTexture(r.TEXTURE_2D,this.texture),t!==this.minFilter&&(r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,t),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,this.useMipmap?t===r.NEAREST?r.NEAREST_MIPMAP_NEAREST:r.LINEAR_MIPMAP_NEAREST:t),this.minFilter=t),i!==this.wrapS&&(r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,i),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,i),this.wrapS=i)}bindExtraParam(t,i,n,r){const{context:o}=this,{gl:s}=o;s.bindTexture(s.TEXTURE_2D,this.texture),i!==this.magFilter&&(s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,i),this.magFilter=i),t!==this.minFilter&&(s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,this.useMipmap?t===s.NEAREST?s.NEAREST_MIPMAP_NEAREST:s.LINEAR_MIPMAP_NEAREST:t),this.minFilter=t),n!==this.wrapS&&(s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,n),this.wrapS=n),r!==this.wrapT&&(s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,r),this.wrapT=r)}destroy(){const{gl:t}=this.context;t.deleteTexture(this.texture),this.texture=null}}class Yh{constructor(t,i){this.context=t,this.texture=i}bind(t,i){const{context:n}=this,{gl:r}=n;r.bindTexture(r.TEXTURE_2D,this.texture),t!==this.minFilter&&(r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,t),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,t),this.minFilter=t),i!==this.wrapS&&(r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,i),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,i),this.wrapS=i)}}const Qr=32,zo=33,Ks=new Uint16Array(8184);for(let e=0;e<2046;e++){let t=e+2,i=0,n=0,r=0,o=0,s=0,a=0;for(1&t?r=o=s=Qr:i=n=a=Qr;(t>>=1)>1;){const c=i+r>>1,u=n+o>>1;1&t?(r=i,o=n,i=s,n=a):(i=r,n=o,r=s,o=a),s=c,a=u}const l=4*e;Ks[l+0]=i,Ks[l+1]=n,Ks[l+2]=r,Ks[l+3]=o}const Lo=new Uint16Array(2178),Js=new Uint8Array(1089),Kh=new Uint16Array(1089);function nx(e){return e===0?-.03125:e===32?.03125:0}var Bm=zi([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);const rx={type:2,extent:pt,loadGeometry:()=>[[new G(0,0),new G(pt+1,0),new G(pt+1,pt+1),new G(0,pt+1),new G(0,0)]]};class Jc{constructor(t,i,n,r,o){this.tileID=t,this.uid=ae(),this.uses=0,this.tileSize=i,this.tileZoom=n,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=o,r&&r.style&&(this._lastUpdatedBrightness=r.style.getBrightness()),this.expiredRequestCount=0,this.state="loading",r&&r.transform&&(this.projection=r.transform.projection)}registerFadeDuration(t){const i=t+this.timeAdded;i<ke.now()||this.fadeEndTime&&i<this.fadeEndTime||(this.fadeEndTime=i)}wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading"}get tileTransform(){return this._tileTransform||(this._tileTransform=ka(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(t,i,n){if(this.unloadVectorData(),this.state="loaded",t){t.featureIndex&&(this.latestFeatureIndex=t.featureIndex,t.rawTileData?(this.latestRawTileData=t.rawTileData,this.latestFeatureIndex.rawTileData=t.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=t.collisionBoxArray,this.buckets=function(r,o){const s={};if(!o)return s;for(const a of r){const l=a.layerIds.map(c=>o.getLayer(c)).filter(Boolean);if(l.length!==0){a.layers=l,a.stateDependentLayerIds&&(a.stateDependentLayers=a.stateDependentLayerIds.map(c=>l.filter(u=>u.id===c)[0]));for(const c of l)s[c.fqid]=a}}return s}(t.buckets,i.style),this.hasSymbolBuckets=!1;for(const r in this.buckets){const o=this.buckets[r];if(o instanceof Kc){if(this.hasSymbolBuckets=!0,!n)break;o.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const r in this.buckets){const o=this.buckets[r];if(o instanceof Kc&&o.hasRTLText){this.hasRTLText=!0,$r.isLoading()||$r.isLoaded()||pp()!=="deferred"||U0();break}}this.queryPadding=0;for(const r in this.buckets){const o=this.buckets[r],s=i.style.getOwnLayer(r);if(!s)continue;const a=s.queryRadius(o);this.queryPadding=Math.max(this.queryPadding,a)}t.imageAtlas&&(this.imageAtlas=t.imageAtlas),t.glyphAtlasImage&&(this.glyphAtlasImage=t.glyphAtlasImage),t.lineAtlas&&(this.lineAtlas=t.lineAtlas),this._lastUpdatedBrightness=t.brightness}else this.collisionBoxArray=new Dp}unloadVectorData(){if(this.hasData()){for(const t in this.buckets)this.buckets[t].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}getBucket(t){return this.buckets[t.fqid]}upload(t){for(const n in this.buckets){const r=this.buckets[n];r.uploadPending()&&r.upload(t)}const i=t.gl;this.imageAtlas&&!this.imageAtlas.uploaded&&(this.imageAtlasTexture=new mn(t,this.imageAtlas.image,i.RGBA),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new mn(t,this.glyphAtlasImage,i.ALPHA),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new mn(t,this.lineAtlas.image,i.ALPHA),this.lineAtlas.uploaded=!0)}prepare(t,i,n){if(this.imageAtlas&&this.imageAtlasTexture&&this.imageAtlas.patchUpdatedImages(t,this.imageAtlasTexture,n),!i||!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData)return;const r=i.style.getBrightness();(this._lastUpdatedBrightness||r)&&(this._lastUpdatedBrightness&&r&&Math.abs(this._lastUpdatedBrightness-r)<.001||(this._lastUpdatedBrightness=r,this.updateBuckets(void 0,i)))}queryRenderedFeatures(t,i,n,r,o,s,a,l){return this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData?this.latestFeatureIndex.query({tileResult:r,pixelPosMatrix:a,transform:s,params:o,tileTransform:this.tileTransform},t,i,n):{}}querySourceFeatures(t,i){const n=this.latestFeatureIndex;if(!n||!n.rawTileData)return;const r=n.loadVTLayers(),o=i?i.sourceLayer:"",s=r._geojsonTileLayer||r[o];if(!s)return;const a=Zu(i&&i.filter),{z:l,x:c,y:u}=this.tileID.canonical,h={z:l,x:c,y:u};for(let d=0;d<s.length;d++){const p=s.feature(d);if(a.needGeometry){const y=Zs(p,!0);if(!a.filter(new dn(this.tileID.overscaledZ),y,this.tileID.canonical))continue}else if(!a.filter(new dn(this.tileID.overscaledZ),p))continue;const _=n.getId(p,o),g=new gv(p,l,c,u,_);g.tile=h,t.push(g)}}hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired"}bucketsLoaded(){for(const t in this.buckets)if(this.buckets[t].uploadPending())return!1;return!0}patternsLoaded(){return!!this.imageAtlas&&!!Object.keys(this.imageAtlas.patternPositions).length}setExpiryData(t){const i=this.expirationTime;if(t.cacheControl){const n=Xt(t.cacheControl);n["max-age"]&&(this.expirationTime=Date.now()+1e3*n["max-age"])}else t.expires&&(this.expirationTime=new Date(t.expires).getTime());if(this.expirationTime){const n=Date.now();let r=!1;if(this.expirationTime>n)r=!1;else if(i)if(this.expirationTime<i)r=!0;else{const o=this.expirationTime-i;o?this.expirationTime=n+Math.max(o,3e4):r=!0}else r=!0;r?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1)}setFeatureState(t,i){this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData&&Object.keys(t).length!==0&&i&&this.updateBuckets(t,i)}updateBuckets(t,i){if(!this.latestFeatureIndex)return;const n=this.latestFeatureIndex.loadVTLayers(),r=i.style.listImages(),o=i.style.getBrightness();for(const s in this.buckets){if(!i.style.hasLayer(s))continue;const a=this.buckets[s],l=a.layers[0].sourceLayer||"_geojsonTileLayer",c=n[l];let u={};if(t&&(u=t[l],!c||!u||Object.keys(u).length===0))continue;if(a.update(u,c,r,this.imageAtlas&&this.imageAtlas.patternPositions||{},o),a instanceof Xh||a instanceof Sh){const d=i.style.getOwnSourceCache(a.layers[0].source);i._terrain&&i._terrain.enabled&&d&&a.programConfigurations.needsUpload&&i._terrain._clearRenderCacheForTile(d.id,this.tileID)}const h=i&&i.style&&i.style.getOwnLayer(s);h&&(this.queryPadding=Math.max(this.queryPadding,h.queryRadius(a)))}}holdingForFade(){return this.symbolFadeHoldUntil!==void 0}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<ke.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(t){this.symbolFadeHoldUntil=ke.now()+t}setTexture(t,i){const n=i.context,r=n.gl;this.texture=this.texture||i.getTileTexture(t.width),this.texture&&this.texture instanceof mn?this.texture.update(t,{useMipmap:!0}):(this.texture=new mn(n,t,r.RGBA,{useMipmap:!0}),this.texture.bind(r.LINEAR,r.CLAMP_TO_EDGE))}setDependencies(t,i){const n={};for(const r of i)n[r]=!0;this.dependencies[t]=n}hasDependency(t,i){for(const n of t){const r=this.dependencies[n];if(r){for(const o of i)if(r[o])return!0}}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(t,i){if(!i||i.name==="mercator"||this._tileDebugBuffer)return;const n=Po(rx,this.tileID.canonical,this.tileTransform)[0],r=new Tr,o=new Dc;for(let s=0;s<n.length;s++){const{x:a,y:l}=n[s];r.emplaceBack(a,l),o.emplaceBack(s)}o.emplaceBack(0),this._tileDebugIndexBuffer=t.createIndexBuffer(o),this._tileDebugBuffer=t.createVertexBuffer(r,Us.members),this._tileDebugSegments=Fi.simpleSegment(0,0,r.length,o.length)}_makeTileBoundsBuffers(t,i){if(this._tileBoundsBuffer||!i||i.name==="mercator")return;const n=Po(rx,this.tileID.canonical,this.tileTransform)[0];let r,o;if(this.isRaster){const s=function(a,l){const c=ka(a,l),u=Math.pow(2,a.z);for(let y=0;y<zo;y++)for(let x=0;x<zo;x++){const b=Sr((a.x+(x+nx(x))/Qr)/u),M=On((a.y+(y+nx(y))/Qr)/u),E=l.project(b,M),T=y*zo+x;Lo[2*T+0]=Math.round((E.x*c.scale-c.x)*pt),Lo[2*T+1]=Math.round((E.y*c.scale-c.y)*pt)}Js.fill(0),Kh.fill(0);for(let y=2045;y>=0;y--){const x=4*y,b=Ks[x+0],M=Ks[x+1],E=Ks[x+2],T=Ks[x+3],S=b+E>>1,D=M+T>>1,z=S+D-M,L=D+b-S,R=M*zo+b,N=T*zo+E,U=D*zo+S,H=Math.hypot((Lo[2*R+0]+Lo[2*N+0])/2-Lo[2*U+0],(Lo[2*R+1]+Lo[2*N+1])/2-Lo[2*U+1])>=16;Js[U]=Js[U]||(H?1:0),y<1022&&(Js[U]=Js[U]||Js[(M+L>>1)*zo+(b+z>>1)]||Js[(T+L>>1)*zo+(E+z>>1)])}const h=new Ea,d=new Rn;let p=0;function _(y,x){const b=x*zo+y;return Kh[b]===0&&(h.emplaceBack(Lo[2*b+0],Lo[2*b+1],y*pt/Qr,x*pt/Qr),Kh[b]=++p),Kh[b]-1}function g(y,x,b,M,E,T){const S=y+b>>1,D=x+M>>1;if(Math.abs(y-E)+Math.abs(x-T)>1&&Js[D*zo+S])g(E,T,y,x,S,D),g(b,M,E,T,S,D);else{const z=_(y,x),L=_(b,M),R=_(E,T);d.emplaceBack(z,L,R)}}return g(0,0,Qr,Qr,Qr,0),g(Qr,Qr,0,0,0,Qr),{vertices:h,indices:d}}(this.tileID.canonical,i);r=s.vertices,o=s.indices}else{r=new Ea,o=new Rn;for(const{x:a,y:l}of n)r.emplaceBack(a,l,0,0);const s=Eh(r.int16,void 0,4);for(let a=0;a<s.length;a+=3)o.emplaceBack(s[a],s[a+1],s[a+2])}this._tileBoundsBuffer=t.createVertexBuffer(r,Bm.members),this._tileBoundsIndexBuffer=t.createIndexBuffer(o),this._tileBoundsSegments=Fi.simpleSegment(0,0,r.length,o.length)}_makeGlobeTileDebugBuffers(t,i){const n=i.projection;if(!n||n.name!=="globe"||i.freezeTileCoverage)return;const r=this.tileID.canonical,o=js(I1(r,i)),s=Wn(i.zoom);let a;s>0&&(a=st.invert(new Float64Array(16),i.globeMatrix)),this._makeGlobeTileDebugBorderBuffer(t,r,i,o,a,s),this._makeGlobeTileDebugTextBuffer(t,r,i,o,a,s)}_globePoint(t,i,n,r,o,s,a){let l=Bc(t,i,n);if(s){const c=1<<n.z,u=Fn(r.center.lng),h=jn(r.center.lat),d=(n.x+.5)/c-u;let p=0;d>.5?p=-1:d<-.5&&(p=1);let _=(t/pt+n.x)/c+p,g=(i/pt+n.y)/c;_=(_-u)*r._pixelsPerMercatorPixel+u,g=(g-h)*r._pixelsPerMercatorPixel+h;const y=[_*r.worldSize,g*r.worldSize,0];Z.transformMat4(y,y,s),l=us(l,y,a)}return Z.transformMat4(l,l,o)}_makeGlobeTileDebugBorderBuffer(t,i,n,r,o,s){const a=new Tr,l=new Dc,c=new th,u=(d,p,_,g,y)=>{const x=(_-d)/(y-1),b=(g-p)/(y-1),M=a.length;for(let E=0;E<y;E++){const T=d+E*x,S=p+E*b;a.emplaceBack(T,S);const D=this._globePoint(T,S,i,n,r,o,s);c.emplaceBack(D[0],D[1],D[2]),l.emplaceBack(M+E)}},h=pt;u(0,0,h,0,16),u(h,0,h,h,16),u(h,h,0,h,16),u(0,h,0,0,16),this._tileDebugIndexBuffer=t.createIndexBuffer(l),this._tileDebugBuffer=t.createVertexBuffer(a,Us.members),this._globeTileDebugBorderBuffer=t.createVertexBuffer(c,b1.members),this._tileDebugSegments=Fi.simpleSegment(0,0,a.length,l.length)}_makeGlobeTileDebugTextBuffer(t,i,n,r,o,s){const a=pt/4,l=new Tr,c=new Rn,u=new th,h=25;c.reserve(32),l.reserve(h),u.reserve(h);const d=(p,_)=>h*p+_;for(let p=0;p<h;p++){const _=p*a;for(let g=0;g<h;g++){const y=g*a;l.emplaceBack(y,_);const x=this._globePoint(y,_,i,n,r,o,s);u.emplaceBack(x[0],x[1],x[2])}}for(let p=0;p<4;p++)for(let _=0;_<4;_++){const g=d(p,_),y=d(p,_+1),x=d(p+1,_),b=d(p+1,_+1);c.emplaceBack(g,y,x),c.emplaceBack(x,y,b)}this._tileDebugTextIndexBuffer=t.createIndexBuffer(c),this._tileDebugTextBuffer=t.createVertexBuffer(l,Us.members),this._globeTileDebugTextBuffer=t.createVertexBuffer(u,b1.members),this._tileDebugTextSegments=Fi.simpleSegment(0,0,h,32)}destroy(t=!1){for(const i in this.buckets)this.buckets[i].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&(this.imageAtlasTexture.destroy(),delete this.imageAtlasTexture),this.glyphAtlasTexture&&(this.glyphAtlasTexture.destroy(),delete this.glyphAtlasTexture),this.lineAtlasTexture&&(this.lineAtlasTexture.destroy(),delete this.lineAtlasTexture),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),!t&&this.texture&&this.texture instanceof mn&&(this.texture.destroy(),delete this.texture),this.hillshadeFBO&&(this.hillshadeFBO.destroy(),delete this.hillshadeFBO),this.dem&&delete this.dem,this.neighboringTiles&&delete this.neighboringTiles,this.demTexture&&(this.demTexture.destroy(),delete this.demTexture),this.latestFeatureIndex=null,this.state="unloaded"}}class VA{constructor(t,i){this.max=t,this.onRemove=i,this.reset()}reset(){for(const t in this.data)for(const i of this.data[t])i.timeout&&clearTimeout(i.timeout),this.onRemove(i.value);return this.data={},this.order=[],this}add(t,i,n){const r=t.wrapped().key;this.data[r]===void 0&&(this.data[r]=[]);const o={value:i,timeout:void 0};if(n!==void 0&&(o.timeout=setTimeout(()=>{this.remove(t,o)},n)),this.data[r].push(o),this.order.push(r),this.order.length>this.max){const s=this._getAndRemoveByKey(this.order[0]);s&&this.onRemove(s)}return this}has(t){return t.wrapped().key in this.data}getAndRemove(t){return this.has(t)?this._getAndRemoveByKey(t.wrapped().key):null}_getAndRemoveByKey(t){const i=this.data[t].shift();return i.timeout&&clearTimeout(i.timeout),this.data[t].length===0&&delete this.data[t],this.order.splice(this.order.indexOf(t),1),i.value}getByKey(t){const i=this.data[t];return i?i[0].value:null}get(t){return this.has(t)?this.data[t.wrapped().key][0].value:null}remove(t,i){if(!this.has(t))return this;const n=t.wrapped().key,r=i===void 0?0:this.data[n].indexOf(i),o=this.data[n][r];return this.data[n].splice(r,1),o.timeout&&clearTimeout(o.timeout),this.data[n].length===0&&delete this.data[n],this.onRemove(o.value),this.order.splice(this.order.indexOf(n),1),this}setMaxSize(t){for(this.max=t;this.order.length>this.max;){const i=this._getAndRemoveByKey(this.order[0]);i&&this.onRemove(i)}return this}filter(t){const i=[];for(const n in this.data)for(const r of this.data[n])t(r.value)||i.push(r);for(const n of i)this.remove(n.value.tileID,n)}}class Qs{constructor(t,i,n,r){this.id=Qs.uniqueIdxCounter,Qs.uniqueIdxCounter++,this.context=t;const o=t.gl;this.buffer=o.createBuffer(),this.dynamicDraw=!!n,this.context.unbindVAO(),t.bindElementBuffer.set(this.buffer),o.bufferData(o.ELEMENT_ARRAY_BUFFER,i.arrayBuffer,this.dynamicDraw?o.DYNAMIC_DRAW:o.STATIC_DRAW),this.dynamicDraw||r||i.destroy()}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(t){this.id=Qs.uniqueIdxCounter,Qs.uniqueIdxCounter++;const i=this.context.gl;this.context.unbindVAO(),this.bind(),i.bufferSubData(i.ELEMENT_ARRAY_BUFFER,0,t.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}Qs.uniqueIdxCounter=0;const jA={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class GA{constructor(t,i,n,r,o,s){this.length=i.length,this.attributes=n,this.itemSize=i.bytesPerElement,this.dynamicDraw=r,this.instanceCount=s,this.context=t;const a=t.gl;this.buffer=a.createBuffer(),t.bindVertexBuffer.set(this.buffer),a.bufferData(a.ARRAY_BUFFER,i.arrayBuffer,this.dynamicDraw?a.DYNAMIC_DRAW:a.STATIC_DRAW),this.dynamicDraw||o||i.destroy()}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(t){const i=this.context.gl;this.bind(),i.bufferSubData(i.ARRAY_BUFFER,0,t.arrayBuffer)}enableAttributes(t,i){for(let n=0;n<this.attributes.length;n++){const r=i.attributes[this.attributes[n].name];r!==void 0&&t.enableVertexAttribArray(r)}}setVertexAttribPointers(t,i,n){for(let r=0;r<this.attributes.length;r++){const o=this.attributes[r],s=i.attributes[o.name];s!==void 0&&t.vertexAttribPointer(s,o.components,t[jA[o.type]],!1,this.itemSize,o.offset+this.itemSize*(n||0))}}setVertexAttribDivisor(t,i,n){for(let r=0;r<this.attributes.length;r++){const o=i.attributes[this.attributes[r].name];o!==void 0&&this.instanceCount&&this.instanceCount>0&&t.vertexAttribDivisor(o,n)}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class on{constructor(t){this.gl=t.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(t){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class qA extends on{getDefault(){return Ye.transparent}set(t){const i=this.current;(t.r!==i.r||t.g!==i.g||t.b!==i.b||t.a!==i.a||this.dirty)&&(this.gl.clearColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class ZA extends on{getDefault(){return 1}set(t){(t!==this.current||this.dirty)&&(this.gl.clearDepth(t),this.current=t,this.dirty=!1)}}class HA extends on{getDefault(){return 0}set(t){(t!==this.current||this.dirty)&&(this.gl.clearStencil(t),this.current=t,this.dirty=!1)}}class WA extends on{getDefault(){return[!0,!0,!0,!0]}set(t){const i=this.current;(t[0]!==i[0]||t[1]!==i[1]||t[2]!==i[2]||t[3]!==i[3]||this.dirty)&&(this.gl.colorMask(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class $A extends on{getDefault(){return!0}set(t){(t!==this.current||this.dirty)&&(this.gl.depthMask(t),this.current=t,this.dirty=!1)}}class XA extends on{getDefault(){return 255}set(t){(t!==this.current||this.dirty)&&(this.gl.stencilMask(t),this.current=t,this.dirty=!1)}}class YA extends on{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(t){const i=this.current;(t.func!==i.func||t.ref!==i.ref||t.mask!==i.mask||this.dirty)&&(this.gl.stencilFunc(t.func,t.ref,t.mask),this.current=t,this.dirty=!1)}}class KA extends on{getDefault(){const t=this.gl;return[t.KEEP,t.KEEP,t.KEEP]}set(t){const i=this.current;(t[0]!==i[0]||t[1]!==i[1]||t[2]!==i[2]||this.dirty)&&(this.gl.stencilOp(t[0],t[1],t[2]),this.current=t,this.dirty=!1)}}class JA extends on{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const i=this.gl;t?i.enable(i.STENCIL_TEST):i.disable(i.STENCIL_TEST),this.current=t,this.dirty=!1}}class QA extends on{getDefault(){return[0,1]}set(t){const i=this.current;(t[0]!==i[0]||t[1]!==i[1]||this.dirty)&&(this.gl.depthRange(t[0],t[1]),this.current=t,this.dirty=!1)}}class t3 extends on{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const i=this.gl;t?i.enable(i.DEPTH_TEST):i.disable(i.DEPTH_TEST),this.current=t,this.dirty=!1}}class e3 extends on{getDefault(){return this.gl.LESS}set(t){(t!==this.current||this.dirty)&&(this.gl.depthFunc(t),this.current=t,this.dirty=!1)}}class i3 extends on{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const i=this.gl;t?i.enable(i.BLEND):i.disable(i.BLEND),this.current=t,this.dirty=!1}}class n3 extends on{getDefault(){const t=this.gl;return[t.ONE,t.ZERO,t.ONE,t.ZERO]}set(t){const i=this.current;(t[0]!==i[0]||t[1]!==i[1]||t[2]!==i[2]||t[3]!==i[3]||this.dirty)&&(this.gl.blendFuncSeparate(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class r3 extends on{getDefault(){return Ye.transparent}set(t){const i=this.current;(t.r!==i.r||t.g!==i.g||t.b!==i.b||t.a!==i.a||this.dirty)&&(this.gl.blendColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class o3 extends on{getDefault(){return this.gl.FUNC_ADD}set(t){(t!==this.current||this.dirty)&&(this.gl.blendEquationSeparate(t,t),this.current=t,this.dirty=!1)}}class s3 extends on{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const i=this.gl;t?i.enable(i.CULL_FACE):i.disable(i.CULL_FACE),this.current=t,this.dirty=!1}}class a3 extends on{getDefault(){return this.gl.BACK}set(t){(t!==this.current||this.dirty)&&(this.gl.cullFace(t),this.current=t,this.dirty=!1)}}class l3 extends on{getDefault(){return this.gl.CCW}set(t){(t!==this.current||this.dirty)&&(this.gl.frontFace(t),this.current=t,this.dirty=!1)}}let c3=class extends on{getDefault(){return null}set(e){(e!==this.current||this.dirty)&&(this.gl.useProgram(e),this.current=e,this.dirty=!1)}};class u3 extends on{getDefault(){return this.gl.TEXTURE0}set(t){(t!==this.current||this.dirty)&&(this.gl.activeTexture(t),this.current=t,this.dirty=!1)}}class h3 extends on{getDefault(){const t=this.gl;return[0,0,t.drawingBufferWidth,t.drawingBufferHeight]}set(t){const i=this.current;(t[0]!==i[0]||t[1]!==i[1]||t[2]!==i[2]||t[3]!==i[3]||this.dirty)&&(this.gl.viewport(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class d3 extends on{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const i=this.gl;i.bindFramebuffer(i.FRAMEBUFFER,t),this.current=t,this.dirty=!1}}class f3 extends on{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const i=this.gl;i.bindRenderbuffer(i.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class p3 extends on{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const i=this.gl;i.bindTexture(i.TEXTURE_2D,t),this.current=t,this.dirty=!1}}class m3 extends on{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const i=this.gl;i.bindBuffer(i.ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class _3 extends on{getDefault(){return null}set(t){const i=this.gl;i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class g3 extends on{getDefault(){return null}set(t){this.gl&&(t!==this.current||this.dirty)&&(this.gl.bindVertexArray(t),this.current=t,this.dirty=!1)}}class y3 extends on{getDefault(){return 4}set(t){if(t===this.current&&!this.dirty)return;const i=this.gl;i.pixelStorei(i.UNPACK_ALIGNMENT,t),this.current=t,this.dirty=!1}}class v3 extends on{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const i=this.gl;i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t),this.current=t,this.dirty=!1}}class x3 extends on{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const i=this.gl;i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,t),this.current=t,this.dirty=!1}}class Fm extends on{constructor(t,i){super(t),this.context=t,this.parent=i}getDefault(){return null}}class b3 extends Fm{setDirty(){this.dirty=!0}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const i=this.gl;i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,t,0),this.current=t,this.dirty=!1}}class ox extends Fm{attachment(){return this.gl.DEPTH_ATTACHMENT}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const i=this.gl;i.framebufferRenderbuffer(i.FRAMEBUFFER,this.attachment(),i.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class w3 extends Fm{attachment(){return this.gl.DEPTH_ATTACHMENT}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const i=this.gl;i.framebufferTexture2D(i.FRAMEBUFFER,this.attachment(),i.TEXTURE_2D,t,0),this.current=t,this.dirty=!1}}class T3 extends ox{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}}class M3{constructor(t,i,n,r,o){this.context=t,this.width=i,this.height=n;const s=this.framebuffer=t.gl.createFramebuffer();r&&(this.colorAttachment=new b3(t,s)),o&&(this.depthAttachmentType=o,this.depthAttachment=o==="renderbuffer"?new ox(t,s):new w3(t,s))}destroy(){const t=this.context.gl;if(this.colorAttachment){const i=this.colorAttachment.get();i&&t.deleteTexture(i)}if(this.depthAttachment&&this.depthAttachmentType)if(this.depthAttachmentType==="renderbuffer"){const i=this.depthAttachment.get();i&&t.deleteRenderbuffer(i)}else{const i=this.depthAttachment.get();i&&t.deleteTexture(i)}t.deleteFramebuffer(this.framebuffer)}}class Ie{constructor(t,i,n){this.func=t,this.mask=i,this.range=n}}Ie.ReadOnly=!1,Ie.ReadWrite=!0,Ie.disabled=new Ie(519,Ie.ReadOnly,[0,1]);const Nm=7680;class Ke{constructor(t,i,n,r,o,s){this.test=t,this.ref=i,this.mask=n,this.fail=r,this.depthFail=o,this.pass=s}}Ke.disabled=new Ke({func:519,mask:0},0,0,Nm,Nm,Nm);const Jh=771;class Ti{constructor(t,i,n,r){this.blendFunction=t,this.blendColor=i,this.mask=n,this.blendEquation=r}}Ti.Replace=[1,0,1,0],Ti.disabled=new Ti(Ti.Replace,Ye.transparent,[!1,!1,!1,!1]),Ti.unblended=new Ti(Ti.Replace,Ye.transparent,[!0,!0,!0,!0]),Ti.alphaBlended=new Ti([1,Jh,1,Jh],Ye.transparent,[!0,!0,!0,!0]),Ti.multiply=new Ti([774,0,774,0],Ye.transparent,[!0,!0,!0,!0]);const Um=1029,Vm=2305;class ti{constructor(t,i,n){this.enable=t,this.mode=i,this.frontFace=n}}ti.disabled=new ti(!1,Um,Vm),ti.backCCW=new ti(!0,Um,Vm),ti.backCW=new ti(!0,Um,2304),ti.frontCW=new ti(!0,1028,2304),ti.frontCCW=new ti(!0,1028,Vm);class E3{constructor(t,i){this.gl=t,this.clearColor=new qA(this),this.clearDepth=new ZA(this),this.clearStencil=new HA(this),this.colorMask=new WA(this),this.depthMask=new $A(this),this.stencilMask=new XA(this),this.stencilFunc=new YA(this),this.stencilOp=new KA(this),this.stencilTest=new JA(this),this.depthRange=new QA(this),this.depthTest=new t3(this),this.depthFunc=new e3(this),this.blend=new i3(this),this.blendFunc=new n3(this),this.blendColor=new r3(this),this.blendEquation=new o3(this),this.cullFace=new s3(this),this.cullFaceSide=new a3(this),this.frontFace=new l3(this),this.program=new c3(this),this.activeTexture=new u3(this),this.viewport=new h3(this),this.bindFramebuffer=new d3(this),this.bindRenderbuffer=new f3(this),this.bindTexture=new p3(this),this.bindVertexBuffer=new m3(this),this.bindElementBuffer=new _3(this),this.bindVertexArrayOES=new g3(this),this.pixelStoreUnpack=new y3(this),this.pixelStoreUnpackPremultiplyAlpha=new v3(this),this.pixelStoreUnpackFlipY=new x3(this),this.options=i?{...i}:{},this.options.extTextureFilterAnisotropicForceOff||(this.extTextureFilterAnisotropic=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=t.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT))),this.extDebugRendererInfo=t.getExtension("WEBGL_debug_renderer_info"),this.extDebugRendererInfo&&(this.renderer=t.getParameter(this.extDebugRendererInfo.UNMASKED_RENDERER_WEBGL),this.vendor=t.getParameter(this.extDebugRendererInfo.UNMASKED_VENDOR_WEBGL)),this.options.extTextureFloatLinearForceOff||(this.extTextureFloatLinear=t.getExtension("OES_texture_float_linear")),this.extRenderToTextureHalfFloat=t.getExtension("EXT_color_buffer_half_float"),this.extTimerQuery=t.getExtension("EXT_disjoint_timer_query_webgl2"),this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE)}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArrayOES.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(t,i,n){return new Qs(this,t,i,n)}createVertexBuffer(t,i,n,r,o){return new GA(this,t,i,n,r,o)}createRenderbuffer(t,i,n){const r=this.gl,o=r.createRenderbuffer();return this.bindRenderbuffer.set(o),r.renderbufferStorage(r.RENDERBUFFER,t,i,n),this.bindRenderbuffer.set(null),o}createFramebuffer(t,i,n,r){return new M3(this,t,i,n,r)}clear({color:t,depth:i,stencil:n,colorMask:r}){const o=this.gl;let s=0;t&&(s|=o.COLOR_BUFFER_BIT,this.clearColor.set(t),this.colorMask.set(r||[!0,!0,!0,!0])),i!==void 0&&(s|=o.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(i),this.depthMask.set(!0)),n!==void 0&&(s|=o.STENCIL_BUFFER_BIT,this.clearStencil.set(n),this.stencilMask.set(255)),o.clear(s)}setCullFace(t){t.enable===!1?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(t.mode),this.frontFace.set(t.frontFace))}setDepthMode(t){t.func!==this.gl.ALWAYS||t.mask?(this.depthTest.set(!0),this.depthFunc.set(t.func),this.depthMask.set(t.mask),this.depthRange.set(t.range)):this.depthTest.set(!1)}setStencilMode(t){t.test.func!==this.gl.ALWAYS||t.mask?(this.stencilTest.set(!0),this.stencilMask.set(t.mask),this.stencilOp.set([t.fail,t.depthFail,t.pass]),this.stencilFunc.set({func:t.test.func,ref:t.ref,mask:t.test.mask})):this.stencilTest.set(!1)}setColorMode(t){Tt(t.blendFunction,Ti.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(t.blendFunction),this.blendColor.set(t.blendColor),t.blendEquation?this.blendEquation.set(t.blendEquation):this.blendEquation.setDefault()),this.colorMask.set(t.mask)}unbindVAO(){this.bindVertexArrayOES.set(null)}}class co extends Mn{constructor(t,i,n){super(),this.id=t,this._onlySymbols=n,i.on("data",r=>{r.dataType==="source"&&r.sourceDataType==="metadata"&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&r.dataType==="source"&&r.sourceDataType==="content"&&(this.reload(),this.transform&&this.update(this.transform))}),i.on("error",()=>{this._sourceErrored=!0}),this._source=i,this._tiles={},this._cache=new VA(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=i.minTileCacheSize,this._maxTileCacheSize=i.maxTileCacheSize,this._loadedParentTiles={},this.castsShadows=!1,this._coveredTiles={},this._shadowCasterTiles={},this._state=new qS,this._isRaster=this._source.type==="raster"||this._source.type==="raster-dem"||this._source.type==="custom"&&this._source._dataType==="raster"}onAdd(t){this.map=t,this._minTileCacheSize=this._minTileCacheSize===void 0&&t?t._minTileCacheSize:this._minTileCacheSize,this._maxTileCacheSize=this._maxTileCacheSize===void 0&&t?t._maxTileCacheSize:this._maxTileCacheSize}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;for(const t in this._tiles){const i=this._tiles[t];if(i.state!=="errored"&&(i.state!=="loaded"||!i.bucketsLoaded()))return!1}return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const t=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,t&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(t,i){return t.isSymbolTile=this._onlySymbols,t.isExtraShadowCaster=this._shadowCasterTiles[t.tileID.key],this._source.loadTile(t,i)}_unloadTile(t){if(this._source.unloadTile)return this._source.unloadTile(t,()=>{})}_abortTile(t){if(this._source.abortTile)return this._source.abortTile(t,()=>{})}serialize(){return this._source.serialize()}prepare(t){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const i in this._tiles){const n=this._tiles[i];n.upload(t),n.prepare(this.map.style.imageManager,this.map?this.map.painter:null,this._source.scope)}}getIds(){return Oi(this._tiles).map(t=>t.tileID).sort(sx).map(t=>t.key)}getRenderableIds(t,i){const n=[];for(const r in this._tiles)this._isIdRenderable(+r,t,i)&&n.push(this._tiles[r]);return t?n.sort((r,o)=>{const s=r.tileID,a=o.tileID,l=new G(s.canonical.x,s.canonical.y)._rotate(this.transform.angle),c=new G(a.canonical.x,a.canonical.y)._rotate(this.transform.angle);return s.overscaledZ-a.overscaledZ||c.y-l.y||c.x-l.x}).map(r=>r.tileID.key):n.map(r=>r.tileID).sort(sx).map(r=>r.key)}hasRenderableParent(t){const i=this.findLoadedParent(t,0);return!!i&&this._isIdRenderable(i.tileID.key)}_isIdRenderable(t,i,n){return this._tiles[t]&&this._tiles[t].hasData()&&!this._coveredTiles[t]&&(i||!this._tiles[t].holdingForFade())&&(n||!this._shadowCasterTiles[t])}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const t in this._tiles)this._tiles[t].state!=="errored"&&this._reloadTile(+t,"reloading")}}_reloadTile(t,i){const n=this._tiles[t];n&&(n.state!=="loading"&&(n.state=i),this._loadTile(n,this._tileLoaded.bind(this,n,t,i)))}_tileLoaded(t,i,n,r){if(r)if(t.state="errored",r.status!==404)this._source.fire(new Ae(r,{tile:t}));else{if(!(t.tileID.key in this._loadedParentTiles))return void this._source.fire(new jt("data",{dataType:"source",sourceDataType:"error",sourceId:this._source.id}));if(this._source.type==="raster-dem"&&this.usedForTerrain&&this.map.painter.terrain){const o=this.map.painter.terrain;this.update(this.transform,o.getScaledDemTileSize(),!0),o.resetTileLookupCache(this.id)}else this.update(this.transform)}else t.timeAdded=ke.now(),n==="expired"&&(t.refreshedUponExpiration=!0),this._setTileReloadTimer(i,t),this._source.type==="raster-dem"&&t.dem&&this._backfillDEM(t),this._state.initializeTileState(t,this.map?this.map.painter:null),this._source.fire(new jt("data",{dataType:"source",tile:t,coord:t.tileID,sourceCacheId:this.id}))}_backfillDEM(t){const i=this.getRenderableIds();for(let r=0;r<i.length;r++){const o=i[r];if(t.neighboringTiles&&t.neighboringTiles[o]){const s=this.getTileByID(o);n(t,s),n(s,t)}}function n(r,o){if(!r.dem||r.dem.borderReady)return;r.needsHillshadePrepare=!0,r.needsDEMTextureUpload=!0;let s=o.tileID.canonical.x-r.tileID.canonical.x;const a=o.tileID.canonical.y-r.tileID.canonical.y,l=Math.pow(2,r.tileID.canonical.z),c=o.tileID.key;s===0&&a===0||Math.abs(a)>1||(Math.abs(s)>1&&(Math.abs(s+l)===1?s+=l:Math.abs(s-l)===1&&(s-=l)),o.dem&&r.dem&&(r.dem.backfillBorder(o.dem,s,a),r.neighboringTiles&&r.neighboringTiles[c]&&(r.neighboringTiles[c].backfilled=!0)))}}getTile(t){return this.getTileByID(t.key)}getTileByID(t){return this._tiles[t]}_retainLoadedChildren(t,i,n,r){for(const o in this._tiles){let s=this._tiles[o];if(r[o]||!s.hasData()||s.tileID.overscaledZ<=i||s.tileID.overscaledZ>n)continue;let a=s.tileID;for(;s&&s.tileID.overscaledZ>i+1;){const c=s.tileID.scaledTo(s.tileID.overscaledZ-1);s=this._tiles[c.key],s&&s.hasData()&&(a=c)}let l=a;for(;l.overscaledZ>i;)if(l=l.scaledTo(l.overscaledZ-1),t[l.key]){r[a.key]=a;break}}}findLoadedParent(t,i){if(t.key in this._loadedParentTiles){const n=this._loadedParentTiles[t.key];return n&&n.tileID.overscaledZ>=i?n:null}for(let n=t.overscaledZ-1;n>=i;n--){const r=t.scaledTo(n),o=this._getLoadedTile(r);if(o)return o}}_getLoadedTile(t){const i=this._tiles[t.key];return i&&i.hasData()?i:this._cache.getByKey(this._source.reparseOverscaled?t.wrapped().key:t.canonical.key)}updateCacheSize(t,i){i=i||this._source.tileSize;const n=Math.ceil(t.width/i)+1,r=Math.ceil(t.height/i)+1,o=Math.floor(n*r*5),s=typeof this._minTileCacheSize=="number"?Math.max(this._minTileCacheSize,o):o,a=typeof this._maxTileCacheSize=="number"?Math.min(this._maxTileCacheSize,s):s;this._cache.setMaxSize(a)}handleWrapJump(t){const i=Math.round((t-(this._prevLng===void 0?t:this._prevLng))/360);if(this._prevLng=t,i){const n={};for(const r in this._tiles){const o=this._tiles[r];o.tileID=o.tileID.unwrapTo(o.tileID.wrap+i),n[o.tileID.key]=o}this._tiles=n;for(const r in this._timers)clearTimeout(this._timers[r]),delete this._timers[r];for(const r in this._tiles)this._setTileReloadTimer(+r,this._tiles[r])}}update(t,i,n,r){if(this.transform=t,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage||this.usedForTerrain&&!n)return;let o;if(this.updateCacheSize(t,i),this.transform.projection.name!=="globe"&&this.handleWrapJump(this.transform.center.lng),this._shadowCasterTiles={},this._coveredTiles={},this.used||this.usedForTerrain?this._source.tileID?o=t.getVisibleUnwrappedCoordinates(this._source.tileID).map(l=>new Si(l.canonical.z,l.wrap,l.canonical.z,l.canonical.x,l.canonical.y)):(o=t.coveringTiles({tileSize:i||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!n,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain}),this._source.hasTile&&(o=o.filter(l=>this._source.hasTile(l)))):o=[],o.length>0&&this.castsShadows&&r&&this.transform.projection.name!=="globe"&&!this.usedForTerrain&&!jm(this._source.type)){const l=t.coveringZoomLevel({tileSize:i||this._source.tileSize,roundZoom:this._source.roundZoom&&!n}),c=Math.min(l,this._source.maxzoom),u=t.extendTileCoverForShadows(o,r,c);for(const h of u)this._shadowCasterTiles[h.key]=!0,o.push(h)}const s=this._updateRetainedTiles(o);if(jm(this._source.type)&&o.length!==0){const l={},c={},u=Object.keys(s);for(const d of u){const p=s[d],_=this._tiles[d];if(!_||_.fadeEndTime&&_.fadeEndTime<=ke.now())continue;const g=this.findLoadedParent(p,Math.max(p.overscaledZ-co.maxOverzooming,this._source.minzoom));g&&(this._addTile(g.tileID),l[g.tileID.key]=g.tileID),c[d]=p}const h=o[o.length-1].overscaledZ;for(const d in this._tiles){const p=this._tiles[d];if(s[d]||!p.hasData())continue;let _=p.tileID;for(;_.overscaledZ>h;){_=_.scaledTo(_.overscaledZ-1);const g=this._tiles[_.key];if(g&&g.hasData()&&c[_.key]){s[d]=p.tileID;break}}}for(const d in l)s[d]||(this._coveredTiles[d]=!0,s[d]=l[d])}for(const l in s)this._tiles[l].clearFadeHold();const a=function(l,c){const u=[];for(const h in l)h in c||u.push(h);return u}(this._tiles,s);for(const l of a){const c=this._tiles[l];c.hasSymbolBuckets&&!c.holdingForFade()?c.setHoldDuration(this.map._fadeDuration):c.hasSymbolBuckets&&!c.symbolFadeFinished()||this._removeTile(+l)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(const t in this._tiles)this._tiles[t].holdingForFade()&&this._removeTile(+t)}_updateRetainedTiles(t){const i={};if(t.length===0)return i;const n={},r=t.reduce((c,u)=>Math.min(c,u.overscaledZ),1/0),o=t[0].overscaledZ,s=Math.max(o-co.maxOverzooming,this._source.minzoom),a=Math.max(o+co.maxUnderzooming,this._source.minzoom),l={};for(const c of t){const u=this._addTile(c);i[c.key]=c,u.hasData()||r<this._source.maxzoom&&(l[c.key]=c)}this._retainLoadedChildren(l,r,a,i);for(const c of t){let u=this._tiles[c.key];if(u.hasData())continue;if(c.canonical.z>=this._source.maxzoom){const d=c.children(this._source.maxzoom)[0],p=this.getTile(d);if(p&&p.hasData()){i[d.key]=d;continue}}else{const d=c.children(this._source.maxzoom);if(i[d[0].key]&&i[d[1].key]&&i[d[2].key]&&i[d[3].key])continue}let h=u.wasRequested();for(let d=c.overscaledZ-1;d>=s;--d){const p=c.scaledTo(d);if(n[p.key]||(n[p.key]=!0,u=this.getTile(p),!u&&h&&(u=this._addTile(p)),u&&(i[p.key]=p,h=u.wasRequested(),u.hasData())))break}}return i}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const t in this._tiles){const i=[];let n,r=this._tiles[t].tileID;for(;r.overscaledZ>0;){if(r.key in this._loadedParentTiles){n=this._loadedParentTiles[r.key];break}i.push(r.key);const o=r.scaledTo(r.overscaledZ-1);if(n=this._getLoadedTile(o),n)break;r=o}for(const o of i)this._loadedParentTiles[o]=n}}_addTile(t){let i=this._tiles[t.key];if(i)return i.isExtraShadowCaster!==!0||this._shadowCasterTiles[t.key]||this._reloadTile(t.key,"reloading"),i;i=this._cache.getAndRemove(t),i&&(this._setTileReloadTimer(t.key,i),i.tileID=t,this._state.initializeTileState(i,this.map?this.map.painter:null),this._cacheTimers[t.key]&&(clearTimeout(this._cacheTimers[t.key]),delete this._cacheTimers[t.key],this._setTileReloadTimer(t.key,i)));const n=!!i;if(!n){const r=this.map?this.map.painter:null;i=new Jc(t,this._source.tileSize*t.overscaleFactor(),this.transform.tileZoom,r,this._isRaster),this._loadTile(i,this._tileLoaded.bind(this,i,t.key,i.state))}return i?(i.uses++,this._tiles[t.key]=i,n||this._source.fire(new jt("dataloading",{tile:i,coord:i.tileID,dataType:"source"})),i):null}_setTileReloadTimer(t,i){t in this._timers&&(clearTimeout(this._timers[t]),delete this._timers[t]);const n=i.getExpiryTimeout();n&&(this._timers[t]=setTimeout(()=>{this._reloadTile(t,"expired"),delete this._timers[t]},n))}_removeTile(t){const i=this._tiles[t];i&&(i.uses--,delete this._tiles[t],this._timers[t]&&(clearTimeout(this._timers[t]),delete this._timers[t]),i.uses>0||(i.hasData()&&i.state!=="reloading"?this._cache.add(i.tileID,i,i.getExpiryTimeout()):(i.aborted=!0,this._abortTile(i),this._unloadTile(i))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const t in this._tiles)this._removeTile(+t);this._source._clear&&this._source._clear(),this._cache.reset(),this.map&&this.usedForTerrain&&this.map.painter.terrain&&this.map.painter.terrain.resetTileLookupCache(this.id)}tilesIn(t,i,n){const r=[],o=this.transform;if(!o)return r;const s=o.projection.name==="globe",a=Fn(o.center.lng);for(const l in this._tiles){const c=this._tiles[l];if(n&&c.clearQueryDebugViz(),c.holdingForFade())continue;let u;if(s){const h=c.tileID.canonical;if(h.z===0){const d=[Math.abs(Lt(a,...Qc(h,-1))-a),Math.abs(Lt(a,...Qc(h,1))-a)];u=[0,2*d.indexOf(Math.min(...d))-1]}else{const d=[Math.abs(Lt(a,...Qc(h,-1))-a),Math.abs(Lt(a,...Qc(h,0))-a),Math.abs(Lt(a,...Qc(h,1))-a)];u=[d.indexOf(Math.min(...d))-1]}}else u=[0];for(const h of u){const d=t.containsTile(c,o,i,h);d&&r.push(d)}}return r}getShadowCasterCoordinates(){return this._getRenderableCoordinates(!1,!0)}getVisibleCoordinates(t){return this._getRenderableCoordinates(t)}_getRenderableCoordinates(t,i){const n=this.getRenderableIds(t,i).map(o=>this._tiles[o].tileID),r=this.transform.projection.name==="globe";for(const o of n)o.projMatrix=this.transform.calculateProjMatrix(o.toUnwrapped()),o.expandedProjMatrix=r?this.transform.calculateProjMatrix(o.toUnwrapped(),!1,!0):o.projMatrix;return n}sortCoordinatesByDistance(t){const i=t.slice(),n=this.transform._camera.position,r=this.transform._camera.forward(),o={};for(const s of i){const a=1/(1<<s.canonical.z);o[s.key]=((s.canonical.x+.5)*a+s.wrap-n[0])*r[0]+((s.canonical.y+.5)*a-n[1])*r[1]-n[2]*r[2]}return i.sort((s,a)=>o[s.key]-o[a.key]),i}hasTransition(){if(this._source.hasTransition())return!0;if(jm(this._source.type))for(const t in this._tiles){const i=this._tiles[t];if(i.fadeEndTime!==void 0&&i.fadeEndTime>=ke.now())return!0}return!1}setFeatureState(t,i,n){this._state.updateState(t=t||"_geojsonTileLayer",i,n)}removeFeatureState(t,i,n){this._state.removeFeatureState(t=t||"_geojsonTileLayer",i,n)}getFeatureState(t,i){return this._state.getState(t=t||"_geojsonTileLayer",i)}setDependencies(t,i,n){const r=this._tiles[t];r&&r.setDependencies(i,n)}reloadTilesForDependencies(t,i){for(const n in this._tiles)this._tiles[n].hasDependency(t,i)&&this._reloadTile(+n,"reloading");this._cache.filter(n=>!n.hasDependency(t,i))}_preloadTiles(t,i){if(!this._sourceLoaded){const a=()=>{this._sourceLoaded&&(this._source.off("data",a),this._preloadTiles(t,i))};return void this._source.on("data",a)}const n=new Map,r=Array.isArray(t)?t:[t],o=this.map.painter.terrain,s=this.usedForTerrain&&o?o.getScaledDemTileSize():this._source.tileSize;for(const a of r){const l=a.coveringTiles({tileSize:s,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(const c of l)n.set(c.key,c);this.usedForTerrain&&a.updateElevation(!1)}Ii(Array.from(n.values()),(a,l)=>{const c=new Jc(a,this._source.tileSize*a.overscaleFactor(),this.transform.tileZoom,this.map.painter,this._isRaster);this._loadTile(c,u=>{this._source.type==="raster-dem"&&c.dem&&this._backfillDEM(c),l(u,c)})},i)}}function sx(e,t){const i=Math.abs(2*e.wrap)-+(e.wrap<0),n=Math.abs(2*t.wrap)-+(t.wrap<0);return e.overscaledZ-t.overscaledZ||n-i||t.canonical.y-e.canonical.y||t.canonical.x-e.canonical.x}function jm(e){return e==="raster"||e==="image"||e==="video"||e==="custom"}function Qc(e,t){const i=1<<e.z;return[e.x/i+t,(e.x+1)/i+t]}co.maxOverzooming=10,co.maxUnderzooming=3;const S3=zi([{name:"a_pos_3f",components:3,type:"Float32"}]),A3=zi([{name:"a_color_3f",components:3,type:"Float32"}]),I3=zi([{name:"a_color_4f",components:4,type:"Float32"}]),C3=zi([{name:"a_uv_2f",components:2,type:"Float32"}]),D3=zi([{name:"a_normal_3f",components:3,type:"Float32"}]),P3=zi([{name:"a_normal_matrix0",components:4,type:"Float32"},{name:"a_normal_matrix1",components:4,type:"Float32"},{name:"a_normal_matrix2",components:4,type:"Float32"},{name:"a_normal_matrix3",components:4,type:"Float32"}]),k3=zi([{name:"a_pbr",components:4,type:"Uint16"},{name:"a_heightBasedEmissiveStrength",components:3,type:"Float32"}]);class Gm{constructor(t=0,i=0,n=0,r=0){if(isNaN(t)||t<0||isNaN(i)||i<0||isNaN(n)||n<0||isNaN(r)||r<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=t,this.bottom=i,this.left=n,this.right=r}interpolate(t,i,n){return i.top!=null&&t.top!=null&&(this.top=ze(t.top,i.top,n)),i.bottom!=null&&t.bottom!=null&&(this.bottom=ze(t.bottom,i.bottom,n)),i.left!=null&&t.left!=null&&(this.left=ze(t.left,i.left,n)),i.right!=null&&t.right!=null&&(this.right=ze(t.right,i.right,n)),this}getCenter(t,i){const n=Lt((this.left+t-this.right)/2,0,t),r=Lt((this.top+i-this.bottom)/2,0,i);return new G(n,r)}equals(t){return this.top===t.top&&this.bottom===t.bottom&&this.left===t.left&&this.right===t.right}clone(){return new Gm(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}function ax(e,t){const i=Ci(e,3);st.fromQuat(e,t),Xi(e,3,i)}function qm(e,t){const i=nr.identity([]);return nr.rotateZ(i,i,-t),nr.rotateX(i,i,-e),i}function lx(e,t){const i=[e[0],e[1],0],n=[t[0],t[1],0];if(Z.length(i)>=1e-15){const s=Z.normalize([],i);Z.scale(n,s,Z.dot(n,s)),t[0]=n[0],t[1]=n[1]}const r=Z.cross([],t,e);if(Z.len(r)<1e-15)return null;const o=Math.atan2(-r[1],r[0]);return qm(Math.atan2(Math.sqrt(e[0]*e[0]+e[1]*e[1]),-e[2]),o)}class cx{constructor(t,i){this.position=t,this.orientation=i}get position(){return this._position}set position(t){if(t){const i=t instanceof ui?t:new ui(t[0],t[1],t[2]);this._renderWorldCopies&&(i.x=Me(i.x,0,1)),this._position=i}else this._position=null}lookAtPoint(t,i){if(this.orientation=null,!this.position)return;const n=this.position,r=this._elevation?this._elevation.getAtPointOrZero(ui.fromLngLat(t)):0,o=ui.fromLngLat(t,r),s=[o.x-n.x,o.y-n.y,o.z-n.z];i||(i=[0,0,1]),i[2]=Math.abs(i[2]),this.orientation=lx(s,i)}setPitchBearing(t,i){this.orientation=qm(wt(t),wt(-i))}}class Qh{constructor(t,i){this._transform=st.identity([]),this.orientation=i,this.position=t}get mercatorPosition(){const t=this.position;return new ui(t[0],t[1],t[2])}get position(){const t=Ci(this._transform,3);return[t[0],t[1],t[2]]}set position(t){var i;t&&Xi(this._transform,3,[(i=t)[0],i[1],i[2],1])}get orientation(){return this._orientation}set orientation(t){this._orientation=t||nr.identity([]),t&&ax(this._transform,this._orientation)}getPitchBearing(){const t=this.forward(),i=this.right();return{bearing:Math.atan2(-i[1],i[0]),pitch:Math.atan2(Math.sqrt(t[0]*t[0]+t[1]*t[1]),-t[2])}}setPitchBearing(t,i){this._orientation=qm(t,i),ax(this._transform,this._orientation)}forward(){const t=Ci(this._transform,2);return[-t[0],-t[1],-t[2]]}up(){const t=Ci(this._transform,1);return[-t[0],-t[1],-t[2]]}right(){const t=Ci(this._transform,0);return[t[0],t[1],t[2]]}getCameraToWorld(t,i){const n=new Float64Array(16);return st.invert(n,this.getWorldToCamera(t,i)),n}getCameraToWorldMercator(){return this._transform}getWorldToCameraPosition(t,i,n){const r=this.position;Z.scale(r,r,-t);const o=new Float64Array(16);return st.fromScaling(o,[n,n,n]),st.translate(o,o,r),o[10]*=i,o}getWorldToCamera(t,i){const n=new Float64Array(16),r=new Float64Array(4),o=this.position;return nr.conjugate(r,this._orientation),Z.scale(o,o,-t),st.fromQuat(n,r),st.translate(n,n,o),n[1]*=-1,n[5]*=-1,n[9]*=-1,n[13]*=-1,n[8]*=i,n[9]*=i,n[10]*=i,n[11]*=i,n}getCameraToClipPerspective(t,i,n,r){const o=new Float64Array(16);return st.perspective(o,t,i,n,r),o}getCameraToClipOrthographic(t,i,n,r,o,s){const a=new Float64Array(16);return st.ortho(a,t,i,n,r,o,s),a}getDistanceToElevation(t,i=!1){const n=t===0?0:Gi(t,i?On(this.position[1]):this.position[1]),r=this.forward();return(n-this.position[2])/r[2]}clone(){return new Qh([...this.position],[...this.orientation])}}function ux(e,t){const i=tu(e.projection,e.zoom,e.width,e.height),n=function(o,s,a,l,c){const u=new Le(a.lng-180*ta,a.lat),h=new Le(a.lng+180*ta,a.lat),d=o.project(u.lng,u.lat),p=o.project(h.lng,h.lat),_=-Math.atan2(p.y-d.y,p.x-d.x),g=ui.fromLngLat(a);g.y=Lt(g.y,-1+ta,1-ta);const y=g.toLngLat(),x=o.project(y.lng,y.lat),b=ui.fromLngLat(y);b.x+=ta;const M=b.toLngLat(),E=o.project(M.lng,M.lat),T=fx(E.x-x.x,E.y-x.y,_),S=ui.fromLngLat(y);S.y+=ta;const D=S.toLngLat(),z=o.project(D.lng,D.lat),L=fx(z.x-x.x,z.y-x.y,_),R=Math.abs(T.x)/Math.abs(L.y),N=st.identity([]);st.rotateZ(N,N,-_*(1-(c?0:l)));const U=st.identity([]);return st.scale(U,U,[1,1-(1-R)*l,1]),U[4]=-L.x/L.y*l,st.rotateZ(U,U,_),st.multiply(U,N,U),U}(e.projection,0,e.center,i,t),r=hx(e);return st.scale(n,n,[r,r,1]),n}function hx(e){const t=e.projection,i=tu(e.projection,e.zoom,e.width,e.height),n=dx(t,e.center),r=dx(t,Le.convert(t.center));return Math.pow(2,n*i+(1-i)*r)}function tu(e,t,i,n,r=1/0){const o=e.range;if(!o)return 0;const s=Math.min(r,Math.max(i,n)),a=Math.log(s/1024)/Math.LN2;return Fe(o[0]+a,o[1]+a,t)}const ta=1/4e4;function dx(e,t){const i=Lt(t.lat,-Sn,Sn),n=new Le(t.lng-180*ta,i),r=new Le(t.lng+180*ta,i),o=e.project(n.lng,i),s=e.project(r.lng,i),a=ui.fromLngLat(n),l=ui.fromLngLat(r),c=s.x-o.x,u=s.y-o.y,h=l.x-a.x,d=l.y-a.y,p=Math.sqrt((h*h+d*d)/(c*c+u*u));return Math.log(p)/Math.LN2}function fx(e,t,i){const n=Math.cos(i),r=Math.sin(i);return{x:e*n-t*r,y:e*r+t*n}}function za(e,t,i){return t*(pt/(e.tileSize*Math.pow(2,i-e.tileID.overscaledZ)))}const Ol={unknown:0,flipRequired:1,flipNotRequired:2},z3=Math.tan(85*Math.PI/180);function td(e,t,i,n,r,o,s){const a=st.create();if(i)if(o.name==="globe"){const l=function(c,u){const{x:h,y:d}=c.point,p=k1(h,d,c.worldSize/c._pixelsPerMercatorPixel,0,0);return st.multiply(p,p,nm(Fr(u)))}(r,t);st.multiply(a,a,l)}else{const l=vl.invert([],s);a[0]=l[0],a[1]=l[1],a[4]=l[2],a[5]=l[3],n||st.rotateZ(a,a,r.angle)}else st.multiply(a,r.labelPlaneMatrix,e);return a}function px(e,t,i,n,r,o,s){const a=td(e,t,i,n,r,o,s);return o.name==="globe"&&i||(a[2]=a[6]=a[10]=a[14]=0),a}function mx(e,t,i,n,r,o,s){if(i){if(o.name==="globe"){const a=td(e,t,i,n,r,o,s);return st.invert(a,a),st.multiply(a,e,a),a}{const a=st.clone(e),l=st.identity([]);return l[0]=s[0],l[1]=s[1],l[4]=s[2],l[5]=s[3],st.multiply(a,a,l),n||st.rotateZ(a,a,-r.angle),a}}return r.glCoordMatrix}function uo(e,t,i,n){const r=[e,t,i,1];i?Ni.transformMat4(r,r,n):wx(r,r,n);const o=r[3];return r[0]/=o,r[1]/=o,r[2]/=o,r}function _x(e,t){return Math.min(.5+e/t*.5,1.5)}function L3(e,t){const i=e[0]/e[3],n=e[1]/e[3];return i>=-t[0]&&i<=t[0]&&n>=-t[1]&&n<=t[1]}function R3(e,t,i,n,r,o,s,a,l,c){const u=i.transform,h=n?e.textSizeData:e.iconSizeData,d=ko(h,i.transform.zoom),p=u.projection.name==="globe",_=[256/i.width*2+1,256/i.height*2+1],g=n?e.text.dynamicLayoutVertexArray:e.icon.dynamicLayoutVertexArray;g.clear();let y=null;p&&(y=n?e.text.globeExtVertexArray:e.icon.globeExtVertexArray);const x=e.lineVertexArray,b=n?e.text.placedSymbolArray:e.icon.placedSymbolArray,M=i.transform.width/i.transform.height;let E,T=!1;for(let S=0;S<b.length;S++){const D=b.get(S),{numGlyphs:z,writingMode:L}=D;if(L!==un.vertical||T||E===un.horizontal||(T=!0),E=L,(D.hidden||L===un.vertical)&&!T){Bl(z,g);continue}T=!1;const R=new G(D.tileAnchorX,D.tileAnchorY);let{x:N,y:U,z:H}=u.projection.projectTilePoint(R.x,R.y,c.canonical);if(l){const[bt,Mt,Et]=l(R);N+=bt,U+=Mt,H+=Et}const O=[N,U,H,1];if(Ni.transformMat4(O,O,t),!L3(O,_)){Bl(z,g);continue}const X=O[3],K=_x(i.transform.getCameraToCenterDistance(u.projection),X),ot=jc(h,d,D),$=s?ot/K:ot*K,Y=uo(N,U,H,r);if(Y[3]<=0){Bl(z,g);continue}let at={};const ut=s?null:l,ct=vx(D,$,!1,a,t,r,o,e.glyphOffsetArray,x,g,y,Y,R,at,M,ut,u.projection,c,s);T=ct.useVertical,ut&&ct.needsFlipping&&(at={}),(ct.notEnoughRoom||T||ct.needsFlipping&&vx(D,$,!0,a,t,r,o,e.glyphOffsetArray,x,g,y,Y,R,at,M,ut,u.projection,c,s).notEnoughRoom)&&Bl(z,g)}n?(e.text.dynamicLayoutVertexBuffer.updateData(g),y&&e.text.globeExtVertexBuffer&&e.text.globeExtVertexBuffer.updateData(y)):(e.icon.dynamicLayoutVertexBuffer.updateData(g),y&&e.icon.globeExtVertexBuffer&&e.icon.globeExtVertexBuffer.updateData(y))}function gx(e,t,i,n,r,o,s,a,l,c,u,h,d,p,_,g){const{lineStartIndex:y,glyphStartIndex:x,segment:b}=a,M=x+a.numGlyphs,E=y+a.lineLength,T=t.getoffsetX(x),S=t.getoffsetX(M-1),D=ed(e*T,i,n,r,o,s,b,y,E,l,c,u,h,d,!0,p,_,g);if(!D)return null;const z=ed(e*S,i,n,r,o,s,b,y,E,l,c,u,h,d,!0,p,_,g);return z?{first:D,last:z}:null}function yx(e,t,i,n){return e===un.horizontal&&Math.abs(n)>Math.abs(i)?{useVertical:!0}:e===un.vertical?n>0?{needsFlipping:!0}:null:t!==Ol.unknown&&function(r,o){return r===0||Math.abs(o/r)>z3}(i,n)?t===Ol.flipRequired?{needsFlipping:!0}:null:i<0?{needsFlipping:!0}:null}function vx(e,t,i,n,r,o,s,a,l,c,u,h,d,p,_,g,y,x,b){const M=t/24,E=e.lineOffsetX*M,T=e.lineOffsetY*M,{lineStartIndex:S,glyphStartIndex:D,numGlyphs:z,segment:L,writingMode:R,flipState:N}=e,U=S+e.lineLength,H=O=>{if(u){const[$,Y,at]=O.up,ut=c.length;Wh(u,ut+0,$,Y,at),Wh(u,ut+1,$,Y,at),Wh(u,ut+2,$,Y,at),Wh(u,ut+3,$,Y,at)}const[X,K,ot]=O.point;Rl(c,X,K,ot,O.angle)};if(z>1){const O=gx(M,a,E,T,i,h,d,e,l,o,p,g,!1,y,x,b);if(!O)return{notEnoughRoom:!0};if(n&&!i){let[X,K,ot]=O.first.point,[$,Y,at]=O.last.point;[X,K]=uo(X,K,ot,s),[$,Y]=uo($,Y,at,s);const ut=yx(R,N,($-X)*_,Y-K);if(e.flipState=ut&&ut.needsFlipping?Ol.flipRequired:Ol.flipNotRequired,ut)return ut}H(O.first);for(let X=D+1;X<D+z-1;X++){const K=ed(M*a.getoffsetX(X),E,T,i,h,d,L,S,U,l,o,p,g,!1,!1,y,x,b);if(!K)return c.length-=4*(X-D),{notEnoughRoom:!0};H(K)}H(O.last)}else{if(n&&!i){const X=uo(d.x,d.y,0,r),K=S+L+1,ot=new G(l.getx(K),l.gety(K)),$=uo(ot.x,ot.y,0,r),Y=$[3]>0?$:bx(d,ot,X,1,r,void 0,y,x.canonical),at=yx(R,N,(Y[0]-X[0])*_,Y[1]-X[1]);if(e.flipState=at&&at.needsFlipping?Ol.flipRequired:Ol.flipNotRequired,at)return at}const O=ed(M*a.getoffsetX(D),E,T,i,h,d,L,S,U,l,o,p,g,!1,!1,y,x,b);if(!O)return{notEnoughRoom:!0};H(O)}return{}}function xx(e,t,i,n,r){const{x:o,y:s,z:a}=n.projectTilePoint(e.x,e.y,t);if(!r)return uo(o,s,a,i);const[l,c,u]=r(e);return uo(o+l,s+c,a+u,i)}function bx(e,t,i,n,r,o,s,a){const l=xx(e.sub(t)._unit()._add(e),a,r,s,o);return Z.sub(l,i,l),Z.normalize(l,l),Z.scaleAndAdd(l,i,l,n)}function ed(e,t,i,n,r,o,s,a,l,c,u,h,d,p,_,g,y,x){const b=n?e-t:e+t;let M=b>0?1:-1,E=0;n&&(M*=-1,E=Math.PI),M<0&&(E+=Math.PI);let T=a+s+(M>0?0:1)|0,S=r,D=r,z=0,L=0;const R=Math.abs(b),N=[],U=[];let H=o,O=H;const X=()=>bx(O,H,D,R-z+1,u,d,g,y.canonical);for(;z+L<=R;){if(T+=M,T<a||T>=l)return null;if(D=S,O=H,N.push(D),p&&U.push(O),H=new G(c.getx(T),c.gety(T)),S=h[T],!S){const Mt=xx(H,y.canonical,u,g,d);S=Mt[3]>0?h[T]=Mt:X()}z+=L,L=Z.distance(D,S)}_&&d&&(h[T]&&(S=X(),L=Z.distance(D,S)),h[T]=S);const K=(R-z)/L,ot=H.sub(O)._mult(K)._add(O),$=Z.sub([],S,D),Y=Z.scaleAndAdd([],D,$,K);let at=[0,0,1],ut=$[0],ct=$[1];if(x&&(at=g.upVector(y.canonical,ot.x,ot.y),at[0]!==0||at[1]!==0||at[2]!==1)){const Mt=[at[2],0,-at[0]],Et=Z.cross([],at,Mt);Z.normalize(Mt,Mt),Z.normalize(Et,Et),ut=Z.dot($,Mt),ct=Z.dot($,Et)}if(i){const Mt=Z.cross([],at,$);Z.normalize(Mt,Mt),Z.scaleAndAdd(Y,Y,Mt,i*M)}const bt=E+Math.atan2(ct,ut);return N.push(Y),p&&U.push(ot),{point:Y,angle:bt,path:N,tilePath:U,up:at}}function Bl(e,t){const i=t.length,n=i+4*e;t.resize(n),t.float32.fill(-1/0,4*i,4*n)}function wx(e,t,i){const n=t[0],r=t[1];return e[0]=i[0]*n+i[4]*r+i[12],e[1]=i[1]*n+i[5]*r+i[13],e[3]=i[3]*n+i[7]*r+i[15],e}const Tx=(e,t,i)=>(1-i)*e+i*t,Mx=e=>e*e*e*e*e;class Zm{constructor(t,i,n,r,o,s,a){this.tileSize=512,this._renderWorldCopies=o===void 0||o,this._minZoom=t||0,this._maxZoom=i||22,this._minPitch=n??0,this._maxPitch=r??60,this.setProjection(s),this.setMaxBounds(a),this.width=0,this.height=0,this._center=new Le(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new Gm,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._expandedProjMatrixCache={},this._distanceTileDataCache={},this._camera=new Qh,this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._pixelsPerMercatorPixel=1,this.globeRadius=0,this.globeCenterInViewSpace=[0,0,0],this._horizonShift=.1,this._orthographicProjectionAtLowPitch=!1}clone(){const t=new Zm(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies,this.getProjection());return t._elevation=this._elevation,t._centerAltitude=this._centerAltitude,t._centerAltitudeValidForExaggeration=this._centerAltitudeValidForExaggeration,t.tileSize=this.tileSize,t.mercatorFromTransition=this.mercatorFromTransition,t.width=this.width,t.height=this.height,t.cameraElevationReference=this.cameraElevationReference,t._center=this._center,t._setZoom(this.zoom),t._seaLevelZoom=this._seaLevelZoom,t.angle=this.angle,t._fov=this._fov,t._pitch=this._pitch,t._nearZ=this._nearZ,t._farZ=this._farZ,t._averageElevation=this._averageElevation,t._orthographicProjectionAtLowPitch=this._orthographicProjectionAtLowPitch,t._unmodified=this._unmodified,t._edgeInsets=this._edgeInsets.clone(),t._camera=this._camera.clone(),t._calcMatrices(),t.freezeTileCoverage=this.freezeTileCoverage,t.frustumCorners=this.frustumCorners,t}get isOrthographic(){return this.projection.name!=="globe"&&this._orthographicProjectionAtLowPitch&&this.pitch<15}get elevation(){return this._elevation}set elevation(t){this._elevation!==t&&(this._elevation=t,this._updateCameraOnTerrain(),this._calcMatrices())}get depthOcclusionForSymbolsAndCircles(){return this.projection.name!=="globe"&&!this.isOrthographic}updateElevation(t,i=!1){const n=this._elevation&&this._elevation.exaggeration()!==this._centerAltitudeValidForExaggeration;(this._seaLevelZoom==null||n)&&this._updateCameraOnTerrain(),(t||n)&&this._constrainCamera(i),this._calcMatrices()}getProjection(){return Ve(this.projection,["name","center","parallels"])}setProjection(t){this.projectionOptions=t||{name:"mercator"};const i=this.projection?this.getProjection():void 0;this.projection=jh(this.projectionOptions);const n=!Tt(i,this.getProjection());return n&&this._calcMatrices(),this.mercatorFromTransition=!1,n}setOrthographicProjectionAtLowPitch(t){return this._orthographicProjectionAtLowPitch!==t&&(this._orthographicProjectionAtLowPitch=t,this._calcMatrices(),!0)}setMercatorFromTransition(){const t=this.projection.name;this.mercatorFromTransition=!0,this.projectionOptions={name:"mercator"},this.projection=jh({name:"mercator"});const i=t!==this.projection.name;return i&&this._calcMatrices(),i}get minZoom(){return this._minZoom}set minZoom(t){this._minZoom!==t&&(this._minZoom=t,this.zoom=Math.max(this.zoom,t))}get maxZoom(){return this._maxZoom}set maxZoom(t){this._maxZoom!==t&&(this._maxZoom=t,this.zoom=Math.min(this.zoom,t))}get minPitch(){return this._minPitch}set minPitch(t){this._minPitch!==t&&(this._minPitch=t,this.pitch=Math.max(this.pitch,t))}get maxPitch(){return this._maxPitch}set maxPitch(t){this._maxPitch!==t&&(this._maxPitch=t,this.pitch=Math.min(this.pitch,t))}get renderWorldCopies(){return this._renderWorldCopies&&this.projection.supportsWorldCopies===!0}set renderWorldCopies(t){t===void 0?t=!0:t===null&&(t=!1),this._renderWorldCopies=t}get worldSize(){return this.tileSize*this.scale}get cameraWorldSizeForFog(){const t=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(t))}get cameraWorldSize(){const t=Math.max(this._camera.getDistanceToElevation(this._averageElevation,!0),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(t))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return Gi(1,this.center.lat)*this.cameraWorldSizeForFog}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new G(this.width,this.height)}get bearing(){return Me(this.rotation,-180,180)}set bearing(t){this.rotation=t}get rotation(){return-this.angle/Math.PI*180}set rotation(t){const i=-t*Math.PI/180;this.angle!==i&&(this._unmodified=!1,this.angle=i,this._calcMatrices(),this.rotationMatrix=vl.create(),vl.rotate(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(t){const i=Lt(t,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==i&&(this._unmodified=!1,this._pitch=i,this._calcMatrices())}get aspect(){return this.width/this.height}get fov(){return this._fov/Math.PI*180}get fovX(){return this._fov}get fovY(){const t=1/Math.tan(.5*this.fovX);return 2*Math.atan(1/this.aspect/t)}set fov(t){t=Math.max(.01,Math.min(60,t)),this._fov!==t&&(this._unmodified=!1,this._fov=wt(t),this._calcMatrices())}get averageElevation(){return this._averageElevation}set averageElevation(t){this._averageElevation=t,this._calcFogMatrices(),this._distanceTileDataCache={}}get zoom(){return this._zoom}set zoom(t){const i=Math.min(Math.max(t,this.minZoom),this.maxZoom);this._zoom!==i&&(this._unmodified=!1,this._setZoom(i),this._updateSeaLevelZoom(),this._constrain(),this._calcMatrices())}_setZoom(t){this._zoom=t,this.scale=this.zoomScale(t),this.tileZoom=Math.floor(t),this.zoomFraction=t-this.tileZoom}_updateCameraOnTerrain(){const t=this.elevation?this.elevation.getAtPoint(this.locationCoordinate(this.center),Number.NEGATIVE_INFINITY):Number.NEGATIVE_INFINITY,i=this.elevation&&t===Number.NEGATIVE_INFINITY&&this.elevation.visibleDemTiles.length>0&&this.elevation.exaggeration()>0&&this._centerAltitudeValidForExaggeration;if(!this._elevation||t===Number.NEGATIVE_INFINITY&&(!i||!this._centerAltitude))return this._centerAltitude=0,this._seaLevelZoom=null,void(this._centerAltitudeValidForExaggeration=void 0);const n=this._elevation;i||this._centerAltitude&&this._centerAltitudeValidForExaggeration&&n.exaggeration()&&this._centerAltitudeValidForExaggeration!==n.exaggeration()?(this._centerAltitude=this._centerAltitude/this._centerAltitudeValidForExaggeration*n.exaggeration(),this._centerAltitudeValidForExaggeration=n.exaggeration()):(this._centerAltitude=t||0,this._centerAltitudeValidForExaggeration=n.exaggeration()),this._updateSeaLevelZoom()}_updateSeaLevelZoom(){this._centerAltitudeValidForExaggeration!==void 0&&(this._seaLevelZoom=this._zoomFromMercatorZ((this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize))}sampleAverageElevation(){if(!this._elevation)return 0;const t=this._elevation,i=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],n=this.horizonLineFromTop();let r=0,o=0;for(let s=0;s<i.length;s++){const a=new G(i[s][0]*this.width,n+i[s][1]*(this.height-n)),l=t.pointCoordinate(a);if(!l)continue;const c=1/Math.hypot(l[0]-this._camera.position[0],l[1]-this._camera.position[1]);r+=l[3]*c,o+=c}return o===0?NaN:r/o}get center(){return this._center}set center(t){t.lat===this._center.lat&&t.lng===this._center.lng||(this._unmodified=!1,this._center=t,this._terrainEnabled()&&(this.cameraElevationReference==="ground"?this._updateCameraOnTerrain():this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(this._seaLevelZoom==null||!this._elevation)return;const t=this._seaLevelZoom,i=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),n=this.pixelsPerMeter/this.worldSize*i,r=this._mercatorZfromZoom(t),o=this._mercatorZfromZoom(this._maxZoom),s=Math.max(r-n,o);this._setZoom(this._zoomFromMercatorZ(s))}get padding(){return this._edgeInsets.toJSON()}set padding(t){this._edgeInsets.equals(t)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,t,1),this._calcMatrices())}computeZoomRelativeTo(t){const i=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,t.toAltitude()));let n;n=t.z<this._camera.position[2]?[i.x,i.y,i.z]:[t.x,t.y,t.z];const r=Z.length(Z.sub([],this._camera.position,n));return Lt(this._zoomFromMercatorZ(r),this._minZoom,this._maxZoom)}setFreeCameraOptions(t){if(!this.height||!t.position&&!t.orientation)return;this._updateCameraState();let i=!1;if(t.orientation&&!nr.exactEquals(t.orientation,this._camera.orientation)&&(i=this._setCameraOrientation(t.orientation)),t.position){const n=[t.position.x,t.position.y,t.position.z];Z.exactEquals(n,this._camera.position)||(this._setCameraPosition(n),i=!0)}i&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();const t=this._camera.position,i=new cx;return i.position=new ui(t[0],t[1],t[2]),i.orientation=this._camera.orientation,i._elevation=this.elevation,i._renderWorldCopies=this.renderWorldCopies,i}_setCameraOrientation(t){if(!nr.length(t))return!1;nr.normalize(t,t);const i=Z.transformQuat([],[0,0,-1],t),n=Z.transformQuat([],[0,-1,0],t);if(n[2]<0)return!1;const r=lx(i,n);return!!r&&(this._camera.orientation=r,!0)}_setCameraPosition(t){const i=this.zoomScale(this.minZoom)*this.tileSize,n=this.zoomScale(this.maxZoom)*this.tileSize,r=this.cameraToCenterDistance;t[2]=Lt(t[2],r/n,r/i),this._camera.position=t}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(t){return this._edgeInsets.equals(t)}interpolatePadding(t,i,n){this._unmodified=!1,this._edgeInsets.interpolate(t,i,n),this._constrain(),this._calcMatrices()}coveringZoomLevel(t){const i=(t.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/t.tileSize));return Math.max(0,i)}getVisibleUnwrappedCoordinates(t){const i=[new Kp(0,t)];if(this.renderWorldCopies){const n=this.pointCoordinate(new G(0,0)),r=this.pointCoordinate(new G(this.width,0)),o=this.pointCoordinate(new G(this.width,this.height)),s=this.pointCoordinate(new G(0,this.height)),a=Math.floor(Math.min(n.x,r.x,o.x,s.x)),l=Math.floor(Math.max(n.x,r.x,o.x,s.x)),c=1;for(let u=a-c;u<=l+c;u++)u!==0&&i.push(new Kp(u,t))}return i}isLODDisabled(t){return(!t||this.pitch<=60)&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace}extendTileCoverForShadows(t,i,n){let r=[];if(i[0]===0&&i[1]===0)return r;for(const s of t){const a=s.canonical,l=s.overscaledZ,c=s.wrap,u=1<<a.z,h=a.x+1<u,d=a.x>0,p=a.y+1<u,_=a.y>0,g=s.wrap-(d?0:1),y=s.wrap+(h?0:1),x=d?a.x-1:u-1,b=h?a.x+1:0;i[0]<0?(r.push(new Si(l,y,a.z,b,a.y)),i[1]<0&&p&&(r.push(new Si(l,c,a.z,a.x,a.y+1)),r.push(new Si(l,y,a.z,b,a.y+1))),i[1]>0&&_&&(r.push(new Si(l,c,a.z,a.x,a.y-1)),r.push(new Si(l,y,a.z,b,a.y-1)))):i[0]>0?(r.push(new Si(l,g,a.z,x,a.y)),i[1]<0&&p&&(r.push(new Si(l,c,a.z,a.x,a.y+1)),r.push(new Si(l,g,a.z,x,a.y+1))),i[1]>0&&_&&(r.push(new Si(l,c,a.z,a.x,a.y-1)),r.push(new Si(l,g,a.z,x,a.y-1)))):i[1]<0&&p?r.push(new Si(l,c,a.z,a.x,a.y+1)):_&&r.push(new Si(l,c,a.z,a.x,a.y-1))}if(r.length>1){r.sort((l,c)=>l.overscaledZ-c.overscaledZ||l.wrap-c.wrap||l.canonical.z-c.canonical.z||l.canonical.x-c.canonical.x||l.canonical.y-c.canonical.y);let s=0,a=0;for(;a<r.length;)r[a].equals(r[s])?++a:r[++s]=r[a++];r.length=s+1}const o=[];for(const s of r)r.some(a=>s.isChildOf(a))||o.push(s);return r=o.filter(s=>!t.some(a=>!!(s.overscaledZ<n&&a.isChildOf(s))||s.equals(a)||s.isChildOf(a))),r}coveringTiles(t){let i=this.coveringZoomLevel(t);const n=i,r=this.elevation&&this.elevation.exaggeration(),o=r&&!t.isTerrainDEM,s=this.projection.name==="mercator";if(t.minzoom!==void 0&&i<t.minzoom)return[];t.maxzoom!==void 0&&i>t.maxzoom&&(i=t.maxzoom);const a=this.locationCoordinate(this.center),l=this.center.lat,c=1<<i,u=[c*a.x,c*a.y,0],h=this.projection.name==="globe",d=!h,p=cs.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,i,d),_=h?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),g=c*Gi(1,this.center.lat),y=this._camera.position[2]/Gi(1,this.center.lat),x=[c*_.x,c*_.y,y*(d?1:g)],b=h||r,M=this.cameraToCenterDistance/t.tileSize*(t.roundZoom?1:.502),E=this.isLODDisabled(!0)?i:0;let T;if(this._elevation&&t.isTerrainDEM)T=1e4*this._elevation.exaggeration();else if(this._elevation){const $=this._elevation.getMinMaxForVisibleTiles();T=$?$.max:this._centerAltitude}else T=this._centerAltitude;const S=t.isTerrainDEM?-T:this._elevation?this._elevation.getMinElevationBelowMSL():0,D=this.projection.isReprojectedInTileSpace?hx(this):1,z=$=>{const at=new ui($.x+25e-6,$.y,$.z),ut=new ui($.x,$.y+25e-6,$.z),ct=$.toLngLat(),bt=at.toLngLat(),Mt=ut.toLngLat(),Et=this.locationCoordinate(ct),ft=this.locationCoordinate(bt),kt=this.locationCoordinate(Mt),Qt=Math.hypot(ft.x-Et.x,ft.y-Et.y),te=Math.hypot(kt.x-Et.x,kt.y-Et.y);return Math.sqrt(Qt*te)*D/25e-6},L=$=>{const Y=T,at=S;return{aabb:Xv(this,c,0,0,0,$,at,Y,this.projection),zoom:0,x:0,y:0,minZ:at,maxZ:Y,wrap:$,fullyVisible:!1}},R=[];let N=[];const U=i,H=t.reparseOverscaled?n:i,O=$=>$*$,X=O((y-this._centerAltitude)*g),K=$=>{if(!this._elevation||!$.tileID||!s)return;const Y=this._elevation.getMinMaxForTile($.tileID),at=$.aabb;Y?(at.min[2]=Y.min,at.max[2]=Y.max,at.center[2]=(at.min[2]+at.max[2])/2):($.shouldSplit=ot($),$.shouldSplit||(at.min[2]=at.max[2]=at.center[2]=this._centerAltitude))},ot=$=>{if($.zoom<E)return!0;if($.zoom===U)return!1;if($.shouldSplit!=null)return $.shouldSplit;const Y=$.aabb.distanceX(x),at=$.aabb.distanceY(x);let ut=X,ct=1;if(h){ut=O($.aabb.distanceZ(x));const Et=Math.pow(2,$.zoom),ft=On(($.y+1)/Et),kt=On($.y/Et),Qt=Math.min(Math.max(l,ft),kt),te=_h(Qt)/_h(l);if(ct=Qt===l?1/Math.max(1,this._mercatorScaleRatio-.3):Math.min(1,te/this._mercatorScaleRatio),this.zoom<=Oc&&$.zoom===U-1&&te>=.9)return!0}else if(o&&(ut=O($.aabb.distanceZ(x)*g)),this.projection.isReprojectedInTileSpace&&n<=5){const Et=Math.pow(2,$.zoom),ft=z(new ui(($.x+.5)/Et,($.y+.5)/Et));ct=ft>.85?1:ft}const bt=Y*Y+at*at+ut,Mt=O((1<<U-$.zoom)*M*ct*((Et,ft)=>{if(ft*O(.707)<Et)return 1;const kt=Math.sqrt(ft/Et);return kt/(1.4144271570014144+(Math.pow(1.1,kt-1.4144271570014144+1)-1)/(1.1-1)-1)})(Math.max(ut,X),bt));return bt<Mt};if(this.renderWorldCopies)for(let $=1;$<=3;$++)R.push(L(-$)),R.push(L($));for(R.push(L(0));R.length>0;){const $=R.pop(),Y=$.x,at=$.y;let ut=$.fullyVisible;const ct=()=>this.projection.name==="globe"&&($.y===0||$.y===(1<<$.zoom)-1);if(!ut){let bt=b?$.aabb.intersects(p):$.aabb.intersectsFlat(p);if(bt===0&&ct()){const Mt=new Yr($.zoom,Y,at);bt=em(this,c,Mt,!0).intersects(p)}if(bt===0)continue;ut=bt===2}if($.zoom!==U&&ot($))for(let bt=0;bt<4;bt++){const Mt=(Y<<1)+bt%2,Et=(at<<1)+(bt>>1),ft={aabb:s?$.aabb.quadrant(bt):Xv(this,c,$.zoom+1,Mt,Et,$.wrap,$.minZ,$.maxZ,this.projection),zoom:$.zoom+1,x:Mt,y:Et,wrap:$.wrap,fullyVisible:ut,tileID:void 0,shouldSplit:void 0,minZ:$.minZ,maxZ:$.maxZ};o&&!h&&(ft.tileID=new Si($.zoom+1===U?H:$.zoom+1,$.wrap,$.zoom+1,Mt,Et),K(ft)),R.push(ft)}else{const bt=$.zoom===U?H:$.zoom;if(t.minzoom&&t.minzoom>bt)continue;if(!ut){let kt=b?$.aabb.intersectsPrecise(p):$.aabb.intersectsPreciseFlat(p);if(kt===0&&ct()){const Qt=new Yr($.zoom,Y,at);kt=em(this,c,Qt,!0).intersectsPrecise(p)}if(kt===0)continue}const Mt=u[0]-(.5+Y+($.wrap<<$.zoom))*(1<<i-$.zoom),Et=u[1]-.5-at,ft=$.tileID?$.tileID:new Si(bt,$.wrap,$.zoom,Y,at);N.push({tileID:ft,distanceSq:Mt*Mt+Et*Et})}}if(this.fogCullDistSq){const $=this.fogCullDistSq,Y=this.horizonLineFromTop();N=N.filter(at=>{const ut=[0,0,0,1],ct=[pt,pt,0,1],bt=this.calculateFogTileMatrix(at.tileID.toUnwrapped());Ni.transformMat4(ut,ut,bt),Ni.transformMat4(ct,ct,bt);const Mt=function(kt,Qt,te){let oe=0;for(let ce=0;ce<2;++ce)kt[ce]>0&&(oe+=(kt[ce]-0)*(kt[ce]-0)),Qt[ce]<0&&(oe+=(0-Qt[ce])*(0-Qt[ce]));return oe}(Ni.min([],ut,ct),Ni.max([],ut,ct));if(Mt===0)return!0;let Et=!1;const ft=this._elevation;if(ft&&Mt>$&&Y!==0){const kt=this.calculateProjMatrix(at.tileID.toUnwrapped());let Qt;t.isTerrainDEM||(Qt=ft.getMinMaxForTile(at.tileID)),Qt||(Qt={min:S,max:T});const te=function(ce){const Ce=Math.round((ce+45+360)%360/90)%4;return ai[Ce]}(this.rotation),oe=[te[0]*pt,te[1]*pt,Qt.max];Z.transformMat4(oe,oe,kt),Et=(1-oe[1])*this.height*.5<Y}return Mt<$||Et})}return N.sort(($,Y)=>$.distanceSq-Y.distanceSq).map($=>$.tileID)}resize(t,i){this.width=t,this.height=i,this.pixelsToGLUnits=[2/t,-2/i],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(t){return Math.pow(2,t)}scaleZoom(t){return Math.log(t)/Math.LN2}project(t){const i=Lt(t.lat,-Sn,Sn),n=this.projection.project(t.lng,i);return new G(n.x*this.worldSize,n.y*this.worldSize)}unproject(t){return this.projection.unproject(t.x/this.worldSize,t.y/this.worldSize)}get point(){return this.project(this.center)}get pointMerc(){return this.point._div(this.worldSize)}get pixelsPerMeterRatio(){return this.pixelsPerMeter/Gi(1,this.center.lat)/this.worldSize}setLocationAtPoint(t,i){let n,r;const o=this.centerPoint;if(this.projection.name==="globe"){const a=this.worldSize;n=(i.x-o.x)/a,r=(i.y-o.y)/a}else{const a=this.pointCoordinate(i),l=this.pointCoordinate(o);n=a.x-l.x,r=a.y-l.y}const s=this.locationCoordinate(t);this.setLocation(new ui(s.x-n,s.y-r))}setLocation(t){this.center=this.coordinateLocation(t),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(t){return this.projection.locationPoint(this,t)}locationPoint3D(t){return this.projection.locationPoint(this,t,!0)}pointLocation(t){return this.coordinateLocation(this.pointCoordinate(t))}pointLocation3D(t){return this.coordinateLocation(this.pointCoordinate3D(t))}locationCoordinate(t,i){const n=i?Gi(i,t.lat):void 0,r=this.projection.project(t.lng,t.lat);return new ui(r.x,r.y,n)}coordinateLocation(t){return this.projection.unproject(t.x,t.y)}pointRayIntersection(t,i){const n=i??this._centerAltitude,r=[t.x,t.y,0,1],o=[t.x,t.y,1,1];Ni.transformMat4(r,r,this.pixelMatrixInverse),Ni.transformMat4(o,o,this.pixelMatrixInverse);const s=o[3];Ni.scale(r,r,1/r[3]),Ni.scale(o,o,1/s);const a=r[2],l=o[2];return{p0:r,p1:o,t:a===l?0:(n-a)/(l-a)}}screenPointToMercatorRay(t){const i=[t.x,t.y,0,1],n=[t.x,t.y,1,1];return Ni.transformMat4(i,i,this.pixelMatrixInverse),Ni.transformMat4(n,n,this.pixelMatrixInverse),Ni.scale(i,i,1/i[3]),Ni.scale(n,n,1/n[3]),i[2]=Gi(i[2],this._center.lat)*this.worldSize,n[2]=Gi(n[2],this._center.lat)*this.worldSize,Ni.scale(i,i,1/this.worldSize),Ni.scale(n,n,1/this.worldSize),new hh([i[0],i[1],i[2]],Z.normalize([],Z.sub([],n,i)))}rayIntersectionCoordinate(t){const{p0:i,p1:n,t:r}=t,o=Gi(i[2],this._center.lat),s=Gi(n[2],this._center.lat);return new ui(ze(i[0],n[0],r)/this.worldSize,ze(i[1],n[1],r)/this.worldSize,ze(o,s,r))}pointCoordinate(t,i=this._centerAltitude){return this.projection.pointCoordinate(this,t.x,t.y,i)}pointCoordinate3D(t){if(!this.elevation)return this.pointCoordinate(t);let i=this.projection.pointCoordinate3D(this,t.x,t.y);if(i)return new ui(i[0],i[1],i[2]);let n=0,r=this.horizonLineFromTop();if(t.y>r)return this.pointCoordinate(t);const o=.02*r,s=t.clone();for(let a=0;a<10&&r-n>o;a++){s.y=ze(n,r,.66);const l=this.projection.pointCoordinate3D(this,s.x,s.y);l?(r=s.y,i=l):n=s.y}return i?new ui(i[0],i[1],i[2]):this.pointCoordinate(t)}isPointAboveHorizon(t){return this.projection.isPointAboveHorizon(this,t)}isPointOnSurface(t){if(t.y<0||t.y>this.height||t.x<0||t.x>this.width)return!1;if(this.elevation||this.zoom>=Vs)return!this.isPointAboveHorizon(t);const i=this.pointCoordinate(t);return i.y>=0&&i.y<=1}_coordinatePoint(t,i){const n=i&&this.elevation?this.elevation.getAtPointOrZero(t,this._centerAltitude):this._centerAltitude,r=[t.x*this.worldSize,t.y*this.worldSize,n+t.toAltitude(),1];return Ni.transformMat4(r,r,this.pixelMatrix),r[3]>0?new G(r[0]/r[3],r[1]/r[3]):new G(Number.MAX_VALUE,Number.MAX_VALUE)}_getBoundsNonRectangular(){const{top:t,left:i}=this._edgeInsets,n=this.height-this._edgeInsets.bottom,r=this.width-this._edgeInsets.right,o=this.pointLocation3D(new G(i,t)),s=this.pointLocation3D(new G(r,t)),a=this.pointLocation3D(new G(r,n)),l=this.pointLocation3D(new G(i,n));let c=Math.min(o.lng,s.lng,a.lng,l.lng),u=Math.max(o.lng,s.lng,a.lng,l.lng),h=Math.min(o.lat,s.lat,a.lat,l.lat),d=Math.max(o.lat,s.lat,a.lat,l.lat);const p=Math.pow(2,-this.zoom)/16*270,_=this.projection.name==="globe"?1:4,g=(y,x,b,M,E)=>{const T=(y+b)/2,S=(x+M)/2,D=new G(T,S),{lng:z,lat:L}=this.pointLocation3D(D),R=Math.max(0,c-z,h-L,z-u,L-d);c=Math.min(c,z),u=Math.max(u,z),h=Math.min(h,L),d=Math.max(d,L),(E<_||R>p)&&(g(y,x,T,S,E+1),g(T,S,b,M,E+1))};if(g(i,t,r,t,1),g(r,t,r,n,1),g(r,n,i,n,1),g(i,n,i,t,1),this.projection.name==="globe"){const[y,x]=function(b){const M=st.identity(new Float64Array(16));st.multiply(M,b.pixelMatrix,b.globeMatrix);const E=[0,Kr,0],T=[0,Jr,0];return Z.transformMat4(E,E,M),Z.transformMat4(T,T,M),[E[0]>0&&E[0]<=b.width&&E[1]>0&&E[1]<=b.height&&!mh(b,new Le(b.center.lat,90)),T[0]>0&&T[0]<=b.width&&T[1]>0&&T[1]<=b.height&&!mh(b,new Le(b.center.lat,-90))]}(this);y?(d=90,u=180,c=-180):x&&(h=-90,u=180,c=-180)}return new Er(new Le(c,h),new Le(u,d))}_getBoundsRectangular(t,i){const{top:n,left:r}=this._edgeInsets,o=this.height-this._edgeInsets.bottom,s=this.width-this._edgeInsets.right,a=new G(r,n),l=new G(s,n),c=new G(s,o),u=new G(r,o);let h=this.pointCoordinate(a,t),d=this.pointCoordinate(l,t);const p=this.pointCoordinate(c,i),_=this.pointCoordinate(u,i),g=(y,x)=>(x.y-y.y)/(x.x-y.x);return h.y>1&&d.y>=0?h=new ui((1-_.y)/g(_,h)+_.x,1):h.y<0&&d.y<=1&&(h=new ui(-_.y/g(_,h)+_.x,0)),d.y>1&&h.y>=0?d=new ui((1-p.y)/g(p,d)+p.x,1):d.y<0&&h.y<=1&&(d=new ui(-p.y/g(p,d)+p.x,0)),new Er().extend(this.coordinateLocation(h)).extend(this.coordinateLocation(d)).extend(this.coordinateLocation(_)).extend(this.coordinateLocation(p))}_getBoundsRectangularTerrain(){const t=this.elevation;if(!t.visibleDemTiles.length||t.isUsingMockSource())return this._getBoundsRectangular(0,0);const i=t.visibleDemTiles.reduce((n,r)=>{if(r.dem){const o=r.dem.tree;n.min=Math.min(n.min,o.minimums[0]),n.max=Math.max(n.max,o.maximums[0])}return n},{min:Number.MAX_VALUE,max:0});return this._getBoundsRectangular(i.min*t.exaggeration(),i.max*t.exaggeration())}getBounds(){return this.projection.name==="mercator"||this.projection.name==="equirectangular"?this._terrainEnabled()?this._getBoundsRectangularTerrain():this._getBoundsRectangular(0,0):this._getBoundsNonRectangular()}horizonLineFromTop(t=!0){const i=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))-this.centerOffset.y,n=this.height/2-i*(1-this._horizonShift);return t?Math.max(0,n):n}getMaxBounds(){return this.maxBounds}setMaxBounds(t){this.maxBounds=t,this.minLat=-Sn,this.maxLat=Sn,this.minLng=-180,this.maxLng=180,t&&(this.minLat=t.getSouth(),this.maxLat=t.getNorth(),this.minLng=t.getWest(),this.maxLng=t.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=Fn(this.minLng)*this.tileSize,this.worldMaxX=Fn(this.maxLng)*this.tileSize,this.worldMinY=jn(this.maxLat)*this.tileSize,this.worldMaxY=jn(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(t,i){return this.projection.createTileMatrix(this,i,t)}calculateDistanceTileData(t){const i=t.key,n=this._distanceTileDataCache;if(n[i])return n[i];const r=t.canonical,o=1/this.height,s=this.cameraWorldSize,a=s/this.zoomScale(r.z),l=(r.x+Math.pow(2,r.z)*t.wrap)*a,c=r.y*a,u=this.point;u.x*=s/this.worldSize,u.y*=s/this.worldSize;const h=this.angle,d=Math.sin(-h),p=-Math.cos(-h);return n[i]={bearing:[d,p],center:[(u.x-l)*o,(u.y-c)*o],scale:a/pt*o},n[i]}calculateFogTileMatrix(t){const i=t.key,n=this._fogTileMatrixCache;if(n[i])return n[i];const r=this.projection.createTileMatrix(this,this.cameraWorldSizeForFog,t);return st.multiply(r,this.worldToFogMatrix,r),n[i]=new Float32Array(r),n[i]}calculateProjMatrix(t,i=!1,n=!1){const r=t.key;let o;if(o=n?this._expandedProjMatrixCache:i?this._alignedProjMatrixCache:this._projMatrixCache,o[r])return o[r];const s=this.calculatePosMatrix(t,this.worldSize);let a;return a=this.projection.isReprojectedInTileSpace?this.mercatorMatrix:n?this.expandedFarZProjMatrix:i?this.alignedProjMatrix:this.projMatrix,st.multiply(s,a,s),o[r]=new Float32Array(s),o[r]}calculatePixelsToTileUnitsMatrix(t){const i=t.tileID.key,n=this._pixelsToTileUnitsCache;if(n[i])return n[i];const r=function(o,s){const{scale:a}=o.tileTransform,l=a*pt/(o.tileSize*Math.pow(2,s.zoom-o.tileID.overscaledZ+o.tileID.canonical.z));return vl.scale(new Float32Array(4),s.inverseAdjustmentMatrix,[l,l])}(t,this);return n[i]=r,n[i]}customLayerMatrix(){return this.mercatorMatrix.slice()}globeToMercatorMatrix(){if(this.projection.name==="globe"){const t=1/this.worldSize,i=st.fromScaling([],[t,t,t]);return st.multiply(i,i,this.globeMatrix),i}}recenterOnTerrain(){if(!this._elevation||this.projection.name==="globe")return;const t=this._elevation;this._updateCameraState();const i=Gi(1,this._center.lat)*this.worldSize,n=this._computeCameraPosition(i),r=this._camera.forward(),o=Gi(1,this._center.lat);n[2]/=o,r[2]/=o,Z.normalize(r,r);const s=t.raycast(n,r,t.exaggeration());if(s){const a=Z.scaleAndAdd([],n,r,s),l=new ui(a[0],a[1],Gi(a[2],On(a[1]))),c=(l.z+Z.length([l.x-n[0],l.y-n[1],l.z-n[2]*o]))*this._pixelsPerMercatorPixel;this._seaLevelZoom=this._zoomFromMercatorZ(c),this._centerAltitude=l.toAltitude(),this._center=this.coordinateLocation(l),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCamera(t=!1){if(!this._elevation)return;const i=this._elevation,n=Gi(1,this._center.lat)*this.worldSize,r=this._computeCameraPosition(n),o=i.getAtPointOrZero(new ui(...r)),s=this.pixelsPerMeter/this.worldSize*o,a=this._minimumHeightOverTerrain(),l=r[2]-s;if(l<=a)if(l<0||t){const c=this.locationCoordinate(this._center,this._centerAltitude),u=[r[0],r[1],c.z-r[2]],h=Z.length(u);u[2]-=(a-l)/this._pixelsPerMercatorPixel;const d=Z.length(u);if(d===0)return;Z.scale(u,u,h/d*this._pixelsPerMercatorPixel),this._camera.position=[r[0],r[1],c.z*this._pixelsPerMercatorPixel-u[2]],this._updateStateFromCamera()}else this._isCameraConstrained=!0}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;const t=this.projection.name==="globe"||this.mercatorFromTransition;if(this.projection.isReprojectedInTileSpace||t){const d=this.center;return d.lat=Lt(d.lat,this.minLat,this.maxLat),(this.maxBounds||!this.renderWorldCopies&&!t)&&(d.lng=Lt(d.lng,this.minLng,this.maxLng)),this.center=d,void(this._constraining=!1)}const i=this._unmodified,{x:n,y:r}=this.point;let o=0,s=n,a=r;const l=this.width/2,c=this.height/2,u=this.worldMinY*this.scale,h=this.worldMaxY*this.scale;if(r-c<u&&(a=u+c),r+c>h&&(a=h-c),h-u<this.height&&(o=Math.max(o,this.height/(h-u)),a=(h+u)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){const d=this.worldMinX*this.scale,p=this.worldMaxX*this.scale,_=this.worldSize/2-(d+p)/2;s=(n+_+this.worldSize)%this.worldSize-_,s-l<d&&(s=d+l),s+l>p&&(s=p-l),p-d<this.width&&(o=Math.max(o,this.width/(p-d)),s=(p+d)/2)}s===n&&a===r||(this.center=this.unproject(new G(s,a))),o&&(this.zoom+=this.scaleZoom(o)),this._constrainCamera(),this._unmodified=i,this._constraining=!1}_minZoomForBounds(){let t=Math.max(0,this.scaleZoom(this.height/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(t=Math.max(t,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),t}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){if(!this.height)return;const t=this.centerOffset,i=this.projection.name==="globe",n=this.pixelsPerMeter;this.projection.name==="globe"&&(this._mercatorScaleRatio=Gi(1,this.center.lat)/Gi(1,45));const r=tu(this.projection,this.zoom,this.width,this.height,1024);this._pixelsPerMercatorPixel=this.projection.pixelSpaceConversion(this.center.lat,this.worldSize,r),this.cameraToCenterDistance=.5/Math.tan(.5*this._fov)*this.height*this._pixelsPerMercatorPixel,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;const o=this.projection.zAxisUnit==="meters"?n:1,s=this._camera.getWorldToCamera(this.worldSize,o);let a;const l=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);if(l[8]=2*-t.x/this.width,l[9]=2*t.y/this.height,this.isOrthographic){let L=.5*this.height/Math.tan(this._fov/2)*1*Math.tan(.5*this._fov),R=L*this.aspect,N=-R,U=-L;R-=t.x,N-=t.x,L+=t.y,U+=t.y,a=this._camera.getCameraToClipOrthographic(N,R,U,L,this._nearZ,this._farZ),((H,O,X,K)=>{for(let ot=0;ot<16;ot++)H[ot]=Tx(O[ot],X[ot],K)})(a,a,l,Mx(this.pitch>=15?1:this.pitch/15))}else a=l;const c=st.mul([],l,s);let u=st.mul([],a,s);if(this.projection.isReprojectedInTileSpace){const L=this.locationCoordinate(this.center),R=st.identity([]);st.translate(R,R,[L.x*this.worldSize,L.y*this.worldSize,0]),st.multiply(R,R,ux(this)),st.translate(R,R,[-L.x*this.worldSize,-L.y*this.worldSize,0]),st.multiply(u,u,R),st.multiply(c,c,R),this.inverseAdjustmentMatrix=function(N){const U=ux(N,!0);return vl.invert([],[U[0],U[1],U[4],U[5]])}(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];if(this.mercatorMatrix=st.scale([],u,[this.worldSize,this.worldSize,this.worldSize/o,1]),this.projMatrix=u,this.invProjMatrix=st.invert(new Float64Array(16),this.projMatrix),i){const L=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,1/0);L[8]=2*-t.x/this.width,L[9]=2*t.y/this.height,this.expandedFarZProjMatrix=st.mul([],L,s)}else this.expandedFarZProjMatrix=this.projMatrix;const h=st.invert([],a);this.frustumCorners=Jp.fromInvProjectionMatrix(h,this.horizonLineFromTop(),this.height),this.cameraFrustum=cs.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,0,!i);const d=new Float32Array(16);st.identity(d),st.scale(d,d,[1,-1,1]),st.rotateX(d,d,this._pitch),st.rotateZ(d,d,this.angle);const p=st.perspective(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ);this.starsProjMatrix=st.clone(p);const _=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;p[8]=2*-t.x/this.width,p[9]=2*(t.y+_)/this.height,this.skyboxMatrix=st.multiply(d,p,d);const g=this.point,y=g.x,x=g.y,b=this.width%2/2,M=this.height%2/2,E=Math.cos(this.angle),T=Math.sin(this.angle),S=y-Math.round(y)+E*b+T*M,D=x-Math.round(x)+E*M+T*b,z=new Float64Array(u);if(st.translate(z,z,[S>.5?S-1:S,D>.5?D-1:D,0]),this.alignedProjMatrix=z,u=st.create(),st.scale(u,u,[this.width/2,-this.height/2,1]),st.translate(u,u,[1,-1,0]),this.labelPlaneMatrix=u,u=st.create(),st.scale(u,u,[1,-1,1]),st.translate(u,u,[-1,-1,0]),st.scale(u,u,[2/this.width,2/this.height,1]),this.glCoordMatrix=u,this.pixelMatrix=st.multiply(new Float64Array(16),this.labelPlaneMatrix,c),this._calcFogMatrices(),this._distanceTileDataCache={},u=st.invert(new Float64Array(16),this.pixelMatrix),!u)throw new Error("failed to invert matrix");if(this.pixelMatrixInverse=u,this.projection.name==="globe"||this.mercatorFromTransition){this.globeMatrix=function(R){const{x:N,y:U}=R.point,{lng:H,lat:O}=R._center;return k1(N,U,R.worldSize,H,O)}(this);const L=[this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]];this.globeCenterInViewSpace=Z.transformMat4(L,L,s),this.globeRadius=this.worldSize/2/Math.PI-1}else this.globeMatrix=u;this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={},this._expandedProjMatrixCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};const t=this.cameraWorldSizeForFog,i=this.cameraPixelsPerMeter,n=this._camera.position,r=1/this.height/this._pixelsPerMercatorPixel,o=[t,t,i];Z.scale(o,o,r),Z.scale(n,n,-1),Z.multiply(n,n,o);const s=st.create();st.translate(s,s,n),st.scale(s,s,o),this.mercatorFogMatrix=s,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(t,i,r)}_computeCameraPosition(t){const i=(t=t||this.pixelsPerMeter)/this.pixelsPerMeter,n=this._camera.forward(),r=this.point,o=this._mercatorZfromZoom(this._seaLevelZoom?this._seaLevelZoom:this._zoom)*i-t/this.worldSize*this._centerAltitude;return[r.x/this.worldSize-n[0]*o,r.y/this.worldSize-n[1]*o,t/this.worldSize*this._centerAltitude-n[2]*o]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(t){const i=this._maxCameraBoundsDistance()*Math.cos(this._pitch),n=this._camera.position[2],r=t[2];let o=1;this.projection.wrap&&(this.center=this.center.wrap()),r>0&&(o=Math.min((i-n)/r,1)),this._camera.position=Z.scaleAndAdd([],this._camera.position,t,o),this._updateStateFromCamera()}_updateStateFromCamera(){const t=this._camera.position,i=this._camera.forward(),{pitch:n,bearing:r}=this._camera.getPitchBearing(),o=Gi(this._centerAltitude,this.center.lat)*this._pixelsPerMercatorPixel,s=this._mercatorZfromZoom(this._maxZoom)*Math.cos(wt(this._maxPitch)),a=Math.max((t[2]-o)/Math.cos(n),s),l=this._zoomFromMercatorZ(a);Z.scaleAndAdd(t,t,i,a),this._pitch=Lt(n,wt(this.minPitch),wt(this.maxPitch)),this.angle=Me(r,-Math.PI,Math.PI),this._setZoom(Lt(l,this._minZoom,this._maxZoom)),this._updateSeaLevelZoom(),this._center=this.coordinateLocation(new ui(t[0],t[1],t[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(t){return Math.pow(2,t)*this.tileSize}_mercatorZfromZoom(t){return this.cameraToCenterDistance/this._worldSizeFromZoom(t)}_minimumHeightOverTerrain(){const t=Math.min((this._seaLevelZoom!=null?this._seaLevelZoom:this._zoom)+4,this._maxZoom);return this._mercatorZfromZoom(t)}_zoomFromMercatorZ(t){return this.scaleZoom(this.cameraToCenterDistance/(t*this.tileSize))}zoomFromMercatorZAdjusted(t){let i=0,n=Vs,r=0,o=1/0;for(;n-i>1e-6&&n>i;){const s=i+.5*(n-i),a=this.tileSize*Math.pow(2,s),l=this.getCameraToCenterDistance(this.projection,s,a),c=this.scaleZoom(l/(t*this.tileSize)),u=Math.abs(s-c);u<o&&(o=u,r=s),s<c?i=s:n=s}return r}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(J("Terrain is not yet supported with alternate projections. Use mercator or globe to enable terrain."),1))}anyCornerOffEdge(t,i){const n=Math.min(t.x,i.x),r=Math.max(t.x,i.x),o=Math.min(t.y,i.y),s=Math.max(t.y,i.y);if(o<this.horizonLineFromTop(!1))return!0;if(this.projection.name!=="mercator")return!1;const a=[new G(n,o),new G(r,s),new G(n,s),new G(r,o)],l=this.renderWorldCopies?-3:0,c=this.renderWorldCopies?4:1;for(const u of a){const h=this.pointRayIntersection(u);if(h.t<0)return!0;const d=this.rayIntersectionCoordinate(h);if(d.x<l||d.y<0||d.x>c||d.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+ne(this.fovAboveCenter)>88||this.anyCornerOffEdge(new G(0,0),new G(this.width,this.height))}zoomDeltaToMovement(t,i){const n=Z.length(Z.sub([],this._camera.position,t)),r=this._zoomFromMercatorZ(n)+i;return n-this._mercatorZfromZoom(r)}getCameraPoint(){if(this.projection.name==="globe"){const t=function([i,n,r],o){const s=[i,n,r,1];Ni.transformMat4(s,s,o);const a=s[3]=Math.max(s[3],1e-6);return s[0]/=a,s[1]/=a,s[2]/=a,s}([this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]],this.pixelMatrix);return new G(t[0],t[1])}{const t=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new G(0,t))}}getCameraToCenterDistance(t,i=this.zoom,n=this.worldSize){const r=tu(t,i,this.width,this.height,1024),o=t.pixelSpaceConversion(this.center.lat,n,r);let s=.5/Math.tan(.5*this._fov)*this.height*o;return this.isOrthographic&&(s=Tx(1,s,Mx(this.pitch>=15?1:this.pitch/15))),s}getWorldToCameraMatrix(){const t=this._camera.getWorldToCamera(this.worldSize,this.projection.zAxisUnit==="meters"?this.pixelsPerMeter:1);return this.projection.name==="globe"&&st.multiply(t,t,this.globeMatrix),t}getFrustum(t){return cs.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,t,this.projection.zAxisUnit==="meters")}}function Ex(e,t,i){st.identity(e),st.rotateZ(e,e,wt(t[2])),st.rotateX(e,e,wt(t[0])),st.rotateY(e,e,wt(t[1])),st.scale(e,e,i),st.multiply(e,e,[1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1])}function id(e,t,i,n,r,o,s,a){const l=[i[0]-t[0],i[1]-t[1],0],c=[n[0]-t[0],n[1]-t[1],0];if(Z.length(l)<1e-12||Z.length(c)<1e-12)return nr.identity(e);const u=Z.cross([],l,c);Z.normalize(u,u),Z.subtract(c,n,t),l[2]=(o-r)*a,c[2]=(s-r)*a;const h=l;return Z.cross(h,l,c),Z.normalize(h,h),nr.rotationTo(e,u,h)}function Sx(e,t,i=!1){const n=Wn(t.zoom),r=function(o,s,a){const l=s.worldSize,c=[o[12],o[13],o[14]],u=On(c[1]/l),h=Sr(c[0]/l),d=st.identity([]),p=Gi(1,u)*l,_=Gi(1,0)*l*qs(u,s.zoom),g=1/rm(l);let y=_*g;if(a){const E=tu(s.projection,s.zoom,s.width,s.height,1024);y=g*s.projection.pixelSpaceConversion(s.center.lat,l,E)}const x=gr(u,h);Z.add(x,x,Z.scale([],Z.normalize([],x),p*y*c[2]));const b=function(E){const T=[E[0],E[1],E[2]];let S=[0,1,0];const D=Z.cross([],S,T);return Z.cross(S,T,D),Z.squaredLength(S)===0&&(S=[0,1,0],Z.cross(D,T,S)),Z.normalize(D,D),Z.normalize(S,S),Z.normalize(T,T),[D[0],D[1],D[2],0,S[0],S[1],S[2],0,T[0],T[1],T[2],0,E[0],E[1],E[2],1]}(x);st.scale(d,d,[y,y,y*p]),st.translate(d,d,[-c[0],-c[1],-c[2]]);const M=st.multiply([],s.globeMatrix,b);return st.multiply(M,M,d),st.multiply(M,M,o),M}(e,t,i);if(n>0){const o=function(s,a){const l=a.worldSize,c=Gi(1,0)*l*qs(a.center.lat,a.zoom)/rm(l),u=Gi(1,a.center.lat)*l,h=st.identity([]);return st.rotateY(h,h,wt(a.center.lng)),st.rotateX(h,h,wt(a.center.lat)),st.translate(h,h,[0,0,dr]),st.scale(h,h,[c,c,c*u]),st.translate(h,h,[a.point.x-.5*l,a.point.y-.5*l,0]),st.multiply(h,h,s),st.multiply(h,a.globeMatrix,h)}(e,t);return function(s,a,l){const c=(_,g,y)=>{const x=Z.length(_),b=Z.length(g),M=us(_,g,y);return Z.scale(M,M,1/Z.length(M)*ze(x,b,y))},u=c([s[0],s[1],s[2]],[a[0],a[1],a[2]],l),h=c([s[4],s[5],s[6]],[a[4],a[5],a[6]],l),d=c([s[8],s[9],s[10]],[a[8],a[9],a[10]],l),p=us([s[12],s[13],s[14]],[a[12],a[13],a[14]],l);return[u[0],u[1],u[2],0,h[0],h[1],h[2],0,d[0],d[1],d[2],0,p[0],p[1],p[2],1]}(r,o,n)}return r}const La=64,O3=[1,1,1];class Ax{constructor(t,i,n,r){this.id=t,this.position=i!=null?new Le(i[0],i[1]):new Le(0,0),this.orientation=n??[0,0,0],this.nodes=r,this.uploaded=!1,this.aabb=new en([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),this.matrix=[]}_applyTransformations(t,i){if(st.multiply(t.matrix,i,t.matrix),t.meshes)for(const n of t.meshes){const r=en.applyTransform(n.aabb,t.matrix);this.aabb.encapsulate(r)}if(t.children)for(const n of t.children)this._applyTransformations(n,t.matrix)}computeBoundsAndApplyParent(){const t=st.identity([]);for(const i of this.nodes)this._applyTransformations(i,t)}_positionModelOnTerrain(t,i){const n=t.elevation;if(!n)return 0;const r=en.projectAabbCorners(this.aabb,this.matrix),o=Gi(1,this.position.lat)*t.worldSize,s=function(x,b){const M=[0,0,1],E=[{corners:[0,1,3,2],dotProductWithUp:0},{corners:[1,5,2,6],dotProductWithUp:0},{corners:[0,4,1,5],dotProductWithUp:0},{corners:[2,6,3,7],dotProductWithUp:0},{corners:[4,7,5,6],dotProductWithUp:0},{corners:[0,3,4,7],dotProductWithUp:0}];for(const T of E){const S=x[T.corners[0]],D=x[T.corners[1]],z=x[T.corners[2]],L=[D[0]-S[0],D[1]-S[1],b*(D[2]-S[2])],R=Z.cross(L,L,[z[0]-S[0],z[1]-S[1],b*(z[2]-S[2])]);Z.normalize(R,R),T.dotProductWithUp=Z.dot(R,M)}return E.sort((T,S)=>T.dotProductWithUp-S.dotProductWithUp),E[0].corners}(r,o),a=r[s[0]],l=r[s[1]],c=r[s[2]],u=r[s[3]],h=n.getAtPointOrZero(new ui(a[0]/t.worldSize,a[1]/t.worldSize),0),d=n.getAtPointOrZero(new ui(l[0]/t.worldSize,l[1]/t.worldSize),0),p=n.getAtPointOrZero(new ui(c[0]/t.worldSize,c[1]/t.worldSize),0),_=n.getAtPointOrZero(new ui(u[0]/t.worldSize,u[1]/t.worldSize),0),g=(h+_)/2,y=(d+p)/2;return g>y?d<p?id(i,l,u,a,d,_,h,o):id(i,c,a,u,p,h,_,o):h<_?id(i,a,l,c,h,d,p,o):id(i,u,c,l,_,p,d,o),Math.max(g,y)}computeModelMatrix(t,i,n,r,o,s,a=!1){const l=t.transform,c=l.zoom,u=l.project(this.position),h=qs(this.position.lat,c),d=1/h;st.identity(this.matrix),st.translate(this.matrix,this.matrix,[u.x+r[0]*d,u.y+r[1]*d,r[2]]);let p=1,_=1;const g=l.worldSize;if(a){if(l.projection.name==="mercator"){let M=0;l.elevation&&(M=l.elevation.getAtPointOrZero(new ui(u.x/g,u.y/g),0));const E=Ni.transformMat4([],[u.x,u.y,M,1],l.projMatrix)[3]/l.cameraToCenterDistance;p=E,_=E*qs(l.center.lat,c)}else if(l.projection.name==="globe"){const M=Sx(this.matrix,l),E=st.multiply([],l.projMatrix,M),T=[0,0,0,1];Ni.transformMat4(T,T,E);const S=T[3]/l.cameraToCenterDistance,D=Wn(c),z=l.projection.pixelsPerMeter(this.position.lat,g)*qs(this.position.lat,c),L=l.projection.pixelsPerMeter(l.center.lat,g)*qs(l.center.lat,c);p=S/ze(z,V1(l.center.lat),D),_=S*h/z,p*=L,_*=L}}else p=d;st.scale(this.matrix,this.matrix,[p,p,_]);const y=[...this.matrix],x=this.orientation,b=[];if(Ex(b,[x[0]+i[0],x[1]+i[1],x[2]+i[2]],n),st.multiply(this.matrix,y,b),o&&l.elevation){let M=0;const E=[];if(s&&l.elevation){M=this._positionModelOnTerrain(l,E);const T=st.fromQuat([],E),S=st.multiply([],T,b);st.multiply(this.matrix,y,S)}else M=l.elevation.getAtPointOrZero(new ui(u.x/g,u.y/g),0);M!==0&&(this.matrix[14]+=M)}}upload(t){if(!this.uploaded){for(const i of this.nodes)Hm(i,t);for(const i of this.nodes)nd(i);this.uploaded=!0}}destroy(){for(const t of this.nodes)rd(t)}}function eu(e,t,i=!1){e.uploaded||(e.gfxTexture=new mn(t,e.image,i?t.gl.R8:t.gl.RGBA,{useMipmap:e.sampler.minFilter>=t.gl.NEAREST_MIPMAP_NEAREST}),e.uploaded=!0,e.image=null)}function B3(e,t,i){e.indexBuffer=t.createIndexBuffer(e.indexArray,!1,!0),e.vertexBuffer=t.createVertexBuffer(e.vertexArray,S3.members,!1,!0),e.normalArray&&(e.normalBuffer=t.createVertexBuffer(e.normalArray,D3.members,!1,!0)),e.texcoordArray&&(e.texcoordBuffer=t.createVertexBuffer(e.texcoordArray,C3.members,!1,!0)),e.colorArray&&(e.colorBuffer=t.createVertexBuffer(e.colorArray,(e.colorArray.bytesPerElement===12?A3:I3).members,!1,!0)),e.featureArray&&(e.pbrBuffer=t.createVertexBuffer(e.featureArray,k3.members,!0)),e.segments=Fi.simpleSegment(0,0,e.vertexArray.length,e.indexArray.length);const n=e.material;n.pbrMetallicRoughness.baseColorTexture&&eu(n.pbrMetallicRoughness.baseColorTexture,t),n.pbrMetallicRoughness.metallicRoughnessTexture&&eu(n.pbrMetallicRoughness.metallicRoughnessTexture,t),n.normalTexture&&eu(n.normalTexture,t),n.occlusionTexture&&eu(n.occlusionTexture,t,i),n.emissionTexture&&eu(n.emissionTexture,t)}function Hm(e,t,i){if(e.meshes)for(const n of e.meshes)B3(n,t,i);if(e.children)for(const n of e.children)Hm(n,t,i)}function nd(e){if(e.meshes)for(const t of e.meshes)t.indexArray.destroy(),t.vertexArray.destroy(),t.colorArray&&t.colorArray.destroy(),t.normalArray&&t.normalArray.destroy(),t.texcoordArray&&t.texcoordArray.destroy(),t.featureArray&&t.featureArray.destroy();if(e.children)for(const t of e.children)nd(t)}function rd(e){if(e.meshes)for(const i of e.meshes)i.vertexBuffer&&(i.vertexBuffer.destroy(),i.indexBuffer.destroy(),i.normalBuffer&&i.normalBuffer.destroy(),i.texcoordBuffer&&i.texcoordBuffer.destroy(),i.colorBuffer&&i.colorBuffer.destroy(),i.pbrBuffer&&i.pbrBuffer.destroy(),i.segments.destroy(),i.material&&((t=i.material).pbrMetallicRoughness.baseColorTexture&&t.pbrMetallicRoughness.baseColorTexture.gfxTexture&&t.pbrMetallicRoughness.baseColorTexture.gfxTexture.destroy(),t.pbrMetallicRoughness.metallicRoughnessTexture&&t.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture&&t.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture.destroy(),t.normalTexture&&t.normalTexture.gfxTexture&&t.normalTexture.gfxTexture.destroy(),t.emissionTexture&&t.emissionTexture.gfxTexture&&t.emissionTexture.gfxTexture.destroy(),t.occlusionTexture&&t.occlusionTexture.gfxTexture&&t.occlusionTexture.gfxTexture.destroy()));var t;if(e.children)for(const i of e.children)rd(i)}class Ix{constructor(t,i){this.feature=t,this.instancedDataOffset=i,this.instancedDataCount=0,this.rotation=[0,0,0],this.scale=[1,1,1],this.translation=[0,0,0]}}class Cx{constructor(){this.instancedDataArray=new Ip,this.instancesEvaluatedElevation=[],this.features=[],this.idToFeaturesIndex={}}}class Dx{constructor(t){this.zoom=t.zoom,this.canonical=t.canonical,this.layers=t.layers,this.layerIds=this.layers.map(i=>i.fqid),this.projection=t.projection,this.index=t.index,this.hasZoomDependentProperties=this.layers[0].isZoomDependent(),this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.hasPattern=!1,this.instancesPerModel={},this.validForExaggeration=0,this.maxVerticalOffset=0,this.maxScale=0,this.maxHeight=0,this.lookupDim=this.zoom>this.canonical.z?256:this.zoom>15?75:100,this.instanceCount=0,this.terrainElevationMin=0,this.terrainElevationMax=0,this.validForDEMTile={id:null,timestamp:0}}populate(t,i,n,r){this.tileToMeter=Fc(n);const o=this.layers[0]._featureFilter.needGeometry;this.lookup=new Uint8Array(this.lookupDim*this.lookupDim);for(const{feature:s,id:a,index:l,sourceLayerIndex:c}of t){const u=Zs(s,o);if(!this.layers[0]._featureFilter.filter(new dn(this.zoom),u,n))continue;const h={id:a,sourceLayerIndex:c,index:l,geometry:o?u.geometry:Po(s,n,r),properties:s.properties,type:s.type,patterns:{}},d=this.addFeature(h,h.geometry,u);d&&i.featureIndex.insert(s,h.geometry,l,c,this.index,this.instancesPerModel[d].instancedDataArray.length)}this.lookup=null}update(t,i,n,r){for(const o in this.instancesPerModel){const s=this.instancesPerModel[o];for(const a in t)s.idToFeaturesIndex.hasOwnProperty(a)&&this.evaluate(s.features[s.idToFeaturesIndex[a]],t[a],s,!0)}this.maxHeight=0}updateZoomBasedPaintProperties(){if(!this.hasZoomDependentProperties)return!1;let t=!1;for(const i in this.instancesPerModel){const n=this.instancesPerModel[i];for(const r of n.features){const o=this.layers[0],s=r.feature,a=this.canonical,l=o.paint.get("model-rotation").evaluate(s,{},a),c=o.paint.get("model-scale").evaluate(s,{},a),u=o.paint.get("model-translation").evaluate(s,{},a);Z.exactEquals(r.rotation,l)&&Z.exactEquals(r.scale,c)&&Z.exactEquals(r.translation,u)||(this.evaluate(r,r.featureStates,n,!0),t=!0)}}return t}isEmpty(){for(const t in this.instancesPerModel)if(this.instancesPerModel[t].instancedDataArray.length!==0)return!1;return!0}uploadPending(){return!this.uploaded}upload(t){if(!this.uploaded)for(const i in this.instancesPerModel){const n=this.instancesPerModel[i];n.instancedDataArray.length<0||n.instancedDataArray.length===0||(n.instancedDataBuffer?n.instancedDataBuffer.updateData(n.instancedDataArray):n.instancedDataBuffer=t.createVertexBuffer(n.instancedDataArray,P3.members,!0,void 0,this.instanceCount))}this.uploaded=!0}destroy(){for(const t in this.instancesPerModel){const i=this.instancesPerModel[t];i.instancedDataArray.length!==0&&i.instancedDataBuffer&&i.instancedDataBuffer.destroy()}}addFeature(t,i,n){const r=this.layers[0],o=r.layout.get("model-id").evaluate(n,{},this.canonical);if(!o)return J(`modelId is not evaluated for layer ${r.id} and it is not going to get rendered.`),o;this.instancesPerModel[o]||(this.instancesPerModel[o]=new Cx);const s=this.instancesPerModel[o],a=s.instancedDataArray,l=new Ix(n,a.length);for(const c of i)for(const u of c){if(u.x<0||u.x>=pt||u.y<0||u.y>=pt)continue;const h=(this.lookupDim-1)/pt,d=this.lookupDim*(u.y*h|0)+u.x*h|0;if(this.lookup){if(this.lookup[d]!==0)continue;this.lookup[d]=1}this.instanceCount++;const p=a.length;a.resize(p+1),s.instancesEvaluatedElevation.push(0),a.float32[16*p]=u.x,a.float32[16*p+1]=u.y}return l.instancedDataCount=s.instancedDataArray.length-l.instancedDataOffset,l.instancedDataCount>0&&(t.id&&(s.idToFeaturesIndex[t.id]=s.features.length),s.features.push(l),this.evaluate(l,{},s,!1)),o}evaluate(t,i,n,r){const o=this.layers[0],s=t.feature,a=this.canonical,l=t.rotation=o.paint.get("model-rotation").evaluate(s,i,a),c=t.scale=o.paint.get("model-scale").evaluate(s,i,a),u=t.translation=o.paint.get("model-translation").evaluate(s,i,a),h=o.paint.get("model-color").evaluate(s,i,a);h.a=o.paint.get("model-color-mix-intensity").evaluate(s,i,a);const d=[];this.maxVerticalOffset<u[2]&&(this.maxVerticalOffset=u[2]),this.maxScale=Math.max(Math.max(this.maxScale,c[0]),Math.max(c[1],c[2])),Ex(d,l,c);const p=Math.round(100*h.a)+h.b/1.05;for(let _=0;_<t.instancedDataCount;++_){const g=t.instancedDataOffset+_,y=16*g,x=n.instancedDataArray.float32;let b=0;r&&(b=x[y+6]-n.instancesEvaluatedElevation[g]);const M=0|x[y+1];x[y]=(0|x[y])+h.r/1.05,x[y+1]=M+h.g/1.05,x[y+2]=p,x[y+3]=1/(a.z>10?this.tileToMeter:Fc(a,M)),x[y+4]=u[0],x[y+5]=u[1],x[y+6]=u[2]+b,x[y+7]=d[0],x[y+8]=d[1],x[y+9]=d[2],x[y+10]=d[4],x[y+11]=d[5],x[y+12]=d[6],x[y+13]=d[8],x[y+14]=d[9],x[y+15]=d[10],n.instancesEvaluatedElevation[g]=u[2]}}}he(Dx,"ModelBucket",{omit:["layers"]}),he(Cx,"PerModelAttributes"),he(Ix,"ModelFeature");const F3=new wn({visibility:new Gt(rt.layout_model.visibility),"model-id":new ve(rt.layout_model["model-id"])});var N3={paint:new wn({"model-opacity":new Gt(rt.paint_model["model-opacity"]),"model-rotation":new ve(rt.paint_model["model-rotation"]),"model-scale":new ve(rt.paint_model["model-scale"]),"model-translation":new ve(rt.paint_model["model-translation"]),"model-color":new ve(rt.paint_model["model-color"]),"model-color-mix-intensity":new ve(rt.paint_model["model-color-mix-intensity"]),"model-type":new Gt(rt.paint_model["model-type"]),"model-cast-shadows":new Gt(rt.paint_model["model-cast-shadows"]),"model-receive-shadows":new Gt(rt.paint_model["model-receive-shadows"]),"model-ambient-occlusion-intensity":new Gt(rt.paint_model["model-ambient-occlusion-intensity"]),"model-emissive-strength":new ve(rt.paint_model["model-emissive-strength"]),"model-roughness":new ve(rt.paint_model["model-roughness"]),"model-height-based-emissive-strength-multiplier":new ve(rt.paint_model["model-height-based-emissive-strength-multiplier"]),"model-cutoff-fade-range":new Gt(rt.paint_model["model-cutoff-fade-range"])}),layout:F3};const Wm=new Float32Array(262144),Ra=new Uint8Array(262144);function Px(e){let t=0;if(e.meshes)for(const i of e.meshes)t=Math.max(t,i.aabb.max[2]);if(e.children)for(const i of e.children)t=Math.max(t,Px(i));return t}const kx=["","wall","door","roof","window","lamp","logo"];class zx{constructor(t){this.node=t,this.evaluatedRMEA=[[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[.4,1,0,1],[1,0,0,1],[1,0,0,1]],this.hiddenByReplacement=!1,this.evaluatedScale=[1,1,1],this.evaluatedColor=[],this.emissionHeightBasedParams=[],this.feature={type:"Point",id:t.id,geometry:[],properties:{height:Px(t)}}}}class Lx{constructor(t,i,n,r){this.nodes=t,this.id=i,this.modelTraits|=1,this.uploaded=!1,this.hasPattern=!1,n&&(this.modelTraits|=4),this.zoom=-1,this.terrainExaggeration=1,this.projection={name:"mercator"},this.replacementUpdateTime=0,this.elevationReadFromZ=255,this.brightness=r,this.dirty=!0,this.needsUpload=!1}update(){console.log("Update 3D model bucket")}populate(){console.log("populate 3D model bucket")}uploadPending(){return!this.uploaded||this.needsUpload}upload(t){if(!this.needsUpload)return;const i=this.getNodesInfo();for(const n of i){const r=n.node;this.uploaded?this.updatePbrBuffer(r):Hm(r,t,!0)}for(const n of i)nd(n.node);this.uploaded=!0,this.needsUpload=!1}updatePbrBuffer(t){let i=!1;if(!t.meshes)return i;for(const n of t.meshes)n.pbrBuffer&&(n.pbrBuffer.updateData(n.featureArray),i=!0);return i}needsReEvaluation(t,i,n){const r=t.transform.projectionOptions,o=t.style.getBrightness(),s=this.brightness!==o;return!!(!this.uploaded||this.dirty||r.name!==this.projection.name||iu(n.paint.get("model-color").value,s)||iu(n.paint.get("model-color-mix-intensity").value,s)||iu(n.paint.get("model-roughness").value,s)||iu(n.paint.get("model-emissive-strength").value,s)||iu(n.paint.get("model-height-based-emissive-strength-multiplier").value,s))&&(this.projection=r,this.brightness=o,!0)}evaluateScale(t,i){if(t.transform.zoom===this.zoom)return;this.zoom=t.transform.zoom;const n=this.getNodesInfo(),r=this.id.canonical;for(const o of n){const s=o.feature;o.evaluatedScale=i.paint.get("model-scale").evaluate(s,{},r)}}evaluate(t){const i=this.getNodesInfo();for(const n of i){if(!n.node.meshes)continue;const r=n.feature,o=n.node.meshes&&n.node.meshes[0].featureData,s=n.evaluatedColor[2],a=n.evaluatedRMEA[2],l=this.id.canonical;if(n.hasTranslucentParts=!1,o){for(let c=0;c<kx.length;c++){const u=kx[c];u.length&&(r.properties.part=u);const h=t.paint.get("model-color").evaluate(r,{},l),d=t.paint.get("model-color-mix-intensity").evaluate(r,{},l);n.evaluatedColor[c]=[h.r,h.g,h.b,d],n.evaluatedRMEA[c][0]=t.paint.get("model-roughness").evaluate(r,{},l),n.evaluatedRMEA[c][2]=t.paint.get("model-emissive-strength").evaluate(r,{},l),n.evaluatedRMEA[c][3]=h.a,n.emissionHeightBasedParams[c]=t.paint.get("model-height-based-emissive-strength-multiplier").evaluate(r,{},l),!n.hasTranslucentParts&&h.a<1&&(n.hasTranslucentParts=!0)}delete r.properties.part,V3(n,s!==n.evaluatedColor[2]||a!==n.evaluatedRMEA[2])}n.evaluatedScale=t.paint.get("model-scale").evaluate(r,{},l),this.updatePbrBuffer(n.node)||(this.needsUpload=!0)}this.dirty=!1}elevationUpdate(t,i,n,r){const o=t.findDEMTileFor(n);if(o&&(o.tileID.canonical!==this.terrainTile||i!==this.terrainExaggeration)){if(o.dem&&o.tileID.overscaledZ!==this.elevationReadFromZ){this.elevationReadFromZ=o.tileID.overscaledZ;const s=Cl.create(t,n,o);if(!s)return;4&this.modelTraits&&this.updateDEM(t,s,n,r);for(const a of this.getNodesInfo()){const l=a.node;if(!l.footprint||!l.footprint.vertices||!l.footprint.vertices.length)continue;const c=l.footprint.vertices;let u=s.getElevationAt(c[0].x,c[0].y,!0,!0);for(let h=1;h<c.length;h++)u=Math.min(u,s.getElevationAt(c[h].x,c[h].y,!0,!0));l.elevation=u}}this.terrainTile=o.tileID.canonical,this.terrainExaggeration=i}}updateDEM(t,i,n,r){let o=i._dem._modifiedForSources[r];if(o===void 0&&(i._dem._modifiedForSources[r]=[],o=i._dem._modifiedForSources[r]),o.includes(n.canonical))return;const s=i._dem.dim;o.push(n.canonical);let a=!1;for(const l of this.getNodesInfo()){const c=l.node;if(!c.footprint||!c.footprint.grid)continue;const u=c.footprint.grid,h=i.tileCoordToPixel(u.min.x,u.min.y),d=i.tileCoordToPixel(u.max.x,u.max.y),p=Math.min(Math.min(s-d.y,h.x),Math.min(h.y,s-d.x));if(p<0)continue;const _=Lt(p,2,5);let g=Math.max(0,h.x-_),y=Math.max(0,h.y-_),x=Math.min(d.x+_,s-1),b=Math.min(d.y+_,s-1);for(let S=y;S<=b;++S)for(let D=g;D<=x;++D)Ra[S*s+D]=255;let M=0,E=0;for(let S=0;S<u.cellsY;++S)for(let D=0;D<u.cellsX;++D){if(!u.cells[S*u.cellsX+D])continue;const z=i.tileCoordToPixel(u.min.x+D/u.xScale,u.min.y+S/u.yScale),L=i.tileCoordToPixel(u.min.x+(D+1)/u.xScale,u.min.y+(S+1)/u.yScale);for(let R=z.y;R<=Math.min(L.y+1,s-1);++R)for(let N=z.x;N<=Math.min(L.x+1,s-1);++N)Ra[R*s+N]===255&&(Ra[R*s+N]=0,M+=i.getElevationAtPixel(N,R),E++)}const T=M/E;g=Math.max(1,h.x-_),y=Math.max(1,h.y-_),x=Math.min(d.x+_,s-2),b=Math.min(d.y+_,s-2),a=!0;for(let S=y;S<=b;++S)for(let D=g;D<=x;++D)Ra[S*s+D]===0&&(Wm[S*s+D]=i._dem.set(D,S,T));for(let S=1;S<_;++S){g=Math.max(1,h.x-S),y=Math.max(1,h.y-S),x=Math.min(d.x+S,s-2),b=Math.min(d.y+S,s-2);for(let D=y;D<=b;++D)for(let z=g;z<=x;++z){const L=D*s+z;if(Ra[L]===255){let R=0,N=0,U=-1,H=-1;for(let O=-1;O<=1;++O)for(let X=-1;X<=1;++X){const K=(D+O)*s+z+X;if(Ra[K]>=S)continue;const ot=Wm[K],$=Math.abs(ot);$>N&&(R=ot,N=$,U=X,H=O)}if(N>.1){const O=1-(S+.5*Math.abs(U*H))/_;let X=i._dem.get(z,D)+R*O;const K=i._dem.get(z+U,D+H),ot=i._dem.get(z-U,D-H,!0);(X-K)*(X-ot)>0&&(X=(K+ot)/2),Wm[L]=i._dem.set(z,D,X),Ra[L]=S}}}}}a&&(i._demTile.needsDEMTextureUpload=!0,i._dem._timestamp=ke.now())}getNodesInfo(){if(!this.nodesInfo){this.nodesInfo=[];for(const t of this.nodes)this.nodesInfo.push(new zx(t));this.freeNodes()}return this.nodesInfo}freeNodes(){if(this.nodes){for(const t of this.nodes)rd(t);this.nodes.splice(0,this.nodes.length)}}destroy(){this.freeNodes();const t=this.getNodesInfo();for(const i of t)nd(i.node),rd(i.node)}isEmpty(){return!this.nodes.length}updateReplacement(t,i){if(i.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=i.updateTime;const n=i.getReplacementRegionsForTile(t.toUnwrapped()),r=this.getNodesInfo();for(let o=0;o<this.nodesInfo.length;o++){const s=r[o].node;r[o].hiddenByReplacement=!!s.footprint&&!n.find(a=>a.footprint===s.footprint)}}getHeightAtTileCoord(t,i){const n=this.getNodesInfo(),r=[];for(let o=0;o<this.nodesInfo.length;o++){const s=n[o],a=s.node.meshes[0];if(t<a.aabb.min[0]||i<a.aabb.min[1]||t>a.aabb.max[0]||i>a.aabb.max[1])continue;const l=(t-a.aabb.min[0])/(a.aabb.max[0]-a.aabb.min[0])*La|0,c=Math.min(63,(i-a.aabb.min[1])/(a.aabb.max[1]-a.aabb.min[1])*La|0)*La+Math.min(63,l);if(!(a.heightmap[c]<0&&s.node.footprint))return s.hiddenByReplacement?void 0:{height:a.heightmap[c],maxHeight:s.feature.properties.height,hidden:!1,verticalScale:s.evaluatedScale[2]};if(s.node.footprint.grid.query(new G(t,i),new G(t,i),r),r.length>0)return{height:void 0,maxHeight:s.feature.properties.height,hidden:s.hiddenByReplacement,verticalScale:s.evaluatedScale[2]}}}}function iu(e,t){return!e.isLightConstant&&t}function U3(e,t,i,n,r,o,s,a){let l=(61440&t|(61440&t)>>4)>>8,c=(3840&t|(3840&t)>>4)>>4,u=240&t|(240&t)>>4;i[3]>0&&(l=ze(l,255*i[0],i[3]),c=ze(c,255*i[1],i[3]),u=ze(u,255*i[2],i[3]));const h=l<<8|c,d=u<<8|Math.floor(255*n[3]),p=function(S){const D=Lt(S,0,2);return Math.min(Math.round(.5*D*255),255)}(n[2])<<8|15*n[0]<<4|15*n[1],_=Lt(r[0],0,1),g=Lt(r[1],0,1),y=Lt(r[2],0,1),x=Lt(r[3],0,1);let b,M,E,T;if(_!==g&&s!==o&&g!==_){const S=s-o;M=1/(S*(g-_)),E=-(o+S*_)/(S*(g-_));const D=Lt(r[4],-1,1);T=Math.pow(10,D),b=255*y<<8|255*x}else b=65535,M=0,E=1,T=1;if(e.emplaceBack(h,d,p,b,M,E,T),a){const S=a.length;a.clear();for(let D=0;D<S;D++)a.emplaceBack(h,d,p,b,M,E,T)}}function V3(e,t){const i=e.node;let n=0;for(const r of i.meshes){if(i.lights&&i.lightMeshIndex===n||!r.featureData)continue;r.featureArray=new rh,r.featureArray.reserve(r.featureData.length);let o=t;for(const s of r.featureData){let a;const l=65535&s,c=(15&l)<8?15&l:0,u=s>>16&65535,h=e.evaluatedRMEA[c],d=e.evaluatedColor[c],p=e.emissionHeightBasedParams[c];if(o&&c===2&&i.lights&&(a=new rh,a.resize(10*i.lights.length)),U3(r.featureArray,u,d,h,p,r.aabb.min[2],r.aabb.max[2],a),a&&o){o=!1;const _=i.meshes[i.lightMeshIndex];_.featureArray=a,_.featureArray._trim()}}r.featureArray._trim(),n++}}he(Lx,"Tiled3dModelBucket",{omit:["layers"]}),he(zx,"Tiled3dModelFeature");class j3{constructor(){this._updateTime=0,this._sourceIds=[],this._activeRegions=[],this._prevRegions=[]}clear(){this._activeRegions.length>0&&++this._updateTime,this._activeRegions=[],this._prevRegions=[]}get updateTime(){return this._updateTime}getReplacementRegionsForTile(t){const i=Bx(new G(0,0),new G(pt,pt),t),n=[];for(const r of this._activeRegions){if(r.hiddenByOverlap||!Ox(i,r))continue;const o=G3(r.min,r.max,t);n.push({min:o.min,max:o.max,sourceId:this._sourceIds[r.priority],footprint:r.footprint,footprintTileId:r.tileId})}return n}setSources(t){this._setSources(t.map(i=>({getSourceId:()=>i.cache.id,getFootprints:()=>{const n=[];for(const r of i.cache.getVisibleCoordinates()){const o=i.cache.getTile(r).buckets[i.layer];if(o)for(const s of o.getNodesInfo()){const a=s.node;a.footprint&&n.push({footprint:a.footprint,id:r.toUnwrapped()})}}return n}})))}_addSource(t){const i=t.getFootprints();if(i.length!==0){for(const n of i){if(!n.footprint)continue;const r=Bx(n.footprint.min,n.footprint.max,n.id);this._activeRegions.push({min:r.min,max:r.max,hiddenByOverlap:!1,priority:this._sourceIds.length,tileId:n.id,footprint:n.footprint})}this._sourceIds.push(t.getSourceId())}}_computeReplacement(){this._activeRegions.sort((i,n)=>i.priority-n.priority||od(i.min,n.min)||od(i.max,n.max));let t=this._activeRegions.length!==this._prevRegions.length;if(!t){let i=0,n=0;for(;!t&&i!==this._activeRegions.length;){const r=this._activeRegions[i],o=this._prevRegions[n];t=r.priority!==o.priority||!Rx(r,o),++i,++n}}if(t){++this._updateTime;const i=n=>{const r=this._activeRegions;if(n>=r.length)return n;const o=r[n].priority;for(;n<r.length&&r[n].priority===o;)++n;return n};if(this._sourceIds.length>1){let n=0,r=i(n);for(;n!==r;){let o=n;const s=n;for(;o!==r;){const a=this._activeRegions[o];a.hiddenByOverlap=!1;for(let l=0;l<s;l++){const c=this._activeRegions[l];if(!c.hiddenByOverlap&&Ox(a,c)&&(a.hiddenByOverlap=Nx(a.footprint,a.tileId,c.footprint,c.tileId),a.hiddenByOverlap))break}++o}n=r,r=i(n)}}}}_setSources(t){[this._prevRegions,this._activeRegions]=[this._activeRegions,[]],this._sourceIds=[];for(let i=t.length-1;i>=0;i--)this._addSource(t[i]);this._computeReplacement()}}function od(e,t){return e.x-t.x||e.y-t.y}function Rx(e,t){return od(e.min,t.min)===0&&od(e.max,t.max)===0}function Ox(e,t){return!(e.min.x>t.max.x||e.max.x<t.min.x||e.min.y>t.max.y||e.max.y<t.min.y)}function Bx(e,t,i){const n=1/pt,r=1/(1<<i.canonical.z),o=(t.x*n+i.canonical.x)*r+i.wrap,s=(t.y*n+i.canonical.y)*r;return{min:new G((e.x*n+i.canonical.x)*r+i.wrap,(e.y*n+i.canonical.y)*r),max:new G(o,s)}}function G3(e,t,i){const n=1<<i.canonical.z,r=((t.x-i.wrap)*n-i.canonical.x)*pt,o=(t.y*n-i.canonical.y)*pt;return{min:new G(((e.x-i.wrap)*n-i.canonical.x)*pt,(e.y*n-i.canonical.y)*pt),max:new G(r,o)}}function Fx(e,t,i,n,r,o,s){const a=e.indices,l=e.vertices,c=[];for(let u=n;u<n+r;u+=3){const h=t[i[u+0]+o],d=t[i[u+1]+o],p=t[i[u+2]+o],_=Math.min(h.x,d.x,p.x),g=Math.max(h.x,d.x,p.x),y=Math.min(h.y,d.y,p.y),x=Math.max(h.y,d.y,p.y);c.length=0,e.grid.query(new G(_,y),new G(g,x),c);for(let b=0;b<c.length;b++){const M=c[b];if(fm(l[a[3*M+0]],l[a[3*M+1]],l[a[3*M+2]],h,d,p,s))return!0}}return!1}function Nx(e,t,i,n){if(!e||!i)return!1;let r=e.vertices;if(!t.canonical.equals(n.canonical)||t.wrap!==n.wrap){if(i.vertices.length<e.vertices.length)return Nx(i,n,e,t);const o=t.canonical,s=n.canonical,a=Math.pow(2,s.z-o.z);r=e.vertices.map(l=>new G(l.x*o.x*pt*a-s.x*pt,l.y*o.y*pt*a-s.y*pt))}return Fx(i,r,e.indices,0,e.indices.length,0,0)}const q3=Ih.types,Z3=["fill-extrusion-base","fill-extrusion-height","fill-extrusion-color","fill-extrusion-pattern","fill-extrusion-flood-light-wall-radius"],H3=["fill-extrusion-flood-light-ground-radius"],W3=Math.pow(2,13),$3=Math.pow(2,15)-1,Ux=new G(0,1),Ro=2147483648;function nu(e,t,i,n,r,o,s,a){e.emplaceBack((t<<1)+s,(i<<1)+o,(Math.floor(n*W3)<<1)+r,Math.round(a))}function sd(e,t,i,n,r,o){e.emplaceBack(t.x,t.y,(i.x<<1)+n,(i.y<<1)+r,o)}function ru(e,t,i){e.emplaceBack(t.x,t.y,t.z,i[0]*16384,i[1]*16384,i[2]*16384)}class Vx{constructor(){this.vertexOffset=0,this.vertexCount=0,this.indexOffset=0,this.indexCount=0}}class jx{constructor(){this.centroidXY=new G(0,0),this.vertexArrayOffset=0,this.vertexCount=0,this.groundVertexArrayOffset=0,this.groundVertexCount=0,this.flags=0,this.footprintSegIdx=-1,this.footprintSegLen=0,this.polygonSegIdx=-1,this.polygonSegLen=0,this.min=new G(Number.MAX_VALUE,Number.MAX_VALUE),this.max=new G(-Number.MAX_VALUE,-Number.MAX_VALUE),this.height=0}span(){return new G(this.max.x-this.min.x,this.max.y-this.min.y)}}class Gx{constructor(){this.acc=new G(0,0),this.accCount=0,this.centroidDataIndex=0}startRing(t,i){t.min.x===Number.MAX_VALUE&&(t.min.x=t.max.x=i.x,t.min.y=t.max.y=i.y)}appendEdge(t,i,n){this.accCount++,this.acc._add(i);let r=!!this.borders;i.x<t.min.x?(t.min.x=i.x,r=!0):i.x>t.max.x&&(t.max.x=i.x,r=!0),i.y<t.min.y?(t.min.y=i.y,r=!0):i.y>t.max.y&&(t.max.y=i.y,r=!0),((i.x===0||i.x===pt)&&i.x===n.x)!=((i.y===0||i.y===pt)&&i.y===n.y)&&this.processBorderOverlap(i,n),r&&this.checkBorderIntersection(i,n)}checkBorderIntersection(t,i){i.x<0!=t.x<0&&this.addBorderIntersection(0,ze(i.y,t.y,(0-i.x)/(t.x-i.x))),i.x>pt!=t.x>pt&&this.addBorderIntersection(1,ze(i.y,t.y,(pt-i.x)/(t.x-i.x))),i.y<0!=t.y<0&&this.addBorderIntersection(2,ze(i.x,t.x,(0-i.y)/(t.y-i.y))),i.y>pt!=t.y>pt&&this.addBorderIntersection(3,ze(i.x,t.x,(pt-i.y)/(t.y-i.y)))}addBorderIntersection(t,i){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);const n=this.borders[t];i<n[0]&&(n[0]=i),i>n[1]&&(n[1]=i)}processBorderOverlap(t,i){if(t.x===i.x){if(t.y===i.y)return;const n=t.x===0?0:1;this.addBorderIntersection(n,i.y),this.addBorderIntersection(n,t.y)}else{const n=t.y===0?2:3;this.addBorderIntersection(n,i.x),this.addBorderIntersection(n,t.x)}}centroid(){return this.accCount===0?new G(0,0):new G(Math.floor(Math.max(0,this.acc.x)/this.accCount),Math.floor(Math.max(0,this.acc.y)/this.accCount))}intersectsCount(){return this.borders?this.borders.reduce((t,i)=>t+ +(i[0]!==Number.MAX_VALUE),0):0}}function qx(e,t){const i=e.add(t)._unit(),n=Lt(e.x*i.x+e.y*i.y,-1,1);var r,o,s;return r=Math.acos(n),Math.min(4,Math.max(-4,Math.tan(r)))/4*$3*((o=e).x*(s=t).y-o.y*s.x<0?-1:1)}const X3=[e=>e.x<0,e=>e.x>pt,e=>e.y<0,e=>e.y>pt];function Y3(e,t,i,n){const r=[4];if(n===0)return r;i._mult(n);const o=e.sub(i),s=t.sub(i),a=[e,t,o,s];for(let l=0;l<4;l++)for(const c of a)if(X3[l](c)){r.push(l);break}return r}class Zx{constructor(t){this.vertexArray=new _p,this.indexArray=new Rn,this.programConfigurations=new Fs(t.layers,t.zoom,i=>H3.includes(i)),this._segments=new Fi,this.hiddenByLandmarkVertexArray=new Cp,this._segmentToGroundQuads={},this._segmentToGroundQuads[0]=[],this._segmentToRegionTriCounts={},this._segmentToRegionTriCounts[0]=[0,0,0,0,0],this.regionSegments={},this.regionSegments[4]=new Fi}getDefaultSegment(){return this.regionSegments[4]}hasData(){return this.vertexArray.length!==0}addData(t,i,n,r=!1){const o=t.length;if(o>2){let s=Math.max(0,this._segments.get().length-1);const a=this._segments._prepareSegment(4*o,this.vertexArray.length,2*this._segmentToGroundQuads[s].length);let l;s!==this._segments.get().length-1&&(s++,this._segmentToGroundQuads[s]=[],this._segmentToRegionTriCounts[s]=[0,0,0,0,0]);{const c=t[0],u=t[1];l=qx(c.sub(t[o-1])._perp()._unit(),u.sub(c)._perp()._unit())}for(let c=0;c<o;c++){const u=c===o-1?0:c+1,h=t[c],d=t[u],p=t[u===o-1?0:u+1],_=d.sub(h)._perp()._unit(),g=qx(_,p.sub(d)._perp()._unit()),y=l,x=g;if($m(h,d,i)||r&&$x(h,i)&&$x(d,i)){l=g;continue}const b=a.vertexLength;sd(this.vertexArray,h,d,1,1,y),sd(this.vertexArray,h,d,1,0,y),sd(this.vertexArray,h,d,0,1,x),sd(this.vertexArray,h,d,0,0,x),a.vertexLength+=4;const M=Y3(h,d,_,n);for(const E of M)this._segmentToGroundQuads[s].push({id:b,region:E}),this._segmentToRegionTriCounts[s][E]+=2,a.primitiveLength+=2;l=g}}}prepareBorderSegments(){if(!this.hasData())return;const t=this._segments.get(),i=t.length;for(let n=0;n<i;n++)this._segmentToGroundQuads[n].sort((r,o)=>r.region-o.region);for(let n=0;n<i;n++){const r=this._segmentToGroundQuads[n],o=t[n],s=this._segmentToRegionTriCounts[n];s.reduce((l,c)=>l+c,0);let a=0;for(let l=0;l<=4;l++){const c=s[l];if(c!==0){let u=this.regionSegments[l];u||(u=this.regionSegments[l]=new Fi);const h={vertexOffset:o.vertexOffset,primitiveOffset:o.primitiveOffset+a,vertexLength:o.vertexLength,primitiveLength:c};u.get().push(h)}a+=c}for(let l=0;l<r.length;l++){const c=r[l].id;this.indexArray.emplaceBack(c,c+1,c+3),this.indexArray.emplaceBack(c,c+3,c+2)}}this._segmentToGroundQuads=null,this._segmentToRegionTriCounts=null,this._segments.destroy(),this._segments=null}addPaintPropertiesData(t,i,n,r,o,s){this.hasData()&&this.programConfigurations.populatePaintArrays(this.vertexArray.length,t,i,n,r,o,s)}upload(t){this.hasData()&&(this.vertexBuffer=t.createVertexBuffer(this.vertexArray,bS.members),this.indexBuffer=t.createIndexBuffer(this.indexArray))}uploadPaintProperties(t){this.hasData()&&this.programConfigurations.upload(t)}update(t,i,n,r,o,s){this.hasData()&&this.programConfigurations.updatePaintArrays(t,i,n,r,o,s)}updateHiddenByLandmark(t){if(!this.hasData())return;const i=t.groundVertexCount+t.groundVertexArrayOffset;if(t.groundVertexCount===0)return;const n=t.flags&Ro?1:0;for(let r=t.groundVertexArrayOffset;r<i;++r)this.hiddenByLandmarkVertexArray.emplace(r,n);this._needsHiddenByLandmarkUpdate=!0}uploadHiddenByLandmark(t){this.hasData()&&this._needsHiddenByLandmarkUpdate&&(!this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexArray.length>0?this.hiddenByLandmarkVertexBuffer=t.createVertexBuffer(this.hiddenByLandmarkVertexArray,TS.members,!0):this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.updateData(this.hiddenByLandmarkVertexArray),this._needsHiddenByLandmarkUpdate=!1)}destroy(){if(this.vertexBuffer){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.destroy(),this._segments&&this._segments.destroy(),this.programConfigurations.destroy();for(let t=0;t<=4;t++){const i=this.regionSegments[t];i&&i.destroy()}}}}class ou{constructor(t){this.zoom=t.zoom,this.canonical=t.canonical,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map(i=>i.fqid),this.index=t.index,this.hasPattern=!1,this.edgeRadius=0,this.projection=t.projection,this.activeReplacements=[],this.replacementUpdateTime=0,this.centroidData=[],this.footprintIndices=new Rn,this.footprintVertices=new Tr,this.footprintSegments=[],this.layoutVertexArray=new Ea,this.centroidVertexArray=new ey,this.indexArray=new Rn,this.programConfigurations=new Fs(t.layers,t.zoom,i=>Z3.includes(i)),this.segments=new Fi,this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.groundEffect=new Zx(t),this.maxHeight=0,this.partLookup={},this.triangleSubSegments=[],this.polygonSegments=[]}populate(t,i,n,r){this.features=[],this.hasPattern=xm("fill-extrusion",this.layers,i),this.featuresOnBorder=[],this.borderFeatureIndices=[[],[],[],[]],this.borderDoneWithNeighborZ=[-1,-1,-1,-1],this.tileToMeter=Fc(n),this.edgeRadius=this.layers[0].layout.get("fill-extrusion-edge-radius")/this.tileToMeter;for(const{feature:o,id:s,index:a,sourceLayerIndex:l}of t){const c=this.layers[0]._featureFilter.needGeometry,u=Zs(o,c);if(!this.layers[0]._featureFilter.filter(new dn(this.zoom),u,n))continue;const h={id:s,sourceLayerIndex:l,index:a,geometry:c?u.geometry:Po(o,n,r),properties:o.properties,type:o.type,patterns:{}},d=this.layoutVertexArray.length;this.hasPattern?this.features.push(bm("fill-extrusion",this.layers,h,this.zoom,i)):this.addFeature(h,h.geometry,a,n,{},i.availableImages,r,i.brightness),i.featureIndex.insert(o,h.geometry,a,l,this.index,d)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles(),this.groundEffect.prepareBorderSegments(),this.polygonSegments.length=0}addFeatures(t,i,n,r,o,s){for(const a of this.features){const{geometry:l}=a;this.addFeature(a,l,a.index,i,n,r,o,s)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles()}update(t,i,n,r,o){const s=Object.keys(t).length!==0;if(s&&!this.stateDependentLayers.length)return;const a=s?this.stateDependentLayers:this.layers;this.programConfigurations.updatePaintArrays(t,i,a,n,r,o),this.groundEffect.update(t,i,a,n,r,o)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(t){this.uploaded||(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,ES),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.layoutVertexExtArray&&(this.layoutVertexExtBuffer=t.createVertexBuffer(this.layoutVertexExtArray,MS.members,!0)),this.groundEffect.upload(t)),this.groundEffect.uploadPaintProperties(t),this.programConfigurations.upload(t),this.uploaded=!0}uploadCentroid(t){this.groundEffect.uploadHiddenByLandmark(t),this.needsCentroidUpdate&&(!this.centroidVertexBuffer&&this.centroidVertexArray.length>0?this.centroidVertexBuffer=t.createVertexBuffer(this.centroidVertexArray,wS.members,!0):this.centroidVertexBuffer&&this.centroidVertexBuffer.updateData(this.centroidVertexArray),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.layoutVertexExtBuffer&&this.layoutVertexExtBuffer.destroy(),this.groundEffect.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(t,i,n,r,o,s,a,l){const c=this.layers[0].paint.get("fill-extrusion-flood-light-ground-radius").evaluate(t,{})/this.tileToMeter,u=[new G(0,0),new G(pt,pt)],h=a.projection,d=h.name==="globe",p=q3[t.type]==="Polygon",_=new Gx;_.centroidDataIndex=this.centroidData.length;const g=new jx,y=this.layers[0].paint.get("fill-extrusion-base").evaluate(t,{},r)<=0,x=this.layers[0].paint.get("fill-extrusion-height").evaluate(t,{},r);g.height=x,g.vertexArrayOffset=this.layoutVertexArray.length,g.groundVertexArrayOffset=this.groundEffect.vertexArray.length,d&&!this.layoutVertexExtArray&&(this.layoutVertexExtArray=new ih);const b=vm(i,500);for(let z=b.length-1;z>=0;z--){const L=b[z];(L.length===0||(M=L[0]).every(R=>R.x<=0)||M.every(R=>R.x>=pt)||M.every(R=>R.y<=0)||M.every(R=>R.y>=pt))&&b.splice(z,1)}var M;let E;if(d)E=Jx(b,u,r);else{E=[];for(const z of b)E.push({polygon:z,bounds:u})}const T=p?this.edgeRadius:0,S=T>0&&this.zoom<17,D=(z,L)=>{if(z.length===0)return!1;const R=z[z.length-1];return L.x===R.x&&L.y===R.y};for(const{polygon:z,bounds:L}of E){let R=0,N=0;for(const X of z)p&&!X[0].equals(X[X.length-1])&&X.push(X[0]),N+=p?X.length-1:X.length;const U=this.segments.prepareSegment((p?5:4)*N,this.layoutVertexArray,this.indexArray);g.footprintSegIdx<0&&(g.footprintSegIdx=this.footprintSegments.length),g.polygonSegIdx<0&&(g.polygonSegIdx=this.polygonSegments.length);const H={triangleArrayOffset:this.indexArray.length,triangleCount:0,triangleSegIdx:this.segments.segments.length-1},O=new Vx;if(O.vertexOffset=this.footprintVertices.length,O.indexOffset=3*this.footprintIndices.length,O.ringIndices=[],p){const X=[],K=[];R=U.vertexLength;for(let $=0;$<z.length;$++){const Y=z[$];Y.length&&$!==0&&K.push(X.length/2);const at=[];let ut,ct;ut=Y[1].sub(Y[0])._perp()._unit(),O.ringIndices.push(Y.length-1);for(let bt=1;bt<Y.length;bt++){const Mt=Y[bt],Et=Y[bt===Y.length-1?1:bt+1],ft=Mt.clone();if(T){ct=Et.sub(Mt)._perp()._unit();const kt=ut.add(ct)._unit(),Qt=T*Math.min(4,1/(ut.x*kt.x+ut.y*kt.y));ft.x+=Qt*kt.x,ft.y+=Qt*kt.y,ft.x=Math.round(ft.x),ft.y=Math.round(ft.y),ut=ct}!y||T!==0&&!S||D(at,ft)||at.push(ft),nu(this.layoutVertexArray,ft.x,ft.y,0,0,1,1,0),U.vertexLength++,this.footprintVertices.emplaceBack(Mt.x,Mt.y),X.push(Mt.x,Mt.y),d&&ru(this.layoutVertexExtArray,h.projectTilePoint(ft.x,ft.y,r),h.upVector(r,ft.x,ft.y))}y&&(T===0||S)&&(at.length!==0&&D(at,at[0])&&at.pop(),this.groundEffect.addData(at,L,c))}const ot=Eh(X,K);for(let $=0;$<ot.length;$+=3)this.footprintIndices.emplaceBack(O.vertexOffset+ot[$+0],O.vertexOffset+ot[$+1],O.vertexOffset+ot[$+2]),this.indexArray.emplaceBack(R+ot[$],R+ot[$+2],R+ot[$+1]),U.primitiveLength++;O.indexCount+=ot.length,O.vertexCount+=this.footprintVertices.length-O.vertexOffset}for(let X=0;X<z.length;X++){const K=z[X];_.startRing(g,K[0]);let ot=K.length>4&&Xx(K[K.length-2],K[0],K[1]),$=T?K3(K[K.length-2],K[0],K[1],T):0;const Y=[];let at,ut,ct;ut=K[1].sub(K[0])._perp()._unit();let bt=!0;for(let Mt=1,Et=0;Mt<K.length;Mt++){let ft=K[Mt-1],kt=K[Mt];const Qt=K[Mt===K.length-1?1:Mt+1];if(_.appendEdge(g,kt,ft),$m(kt,ft,L)){T&&(ut=Qt.sub(kt)._perp()._unit(),bt=!bt);continue}const te=kt.sub(ft)._perp(),oe=te.x/(Math.abs(te.x)+Math.abs(te.y)),ce=te.y>0?1:0,Ce=ft.dist(kt);if(Et+Ce>32768&&(Et=0),T){ct=Qt.sub(kt)._perp()._unit();let De=Wx(ft,kt,Qt,Hx(ut,ct),T);isNaN(De)&&(De=0);const we=kt.sub(ft)._unit();ft=ft.add(we.mult($))._round(),kt=kt.add(we.mult(-De))._round(),$=De,ut=ct,y&&this.zoom>=17&&(D(Y,ft)||Y.push(ft),D(Y,kt)||Y.push(kt))}const ge=U.vertexLength,bi=K.length>4&&Xx(ft,kt,Qt);let ni=Yx(Et,ot,bt);if(nu(this.layoutVertexArray,ft.x,ft.y,oe,ce,0,0,ni),nu(this.layoutVertexArray,ft.x,ft.y,oe,ce,0,1,ni),Et+=Ce,ni=Yx(Et,bi,!bt),ot=bi,nu(this.layoutVertexArray,kt.x,kt.y,oe,ce,0,0,ni),nu(this.layoutVertexArray,kt.x,kt.y,oe,ce,0,1,ni),U.vertexLength+=4,this.indexArray.emplaceBack(ge+0,ge+1,ge+2),this.indexArray.emplaceBack(ge+1,ge+3,ge+2),U.primitiveLength+=2,T){const De=R+(Mt===1?K.length-2:Mt-2),we=Mt===1?R:De+1;if(this.indexArray.emplaceBack(ge+1,De,ge+3),this.indexArray.emplaceBack(De,we,ge+3),U.primitiveLength+=2,at===void 0&&(at=ge),!$m(Qt,K[Mt],L)){const ye=Mt===K.length-1?at:U.vertexLength;this.indexArray.emplaceBack(ge+2,ge+3,ye),this.indexArray.emplaceBack(ge+3,ye+1,ye),this.indexArray.emplaceBack(ge+3,we,ye+1),U.primitiveLength+=3}bt=!bt}if(d){const De=this.layoutVertexExtArray,we=h.projectTilePoint(ft.x,ft.y,r),ye=h.projectTilePoint(kt.x,kt.y,r),si=h.upVector(r,ft.x,ft.y),pi=h.upVector(r,kt.x,kt.y);ru(De,we,si),ru(De,we,si),ru(De,ye,pi),ru(De,ye,pi)}}p&&(R+=K.length-1),y&&T&&this.zoom>=17&&(Y.length!==0&&D(Y,Y[0])&&Y.pop(),this.groundEffect.addData(Y,L,c,T>0))}this.footprintSegments.push(O),H.triangleCount=this.indexArray.length-H.triangleArrayOffset,this.polygonSegments.push(H),++g.footprintSegLen,++g.polygonSegLen}if(g.vertexCount=this.layoutVertexArray.length-g.vertexArrayOffset,g.groundVertexCount=this.groundEffect.vertexArray.length-g.groundVertexArrayOffset,g.vertexCount!==0){if(g.centroidXY=_.borders?Ux:this.encodeCentroid(_,g),this.centroidData.push(g),_.borders){this.featuresOnBorder.push(_);const z=this.featuresOnBorder.length-1;for(let L=0;L<_.borders.length;L++)_.borders[L][0]!==Number.MAX_VALUE&&this.borderFeatureIndices[L].push(z)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,n,o,s,r,l),this.groundEffect.addPaintPropertiesData(t,n,o,s,r,l),this.maxHeight=Math.max(this.maxHeight,x)}}sortBorders(){for(let t=0;t<this.borderFeatureIndices.length;t++)this.borderFeatureIndices[t].sort((i,n)=>this.featuresOnBorder[i].borders[t][0]-this.featuresOnBorder[n].borders[t][0])}splitToSubtiles(){const t=[];for(let a=0;a<this.centroidData.length;a++){const l=this.centroidData[a],c=+(l.min.y+l.max.y>pt),u=2*c+(+(l.min.x+l.max.x>pt)^c);for(let h=0;h<l.polygonSegLen;h++){const d=l.polygonSegIdx+h;t.push({centroidIdx:a,subtile:u,polygonSegmentIdx:d,triangleSegmentIdx:this.polygonSegments[d].triangleSegIdx})}}const i=new Rn;t.sort((a,l)=>a.triangleSegmentIdx===l.triangleSegmentIdx?a.subtile-l.subtile:a.triangleSegmentIdx-l.triangleSegmentIdx);let n=0,r=0,o=0;for(const a of t){if(a.triangleSegmentIdx!==n)break;o++}const s=t.length;for(;r!==t.length;){n=t[r].triangleSegmentIdx;let a=0,l=r,c=r;for(let u=l;u<o&&t[u].subtile===a;u++)c++;for(;l!==o;){const u=t[l];a=u.subtile;const h=this.centroidData[u.centroidIdx].min.clone(),d=this.centroidData[u.centroidIdx].max.clone(),p={vertexOffset:this.segments.segments[n].vertexOffset,primitiveOffset:i.length,vertexLength:this.segments.segments[n].vertexLength,primitiveLength:0,sortKey:void 0,vaos:{}};for(let _=l;_<c;_++){const g=t[_],y=this.polygonSegments[g.polygonSegmentIdx],x=this.centroidData[g.centroidIdx].min,b=this.centroidData[g.centroidIdx].max,M=this.indexArray.uint16;for(let E=y.triangleArrayOffset;E<y.triangleArrayOffset+y.triangleCount;E++)i.emplaceBack(M[3*E],M[3*E+1],M[3*E+2]);p.primitiveLength+=y.triangleCount,h.x=Math.min(h.x,x.x),h.y=Math.min(h.y,x.y),d.x=Math.max(d.x,b.x),d.y=Math.max(d.y,b.y)}p.primitiveLength>0&&this.triangleSubSegments.push({segment:p,min:h,max:d}),l=c;for(let _=l;_<o&&t[_].subtile===t[l].subtile;_++)c++}r=o;for(let u=r;u<s&&t[u].triangleSegmentIdx===t[r].triangleSegmentIdx;u++)o++}i._trim(),this.indexArray=i}getVisibleSegments(t,i,n){let r=0,o=0;const s=1<<t.canonical.z;if(i){const g=i.getMinMaxForTile(t);g&&(r=g.min,o=g.max)}o+=this.maxHeight;const a=t.toUnwrapped();let l;const c=[a.canonical.x/s+a.wrap,a.canonical.y/s],u=[(a.canonical.x+1)/s+a.wrap,(a.canonical.y+1)/s],h=new Fi,d=(g,y,x)=>[g[0]*(1-x[0])+y[0]*x[0],g[1]*(1-x[1])+y[1]*x[1]],p=[],_=[];for(const g of this.triangleSubSegments){p[0]=g.min.x/pt,p[1]=g.min.y/pt,_[0]=g.max.x/pt,_[1]=g.max.y/pt;const y=d(c,u,p),x=d(c,u,_);if(new en([y[0],y[1],r],[x[0],x[1],o]).intersectsPrecise(n)===0){l&&(h.segments.push(l),l=void 0);continue}const b=g.segment;l&&l.vertexOffset!==b.vertexOffset&&(h.segments.push(l),l=void 0),l?(l.vertexLength+=b.vertexLength,l.primitiveLength+=b.primitiveLength):l={vertexOffset:b.vertexOffset,primitiveLength:b.primitiveLength,vertexLength:b.vertexLength,primitiveOffset:b.primitiveOffset,sortKey:void 0,vaos:{}}}return l&&h.segments.push(l),h}encodeCentroid(t,i){const n=t.centroid(),r=i.span(),o=Math.min(7,Math.round(r.x*this.tileToMeter/10)),s=Math.min(7,Math.round(r.y*this.tileToMeter/10));return new G(Lt(n.x,1,pt-1)<<3|o,Lt(n.y,1,pt-1)<<3|s)}showCentroid(t){const i=this.centroidData[t.centroidDataIndex];i.flags&=Ro,i.centroidXY.x=0,i.centroidXY.y=0,this.writeCentroidToBuffer(i)}writeCentroidToBuffer(t){this.groundEffect.updateHiddenByLandmark(t);const i=t.vertexArrayOffset,n=t.vertexCount+t.vertexArrayOffset,r=t.flags&Ro?Ux:t.centroidXY,o=this.centroidVertexArray.geta_centroid_pos0(i);if(this.centroidVertexArray.geta_centroid_pos1(i)!==r.y||o!==r.x){for(let s=i;s<n;++s)this.centroidVertexArray.emplace(s,r.x,r.y);this.needsCentroidUpdate=!0}}createCentroidsBuffer(){this.centroidVertexArray.resize(this.layoutVertexArray.length),this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const t of this.centroidData)this.writeCentroidToBuffer(t)}updateReplacement(t,i){if(i.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=i.updateTime;const n=i.getReplacementRegionsForTile(t.toUnwrapped());if(function(o,s){if(o.length!==s.length)return!1;for(let a=0;a<o.length;a++)if(o[a].sourceId!==s[a].sourceId||!Rx(o[a],s[a]))return!1;return!0}(this.activeReplacements,n))return;if(this.activeReplacements=n,this.centroidVertexArray.length===0)this.createCentroidsBuffer();else for(const o of this.centroidData)o.flags&=2147483647;const r=[];for(const o of this.activeReplacements){const s=Math.pow(2,o.footprintTileId.canonical.z-t.canonical.z);for(const a of this.centroidData)if(!(a.flags&Ro||o.min.x>a.max.x||a.min.x>o.max.x||o.min.y>a.max.y||a.min.y>o.max.y))for(let l=0;l<a.footprintSegLen;l++){const c=this.footprintSegments[a.footprintSegIdx+l];if(r.length=0,J3(this.footprintVertices,c.vertexOffset,c.vertexCount,o.footprintTileId.canonical,t.canonical,r),Fx(o.footprint,r,this.footprintIndices.uint16,c.indexOffset,c.indexCount,-c.vertexOffset,-s)){a.flags|=Ro;break}}}for(const o of this.centroidData)this.writeCentroidToBuffer(o);this.borderDoneWithNeighborZ=[-1,-1,-1,-1]}footprintContainsPoint(t,i,n){let r=!1;for(let o=0;o<n.footprintSegLen;o++){const s=this.footprintSegments[n.footprintSegIdx+o];let a=0;for(const l of s.ringIndices){for(let c=a,u=l+a-1;c<l+a;u=c++){const h=this.footprintVertices.int16[2*(c+s.vertexOffset)+0],d=this.footprintVertices.int16[2*(c+s.vertexOffset)+1],p=this.footprintVertices.int16[2*(u+s.vertexOffset)+1];d>i!=p>i&&t<(this.footprintVertices.int16[2*(u+s.vertexOffset)+0]-h)*(i-d)/(p-d)+h&&(r=!r)}a=l}}return r}getHeightAtTileCoord(t,i){let n=Number.NEGATIVE_INFINITY,r=!0;const o=4*(t+pt)*pt+(i+pt);if(this.partLookup.hasOwnProperty(o)){const s=this.partLookup[o];return s?{height:s.height,hidden:!!(s.flags&Ro)}:void 0}for(const s of this.centroidData)t>s.max.x||s.min.x>t||i>s.max.y||s.min.y>i||this.footprintContainsPoint(t,i,s)&&s&&s.height>n&&(n=s.height,this.partLookup[o]=s,r=!!(s.flags&Ro));if(n!==Number.NEGATIVE_INFINITY)return{height:n,hidden:r};this.partLookup[o]=void 0}}function Hx(e,t){const i=e.add(t)._unit();return e.x*i.x+e.y*i.y}function K3(e,t,i,n){const r=t.sub(e)._perp()._unit(),o=i.sub(t)._perp()._unit();return Wx(e,t,i,Hx(r,o),n)}function Wx(e,t,i,n,r){const o=Math.sqrt(1-n*n);return Math.min(e.dist(t)/3,t.dist(i)/3,r*o/n)}function $m(e,t,i){return e.x<i[0].x&&t.x<i[0].x||e.x>i[1].x&&t.x>i[1].x||e.y<i[0].y&&t.y<i[0].y||e.y>i[1].y&&t.y>i[1].y}function $x(e,t){return e.x<t[0].x||e.x>t[1].x||e.y<t[0].y||e.y>t[1].y}function Xx(e,t,i){if(e.x<0||e.x>=pt||t.x<0||t.x>=pt||i.x<0||i.x>=pt)return!1;const n=i.sub(t),r=n.perp(),o=e.sub(t);return(n.x*o.x+n.y*o.y)/Math.sqrt((n.x*n.x+n.y*n.y)*(o.x*o.x+o.y*o.y))>-.866&&r.x*o.x+r.y*o.y<0}function Yx(e,t,i){const n=t?2|e:-3&e;return i?1|n:-2&n}function Kx(){const e=Math.PI/32,t=Math.tan(e),i=wl;return i*Math.sqrt(1+2*t*t)-i}function Jx(e,t,i){const n=1<<i.z,r=Sr(i.x/n),o=Sr((i.x+1)/n),s=On(i.y/n),a=On((i.y+1)/n);return function(l,c,u,h,d=0,p){const _=[];if(!l.length||!u||!h)return _;const g=(S,D)=>{for(const z of S)_.push({polygon:z,bounds:D})},y=Math.ceil(Math.log2(u)),x=Math.ceil(Math.log2(h)),b=y-x,M=[];for(let S=0;S<Math.abs(b);S++)M.push(b>0?0:1);for(let S=0;S<Math.min(y,x);S++)M.push(0),M.push(1);let E=l;if(E=Ch(E,c[0].y-d,c[1].y+d,1),E=Ch(E,c[0].x-d,c[1].x+d,0),!E.length)return _;const T=[];for(M.length?T.push({polygons:E,bounds:c,depth:0}):g(E,c);T.length;){const S=T.pop(),D=S.depth,z=M[D],L=S.bounds[0],R=S.bounds[1],N=z===0?L.x:L.y,U=z===0?R.x:R.y,H=p?p(z,N,U):.5*(N+U),O=Ch(S.polygons,N-d,H+d,z),X=Ch(S.polygons,H-d,U+d,z);if(O.length){const K=[L,new G(z===0?H:R.x,z===1?H:R.y)];M.length>D+1?T.push({polygons:O,bounds:K,depth:D+1}):g(O,K)}if(X.length){const K=[new G(z===0?H:L.x,z===1?H:L.y),R];M.length>D+1?T.push({polygons:X,bounds:K,depth:D+1}):g(X,K)}}return _}(e,t,Math.ceil((o-r)/11.25),Math.ceil((s-a)/11.25),1,(l,c,u)=>{if(l===0)return .5*(c+u);{const h=On((i.y+c/pt)/n);return(jn(.5*(On((i.y+u/pt)/n)+h))*n-i.y)*pt}})}function J3(e,t,i,n,r,o){const s=Math.pow(2,n.z-r.z);for(let a=0;a<i;a++){let l=e.int16[2*(a+t)+0],c=e.int16[2*(a+t)+1];l=(l+r.x*pt)*s-n.x*pt,c=(c+r.y*pt)*s-n.y*pt,o.push(new G(l,c))}}he(ou,"FillExtrusionBucket",{omit:["layers","features"]}),he(jx,"PartData"),he(Vx,"FootprintSegment"),he(Gx,"BorderCentroidData"),he(Zx,"GroundEffect");const Q3=new wn({visibility:new Gt(rt["layout_fill-extrusion"].visibility),"fill-extrusion-edge-radius":new Gt(rt["layout_fill-extrusion"]["fill-extrusion-edge-radius"])});var tI={paint:new wn({"fill-extrusion-opacity":new Gt(rt["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new ve(rt["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new Gt(rt["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new Gt(rt["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new ve(rt["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new ve(rt["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new ve(rt["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-vertical-gradient":new Gt(rt["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"]),"fill-extrusion-ambient-occlusion-intensity":new Gt(rt["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-intensity"]),"fill-extrusion-ambient-occlusion-radius":new Gt(rt["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-radius"]),"fill-extrusion-ambient-occlusion-wall-radius":new Gt(rt["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-wall-radius"]),"fill-extrusion-ambient-occlusion-ground-radius":new Gt(rt["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-radius"]),"fill-extrusion-ambient-occlusion-ground-attenuation":new Gt(rt["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-attenuation"]),"fill-extrusion-flood-light-color":new Gt(rt["paint_fill-extrusion"]["fill-extrusion-flood-light-color"]),"fill-extrusion-flood-light-intensity":new Gt(rt["paint_fill-extrusion"]["fill-extrusion-flood-light-intensity"]),"fill-extrusion-flood-light-wall-radius":new ve(rt["paint_fill-extrusion"]["fill-extrusion-flood-light-wall-radius"]),"fill-extrusion-flood-light-ground-radius":new ve(rt["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-radius"]),"fill-extrusion-flood-light-ground-attenuation":new Gt(rt["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-attenuation"]),"fill-extrusion-vertical-scale":new Gt(rt["paint_fill-extrusion"]["fill-extrusion-vertical-scale"]),"fill-extrusion-rounded-roof":new Gt(rt["paint_fill-extrusion"]["fill-extrusion-rounded-roof"]),"fill-extrusion-cutoff-fade-range":new Gt(rt["paint_fill-extrusion"]["fill-extrusion-cutoff-fade-range"]),"fill-extrusion-emissive-strength":new Gt(rt["paint_fill-extrusion"]["fill-extrusion-emissive-strength"])}),layout:Q3};class Fl extends G{constructor(t,i,n){super(t,i),this.z=n}}function su(e,t){return e.x*t.x+e.y*t.y}function Qx(e,t){if(e.length===1){let i=0;const n=t[i++];let r;for(;!r||n.equals(r);)if(r=t[i++],!r)return 1/0;for(;i<t.length;i++){const o=t[i],s=e[0],a=r.sub(n),l=o.sub(n),c=s.sub(n),u=su(a,a),h=su(a,l),d=su(l,l),p=su(c,a),_=su(c,l),g=u*d-h*h,y=(d*p-h*_)/g,x=(u*_-h*p)/g,b=n.z*(1-y-x)+r.z*y+o.z*x;if(isFinite(b))return b}return 1/0}{let i=1/0;for(const n of t)i=Math.min(i,n.z);return i}}function tb(e,t,i,n,r,o,s,a){const l=s*r.getElevationAt(e,t,!0,!0),c=o[0]!==0,u=c?o[1]===0?s*(o[0]/7-450):s*function(h,d,p){const _=Math.floor(d[0]/8),g=Math.floor(d[1]/8),y=10*(d[0]-8*_),x=10*(d[1]-8*g),b=h.getElevationAt(_,g,!0,!0),M=h.getMeterToDEM(p),E=Math.floor(.5*(y*M-1)),T=Math.floor(.5*(x*M-1)),S=h.tileCoordToPixel(_,g),D=2*E+1,z=2*T+1,L=function(X,K,ot,$,Y){return[X.getElevationAtPixel(K,ot,!0),X.getElevationAtPixel(K+Y,ot,!0),X.getElevationAtPixel(K,ot+Y,!0),X.getElevationAtPixel(K+$,ot+Y,!0)]}(h,S.x-E,S.y-T,D,z),R=Math.abs(L[0]-L[1]),N=Math.abs(L[2]-L[3]),U=Math.abs(L[0]-L[2])+Math.abs(L[1]-L[3]),H=Math.min(.25,.5*M*(R+N)/D),O=Math.min(.25,.5*M*U/z);return b+Math.max(H*y,O*x)}(r,o,a):l;return{base:l+(i===0)?-1:i,top:c?Math.max(u+n,l+i+2):l+n}}const eI=new wn({"line-cap":new ve(rt.layout_line["line-cap"]),"line-join":new ve(rt.layout_line["line-join"]),"line-miter-limit":new Gt(rt.layout_line["line-miter-limit"]),"line-round-limit":new Gt(rt.layout_line["line-round-limit"]),"line-sort-key":new ve(rt.layout_line["line-sort-key"]),visibility:new Gt(rt.layout_line.visibility)});var eb={paint:new wn({"line-opacity":new ve(rt.paint_line["line-opacity"]),"line-color":new ve(rt.paint_line["line-color"]),"line-translate":new Gt(rt.paint_line["line-translate"]),"line-translate-anchor":new Gt(rt.paint_line["line-translate-anchor"]),"line-width":new ve(rt.paint_line["line-width"]),"line-gap-width":new ve(rt.paint_line["line-gap-width"]),"line-offset":new ve(rt.paint_line["line-offset"]),"line-blur":new ve(rt.paint_line["line-blur"]),"line-dasharray":new ve(rt.paint_line["line-dasharray"]),"line-pattern":new ve(rt.paint_line["line-pattern"]),"line-gradient":new Ic(rt.paint_line["line-gradient"]),"line-trim-offset":new Gt(rt.paint_line["line-trim-offset"]),"line-emissive-strength":new Gt(rt.paint_line["line-emissive-strength"]),"line-border-width":new ve(rt.paint_line["line-border-width"]),"line-border-color":new ve(rt.paint_line["line-border-color"])}),layout:eI};const iI=(e,t,i,n,r,o,s)=>{const a=e.transform,l=a.calculatePixelsToTileUnitsMatrix(t);return{u_matrix:nb(e,t,i,n),u_pixels_to_tile_units:l,u_device_pixel_ratio:o,u_units_to_pixels:[1/a.pixelsToGLUnits[0],1/a.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:r,u_texsize:ob(i)&&t.lineAtlasTexture?t.lineAtlasTexture.size:[0,0],u_tile_units_to_pixels:ib(t,e.transform),u_alpha_discard_threshold:0,u_trim_offset:s,u_emissive_strength:i.paint.get("line-emissive-strength")}},nI=(e,t,i,n,r)=>{const o=e.transform;return{u_matrix:nb(e,t,i,n),u_texsize:t.imageAtlasTexture?t.imageAtlasTexture.size:[0,0],u_pixels_to_tile_units:o.calculatePixelsToTileUnitsMatrix(t),u_device_pixel_ratio:r,u_image:0,u_tile_units_to_pixels:ib(t,o),u_units_to_pixels:[1/o.pixelsToGLUnits[0],1/o.pixelsToGLUnits[1]],u_alpha_discard_threshold:0}};function ib(e,t){return 1/za(e,1,t.tileZoom)}function nb(e,t,i,n){return e.translatePosMatrix(n||t.tileID.projMatrix,t,i.paint.get("line-translate"),i.paint.get("line-translate-anchor"))}const rb=e=>{const t=[];ob(e)&&t.push("RENDER_LINE_DASH"),e.paint.get("line-gradient")&&t.push("RENDER_LINE_GRADIENT");const i=e.paint.get("line-trim-offset");return i[0]===0&&i[1]===0||t.push("RENDER_LINE_TRIM_OFFSET"),e.paint.get("line-border-width").constantOr(1)!==0&&t.push("RENDER_LINE_BORDER"),t};function ob(e){const t=e.paint.get("line-dasharray").value;return t.value||t.kind!=="constant"}const sb=new class extends ve{possiblyEvaluate(e,t){return t=new dn(Math.floor(t.zoom),{now:t.now,fadeDuration:t.fadeDuration,transition:t.transition}),super.possiblyEvaluate(e,t)}evaluate(e,t,i,n){return t=Vt({},t,{zoom:Math.floor(t.zoom)}),super.evaluate(e,t,i,n)}}(eb.paint.properties["line-width"].specification);function ab(e,t){return t>0?t+2*e:e}sb.useIntegerZoom=!0;const rI=new wn({visibility:new Gt(rt.layout_background.visibility)});var oI={paint:new wn({"background-color":new Gt(rt.paint_background["background-color"]),"background-pattern":new Gt(rt.paint_background["background-pattern"]),"background-opacity":new Gt(rt.paint_background["background-opacity"]),"background-emissive-strength":new Gt(rt.paint_background["background-emissive-strength"])}),layout:rI};const sI=new wn({visibility:new Gt(rt.layout_raster.visibility)});var aI={paint:new wn({"raster-opacity":new Gt(rt.paint_raster["raster-opacity"]),"raster-color":new Ic(rt.paint_raster["raster-color"]),"raster-color-mix":new Gt(rt.paint_raster["raster-color-mix"]),"raster-color-range":new Gt(rt.paint_raster["raster-color-range"]),"raster-hue-rotate":new Gt(rt.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new Gt(rt.paint_raster["raster-brightness-min"]),"raster-brightness-max":new Gt(rt.paint_raster["raster-brightness-max"]),"raster-saturation":new Gt(rt.paint_raster["raster-saturation"]),"raster-contrast":new Gt(rt.paint_raster["raster-contrast"]),"raster-resampling":new Gt(rt.paint_raster["raster-resampling"]),"raster-fade-duration":new Gt(rt.paint_raster["raster-fade-duration"]),"raster-emissive-strength":new Gt(rt.paint_raster["raster-emissive-strength"]),"raster-array-band":new Gt(rt.paint_raster["raster-array-band"]),"raster-elevation":new Gt(rt.paint_raster["raster-elevation"])}),layout:sI};function lb(e,t,i,n,r,o,s,a){const l=[e,i,r,t,n,o,1,1,1],c=[s,a,1],u=_r.adjoint([],l),[h,d,p]=Z.transformMat3(c,c,_r.transpose(u,u));return _r.multiply(l,[h,0,0,0,d,0,0,0,p],l)}class to extends Mn{constructor(t,i,n,r){super(),this.id=t,this.dispatcher=n,this.coordinates=i.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.onNorthPole=!1,this.onSouthPole=!1,this.setEventedParent(r),this.options=i,this._dirty=!1}load(t,i){if(this._loaded=i||!1,this.fire(new jt("dataloading",{dataType:"source"})),this.url=this.options.url,!this.url)return t&&(this.coordinates=t),this._loaded=!0,void this._finishLoading();this._imageRequest=Ee(this.map._requestManager.transformRequest(this.url,xt.Image),(n,r)=>{if(this._imageRequest=null,this._loaded=!0,n)this.fire(new Ae(n));else if(r){const{HTMLImageElement:o}=I;this.image=r instanceof o?ke.getImageData(r):r,this._dirty=!0,this.width=this.image.width,this.height=this.image.height,t&&(this.coordinates=t),this._finishLoading()}})}loaded(){return this._loaded}updateImage(t){return t.url?(this._imageRequest&&t.url!==this.options.url&&(this._imageRequest.cancel(),this._imageRequest=null),this.options.url=t.url,this.load(t.coordinates,this._loaded),this):this}setTexture(t){if(!(t.handle instanceof WebGLTexture))throw new Error("The provided handle is not a WebGLTexture instance");return this.texture=new Yh(this.map.painter.context,t.handle),this.width=t.dimensions[0],this.height=t.dimensions[1],this._dirty=!1,this._loaded=!0,this._finishLoading(),this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new jt("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(t){this.map=t,this.load()}onRemove(){this._imageRequest&&(this._imageRequest.cancel(),this._imageRequest=null),!this.texture||this.texture instanceof Yh||this.texture.destroy()}setCoordinates(t){if(this.coordinates=t,this._boundsArray=void 0,!t.length)return this;this.onNorthPole=!1,this.onSouthPole=!1;let i=t[0][1],n=t[0][1];for(const o of t)o[1]>n&&(n=o[1]),o[1]<i&&(i=o[1]);const r=(n+i)/2;if(r>Sn?this.onNorthPole=!0:r<-Sn&&(this.onSouthPole=!0),!this.onNorthPole&&!this.onSouthPole){const o=t.map(ui.fromLngLat);this.tileID=function(s){let a=1/0,l=1/0,c=-1/0,u=-1/0;for(const _ of s)a=Math.min(a,_.x),l=Math.min(l,_.y),c=Math.max(c,_.x),u=Math.max(u,_.y);const h=Math.max(c-a,u-l),d=Math.max(0,Math.floor(-Math.log(h)/Math.LN2)),p=Math.pow(2,d);return new Yr(d,Math.floor((a+c)/2*p),Math.floor((l+u)/2*p))}(o),this.minzoom=this.maxzoom=this.tileID.z}return this.fire(new jt("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){this._boundsArray=void 0}_prepareData(t){for(const l in this.tiles){const c=this.tiles[l];c.state!=="loaded"&&(c.state="loaded",c.texture=this.texture)}if(this._boundsArray)return;const i=ka(this.tileID,this.map.transform.projection),[n,r,o,s]=this.coordinates.map(l=>{const c=i.projection.project(l[0],l[1]);return Yv(i,c)._round()});this.perspectiveTransform=function(l,c,u,h,d,p,_,g,y,x){const b=lb(0,0,l,0,0,c,l,c),M=lb(u,h,d,p,_,g,y,x);return _r.multiply(M,_r.adjoint(b,b),M),[M[6]/M[8]*l/pt,M[7]/M[8]*c/pt]}(this.width,this.height,n.x,n.y,r.x,r.y,s.x,s.y,o.x,o.y);const a=this._boundsArray=new Ea;a.emplaceBack(n.x,n.y,0,0),a.emplaceBack(r.x,r.y,pt,0),a.emplaceBack(s.x,s.y,0,pt),a.emplaceBack(o.x,o.y,pt,pt),this.boundsBuffer&&this.boundsBuffer.destroy(),this.boundsBuffer=t.createVertexBuffer(a,Bm.members),this.boundsSegments=Fi.simpleSegment(0,0,4,2)}prepare(){const t=Object.keys(this.tiles).length!==0;if(this.tileID&&!t)return;const i=this.map.painter.context,n=i.gl;!this._dirty||this.texture instanceof Yh||(this.texture?this.texture.update(this.image):(this.texture=new mn(i,this.image,n.RGBA),this.texture.bind(n.LINEAR,n.CLAMP_TO_EDGE)),this._dirty=!1),t&&this._prepareData(i)}loadTile(t,i){this.tileID&&this.tileID.equals(t.tileID.canonical)?(this.tiles[String(t.tileID.wrap)]=t,t.buckets={},i(null)):(t.state="errored",i(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}}class lI extends Rr{constructor(t){super(t,{}),this.implementation=t,t.slot&&(this.slot=t.slot)}is3D(){return this.implementation.renderingMode==="3d"}hasOffscreenPass(){return this.implementation.prerender!==void 0}isLayerDraped(t){return this.implementation.renderToTile!==void 0}shouldRedrape(){return!!this.implementation.shouldRerenderTiles&&this.implementation.shouldRerenderTiles()}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){}onAdd(t){this.implementation.onAdd&&this.implementation.onAdd(t,t.painter.context.gl)}onRemove(t){this.implementation.onRemove&&this.implementation.onRemove(t,t.painter.context.gl)}}const cI=new wn({visibility:new Gt(rt.layout_sky.visibility)});var uI={paint:new wn({"sky-type":new Gt(rt.paint_sky["sky-type"]),"sky-atmosphere-sun":new Gt(rt.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new Gt(rt.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new Gt(rt.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new Gt(rt.paint_sky["sky-gradient-radius"]),"sky-gradient":new Ic(rt.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new Gt(rt.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new Gt(rt.paint_sky["sky-atmosphere-color"]),"sky-opacity":new Gt(rt.paint_sky["sky-opacity"])}),layout:cI};function Xm(e,t,i){const n=[0,0,1],r=nr.identity([]);return nr.rotateY(r,r,i?-wt(e)+Math.PI:wt(e)),nr.rotateX(r,r,-wt(t)),Z.transformQuat(n,n,r),Z.normalize(n,n)}var hI={paint:new wn({})};const dI={circle:class extends Rr{constructor(e,t){super(e,YE,t)}createBucket(e){return new um(e)}queryRadius(e){const t=e;return Ml("circle-radius",this,t)+Ml("circle-stroke-width",this,t)+vh(this.paint.get("circle-translate"))}queryIntersectsFeature(e,t,i,n,r,o,s,a){const l=Y1(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),o.angle,e.pixelToTileUnitsFactor),c=this.paint.get("circle-radius").evaluate(t,i)+this.paint.get("circle-stroke-width").evaluate(t,i);return J1(e,n,o,s,a,this.paint.get("circle-pitch-alignment")==="map",this.paint.get("circle-pitch-scale")==="map",l,c)}getProgramIds(){return["circle"]}getDefaultProgramParams(e,t){const i=K1(this);return{config:new Ia(this,t),defines:i,overrideFog:!1}}},heatmap:class extends Rr{createBucket(e){return new tv(e)}constructor(e,t){super(e,nS,t),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(e){e==="heatmap-color"&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=xh({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}queryRadius(e){return Ml("heatmap-radius",this,e)}queryIntersectsFeature(e,t,i,n,r,o,s,a){const l=this.paint.get("heatmap-radius").evaluate(t,i);return J1(e,n,o,s,a,!0,!0,new G(0,0),l)}hasOffscreenPass(){return this.paint.get("heatmap-opacity")!==0&&this.visibility!=="none"}getProgramIds(){return["heatmap","heatmapTexture"]}getDefaultProgramParams(e,t){return e==="heatmap"?{config:new Ia(this,t),overrideFog:!1}:{}}},hillshade:class extends Rr{constructor(e,t){super(e,oS,t)}hasOffscreenPass(){return this.paint.get("hillshade-exaggeration")!==0&&this.visibility!=="none"}getProgramIds(){return["hillshade","hillshadePrepare"]}getDefaultProgramParams(e,t){return{overrideFog:!1}}},fill:class extends Rr{constructor(e,t){super(e,vS,t)}getProgramIds(){const e=this.paint.get("fill-pattern"),t=e&&e.constantOr(1),i=[t?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&i.push(t&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),i}getDefaultProgramParams(e,t){return{config:new Ia(this,t),overrideFog:!1}}recalculate(e,t){super.recalculate(e,t);const i=this.paint._values["fill-outline-color"];i.value.kind==="constant"&&i.value.value===void 0&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(e){return new Sh(e)}queryRadius(){return vh(this.paint.get("fill-translate"))}queryIntersectsFeature(e,t,i,n,r,o){return!e.queryGeometry.isAboveHorizon&&Z1(X1(e.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),o.angle,e.pixelToTileUnitsFactor),n)}isTileClipped(){return!0}},"fill-extrusion":class extends Rr{constructor(e,t){super(e,tI,t),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(e){return new ou(e)}queryRadius(){return vh(this.paint.get("fill-extrusion-translate"))}is3D(){return!0}hasShadowPass(){return!0}cutoffRange(){return this.paint.get("fill-extrusion-cutoff-fade-range")}canCastShadows(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}queryIntersectsFeature(e,t,i,n,r,o,s,a,l){const c=Y1(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),o.angle,e.pixelToTileUnitsFactor),u=this.paint.get("fill-extrusion-height").evaluate(t,i),h=this.paint.get("fill-extrusion-base").evaluate(t,i),d=[0,0],p=a&&o.elevation,_=o.elevation?o.elevation.exaggeration():1,g=e.tile.getBucket(this);if(p&&g instanceof ou){const E=g.centroidVertexArray,T=l+1;T<E.length&&(d[0]=E.geta_centroid_pos0(T),d[1]=E.geta_centroid_pos1(T))}if(d[0]===0&&d[1]===1)return!1;o.projection.name==="globe"&&(n=Jx([n],[new G(0,0),new G(pt,pt)],e.tileID.canonical).map(E=>E.polygon).flat());const y=p?a:null,[x,b]=function(E,T,S,D,z,L,R,N,U,H,O){return E.projection.name==="globe"?function(X,K,ot,$,Y,at,ut,ct,bt,Mt,Et){const ft=[],kt=[],Qt=X.projection.upVectorScale(Et,X.center.lat,X.worldSize).metersToTile,te=[0,0,0,1],oe=[0,0,0,1],ce=(ge,bi,ni,De)=>{ge[0]=bi,ge[1]=ni,ge[2]=De,ge[3]=1},Ce=Kx();ot>0&&(ot+=Ce),$+=Ce;for(const ge of K){const bi=[],ni=[];for(const De of ge){const we=De.x+Y.x,ye=De.y+Y.y,si=X.projection.projectTilePoint(we,ye,Et),pi=X.projection.upVector(Et,De.x,De.y);let $e=ot,qi=$;if(ut){const An=tb(we,ye,ot,$,ut,ct,bt,Mt);$e+=An.base,qi+=An.top}ot!==0?ce(te,si.x+pi[0]*Qt*$e,si.y+pi[1]*Qt*$e,si.z+pi[2]*Qt*$e):ce(te,si.x,si.y,si.z),ce(oe,si.x+pi[0]*Qt*qi,si.y+pi[1]*Qt*qi,si.z+pi[2]*Qt*qi),Z.transformMat4(te,te,at),Z.transformMat4(oe,oe,at),bi.push(new Fl(te[0],te[1],te[2])),ni.push(new Fl(oe[0],oe[1],oe[2]))}ft.push(bi),kt.push(ni)}return[ft,kt]}(E,T,S,D,z,L,R,N,U,H,O):R?function(X,K,ot,$,Y,at,ut,ct,bt){const Mt=[],Et=[],ft=[0,0,0,1];for(const kt of X){const Qt=[],te=[];for(const oe of kt){const ce=oe.x+$.x,Ce=oe.y+$.y,ge=tb(ce,Ce,K,ot,at,ut,ct,bt);ft[0]=ce,ft[1]=Ce,ft[2]=ge.base,ft[3]=1,Ni.transformMat4(ft,ft,Y),ft[3]=Math.max(ft[3],1e-5);const bi=new Fl(ft[0]/ft[3],ft[1]/ft[3],ft[2]/ft[3]);ft[0]=ce,ft[1]=Ce,ft[2]=ge.top,ft[3]=1,Ni.transformMat4(ft,ft,Y),ft[3]=Math.max(ft[3],1e-5);const ni=new Fl(ft[0]/ft[3],ft[1]/ft[3],ft[2]/ft[3]);Qt.push(bi),te.push(ni)}Mt.push(Qt),Et.push(te)}return[Mt,Et]}(T,S,D,z,L,R,N,U,H):function(X,K,ot,$,Y){const at=[],ut=[],ct=Y[8]*K,bt=Y[9]*K,Mt=Y[10]*K,Et=Y[11]*K,ft=Y[8]*ot,kt=Y[9]*ot,Qt=Y[10]*ot,te=Y[11]*ot;for(const oe of X){const ce=[],Ce=[];for(const ge of oe){const bi=ge.x+$.x,ni=ge.y+$.y,De=Y[0]*bi+Y[4]*ni+Y[12],we=Y[1]*bi+Y[5]*ni+Y[13],ye=Y[2]*bi+Y[6]*ni+Y[14],si=Y[3]*bi+Y[7]*ni+Y[15],pi=De+ct,$e=we+bt,qi=ye+Mt,An=Math.max(si+Et,1e-5),Ui=De+ft,nn=we+kt,Dn=ye+Qt,In=Math.max(si+te,1e-5);ce.push(new Fl(pi/An,$e/An,qi/An)),Ce.push(new Fl(Ui/In,nn/In,Dn/In))}at.push(ce),ut.push(Ce)}return[at,ut]}(T,S,D,z,L)}(o,n,h,u,c,s,y,d,_,o.center.lat,e.tileID.canonical),M=e.queryGeometry;return function(E,T,S){let D=1/0;Z1(S,T)&&(D=Qx(S,T[0]));for(let z=0;z<T.length;z++){const L=T[z],R=E[z];for(let N=0;N<L.length-1;N++){const U=L[N],H=[U,L[N+1],R[N+1],R[N],U];q1(S,H)&&(D=Math.min(D,Qx(S,H)))}}return D!==1/0&&D}(x,b,M.isPointQuery()?M.screenBounds:M.screenGeometry)}},line:class extends Rr{constructor(e,t){super(e,eb,t),this.gradientVersion=0}_handleSpecialPaintPropertyUpdate(e){if(e==="line-gradient"){const t=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=t._styleExpression&&t._styleExpression.expression instanceof Rf,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}widthExpression(){return this._transitionablePaint._values["line-width"].value.expression}recalculate(e,t){super.recalculate(e,t),this.paint._values["line-floorwidth"]=sb.possiblyEvaluate(this._transitioningPaint._values["line-width"].value,e)}createBucket(e){return new Xh(e)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getDefaultProgramParams(e,t){const i=rb(this);return{config:new Ia(this,t),defines:i,overrideFog:!1}}queryRadius(e){const t=e,i=ab(Ml("line-width",this,t),Ml("line-gap-width",this,t)),n=Ml("line-offset",this,t);return i/2+Math.abs(n)+vh(this.paint.get("line-translate"))}queryIntersectsFeature(e,t,i,n,r,o){if(e.queryGeometry.isAboveHorizon)return!1;const s=X1(e.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),o.angle,e.pixelToTileUnitsFactor),a=e.pixelToTileUnitsFactor/2*ab(this.paint.get("line-width").evaluate(t,i),this.paint.get("line-gap-width").evaluate(t,i)),l=this.paint.get("line-offset").evaluate(t,i);return l&&(n=function(c,u){const h=[],d=new G(0,0);for(let p=0;p<c.length;p++){const _=c[p],g=[];for(let y=0;y<_.length;y++){const x=_[y],b=_[y+1],M=y===0?d:x.sub(_[y-1])._unit()._perp(),E=y===_.length-1?d:b.sub(x)._unit()._perp(),T=M._add(E)._unit();T._mult(1/(T.x*E.x+T.y*E.y)),g.push(T._mult(u)._add(x))}h.push(g)}return h}(n,l*e.pixelToTileUnitsFactor)),function(c,u,h){for(let d=0;d<u.length;d++){const p=u[d];if(c.length>=3){for(let _=0;_<p.length;_++)if(Hs(c,p[_]))return!0}if(HE(c,p,h))return!0}return!1}(s,n,a)}isTileClipped(){return!0}},symbol:Gh,background:class extends Rr{constructor(e,t){super(e,oI,t)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}getDefaultProgramParams(e,t){return{overrideFog:!1}}},raster:class extends Rr{constructor(e,t){super(e,aI,t),this._updateColorRamp()}getProgramIds(){return["raster"]}hasColorMap(){return!!this._transitionablePaint._values["raster-color"].value.value}isLayerDraped(e){return!(e&&e._source instanceof to)||!e._source.onNorthPole&&!e._source.onSouthPole&&this.paint.get("raster-elevation")===0}_handleSpecialPaintPropertyUpdate(e){e!=="raster-color"&&e!=="raster-color-range"||this._updateColorRamp()}_updateColorRamp(){if(!this.hasColorMap())return;const e=this._transitionablePaint._values["raster-color"].value.expression,[t,i]=this._transitionablePaint._values["raster-color-range"].value.expression.evaluate({zoom:0});this.colorRamp=xh({expression:e,evaluationKey:"rasterValue",image:this.colorRamp,clips:[{start:t,end:i}],resolution:256}),this.colorRampTexture=null}},sky:class extends Rr{constructor(e,t){super(e,uI,t),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(e){e==="sky-gradient"?this._updateColorRamp():e!=="sky-atmosphere-sun"&&e!=="sky-atmosphere-halo-color"&&e!=="sky-atmosphere-color"&&e!=="sky-atmosphere-sun-intensity"||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=xh({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(e){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){const t=e.style.light.properties.get("position");return this._lightPosition.azimuthal!==t.azimuthal||this._lightPosition.polar!==t.polar}return!1}getCenter(e,t){if(this.paint.get("sky-type")==="atmosphere"){const n=this.paint.get("sky-atmosphere-sun"),r=!n,o=e.style.light,s=o.properties.get("position");return r&&o.properties.get("anchor")==="viewport"&&J("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),r?Xm(s.azimuthal,90-s.polar,t):Xm(n[0],90-n[1],t)}const i=this.paint.get("sky-gradient-center");return Xm(i[0],90-i[1],t)}isSky(){return!0}markSkyboxValid(e){this._skyboxInvalidated=!1,this._lightPosition=e.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){const e=this.paint.get("sky-type");return e==="atmosphere"?["skyboxCapture","skybox"]:e==="gradient"?["skyboxGradient"]:null}},slot:class extends Rr{constructor(e,t){super(e,hI)}},model:class extends Rr{constructor(e,t){super(e,N3,t)}createBucket(e){return new Dx(e)}getProgramIds(){return["model"]}is3D(){return!0}hasShadowPass(){return!0}canCastShadows(){return!0}hasLightBeamPass(){return!0}cutoffRange(){return this.paint.get("model-cutoff-fade-range")}queryRadius(){return 0}queryIntersectsFeature(){return!1}_handleOverridablePaintPropertyUpdate(e,t,i){return!(!this.layout||t.isDataDriven()||i.isDataDriven()||e!=="model-color"&&e!=="model-color-mix-intensity"&&e!=="model-rotation"&&e!=="model-scale"&&e!=="model-translation"&&e!=="model-emissive-strength")}_isPropertyZoomDependent(e){const t=this._transitionablePaint._values[e];return t!=null&&t.value!=null&&t.value.expression!=null&&t.value.expression instanceof ks}isZoomDependent(){return this._isPropertyZoomDependent("model-scale")||this._isPropertyZoomDependent("model-rotation")||this._isPropertyZoomDependent("model-translation")}}};function ad(e,t){return e.type==="custom"?new lI(e):new dI[e.type](e,t)}function fI(e){const{userImage:t}=e;return!!(t&&t.render&&t.render())&&(e.data.replace(new Uint8Array(t.data.buffer)),!0)}class pI extends Mn{constructor(){super(),this.images={},this.updatedImages={},this.callbackDispatchedThisFrame={},this.loaded={},this.requestors=[],this.patterns={},this.atlasImage={},this.atlasTexture={},this.dirty=!0}createScope(t){this.images[t]={},this.loaded[t]=!1,this.updatedImages[t]={},this.patterns[t]={},this.callbackDispatchedThisFrame[t]={},this.atlasImage[t]=new Ln({width:1,height:1})}isLoaded(){for(const t in this.loaded)if(!this.loaded[t])return!1;return!0}setLoaded(t,i){if(this.loaded[i]!==t&&(this.loaded[i]=t,t)){for(const{ids:n,callback:r}of this.requestors)this._notify(n,i,r);this.requestors=[]}}hasImage(t,i){return!!this.getImage(t,i)}getImage(t,i){return this.images[i][t]}addImage(t,i,n){this._validate(t,n)&&(this.images[i][t]=n)}_validate(t,i){let n=!0;return this._validateStretch(i.stretchX,i.data&&i.data.width)||(this.fire(new Ae(new Error(`Image "${t}" has invalid "stretchX" value`))),n=!1),this._validateStretch(i.stretchY,i.data&&i.data.height)||(this.fire(new Ae(new Error(`Image "${t}" has invalid "stretchY" value`))),n=!1),this._validateContent(i.content,i)||(this.fire(new Ae(new Error(`Image "${t}" has invalid "content" value`))),n=!1),n}_validateStretch(t,i){if(!t)return!0;let n=0;for(const r of t){if(r[0]<n||r[1]<r[0]||i<r[1])return!1;n=r[1]}return!0}_validateContent(t,i){return!(t&&(t.length!==4||t[0]<0||i.data.width<t[0]||t[1]<0||i.data.height<t[1]||t[2]<0||i.data.width<t[2]||t[3]<0||i.data.height<t[3]||t[2]<t[0]||t[3]<t[1]))}updateImage(t,i,n){n.version=this.images[i][t].version+1,this.images[i][t]=n,this.updatedImages[i][t]=!0}removeImage(t,i){const n=this.images[i][t];delete this.images[i][t],delete this.patterns[i][t],n.userImage&&n.userImage.onRemove&&n.userImage.onRemove()}listImages(t){return Object.keys(this.images[t])}getImages(t,i,n){let r=!0;const o=!!this.loaded[i];if(!o)for(const s of t)this.images[i][s]||(r=!1);o||r?this._notify(t,i,n):this.requestors.push({ids:t,scope:i,callback:n})}getUpdatedImages(t){return this.updatedImages[t]}_notify(t,i,n){const r={};for(const o of t){this.images[i][o]||this.fire(new jt("styleimagemissing",{id:o}));const s=this.images[i][o];s?r[o]={data:s.data.clone(),pixelRatio:s.pixelRatio,sdf:s.sdf,version:s.version,stretchX:s.stretchX,stretchY:s.stretchY,content:s.content,hasRenderCallback:!!(s.userImage&&s.userImage.render)}:J(`Image "${o}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`)}n(null,r)}getPixelSize(t){const{width:i,height:n}=this.atlasImage[t];return{width:i,height:n}}getPattern(t,i){const n=this.patterns[i][t],r=this.getImage(t,i);if(!r)return null;if(n&&n.position.version===r.version)return n.position;if(n)n.position.version=r.version;else{const o={w:r.data.width+2,h:r.data.height+2,x:0,y:0},s=new Cm(o,r);this.patterns[i][t]={bin:o,position:s}}return this._updatePatternAtlas(i),this.patterns[i][t].position}bind(t,i){const n=t.gl;let r=this.atlasTexture[i];r?this.dirty&&(r.update(this.atlasImage[i]),this.dirty=!1):(r=new mn(t,this.atlasImage[i],n.RGBA),this.atlasTexture[i]=r),r.bind(n.LINEAR,n.CLAMP_TO_EDGE)}_updatePatternAtlas(t){const i=[];for(const s in this.patterns[t])i.push(this.patterns[t][s].bin);const{w:n,h:r}=Im(i),o=this.atlasImage[t];o.resize({width:n||1,height:r||1});for(const s in this.patterns[t]){const{bin:a}=this.patterns[t][s],l=a.x+1,c=a.y+1,u=this.images[t][s].data,h=u.width,d=u.height;Ln.copy(u,o,{x:0,y:0},{x:l,y:c},{width:h,height:d}),Ln.copy(u,o,{x:0,y:d-1},{x:l,y:c-1},{width:h,height:1}),Ln.copy(u,o,{x:0,y:0},{x:l,y:c+d},{width:h,height:1}),Ln.copy(u,o,{x:h-1,y:0},{x:l-1,y:c},{width:1,height:d}),Ln.copy(u,o,{x:0,y:0},{x:l+h,y:c},{width:1,height:d})}this.dirty=!0}beginFrame(){for(const t in this.images)this.callbackDispatchedThisFrame[t]={}}dispatchRenderCallbacks(t,i){for(const n of t){if(this.callbackDispatchedThisFrame[i][n])continue;this.callbackDispatchedThisFrame[i][n]=!0;const r=this.images[i][n];fI(r)&&this.updateImage(n,i,r)}}}const mI=new wn({anchor:new Gt(rt.light.anchor),position:new class{constructor(e){this.specification=e}possiblyEvaluate(e,t){return ee(e.expression.evaluate(t))}interpolate(e,t,i){return{x:ze(e.x,t.x,i),y:ze(e.y,t.y,i),z:ze(e.z,t.z,i),azimuthal:ze(e.azimuthal,t.azimuthal,i),polar:ze(e.polar,t.polar,i)}}}(rt.light.position),color:new Gt(rt.light.color),intensity:new Gt(rt.light.intensity)});class cb extends Mn{constructor(t,i="flat"){super(),this._transitionable=new Sc(mI),this.setLight(t,i),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(t,i,n={}){this._validate(FM,t,n)||(this._transitionable.setTransitionOrValue(t),this.id=i)}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}_validate(t,i,n){return(!n||n.validate!==!1)&&$u(this,t.call(dl,Vt({value:i,style:{glyphs:!0,sprite:!0},styleSpec:rt})))}}const _I=new wn({source:new Gt(rt.terrain.source),exaggeration:new Gt(rt.terrain.exaggeration)});let gI=class extends Mn{constructor(e,t,i,n){super(),this.scope=i,this._transitionable=new Sc(_I,n),this._transitionable.setTransitionOrValue(e,n),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=t}get(){return this._transitionable.serialize()}set(e,t){this._transitionable.setTransitionOrValue(e,t)}updateTransitions(e){this._transitioning=this._transitionable.transitioned(e,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(e){this.properties=this._transitioning.possiblyEvaluate(e)}getExaggeration(e){return this._transitioning.possiblyEvaluate(new dn(e)).get("exaggeration")}isZoomDependent(){const e=this._transitionable._values.exaggeration;return e!=null&&e.value!=null&&e.value.expression!=null&&e.value.expression instanceof ks}};const ub=45,hb=65,Oa=.05;function ld(e,t,i,n){const r=Fe(ub,hb,i),[o,s]=db(e,n);let a=1-Math.min(1,Math.exp((t-o)/(s-o)*-6));return a*=a*a,a=Math.min(1,1.00747*a),a*r*e.alpha}function db(e,t){const i=.5/Math.tan(.5*t);return[e.range[0]+i,e.range[1]+i]}function fb(e,t,i,n,r){const o=Z.transformMat4([],[t,i,n],r.mercatorFogMatrix);return ld(e,Z.length(o),r.pitch,r._fov)}function pb(e,t,i,n,r,o,s){const a=[[i,n,0],[r,n,0],[r,o,0],[i,o,0]];let l=Number.MAX_VALUE,c=-Number.MAX_VALUE;for(const u of a){const h=Z.transformMat4([],u,t),d=Z.length(h);l=Math.min(l,d),c=Math.max(c,d)}return[ld(e,l,s.pitch,s._fov),ld(e,c,s.pitch,s._fov)]}const yI=new wn({range:new Gt(rt.fog.range),color:new Gt(rt.fog.color),"high-color":new Gt(rt.fog["high-color"]),"space-color":new Gt(rt.fog["space-color"]),"horizon-blend":new Gt(rt.fog["horizon-blend"]),"star-intensity":new Gt(rt.fog["star-intensity"]),"vertical-range":new Gt(rt.fog["vertical-range"])});class vI extends Mn{constructor(t,i){super(),this._transitionable=new Sc(yI),this.set(t),this._transitioning=this._transitionable.untransitioned(),this._transform=i}get state(){const t=this._transform,i=t.projection.name==="globe",n=Wn(t.zoom),r=this.properties.get("range"),o=[.5,3];return{range:i?[ze(o[0],r[0],n),ze(o[1],r[1],n)]:r,horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(t,i={}){if(this._validate(VM,t,i))return;const n=Vt({},t);for(const r of Object.keys(rt.fog))n[r]===void 0&&(n[r]=rt.fog[r].default);this._transitionable.setTransitionOrValue(n)}getOpacity(t){if(!this._transform.projection.supportsFog)return 0;const i=this.properties&&this.properties.get("color")||1;return(this._transform.projection.name==="globe"?1:Fe(ub,hb,t))*i.a}getOpacityAtLatLng(t,i){return this._transform.projection.supportsFog?function(n,r,o){const s=ui.fromLngLat(r),a=o.elevation?o.elevation.getAtPointOrZero(s):0;return fb(n,s.x,s.y,a,o)}(this.state,t,i):0}getOpacityForTile(t){if(!this._transform.projection.supportsFog)return[1,1];const i=this._transform.calculateFogTileMatrix(t.toUnwrapped());return pb(this.state,i,0,0,pt,pt,this._transform)}getOpacityForBounds(t,i,n,r,o){return this._transform.projection.supportsFog?pb(this.state,t,i,n,r,o,this._transform):[1,1]}getFovAdjustedRange(t){return this._transform.projection.supportsFog?db(this.state,t):[0,1]}isVisibleOnFrustum(t){if(!this._transform.projection.supportsFog)return!1;const i=[4,5,6,7];for(const n of i){const r=t.points[n];let o;if(r[2]>=0)o=r;else{const s=t.points[n-4];o=jg(s,r,s[2]/(s[2]-r[2]))}if(fb(this.state,o[0],o[1],0,this._transform)>=Oa)return!0}return!1}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}_validate(t,i,n){return(!n||n.validate!==!1)&&$u(this,t.call(dl,Vt({value:i,style:{glyphs:!0,sprite:!0},styleSpec:rt})))}}class xI{constructor(t){this._callback=t,this._triggered=!1,typeof MessageChannel<"u"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout(()=>{this._triggered=!1,this._callback()},0))}remove(){this._channel=void 0,this._callback=()=>{}}}class bI{constructor(){this.tasks={},this.taskQueue=[],Xe(["process"],this),this.invoker=new xI(this.process),this.nextId=0}add(t,i){const n=this.nextId++,r=function({type:o,isSymbolTile:s,zoom:a}){return a=a||0,o==="message"?0:o!=="maybePrepare"||s?o!=="parseTile"||s?o==="parseTile"&&s?300-a:o==="maybePrepare"&&s?400-a:500:200-a:100-a}(i);if(r===0){Pt();try{t()}finally{}return{cancel:()=>{}}}return this.tasks[n]={fn:t,metadata:i,priority:r,id:n},this.taskQueue.push(n),this.invoker.trigger(),{cancel:()=>{delete this.tasks[n]}}}process(){Pt();try{if(this.taskQueue=this.taskQueue.filter(n=>!!this.tasks[n]),!this.taskQueue.length)return;const t=this.pick();if(t===null)return;const i=this.tasks[t];if(delete this.tasks[t],this.taskQueue.length&&this.invoker.trigger(),!i)return;i.fn()}finally{}}pick(){let t=null,i=1/0;for(let r=0;r<this.taskQueue.length;r++){const o=this.tasks[this.taskQueue[r]];o.priority<i&&(i=o.priority,t=r)}if(t===null)return null;const n=this.taskQueue[t];return this.taskQueue.splice(t,1),n}remove(){this.invoker.remove()}}class mb{constructor(t,i,n){this.target=t,this.parent=i,this.mapId=n,this.callbacks={},this.cancelCallbacks={},Xe(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.scheduler=new bI}send(t,i,n,r,o=!1,s){const a=Math.round(1e18*Math.random()).toString(36).substring(0,10);n&&(n.metadata=s,this.callbacks[a]=n);const l=new Set;return this.target.postMessage({id:a,type:t,hasCallback:!!n,targetMapId:r,mustQueue:o,sourceMapId:this.mapId,data:pl(i,l)},l),{cancel:()=>{n&&delete this.callbacks[a],this.target.postMessage({id:a,type:"<cancel>",targetMapId:r,sourceMapId:this.mapId})}}}receive(t){const i=t.data,n=i.id;if(n&&(!i.targetMapId||this.mapId===i.targetMapId))if(i.type==="<cancel>"){const r=this.cancelCallbacks[n];delete this.cancelCallbacks[n],r&&r.cancel()}else if(i.mustQueue||Pt()){const r=this.callbacks[n];this.cancelCallbacks[n]=this.scheduler.add(()=>this.processTask(n,i),r&&r.metadata||{type:"message"})}else this.processTask(n,i)}processTask(t,i){if(i.type==="<response>"){const n=this.callbacks[t];delete this.callbacks[t],n&&(i.error?n(ml(i.error)):n(null,ml(i.data)))}else{const n=new Set,r=i.hasCallback?(s,a)=>{delete this.cancelCallbacks[t],this.target.postMessage({id:t,type:"<response>",sourceMapId:this.mapId,error:s?pl(s):null,data:pl(a,n)},n)}:s=>{},o=ml(i.data);if(this.parent[i.type])this.parent[i.type](i.sourceMapId,o,r);else if(this.parent.getWorkerSource){const s=i.type.split(".");this.parent.getWorkerSource(i.sourceMapId,s[0],o.source,o.scope)[s[1]](o,r)}else r(new Error(`Could not find function ${i.type}`))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}}class Ba{constructor(t,i){this.workerPool=t,this.actors=[],this.currentActor=0,this.id=ae();const n=this.workerPool.acquire(this.id);for(let r=0;r<n.length;r++){const o=new Ba.Actor(n[r],i,this.id);o.name=`Worker ${r}`,this.actors.push(o)}this.ready=!1,this.broadcast("checkIfReady",null,()=>{this.ready=!0})}broadcast(t,i,n){Ii(this.actors,(r,o)=>{r.send(t,i,o)},n=n||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach(t=>{t.remove()}),this.actors=[],this.workerPool.release(this.id)}}Ba.Actor=mb;class _b extends Mn{constructor(t,i,n,r){super(),this.scope=n,this._options=t,this.properties=new Ac(i),this._transitionable=new Sc(i,new Map(r)),this._transitionable.setTransitionOrValue(t.properties),this._transitioning=this._transitionable.untransitioned()}updateConfig(t){this._transitionable.setTransitionOrValue(this._options.properties,new Map(t))}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}get(){return this._options.properties=this._transitionable.serialize(),this._options}set(t,i){this._options=t,this._transitionable.setTransitionOrValue(t.properties,i)}shadowsEnabled(){return!!this.properties&&this.properties.get("cast-shadows")===!0}}const wI=new wn({color:new Gt(rt.properties_light_ambient.color),intensity:new Gt(rt.properties_light_ambient.intensity)}),TI=new wn({direction:new class{constructor(e){this.specification=e}possiblyEvaluate(e,t){return function([i,n]){const r=ee([1,i,n]);return{x:r.x,y:r.y,z:r.z}}(e.expression.evaluate(t))}interpolate(e,t,i){return{x:ze(e.x,t.x,i),y:ze(e.y,t.y,i),z:ze(e.z,t.z,i)}}}(rt.properties_light_directional.direction),color:new Gt(rt.properties_light_directional.color),intensity:new Gt(rt.properties_light_directional.intensity),"cast-shadows":new Gt(rt.properties_light_directional["cast-shadows"]),"shadow-intensity":new Gt(rt.properties_light_directional["shadow-intensity"])});class Ym{constructor(t,i,n,r){this.screenBounds=t,this.cameraPoint=i,this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=n,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this._bufferedScreenMercator(0,r)}static createFromScreenPoints(t,i){let n,r;if(t instanceof G||typeof t[0]=="number"){const o=G.convert(t);n=[o],r=i.isPointAboveHorizon(o)}else{const o=G.convert(t[0]),s=G.convert(t[1]);n=[o,s],r=We(o,s).every(a=>i.isPointAboveHorizon(a))}return new Ym(n,i.getCameraPoint(),r,i)}isPointQuery(){return this.screenBounds.length===1}bufferedScreenGeometry(t){return We(this.screenBounds[0],this.screenBounds.length===1?this.screenBounds[0]:this.screenBounds[1],t)}bufferedCameraGeometry(t){const i=this.screenBounds[0],n=this.screenBounds.length===1?this.screenBounds[0].add(new G(1,1)):this.screenBounds[1],r=We(i,n,0,!1);return this.cameraPoint.y>n.y&&(this.cameraPoint.x>i.x&&this.cameraPoint.x<n.x?r.splice(3,0,this.cameraPoint):this.cameraPoint.x>=n.x?r[2]=this.cameraPoint:this.cameraPoint.x<=i.x&&(r[3]=this.cameraPoint)),function(o,s){const a=[];for(let l=0;l<o.length;l++){const c=Me(l-1,-1,o.length-1),u=Me(l+1,-1,o.length-1),h=o[l],d=o[u],p=o[c].sub(h).unit(),_=d.sub(h).unit(),g=_.angleWithSep(p.x,p.y),y=p.add(_).unit().mult(-1*s/Math.sin(g/2));a.push(h.add(y))}return a}(r,t)}bufferedCameraGeometryGlobe(t){const i=this.screenBounds[0],n=this.screenBounds.length===1?this.screenBounds[0].add(new G(1,1)):this.screenBounds[1],r=We(i,n,t),o=this.cameraPoint.clone();switch(3*((o.y>i.y)+(o.y>n.y))+((o.x>i.x)+(o.x>n.x))){case 0:r[0]=o,r[4]=o.clone();break;case 1:r.splice(1,0,o);break;case 2:r[1]=o;break;case 3:r.splice(4,0,o);break;case 5:r.splice(2,0,o);break;case 6:r[3]=o;break;case 7:r.splice(3,0,o);break;case 8:r[2]=o}return r}containsTile(t,i,n,r=0){const o=t.queryPadding/i._pixelsPerMercatorPixel+1,s=n?this._bufferedCameraMercator(o,i):this._bufferedScreenMercator(o,i);let a=t.tileID.wrap+(s.unwrapped?r:0);const l=s.polygon.map(y=>Yv(t.tileTransform,y,a));if(!$1(l,0,0,pt,pt))return;a=t.tileID.wrap+(this.screenGeometryMercator.unwrapped?r:0);const c=this.screenGeometryMercator.polygon.map(y=>Kv(t.tileTransform,y,a)),u=c.map(y=>new G(y[0],y[1])),h=i.getFreeCameraOptions().position||new ui(0,0,0),d=Kv(t.tileTransform,h,a),p=c.map(y=>{const x=Z.sub(y,y,d);return Z.normalize(x,x),new hh(d,x)}),_=za(t,1,i.zoom)*i._pixelsPerMercatorPixel;return{queryGeometry:this,tilespaceGeometry:u,tilespaceRays:p,bufferedTilespaceGeometry:l,bufferedTilespaceBounds:(g=Je(l),g.min.x=Lt(g.min.x,0,pt),g.min.y=Lt(g.min.y,0,pt),g.max.x=Lt(g.max.x,0,pt),g.max.y=Lt(g.max.y,0,pt),g),tile:t,tileID:t.tileID,pixelToTileUnitsFactor:_};var g}_bufferedScreenMercator(t,i){const n=gb(t);if(this._screenRaycastCache[n])return this._screenRaycastCache[n];{let r;return r=i.projection.name==="globe"?this._projectAndResample(this.bufferedScreenGeometry(t),i):{polygon:this.bufferedScreenGeometry(t).map(o=>i.pointCoordinate3D(o)),unwrapped:!0},this._screenRaycastCache[n]=r,r}}_bufferedCameraMercator(t,i){const n=gb(t);if(this._cameraRaycastCache[n])return this._cameraRaycastCache[n];{let r;return r=i.projection.name==="globe"?this._projectAndResample(this.bufferedCameraGeometryGlobe(t),i):{polygon:this.bufferedCameraGeometry(t).map(o=>i.pointCoordinate3D(o)),unwrapped:!0},this._cameraRaycastCache[n]=r,r}}_projectAndResample(t,i){const n=function(o,s){const a=st.multiply([],s.pixelMatrix,s.globeMatrix),l=[0,-dr,0,1],c=[0,dr,0,1],u=[0,0,0,1];Ni.transformMat4(l,l,a),Ni.transformMat4(c,c,a),Ni.transformMat4(u,u,a);const h=new G(l[0]/l[3],l[1]/l[3]),d=new G(c[0]/c[3],c[1]/c[3]),p=Hs(o,h)&&l[3]<u[3],_=Hs(o,d)&&c[3]<u[3];if(!p&&!_)return null;const g=function(D,z,L){for(let R=1;R<D.length;R++){const N=au(z.pointCoordinate3D(D[R-1]).x),U=au(z.pointCoordinate3D(D[R]).x);if(L<0){if(N<U)return{idx:R,t:-N/(U-1-N)}}else if(U<N)return{idx:R,t:(1-N)/(U+1-N)}}return null}(o,s,p?-1:1);if(!g)return null;const{idx:y,t:x}=g;let b=y>1?Km(o.slice(0,y),s):[],M=y<o.length?Km(o.slice(y),s):[];b=b.map(D=>new G(au(D.x),D.y)),M=M.map(D=>new G(au(D.x),D.y));const E=[...b];E.length===0&&E.push(M[M.length-1]);const T=ze(E[E.length-1].y,(M.length===0?b[0]:M[0]).y,x);let S;return S=p?[new G(0,T),new G(0,0),new G(1,0),new G(1,T)]:[new G(1,T),new G(1,1),new G(0,1),new G(0,T)],E.push(...S),M.length===0?E.push(b[0]):E.push(...M),{polygon:E.map(D=>new ui(D.x,D.y)),unwrapped:!1}}(t,i);if(n)return n;const r=function(o,s){let a=!1,l=-1/0,c=0;for(let h=0;h<o.length-1;h++)o[h].x>l&&(l=o[h].x,c=h);for(let h=0;h<o.length-1;h++){const d=(c+h)%(o.length-1),p=o[d],_=o[d+1];Math.abs(p.x-_.x)>.5&&(p.x<_.x?(p.x+=1,d===0&&(o[o.length-1].x+=1)):(_.x+=1,d+1===o.length-1&&(o[0].x+=1)),a=!0)}const u=Fn(s.center.lng);return a&&u<Math.abs(u-1)&&o.forEach(h=>{h.x-=1}),{polygon:o,unwrapped:a}}(Km(t,i).map(o=>new G(au(o.x),o.y)),i);return{polygon:r.polygon.map(o=>new ui(o.x,o.y)),unwrapped:r.unwrapped}}}function Km(e,t){return j1(e,i=>{const n=t.pointCoordinate3D(i);i.x=n.x,i.y=n.y},1/256)}function au(e){return e<0?1+e%1:e%1}function gb(e){return 100*e|0}function Jm(e,t,i,n,r){const o=function(s,a){if(s)return r(s);if(a){e.url&&a.tiles&&e.tiles&&delete e.tiles;const l=Ve(Vt(a,e),["tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","scheme","tileSize","encoding"]);a.vector_layers&&(l.vectorLayers=a.vector_layers,l.vectorLayerIds=l.vectorLayers.map(c=>c.id)),l.tiles=t.canonicalizeTileset(l,e.url),r(null,l)}};return e.url?Ut(t.transformRequest(t.normalizeSourceURL(e.url,null,i,n),xt.Source),o):ke.frame(()=>o(null,e))}class cd{constructor(t,i,n){this.bounds=Er.convert(this.validateBounds(t)),this.minzoom=i||0,this.maxzoom=n||24}validateBounds(t){return Array.isArray(t)&&t.length===4?[Math.max(-180,t[0]),Math.max(-90,t[1]),Math.min(180,t[2]),Math.min(90,t[3])]:[-180,-90,180,90]}contains(t){const i=Math.pow(2,t.z),n=Math.floor(Fn(this.bounds.getWest())*i),r=Math.floor(jn(this.bounds.getNorth())*i),o=Math.ceil(Fn(this.bounds.getEast())*i),s=Math.ceil(jn(this.bounds.getSouth())*i);return t.x>=n&&t.x<o&&t.y>=r&&t.y<s}}class yb{constructor(t,i){this.width=t,this.height=i,this.nextRow=0,this.image=new hs({width:t,height:i}),this.positions={},this.uploaded=!1}getDash(t,i){const n=this.getKey(t,i);return this.positions[n]}trim(){const t=this.width,i=this.height=Oe(this.nextRow);this.image.resize({width:t,height:i})}getKey(t,i){return t.join(",")+i}getDashRanges(t,i,n){const r=[];let o=t.length%2==1?-t[t.length-1]*n:0,s=t[0]*n,a=!0;r.push({left:o,right:s,isDash:a,zeroLength:t[0]===0});let l=t[0];for(let c=1;c<t.length;c++){a=!a;const u=t[c];o=l*n,l+=u,s=l*n,r.push({left:o,right:s,isDash:a,zeroLength:u===0})}return r}addRoundDash(t,i,n){const r=i/2;for(let o=-n;o<=n;o++){const s=this.width*(this.nextRow+n+o);let a=0,l=t[a];for(let c=0;c<this.width;c++){c/l.right>1&&(l=t[++a]);const u=Math.abs(c-l.left),h=Math.abs(c-l.right),d=Math.min(u,h);let p;const _=o/n*(r+1);if(l.isDash){const g=r-Math.abs(_);p=Math.sqrt(d*d+g*g)}else p=r-Math.sqrt(d*d+_*_);this.image.data[s+c]=Math.max(0,Math.min(255,p+128))}}}addRegularDash(t,i){for(let l=t.length-1;l>=0;--l){const c=t[l],u=t[l+1];c.zeroLength?t.splice(l,1):u&&u.isDash===c.isDash&&(u.left=c.left,t.splice(l,1))}const n=t[0],r=t[t.length-1];n.isDash===r.isDash&&(n.left=r.left-this.width,r.right=n.right+this.width);const o=this.width*this.nextRow;let s=0,a=t[s];for(let l=0;l<this.width;l++){l/a.right>1&&(a=t[++s]);const c=Math.abs(l-a.left),u=Math.abs(l-a.right),h=Math.min(c,u);this.image.data[o+l]=Math.max(0,Math.min(255,(a.isDash?h:-h)+i+128))}}addDash(t,i){const n=this.getKey(t,i);if(this.positions[n])return this.positions[n];const r=i==="round",o=r?7:0,s=2*o+1;if(this.nextRow+s>this.height)return J("LineAtlas out of space"),null;t.length===0&&t.push(1);let a=0;for(let u=0;u<t.length;u++)t[u]<0&&(J("Negative value is found in line dasharray, replacing values with 0"),t[u]=0),a+=t[u];if(a!==0){const u=this.width/a,h=this.getDashRanges(t,this.width,u);r?this.addRoundDash(h,u,o):this.addRegularDash(h,i==="square"?.5*u:0)}const l=this.nextRow+o;this.nextRow+=s;const c={tl:[l,o],br:[a,0]};return this.positions[n]=c,c}}he(yb,"LineAtlas");const vb=1*lo;class xb{constructor(t){const i={},n=[];for(const a in t){const l=t[a],c=i[a]={};for(const u in l.glyphs){const h=l.glyphs[+u];if(!h||h.bitmap.width===0||h.bitmap.height===0)continue;const d=h.metrics.localGlyph?vb:1,p={x:0,y:0,w:h.bitmap.width+2*d,h:h.bitmap.height+2*d};n.push(p),c[u]=p}}const{w:r,h:o}=Im(n),s=new hs({width:r||1,height:o||1});for(const a in t){const l=t[a];for(const c in l.glyphs){const u=l.glyphs[+c];if(!u||u.bitmap.width===0||u.bitmap.height===0)continue;const h=i[a][c],d=u.metrics.localGlyph?vb:1;hs.copy(u.bitmap,s,{x:0,y:0},{x:h.x+d,y:h.y+d},u.bitmap)}}this.image=s,this.positions=i}}he(xb,"GlyphAtlas");class MI{constructor(t){this.tileID=new Si(t.tileID.overscaledZ,t.tileID.wrap,t.tileID.canonical.z,t.tileID.canonical.x,t.tileID.canonical.y),this.tileZoom=t.tileZoom,this.uid=t.uid,this.zoom=t.zoom,this.canonical=t.tileID.canonical,this.pixelRatio=t.pixelRatio,this.tileSize=t.tileSize,this.source=t.source,this.scope=t.scope,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=t.showCollisionBoxes,this.collectResourceTiming=!!t.collectResourceTiming,this.promoteId=t.promoteId,this.isSymbolTile=t.isSymbolTile,this.tileTransform=ka(t.tileID.canonical,t.projection),this.projection=t.projection,this.brightness=t.brightness,this.extraShadowCaster=!!t.extraShadowCaster}parse(t,i,n,r,o){this.status="parsing",this.data=t,this.collisionBoxArray=new Dp;const s=new hv(Object.keys(t.layers).sort()),a=new Mm(this.tileID,this.promoteId);a.bucketLayerIDs=[];const l={},c=new yb(256,256),u={featureIndex:a,iconDependencies:{},patternDependencies:{},glyphDependencies:{},lineAtlas:c,availableImages:n,brightness:this.brightness},h=i.familiesBySource[this.source];for(const b in h){const M=t.layers[b];if(!M)continue;let E=!1,T=!1,S=!1;for(const L of h[b])L[0].type==="symbol"?E=!0:T=!0,L[0].is3D()&&L[0].type!=="model"&&(S=!0);if(this.extraShadowCaster&&!S||this.isSymbolTile===!0&&!E||this.isSymbolTile===!1&&!T)continue;M.version===1&&J(`Vector tile source "${this.source}" layer "${b}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const D=s.encode(b),z=[];for(let L=0;L<M.length;L++){const R=M.feature(L),N=a.getId(R,b);z.push({feature:R,id:N,index:L,sourceLayerIndex:D})}for(const L of h[b]){const R=L[0];(!this.extraShadowCaster||R.is3D()&&R.type!=="model")&&(this.isSymbolTile!==void 0&&R.type==="symbol"!==this.isSymbolTile||R.minzoom&&this.zoom<Math.floor(R.minzoom)||R.maxzoom&&this.zoom>=R.maxzoom||R.visibility!=="none"&&(Qm(L,this.zoom,u.brightness,n),(l[R.id]=R.createBucket({index:a.bucketLayerIDs.length,layers:L,zoom:this.zoom,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:D,sourceID:this.source,projection:this.projection.spec})).populate(z,u,this.tileID.canonical,this.tileTransform),a.bucketLayerIDs.push(L.map(N=>N.id))))}}let d,p,_,g;c.trim();const y={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},x=()=>{if(d)return this.status="done",o(d);if(this.extraShadowCaster)this.status="done",o(null,{buckets:Oi(l).filter(b=>!b.isEmpty()),featureIndex:a,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:u.brightness,glyphMap:null,iconMap:null,glyphPositions:null});else if(p&&_&&g){const b=new xb(p),M=new Vv(_,g);for(const E in l){const T=l[E];T instanceof Kc?(Qm(T.layers,this.zoom,u.brightness,n),xA(T,p,b.positions,_,M.iconPositions,this.showCollisionBoxes,n,this.tileID.canonical,this.tileZoom,this.projection,this.brightness)):T.hasPattern&&(T instanceof Xh||T instanceof Sh||T instanceof ou)&&(Qm(T.layers,this.zoom,u.brightness,n),T.addFeatures(u,this.tileID.canonical,M.patternPositions,n,this.tileTransform,this.brightness))}this.status="done",o(null,{buckets:Oi(l).filter(E=>!E.isEmpty()),featureIndex:a,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:b.image,lineAtlas:c,imageAtlas:M,brightness:u.brightness})}};if(!this.extraShadowCaster){const b=gi(u.glyphDependencies,T=>Object.keys(T).map(Number));Object.keys(b).length?r.send("getGlyphs",{uid:this.uid,stacks:b,scope:this.scope},(T,S)=>{d||(d=T,p=S,x())},void 0,!1,y):p={};const M=Object.keys(u.iconDependencies);M.length?r.send("getImages",{icons:M,source:this.source,scope:this.scope,tileID:this.tileID,type:"icons"},(T,S)=>{d||(d=T,_=S,x())},void 0,!1,y):_={};const E=Object.keys(u.patternDependencies);E.length?r.send("getImages",{icons:E,source:this.source,scope:this.scope,tileID:this.tileID,type:"patterns"},(T,S)=>{d||(d=T,g=S,x())},void 0,!1,y):g={}}x()}}function Qm(e,t,i,n){const r=new dn(t,{brightness:i});for(const o of e)o.recalculate(r,n)}class bb{constructor(t){this.entries={},this.scheduler=t}request(t,i,n,r){const o=this.entries[t]=this.entries[t]||{callbacks:[]};if(o.result){const[s,a]=o.result;return this.scheduler?this.scheduler.add(()=>{r(s,a)},i):r(s,a),()=>{}}return o.callbacks.push(r),o.cancel||(o.cancel=n((s,a)=>{o.result=[s,a];for(const l of o.callbacks)this.scheduler?this.scheduler.add(()=>{l(s,a)},i):l(s,a);setTimeout(()=>delete this.entries[t],3e3)})),()=>{o.result||(o.callbacks=o.callbacks.filter(s=>s!==r),o.callbacks.length||(o.cancel(),delete this.entries[t]))}}}function wb(e,t,i){const n=JSON.stringify(e.request);return e.data&&(this.deduped.entries[n]={result:[null,e.data]}),this.deduped.request(n,{type:"parseTile",isSymbolTile:e.isSymbolTile,zoom:e.tileZoom},r=>{const o=Ht(e.request,(s,a,l,c)=>{s?r(s):a&&r(null,{vectorTile:i?void 0:new wm(new kh(a)),rawData:a,cacheControl:l,expires:c})});return()=>{o.cancel(),r()}},t)}class Tb extends Mn{constructor(t,i,n,r){if(super(),this.id=t,this.dispatcher=n,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,Vt(this,Ve(i,["url","scheme","tileSize","promoteId"])),this._options=Vt({type:"vector"},i),this._collectResourceTiming=!!i.collectResourceTiming,this.tileSize!==512)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(r),this._tileWorkers={},this._deduped=new bb}load(t){this._loaded=!1,this.fire(new jt("dataloading",{dataType:"source"}));const i=Array.isArray(this.map._language)?this.map._language.join():this.map._language,n=this.map._worldview;this._tileJSONRequest=Jm(this._options,this.map._requestManager,i,n,(r,o)=>{this._tileJSONRequest=null,this._loaded=!0,r?(i&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${i}`),n&&n.length!==2&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${n}`),this.fire(new Ae(r))):o&&(Vt(this,o),o.bounds&&(this.tileBounds=new cd(o.bounds,this.minzoom,this.maxzoom)),Zo(o.tiles,this.map._requestManager._customAccessToken),this.fire(new jt("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new jt("data",{dataType:"source",sourceDataType:"content"}))),t&&t(r)})}loaded(){return this._loaded}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}onAdd(t){this.map=t,this.load()}reload(){this.cancelTileJSONRequest();const t=cr(this.id,this.scope);this.load(()=>this.map.style.clearSource(t))}setTiles(t){return this._options.tiles=t,this.reload(),this}setUrl(t){return this.url=t,this._options.url=t,this.reload(),this}onRemove(){this.cancelTileJSONRequest()}serialize(){return Vt({},this._options)}loadTile(t,i){const n=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme)),r={request:this.map._requestManager.transformRequest(n,xt.Tile),data:void 0,uid:t.uid,tileID:t.tileID,tileZoom:t.tileZoom,zoom:t.tileID.overscaledZ,tileSize:this.tileSize*t.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,pixelRatio:ke.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:t.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:t.isExtraShadowCaster};if(r.request.collectResourceTiming=this._collectResourceTiming,t.actor&&t.state!=="expired")t.state==="loading"?t.reloadCallback=i:t.request=t.actor.send("reloadTile",r,o.bind(this));else if(t.actor=this._tileWorkers[n]=this._tileWorkers[n]||this.dispatcher.getActor(),this.dispatcher.ready)t.request=t.actor.send("loadTile",r,o.bind(this),void 0,!0);else{const s=wb.call({deduped:this._deduped},r,(a,l)=>{a||!l?o.call(this,a):(r.data={cacheControl:l.cacheControl,expires:l.expires,rawData:l.rawData.slice(0)},t.actor&&t.actor.send("loadTile",r,o.bind(this),void 0,!0))},!0);t.request={cancel:s}}function o(s,a){return delete t.request,t.aborted?i(null):s&&s.status!==404?i(s):(a&&a.resourceTiming&&(t.resourceTiming=a.resourceTiming),this.map._refreshExpiredTiles&&a&&t.setExpiryData(a),t.loadVectorData(a,this.map.painter),Bn(this.dispatcher),i(null),void(t.reloadCallback&&(this.loadTile(t,t.reloadCallback),t.reloadCallback=null)))}}abortTile(t){t.request&&(t.request.cancel(),delete t.request),t.actor&&t.actor.send("abortTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(t){t.actor&&t.actor.send("removeTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope}),t.destroy()}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class t_ extends Mn{constructor(t,i,n,r){super(),this.id=t,this.dispatcher=n,this.setEventedParent(r),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=Vt({type:"raster"},i),Vt(this,Ve(i,["url","scheme","tileSize"]))}load(t){this._loaded=!1,this.fire(new jt("dataloading",{dataType:"source"})),this._tileJSONRequest=Jm(this._options,this.map._requestManager,null,null,(i,n)=>{this._tileJSONRequest=null,this._loaded=!0,i?this.fire(new Ae(i)):n&&(Vt(this,n),n.bounds&&(this.tileBounds=new cd(n.bounds,this.minzoom,this.maxzoom)),Zo(n.tiles),this.fire(new jt("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new jt("data",{dataType:"source",sourceDataType:"content"}))),t&&t(i)})}loaded(){return this._loaded}onAdd(t){this.map=t,this.load()}reload(){this.cancelTileJSONRequest();const t=cr(this.id,this.scope);this.load(()=>this.map.style.clearSource(t))}setTiles(t){return this._options.tiles=t,this.reload(),this}setUrl(t){return this.url=t,this._options.url=t,this.reload(),this}onRemove(){this.cancelTileJSONRequest()}serialize(){return Vt({},this._options)}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}loadTile(t,i){const n=ke.devicePixelRatio>=2,r=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),n,this.tileSize);t.request=Ee(this.map._requestManager.transformRequest(r,xt.Tile),(o,s,a,l)=>(delete t.request,t.aborted?(t.state="unloaded",i(null)):o?(t.state="errored",i(o)):s?(this.map._refreshExpiredTiles&&t.setExpiryData({cacheControl:a,expires:l}),t.setTexture(s,this.map.painter),t.state="loaded",Bn(this.dispatcher),void i(null)):i(null)))}abortTile(t,i){t.request&&(t.request.cancel(),delete t.request),i()}unloadTile(t,i){t.texture&&t.texture instanceof mn?(t.destroy(!0),t.texture&&t.texture instanceof mn&&this.map.painter.saveTileTexture(t.texture)):t.destroy(),i()}hasTransition(){return!1}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}function EI(){return kd.workerClass!=null?new kd.workerClass:new I.Worker(kd.workerUrl)}const e_="mapboxgl_preloaded_worker_pool";class Nl{constructor(){this.active={}}acquire(t){if(!this.workers)for(this.workers=[];this.workers.length<Nl.workerCount;)this.workers.push(new EI);return this.active[t]=!0,this.workers.slice()}release(t){delete this.active[t],this.workers&&this.numActive()===0&&(this.workers.forEach(i=>{i.terminate()}),this.workers=null)}isPreloaded(){return!!this.active[e_]}numActive(){return Object.keys(this.active).length}}let lu;function cu(){return lu||(lu=new Nl),lu}Nl.workerCount=2;let ud,i_,ho,n_=null;function Mb(){return Pt()&&self.worker&&self.worker.dracoUrl?self.worker.dracoUrl:i_||j.DRACO_URL}const r_=5123,o_=5126,s_={5120:Int8Array,5121:Uint8Array,5122:Int16Array,[r_]:Uint16Array,5125:Uint32Array,[o_]:Float32Array},SI={5120:"DT_INT8",5121:"DT_UINT8",5122:"DT_INT16",[r_]:"DT_UINT16",5125:"DT_UINT32",[o_]:"DT_FLOAT32"},a_={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};function Eb(e,t,i){const n=i.json.bufferViews.length,r=i.buffers.length;t.bufferView=n,i.json.bufferViews[n]={buffer:r,byteLength:e.byteLength},i.buffers[r]=e}const l_="KHR_draco_mesh_compression";function AI(e,t){const i=e.extensions&&e.extensions[l_];if(!i)return;const n=new ho.Decoder,r=Cb(t,i.bufferView),o=new ho.Mesh;if(!n.DecodeArrayToMesh(r,r.byteLength,o))throw new Error("Failed to decode Draco mesh");const s=t.json.accessors[e.indices],a=s_[s.componentType],l=s.count*a.BYTES_PER_ELEMENT,c=ho._malloc(l);a===Uint16Array?n.GetTrianglesUInt16Array(o,l,c):n.GetTrianglesUInt32Array(o,l,c),Eb(ho.memory.buffer.slice(c,c+l),s,t),ho._free(c);for(const u of Object.keys(i.attributes)){const h=n.GetAttributeByUniqueId(o,i.attributes[u]),d=t.json.accessors[e.attributes[u]],p=SI[d.componentType],_=d.count*a_[d.type]*s_[d.componentType].BYTES_PER_ELEMENT,g=ho._malloc(_);n.GetAttributeDataArrayForAllPoints(o,h,ho[p],_,g),Eb(ho.memory.buffer.slice(g,g+_),d,t),ho._free(g)}n.destroy(),o.destroy(),delete e.extensions[l_]}const Sb=1179937895,Ab=new TextDecoder("utf8");function Ib(e,t){return new URL(e,t).href}function II(e,t,i,n){return fetch(Ib(e.uri,n)).then(r=>r.arrayBuffer()).then(r=>{t.buffers[i]=r})}function Cb(e,t){const i=e.json.bufferViews[t];return new Uint8Array(e.buffers[i.buffer],i.byteOffset||0,i.byteLength)}function CI(e,t,i,n){if(e.uri){const r=Ib(e.uri,n);return fetch(r).then(o=>o.blob()).then(o=>I.createImageBitmap(o)).then(o=>{t.images[i]=o})}if(e.bufferView!==void 0){const r=Cb(t,e.bufferView),o=new I.Blob([r],{type:e.mimeType});return I.createImageBitmap(o).then(s=>{t.images[i]=s})}}function Db(e,t=0,i){const n={json:null,images:[],buffers:[]};if(new Uint32Array(e,t,1)[0]===Sb){const c=new Uint32Array(e,t);let u=2;const h=(c[u++]>>2)-3,d=c[u++]>>2;if(u++,n.json=JSON.parse(Ab.decode(c.subarray(u,u+d))),u+=d,u<h){const p=c[u++];u++;const _=t+(u<<2);n.buffers[0]=e.slice(_,_+p)}}else n.json=JSON.parse(Ab.decode(new Uint8Array(e,t)));const{buffers:r,images:o,meshes:s,extensionsUsed:a}=n.json;let l=Promise.resolve();if(r){const c=[];for(let u=0;u<r.length;u++){const h=r[u];h.uri?c.push(II(h,n,u,i)):n.buffers[u]||(n.buffers[u]=null)}l=Promise.all(c)}return l.then(()=>{const c=[],u=a&&a.includes(l_);if(u&&c.push(function(){if(!ho)return ud||(ud=function(h){let d,p=null;function _(){d=new Uint8Array(p.buffer)}function g(){throw new Error("Unexpected Draco error.")}const y={a:{a:g,d:function(x,b,M){return d.copyWithin(x,b,b+M)},c:function(x){const b=d.length,M=Math.max(x>>>0,Math.ceil(1.2*b)),E=Math.ceil((M-b)/65536);try{return p.grow(E),_(),!0}catch{return!1}},b:g}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(h,y):h.then(x=>x.arrayBuffer()).then(x=>WebAssembly.instantiate(x,y))).then(x=>{const{Rb:b,Qb:M,P:E,T,X:S,Ja:D,La:z,Qa:L,Va:R,Wa:N,eb:U,jb:H,f:O,e:X,yb:K,zb:ot,Ab:$,Bb:Y,Db:at,Gb:ut}=x.instance.exports;p=X;const ct=(()=>{let bt=0,Mt=0,Et=0,ft=0;return kt=>{Et&&(b(ft),b(bt),Mt+=Et,Et=bt=0),bt||(Mt+=128,bt=M(Mt));const Qt=kt.length+7&-8;let te=bt;Qt>=Mt&&(Et=Qt,te=ft=M(Qt));for(let oe=0;oe<kt.length;oe++)d[te+oe]=kt[oe];return te}})();return _(),O(),{memory:X,_free:b,_malloc:M,Mesh:class{constructor(){this.ptr=E()}destroy(){T(this.ptr)}},Decoder:class{constructor(){this.ptr=D()}destroy(){H(this.ptr)}DecodeArrayToMesh(bt,Mt,Et){const ft=ct(bt),kt=z(this.ptr,ft,Mt,Et.ptr);return!!S(kt)}GetAttributeByUniqueId(bt,Mt){return{ptr:L(this.ptr,bt.ptr,Mt)}}GetTrianglesUInt16Array(bt,Mt,Et){R(this.ptr,bt.ptr,Mt,Et)}GetTrianglesUInt32Array(bt,Mt,Et){N(this.ptr,bt.ptr,Mt,Et)}GetAttributeDataArrayForAllPoints(bt,Mt,Et,ft,kt){U(this.ptr,bt.ptr,Mt.ptr,Et,ft,kt)}},DT_INT8:K(),DT_UINT8:ot(),DT_INT16:$(),DT_UINT16:Y(),DT_UINT32:at(),DT_FLOAT32:ut()}})}(fetch(Mb())),ud.then(h=>{ho=h,ud=void 0}))}()),o)for(let h=0;h<o.length;h++)c.push(CI(o[h],n,h,i));return(c.length?Promise.all(c):Promise.resolve()).then(()=>{if(u&&s)for(const{primitives:h}of s)for(const d of h)AI(d,n);return n})})}function Pb(e){return fetch(e).then(t=>t.arrayBuffer()).then(t=>Db(t,0,e))}class kb{constructor(t,i,n){if(this.triangleCount=i.length/3,this.min=new G(0,0),this.max=new G(0,0),this.xScale=0,this.yScale=0,this.cellsX=0,this.cellsY=0,this.cells=[],this.payload=[],this.triangleCount===0||t.length===0||n===0)return;const r=t.map(u=>u.x),o=t.map(u=>u.y);this.min=new G(Math.min(...r),Math.min(...o)),this.max=new G(Math.max(...r),Math.max(...o));const s=this.max.sub(this.min);s.x=Math.max(s.x,1),s.y=Math.max(s.y,1);const a=Math.max(s.x,s.y)/n;this.cellsX=Math.max(1,Math.ceil(s.x/a)),this.cellsY=Math.max(1,Math.ceil(s.y/a)),this.xScale=1/a,this.yScale=1/a;const l=[];for(let u=0;u<this.triangleCount;u++){const h=t[i[3*u+0]].sub(this.min),d=t[i[3*u+1]].sub(this.min),p=t[i[3*u+2]].sub(this.min),_=ea(Math.floor(Math.min(h.x,d.x,p.x)),this.xScale,this.cellsX),g=ea(Math.floor(Math.max(h.x,d.x,p.x)),this.xScale,this.cellsX),y=ea(Math.floor(Math.min(h.y,d.y,p.y)),this.yScale,this.cellsY),x=ea(Math.floor(Math.max(h.y,d.y,p.y)),this.yScale,this.cellsY),b=new G(0,0),M=new G(0,0),E=new G(0,0),T=new G(0,0);for(let S=y;S<=x;++S){b.y=M.y=S*a,E.y=T.y=(S+1)*a;for(let D=_;D<=g;++D)b.x=E.x=D*a,M.x=T.x=(D+1)*a,(fm(h,d,p,b,M,T)||fm(h,d,p,b,T,E))&&l.push({cellIdx:S*this.cellsX+D,triIdx:u})}}if(l.length===0)return;l.sort((u,h)=>u.cellIdx-h.cellIdx||u.triIdx-h.triIdx);let c=0;for(;c<l.length;){const u=l[c].cellIdx,h={start:this.payload.length,len:0};for(;c<l.length&&l[c].cellIdx===u;)++h.len,this.payload.push(l[c++].triIdx);this.cells[u]=h}}query(t,i,n){if(this.triangleCount===0||this.cells.length===0||t.x>this.max.x||this.min.x>i.x||t.y>this.max.y||this.min.y>i.y)return;this.lookup||(this.lookup=new Uint8Array(Math.ceil(this.triangleCount/8)));for(let l=0;l<this.lookup.length;l++)this.lookup[l]=0;const r=ea(t.x-this.min.x,this.xScale,this.cellsX),o=ea(i.x-this.min.x,this.xScale,this.cellsX),s=ea(t.y-this.min.y,this.yScale,this.cellsY),a=ea(i.y-this.min.y,this.yScale,this.cellsY);for(let l=s;l<=a;l++)for(let c=r;c<=o;c++){const u=this.cells[l*this.cellsX+c];if(u)for(let h=0;h<u.len;h++){const d=this.payload[u.start+h],p=Math.floor(d/8),_=1<<d%8;if(!(this.lookup[p]&_)&&(this.lookup[p]|=_,n.push(d),n.length===this.triangleCount))return}}}}function ea(e,t,i){return Math.max(0,Math.min(i-1,Math.floor(e*t)))}function Fa(e,t){const i=e.json.bufferViews[t.bufferView];return new s_[t.componentType](e.buffers[i.buffer],(t.byteOffset||0)+(i.byteOffset||0),t.count*a_[t.type])}function DI(e,t,i){const n=e.indices,r=e.attributes,o={};o.indexArray=new Rn;const s=t.json.accessors[n],a=s.count/3;o.indexArray.reserve(a);const l=Fa(t,s);for(let d=0;d<a;d++)o.indexArray.emplaceBack(l[3*d],l[3*d+1],l[3*d+2]);o.indexArray._trim(),o.vertexArray=new Aa;const c=t.json.accessors[r.POSITION];o.vertexArray.reserve(c.count);const u=Fa(t,c);for(let d=0;d<c.count;d++)o.vertexArray.emplaceBack(u[3*d],u[3*d+1],u[3*d+2]);if(o.vertexArray._trim(),o.aabb=new en(c.min,c.max),o.centroid=function(d,p){const _=[0,0,0],g=d.length;if(g>0){for(let y=0;y<g;y++){const x=3*d[y];_[0]+=p[x],_[1]+=p[x+1],_[2]+=p[x+2]}_[0]/=g,_[1]/=g,_[2]/=g}return _}(l,u),r.COLOR_0!==void 0){const d=t.json.accessors[r.COLOR_0],p=a_[d.type];if(d.componentType===o_){o.colorArray=p===3?new Aa:new is,o.colorArray.reserve(d.count);const _=Fa(t,d);if(p===3)for(let g=0;g<d.count;g++)o.colorArray.emplaceBack(_[3*g],_[3*g+1],_[3*g+2]);else for(let g=0;g<d.count;g++)o.colorArray.emplaceBack(_[4*g],_[4*g+1],_[4*g+2],_[4*g+3]);o.colorArray._trim()}else if(d.componentType===r_&&p===4){o.colorArray=new is,o.colorArray.resize(d.count);const _=Fa(t,d),g=1/65535,y=o.colorArray.float32;for(let x=0;x<4*_.length;++x)y[x]=_[x]*g}else J(`glTF color buffer parsing for accessor ${JSON.stringify(d)} is not supported`)}if(r.NORMAL!==void 0){o.normalArray=new Aa;const d=t.json.accessors[r.NORMAL];o.normalArray.reserve(d.count);const p=Fa(t,d);for(let _=0;_<d.count;_++)o.normalArray.emplaceBack(p[3*_],p[3*_+1],p[3*_+2]);o.normalArray._trim()}if(r.TEXCOORD_0!==void 0&&i.length>0){o.texcoordArray=new Pc;const d=t.json.accessors[r.TEXCOORD_0];o.texcoordArray.reserve(d.count);const p=Fa(t,d);for(let _=0;_<d.count;_++)o.texcoordArray.emplaceBack(p[2*_],p[2*_+1]);o.texcoordArray._trim()}const h=e.material;return o.material=function(d,p){const{emissiveFactor:_=[0,0,0],alphaMode:g="OPAQUE",alphaCutoff:y=.5,normalTexture:x,occlusionTexture:b,emissiveTexture:M,doubleSided:E}=d,{baseColorFactor:T=[1,1,1,1],metallicFactor:S=1,roughnessFactor:D=1,baseColorTexture:z,metallicRoughnessTexture:L}=d.pbrMetallicRoughness||{};return{pbrMetallicRoughness:{baseColorFactor:new Ye(...T),metallicFactor:S,roughnessFactor:D,baseColorTexture:z?p[z.index]:void 0,metallicRoughnessTexture:L?p[L.index]:void 0},doubleSided:E,emissiveFactor:_,alphaMode:g,alphaCutoff:y,normalTexture:x?p[x.index]:void 0,occlusionTexture:b?p[b.index]:void 0,emissionTexture:M?p[M.index]:void 0,defined:d.defined===void 0}}(h!==void 0?t.json.materials[h]:{defined:!1},i),r._FEATURE_RGBA4444!==void 0&&(o.featureData=new Uint32Array(Fa(t,t.json.accessors[r._FEATURE_RGBA4444]).buffer)),o}function zb(e,t,i){const{matrix:n,rotation:r,translation:o,scale:s,mesh:a,extras:l,children:c}=e,u={};if(u.matrix=n||st.fromRotationTranslationScale([],r||[0,0,0,1],o||[0,0,0],s||[1,1,1]),a!==void 0){u.meshes=i[a];const h=u.anchor=[0,0];for(const d of u.meshes){const{min:p,max:_}=d.aabb;h[0]+=p[0]+_[0],h[1]+=p[1]+_[1]}h[0]=Math.floor(h[0]/u.meshes.length/2),h[1]=Math.floor(h[1]/u.meshes.length/2)}if(l&&(l.id&&(u.id=l.id),l.lights&&(u.lights=function(h){if(!h.length)return[];const d=function(x){const b=atob(x),M=new Uint8Array(b.length);for(let E=0;E<b.length;E++)M[E]=b.codePointAt(E);return M}(h),p=[],_=d.length/24,g=new Uint16Array(d.buffer),y=new Float32Array(d.buffer);for(let x=0;x<_;x++){const b=g[2*x*6]/30,M=g[2*x*6+1]/30,E=g[2*x*6+10]/100,T=y[6*x+1],S=y[6*x+2],D=y[6*x+3],z=y[6*x+4],L=D-T,R=z-S,N=Math.hypot(L,R);p.push({pos:[T+.5*L,S+.5*R,M],normal:[R/N,-L/N,0],width:N,height:b,depth:E,points:[T,S,D,z]})}return p}(l.lights))),c){const h=[];for(const d of c)h.push(zb(t.json.nodes[d],t,i));u.children=h}return u}function PI(e){if(e.vertices.length===0||e.indices.length===0)return null;const[t,i]=[e.vertices[0].clone(),e.vertices[0].clone()];for(let s=1;s<e.vertices.length;++s){const a=e.vertices[s];t.x=Math.min(t.x,a.x),t.y=Math.min(t.y,a.y),i.x=Math.max(i.x,a.x),i.y=Math.max(i.y,a.y)}const n=Math.ceil(Math.max(i.x-t.x,i.y-t.y)/256),r=Math.max(8,n),o=new kb(e.vertices,e.indices,r);return{vertices:e.vertices,indices:e.indices,grid:o,min:t,max:i}}function kI(e){if(!e.extras||!e.extras.ground)return null;const t=e.extras.ground;if(!t||!Array.isArray(t)||t.length===0)return null;const i=t[0];if(!i||!Array.isArray(i)||i.length===0)return null;const n=[];for(const s of i){if(!Array.isArray(s)||s.length!==2)continue;const a=s[0],l=s[1];typeof a=="number"&&typeof l=="number"&&n.push(new G(a,l))}if(n.length<3)return null;n.length>1&&n[n.length-1].equals(n[0])&&n.pop();let r=0;for(let s=0;s<n.length;s++){const a=n[s],l=n[(s+1)%n.length],c=n[(s+2)%n.length];r+=(a.x-l.x)*(c.y-l.y)-(c.x-l.x)*(a.y-l.y)}r>0&&n.reverse();const o=Eh(n.flatMap(s=>[s.x,s.y]),[]);return o.length===0?null:{vertices:n,indices:o}}function zI(e){const t=[],i=[];let n=0;for(const r of e){n=t.length;const o=r.vertexArray.float32,s=r.indexArray.uint16;for(let a=0;a<r.vertexArray.length;a++)t.push(new G(o[3*a+0],o[3*a+1]));for(let a=0;a<3*r.indexArray.length;a++)i.push(s[a]+n)}if(i.length%3!=0)return null;for(let r=0;r<i.length;r+=3){const o=t[i[r+0]],s=t[i[r+1]],a=t[i[r+2]];(o.x-s.x)*(a.y-s.y)-(a.x-s.x)*(o.y-s.y)>0&&([i[r+1],i[r+2]]=[i[r+2],i[r+1]])}return{vertices:t,indices:i}}function c_(e){const t=function(l,c){const u=[],h=I.WebGL2RenderingContext;if(l.json.textures)for(const d of l.json.textures){const p={magFilter:h.LINEAR,minFilter:h.NEAREST,wrapS:h.REPEAT,wrapT:h.REPEAT};d.sampler!==void 0&&Object.assign(p,l.json.samplers[d.sampler]),u.push({image:c[d.source],sampler:p,uploaded:!1})}return u}(e,e.images),i=function(l,c){const u=[];for(const h of l.json.meshes){const d=[];for(const p of h.primitives)d.push(DI(p,l,c));u.push(d)}return u}(e,t),{scenes:n,scene:r,nodes:o}=e.json,s=n?n[r||0].nodes:o,a=[];for(const l of s)a.push(zb(o[l],e,i));return function(l,c,u){const h={},d=new Set;for(let p=0;p<l.length;p++){const _=u[c[p]];if(!_.extras)continue;const g=_.extras["mapbox:footprint:version"],y=_.extras["mapbox:footprint:id"];(g||y)&&d.add(p),g==="1.0.0"&&y&&(h[y]=p)}for(let p=0;p<l.length;p++){if(d.has(p))continue;const _=l[p],g=u[c[p]];if(!g.extras)continue;let y=null;_.id in h&&(y=zI(l[h[_.id]].meshes)),y||(y=kI(g)),y&&(_.footprint=PI(y))}if(d.size>0){const p=Array.from(d.values()).sort((_,g)=>_-g);for(let _=p.length-1;_>=0;_--)l.splice(p[_],1)}}(a,s,e.json.nodes),a}function LI(e){e.heightmap=new Float32Array(4096),e.heightmap.fill(-1);const t=e.vertexArray.float32,i=e.aabb.min[0]-1,n=e.aabb.min[1]-1,r=La/(e.aabb.max[0]-i+2),o=La/(e.aabb.max[1]-n+2);for(let s=0;s<t.length;s+=3){const a=t[s+2],l=(t[s+0]-i)*r|0,c=(t[s+1]-n)*o|0;a>e.heightmap[c*La+l]&&(e.heightmap[c*La+l]=a)}}function RI(e,t){const i={};i.indexArray=new Rn,i.indexArray.reserve(4*e.length),i.vertexArray=new Aa,i.vertexArray.reserve(10*e.length),i.colorArray=new is,i.vertexArray.reserve(10*e.length);let n=0;for(const s of e){const a=Math.min(10,Math.max(4,1.3*s.height))*t,l=[-s.normal[1],s.normal[0],0],c=Math.min(.29,.1*s.width/s.depth),u=s.width-2*s.depth*t*(c+.01),h=Z.scaleAndAdd([],s.pos,l,u/2),d=Z.scaleAndAdd([],s.pos,l,-u/2),p=[h[0],h[1],h[2]+s.height],_=[d[0],d[1],d[2]+s.height],g=Z.scaleAndAdd([],s.normal,l,c);Z.scale(g,g,a);const y=Z.scaleAndAdd([],s.normal,l,-c);Z.scale(y,y,a),Z.add(g,h,g),Z.add(y,d,y),h[2]+=.1,d[2]+=.1,i.vertexArray.emplaceBack(g[0],g[1],g[2]),i.vertexArray.emplaceBack(y[0],y[1],y[2]),i.vertexArray.emplaceBack(h[0],h[1],h[2]),i.vertexArray.emplaceBack(d[0],d[1],d[2]),i.vertexArray.emplaceBack(p[0],p[1],p[2]),i.vertexArray.emplaceBack(_[0],_[1],_[2]),i.vertexArray.emplaceBack(h[0],h[1],h[2]),i.vertexArray.emplaceBack(d[0],d[1],d[2]),i.vertexArray.emplaceBack(g[0],g[1],g[2]),i.vertexArray.emplaceBack(y[0],y[1],y[2]);const x=u/a/2;i.colorArray.emplaceBack(-x-c,-1,x,.8),i.colorArray.emplaceBack(x+c,-1,x,.8),i.colorArray.emplaceBack(-x,0,x,1.3),i.colorArray.emplaceBack(x,0,x,1.3),i.colorArray.emplaceBack(x+c,-.8,x,.7),i.colorArray.emplaceBack(x+c,-.8,x,.7),i.colorArray.emplaceBack(0,0,x,1.3),i.colorArray.emplaceBack(0,0,x,1.3),i.colorArray.emplaceBack(x+c,-1.2,x,.8),i.colorArray.emplaceBack(x+c,-1.2,x,.8),i.indexArray.emplaceBack(6+n,4+n,8+n),i.indexArray.emplaceBack(7+n,9+n,5+n),i.indexArray.emplaceBack(0+n,1+n,2+n),i.indexArray.emplaceBack(1+n,3+n,2+n),n+=10}const r={defined:!0,emissiveFactor:[0,0,0]},o={};return o.baseColorFactor=Ye.white,r.pbrMetallicRoughness=o,i.material=r,i.aabb=new en([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),i}he(kb,"TriangleGridIndex");const u_={vector:Tb,raster:t_,"raster-dem":class extends t_{constructor(e,t,i,n){super(e,t,i,n),this.type="raster-dem",this.maxzoom=22,this._options=Vt({type:"raster-dem"},t),this.encoding=t.encoding||"mapbox"}loadTile(e,t){const i=this.map._requestManager.normalizeTileURL(e.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function n(r,o){r&&(e.state="errored",t(r)),o&&(e.dem=o,e.dem.onDeserialize(),e.needsHillshadePrepare=!0,e.needsDEMTextureUpload=!0,e.state="loaded",t(null))}e.request=Ee(this.map._requestManager.transformRequest(i,xt.Tile),(function(r,o,s,a){if(delete e.request,e.aborted)e.state="unloaded",t(null);else if(r)e.state="errored",t(r);else if(o){this.map._refreshExpiredTiles&&e.setExpiryData({cacheControl:s,expires:a});const c=I.ImageBitmap&&o instanceof I.ImageBitmap&&ac(),u=1-(o.width-((l=o.width)<=1?1:Math.pow(2,Math.floor(Math.log(l)/Math.LN2))))/2;u<1||e.neighboringTiles||(e.neighboringTiles=this._getNeighboringTiles(e.tileID));const h=c?o:ke.getImageData(o,u),d={uid:e.uid,coord:e.tileID,source:this.id,scope:this.scope,rawImageData:h,encoding:this.encoding,padding:u};e.actor&&e.state!=="expired"||(e.actor=this.dispatcher.getActor(),e.actor.send("loadDEMTile",d,n.bind(this),void 0,!0))}var l}).bind(this))}_getNeighboringTiles(e){const t=e.canonical,i=Math.pow(2,t.z),n=(t.x-1+i)%i,r=t.x===0?e.wrap-1:e.wrap,o=(t.x+1+i)%i,s=t.x+1===i?e.wrap+1:e.wrap,a={};return a[new Si(e.overscaledZ,r,t.z,n,t.y).key]={backfilled:!1},a[new Si(e.overscaledZ,s,t.z,o,t.y).key]={backfilled:!1},t.y>0&&(a[new Si(e.overscaledZ,r,t.z,n,t.y-1).key]={backfilled:!1},a[new Si(e.overscaledZ,e.wrap,t.z,t.x,t.y-1).key]={backfilled:!1},a[new Si(e.overscaledZ,s,t.z,o,t.y-1).key]={backfilled:!1}),t.y+1<i&&(a[new Si(e.overscaledZ,r,t.z,n,t.y+1).key]={backfilled:!1},a[new Si(e.overscaledZ,e.wrap,t.z,t.x,t.y+1).key]={backfilled:!1},a[new Si(e.overscaledZ,s,t.z,o,t.y+1).key]={backfilled:!1}),a}},geojson:class extends Mn{constructor(e,t,i,n){super(),this.id=e,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=i.getActor(),this.setEventedParent(n),this._data=t.data,this._options=Vt({},t),this._collectResourceTiming=t.collectResourceTiming,t.maxzoom!==void 0&&(this.maxzoom=t.maxzoom),t.type&&(this.type=t.type),t.attribution&&(this.attribution=t.attribution),this.promoteId=t.promoteId;const r=pt/this.tileSize;this.workerOptions=Vt({source:this.id,scope:this.scope,cluster:t.cluster||!1,geojsonVtOptions:{buffer:(t.buffer!==void 0?t.buffer:128)*r,tolerance:(t.tolerance!==void 0?t.tolerance:.375)*r,extent:pt,maxZoom:this.maxzoom,lineMetrics:t.lineMetrics||!1,generateId:t.generateId||!1},superclusterOptions:{maxZoom:t.clusterMaxZoom!==void 0?t.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,t.clusterMinPoints||2),extent:pt,radius:(t.clusterRadius!==void 0?t.clusterRadius:50)*r,log:!1,generateId:t.generateId||!1},clusterProperties:t.clusterProperties,filter:t.filter},t.workerOptions)}onAdd(e){this.map=e,this.setData(this._data)}setData(e){return this._data=e,this._updateWorkerData(),this}getClusterExpansionZoom(e,t){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:e,source:this.id,scope:this.scope},t),this}getClusterChildren(e,t){return this.actor.send("geojson.getClusterChildren",{clusterId:e,source:this.id,scope:this.scope},t),this}getClusterLeaves(e,t,i,n){return this.actor.send("geojson.getClusterLeaves",{source:this.id,scope:this.scope,clusterId:e,limit:t,offset:i},n),this}_updateWorkerData(){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new jt("dataloading",{dataType:"source"})),this._loaded=!1;const e=Vt({},this.workerOptions);e.scope=this.scope;const t=this._data;typeof t=="string"?(e.request=this.map._requestManager.transformRequest(ke.resolveURL(t),xt.Source),e.request.collectResourceTiming=this._collectResourceTiming):e.data=JSON.stringify(t),this._pendingLoad=this.actor.send(`${this.type}.loadData`,e,(i,n)=>{if(this._loaded=!0,this._pendingLoad=null,i)this.fire(new Ae(i));else{const r={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&n&&n.resourceTiming&&n.resourceTiming[this.id]&&(r.resourceTiming=n.resourceTiming[this.id]),this.fire(new jt("data",r)),this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(),this._coalesce=!1)})}loaded(){return this._loaded}loadTile(e,t){const i=e.actor?"reloadTile":"loadTile";e.actor=this.actor;const n={type:this.type,uid:e.uid,tileID:e.tileID,tileZoom:e.tileZoom,zoom:e.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,scope:this.scope,pixelRatio:ke.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,brightness:this.map.style&&this.map.style.getBrightness()||0};e.request=this.actor.send(i,n,(r,o)=>(delete e.request,e.destroy(),e.aborted?t(null):r?t(r):(e.loadVectorData(o,this.map.painter,i==="reloadTile"),t(null))),void 0,i==="loadTile")}abortTile(e){e.request&&(e.request.cancel(),delete e.request),e.aborted=!0}unloadTile(e){this.actor.send("removeTile",{uid:e.uid,type:this.type,source:this.id,scope:this.scope}),e.destroy()}onRemove(){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return Vt({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends to{constructor(e,t,i,n){super(e,t,i,n),this.roundZoom=!0,this.type="video",this.options=t}load(){this._loaded=!1;const e=this.options;this.urls=[];for(const t of e.urls)this.urls.push(this.map._requestManager.transformRequest(t,xt.Source).url);(function(t,i){const n=I.document.createElement("video");n.muted=!0,n.onloadstart=function(){i(null,n)};for(let r=0;r<t.length;r++){const o=I.document.createElement("source");Kt(t[r])||(n.crossOrigin="Anonymous"),o.src=t[r],n.appendChild(o)}})(this.urls,(t,i)=>{this._loaded=!0,t?this.fire(new Ae(t)):i&&(this.video=i,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",()=>{this.map.triggerRepaint()}),this.map&&this.video.play(),this._finishLoading())})}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(e){if(this.video){const t=this.video.seekable;e<t.start(0)||e>t.end(0)?this.fire(new Ae(new le(`sources.${this.id}`,null,`Playback for this video can be set only between the ${t.start(0)} and ${t.end(0)}-second mark.`))):this.video.currentTime=e}}getVideo(){return this.video}onAdd(e){this.map||(this.map=e,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(Object.keys(this.tiles).length===0||this.video.readyState<2)return;const e=this.map.painter.context,t=e.gl;this.texture?this.video.paused||(this.texture.bind(t.LINEAR,t.CLAMP_TO_EDGE),t.texSubImage2D(t.TEXTURE_2D,0,0,0,t.RGBA,t.UNSIGNED_BYTE,this.video)):(this.texture=new mn(e,this.video,t.RGBA),this.texture.bind(t.LINEAR,t.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._prepareData(e)}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:to,model:class extends Mn{constructor(e,t,i,n){super(),this.id=e,this.type="model",this.models=[],this._loaded=!1,this._options=t}load(){const e=[];for(const t in this._options.models){const i=this._options.models[t],n=Pb(this.map._requestManager.transformRequest(i.uri,xt.Model).url).then(r=>{if(!r)return;const o=c_(r),s=new Ax(t,i.position,i.orientation,o);s.computeBoundsAndApplyParent(),this.models.push(s)}).catch(r=>{this.fire(new Ae(new Error(`Could not load model ${t} from ${i.uri}: ${r.message}`)))});e.push(n)}return Promise.allSettled(e).then(()=>{this._loaded=!0,this.fire(new jt("data",{dataType:"source",sourceDataType:"metadata"}))}).catch(t=>{this.fire(new Ae(new Error(`Could not load models: ${t.message}`)))})}onAdd(e){this.map=e,this.load()}hasTransition(){return!1}loaded(){return this._loaded}getModels(){return this.models}loadTile(e,t){}serialize(){return{type:"model"}}},"batched-model":class extends Mn{constructor(e,t,i,n){super(),this.type="batched-model",this.id=e,this.tileSize=512,this._options=t,this.tiles=this._options.tiles,this.maxzoom=t.maxzoom||19,this.minzoom=t.minzoom||0,this.roundZoom=!0,this.usedInConflation=!0,this.dispatcher=i,this.reparseOverscaled=!1,this.scheme="xyz",this._loaded=!1,this.setEventedParent(n)}onAdd(e){this.map=e,this.load()}load(e){this._loaded=!1,this.fire(new jt("dataloading",{dataType:"source"}));const t=Array.isArray(this.map._language)?this.map._language.join():this.map._language,i=this.map._worldview;this._tileJSONRequest=Jm(this._options,this.map._requestManager,t,i,(n,r)=>{this._tileJSONRequest=null,this._loaded=!0,n?(t&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${t}`),i&&i.length!==2&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${i}`),this.fire(new Ae(n))):r&&(Vt(this,r),r.bounds&&(this.tileBounds=new cd(r.bounds,this.minzoom,this.maxzoom)),Zo(r.tiles,this.map._requestManager._customAccessToken),this.fire(new jt("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new jt("data",{dataType:"source",sourceDataType:"content"}))),e&&e(n)})}hasTransition(){return!1}hasTile(e){return!this.tileBounds||this.tileBounds.contains(e.canonical)}loaded(){return this._loaded}loadTile(e,t){const i=this.map._requestManager.normalizeTileURL(e.tileID.canonical.url(this.tiles,this.scheme)),n={request:this.map._requestManager.transformRequest(i,xt.Tile),data:void 0,uid:e.uid,tileID:e.tileID,tileZoom:e.tileZoom,zoom:e.tileID.overscaledZ,tileSize:this.tileSize*e.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,showCollisionBoxes:this.map.showCollisionBoxes,isSymbolTile:e.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0};if(e.actor&&e.state!=="expired")if(e.state==="loading")e.reloadCallback=t;else{if(e.buckets){const o=Object.values(e.buckets);for(const s of o)s.dirty=!0;return void(e.state="loaded")}e.request=e.actor.send("reloadTile",n,r.bind(this))}else e.actor=this.dispatcher.getActor(),e.request=e.actor.send("loadTile",n,r.bind(this),void 0,!0);function r(o,s){return e.aborted?t(null):o&&o.status!==404?t(o):(s&&(s.resourceTiming&&(e.resourceTiming=s.resourceTiming),this.map._refreshExpiredTiles&&e.setExpiryData(s),e.buckets={...e.buckets,...s.buckets}),e.state="loaded",void t(null))}}serialize(){return Vt({},this._options)}},canvas:class extends to{constructor(e,t,i,n){super(e,t,i,n),t.coordinates?Array.isArray(t.coordinates)&&t.coordinates.length===4&&!t.coordinates.some(r=>!Array.isArray(r)||r.length!==2||r.some(o=>typeof o!="number"))||this.fire(new Ae(new le(`sources.${e}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new Ae(new le(`sources.${e}`,null,'missing required property "coordinates"'))),t.animate&&typeof t.animate!="boolean"&&this.fire(new Ae(new le(`sources.${e}`,null,'optional "animate" property must be a boolean value'))),t.canvas?typeof t.canvas=="string"||t.canvas instanceof I.HTMLCanvasElement||this.fire(new Ae(new le(`sources.${e}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new Ae(new le(`sources.${e}`,null,'missing required property "canvas"'))),this.options=t,this.animate=t.animate===void 0||t.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof I.HTMLCanvasElement?this.options.canvas:I.document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new Ae(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(e){this.map=e,this.load(),this.canvas&&this.animate&&this.play()}onRemove(){this.pause()}prepare(){let e=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,e=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,e=!0),this._hasInvalidDimensions()||Object.keys(this.tiles).length===0)return;const t=this.map.painter.context;this.texture?!e&&!this._playing||this.texture instanceof Yh||this.texture.update(this.canvas,{premultiply:!0}):this.texture=new mn(t,this.canvas,t.gl.RGBA,{premultiply:!0}),this._prepareData(t)}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const e of[this.canvas.width,this.canvas.height])if(isNaN(e)||e<=0)return!0;return!1}},custom:class extends Mn{constructor(e,t,i,n){super(),this.id=e,this.type="custom",this._dataType="raster",this._dispatcher=i,this._implementation=t,this.setEventedParent(n),this.scheme="xyz",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this._loaded=!1,this.roundZoom=!0,this._implementation||this.fire(new Ae(new Error(`Missing implementation for ${this.id} custom source`))),this._implementation.loadTile||this.fire(new Ae(new Error(`Missing loadTile implementation for ${this.id} custom source`))),this._implementation.bounds&&(this.tileBounds=new cd(this._implementation.bounds,this.minzoom,this.maxzoom)),t.update=this._update.bind(this),t.clearTiles=this._clearTiles.bind(this),t.coveringTiles=this._coveringTiles.bind(this),Vt(this,Ve(t,["dataType","scheme","minzoom","maxzoom","tileSize","attribution","minTileCacheSize","maxTileCacheSize"]))}serialize(){return Ve(this,["type","scheme","minzoom","maxzoom","tileSize","attribution"])}load(){this._loaded=!0,this.fire(new jt("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new jt("data",{dataType:"source",sourceDataType:"content"}))}loaded(){return this._loaded}onAdd(e){this._map=e,this._loaded=!1,this.fire(new jt("dataloading",{dataType:"source"})),this._implementation.onAdd&&this._implementation.onAdd(e),this.load()}onRemove(e){this._implementation.onRemove&&this._implementation.onRemove(e)}hasTile(e){if(this._implementation.hasTile){const{x:t,y:i,z:n}=e.canonical;return this._implementation.hasTile({x:t,y:i,z:n})}return!this.tileBounds||this.tileBounds.contains(e.canonical)}loadTile(e,t){const{x:i,y:n,z:r}=e.tileID.canonical,o=new I.AbortController;e.request=Promise.resolve(this._implementation.loadTile({x:i,y:n,z:r},{signal:o.signal})).then((function(s){return delete e.request,e.aborted?(e.state="unloaded",t(null)):s===void 0?(e.state="errored",t(null)):s===null?(this.loadTileData(e,{width:this.tileSize,height:this.tileSize,data:null}),e.state="loaded",t(null)):function(a){return a instanceof I.ImageData||a instanceof I.HTMLCanvasElement||a instanceof I.ImageBitmap||a instanceof I.HTMLImageElement}(s)?(this.loadTileData(e,s),e.state="loaded",void t(null)):(e.state="errored",t(new Error(`Can't infer data type for ${this.id}, only raster data supported at the moment`)))}).bind(this)).catch(s=>{s.code!==20&&(e.state="errored",t(s))}),e.request.cancel=()=>o.abort()}loadTileData(e,t){e.setTexture(t,this._map.painter)}unloadTile(e,t){if(e.texture&&e.texture instanceof mn?(e.destroy(!0),e.texture&&e.texture instanceof mn&&this._map.painter.saveTileTexture(e.texture)):e.destroy(),this._implementation.unloadTile){const{x:i,y:n,z:r}=e.tileID.canonical;this._implementation.unloadTile({x:i,y:n,z:r})}t()}abortTile(e,t){e.request&&e.request.cancel&&(e.request.cancel(),delete e.request),t()}hasTransition(){return!1}_coveringTiles(){return this._map.transform.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,roundZoom:this.roundZoom}).map(e=>({x:e.canonical.x,y:e.canonical.y,z:e.canonical.z}))}_clearTiles(){const e=cr(this.id,this.scope);this._map.style.clearSource(e)}_update(){this.fire(new jt("data",{dataType:"source",sourceDataType:"content"}))}}},h_=function(e,t,i,n){const r=new u_[t.type](e,t,i,n);if(r.id!==e)throw new Error(`Expected Source id to be ${e} instead of ${r.id}`);return Xe(["load","abort","unload","serialize","prepare"],r),r};function OI(e,t){const i=st.identity([]);return st.scale(i,i,[.5*e.width,.5*-e.height,1]),st.translate(i,i,[1,-1,0]),st.multiply(i,i,e.calculateProjMatrix(t.toUnwrapped())),Float32Array.from(i)}function BI(e,t,i,n,r,o,s,a=!1){const l=e.tilesIn(n,s,a);l.sort(Lb);const c=[];for(const h of l)c.push({wrappedTileID:h.tile.tileID.wrapped().key,queryResults:h.tile.queryRenderedFeatures(t,i,e._state,h,r,o,OI(e.transform,h.tile.tileID),a)});const u=function(h){const d={},p={};for(const _ of h){const g=_.queryResults,y=_.wrappedTileID,x=p[y]=p[y]||{};for(const b in g){const M=g[b],E=x[b]=x[b]||{},T=d[b]=d[b]||[];for(const S of M)E[S.featureIndex]||(E[S.featureIndex]=!0,T.push(S))}}return d}(c);for(const h in u)u[h].forEach(d=>{const p=d.feature,_=p.layer;_&&_.type!=="background"&&_.type!=="sky"&&_.type!=="slot"&&(p.source=_.source,_["source-layer"]&&(p.sourceLayer=_["source-layer"]),p.state=p.id!==void 0?e.getFeatureState(_["source-layer"],p.id):{})});return u}function FI(e,t){const i=e.getRenderableIds().map(o=>e.getTileByID(o)),n=[],r={};for(let o=0;o<i.length;o++){const s=i[o],a=s.tileID.canonical.key;r[a]||(r[a]=!0,s.querySourceFeatures(n,t))}return n}function Lb(e,t){const i=e.tileID,n=t.tileID;return i.overscaledZ-n.overscaledZ||i.canonical.y-n.canonical.y||i.wrap-n.wrap||i.canonical.x-n.canonical.x}class NI{constructor(t){this.style=t}processLayersChanged(){this.layers=[];for(const t in this.style._mergedLayers){const i=this.style._mergedLayers[t];if(i.type==="fill-extrusion")this.layers.push(i);else if(i.type==="model"){const n=this.style.getLayerSource(i);n&&n.type==="batched-model"&&this.layers.push(i)}}}updateZOffset(t,i){this.currentBuildingBuckets=[];for(let r=0;r<this.layers.length;++r){const o=this.layers[r],s=this.style.getLayerSourceCache(o);let a=1;o.type==="fill-extrusion"&&(a=o.paint.get("fill-extrusion-opacity")>0?o.paint.get("fill-extrusion-vertical-scale"):0);let l=s?s.getTile(i):null;if(!l&&s&&i.canonical.z>s.getSource().minzoom){let c=i.scaledTo(Math.min(s.getSource().maxzoom,i.overscaledZ-1));for(;c.overscaledZ>=s.getSource().minzoom&&(l=s.getTile(c),!l&&c.overscaledZ!==0);)c=c.scaledTo(c.overscaledZ-1)}this.currentBuildingBuckets.push({bucket:l?l.getBucket(o):null,tileID:l?l.tileID:i,verticalScale:a})}t.hasAnyZOffset=!1;let n=!1;for(let r=0;r<t.symbolInstances.length;r++){const o=t.symbolInstances.get(r),s=o.zOffset,a=this._getHeightAtTileOffset(i,o.tileAnchorX,o.tileAnchorY);o.zOffset=a!==-1?a:s,n||s===o.zOffset||(n=!0),t.hasAnyZOffset||o.zOffset===0||(t.hasAnyZOffset=!0)}n&&(t.zOffsetBuffersNeedUpload=!0,t.zOffsetSortDirty=!0)}_mapCoordToOverlappingTile(t,i,n,r){let o=i,s=n;if(t.canonical.z!==r.canonical.z){const a=r.canonical,l=1/(1<<t.canonical.z-a.z);o=(i+t.canonical.x*pt)*l-a.x*pt|0,s=(n+t.canonical.y*pt)*l-a.y*pt|0}return{tileX:o,tileY:s}}_getHeightAtTileOffset(t,i,n){let r;for(let o=0;o<this.layers.length;++o){if(this.layers[o].type!=="fill-extrusion")continue;const{bucket:s,tileID:a,verticalScale:l}=this.currentBuildingBuckets[o];if(!s)continue;const{tileX:c,tileY:u}=this._mapCoordToOverlappingTile(t,i,n,a),h=s.getHeightAtTileCoord(c,u);if(h&&h.height!==void 0){if(!h.hidden)return h.height*l;r=h.height}}for(let o=0;o<this.layers.length;++o){if(this.layers[o].type!=="model")continue;const{bucket:s,tileID:a}=this.currentBuildingBuckets[o];if(!s)continue;const{tileX:l,tileY:c}=this._mapCoordToOverlappingTile(t,i,n,a),u=s.getHeightAtTileCoord(l,c);if(u&&!u.hidden)return u.height===void 0&&r!==void 0?Math.min(u.maxHeight,r)*u.verticalScale:(u.height||0)*u.verticalScale}return-1}}var Rb=["type","source","source-layer","minzoom","maxzoom","filter","layout"];function UI(e,t){const i={};for(const n in e)n!=="ref"&&(i[n]=e[n]);return Rb.forEach(n=>{n in t&&(i[n]=t[n])}),i}function Ob(e){e=e.slice();const t=Object.create(null);for(let i=0;i<e.length;i++)t[e[i].id]=e[i];for(let i=0;i<e.length;i++)"ref"in e[i]&&(e[i]=UI(e[i],t[e[i].ref]));return e}const Pi={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setSlot:"setSlot",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setCamera:"setCamera",setLights:"setLights",setProjection:"setProjection",addImport:"addImport",removeImport:"removeImport",setImportUrl:"setImportUrl",setImportData:"setImportData",setImportConfig:"setImportConfig"};function Bb(e,t,i){i.push({command:Pi.addSource,args:[e,t[e]]})}function Fb(e,t,i){t.push({command:Pi.removeSource,args:[e]}),i[e]=!0}function VI(e,t,i,n){Fb(e,i,n),Bb(e,t,i)}function jI(e,t,i){let n;for(n in e[i])if(e[i].hasOwnProperty(n)&&n!=="data"&&!Tt(e[i][n],t[i][n]))return!1;for(n in t[i])if(t[i].hasOwnProperty(n)&&n!=="data"&&!Tt(e[i][n],t[i][n]))return!1;return!0}function hd(e,t,i,n,r,o){let s;for(s in t=t||{},e=e||{})e.hasOwnProperty(s)&&(Tt(e[s],t[s])||i.push({command:o,args:[n,s,t[s],r]}));for(s in t)t.hasOwnProperty(s)&&!e.hasOwnProperty(s)&&(Tt(e[s],t[s])||i.push({command:o,args:[n,s,t[s],r]}))}function dd(e){return e.id}function fd(e,t){return e[t.id]=t,e}class GI{constructor(t,i){this.reset(t,i)}reset(t,i){this.points=t||[],this._distances=[0];for(let n=1;n<this.points.length;n++)this._distances[n]=this._distances[n-1]+this.points[n].dist(this.points[n-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(i||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(t){if(this.points.length===1)return this.points[0];t=Lt(t,0,1);let i=1,n=this._distances[i];const r=t*this.paddedLength+this.padding;for(;n<r&&i<this._distances.length;)n=this._distances[++i];const o=i-1,s=this._distances[o],a=n-s,l=a>0?(r-s)/a:0;return this.points[o].mult(1-l).add(this.points[i].mult(l))}}class Nb{constructor(t,i,n){const r=this.boxCells=[],o=this.circleCells=[];this.xCellCount=Math.ceil(t/n),this.yCellCount=Math.ceil(i/n);for(let s=0;s<this.xCellCount*this.yCellCount;s++)r.push([]),o.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=t,this.height=i,this.xScale=this.xCellCount/t,this.yScale=this.yCellCount/i,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(t,i,n,r,o){this._forEachCell(i,n,r,o,this._insertBoxCell,this.boxUid++),this.boxKeys.push(t),this.bboxes.push(i),this.bboxes.push(n),this.bboxes.push(r),this.bboxes.push(o)}insertCircle(t,i,n,r){this._forEachCell(i-r,n-r,i+r,n+r,this._insertCircleCell,this.circleUid++),this.circleKeys.push(t),this.circles.push(i),this.circles.push(n),this.circles.push(r)}_insertBoxCell(t,i,n,r,o,s){this.boxCells[o].push(s)}_insertCircleCell(t,i,n,r,o,s){this.circleCells[o].push(s)}_query(t,i,n,r,o,s){if(n<0||t>this.width||r<0||i>this.height)return!o&&[];const a=[];if(t<=0&&i<=0&&this.width<=n&&this.height<=r){if(o)return!0;for(let l=0;l<this.boxKeys.length;l++)a.push({key:this.boxKeys[l],x1:this.bboxes[4*l],y1:this.bboxes[4*l+1],x2:this.bboxes[4*l+2],y2:this.bboxes[4*l+3]});for(let l=0;l<this.circleKeys.length;l++){const c=this.circles[3*l],u=this.circles[3*l+1],h=this.circles[3*l+2];a.push({key:this.circleKeys[l],x1:c-h,y1:u-h,x2:c+h,y2:u+h})}return s?a.filter(s):a}return this._forEachCell(t,i,n,r,this._queryCell,a,{hitTest:o,seenUids:{box:{},circle:{}}},s),o?a.length>0:a}_queryCircle(t,i,n,r,o){const s=t-n,a=t+n,l=i-n,c=i+n;if(a<0||s>this.width||c<0||l>this.height)return!r&&[];const u=[];return this._forEachCell(s,l,a,c,this._queryCellCircle,u,{hitTest:r,circle:{x:t,y:i,radius:n},seenUids:{box:{},circle:{}}},o),r?u.length>0:u}query(t,i,n,r,o){return this._query(t,i,n,r,!1,o)}hitTest(t,i,n,r,o){return this._query(t,i,n,r,!0,o)}hitTestCircle(t,i,n,r){return this._queryCircle(t,i,n,!0,r)}_queryCell(t,i,n,r,o,s,a,l){const c=a.seenUids,u=this.boxCells[o];if(u!==null){const d=this.bboxes;for(const p of u)if(!c.box[p]){c.box[p]=!0;const _=4*p;if(t<=d[_+2]&&i<=d[_+3]&&n>=d[_+0]&&r>=d[_+1]&&(!l||l(this.boxKeys[p]))){if(a.hitTest)return s.push(!0),!0;s.push({key:this.boxKeys[p],x1:d[_],y1:d[_+1],x2:d[_+2],y2:d[_+3]})}}}const h=this.circleCells[o];if(h!==null){const d=this.circles;for(const p of h)if(!c.circle[p]){c.circle[p]=!0;const _=3*p;if(this._circleAndRectCollide(d[_],d[_+1],d[_+2],t,i,n,r)&&(!l||l(this.circleKeys[p]))){if(a.hitTest)return s.push(!0),!0;{const g=d[_],y=d[_+1],x=d[_+2];s.push({key:this.circleKeys[p],x1:g-x,y1:y-x,x2:g+x,y2:y+x})}}}}}_queryCellCircle(t,i,n,r,o,s,a,l){const c=a.circle,u=a.seenUids,h=this.boxCells[o];if(h!==null){const p=this.bboxes;for(const _ of h)if(!u.box[_]){u.box[_]=!0;const g=4*_;if(this._circleAndRectCollide(c.x,c.y,c.radius,p[g+0],p[g+1],p[g+2],p[g+3])&&(!l||l(this.boxKeys[_])))return s.push(!0),!0}}const d=this.circleCells[o];if(d!==null){const p=this.circles;for(const _ of d)if(!u.circle[_]){u.circle[_]=!0;const g=3*_;if(this._circlesCollide(p[g],p[g+1],p[g+2],c.x,c.y,c.radius)&&(!l||l(this.circleKeys[_])))return s.push(!0),!0}}}_forEachCell(t,i,n,r,o,s,a,l){const c=this._convertToXCellCoord(t),u=this._convertToYCellCoord(i),h=this._convertToXCellCoord(n),d=this._convertToYCellCoord(r);for(let p=c;p<=h;p++)for(let _=u;_<=d;_++)if(o.call(this,t,i,n,r,this.xCellCount*_+p,s,a,l))return}_convertToXCellCoord(t){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(t*this.xScale)))}_convertToYCellCoord(t){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(t*this.yScale)))}_circlesCollide(t,i,n,r,o,s){const a=r-t,l=o-i,c=n+s;return c*c>a*a+l*l}_circleAndRectCollide(t,i,n,r,o,s,a){const l=(s-r)/2,c=Math.abs(t-(r+l));if(c>l+n)return!1;const u=(a-o)/2,h=Math.abs(i-(o+u));if(h>u+n)return!1;if(c<=l||h<=u)return!0;const d=c-l,p=h-u;return d*d+p*p<=n*n}}const Oo=100;class qI{constructor(t,i,n=new Nb(t.width+200,t.height+200,25),r=new Nb(t.width+200,t.height+200,25)){this.transform=t,this.grid=n,this.ignoredGrid=r,this.pitchfactor=Math.cos(t._pitch)*t.cameraToCenterDistance,this.screenRightBoundary=t.width+Oo,this.screenBottomBoundary=t.height+Oo,this.gridRightBoundary=t.width+200,this.gridBottomBoundary=t.height+200,this.fogState=i}placeCollisionBox(t,i,n,r,o,s,a,l){let c=n.projectedAnchorX,u=n.projectedAnchorY,h=n.projectedAnchorZ;const d=n.elevation,p=n.tileID,_=t.getProjection();if(d&&p){const[S,D,z]=_.upVector(p.canonical,n.tileAnchorX,n.tileAnchorY),L=_.upVectorScale(p.canonical,this.transform.center.lat,this.transform.worldSize).metersToTile;c+=S*d*L,u+=D*d*L,h+=z*d*L}const g=this.projectAndGetPerspectiveRatio(a,c,u,h,n.tileID,_.name==="globe"||!!d||this.transform.pitch>0,_),y=s*g.perspectiveRatio,x=(n.x1*i+r.x-n.padding)*y+g.point.x,b=(n.y1*i+r.y-n.padding)*y+g.point.y,M=(n.x2*i+r.x+n.padding)*y+g.point.x,E=(n.y2*i+r.y+n.padding)*y+g.point.y,T=g.perspectiveRatio<=.55||g.occluded;return!this.isInsideGrid(x,b,M,E)||!o&&this.grid.hitTest(x,b,M,E,l)||T?{box:[],offscreen:!1,occluded:g.occluded}:{box:[x,b,M,E],offscreen:this.isOffscreen(x,b,M,E),occluded:!1}}placeCollisionCircles(t,i,n,r,o,s,a,l,c,u,h,d,p,_,g){const y=[],x=this.transform.elevation,b=t.getProjection(),M=x?x.getAtTileOffsetFunc(g,this.transform.center.lat,this.transform.worldSize,b):null,E=new G(n.tileAnchorX,n.tileAnchorY);let{x:T,y:S,z:D}=b.projectTilePoint(E.x,E.y,g.canonical);if(M){const[ot,$,Y]=M(E);T+=ot,S+=$,D+=Y}const z=b.name==="globe",L=this.projectAndGetPerspectiveRatio(a,T,S,D,g,z||!!x||this.transform.pitch>0,b),{perspectiveRatio:R}=L,N=(h?s/R:s*R)/$n,U=uo(T,S,D,l),H=L.signedDistanceFromCamera>0?gx(N,o,n.lineOffsetX*N,n.lineOffsetY*N,!1,U,E,n,r,l,{},x&&!h?M:null,h&&!!x,b,g,h):null;let O=!1,X=!1,K=!0;if(H&&!L.occluded){const ot=.5*p*R+_,$=new G(-100,-100),Y=new G(this.screenRightBoundary,this.screenBottomBoundary),at=new GI,{first:ut,last:ct}=H,bt=ut.path.length;let Mt=[];for(let kt=bt-1;kt>=1;kt--)Mt.push(ut.path[kt]);for(let kt=1;kt<ct.path.length;kt++)Mt.push(ct.path[kt]);const Et=2.5*ot;c&&(Mt=Mt.map(([kt,Qt,te],oe)=>(M&&!z&&(te=M(oe<bt-1?ut.tilePath[bt-1-oe]:ct.tilePath[oe-bt+2])[2]),uo(kt,Qt,te,c))),Mt.some(kt=>kt[3]<=0)&&(Mt=[]));let ft=[];if(Mt.length>0){let kt=1/0,Qt=-1/0,te=1/0,oe=-1/0;for(const ce of Mt)kt=Math.min(kt,ce[0]),te=Math.min(te,ce[1]),Qt=Math.max(Qt,ce[0]),oe=Math.max(oe,ce[1]);Qt>=$.x&&kt<=Y.x&&oe>=$.y&&te<=Y.y&&(ft=[Mt.map(ce=>new G(ce[0],ce[1]))],(kt<$.x||Qt>Y.x||te<$.y||oe>Y.y)&&(ft=Uv(ft,$.x,$.y,Y.x,Y.y)))}for(const kt of ft){at.reset(kt,.25*ot);let Qt=0;Qt=at.length<=.5*ot?1:Math.ceil(at.paddedLength/Et)+1;for(let te=0;te<Qt;te++){const oe=te/Math.max(Qt-1,1),ce=at.lerp(oe),Ce=ce.x+Oo,ge=ce.y+Oo;y.push(Ce,ge,ot,0);const bi=Ce-ot,ni=ge-ot,De=Ce+ot,we=ge+ot;if(K=K&&this.isOffscreen(bi,ni,De,we),X=X||this.isInsideGrid(bi,ni,De,we),!i&&this.grid.hitTestCircle(Ce,ge,ot,d)&&(O=!0,!u))return{circles:[],offscreen:!1,collisionDetected:O,occluded:!1}}}}return{circles:!u&&O||!X?[]:y,offscreen:K,collisionDetected:O,occluded:L.occluded}}queryRenderedSymbols(t){if(t.length===0||this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0)return{};const i=[];let n=1/0,r=1/0,o=-1/0,s=-1/0;for(const u of t){const h=new G(u.x+Oo,u.y+Oo);n=Math.min(n,h.x),r=Math.min(r,h.y),o=Math.max(o,h.x),s=Math.max(s,h.y),i.push(h)}const a=this.grid.query(n,r,o,s).concat(this.ignoredGrid.query(n,r,o,s)),l={},c={};for(const u of a){const h=u.key;l[h.bucketInstanceId]===void 0&&(l[h.bucketInstanceId]={}),l[h.bucketInstanceId][h.featureIndex]||q1(i,[new G(u.x1,u.y1),new G(u.x2,u.y1),new G(u.x2,u.y2),new G(u.x1,u.y2)])&&(l[h.bucketInstanceId][h.featureIndex]=!0,c[h.bucketInstanceId]===void 0&&(c[h.bucketInstanceId]=[]),c[h.bucketInstanceId].push(h.featureIndex))}return c}insertCollisionBox(t,i,n,r,o){(i?this.ignoredGrid:this.grid).insert({bucketInstanceId:n,featureIndex:r,collisionGroupID:o},t[0],t[1],t[2],t[3])}insertCollisionCircles(t,i,n,r,o){const s=i?this.ignoredGrid:this.grid,a={bucketInstanceId:n,featureIndex:r,collisionGroupID:o};for(let l=0;l<t.length;l+=4)s.insertCircle(a,t[l],t[l+1],t[l+2])}projectAndGetPerspectiveRatio(t,i,n,r,o,s,a){const l=[i,n,r,1];let c=!1;r||this.transform.pitch>0?(Ni.transformMat4(l,l,t),this.fogState&&o&&a.name!=="globe"&&(c=function(d,p,_,g,y,x){const b=x.calculateFogTileMatrix(y),M=[p,_,g];return Z.transformMat4(M,M,b),ld(d,Z.length(M),x.pitch,x._fov)}(this.fogState,i,n,r,o.toUnwrapped(),this.transform)>.9)):wx(l,l,t);const u=l[3];return{point:new G((l[0]/u+1)/2*this.transform.width+Oo,(-l[1]/u+1)/2*this.transform.height+Oo),perspectiveRatio:Math.min(.5+this.transform.getCameraToCenterDistance(a)/u*.5,1.5),signedDistanceFromCamera:u,occluded:s&&l[2]>u||c}}isOffscreen(t,i,n,r){return n<Oo||t>=this.screenRightBoundary||r<Oo||i>this.screenBottomBoundary}isInsideGrid(t,i,n,r){return n>=0&&t<this.gridRightBoundary&&r>=0&&i<this.gridBottomBoundary}getViewportMatrix(){const t=st.identity([]);return st.translate(t,t,[-100,-100,0]),t}}function d_(e,t,i){const n=t.createTileMatrix(e,e.worldSize,i.toUnwrapped());return st.multiply(new Float32Array(16),e.projMatrix,n)}function ZI(e,t,i){if(t.projection.name===i.projection.name)return e.projMatrix;const n=i.clone();return n.setProjection(t.projection),d_(n,t.getProjection(),e)}function f_(e,t,i){return t.name===i.projection.name?e.projMatrix:d_(i,t,e)}class Ub{constructor(t,i,n,r){this.opacity=t?Math.max(0,Math.min(1,t.opacity+(t.placed?i:-i))):r&&n?1:0,this.placed=n}isHidden(){return this.opacity===0&&!this.placed}}class uu{constructor(t,i,n,r,o,s=!1){this.text=new Ub(t?t.text:null,i,n,o),this.icon=new Ub(t?t.icon:null,i,r,o),this.clipped=s}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class p_{constructor(t,i,n,r=!1){this.text=t,this.icon=i,this.skipFade=n,this.clipped=r}}class HI{constructor(){this.invProjMatrix=st.create(),this.viewportMatrix=st.create(),this.circles=[]}}class WI{constructor(t,i,n,r,o){this.bucketInstanceId=t,this.featureIndex=i,this.sourceLayerIndex=n,this.bucketIndex=r,this.tileID=o}}class $I{constructor(t){this.crossSourceCollisions=t,this.maxGroupID=0,this.collisionGroups={}}get(t){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[t]){const i=++this.maxGroupID;this.collisionGroups[t]={ID:i,predicate:n=>n.collisionGroupID===i}}return this.collisionGroups[t]}}function Vb(e,t,i,n,r){const{horizontalAlign:o,verticalAlign:s}=Rh(e),a=-(o-.5)*t,l=-(s-.5)*i,c=Pm(e,n);return new G(a+c[0]*r,l+c[1]*r)}function m_(e,t,i,n,r){const o=new G(e,t);return i&&o._rotate(n?r:-r),o}class XI{constructor(t,i,n,r,o,s){this.transform=t.clone(),this.projection=t.projection.name,this.collisionIndex=new qI(this.transform,o),this.buildingIndex=s,this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=i,this.retainedQueryData={},this.collisionGroups=new $I(n),this.collisionCircleArrays={},this.prevPlacement=r,r&&(r.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(t,i,n,r){const o=n.getBucket(i),s=n.latestFeatureIndex;if(!o||!s||i.fqid!==o.layerIds[0])return;const a=o.layers[0].layout,l=n.collisionBoxArray,c=Math.pow(2,this.transform.zoom-n.tileID.overscaledZ),u=n.tileSize/pt,h=n.tileID.toUnwrapped();this.transform.setProjection(o.projection);const d=(p=n.tileID,_=o.getProjection(),g=this.transform,_.name===this.projection?g.calculateProjMatrix(p.toUnwrapped()):d_(g,_,p));var p,_,g;const y=a.get("text-pitch-alignment")==="map",x=a.get("text-rotation-alignment")==="map";i.compileFilter();const b=i.dynamicFilter(),M=i.dynamicFilterNeedsFeature(),E=this.transform.calculatePixelsToTileUnitsMatrix(n),T=px(d,n.tileID.canonical,y,x,this.transform,o.getProjection(),E);let S=null;if(y){const L=mx(d,n.tileID.canonical,y,x,this.transform,o.getProjection(),E);S=st.multiply([],this.transform.labelPlaneMatrix,L)}let D=null;b&&n.latestFeatureIndex&&(D={unwrappedTileID:h,dynamicFilter:b,dynamicFilterNeedsFeature:M,featureIndex:n.latestFeatureIndex}),this.retainedQueryData[o.bucketInstanceId]=new WI(o.bucketInstanceId,s,o.sourceLayerIndex,o.index,n.tileID);const z={bucket:o,layout:a,posMatrix:d,textLabelPlaneMatrix:T,labelToScreenMatrix:S,clippingData:D,scale:c,textPixelRatio:u,holdingForFade:n.holdingForFade(),collisionBoxArray:l,partiallyEvaluatedTextSize:ko(o.textSizeData,this.transform.zoom),partiallyEvaluatedIconSize:ko(o.iconSizeData,this.transform.zoom),collisionGroup:this.collisionGroups.get(o.sourceID)};if(r)for(const L of o.sortKeyRanges){const{sortKey:R,symbolInstanceStart:N,symbolInstanceEnd:U}=L;t.push({sortKey:R,symbolInstanceStart:N,symbolInstanceEnd:U,parameters:z})}else t.push({symbolInstanceStart:0,symbolInstanceEnd:o.symbolInstances.length,parameters:z})}attemptAnchorPlacement(t,i,n,r,o,s,a,l,c,u,h,d,p,_,g,y,x,b){const{textOffset0:M,textOffset1:E,crossTileID:T}=d,S=[M,E],D=Vb(t,n,r,S,o),z=this.collisionIndex.placeCollisionBox(_,o,i,m_(D.x,D.y,s,a,this.transform.angle),h,l,c,u.predicate);if(y){const L=_.getSymbolInstanceIconSize(b,this.transform.zoom,d.placedIconSymbolIndex);if(this.collisionIndex.placeCollisionBox(_,L,y,m_(D.x,D.y,s,a,this.transform.angle),h,l,c,u.predicate).box.length===0)return}if(z.box.length>0){let L;return this.prevPlacement&&this.prevPlacement.variableOffsets[T]&&this.prevPlacement.placements[T]&&this.prevPlacement.placements[T].text&&(L=this.prevPlacement.variableOffsets[T].anchor),this.variableOffsets[T]={textOffset:S,width:n,height:r,anchor:t,textScale:o,prevAnchor:L},this.markUsedJustification(_,t,d,g),_.allowVerticalPlacement&&(this.markUsedOrientation(_,g,d),this.placedOrientations[T]=g),{shift:D,placedGlyphBoxes:z}}}placeLayerBucketPart(t,i,n,r){const{bucket:o,layout:s,posMatrix:a,textLabelPlaneMatrix:l,labelToScreenMatrix:c,clippingData:u,textPixelRatio:h,holdingForFade:d,collisionBoxArray:p,partiallyEvaluatedTextSize:_,partiallyEvaluatedIconSize:g,collisionGroup:y}=t.parameters,x=s.get("text-optional"),b=s.get("icon-optional"),M=s.get("text-allow-overlap"),E=s.get("icon-allow-overlap"),T=s.get("text-rotation-alignment")==="map",S=s.get("text-pitch-alignment")==="map",D=s.get("symbol-z-order")==="viewport-y",z=s.get("symbol-z-elevate");this.transform.setProjection(o.projection);let L=M&&(E||!o.hasIconData()||b),R=E&&(M||!o.hasTextData()||x);!o.collisionArrays&&p&&o.deserializeCollisionBoxes(p),n&&r&&o.updateCollisionDebugBuffers(this.transform.zoom,p);const N=(U,H,O)=>{const{crossTileID:X,numVerticalGlyphVertices:K}=U;if(u){const De={zoom:this.transform.zoom,pitch:this.transform.pitch};let we=null;if(u.dynamicFilterNeedsFeature){const ye=this.retainedQueryData[o.bucketInstanceId];we=u.featureIndex.loadFeature({featureIndex:U.featureIndex,bucketIndex:ye.bucketIndex,sourceLayerIndex:ye.sourceLayerIndex,layoutVertexArrayOffset:0})}if(!(0,u.dynamicFilter)(De,we,this.retainedQueryData[o.bucketInstanceId].tileID.canonical,new G(U.tileAnchorX,U.tileAnchorY),this.transform.calculateDistanceTileData(u.unwrappedTileID)))return this.placements[X]=new p_(!1,!1,!1,!0),void i.add(X)}if(i.has(X))return;if(d)return void(this.placements[X]=new p_(!1,!1,!1));let ot=!1,$=!1,Y=!0,at=!1,ut=!1,ct=null,bt={box:null,offscreen:null,occluded:null},Mt={box:null,offscreen:null,occluded:null},Et=null,ft=null,kt=null,Qt=0,te=0,oe=0;O.textFeatureIndex?Qt=O.textFeatureIndex:U.useRuntimeCollisionCircles&&(Qt=U.featureIndex),O.verticalTextFeatureIndex&&(te=O.verticalTextFeatureIndex);const ce=De=>{De.tileID=this.retainedQueryData[o.bucketInstanceId].tileID;const we=this.transform.elevation;De.elevation=U.zOffset+(we?we.getAtTileOffset(De.tileID,De.tileAnchorX,De.tileAnchorY):0)},Ce=O.textBox;if(Ce){ce(Ce);const De=ye=>{let si=un.horizontal;if(o.allowVerticalPlacement&&!ye&&this.prevPlacement){const pi=this.prevPlacement.placedOrientations[X];pi&&(this.placedOrientations[X]=pi,si=pi,this.markUsedOrientation(o,si,U))}return si},we=(ye,si)=>{if(o.allowVerticalPlacement&&K>0&&O.verticalTextBox){for(const pi of o.writingModes)if(pi===un.vertical?(bt=si(),Mt=bt):bt=ye(),bt&&bt.box&&bt.box.length)break}else bt=ye()};if(s.get("text-variable-anchor")){let ye=s.get("text-variable-anchor");if(this.prevPlacement&&this.prevPlacement.variableOffsets[X]){const $e=this.prevPlacement.variableOffsets[X];ye.indexOf($e.anchor)>0&&(ye=ye.filter(qi=>qi!==$e.anchor),ye.unshift($e.anchor))}const si=($e,qi,An)=>{const Ui=o.getSymbolInstanceTextSize(_,U,this.transform.zoom,H),nn=($e.x2-$e.x1)*Ui+2*$e.padding,Dn=($e.y2-$e.y1)*Ui+2*$e.padding,In=U.hasIconTextFit&&!E?qi:null;In&&ce(In);let sn={box:[],offscreen:!1,occluded:!1};const Ri=M?2*ye.length:ye.length;for(let Jn=0;Jn<Ri;++Jn){const Fo=this.attemptAnchorPlacement(ye[Jn%ye.length],$e,nn,Dn,Ui,T,S,h,a,y,Jn>=ye.length,U,H,o,An,In,_,g);if(Fo&&(sn=Fo.placedGlyphBoxes,sn&&sn.box&&sn.box.length)){ot=!0,ct=Fo.shift;break}}return sn};we(()=>si(Ce,O.iconBox,un.horizontal),()=>{const $e=O.verticalTextBox;return $e&&ce($e),o.allowVerticalPlacement&&!(bt&&bt.box&&bt.box.length)&&K>0&&$e?si($e,O.verticalIconBox,un.vertical):{box:null,offscreen:null,occluded:null}}),bt&&(ot=bt.box,Y=bt.offscreen,at=bt.occluded);const pi=De(!(!bt||!bt.box));if(!ot&&this.prevPlacement){const $e=this.prevPlacement.variableOffsets[X];$e&&(this.variableOffsets[X]=$e,this.markUsedJustification(o,$e.anchor,U,pi))}}else{const ye=(si,pi)=>{const $e=o.getSymbolInstanceTextSize(_,U,this.transform.zoom,H),qi=this.collisionIndex.placeCollisionBox(o,$e,si,new G(0,0),M,h,a,y.predicate);return qi&&qi.box&&qi.box.length&&(this.markUsedOrientation(o,pi,U),this.placedOrientations[X]=pi),qi};we(()=>ye(Ce,un.horizontal),()=>{const si=O.verticalTextBox;return o.allowVerticalPlacement&&K>0&&si?(ce(si),ye(si,un.vertical)):{box:null,offscreen:null,occluded:null}}),De(!!(bt&&bt.box&&bt.box.length))}}if(Et=bt,ot=Et&&Et.box&&Et.box.length>0,Y=Et&&Et.offscreen,at=Et&&Et.occluded,U.useRuntimeCollisionCircles){const De=o.text.placedSymbolArray.get(U.centerJustifiedTextSymbolIndex>=0?U.centerJustifiedTextSymbolIndex:U.verticalPlacedTextSymbolIndex),we=jc(o.textSizeData,_,De),ye=s.get("text-padding");ft=this.collisionIndex.placeCollisionCircles(o,M,De,o.lineVertexArray,o.glyphOffsetArray,we,a,l,c,n,S,y.predicate,U.collisionCircleDiameter*we/$n,ye,this.retainedQueryData[o.bucketInstanceId].tileID),ot=M||ft.circles.length>0&&!ft.collisionDetected,Y=Y&&ft.offscreen,at=ft.occluded}if(O.iconFeatureIndex&&(oe=O.iconFeatureIndex),O.iconBox){const De=we=>{ce(we);const ye=U.hasIconTextFit&&ct?m_(ct.x,ct.y,T,S,this.transform.angle):new G(0,0),si=o.getSymbolInstanceIconSize(g,this.transform.zoom,U.placedIconSymbolIndex);return this.collisionIndex.placeCollisionBox(o,si,we,ye,E,h,a,y.predicate)};Mt&&Mt.box&&Mt.box.length&&O.verticalIconBox?(kt=De(O.verticalIconBox),$=kt.box.length>0):(kt=De(O.iconBox),$=kt.box.length>0),Y=Y&&kt.offscreen,ut=kt.occluded}const ge=x||U.numHorizontalGlyphVertices===0&&K===0,bi=b||U.numIconVertices===0;if(ge||bi?bi?ge||($=$&&ot):ot=$&&ot:$=ot=$&&ot,ot&&Et&&Et.box&&this.collisionIndex.insertCollisionBox(Et.box,s.get("text-ignore-placement"),o.bucketInstanceId,Mt&&Mt.box&&te?te:Qt,y.ID),$&&kt&&this.collisionIndex.insertCollisionBox(kt.box,s.get("icon-ignore-placement"),o.bucketInstanceId,oe,y.ID),ft&&(ot&&this.collisionIndex.insertCollisionCircles(ft.circles,s.get("text-ignore-placement"),o.bucketInstanceId,Qt,y.ID),n)){const De=o.bucketInstanceId;let we=this.collisionCircleArrays[De];we===void 0&&(we=this.collisionCircleArrays[De]=new HI);for(let ye=0;ye<ft.circles.length;ye+=4)we.circles.push(ft.circles[ye+0]),we.circles.push(ft.circles[ye+1]),we.circles.push(ft.circles[ye+2]),we.circles.push(ft.collisionDetected?1:0)}const ni=o.projection.name!=="globe";L=L&&(ni||!at),R=R&&(ni||!ut),this.placements[X]=new p_(ot||L,$||R,Y||o.justReloaded),i.add(X)};if(z&&this.buildingIndex&&(this.buildingIndex.updateZOffset(o,this.retainedQueryData[o.bucketInstanceId].tileID),o.updateZOffset()),D){const U=o.getSortedSymbolIndexes(this.transform.angle);for(let H=U.length-1;H>=0;--H){const O=U[H];N(o.symbolInstances.get(O),O,o.collisionArrays[O])}o.hasAnyZOffset&&J(`${o.layerIds[0]} layer symbol-z-elevate: symbols are not sorted by elevation if symbol-z-order is evaluated to viewport-y`)}else if(o.hasAnyZOffset){const U=o.getSortedIndexesByZOffset();for(let H=0;H<U.length;++H){const O=U[H];N(o.symbolInstances.get(O),O,o.collisionArrays[O])}}else for(let U=t.symbolInstanceStart;U<t.symbolInstanceEnd;U++)N(o.symbolInstances.get(U),U,o.collisionArrays[U]);if(n&&o.bucketInstanceId in this.collisionCircleArrays){const U=this.collisionCircleArrays[o.bucketInstanceId];st.invert(U.invProjMatrix,a),U.viewportMatrix=this.collisionIndex.getViewportMatrix()}o.justReloaded=!1}markUsedJustification(t,i,n,r){const{leftJustifiedTextSymbolIndex:o,centerJustifiedTextSymbolIndex:s,rightJustifiedTextSymbolIndex:a,verticalPlacedTextSymbolIndex:l,crossTileID:c}=n,u=km(i),h=r===un.vertical?l:u==="left"?o:u==="center"?s:u==="right"?a:-1;o>=0&&(t.text.placedSymbolArray.get(o).crossTileID=h>=0&&o!==h?0:c),s>=0&&(t.text.placedSymbolArray.get(s).crossTileID=h>=0&&s!==h?0:c),a>=0&&(t.text.placedSymbolArray.get(a).crossTileID=h>=0&&a!==h?0:c),l>=0&&(t.text.placedSymbolArray.get(l).crossTileID=h>=0&&l!==h?0:c)}markUsedOrientation(t,i,n){const r=i===un.horizontal||i===un.horizontalOnly?i:0,o=i===un.vertical?i:0,{leftJustifiedTextSymbolIndex:s,centerJustifiedTextSymbolIndex:a,rightJustifiedTextSymbolIndex:l,verticalPlacedTextSymbolIndex:c}=n,u=t.text.placedSymbolArray;s>=0&&(u.get(s).placedOrientation=r),a>=0&&(u.get(a).placedOrientation=r),l>=0&&(u.get(l).placedOrientation=r),c>=0&&(u.get(c).placedOrientation=o)}commit(t){this.commitTime=t,this.zoomAtLastRecencyCheck=this.transform.zoom;const i=this.prevPlacement;let n=!1;this.prevZoomAdjustment=i?i.zoomAdjustment(this.transform.zoom):0;const r=i?i.symbolFadeChange(t):1,o=i?i.opacities:{},s=i?i.variableOffsets:{},a=i?i.placedOrientations:{};for(const l in this.placements){const c=this.placements[l],u=o[l];u?(this.opacities[l]=new uu(u,r,c.text,c.icon,null,c.clipped),n=n||c.text!==u.text.placed||c.icon!==u.icon.placed):(this.opacities[l]=new uu(null,r,c.text,c.icon,c.skipFade,c.clipped),n=n||c.text||c.icon)}for(const l in o){const c=o[l];if(!this.opacities[l]){const u=new uu(c,r,!1,!1);u.isHidden()||(this.opacities[l]=u,n=n||c.text.placed||c.icon.placed)}}for(const l in s)this.variableOffsets[l]||!this.opacities[l]||this.opacities[l].isHidden()||(this.variableOffsets[l]=s[l]);for(const l in a)this.placedOrientations[l]||!this.opacities[l]||this.opacities[l].isHidden()||(this.placedOrientations[l]=a[l]);n?this.lastPlacementChangeTime=t:typeof this.lastPlacementChangeTime!="number"&&(this.lastPlacementChangeTime=i?i.lastPlacementChangeTime:t)}updateLayerOpacities(t,i){const n=new Set;for(const r of i){const o=r.getBucket(t);o&&r.latestFeatureIndex&&t.fqid===o.layerIds[0]&&(this.updateBucketOpacities(o,n,r.collisionBoxArray),o.layers[0].layout.get("symbol-z-elevate")&&this.buildingIndex&&(this.buildingIndex.updateZOffset(o,r.tileID),o.updateZOffset()))}}updateBucketOpacities(t,i,n){t.hasTextData()&&t.text.opacityVertexArray.clear(),t.hasIconData()&&t.icon.opacityVertexArray.clear(),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexArray.clear(),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexArray.clear();const r=t.layers[0].layout,o=!!t.layers[0].dynamicFilter(),s=new uu(null,0,!1,!1,!0),a=r.get("text-allow-overlap"),l=r.get("icon-allow-overlap"),c=r.get("text-variable-anchor"),u=r.get("text-rotation-alignment")==="map",h=r.get("text-pitch-alignment")==="map",d=new uu(null,0,a&&(l||!t.hasIconData()||r.get("icon-optional")),l&&(a||!t.hasTextData()||r.get("text-optional")),!0);!t.collisionArrays&&n&&(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData())&&t.deserializeCollisionBoxes(n);const p=(g,y,x)=>{for(let b=0;b<y/4;b++)g.opacityVertexArray.emplaceBack(x)};let _=0;for(let g=0;g<t.symbolInstances.length;g++){const y=t.symbolInstances.get(g),{numHorizontalGlyphVertices:x,numVerticalGlyphVertices:b,crossTileID:M,numIconVertices:E}=y,T=i.has(M);let S=this.opacities[M];T?S=s:S||(S=d,this.opacities[M]=S),i.add(M);const D=x>0||b>0,z=E>0,L=this.placedOrientations[M],R=L===un.vertical,N=L===un.horizontal||L===un.horizontalOnly;if(!D&&!z||S.isHidden()||_++,D){const U=jb(S.text);p(t.text,x,R?md:U),p(t.text,b,N?md:U);const H=S.text.isHidden(),{leftJustifiedTextSymbolIndex:O,centerJustifiedTextSymbolIndex:X,rightJustifiedTextSymbolIndex:K,verticalPlacedTextSymbolIndex:ot}=y,$=t.text.placedSymbolArray,Y=H||R?1:0;O>=0&&($.get(O).hidden=Y),X>=0&&($.get(X).hidden=Y),K>=0&&($.get(K).hidden=Y),ot>=0&&($.get(ot).hidden=H||N?1:0);const at=this.variableOffsets[M];at&&this.markUsedJustification(t,at.anchor,y,L);const ut=this.placedOrientations[M];ut&&(this.markUsedJustification(t,"left",y,ut),this.markUsedOrientation(t,ut,y))}if(z){const U=jb(S.icon),{placedIconSymbolIndex:H,verticalPlacedIconSymbolIndex:O}=y,X=t.icon.placedSymbolArray,K=S.icon.isHidden()?1:0;H>=0&&(p(t.icon,E,R?md:U),X.get(H).hidden=K),O>=0&&(p(t.icon,y.numVerticalIconVertices,N?md:U),X.get(O).hidden=K)}if(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData()){const U=t.collisionArrays[g];if(U){let H=new G(0,0),O=!0;if(U.textBox||U.verticalTextBox){if(c){const K=this.variableOffsets[M];K?(H=Vb(K.anchor,K.width,K.height,K.textOffset,K.textScale),u&&H._rotate(h?this.transform.angle:-this.transform.angle)):O=!1}o&&(O=!S.clipped),U.textBox&&pd(t.textCollisionBox.collisionVertexArray,S.text.placed,!O||R,H.x,H.y),U.verticalTextBox&&pd(t.textCollisionBox.collisionVertexArray,S.text.placed,!O||N,H.x,H.y)}const X=O&&!!(!N&&U.verticalIconBox);U.iconBox&&pd(t.iconCollisionBox.collisionVertexArray,S.icon.placed,X,y.hasIconTextFit?H.x:0,y.hasIconTextFit?H.y:0),U.verticalIconBox&&pd(t.iconCollisionBox.collisionVertexArray,S.icon.placed,!X,y.hasIconTextFit?H.x:0,y.hasIconTextFit?H.y:0)}}}if(t.fullyClipped=_===0,t.sortFeatures(this.transform.angle),this.retainedQueryData[t.bucketInstanceId]&&(this.retainedQueryData[t.bucketInstanceId].featureSortOrder=t.featureSortOrder),t.hasTextData()&&t.text.opacityVertexBuffer&&t.text.opacityVertexBuffer.updateData(t.text.opacityVertexArray),t.hasIconData()&&t.icon.opacityVertexBuffer&&t.icon.opacityVertexBuffer.updateData(t.icon.opacityVertexArray),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexBuffer&&t.iconCollisionBox.collisionVertexBuffer.updateData(t.iconCollisionBox.collisionVertexArray),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexBuffer&&t.textCollisionBox.collisionVertexBuffer.updateData(t.textCollisionBox.collisionVertexArray),t.bucketInstanceId in this.collisionCircleArrays){const g=this.collisionCircleArrays[t.bucketInstanceId];t.placementInvProjMatrix=g.invProjMatrix,t.placementViewportMatrix=g.viewportMatrix,t.collisionCircleArray=g.circles,delete this.collisionCircleArrays[t.bucketInstanceId]}}symbolFadeChange(t){return this.fadeDuration===0?1:(t-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(t){return Math.max(0,(this.transform.zoom-t)/1.5)}hasTransitions(t){return this.stale||t-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(t,i){const n=this.zoomAtLastRecencyCheck===i?1-this.zoomAdjustment(i):1;return this.zoomAtLastRecencyCheck=i,this.commitTime+this.fadeDuration*n>t}setStale(){this.stale=!0}}function pd(e,t,i,n,r){e.emplaceBack(t?1:0,i?1:0,n||0,r||0),e.emplaceBack(t?1:0,i?1:0,n||0,r||0),e.emplaceBack(t?1:0,i?1:0,n||0,r||0),e.emplaceBack(t?1:0,i?1:0,n||0,r||0)}const YI=Math.pow(2,25),KI=Math.pow(2,24),JI=Math.pow(2,17),QI=Math.pow(2,16),tC=Math.pow(2,9),eC=Math.pow(2,8),iC=Math.pow(2,1);function jb(e){if(e.opacity===0&&!e.placed)return 0;if(e.opacity===1&&e.placed)return 4294967295;const t=e.placed?1:0,i=Math.floor(127*e.opacity);return i*YI+t*KI+i*JI+t*QI+i*tC+t*eC+i*iC+t}const md=0;class nC{constructor(t){this._sortAcrossTiles=t.layout.get("symbol-z-order")!=="viewport-y"&&t.layout.get("symbol-sort-key").constantOr(1)!==void 0,this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs=new Set,this._bucketParts=[]}continuePlacement(t,i,n,r,o){const s=this._bucketParts;for(;this._currentTileIndex<t.length;)if(i.getBucketParts(s,r,t[this._currentTileIndex],this._sortAcrossTiles),this._currentTileIndex++,o())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,s.sort((a,l)=>a.sortKey-l.sortKey));this._currentPartIndex<s.length;){const a=s[this._currentPartIndex];if(i.placeLayerBucketPart(a,this._seenCrossTileIDs,n,a.symbolInstanceStart===0),this._currentPartIndex++,o())return!0}return!1}}class rC{constructor(t,i,n,r,o,s,a,l,c){this.placement=new XI(t,o,s,a,l,c),this._currentPlacementIndex=i.length-1,this._forceFullPlacement=n,this._showCollisionBoxes=r,this._done=!1}isDone(){return this._done}continuePlacement(t,i,n,r){const o=ke.now(),s=()=>{const a=ke.now()-o;return!this._forceFullPlacement&&a>2};for(;this._currentPlacementIndex>=0;){const a=i[t[this._currentPlacementIndex]],l=this.placement.collisionIndex.transform.zoom;if(a.type==="symbol"&&(!a.minzoom||a.minzoom<=l)&&(!a.maxzoom||a.maxzoom>l)){const c=a,u=c.layout.get("symbol-z-elevate"),h=this._inProgressLayer=this._inProgressLayer||new nC(c),d=cr(a.source,a.scope);if(h.continuePlacement(u?r[d]:n[d],this.placement,this._showCollisionBoxes,a,s))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(t){return this.placement.commit(t),this.placement}}const Gb=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class _d{static from(t){if(!(t instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[i,n]=new Uint8Array(t,0,2);if(i!==219)throw new Error("Data does not appear to be in a KDBush format.");const r=n>>4;if(r!==1)throw new Error(`Got v${r} data when expected v1.`);const o=Gb[15&n];if(!o)throw new Error("Unrecognized array type.");const[s]=new Uint16Array(t,2,1),[a]=new Uint32Array(t,4,1);return new _d(a,s,o,t)}constructor(t,i=64,n=Float64Array,r){if(isNaN(t)||t<0)throw new Error(`Unpexpected numItems value: ${t}.`);this.numItems=+t,this.nodeSize=Math.min(Math.max(+i,2),65535),this.ArrayType=n,this.IndexArrayType=t<65536?Uint16Array:Uint32Array;const o=Gb.indexOf(this.ArrayType),s=2*t*this.ArrayType.BYTES_PER_ELEMENT,a=t*this.IndexArrayType.BYTES_PER_ELEMENT,l=(8-a%8)%8;if(o<0)throw new Error(`Unexpected typed array class: ${n}.`);r&&r instanceof ArrayBuffer?(this.data=r,this.ids=new this.IndexArrayType(this.data,8,t),this.coords=new this.ArrayType(this.data,8+a+l,2*t),this._pos=2*t,this._finished=!0):(this.data=new ArrayBuffer(8+s+a+l),this.ids=new this.IndexArrayType(this.data,8,t),this.coords=new this.ArrayType(this.data,8+a+l,2*t),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+o]),new Uint16Array(this.data,2,1)[0]=i,new Uint32Array(this.data,4,1)[0]=t)}add(t,i){const n=this._pos>>1;return this.ids[n]=n,this.coords[this._pos++]=t,this.coords[this._pos++]=i,n}finish(){const t=this._pos>>1;if(t!==this.numItems)throw new Error(`Added ${t} items when expected ${this.numItems}.`);return __(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(t,i,n,r){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:o,coords:s,nodeSize:a}=this,l=[0,o.length-1,0],c=[];for(;l.length;){const u=l.pop()||0,h=l.pop()||0,d=l.pop()||0;if(h-d<=a){for(let y=d;y<=h;y++){const x=s[2*y],b=s[2*y+1];x>=t&&x<=n&&b>=i&&b<=r&&c.push(o[y])}continue}const p=d+h>>1,_=s[2*p],g=s[2*p+1];_>=t&&_<=n&&g>=i&&g<=r&&c.push(o[p]),(u===0?t<=_:i<=g)&&(l.push(d),l.push(p-1),l.push(1-u)),(u===0?n>=_:r>=g)&&(l.push(p+1),l.push(h),l.push(1-u))}return c}within(t,i,n){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:r,coords:o,nodeSize:s}=this,a=[0,r.length-1,0],l=[],c=n*n;for(;a.length;){const u=a.pop()||0,h=a.pop()||0,d=a.pop()||0;if(h-d<=s){for(let y=d;y<=h;y++)Zb(o[2*y],o[2*y+1],t,i)<=c&&l.push(r[y]);continue}const p=d+h>>1,_=o[2*p],g=o[2*p+1];Zb(_,g,t,i)<=c&&l.push(r[p]),(u===0?t-n<=_:i-n<=g)&&(a.push(d),a.push(p-1),a.push(1-u)),(u===0?t+n>=_:i+n>=g)&&(a.push(p+1),a.push(h),a.push(1-u))}return l}}function __(e,t,i,n,r,o){if(r-n<=i)return;const s=n+r>>1;qb(e,t,s,n,r,o),__(e,t,i,n,s-1,1-o),__(e,t,i,s+1,r,1-o)}function qb(e,t,i,n,r,o){for(;r>n;){if(r-n>600){const c=r-n+1,u=i-n+1,h=Math.log(c),d=.5*Math.exp(2*h/3),p=.5*Math.sqrt(h*d*(c-d)/c)*(u-c/2<0?-1:1);qb(e,t,i,Math.max(n,Math.floor(i-u*d/c+p)),Math.min(r,Math.floor(i+(c-u)*d/c+p)),o)}const s=t[2*i+o];let a=n,l=r;for(hu(e,t,n,i),t[2*r+o]>s&&hu(e,t,n,r);a<l;){for(hu(e,t,a,l),a++,l--;t[2*a+o]<s;)a++;for(;t[2*l+o]>s;)l--}t[2*n+o]===s?hu(e,t,n,l):(l++,hu(e,t,l,r)),l<=i&&(n=l+1),i<=l&&(r=l-1)}}function hu(e,t,i,n){g_(e,i,n),g_(t,2*i,2*n),g_(t,2*i+1,2*n+1)}function g_(e,t,i){const n=e[t];e[t]=e[i],e[i]=n}function Zb(e,t,i,n){const r=e-i,o=t-n;return r*r+o*o}const y_=512/pt/2;class oC{constructor(t,i,n){this.tileID=t,this.bucketInstanceId=n,this.index=new _d(i.length,16,Int32Array),this.keys=[],this.crossTileIDs=[];const r=t.canonical.x*pt,o=t.canonical.y*pt;for(let s=0;s<i.length;s++){const{key:a,crossTileID:l,tileAnchorX:c,tileAnchorY:u}=i.get(s),h=Math.floor((r+c)*y_),d=Math.floor((o+u)*y_);this.index.add(h,d),this.keys.push(a),this.crossTileIDs.push(l)}this.index.finish()}findMatches(t,i,n){const r=this.tileID.canonical.z<i.canonical.z?1:Math.pow(2,this.tileID.canonical.z-i.canonical.z),o=y_/Math.pow(2,i.canonical.z-this.tileID.canonical.z),s=i.canonical.x*pt,a=i.canonical.y*pt;for(let l=0;l<t.length;l++){const c=t.get(l);if(c.crossTileID)continue;const{key:u,tileAnchorX:h,tileAnchorY:d}=c,p=Math.floor((s+h)*o),_=Math.floor((a+d)*o),g=this.index.range(p-r,_-r,p+r,_+r);for(const y of g){const x=this.crossTileIDs[y];if(this.keys[y]===u&&!n.has(x)){n.add(x),c.crossTileID=x;break}}}}}class sC{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class aC{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(t){const i=Math.round((t-this.lng)/360);if(i!==0)for(const n in this.indexes){const r=this.indexes[n],o={};for(const s in r){const a=r[s];a.tileID=a.tileID.unwrapTo(a.tileID.wrap+i),o[a.tileID.key]=a}this.indexes[n]=o}this.lng=t}addBucket(t,i,n){if(this.indexes[t.overscaledZ]&&this.indexes[t.overscaledZ][t.key]){if(this.indexes[t.overscaledZ][t.key].bucketInstanceId===i.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(t.overscaledZ,this.indexes[t.overscaledZ][t.key])}for(let o=0;o<i.symbolInstances.length;o++)i.symbolInstances.get(o).crossTileID=0;this.usedCrossTileIDs[t.overscaledZ]||(this.usedCrossTileIDs[t.overscaledZ]=new Set);const r=this.usedCrossTileIDs[t.overscaledZ];for(const o in this.indexes){const s=this.indexes[o];if(Number(o)>t.overscaledZ)for(const a in s){const l=s[a];l.tileID.isChildOf(t)&&l.findMatches(i.symbolInstances,t,r)}else{const a=s[t.scaledTo(Number(o)).key];a&&a.findMatches(i.symbolInstances,t,r)}}for(let o=0;o<i.symbolInstances.length;o++){const s=i.symbolInstances.get(o);s.crossTileID||(s.crossTileID=n.generate(),r.add(s.crossTileID))}return this.indexes[t.overscaledZ]===void 0&&(this.indexes[t.overscaledZ]={}),this.indexes[t.overscaledZ][t.key]=new oC(t,i.symbolInstances,i.bucketInstanceId),!0}removeBucketCrossTileIDs(t,i){for(const n of i.crossTileIDs)this.usedCrossTileIDs[t].delete(n)}removeStaleBuckets(t){let i=!1;for(const n in this.indexes){const r=this.indexes[n];for(const o in r)t[r[o].bucketInstanceId]||(this.removeBucketCrossTileIDs(n,r[o]),delete r[o],i=!0)}return i}}class lC{constructor(){this.layerIndexes={},this.crossTileIDs=new sC,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(t,i,n,r){let o=this.layerIndexes[t.fqid];o===void 0&&(o=this.layerIndexes[t.fqid]=new aC);let s=!1;const a={};r.name!=="globe"&&o.handleWrapJump(n);for(const l of i){const c=l.getBucket(t);c&&t.fqid===c.layerIds[0]&&(c.bucketInstanceId||(c.bucketInstanceId=++this.maxBucketInstanceId),o.addBucket(l.tileID,c,this.crossTileIDs)&&(s=!0),a[c.bucketInstanceId]=!0)}return o.removeStaleBuckets(a)&&(s=!0),s}pruneUnusedLayers(t){const i={};t.forEach(n=>{i[n]=!0});for(const n in this.layerIndexes)i[n]||delete this.layerIndexes[n]}}var Hb=`
#define EPSILON 0.0000001
#define PI 3.141592653589793
#ifdef RENDER_CUTOFF
float cutoff_opacity(vec4 cutoff_params,float depth) {float near=cutoff_params.x;float far=cutoff_params.y;float cutoffStart=cutoff_params.z;float cutoffEnd=cutoff_params.w-0.0001;float linearDepth=(depth-near)/(far-near);return clamp((linearDepth-cutoffStart)/(cutoffEnd-cutoffStart),0.0,1.0);}
#endif`,Wb="in highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;out highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}",$b=`
#define ELEVATION_SCALE 7.0
#define ELEVATION_OFFSET 450.0
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(
mix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}
#else
vec3 elevationVector(vec2 pos) { return vec3(0,0,1); }
#endif
#ifdef TERRAIN
uniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;uniform sampler2D u_depth;uniform vec2 u_depth_size_inv;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float currentElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem,pos).r;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(dd,0)).r;float bl=texture(u_dem,pos+vec2(0,dd)).r;float br=texture(u_dem,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}float prevElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem_prev,pos).r;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem_prev,pos).r;float tr=texture(u_dem_prev,pos+vec2(dd,0)).r;float bl=texture(u_dem_prev,pos+vec2(0,dd)).r;float br=texture(u_dem_prev,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}
#ifdef TERRAIN_VERTEX_MORPHING
float elevation(vec2 apos) {
#ifdef ZERO_EXAGGERATION
return 0.0;
#endif
float nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}
#else
float elevation(vec2 apos) {
#ifdef ZERO_EXAGGERATION
return 0.0;
#endif
return currentElevation(apos);}
#endif
highp float unpack_depth(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}bool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;float depth=unpack_depth(texture(u_depth,(coord.xy+1.0)*0.5));return coord.z > depth+0.0005;}float occlusionFade(vec4 frag) {vec3 coord=frag.xyz/frag.w;vec3 df=vec3(5.0*u_depth_size_inv,0.0);vec2 uv=0.5*coord.xy+0.5;vec4 depth=vec4(
unpack_depth(texture(u_depth,uv-df.xz)),unpack_depth(texture(u_depth,uv+df.xz)),unpack_depth(texture(u_depth,uv-df.zy)),unpack_depth(texture(u_depth,uv+df.zy))
);return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z-0.001)-depth),0.0,1.0));}vec4 fourSample(vec2 pos,vec2 off) {float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(off.x,0.0)).r;float bl=texture(u_dem,pos+vec2(0.0,off.y)).r;float br=texture(u_dem,pos+off).r;return vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}
#else
float elevation(vec2 pos) { return 0.0; }bool isOccluded(vec4 frag) { return false; }float occlusionFade(vec4 frag) { return 1.0; }
#endif`,Xb=`#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump mat4 u_fog_matrix;out vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}
#endif`,Yb=`highp vec3 hash(highp vec2 p) {highp vec3 p3=fract(p.xyx*vec3(443.8975,397.2973,491.1871));p3+=dot(p3,p3.yxz+19.19);return fract((p3.xxy+p3.yzz)*p3.zyx);}vec3 dither(vec3 color,highp vec2 seed) {vec3 rnd=hash(seed)+hash(seed+0.59374)-0.5;return color+rnd/255.0;}
#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump vec2 u_fog_vertical_limit;uniform mediump float u_fog_temporal_offset;in vec3 v_fog_pos;uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform highp vec2 u_viewport;uniform float u_globe_transition;uniform int u_is_globe;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}float globe_glow_progress() {highp vec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float sdf=length(closest_point-u_globe_pos)/u_globe_radius;return sdf+PI*0.5;}float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos,float opacity_limit) {float depth=length(pos);float opacity;if (u_is_globe==1) {float glow_progress=globe_glow_progress();float t=mix(glow_progress,depth,u_globe_transition);opacity=fog_opacity(fog_range(t));} else {opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);}return mix(color,u_fog_color.rgb,min(opacity,opacity_limit));}vec3 fog_apply(vec3 color,vec3 pos) {return fog_apply(color,pos,1.0);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec4 fog_apply_premultiplied(vec4 color,vec3 pos,float heightMeters) {float verticalProgress=(u_fog_vertical_limit.x > 0.0 || u_fog_vertical_limit.y > 0.0) ? smoothstep(u_fog_vertical_limit.x,u_fog_vertical_limit.y,heightMeters) : 0.0;float opacityLimit=1.0-smoothstep(0.9,1.0,fog_opacity(pos));return mix(fog_apply_premultiplied(color,pos),color,min(verticalProgress,opacityLimit));}vec3 fog_dither(vec3 color) {
#ifdef FOG_DITHERING
vec2 dither_seed=gl_FragCoord.xy+u_fog_temporal_offset;return dither(color,dither_seed);
#else
return color;
#endif
}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}
#endif`,Kb=`#ifdef RASTER_ARRAY
uniform sampler2D u_image0;uniform sampler2D u_image1;const vec4 NODATA=vec4(1);vec4 _raTexLinearCoord(vec2 texCoord,vec2 texResolution,out vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return (texCoord.xxyy+vec2(1.5,0.5).xyxy)/texResolution.xxyy;}vec2 _raTexLinearMix(vec2 fxy,vec4 colorMix,float colorOffset,vec4 t00,vec4 t10,vec4 t01,vec4 t11) {vec2 c00=t00==NODATA ? vec2(0) : vec2(colorOffset+dot(t00,colorMix),1);vec2 c10=t10==NODATA ? vec2(0) : vec2(colorOffset+dot(t10,colorMix),1);vec2 c01=t01==NODATA ? vec2(0) : vec2(colorOffset+dot(t01,colorMix),1);vec2 c11=t11==NODATA ? vec2(0) : vec2(colorOffset+dot(t11,colorMix),1);return mix(mix(c01,c11,fxy.x),mix(c00,c10,fxy.x),fxy.y);}vec2 raTexture2D_image0_linear(vec2 texCoord,vec2 texResolution,vec4 colorMix,float colorOffset) {vec2 fxy;vec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texture(u_image0,c.yz),texture(u_image0,c.xz),texture(u_image0,c.yw),texture(u_image0,c.xw)
);}vec2 raTexture2D_image1_linear(vec2 texCoord,vec2 texResolution,vec4 colorMix,float colorOffset) {vec2 fxy;vec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texture(u_image1,c.yz),texture(u_image1,c.xz),texture(u_image1,c.yw),texture(u_image1,c.xw)
);}vec2 raTexture2D_image0_nearest(vec2 texCoord,vec2 texResolution,vec4 colorMix,float colorOffset) {vec4 t=texture(u_image0,texCoord);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}vec2 raTexture2D_image1_nearest(vec2 texCoord,vec2 texResolution,vec4 colorMix,float colorOffset) {vec4 t=texture(u_image1,texCoord);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}
#endif`,Jb=`#ifdef RENDER_SHADOWS
uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_normal_offset;vec3 shadow_normal_offset(vec3 normal) {float tileInMeters=u_shadow_normal_offset[0];vec3 n=vec3(-normal.xy,tileInMeters*normal.z);float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return n*dotScale;}vec3 shadow_normal_offset_model(vec3 normal) {float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return normal*dotScale;}float shadow_normal_offset_multiplier0() {return u_shadow_normal_offset[1];}float shadow_normal_offset_multiplier1() {return u_shadow_normal_offset[2];}
#endif//RENDER_SHADOWS`,Qb=`#ifdef RENDER_SHADOWS
#ifdef DEPTH_TEXTURE
uniform highp sampler2D u_shadowmap_0;uniform highp sampler2D u_shadowmap_1;
#else
uniform sampler2D u_shadowmap_0;uniform sampler2D u_shadowmap_1;
#endif
uniform float u_shadow_intensity;uniform float u_shadow_map_resolution;uniform float u_shadow_texel_size;uniform highp vec3 u_shadow_normal_offset;uniform vec2 u_fade_range;uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_bias;highp float shadow_sample_1(highp vec2 uv,highp float compare) {highp float shadow_depth;
#ifdef DEPTH_TEXTURE
shadow_depth=texture(u_shadowmap_1,uv).r;
#else
shadow_depth=unpack_depth(texture(u_shadowmap_1,uv))*0.5+0.5;
#endif
return step(shadow_depth,compare);}highp float shadow_sample_0(highp vec2 uv,highp float compare) {highp float shadow_depth;
#ifdef DEPTH_TEXTURE
shadow_depth=texture(u_shadowmap_0,uv).r;
#else
shadow_depth=unpack_depth(texture(u_shadowmap_0,uv))*0.5+0.5;
#endif
return step(shadow_depth,compare);}float shadow_occlusion_1(highp vec4 pos,highp float bias) {highp vec2 uv=pos.xy;return shadow_sample_1(uv,pos.z-bias);}float shadow_occlusion_0(highp vec4 pos,highp float bias) {highp float compare0=pos.z-bias;
#ifdef NATIVE
highp vec2 uv=pos.xy;highp vec4 samples=textureGather(u_shadowmap_0,uv,0);lowp vec4 stepSamples=step(samples,vec4(compare0));
#else
highp vec2 uv00=pos.xy-vec2(0.5*u_shadow_texel_size);highp vec2 uv10=uv00+vec2(u_shadow_texel_size,0.0);highp vec2 uv01=uv00+vec2(0.0,u_shadow_texel_size);highp vec2 uv11=uv01+vec2(u_shadow_texel_size,0.0);lowp vec4 stepSamples=vec4(
shadow_sample_0(uv01,compare0),shadow_sample_0(uv11,compare0),shadow_sample_0(uv10,compare0),shadow_sample_0(uv00,compare0)
);
#endif
vec2 f=fract(pos.xy*u_shadow_map_resolution-vec2(0.5));lowp vec2 lerpx=mix(stepSamples.wx,stepSamples.zy,f.xx);return mix(lerpx.x,lerpx.y,f.y);}float shadow_occlusion(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,highp float bias) {
#ifdef SHADOWS_SINGLE_CASCADE
light_view_pos0.xyz=light_view_pos0.xyz/light_view_pos0.w*0.5+0.5;return shadow_occlusion_0(light_view_pos0,bias);
#else
light_view_pos0.xyz/=light_view_pos0.w;light_view_pos1.xyz/=light_view_pos1.w;vec4 uv=vec4(light_view_pos0.xy,light_view_pos1.xy);vec4 abs_bounds=abs(uv);if (abs_bounds.x < 1.0 && abs_bounds.y < 1.0) {light_view_pos0.xyz=light_view_pos0.xyz*0.5+0.5;return shadow_occlusion_0(light_view_pos0,bias);}if (abs_bounds.z >=1.0 || abs_bounds.w >=1.0) {return 0.0;}light_view_pos1.xyz=light_view_pos1.xyz*0.5+0.5;float occlusion1=shadow_occlusion_1(light_view_pos1,bias);return mix(occlusion1,0.0,smoothstep(u_fade_range.x,u_fade_range.y,view_depth));
#endif
}highp float calculate_shadow_bias(float NDotL) {
#ifdef NORMAL_OFFSET
return 0.5*u_shadow_bias.x;
#else
return 0.5*(u_shadow_bias.x+clamp(u_shadow_bias.y*tan(acos(NDotL)),0.0,u_shadow_bias.z));
#endif
}float shadowed_light_factor_normal(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_unbiased(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadow_occlusion(float ndotl,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=calculate_shadow_bias(ndotl);return shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);}
#endif`;const tw=[];vd(Hb,tw);const gd={"_prelude_fog.vertex.glsl":Xb,"_prelude_terrain.vertex.glsl":$b,"_prelude_shadow.vertex.glsl":Jb,"_prelude_fog.fragment.glsl":Yb,"_prelude_shadow.fragment.glsl":Qb,"_prelude_lighting.glsl":`
#ifdef LIGHTING_3D_MODE
uniform mediump vec3 u_lighting_ambient_color;uniform mediump vec3 u_lighting_directional_dir;uniform mediump vec3 u_lighting_directional_color;uniform mediump vec3 u_ground_radiance;float calculate_ambient_directional_factor(vec3 normal) {float NdotL=dot(normal,u_lighting_directional_dir);const float factor_reduction_max=0.3;float dir_luminance=dot(u_lighting_directional_color,vec3(0.2126,0.7152,0.0722));float directional_factor_min=1.0-factor_reduction_max*min(dir_luminance,1.0);float ambient_directional_factor=mix(directional_factor_min,1.0,min((NdotL+1.0),1.0));const float vertical_factor_min=0.92;float vertical_factor=mix(vertical_factor_min,1.0,normal.z*0.5+0.5);return vertical_factor*ambient_directional_factor;}vec3 linearProduct(vec3 srgbIn,vec3 k) {return srgbIn*pow(k,vec3(1./2.2));}vec3 apply_lighting(vec3 color,vec3 normal,float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return linearProduct(color,ambient_contrib+directional_contrib);}vec4 apply_lighting(vec4 color,vec3 normal,float dir_factor) {return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting(vec3 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return apply_lighting(color.rgb,normal,dir_factor);}vec4 apply_lighting(vec4 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting_ground(vec3 color) {return color*u_ground_radiance;}vec4 apply_lighting_ground(vec4 color) {return vec4(apply_lighting_ground(color.rgb),color.a);}float calculate_NdotL(vec3 normal) {const float ext=0.70710678118;return (clamp(dot(normal,u_lighting_directional_dir),-ext,1.0)+ext)/(1.0+ext);}vec4 apply_lighting_with_emission_ground(vec4 color,float emissive_strength) {return mix(apply_lighting_ground(color),color,emissive_strength);}vec3 compute_flood_lighting(vec3 flood_light_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=flood_light_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);float occlusion_ramp=smoothstep(0.0,0.2,1.0-occlusion);return mix(fully_occluded_color,flood_light_color,occlusion_ramp);}vec3 compute_emissive_draped(vec3 unlit_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=unlit_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);return mix(fully_occluded_color,unlit_color,1.0-occlusion);}
#endif//LIGHTING_3D_MODE`,"_prelude_raster_array.glsl":Kb},yd={};Li("",$b),Li(Yb,Xb),Li(Qb,Jb),Li(Kb,"");const ew=Li(`
out vec4 glFragColor;highp float unpack_depth(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}highp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}
#ifdef INDICATOR_CUTOUT
uniform vec2 u_indicator_cutout_centers;uniform vec4 u_indicator_cutout_params;
#endif
vec4 applyCutout(vec4 color) {
#ifdef INDICATOR_CUTOUT
float holeMinOpacity=u_indicator_cutout_params.x;float holeRadius=max(u_indicator_cutout_params.y,0.0);float holeAspectRatio=u_indicator_cutout_params.z;float fadeStart=u_indicator_cutout_params.w;float distA=distance(vec2(gl_FragCoord.x,gl_FragCoord.y*holeAspectRatio),vec2(u_indicator_cutout_centers[0],u_indicator_cutout_centers[1]*holeAspectRatio));return color*min(smoothstep(fadeStart,holeRadius,distA)+holeMinOpacity,1.0);
#else
return color;
#endif
}
#ifdef DEBUG_WIREFRAME
#define HANDLE_WIREFRAME_DEBUG \\
glFragColor=vec4(0.7,0.0,0.0,0.7); \\
gl_FragDepth=gl_FragCoord.z-0.0001;
#else
#define HANDLE_WIREFRAME_DEBUG
#endif
#ifdef RENDER_CUTOFF
uniform highp vec4 u_cutoff_params;in float v_cutoff_opacity;
#endif`,`
#define EXTENT 8192.0
#define RAD_TO_DEG 180.0/PI
#define DEG_TO_RAD PI/180.0
#define GLOBE_RADIUS EXTENT/PI/2.0
float wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}
#ifdef PROJECTION_GLOBE_VIEW
vec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {
#ifndef PROJECTED_POS_ON_VIEWPORT
float tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;
#else
return vec3(0.0);
#endif
}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {return mix(globe,mercator,t);}mat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}
#endif
vec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(
unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0
);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (tile_units_to_pixels*pos+offset)/pattern_size;}float mercatorXfromLng(float lng) {return (180.0+lng)/360.0;}float mercatorYfromLat(float lat) {return (180.0-(RAD_TO_DEG*log(tan(PI/4.0+lat/2.0*DEG_TO_RAD))))/360.0;}vec3 latLngToECEF(vec2 latLng) {latLng=DEG_TO_RAD*latLng;float cosLat=cos(latLng[0]);float sinLat=sin(latLng[0]);float cosLng=cos(latLng[1]);float sinLng=sin(latLng[1]);float sx=cosLat*sinLng*GLOBE_RADIUS;float sy=-sinLat*GLOBE_RADIUS;float sz=cosLat*cosLng*GLOBE_RADIUS;return vec3(sx,sy,sz);}
#ifdef RENDER_CUTOFF
uniform vec4 u_cutoff_params;out float v_cutoff_opacity;
#endif
const vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);const float skirtOffset=24575.0;vec3 decomposeToPosAndSkirt(vec2 posWithComposedSkirt)
{float skirt=float(posWithComposedSkirt.x >=skirtOffset);vec2 pos=posWithComposedSkirt-vec2(skirt*skirtOffset,0.0);return vec3(pos,skirt);}`),iw=Hb;var nw={background:Li(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec4 u_color;uniform float u_opacity;
#ifdef LIGHTING_3D_MODE
in vec4 v_color;
#endif
void main() {vec4 out_color;
#ifdef LIGHTING_3D_MODE
out_color=v_color;
#else
out_color=u_color;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_lighting.glsl"
in vec2 a_pos;uniform mat4 u_matrix;
#ifdef LIGHTING_3D_MODE
uniform mediump vec4 u_color;out vec4 v_color;uniform float u_emissive_strength;
#endif
void main() {gl_Position=u_matrix*vec4(a_pos,0,1);
#ifdef LIGHTING_3D_MODE
v_color=apply_lighting_with_emission_ground(u_color,u_emissive_strength);
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),backgroundPattern:Li(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_pattern_tl;uniform vec2 u_pattern_br;uniform vec2 u_texsize;uniform float u_opacity;uniform float u_emissive_strength;uniform sampler2D u_image;in vec2 v_pos;void main() {vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(u_pattern_tl/u_texsize,u_pattern_br/u_texsize,imagecoord);vec4 out_color=texture(u_image,pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pattern_size;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_pattern_size,u_tile_units_to_pixels,a_pos);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),circle:Li(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
in vec3 v_data;in float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
uniform float u_emissive_strength;void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=v_data.xy;float extrude_length=length(extrude);lowp float antialiasblur=v_data.z;float antialiased_blur=-max(blur,antialiasblur);float opacity_t=smoothstep(0.0,antialiased_blur,extrude_length-1.0);float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(
antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)
);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_apply_premultiplied(out_color,v_fog_pos);
#endif
glFragColor=out_color*(v_visibility*opacity_t);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define NUM_VISIBILITY_RINGS 2
#define INV_SQRT2 0.70710678
#define ELEVATION_BIAS 0.0001
#define NUM_SAMPLES_PER_RING 16
uniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
out vec3 v_data;out float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
vec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {
#if defined(TERRAIN)
return elevation(pos)+ELEVATION_BIAS;
#else
return 0.0;
#endif
}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);
#ifdef PITCH_WITH_MAP
#ifdef PROJECTION_GLOBE_VIEW
return u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );
#else
return u_matrix*( world_center+vec4(sample_offset,0,0) );
#endif
#else
return projected_center+vec4(sample_offset,0,0);
#endif
}float get_sample_step() {
#ifdef PITCH_WITH_MAP
return 2.0*PI/float(NUM_SAMPLES_PER_RING);
#else
return PI/float(NUM_SAMPLES_PER_RING);
#endif
}void main(void) {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);vec4 world_center;mat3 surface_vectors;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);world_center=vec4(pos,1);
#else 
surface_vectors=mat3(1.0);float height=circle_elevation(circle_center);world_center=vec4(circle_center,height,1);
#endif
vec4 projected_center=u_matrix*world_center;float view_scale=0.0;
#ifdef PITCH_WITH_MAP
#ifdef SCALE_WITH_MAP
view_scale=1.0;
#else
view_scale=projected_center.w/u_camera_to_center_distance;
#endif
#else
#ifdef SCALE_WITH_MAP
view_scale=u_camera_to_center_distance;
#else
view_scale=projected_center.w;
#endif
#endif
gl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;
#ifdef TERRAIN
float step=get_sample_step();vec4 occlusion_world_center;vec4 occlusion_projected_center;
#ifdef PITCH_WITH_MAP
float cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);occlusion_world_center=vec4(circle_center,cantilevered_height,1);occlusion_projected_center=u_matrix*occlusion_world_center;
#else
occlusion_world_center=world_center;occlusion_projected_center=projected_center;
#endif
for(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);
#else
visibility=1.0;
#endif
#ifdef PROJECTION_GLOBE_VIEW
visibility=1.0;
#endif
v_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);
#ifdef FOG
v_fog_pos=fog_position(world_center.xyz);
#endif
}`),clippingMask:Li("void main() {glFragColor=vec4(1.0);}","in vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:Li(`#include "_prelude_fog.fragment.glsl"
uniform highp float u_intensity;in vec2 v_extrude;
#pragma mapbox: define highp float weight
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
float d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);glFragColor=vec4(val,1.0,1.0,1.0);
#ifdef FOG
if (u_is_globe==0) {glFragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);}
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
out vec2 v_extrude;
#pragma mapbox: define highp float weight
#pragma mapbox: define mediump float radius
const highp float ZERO=1.0/255.0/16.0;
#define GAUSS_COEF 0.3989422804014327
void main(void) {
#pragma mapbox: initialize highp float weight
#pragma mapbox: initialize mediump float radius
vec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);vec3 pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#else
pos=vec3(tilePos+extrude,elevation(tilePos));
#endif
gl_Position=u_matrix*vec4(pos,1);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),heatmapTexture:Li(`uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;in vec2 v_pos;void main() {float t=texture(u_image,v_pos).r;vec4 color=texture(u_color_ramp,vec2(t,0.5));glFragColor=color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(0.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,"in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:Li("in float v_placed;in float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);glFragColor =mix(red,blue,step(0.5,v_placed))*0.5;glFragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}",`#include "_prelude_terrain.vertex.glsl"
in vec3 a_pos;in vec2 a_anchor_pos;in vec2 a_extrude;in vec2 a_placed;in vec2 a_shift;in float a_size_scale;in vec2 a_padding;in float a_z_offset;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;out float v_placed;out float v_notUsed;void main() {vec4 projectedPoint=u_matrix*vec4(a_pos+elevationVector(a_anchor_pos)*(a_z_offset+elevation(a_anchor_pos)),1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}`),collisionCircle:Li("in float v_radius;in vec2 v_extrude;in float v_perspective_ratio;in float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);glFragColor=color*alpha*opacity_t;}",`in vec2 a_pos_2f;in float a_radius;in vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;out float v_radius;out vec2 v_extrude;out float v_perspective_ratio;out float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(
mix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}`),debug:Li("uniform highp vec4 u_color;uniform sampler2D u_overlay;in vec2 v_uv;void main() {vec4 overlay_color=texture(u_overlay,v_uv);glFragColor=mix(u_color,overlay_color,overlay_color.a);}",`#include "_prelude_terrain.vertex.glsl"
in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;
#endif
out vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
gl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);
#else
gl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);
#endif
}`),fill:Li(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
uniform float u_emissive_strength;void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
vec4 out_color=color;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
in vec2 a_pos;uniform mat4 u_matrix;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
gl_Position=u_matrix*vec4(a_pos,0,1);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillOutline:Li(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
in vec2 v_pos;uniform float u_emissive_strength;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
in vec2 a_pos;uniform mat4 u_matrix;uniform vec2 u_world;out vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillOutlinePattern:Li(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;uniform float u_emissive_strength;in vec2 v_pos;in vec2 v_pos_world;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);float dist=length(v_pos_world-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=texture(u_image,pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;out vec2 v_pos;out vec2 v_pos_world;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#pragma mapbox: define lowp float pixel_ratio
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize lowp float pixel_ratio
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;gl_Position=u_matrix*vec4(a_pos,0,1);vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);v_pos_world=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillPattern:Li(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;in vec2 v_pos;uniform float u_emissive_strength;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);vec4 out_color=texture(u_image,pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;out vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#pragma mapbox: define lowp float pixel_ratio
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize lowp float pixel_ratio
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillExtrusion:Li(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
in vec4 v_color;in vec4 v_flat;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth;
#endif
uniform lowp float u_opacity;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;in vec2 v_ao;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
in vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
in highp vec3 v_normal;
#endif
uniform vec3 u_flood_light_color;uniform highp float u_vertical_scale;uniform float u_flood_light_intensity;uniform vec3 u_ground_shadow_factor;
#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)
in float v_flood_radius;in float v_has_floodlight;
#endif
uniform float u_emissive_strength;in float v_height;void main() {
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
vec3 normal=normalize(v_normal);
#endif
float z;vec4 color=v_color;
#ifdef ZERO_ROOF_RADIUS
z=float(normal.z > 0.00001);
#ifdef LIGHTING_3D_MODE
normal=mix(normal,vec3(0.0,0.0,1.0),z);
#else
color=mix(v_color,v_roof_color,z);
#endif
#endif
float h=max(0.0,v_height);float ao_shade=1.0;
#ifdef FAUX_AO
float intensity=u_ao[0];float h_floors=h/(u_ao[1]*u_vertical_scale);float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);ao_shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;
#ifdef ZERO_ROOF_RADIUS
concave*=(1.0-z);
#endif
float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);ao_shade*=mix(1.0,x_shade*x_shade*x_shade,concave);
#ifdef LIGHTING_3D_MODE
#ifdef FLOOD_LIGHT
color.rgb*=mix(ao_shade,1.0,v_has_floodlight);
#else
color.rgb*=ao_shade;
#endif
#else
color.rgb*=ao_shade;
#endif
#endif
#ifdef LIGHTING_3D_MODE
float flood_radiance=0.0;
#ifdef FLOOD_LIGHT
flood_radiance=(1.0-min(h/v_flood_radius,1.0))*u_flood_light_intensity*v_has_floodlight;
#endif
#ifdef RENDER_SHADOWS
#ifdef FLOOD_LIGHT
float ndotl_unclamped=dot(normal,u_shadow_direction);float ndotl=max(0.0,ndotl_unclamped);float occlusion=ndotl_unclamped < 0.0 ? 1.0 : shadow_occlusion(ndotl,v_pos_light_view_0,v_pos_light_view_1,v_depth);vec3 litColor=apply_lighting(color.rgb,normal,(1.0-u_shadow_intensity*occlusion)*ndotl);vec3 floodLitColor=compute_flood_lighting(u_flood_light_color*u_opacity,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=mix(litColor,floodLitColor,flood_radiance);
#else
float shadowed_lighting_factor=shadowed_light_factor_normal(normal,v_pos_light_view_0,v_pos_light_view_1,v_depth);color.rgb=apply_lighting(color.rgb,normal,shadowed_lighting_factor);
#endif
#else
color.rgb=apply_lighting(color.rgb,normal);
#ifdef FLOOD_LIGHT
color.rgb=mix(color.rgb,u_flood_light_color*u_opacity,flood_radiance);
#endif
#endif
color.rgb=mix(color.rgb,v_flat.rgb,u_emissive_strength);color*=u_opacity;
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos,h));
#endif
#ifdef RENDER_CUTOFF
color*=v_cutoff_opacity;
#endif
#ifdef INDICATOR_CUTOUT
color=applyCutout(color);
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_lighting.glsl"
#ifdef RENDER_CUTOFF
invariant gl_Position;
#endif
uniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_edge_radius;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
uniform highp float u_vertical_scale;out vec4 v_color;out vec4 v_flat;
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
out vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
out highp vec3 v_normal;
#endif
#ifdef FAUX_AO
uniform lowp vec2 u_ao;out vec2 v_ao;
#endif
#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)
out float v_flood_radius;out float v_has_floodlight;
#endif
out float v_height;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
#pragma mapbox: define highp float flood_light_wall_radius
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize highp float flood_light_wall_radius
base*=u_vertical_scale;height*=u_vertical_scale;vec4 pos_nx=floor(a_pos_normal_ed*0.5);vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
v_normal=normal;
#endif
base=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=0.0;float c_ele;vec3 pos;
#ifdef TERRAIN
bool flat_roof=centroid_pos.x !=0.0 && t > 0.0;ele=elevation(pos_nx.xy);c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base==0.0 ?-5.0 : base);pos=vec3(pos_nx.xy,h);
#else
h=t > 0.0 ? height : base;pos=vec3(pos_nx.xy,h);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*h);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
float hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);h=h-ele;v_height=h;
#ifdef RENDER_SHADOWS
vec3 shd_pos0=pos;vec3 shd_pos1=pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(normal);shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
float NdotL=0.0;float colorvalue=0.0;
#ifndef LIGHTING_3D_MODE
colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),NdotL);if (normal.y !=0.0) {float r=0.84;r=mix(0.7,0.98,1.0-u_lightintensity);NdotL*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}
#endif
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec2(mix(concave,-concave,start),y_ground);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
#ifdef LIGHTING_3D_MODE
#ifdef FLOOD_LIGHT
float is_wall=1.0-float(t > 0.0 && top_up_ny.y > 0.0);v_has_floodlight=float(flood_light_wall_radius > 0.0 && is_wall > 0.0);v_flood_radius=flood_light_wall_radius*u_vertical_scale;
#endif
v_color=vec4(color.rgb,1.0);v_flat=vec4(linearProduct(color.rgb,vec3(calculate_NdotL(normal))),1.0);
#else
v_color=vec4(0.0,0.0,0.0,1.0);v_color.rgb+=clamp(color.rgb*NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_color*=u_opacity;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
float roofNdotL=clamp(u_lightpos.z,0.0,1.0);roofNdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),roofNdotL);v_roof_color=vec4(0.0,0.0,0.0,1.0);v_roof_color.rgb+=clamp(color.rgb*roofNdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_roof_color*=u_opacity;
#endif
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
}`),fillExtrusionDepth:Li(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,`#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;uniform float u_edge_radius;uniform float u_vertical_scale;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
out highp float v_depth;void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
base*=u_vertical_scale;height*=u_vertical_scale;vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;base=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
vec3 pos;
#ifdef TERRAIN
bool flat_roof=centroid_pos.x !=0.0 && t > 0.0;float ele=elevation(pos_nx.xy);float c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;float h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base);pos=vec3(pos_nx.xy,h);
#else
pos=vec3(pos_nx.xy,t > 0.0 ? height : base);
#endif
float hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);v_depth=gl_Position.z/gl_Position.w;}`),fillExtrusionPattern:Li(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;in vec3 v_ao;
#endif
#ifdef LIGHTING_3D_MODE
in vec3 v_normal;
#endif
in vec2 v_pos;in vec4 v_lighting;uniform lowp float u_opacity;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define mediump vec4 pattern
#pragma mapbox: define highp float pixel_ratio
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize highp float pixel_ratio
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);vec4 out_color=texture(u_image,pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting(out_color,normalize(v_normal))*u_opacity;
#else
out_color=out_color*v_lighting;
#endif
#ifdef FAUX_AO
float intensity=u_ao[0];float h=max(0.0,v_ao.z);float h_floors=h/u_ao[1];float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);float shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);shade*=mix(1.0,x_shade*x_shade*x_shade,concave);out_color.rgb=out_color.rgb*shade;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#include "_prelude_lighting.glsl"
uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform float u_tile_units_to_pixels;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
out vec2 v_pos;out vec4 v_lighting;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;out vec3 v_ao;
#endif
#ifdef LIGHTING_3D_MODE
out vec3 v_normal;
#endif
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define mediump vec4 pattern
#pragma mapbox: define highp float pixel_ratio
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize highp float pixel_ratio
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec4 pos_nx=floor(a_pos_normal_ed*0.5);mediump vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;mediump vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=z;vec3 p;float c_ele;
#ifdef TERRAIN
bool flat_roof=centroid_pos.x !=0.0 && t > 0.0;ele=elevation(pos_nx.xy);c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base==0.0 ?-5.0 : base);p=vec3(pos_nx.xy,h);
#else
p=vec3(pos_nx.xy,z);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
float hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0
? pos_nx.xy
: vec2(edgedistance,z*u_height_factor);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float NdotL=0.0;
#ifdef LIGHTING_3D_MODE
NdotL=calculate_NdotL(normal);
#else
NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),NdotL);
#endif
if (normal.y !=0.0) {float r=0.84;
#ifndef LIGHTING_3D_MODE
r=mix(0.7,0.98,1.0-u_lightintensity);
#endif
NdotL*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec3(mix(concave,-concave,start),y_ground,h-ele);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
#ifdef LIGHTING_3D_MODE
v_normal=normal;
#else
v_lighting.rgb+=clamp(NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;
#endif 
#ifdef FOG
v_fog_pos=fog_position(p);
#endif
}`),groundShadow:Li(`#include "_prelude_shadow.fragment.glsl"
precision highp float;uniform vec3 u_ground_shadow_factor;in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;in float v_depth;
#ifdef FOG
in float v_fog_opacity;
#endif
void main() {float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);vec3 shadow=mix(u_ground_shadow_factor,vec3(1.0),light);
#ifdef RENDER_CUTOFF
shadow=mix(vec3(1.0),shadow,cutoff_opacity(u_cutoff_params,v_depth));
#endif
#ifdef FOG
shadow=mix(shadow,vec3(1.0),v_fog_opacity);
#endif
#ifdef INDICATOR_CUTOUT
shadow=mix(shadow,vec3(1.0),1.0-applyCutout(vec4(1.0)).r);
#endif
glFragColor=vec4(shadow,1.0);}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;in vec2 a_pos;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;out float v_depth;
#ifdef FOG
out float v_fog_opacity;
#endif
void main() {gl_Position=u_matrix*vec4(a_pos,0.0,1.0);v_pos_light_view_0=u_light_matrix_0*vec4(a_pos,0.0,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(a_pos,0.0,1.0);v_depth=gl_Position.w;
#ifdef FOG
v_fog_pos=fog_position(a_pos);v_fog_opacity=fog(v_fog_pos);
#endif
}`),fillExtrusionGroundEffect:Li(`uniform highp float u_ao_pass;uniform highp float u_opacity;uniform highp float u_flood_light_intensity;uniform highp vec3 u_flood_light_color;uniform highp float u_attenuation;uniform sampler2D u_fb;uniform float u_fb_size;
#ifdef SDF_SUBPASS
in highp vec2 v_pos;in highp vec4 v_line_segment;in highp float v_flood_light_radius_tile;in highp vec2 v_ao;float line_df(highp vec2 a,highp vec2 b,highp vec2 p) {highp vec2 ba=b-a;highp vec2 pa=p-a;highp float r=clamp(dot(pa,ba)/dot(ba,ba),0.0,1.0);return length(pa-r*ba);}
#ifdef FOG
in highp float v_fog;
#endif
#endif
void main() {
#ifdef CLEAR_SUBPASS
vec4 color=vec4(1.0);
#ifdef CLEAR_FROM_TEXTURE
color=texture(u_fb,gl_FragCoord.xy/vec2(u_fb_size));
#endif
glFragColor=color;
#else
#ifdef SDF_SUBPASS
highp float d=line_df(v_line_segment.xy,v_line_segment.zw,v_pos);highp float effect_radius=mix(v_flood_light_radius_tile,v_ao.y,u_ao_pass);d/=effect_radius;d=min(d,1.0);d=1.0-pow(1.0-d,u_attenuation);highp float effect_intensity=mix(u_flood_light_intensity,v_ao.x,u_ao_pass);highp float fog=1.0;
#ifdef FOG
fog=v_fog;
#endif
#ifdef RENDER_CUTOFF
fog*=v_cutoff_opacity;
#endif
glFragColor=vec4(vec3(0.0),mix(1.0,d,effect_intensity*u_opacity*fog));
#else
vec4 color=mix(vec4(u_flood_light_color,1.0),vec4(vec3(0.0),1.0),u_ao_pass);
#ifdef OVERDRAW_INSPECTOR
color=vec4(1.0);
#endif
glFragColor=color;HANDLE_WIREFRAME_DEBUG;
#endif
#endif
}`,`#include "_prelude_fog.vertex.glsl"
in highp vec4 a_pos_end;in highp float a_angular_offset_factor;in highp float a_hidden_by_landmark;
#ifdef SDF_SUBPASS
out highp vec2 v_pos;out highp vec4 v_line_segment;out highp float v_flood_light_radius_tile;out highp vec2 v_ao;
#ifdef FOG
out highp float v_fog;
#endif
#endif
uniform highp float u_flood_light_intensity;uniform highp mat4 u_matrix;uniform highp float u_ao_pass;uniform highp float u_meter_to_tile;uniform highp float u_edge_radius;uniform highp vec2 u_ao;
#pragma mapbox: define highp float flood_light_ground_radius
const float TANGENT_CUTOFF=4.0;const float NORM=32767.0;void main() {
#pragma mapbox: initialize highp float flood_light_ground_radius
vec2 p=a_pos_end.xy;vec2 q=floor(a_pos_end.zw*0.5);vec2 start_bottom=a_pos_end.zw-q*2.0;float fl_ground_radius=flood_light_ground_radius;
#ifdef FORCE_ABS_FL_GROUND_RADIUS
fl_ground_radius=abs(flood_light_ground_radius);
#endif
float flood_radius_tile=fl_ground_radius*u_meter_to_tile;vec2 v=normalize(q-p);float ao_radius=u_ao.y/3.5;float effect_radius=mix(flood_radius_tile,ao_radius,u_ao_pass)+u_edge_radius;float angular_offset_factor=a_angular_offset_factor/NORM*TANGENT_CUTOFF;float angular_offset=angular_offset_factor*effect_radius;float top=1.0-start_bottom.y;float side=(0.5-start_bottom.x)*2.0;vec2 extrusion_parallel=v*side*mix(1.0,angular_offset,top);vec2 perp=vec2(v.y,-v.x);vec2 extrusion_perp=perp*effect_radius*top;vec3 pos=vec3(mix(q,p,start_bottom.x),0.0);pos.xy+=extrusion_parallel+extrusion_perp;
#ifdef SDF_SUBPASS
v_pos=pos.xy;v_line_segment=vec4(p,q)+perp.xyxy*u_edge_radius;v_flood_light_radius_tile=flood_radius_tile;v_ao=vec2(u_ao.x,ao_radius);
#ifdef FOG
v_fog_pos=fog_position(pos);v_fog=1.0-fog(v_fog_pos);
#endif
#endif
float hidden_by_landmark=0.0;
#ifdef HAS_CENTROID
hidden_by_landmark=a_hidden_by_landmark;
#endif
float isFloodlit=float(fl_ground_radius > 0.0 && u_flood_light_intensity > 0.0);float hidden=mix(1.0-isFloodlit,isFloodlit,u_ao_pass);hidden+=hidden_by_landmark;gl_Position=mix(u_matrix*vec4(pos,1.0),AWAY,float(hidden > 0.0));
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
}`),hillshadePrepare:Li(`precision highp float;uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;float getElevation(vec2 coord) {return texture(u_image,coord).r/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos+vec2(epsilon.x,0));float f=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float g=getElevation(v_pos+vec2(0,epsilon.y));float h=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(
(c+e+e+h)-(a+d+d+f),(f+g+g+h)-(a+b+b+c)
)/pow(2.0,exaggeration+(19.2562-u_zoom));glFragColor=clamp(vec4(
deriv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);}`,"uniform mat4 u_matrix;uniform vec2 u_dimension;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:Li(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;uniform float u_emissive_strength;void main() {vec4 pixel=texture(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);glFragColor=accent_color*(1.0-shade_color.a)+shade_color;
#ifdef LIGHTING_3D_MODE
glFragColor=apply_lighting_with_emission_ground(glFragColor,u_emissive_strength);
#endif
#ifdef FOG
glFragColor=fog_dither(fog_apply_premultiplied(glFragColor,v_fog_pos));
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),line:Li(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform lowp float u_device_pixel_ratio;uniform float u_alpha_discard_threshold;uniform highp vec2 u_trim_offset;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;in highp vec4 v_uv;
#ifdef RENDER_LINE_DASH
uniform sampler2D u_dash_image;in vec2 v_tex;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform sampler2D u_gradient_image;
#endif
float luminance(vec3 c) {return (c.r+c.r+c.b+c.g+c.g+c.g)*0.1667;}uniform float u_emissive_strength;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float border_width
#pragma mapbox: define lowp vec4 border_color
float linearstep(float edge0,float edge1,float x) {return  clamp((x-edge0)/(edge1-edge0),0.0,1.0);}void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float border_width
#pragma mapbox: initialize lowp vec4 border_color
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);
#ifdef RENDER_LINE_DASH
float sdfdist=texture(u_dash_image,v_tex).a;float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/dash.z;alpha*=linearstep(0.5-sdfgamma/floorwidth,0.5+sdfgamma/floorwidth,sdfdist);
#endif
highp vec4 out_color;
#ifdef RENDER_LINE_GRADIENT
out_color=texture(u_gradient_image,v_uv.xy);
#else
out_color=color;
#endif
float trimmed=1.0;
#ifdef RENDER_LINE_TRIM_OFFSET
highp float start=v_uv[2];highp float end=v_uv[3];highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=(start+(v_uv.x)*(end-start));if (trim_end > trim_start) {if (line_progress <=trim_end && line_progress >=trim_start) {out_color=vec4(0,0,0,0);trimmed=0.0;}}
#endif
if (u_alpha_discard_threshold !=0.0) {if (alpha < u_alpha_discard_threshold) {discard;}}
#ifdef RENDER_LINE_BORDER
float edgeBlur=(border_width+1.0/u_device_pixel_ratio);float alpha2=clamp(min(dist-(v_width2.t-edgeBlur),v_width2.s-dist)/edgeBlur,0.0,1.0);if (alpha2 < 1.) {float smoothAlpha=smoothstep(0.6,1.0,alpha2);if (border_color.a==0.0) {    
float Y=(out_color.a > 0.01) ? luminance(out_color.rgb/out_color.a) : 1.;float adjustment=(Y > 0.) ? 0.5/Y : 0.45;if (out_color.a > 0.25 && Y < 0.25) {vec3 borderColor=(Y > 0.) ? out_color.rgb : vec3(1,1,1)*out_color.a;out_color.rgb=out_color.rgb+borderColor*(adjustment*(1.0-smoothAlpha));} else {out_color.rgb*=(0.6 +0.4*smoothAlpha);}} else {out_color.rgb=mix(border_color.rgb*border_color.a*trimmed,out_color.rgb,smoothAlpha);}}
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
out_color*=(alpha*opacity);
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#define EXTRUDE_SCALE 0.015873016
in vec2 a_pos_normal;in vec4 a_data;
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
in highp vec4 a_packed;
#endif
#ifdef RENDER_LINE_DASH
in float a_linesofar;
#endif
uniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;out vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec4 v_uv;
#ifdef RENDER_LINE_DASH
uniform vec2 u_texsize;uniform float u_tile_units_to_pixels;out vec2 v_tex;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform float u_image_height;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float border_width
#pragma mapbox: define lowp vec4 border_color
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float border_width
#pragma mapbox: initialize lowp vec4 border_color
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist*u_pixels_to_tile_units,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude;
#ifndef RENDER_TO_TEXTURE
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#else
v_gamma_scale=1.0;
#endif
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
float a_uv_x=a_packed[0];float a_split_index=a_packed[1];highp float a_clip_start=a_packed[2];highp float a_clip_end=a_packed[3];
#ifdef RENDER_LINE_GRADIENT
highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec4(a_uv_x,a_split_index*texel_height-half_texel_height,a_clip_start,a_clip_end);
#else
v_uv=vec4(a_uv_x,0.0,a_clip_start,a_clip_end);
#endif
#endif
#ifdef RENDER_LINE_DASH
float scale=dash.z==0.0 ? 0.0 : u_tile_units_to_pixels/dash.z;float height=dash.y;v_tex=vec2(a_linesofar*scale/floorwidth,(-normal.y*height+dash.x+0.5)/u_texsize.y);
#endif
v_width2=vec2(outset,inset);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),linePattern:Li(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform lowp float u_device_pixel_ratio;uniform vec2 u_texsize;uniform float u_tile_units_to_pixels;uniform sampler2D u_image;in vec2 v_normal;in vec2 v_width2;in float v_linesofar;in float v_gamma_scale;in float v_width;
#pragma mapbox: define lowp vec4 pattern
#pragma mapbox: define lowp float pixel_ratio
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize lowp float pixel_ratio
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;vec2 pattern_size=vec2(display_size.x/u_tile_units_to_pixels,display_size.y);float aspect=display_size.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float x=mod(v_linesofar/pattern_size.x*aspect,1.0);float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;vec2 pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(x,y));vec4 color=texture(u_image,pos);
#ifdef LIGHTING_3D_MODE
color=apply_lighting_ground(color);
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
color*=(alpha*opacity);
#ifdef INDICATOR_CUTOUT
color=applyCutout(color);
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#define scale 0.015873016
in vec2 a_pos_normal;in vec4 a_data;in float a_linesofar;uniform mat4 u_matrix;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform lowp float u_device_pixel_ratio;out vec2 v_normal;out vec2 v_width2;out float v_linesofar;out float v_gamma_scale;out float v_width;
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 pattern
#pragma mapbox: define lowp float pixel_ratio
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize lowp float pixel_ratio
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist*u_pixels_to_tile_units,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude;
#ifndef RENDER_TO_TEXTURE
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#else
v_gamma_scale=1.0;
#endif
v_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=floorwidth;
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),raster:Li(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_raster_array.glsl"
uniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;in vec2 v_pos0;in vec2 v_pos1;in float v_depth;uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;uniform float u_emissive_strength;
#ifndef RASTER_ARRAY
uniform sampler2D u_image0;uniform sampler2D u_image1;
#endif
#ifdef RASTER_COLOR
uniform sampler2D u_color_ramp;uniform highp vec4 u_colorization_mix;uniform highp float u_colorization_offset;uniform vec2 u_texture_res;
#endif
void main() {vec4 color0,color1,color;vec2 value;
#ifdef RASTER_COLOR
#ifdef RASTER_ARRAY
#ifdef RASTER_ARRAY_LINEAR
value=mix(
raTexture2D_image0_linear(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_linear(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t
);
#else
value=mix(
raTexture2D_image0_nearest(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_nearest(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t
);
#endif
if (value.y > 0.0) value.x/=value.y;
#else
color=mix(texture(u_image0,v_pos0),texture(u_image1,v_pos1),u_fade_t);value=vec2(u_colorization_offset+dot(color.rgb,u_colorization_mix.rgb),color.a);
#endif
color=texture(u_color_ramp,vec2(value.x,0.5));if (color.a > 0.0) color.rgb/=color.a;color.a*=value.y;
#else
color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);
#endif
color.a*=u_opacity;vec3 rgb=color.rgb;rgb=vec3(
dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),u_emissive_strength).rgb;
#endif
#ifdef FOG
highp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));
#endif
glFragColor=vec4(out_color*color.a,color.a);
#ifdef RENDER_CUTOFF
glFragColor=glFragColor*cutoff_opacity(u_cutoff_params,v_depth);
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;uniform vec2 u_texture_offset;uniform float u_raster_elevation;uniform vec4 u_tl_br;uniform float u_zoom_transition;uniform vec2 u_merc_center;
#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8;
#ifdef GLOBE_POLES
in vec3 a_globe_pos;in vec2 a_uv;
#elif defined(PROJECTION_GLOBE_VIEW)
in vec2 a_pos;
#else
in vec2 a_pos;in vec2 a_texture_pos;
#endif
out vec2 v_pos0;out vec2 v_pos1;out float v_depth;void main() {vec2 uv;
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;gl_Position=u_matrix*u_globe_matrix*vec4(globe_pos   ,1.0);uv=a_uv;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(a_globe_pos,1.0)).xyz);
#endif
#else
#ifdef PROJECTION_GLOBE_VIEW
vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);vec2 globe_tl=vec2(u_tl_br.x,u_tl_br.y);vec2 globe_br=vec2(u_tl_br.z,u_tl_br.w);float mercatorY=mercatorYfromLat(latLng[0]);float uvY=1.0-((mercatorY-globe_br.y)/(globe_tl.y-globe_br.y));float mercatorX=mercatorXfromLng(latLng[1]);float uvX=(mercatorX-globe_br.x)/(globe_tl.x-globe_br.x);vec3 globe_pos=latLngToECEF(latLng.xy);vec2 merc_pos=vec2(mercatorX,mercatorY);uv=vec2(uvX,uvY);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition),1.0);gl_Position=u_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
#else
float w=1.0+dot(a_texture_pos,u_perspective_transform);gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation,w);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
uv=a_texture_pos/8192.0;
#endif
#endif
v_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;v_pos0=u_texture_offset.x+u_texture_offset.y*v_pos0;v_pos1=u_texture_offset.x+u_texture_offset.y*v_pos1;
#ifdef RENDER_CUTOFF
v_depth=gl_Position.z;
#endif
}`),symbolIcon:Li(`#include "_prelude_lighting.glsl"
uniform sampler2D u_texture;
#ifdef ICON_TRANSITION
uniform float u_icon_transition;
#endif
in float v_fade_opacity;in vec2 v_tex_a;
#ifdef ICON_TRANSITION
in vec2 v_tex_b;
#endif
uniform mediump float u_icon_saturation;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float emissive_strength
lowp float alpha=opacity*v_fade_opacity;vec4 out_color;
#ifdef ICON_TRANSITION
vec4 a=texture(u_texture,v_tex_a)*(1.0-u_icon_transition);vec4 b=texture(u_texture,v_tex_b)*u_icon_transition;out_color=(a+b)*alpha;
#else
out_color=texture(u_texture,v_tex_a)*alpha;
#endif
#ifdef SATURATION
vec3 luma=vec3(dot(out_color.rgb,vec3(0.2126,0.7152,0.0722)));out_color.rgb=mix(luma,out_color.rgb,u_icon_saturation);
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,emissive_strength);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
in vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_pixeloffset;in vec4 a_projected_pos;in float a_fade_opacity;
#ifdef Z_OFFSET
in float a_z_offset;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_globe_anchor;in vec3 a_globe_normal;
#endif
#ifdef ICON_TRANSITION
in vec2 a_texb;
#endif
uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform highp float u_camera_to_center_distance;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform float u_fade_change;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform vec2 u_texsize;uniform vec3 u_up_vector;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;
#endif
out vec2 v_tex_a;
#ifdef ICON_TRANSITION
out vec2 v_tex_b;
#endif
out float v_fade_opacity;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float emissive_strength
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_min_font_scale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=elevation(tile_anchor);
#ifdef Z_OFFSET
e+=a_z_offset;
#endif
vec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;
#ifdef PROJECTION_GLOBE_VIEW
mercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos=mix_globe_mercator(a_globe_anchor+h,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;
#else
world_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjected_point;
#ifdef PROJECTION_GLOBE_VIEW
vec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetProjected_point=u_matrix*vec4(a_globe_anchor+displacement,1);
#else
offsetProjected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);
#endif
vec2 a=projected_point.xy/projected_point.w;vec2 b=offsetProjected_point.xy/offsetProjected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz+h,mercator_pos,u_zoom_transition);projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);
#else
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_min_font_scale,font_scale)+a_pxoffset/16.0);
#ifdef TERRAIN
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
#endif
float occlusion_fade=occlusionFade(projected_point)*globe_occlusion_fade;float projection_transition_fade=1.0;
#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)
projection_transition_fade=1.0-step(EPSILON,u_zoom_transition);
#endif
vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float out_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change))*projection_transition_fade;float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);
#ifdef PROJECTION_GLOBE_VIEW
vec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,hidden);
#else
gl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,hidden);
#endif
v_tex_a=a_tex/u_texsize;
#ifdef ICON_TRANSITION
v_tex_b=a_texb/u_texsize;
#endif
v_fade_opacity=out_fade_opacity;}`),symbolSDF:Li(`#include "_prelude_lighting.glsl"
#define SDF_PX 8.0
uniform sampler2D u_texture;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;uniform bool u_is_halo;in float v_draw_halo;in vec2 v_data0;in vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
float EDGE_GAMMA=0.105/u_device_pixel_ratio;vec2 tex=v_data0.xy;float gamma_scale=v_data1.x;float size=v_data1.y;float fade_opacity=v_data1[2];float fontScale=u_is_text ? size/24.0 : size;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo=v_draw_halo > 0.0;if (draw_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);vec4 out_color=color*(alpha*opacity*fade_opacity);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,emissive_strength);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
in vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_pixeloffset;in vec4 a_projected_pos;in float a_fade_opacity;
#ifdef Z_OFFSET
in float a_z_offset;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_globe_anchor;in vec3 a_globe_normal;
#endif
uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform bool u_is_halo;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;
#endif
out float v_draw_halo;out vec2 v_data0;out vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=elevation(tile_anchor);
#ifdef Z_OFFSET
e+=a_z_offset;
#endif
vec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;
#ifdef PROJECTION_GLOBE_VIEW
mercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos=mix_globe_mercator(a_globe_anchor+h,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;
#else
world_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetprojected_point;
#ifdef PROJECTION_GLOBE_VIEW
vec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetprojected_point=u_matrix*vec4(a_globe_anchor+displacement,1);
#else
offsetprojected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);
#endif
vec2 a=projected_point.xy/projected_point.w;vec2 b=offsetprojected_point.xy/offsetprojected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz+h,mercator_pos,u_zoom_transition);projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);
#else
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*fontScale+a_pxoffset);
#ifdef TERRAIN
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
#endif
float occlusion_fade=occlusionFade(projected_point)*globe_occlusion_fade;float projection_transition_fade=1.0;
#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)
projection_transition_fade=1.0-step(EPSILON,u_zoom_transition);
#endif
vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));float out_fade_opacity=interpolated_fade_opacity*projection_transition_fade;float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);
#ifdef PROJECTION_GLOBE_VIEW
vec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,hidden);
#else
gl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,hidden);
#endif
float gamma_scale=gl_Position.w;v_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;v_data0=a_tex/u_texsize;v_data1=vec3(gamma_scale,size,out_fade_opacity);}`),symbolTextAndIcon:Li(`#include "_prelude_lighting.glsl"
#define SDF_PX 8.0
#define SDF 1.0
#define ICON 0.0
uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_halo;in float v_draw_halo;in vec4 v_data0;in vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
float fade_opacity=v_data1[2];if (v_data1.w==ICON) {vec2 tex_icon=v_data0.zw;lowp float alpha=opacity*fade_opacity;glFragColor=texture(u_texture_icon,tex_icon)*alpha;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
return;}vec2 tex=v_data0.xy;float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_data1.x;float size=v_data1.y;float fontScale=size/24.0;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo=v_draw_halo > 0.0;if (draw_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);vec4 out_color=color*(alpha*opacity*fade_opacity);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,emissive_strength);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
in vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_projected_pos;in float a_fade_opacity;
#ifdef Z_OFFSET
in float a_z_offset;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_globe_anchor;in vec3 a_globe_normal;
#endif
uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform vec2 u_texsize_icon;uniform bool u_is_halo;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;
#endif
out float v_draw_halo;out vec4 v_data0;out vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);float is_sdf=a_size[0]-2.0*a_size_min;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=elevation(tile_anchor);
#ifdef Z_OFFSET
e+=a_z_offset;
#endif
vec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;
#ifdef PROJECTION_GLOBE_VIEW
mercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos=mix_globe_mercator(a_globe_anchor+h,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;
#else
world_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=size/24.0;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offset_projected_point=u_matrix*vec4(a_pos+vec2(1,0),0,1);vec2 a=projected_point.xy/projected_point.w;vec2 b=offset_projected_point.xy/offset_projected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz+h,mercator_pos,u_zoom_transition);projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);
#else
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*font_scale);
#ifdef TERRAIN
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
#endif
float occlusion_fade=occlusionFade(projected_point)*globe_occlusion_fade;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));float projection_transition_fade=1.0;
#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)
projection_transition_fade=1.0-step(EPSILON,u_zoom_transition);
#endif
float out_fade_opacity=interpolated_fade_opacity*projection_transition_fade;float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);
#ifdef PROJECTION_GLOBE_VIEW
vec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,hidden);
#else
gl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,hidden);
#endif
float gamma_scale=gl_Position.w;v_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;v_data0.xy=a_tex/u_texsize;v_data0.zw=a_tex/u_texsize_icon;v_data1=vec4(gamma_scale,size,out_fade_opacity,is_sdf);}`),terrainRaster:Li(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image0;in vec2 v_pos0;
#ifdef FOG
in float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;in float v_depth;
#endif
uniform vec3 u_ground_shadow_factor;void main() {vec4 image_color=texture(u_image0,v_pos0);vec4 color;
#ifdef LIGHTING_3D_MODE
const vec3 normal=vec3(0.0,0.0,1.0);
#ifdef RENDER_SHADOWS
float cutoffOpacity=1.0;
#ifdef RENDER_CUTOFF
cutoffOpacity=cutoff_opacity(u_cutoff_params,v_depth);
#endif
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
vec3 unlit_base=image_color.rgb*(1.0-image_color.a);vec3 emissive_base=image_color.rgb*image_color.a;float ndotl=u_shadow_direction.z;float occlusion=ndotl < 0.0 ? 1.0 : shadow_occlusion(v_pos_light_view_0,v_pos_light_view_1,v_depth,0.0);ndotl=max(0.0,ndotl);vec3 lit=apply_lighting(unlit_base,normal,mix(1.0,(1.0-(u_shadow_intensity*occlusion))*ndotl,cutoffOpacity));vec3 emissive=compute_emissive_draped(emissive_base,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=lit+emissive;color.a=1.0;
#else
float lighting_factor=shadowed_light_factor_normal_unbiased(normal,v_pos_light_view_0,v_pos_light_view_1,v_depth);color=apply_lighting(image_color,normal,mix(1.0,lighting_factor,cutoffOpacity));
#endif
#else
float lighting_factor=u_lighting_directional_dir.z;color=apply_lighting(image_color,normal,lighting_factor);
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
color.rgb=mix(color.rgb,image_color.rgb,image_color.a);color.a=1.0;
#endif
#endif
#else
color=image_color;
#endif
#ifdef FOG
#ifdef ZERO_EXAGGERATION
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#else
color=fog_dither(fog_apply_from_vert(color,v_fog_opacity));
#endif
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;uniform float u_skirt_height;in vec2 a_pos;out vec2 v_pos0;
#ifdef FOG
out float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;out float v_depth;
#endif
void main() {vec3 decomposedPosAndSkirt=decomposeToPosAndSkirt(a_pos);float skirt=decomposedPosAndSkirt.z;vec2 decodedPos=decomposedPosAndSkirt.xy;float elevation=elevation(decodedPos)-skirt*u_skirt_height;v_pos0=decodedPos/8192.0;gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);
#ifdef FOG
#ifdef ZERO_EXAGGERATION
v_fog_pos=fog_position(decodedPos);
#else
v_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));
#endif
#endif
#ifdef RENDER_SHADOWS
vec3 pos=vec3(decodedPos,elevation);v_pos_light_view_0=u_light_matrix_0*vec4(pos,1.);v_pos_light_view_1=u_light_matrix_1*vec4(pos,1.);v_depth=gl_Position.w;
#endif
}`),terrainDepth:Li("precision highp float;in float v_depth;void main() {glFragColor=pack_depth(v_depth);}",`#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;in vec2 a_pos;out float v_depth;void main() {float elevation=elevation(a_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}`),skybox:Li(`#include "_prelude_fog.fragment.glsl"
in lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(
cos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=texture(u_cubemap,uv).rgb;
#ifdef FOG
sky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);
#endif
sky_color.rgb=dither(sky_color.rgb,gl_FragCoord.xy+u_temporal_offset);sky_color+=0.1*sun_disk(v_uv,u_sun_direction);glFragColor=vec4(sky_color*u_opacity,u_opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,Wb),skyboxGradient:Li(`#include "_prelude_fog.fragment.glsl"
in highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture(u_color_ramp,vec2(progress,0.5));
#ifdef FOG
color.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;
#endif
color*=u_opacity;color.rgb=dither(color.rgb,gl_FragCoord.xy+u_temporal_offset);glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,Wb),skyboxCapture:Li(`
in highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;precision highp float;
#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)
#define BETA_M                  vec3(21e-6,21e-6,21e-6)
#define MIE_G                   0.76
#define DENSITY_HEIGHT_SCALE_R  8000.0
#define DENSITY_HEIGHT_SCALE_M  1200.0
#define PLANET_RADIUS           6360e3
#define ATMOSPHERE_RADIUS       6420e3
#define SAMPLE_STEPS            10
#define DENSITY_STEPS           4
float ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;glFragColor=vec4(color,1.0);}`,"in highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;out highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:Li(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image0;in vec2 v_pos0;
#ifndef FOG
uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform vec2 u_viewport;
#endif
void main() {vec4 color;
#ifdef CUSTOM_ANTIALIASING
vec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);vec3 dir=normalize(ray_dir);vec3 closest_point=dot(u_globe_pos,dir)*dir;float norm_dist_from_center=1.0-length(closest_point-u_globe_pos)/u_globe_radius;const float antialias_pixel=2.0;float antialias_factor=antialias_pixel*fwidth(norm_dist_from_center);float antialias=smoothstep(0.0,antialias_factor,norm_dist_from_center);vec4 raster=texture(u_image0,v_pos0);
#ifdef LIGHTING_3D_MODE
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
raster=apply_lighting_with_emission_ground(raster,raster.a);color=vec4(raster.rgb*antialias,antialias);
#else
raster=apply_lighting_ground(raster);color=vec4(raster.rgb*antialias,raster.a*antialias);
#endif
#else
color=vec4(raster.rgb*antialias,raster.a*antialias);
#endif
#else
color=texture(u_image0,v_pos0);
#ifdef LIGHTING_3D_MODE
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
color=apply_lighting_with_emission_ground(color,color.a);color.a=1.0;
#else
color=apply_lighting_ground(color);
#endif
#endif
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_proj_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;uniform mat3 u_grid_matrix;uniform float u_skirt_height;
#ifdef GLOBE_POLES
in vec3 a_globe_pos;in vec2 a_uv;
#else
in vec2 a_pos;
#endif
out vec2 v_pos0;void main() {
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;vec2 uv=a_uv;
#else
float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float uvY=mercatorY*tiles-idy;float mercatorX=mercatorXfromLng(latLng[1]);float uvX=mercatorX*tiles-idx;vec3 globe_pos=latLngToECEF(latLng.xy);vec2 merc_pos=vec2(mercatorX,mercatorY);vec2 uv=vec2(uvX,uvY);
#endif
v_pos0=uv;vec2 tile_pos=uv*EXTENT;vec3 globe_derived_up_vector=normalize(globe_pos)*u_tile_up_scale;
#ifdef GLOBE_POLES
vec3 up_vector=globe_derived_up_vector;
#else
vec3 up_vector=elevationVector(tile_pos);
#endif
float height=elevation(tile_pos);globe_pos+=up_vector*height;
#ifndef GLOBE_POLES
globe_pos-=globe_derived_up_vector*u_skirt_height*decomposed_pos_and_skirt.z;
#endif
#ifdef GLOBE_POLES
vec4 interpolated_pos=u_globe_matrix*vec4(globe_pos,1.0);
#else
vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {merc_world_pos=vec4(merc_pos,height-u_skirt_height*decomposed_pos_and_skirt.z,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition),1.0);
#endif
gl_Position=u_proj_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
}`),globeAtmosphere:Li(`#include "_prelude_fog.fragment.glsl"
uniform float u_transition;uniform highp float u_fadeout_range;uniform highp float u_temporal_offset;uniform vec4 u_color;uniform vec4 u_high_color;uniform vec4 u_space_color;uniform float u_horizon_angle;in highp vec3 v_ray_dir;in highp vec3 v_horizon_dir;void main() {highp vec3 dir=normalize(v_ray_dir);float globe_pos_dot_dir;
#ifdef PROJECTION_GLOBE_VIEW
globe_pos_dot_dir=dot(u_globe_pos,dir);highp vec3 closest_point_forward=abs(globe_pos_dot_dir)*dir;float norm_dist_from_center=length(closest_point_forward-u_globe_pos)/u_globe_radius;if (norm_dist_from_center < 0.98) {
#ifdef ALPHA_PASS
glFragColor=vec4(0,0,0,0);return;
#else
#ifdef NATIVE
glFragColor=vec4(1,1,1,1);
#else
glFragColor=vec4(0,0,0,1);
#endif
return;
#endif
}
#endif
highp vec3 horizon_dir=normalize(v_horizon_dir);float horizon_angle_mercator=dir.y < horizon_dir.y ?
0.0 : max(acos(clamp(dot(dir,horizon_dir),-1.0,1.0)),0.0);float horizon_angle;
#ifdef PROJECTION_GLOBE_VIEW
highp vec3 closest_point=globe_pos_dot_dir*dir;highp float closest_point_to_center=length(closest_point-u_globe_pos);highp float theta=asin(clamp(closest_point_to_center/length(u_globe_pos),-1.0,1.0));horizon_angle=globe_pos_dot_dir < 0.0 ?
PI-theta-u_horizon_angle : theta-u_horizon_angle;float angle_t=pow(u_transition,10.0);horizon_angle=mix(horizon_angle,horizon_angle_mercator,angle_t);
#else
horizon_angle=horizon_angle_mercator;
#endif
horizon_angle/=PI;float t=exp(-horizon_angle/u_fadeout_range);float alpha_0=u_color.a;float alpha_1=u_high_color.a;float alpha_2=u_space_color.a;vec3 color_stop_0=u_color.rgb;vec3 color_stop_1=u_high_color.rgb;vec3 color_stop_2=u_space_color.rgb;
#ifdef ALPHA_PASS
float a0=mix(alpha_2,1.0,alpha_1);float a1=mix(a0,1.0,alpha_0);float a2=mix(a0,a1,t);float a =mix(alpha_2,a2,t);glFragColor=vec4(1.0,1.0,1.0,a);
#else
vec3 c0=mix(color_stop_2,color_stop_1,alpha_1);vec3 c1=mix(c0,color_stop_0,alpha_0);vec3 c2=mix(c0,c1,t);vec3 c=c2;
#ifndef NATIVE
c=dither(c,gl_FragCoord.xy+u_temporal_offset);
#endif
glFragColor=vec4(c*t,t);
#endif
}`,`in vec3 a_pos;in vec2 a_uv;uniform vec3 u_frustum_tl;uniform vec3 u_frustum_tr;uniform vec3 u_frustum_br;uniform vec3 u_frustum_bl;uniform float u_horizon;out highp vec3 v_ray_dir;out highp vec3 v_horizon_dir;void main() {v_ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,a_uv.x),mix(u_frustum_bl,u_frustum_br,a_uv.x),a_uv.y);v_horizon_dir=mix(
mix(u_frustum_tl,u_frustum_bl,u_horizon),mix(u_frustum_tr,u_frustum_br,u_horizon),a_uv.x);gl_Position=vec4(a_pos,1.0);}`),model:Li(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform float u_opacity;uniform vec3 u_lightcolor;uniform vec3 u_lightpos;uniform float u_lightintensity;uniform vec4 u_baseColorFactor;uniform vec4 u_emissiveFactor;uniform float u_metallicFactor;uniform float u_roughnessFactor;uniform float u_emissive_strength;in highp vec4 v_position_height;in lowp vec4 v_color_mix;
#ifdef RENDER_SHADOWS
in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;in float v_depth_shadows;
#endif
#pragma mapbox: define-attribute highp vec3 normal_3f
#pragma mapbox: define-attribute highp vec3 color_3f
#pragma mapbox: define-attribute highp vec4 color_4f
#pragma mapbox: define-attribute highp vec2 uv_2f
#pragma mapbox: initialize-attribute highp vec3 normal_3f
#pragma mapbox: initialize-attribute highp vec3 color_3f
#pragma mapbox: initialize-attribute highp vec4 color_4f
#pragma mapbox: initialize-attribute highp vec2 uv_2f
#ifdef HAS_ATTRIBUTE_a_pbr
in lowp vec4 v_roughness_metallic_emissive_alpha;in mediump vec4 v_height_based_emission_params;
#endif
#ifdef HAS_TEXTURE_u_baseColorTexture
uniform sampler2D u_baseColorTexture;uniform bool u_baseTextureIsAlpha;uniform bool u_alphaMask;uniform float u_alphaCutoff;
#endif
#ifdef HAS_TEXTURE_u_metallicRoughnessTexture
uniform sampler2D u_metallicRoughnessTexture;
#endif
#ifdef HAS_TEXTURE_u_occlusionTexture
uniform sampler2D u_occlusionTexture;uniform float u_aoIntensity;
#endif
#ifdef HAS_TEXTURE_u_normalTexture
uniform sampler2D u_normalTexture;
#endif
#ifdef HAS_TEXTURE_u_emissionTexture
uniform sampler2D u_emissionTexture;
#endif
#ifdef TERRAIN_FRAGMENT_OCCLUSION
in highp float v_depth;uniform sampler2D u_depthTexture;uniform vec2 u_inv_depth_size;bool isOccluded() {vec2 coord=gl_FragCoord.xy*u_inv_depth_size;highp float depth=unpack_depth(texture(u_depthTexture,coord));return v_depth > depth+0.0005;}
#endif
#define saturate(_x) clamp(_x,0.,1.)
vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}float calculate_NdotL(vec3 normal,vec3 lightDir) {const float ext=0.70710678118;return (clamp(dot(normal,lightDir),-ext,1.0)+ext)/(1.0+ext);}vec3 getDiffuseShadedColor(vec3 albedo,vec3 normal,vec3 lightDir,vec3 lightColor)
{
#ifdef LIGHTING_3D_MODE
vec3 transformed_normal=vec3(-normal.xy,normal.z);float lighting_factor;
#ifdef RENDER_SHADOWS
lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
lighting_factor=saturate(dot(transformed_normal,u_lighting_directional_dir));
#endif
return apply_lighting(albedo,transformed_normal,lighting_factor);
#else
vec3 n=normal;float colorvalue=((albedo.x*0.2126)+(albedo.y*0.7152))+(albedo.z*0.0722);vec3 c=vec3(0.03,0.03,0.03);float directional=clamp(dot(n,vec3(lightDir)),0.0,1.0);directional=mix(1.0-u_lightintensity,max((1.0-colorvalue)+u_lightintensity,1.0),directional);vec3 c3=c+clamp((albedo*directional)*lightColor,mix(vec3(0.0),vec3(0.3),vec3(1.0)-lightColor),vec3(1.0));return c3;
#endif
}vec4 getBaseColor() {vec4 albedo=u_baseColorFactor;
#ifdef HAS_ATTRIBUTE_a_color_3f
albedo*=vec4(color_3f,1.0);
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
#else
#ifdef HAS_ATTRIBUTE_a_color_4f
albedo*=color_4f;
#endif
#endif
#if defined (HAS_TEXTURE_u_baseColorTexture) && defined (HAS_ATTRIBUTE_a_uv_2f)
vec4 texColor=texture(u_baseColorTexture,uv_2f);if(u_alphaMask) {if (texColor.w < u_alphaCutoff) {discard;}}
#ifdef UNPREMULT_TEXTURE_IN_SHADER
if(texColor.w > 0.0) {texColor.rgb/=texColor.w;}texColor.w=1.0;
#endif
texColor.rgb=sRGBToLinear(texColor.rgb);if(u_baseTextureIsAlpha) {if (texColor.w < 0.5) {discard;}albedo*=mix(vec4(texColor.rgb,texColor.a),vec4(texColor.a),float(u_baseTextureIsAlpha));} else {albedo*=texColor;}
#endif
return vec4(mix(albedo.rgb,v_color_mix.rgb,v_color_mix.a),albedo.a);}highp mat3 cotangentFrame(highp vec3 N,highp vec3 p,highp vec2 uv ) {
#ifdef HAS_TEXTURE_u_normalTexture
highp vec3 dp1=vec3(dFdx(p.x),dFdx(p.y),dFdx(p.z));highp vec3 dp2=vec3(dFdy(p.x),dFdy(p.y),dFdy(p.z));highp vec2 duv1=vec2(dFdx(uv.x),dFdx(uv.y));highp vec2 duv2=vec2(dFdy(uv.x),dFdy(uv.y));highp vec3 dp2perp=cross( dp2,N );highp vec3 dp1perp=cross( N,dp1 );highp vec3 T=dp2perp*duv1.x+dp1perp*duv2.x;highp vec3 B=dp2perp*duv1.y+dp1perp*duv2.y;highp float lengthT=dot(T,T);highp float lengthB=dot(B,B);highp float maxLength=max(lengthT,lengthB);highp float invmax=inversesqrt( maxLength );highp mat3 res=mat3( T*invmax,B*invmax,N );return res;
#else
return mat3(1.0);
#endif
}highp vec3 getNormal(){highp vec3 n;
#ifdef HAS_ATTRIBUTE_a_normal_3f
n=normalize(normal_3f);
#else
highp vec3 fdx=vec3(dFdx(v_position_height.x),dFdx(v_position_height.y),dFdx(v_position_height.z));highp vec3 fdy=vec3(dFdy(v_position_height.x),dFdy(v_position_height.y),dFdy(v_position_height.z));n=normalize(cross(fdx,fdy))*-1.0;
#endif
#if defined(HAS_TEXTURE_u_normalTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
vec3 nMap=texture( u_normalTexture,uv_2f).xyz;nMap=normalize(2.0*nMap-vec3(1.0));highp vec3 v=normalize(-v_position_height.xyz);highp mat3 TBN=cotangentFrame(n,v,uv_2f);n=normalize(TBN*nMap);
#endif
return n;}struct Material {float perceptualRoughness;float alphaRoughness;float metallic;vec3 f90;vec4 baseColor;vec3 diffuseColor;vec3 specularColor;highp vec3 normal;};Material getPBRMaterial() {Material mat;mat.baseColor=getBaseColor();mat.perceptualRoughness=u_roughnessFactor;mat.metallic=u_metallicFactor;
#ifdef HAS_ATTRIBUTE_a_pbr
mat.perceptualRoughness=v_roughness_metallic_emissive_alpha.x;mat.metallic=v_roughness_metallic_emissive_alpha.y;mat.baseColor.w*=v_roughness_metallic_emissive_alpha.w;
#endif
#if defined(HAS_TEXTURE_u_metallicRoughnessTexture) && defined(HAS_ATTRIBUTE_a_uv_2f) 
vec4 mrSample=texture(u_metallicRoughnessTexture,uv_2f);mat.perceptualRoughness*=mrSample.g;mat.metallic*=mrSample.b;
#endif
const float c_minRoughness=0.04;mat.perceptualRoughness=clamp(mat.perceptualRoughness,c_minRoughness,1.0);mat.metallic=saturate(mat.metallic);mat.alphaRoughness=mat.perceptualRoughness*mat.perceptualRoughness;const vec3 f0=vec3(0.04);mat.diffuseColor=mat.baseColor.rgb*(vec3(1.0)-f0);mat.diffuseColor*=1.0-mat.metallic;mat.specularColor=mix(f0,mat.baseColor.rgb,mat.metallic);highp float reflectance=max(max(mat.specularColor.r,mat.specularColor.g),mat.specularColor.b);highp float reflectance90=saturate(reflectance*25.0);mat.f90=vec3(reflectance90);mat.normal=getNormal();return mat;}float V_GGX(float NdotL,float NdotV,float roughness)
{float a2=roughness*roughness;float GGXV=NdotL*sqrt(NdotV*NdotV*(1.0-a2)+a2);float GGXL=NdotV*sqrt(NdotL*NdotL*(1.0-a2)+a2);return 0.5/(GGXV+GGXL);}float V_GGXFast(float NdotL,float NdotV,float roughness) {float a=roughness;float GGXV=NdotL*(NdotV*(1.0-a)+a);float GGXL=NdotV*(NdotL*(1.0-a)+a);return 0.5/(GGXV+GGXL);}vec3 F_Schlick(vec3 specularColor,vec3 f90,float VdotH)
{return specularColor+(f90-specularColor)*pow(clamp(1.0-VdotH,0.0,1.0),5.0);}vec3 F_SchlickFast(vec3 specularColor,float VdotH)
{float x=1.0-VdotH;float x4=x*x*x*x;return specularColor+(1.0-specularColor)*x4*x;}float D_GGX(highp float NdotH,float alphaRoughness)
{highp float a4=alphaRoughness*alphaRoughness;highp float f=(NdotH*a4-NdotH)*NdotH+1.0;return a4/(PI*f*f);}vec3 diffuseBurley(Material mat,float LdotH,float NdotL,float NdotV)
{float f90=2.0*LdotH*LdotH*mat.alphaRoughness-0.5;return (mat.diffuseColor/PI)*(1.0+f90*pow((1.0-NdotL),5.0))*(1.0+f90*pow((1.0-NdotV),5.0));}vec3 diffuseLambertian(Material mat)
{
#ifdef LIGHTING_3D_MODE
return mat.diffuseColor;
#else
return mat.diffuseColor/PI;
#endif
}vec3 EnvBRDFApprox(vec3 specularColor,float roughness,highp float NdotV)
{vec4 c0=vec4(-1,-0.0275,-0.572,0.022);vec4 c1=vec4(1,0.0425,1.04,-0.04);highp vec4 r=roughness*c0+c1;highp float a004=min(r.x*r.x,exp2(-9.28*NdotV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}vec3 computeIndirectLightContribution(Material mat,float NdotV,vec3 normal)
{vec3 env_light=vec3(0.65,0.65,0.65);
#ifdef LIGHTING_3D_MODE
float ambient_factor=calculate_ambient_directional_factor(normal);env_light=u_lighting_ambient_color*ambient_factor;
#endif
vec3 envBRDF=EnvBRDFApprox(mat.specularColor,mat.perceptualRoughness,NdotV);vec3 indirectSpecular= envBRDF*env_light;vec3 indirectDiffuse=mat.diffuseColor*env_light;return indirectSpecular+indirectDiffuse;}vec3 computeLightContribution(Material mat,vec3 lightPosition,vec3 lightColor)
{highp vec3 n=mat.normal;highp vec3 v=normalize(-v_position_height.xyz);highp vec3 l=normalize(lightPosition);highp vec3 h=normalize(v+l);float NdotV=clamp(abs(dot(n,v)),0.001,1.0);float NdotL=saturate(dot(n,l));highp float NdotH=saturate(dot(n,h));float VdotH=saturate(dot(v,h));vec3 f=F_SchlickFast(mat.specularColor,VdotH);float g=V_GGXFast(NdotL,NdotV,mat.alphaRoughness);float d=D_GGX(NdotH,mat.alphaRoughness);vec3 diffuseTerm=(1.0-f)*diffuseLambertian(mat);vec3 specularTerm=f*g*d;vec3 transformed_normal=vec3(-n.xy,n.z);float lighting_factor;
#ifdef RENDER_SHADOWS
lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
lighting_factor=NdotL;
#endif
vec3 directLightColor=(specularTerm+diffuseTerm)*lighting_factor*lightColor;vec3 indirectLightColor=computeIndirectLightContribution(mat,NdotV,transformed_normal);vec3 color=(saturate(directLightColor)+indirectLightColor);float intensityFactor=1.0;
#if !defined(LIGHTING_3D_MODE)
const vec3 luminosityFactor=vec3(0.2126,0.7152,0.0722);float luminance=dot(diffuseTerm,luminosityFactor);intensityFactor=mix((1.0-u_lightintensity),max((1.0-luminance+u_lightintensity),1.0),NdotL);
#endif
color*=intensityFactor;return color;}void main() {
#ifdef TERRAIN_FRAGMENT_OCCLUSION
if (isOccluded()) {discard;}
#endif
vec3 lightDir=u_lightpos;vec3 lightColor=u_lightcolor;
#ifdef LIGHTING_3D_MODE
lightDir=u_lighting_directional_dir;lightDir.xy=-lightDir.xy;lightColor=u_lighting_directional_color;
#endif
vec4 finalColor;
#ifdef DIFFUSE_SHADED
vec3 N=getNormal();vec3 diffuse=getDiffuseShadedColor(getBaseColor().rgb,N,lightDir,lightColor);
#ifdef HAS_TEXTURE_u_occlusionTexture
float ao=(texture(u_occlusionTexture,uv_2f).r-1.0)*u_aoIntensity+1.0;diffuse*=ao;
#endif
finalColor=vec4(diffuse,1.0)*u_opacity;
#else
Material mat=getPBRMaterial();vec3 color=computeLightContribution(mat,lightDir,lightColor);float ao=1.0;
#if defined (HAS_TEXTURE_u_occlusionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
ao=(texture(u_occlusionTexture,uv_2f).x-1.0)*u_aoIntensity+1.0;color*=ao;
#endif
vec4 emissive=u_emissiveFactor;
#if defined(HAS_TEXTURE_u_emissionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
emissive.rgb*=sRGBToLinear(texture(u_emissionTexture,uv_2f).rgb);
#endif
color+=emissive.rgb;float opacity=mat.baseColor.w*u_opacity;
#ifdef HAS_ATTRIBUTE_a_pbr
float resEmission=v_roughness_metallic_emissive_alpha.z;resEmission*=v_height_based_emission_params.z+v_height_based_emission_params.w*pow(clamp(v_height_based_emission_params.x,0.0,1.0),v_height_based_emission_params.y);color=mix(color,v_color_mix.rgb,min(1.0,resEmission));
#ifdef HAS_ATTRIBUTE_a_color_4f
float distance=length(vec2(1.3*max(0.0,abs(color_4f.x)-color_4f.z),color_4f.y));distance+= mix(0.5,0.0,clamp(resEmission-1.0,0.0,1.0));opacity*=v_roughness_metallic_emissive_alpha.w*saturate(1.0-distance*distance);
#endif
#endif
vec3 unlitColor=mat.baseColor.rgb*ao+emissive.rgb;color=mix(color,unlitColor,u_emissive_strength);color=linearTosRGB(color);color*=opacity;finalColor=vec4(color,opacity);
#endif
#ifdef FOG
finalColor=fog_dither(fog_apply_premultiplied(finalColor,v_fog_pos,v_position_height.w));
#endif
#ifdef RENDER_CUTOFF
finalColor*=v_cutoff_opacity;
#endif
#ifdef INDICATOR_CUTOUT
finalColor=applyCutout(finalColor);
#endif
glFragColor=finalColor;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec3 a_pos_3f;
#pragma mapbox: define-attribute highp vec3 normal_3f
#pragma mapbox: define-attribute highp vec2 uv_2f
#pragma mapbox: define-attribute highp vec3 color_3f
#pragma mapbox: define-attribute highp vec4 color_4f
#pragma mapbox: define-attribute-vertex-shader-only highp vec4 pbr
#pragma mapbox: define-attribute-vertex-shader-only highp vec3 heightBasedEmissiveStrength
uniform mat4 u_matrix;uniform mat4 u_lighting_matrix;uniform vec3 u_camera_pos;uniform vec4 u_color_mix;
#ifdef INSTANCED_ARRAYS
in vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;
#else
uniform highp mat4 u_normal_matrix;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;out float v_depth_shadows;
#endif
out vec4 v_position_height;out lowp vec4 v_color_mix;
#ifdef TERRAIN_FRAGMENT_OCCLUSION
out highp float v_depth;
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
out lowp vec4 v_roughness_metallic_emissive_alpha;out mediump vec4 v_height_based_emission_params;
#endif
vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {
#pragma mapbox: initialize-attribute highp vec3 normal_3f
#pragma mapbox: initialize-attribute highp vec2 uv_2f
#pragma mapbox: initialize-attribute highp vec3 color_3f
#pragma mapbox: initialize-attribute highp vec4 color_4f
#pragma mapbox: initialize-attribute-custom highp vec4 pbr
#pragma mapbox: initialize-attribute-custom highp vec3 heightBasedEmissiveStrength
highp mat4 normal_matrix;
#ifdef INSTANCED_ARRAYS
normal_matrix=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);
#else
normal_matrix=u_normal_matrix;
#endif
vec3 local_pos;mat3 rs;
#ifdef MODEL_POSITION_ON_GPU
vec3 pos_color=normal_matrix[0].xyz;vec4 translate=normal_matrix[1];vec3 pos_a=floor(pos_color);vec3 rgb=1.05*(pos_color-pos_a);float color_mix=pos_a.z/100.0;v_color_mix=vec4(sRGBToLinear(rgb),color_mix);float meter_to_tile=normal_matrix[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);rs[0].x=normal_matrix[1].w;rs[0].yz=normal_matrix[2].xy;rs[1].xy=normal_matrix[2].zw;rs[1].z=normal_matrix[3].x;rs[2].xyz=normal_matrix[3].yzw;vec4 pos_node=u_lighting_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;local_pos=pos.xyz;gl_Position=u_matrix*pos;pos.z*=meter_to_tile;v_position_height.xyz=pos.xyz-u_camera_pos;
#else
local_pos=a_pos_3f;gl_Position=u_matrix*vec4(a_pos_3f,1);v_position_height.xyz=vec3(u_lighting_matrix*vec4(a_pos_3f,1));v_color_mix=vec4(sRGBToLinear(u_color_mix.rgb),u_color_mix.a);
#endif
v_position_height.w=a_pos_3f.z;
#ifdef HAS_ATTRIBUTE_a_pbr
vec4 albedo_c=decode_color(pbr.xy);vec2 e_r_m=unpack_float(pbr.z);vec2 r_m= unpack_float(e_r_m.y*16.0);r_m.r=r_m.r*16.0;v_color_mix=vec4(albedo_c.rgb,1.0);v_roughness_metallic_emissive_alpha=vec4(vec3(r_m,e_r_m.x)/255.0,albedo_c.a);v_roughness_metallic_emissive_alpha.z*=2.0;float heightBasedRelativeIntepolation=a_pos_3f.z*heightBasedEmissiveStrength.x+heightBasedEmissiveStrength.y;v_height_based_emission_params.x=heightBasedRelativeIntepolation;v_height_based_emission_params.y=heightBasedEmissiveStrength.z;vec2 emissionMultiplierValues=unpack_float(pbr.w)/256.0;v_height_based_emission_params.z=emissionMultiplierValues.x;v_height_based_emission_params.w=emissionMultiplierValues.y-emissionMultiplierValues.x;
#endif
#ifdef FOG
v_fog_pos=fog_position(local_pos);
#endif
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
#ifdef TERRAIN_FRAGMENT_OCCLUSION
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef HAS_ATTRIBUTE_a_normal_3f
#ifdef MODEL_POSITION_ON_GPU
float x_squared_scale=dot(rs[0],rs[0]);float y_squared_scale=dot(rs[1],rs[1]);float z_squared_scale=dot(rs[2],rs[2]);vec3 squared_scale=vec3(x_squared_scale,y_squared_scale,z_squared_scale);normal_3f=rs*((u_lighting_matrix*vec4(normal_3f,0.0)).xyz/squared_scale);normal_3f=normalize(normal_3f);
#else
normal_3f=vec3(normal_matrix*vec4(normal_3f,0));
#endif
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
#ifdef HAS_ATTRIBUTE_a_color_4f
v_roughness_metallic_emissive_alpha.w=clamp(color_4f.a*v_roughness_metallic_emissive_alpha.w*(v_roughness_metallic_emissive_alpha.z-1.0),0.0,1.0);
#endif
#endif
#ifdef RENDER_SHADOWS
vec3 shadow_pos=local_pos;
#ifdef NORMAL_OFFSET
#ifdef HAS_ATTRIBUTE_a_normal_3f
#ifdef MODEL_POSITION_ON_GPU
vec3 offset=shadow_normal_offset(vec3(-normal_3f.xy,normal_3f.z));shadow_pos+=offset*shadow_normal_offset_multiplier0();
#else
vec3 offset=shadow_normal_offset_model(normalize(normal_3f));shadow_pos+=offset*shadow_normal_offset_multiplier0();
#endif
#endif
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shadow_pos,1);v_pos_light_view_1=u_light_matrix_1*vec4(shadow_pos,1);v_depth_shadows=gl_Position.w;
#endif
}`),modelDepth:Li(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,`in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;
#ifdef MODEL_POSITION_ON_GPU
#ifdef INSTANCED_ARRAYS
in vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;
#else
uniform highp mat4 u_instance;
#endif
uniform highp mat4 u_node_matrix;
#endif
void main() {
#ifdef MODEL_POSITION_ON_GPU
highp mat4 instance;
#ifdef INSTANCED_ARRAYS
instance=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);
#else
instance=u_instance;
#endif
vec3 pos_color=instance[0].xyz;vec4 translate=instance[1];vec3 pos_a=floor(pos_color);float meter_to_tile=instance[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);mat3 rs;rs[0].x=instance[1].w;rs[0].yz=instance[2].xy;rs[1].xy=instance[2].zw;rs[1].z=instance[3].x;rs[2].xyz=instance[3].yzw;vec4 pos_node=u_node_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;gl_Position=u_matrix*pos;
#else
gl_Position=u_matrix*vec4(a_pos_3f,1);
#endif
v_depth=gl_Position.z/gl_Position.w;}`),stars:Li(`in highp vec2 v_uv;in mediump float v_intensity;float shapeCircle(in vec2 uv)
{float beginFade=0.6;float lengthFromCenter=length(v_uv);return 1.0-clamp((lengthFromCenter-beginFade)/(1.0-beginFade),0.0,1.0);}void main() {float alpha=shapeCircle(v_uv);vec3 color=vec3(1.0,1.0,1.0);alpha*=v_intensity;glFragColor=vec4(color*alpha,alpha);HANDLE_WIREFRAME_DEBUG;}`,`
in vec3 a_pos_3f;in vec2 a_uv;in float a_size_scale;in float a_fade_opacity;uniform mat4 u_matrix;uniform vec3 u_up;uniform vec3 u_right;uniform float u_intensity_multiplier;out highp vec2 v_uv;out mediump float v_intensity;void main() {v_uv=a_uv;v_intensity=a_fade_opacity*u_intensity_multiplier;vec3 pos=a_pos_3f;pos+=a_uv.x*u_right*a_size_scale;pos+=a_uv.y*u_up*a_size_scale;gl_Position=u_matrix*vec4(pos,1.0);}`)};function vd(e,t){const i=e.replace(/\s*\/\/[^\n]*\n/g,`
`).split(`
`);for(let n of i)if(n=n.trim(),n[0]==="#"&&n.includes("if")&&!n.includes("endif")){n=n.replace("#","").replace(/ifdef|ifndef|elif|if/g,"").replace(/!|defined|\(|\)|\|\||&&/g,"").replace(/\s+/g," ").trim();const r=n.split(" ");for(const o of r)t.includes(o)||t.push(o)}}function Li(e,t){const i=/#include\s+"([^"]+)"/g,n=/#pragma mapbox: ([\w\-]+) ([\w]+) ([\w]+) ([\w]+)/g;let r=t.match(/(attribute(\S*)|(^\s*|;)in) (highp |mediump |lowp )?([\w]+) ([\w]+)/gm);r&&(r=r.map(c=>{const u=c.split(" ");return u[u.length-1]}),r=[...new Set(r)]);const o={},s=[],a=[];e=e.replace(i,(c,u)=>(a.push(u),"")),t=t.replace(i,(c,u)=>(s.push(u),""));let l=[...tw];vd(e,l),vd(t,l);for(const c of[...s,...a])gd[c]||console.error(`Undefined include: ${c}`),yd[c]||(yd[c]=[],vd(gd[c],yd[c])),l=[...l,...yd[c]];return{fragmentSource:e=e.replace(n,(c,u,h,d,p)=>(o[p]=!0,u==="define"?`
#ifndef HAS_UNIFORM_u_${p}
in ${h} ${d} ${p};
#else
uniform ${h} ${d} u_${p};
#endif
`:u==="initialize"?`
#ifdef HAS_UNIFORM_u_${p}
    ${h} ${d} ${p} = u_${p};
#endif
`:u==="define-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${p}
    in ${h} ${d} ${p};
#endif
`:u==="initialize-attribute"?"":void 0)),vertexSource:t=t.replace(n,(c,u,h,d,p)=>{const _=d==="float"?"vec2":d,g=p.match(/color/)?"color":_;return u==="define-attribute-vertex-shader-only"?`
#ifdef HAS_ATTRIBUTE_a_${p}
in ${h} ${d} a_${p};
#endif
`:o[p]?u==="define"?`
#ifndef HAS_UNIFORM_u_${p}
uniform lowp float u_${p}_t;
in ${h} ${_} a_${p};
out ${h} ${d} ${p};
#else
uniform ${h} ${d} u_${p};
#endif
`:u==="initialize"?g==="vec4"?`
#ifndef HAS_UNIFORM_u_${p}
    ${p} = a_${p};
#else
    ${h} ${d} ${p} = u_${p};
#endif
`:`
#ifndef HAS_UNIFORM_u_${p}
    ${p} = unpack_mix_${g}(a_${p}, u_${p}_t);
#else
    ${h} ${d} ${p} = u_${p};
#endif
`:u==="define-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${p}
    in ${h} ${d} a_${p};
    out ${h} ${d} ${p};
#endif
`:u==="initialize-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${p}
    ${p} = a_${p};
#endif
`:void 0:u==="define"?`
#ifndef HAS_UNIFORM_u_${p}
uniform lowp float u_${p}_t;
in ${h} ${_} a_${p};
#else
uniform ${h} ${d} u_${p};
#endif
`:u==="define-instanced"?g==="mat4"?`
#ifdef INSTANCED_ARRAYS
in vec4 a_${p}0;
in vec4 a_${p}1;
in vec4 a_${p}2;
in vec4 a_${p}3;
#else
uniform ${h} ${d} u_${p};
#endif
`:`
#ifdef INSTANCED_ARRAYS
in ${h} ${_} a_${p};
#else
uniform ${h} ${d} u_${p};
#endif
`:u==="initialize-attribute-custom"?`
#ifdef HAS_ATTRIBUTE_a_${p}
    ${h} ${d} ${p} = a_${p};
#endif
`:g==="vec4"?`
#ifndef HAS_UNIFORM_u_${p}
    ${h} ${d} ${p} = a_${p};
#else
    ${h} ${d} ${p} = u_${p};
#endif
`:`
#ifndef HAS_UNIFORM_u_${p}
    ${h} ${d} ${p} = unpack_mix_${g}(a_${p}, u_${p}_t);
#else
    ${h} ${d} ${p} = u_${p};
#endif
`}),staticAttributes:r,usedDefines:l,vertexIncludes:s,fragmentIncludes:a}}class cC{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffers=[],this.vao=null}bind(t,i,n,r,o,s,a,l){this.context=t;let c=this.boundPaintVertexBuffers.length!==r.length;for(let h=0;!c&&h<r.length;h++)this.boundPaintVertexBuffers[h]!==r[h]&&(c=!0);let u=this.boundDynamicVertexBuffers.length!==a.length;for(let h=0;!u&&h<a.length;h++)this.boundDynamicVertexBuffers[h]!==a[h]&&(u=!0);if(!this.vao||this.boundProgram!==i||this.boundLayoutVertexBuffer!==n||c||u||this.boundIndexBuffer!==o||this.boundVertexOffset!==s)this.freshBind(i,n,r,o,s,a,l);else{t.bindVertexArrayOES.set(this.vao);for(const h of a)h&&(h.bind(),l&&h.instanceCount&&h.setVertexAttribDivisor(t.gl,i,l));o&&o.dynamicDraw&&o.bind()}}freshBind(t,i,n,r,o,s,a){const l=t.numAttributes,c=this.context,u=c.gl;this.vao&&this.destroy(),this.vao=c.gl.createVertexArray(),c.bindVertexArrayOES.set(this.vao),this.boundProgram=t,this.boundLayoutVertexBuffer=i,this.boundPaintVertexBuffers=n,this.boundIndexBuffer=r,this.boundVertexOffset=o,this.boundDynamicVertexBuffers=s,i.enableAttributes(u,t),i.bind(),i.setVertexAttribPointers(u,t,o);for(const h of n)h.enableAttributes(u,t),h.bind(),h.setVertexAttribPointers(u,t,o);for(const h of s)h&&(h.enableAttributes(u,t),h.bind(),h.setVertexAttribPointers(u,t,o),a&&h.instanceCount&&h.setVertexAttribDivisor(u,t,a));r&&r.bind(),c.currentNumAttributes=l}destroy(){this.vao&&(this.context.gl.deleteVertexArray(this.vao),this.vao=null)}}function uC(e,t){const i=Math.pow(2,t.canonical.z),n=t.canonical.y;return[new ui(0,n/i).toLngLat().lat,new ui(0,(n+1)/i).toLngLat().lat]}function hC(e,t,i,n,r,o,s){const a=e.context,l=a.gl,c=i.hillshadeFBO;if(!c)return;e.prepareDrawTile();const u=e.isTileAffectedByFog(t),h=e.getOrCreateProgram("hillshade",{overrideFog:u});a.activeTexture.set(l.TEXTURE0),l.bindTexture(l.TEXTURE_2D,c.colorAttachment.get());const d=((y,x,b,M)=>{const E=b.paint.get("hillshade-shadow-color"),T=b.paint.get("hillshade-highlight-color"),S=b.paint.get("hillshade-accent-color"),D=b.paint.get("hillshade-emissive-strength");let z=wt(b.paint.get("hillshade-illumination-direction"));if(b.paint.get("hillshade-illumination-anchor")==="viewport")z-=y.transform.angle;else if(y.style&&y.style.enable3dLights()&&y.style.directionalLight){const R=y.style.directionalLight.properties.get("direction");z=wt(ie(R.x,R.y,R.z)[1])}const L=!y.options.moving;return{u_matrix:M||y.transform.calculateProjMatrix(x.tileID.toUnwrapped(),L),u_image:0,u_latrange:uC(0,x.tileID),u_light:[b.paint.get("hillshade-exaggeration"),z],u_shadow:E,u_highlight:T,u_emissive_strength:D,u_accent:S}})(e,i,n,e.terrain?t.projMatrix:null);e.uploadCommonUniforms(a,h,t.toUnwrapped());const{tileBoundsBuffer:p,tileBoundsIndexBuffer:_,tileBoundsSegments:g}=e.getTileBoundsBuffers(i);h.draw(e,l.TRIANGLES,r,o,s,ti.disabled,d,n.id,p,_,g)}function rw(e,t,i){if(!t.needsDEMTextureUpload)return;const n=e.context,r=n.gl;n.pixelStoreUnpackPremultiplyAlpha.set(!1),t.demTexture=t.demTexture||e.getTileTexture(i.stride);const o=i.getPixels();t.demTexture?t.demTexture.update(o,{premultiply:!1}):t.demTexture=new mn(n,o,r.R32F,{premultiply:!1}),t.needsDEMTextureUpload=!1}function dC(e,t,i){const n=e.context,r=n.gl;if(!t.dem)return;const o=t.dem;if(n.activeTexture.set(r.TEXTURE1),rw(e,t,o),!t.demTexture)return;t.demTexture.bind(r.NEAREST,r.CLAMP_TO_EDGE);const s=o.dim;n.activeTexture.set(r.TEXTURE0);let a=t.hillshadeFBO;if(!a){const d=new mn(n,{width:s,height:s,data:null},r.RGBA);d.bind(r.LINEAR,r.CLAMP_TO_EDGE),a=t.hillshadeFBO=n.createFramebuffer(s,s,!0,"renderbuffer"),a.colorAttachment.set(d.texture)}n.bindFramebuffer.set(a.framebuffer),n.viewport.set([0,0,s,s]);const{tileBoundsBuffer:l,tileBoundsIndexBuffer:c,tileBoundsSegments:u}=e.getMercatorTileBoundsBuffers(),h=[];e.linearFloatFilteringSupported()&&h.push("TERRAIN_DEM_FLOAT_FORMAT"),e.getOrCreateProgram("hillshadePrepare",{defines:h}).draw(e,r.TRIANGLES,Ie.disabled,Ke.disabled,Ti.unblended,ti.disabled,((d,p)=>{const _=p.stride,g=st.create();return st.ortho(g,0,pt,-pt,0,0,1),st.translate(g,g,[0,-pt,0]),{u_matrix:g,u_image:1,u_dimension:[_,_],u_zoom:d.overscaledZ}})(t.tileID,o),i.id,l,c,u),t.needsHillshadePrepare=!1}const ow=e=>({u_matrix:new Ne(e),u_image0:new ei(e),u_skirt_height:new Nt(e),u_ground_shadow_factor:new je(e)}),sw=(e,t,i)=>({u_matrix:e,u_image0:0,u_skirt_height:t,u_ground_shadow_factor:i}),aw=(e,t,i,n,r,o,s,a,l,c,u,h,d,p,_)=>({u_proj_matrix:Float32Array.from(e),u_globe_matrix:t,u_normalize_matrix:Float32Array.from(n),u_merc_matrix:i,u_zoom_transition:r,u_merc_center:o,u_image0:0,u_frustum_tl:s,u_frustum_tr:a,u_frustum_br:l,u_frustum_bl:c,u_globe_pos:u,u_globe_radius:h,u_viewport:d,u_grid_matrix:_?Float32Array.from(_):new Float32Array(9),u_skirt_height:p}),Ul=(e,t)=>{if(t>0&&e.terrain&&J("Cutoff is currently disabled on terrain"),t<=0||e.terrain)return{shouldRenderCutoff:!1,uniformValues:{u_cutoff_params:[0,0,0,0]}};const i=e.transform,n=Math.max(Math.abs(i._zoom-(e.minCutoffZoom-1)),1),r=i.isLODDisabled(!1)?Fe(60,45,i.pitch):Fe(30,15,i.pitch),o=i._farZ-i._nearZ,s=t*i.height,a=((1-(l=r))*(.75*i.cameraToCenterDistance)+l*(i._farZ+s))*n;var l;return{shouldRenderCutoff:r<1,uniformValues:{u_cutoff_params:[i._nearZ,i._farZ,(a-i._nearZ)/o,(a-s-i._nearZ)/o]}}};function lw(e,t){return e!=null&&t!=null&&!(!e.hasData()||!t.hasData())&&e.demTexture!=null&&t.demTexture!=null&&e.tileID.key!==t.tileID.key}const Vl=new class{constructor(){this.operations={}}newMorphing(e,t,i,n,r){if(e in this.operations){const o=this.operations[e];o.to.tileID.key!==i.tileID.key&&(o.queued=i)}else this.operations[e]={startTime:n,phase:0,duration:r,from:t,to:i,queued:null}}getMorphValuesForProxy(e){if(!(e in this.operations))return null;const t=this.operations[e];return{from:t.from,to:t.to,phase:t.phase}}update(e){for(const t in this.operations){const i=this.operations[t];for(i.phase=(e-i.startTime)/i.duration;i.phase>=1||!this._validOp(i);)if(!this._nextOp(i,e)){delete this.operations[t];break}}}_nextOp(e,t){return!!e.queued&&(e.from=e.to,e.to=e.queued,e.queued=null,e.phase=0,e.startTime=t,!0)}_validOp(e){return e.from.hasData()&&e.to.hasData()}},cw={0:null,1:"TERRAIN_VERTEX_MORPHING"};function uw(e,t,i){if(t===0)return 0;const n=t<1&&i===514?.25/t:1;return 6*Math.pow(1.5,22-e)*Math.max(t,1)*n}function fC(e,t){const i=1<<e.z;return!t&&(e.x===0||e.x===i-1)||e.y===0||e.y===i-1}const v_=e=>({u_matrix:e});function hw(e,t,i,n,r){if(r>0){const o=ke.now(),s=(o-e.timeAdded)/r,a=t?(o-t.timeAdded)/r:-1,l=i.getSource(),c=n.coveringZoomLevel({tileSize:l.tileSize,roundZoom:l.roundZoom}),u=!t||Math.abs(t.tileID.overscaledZ-c)>Math.abs(e.tileID.overscaledZ-c),h=u&&e.refreshedUponExpiration?1:Lt(u?s:1-a,0,1);return e.refreshedUponExpiration&&s>=1&&(e.refreshedUponExpiration=!1),t?{opacity:1,mix:1-h}:{opacity:h,mix:0}}return{opacity:1,mix:0}}class pC extends co{constructor(t){const i={type:"raster-dem",maxzoom:t.transform.maxZoom},n=new Ba(cu(),null),r=h_("mock-dem",i,n,t.style);super("mock-dem",r,!1),r.setEventedParent(this),this._sourceLoaded=!0}_loadTile(t,i){t.state="loaded",i(null)}}class mC extends co{constructor(t){const i=h_("proxy",{type:"geojson",maxzoom:t.transform.maxZoom},new Ba(cu(),null),t.style);super("proxy",i,!1),i.setEventedParent(this),this.map=this.getSource().map=t,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(t,i,n){if(t.freezeTileCoverage)return;this.transform=t;const r=t.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce((o,s)=>{if(o[s.key]="",!this._tiles[s.key]){const a=new Jc(s,this._source.tileSize*s.overscaleFactor(),t.tileZoom);a.state="loaded",this._tiles[s.key]=a}return o},{});for(const o in this._tiles)o in r||(this.freeFBO(o),this._tiles[o].unloadVectorData(),delete this._tiles[o])}freeFBO(t){const i=this.proxyCachedFBO[t];if(i!==void 0){const n=Object.values(i);this.renderCachePool.push(...n),delete this.proxyCachedFBO[t]}}deallocRenderCache(){this.renderCache.forEach(t=>t.fb.destroy()),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}}class dw extends Si{constructor(t,i,n){super(t.overscaledZ,t.wrap,t.canonical.z,t.canonical.x,t.canonical.y),this.proxyTileKey=i,this.projMatrix=n}}class _C extends $S{constructor(t,i){super(),this.painter=t,this.terrainTileForTile={},this.prevTerrainTileForTile={};const[n,r,o]=function(l){const c=new Tr,u=new Rn,h=131;c.reserve(17161),u.reserve(33800);const d=pt/128,p=pt+d/2,_=p+d;for(let y=-d;y<_;y+=d)for(let x=-d;x<_;x+=d){const b=x<0||x>p||y<0||y>p?24575:0,M=Lt(Math.round(x),0,pt),E=Lt(Math.round(y),0,pt);c.emplaceBack(M+b,E)}const g=(y,x)=>{const b=x*h+y;u.emplaceBack(b+1,b,b+h),u.emplaceBack(b+h,b+h+1,b+1)};for(let y=1;y<129;y++)for(let x=1;x<129;x++)g(x,y);return[0,129].forEach(y=>{for(let x=0;x<130;x++)g(x,y),g(y,x)}),[c,u,32768]}(),s=t.context;this.gridBuffer=s.createVertexBuffer(n,Us.members),this.gridIndexBuffer=s.createIndexBuffer(r),this.gridSegments=Fi.simpleSegment(0,0,n.length,r.length),this.gridNoSkirtSegments=Fi.simpleSegment(0,0,n.length,o),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new mC(i.map),this.orthoMatrix=st.create(),st.ortho(this.orthoMatrix,this.painter.transform.projection.name==="globe"?.015:0,pt,0,pt,0,1);const a=s.gl;this._overlapStencilMode=new Ke({func:a.GEQUAL,mask:255},0,255,a.KEEP,a.KEEP,a.REPLACE),this._previousZoom=t.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=i,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new pC(i.map),this._pendingGroundEffectLayers=[]}set style(t){t.on("data",this._onStyleDataEvent.bind(this)),this._style=t,this._style.map.on("moveend",()=>{this._clearLineLayersFromRenderCache()})}update(t,i,n){if(t&&t.terrain){this._style!==t&&(this.style=t,this._evaluationZoom=void 0);const r=t.terrain.properties,o=t.terrain.drapeRenderMode===0,s=t.terrain.isZoomDependent();this._previousUpdateTimestamp=this.enabled?this._updateTimestamp:void 0,this._updateTimestamp=ke.now();const a=t.terrain&&t.terrain.scope,l=r.get("source"),c=o?this._mockSourceCache:t.getSourceCache(l,a);if(!c)return void J(`Couldn't find terrain source "${l}".`);if(this.sourceCache=c,this._exaggeration=s?this.calculateExaggeration(i):r.get("exaggeration"),!i.projection.requiresDraping&&s&&this._exaggeration===0)return void this._disable();this.enabled=!0;const u=()=>{this.sourceCache.used&&J(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.
This leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);const h=this.getScaledDemTileSize();this.sourceCache.update(i,h,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,u(),this._initializing=!0),u(),i.updateElevation(!0,n),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(i),this._emptyDEMTextureDirty=!0,this._previousZoom=i.zoom}else this._disable()}calculateExaggeration(t){const i=this._previousCameraAltitude,n=t.getFreeCameraOptions().position.z/t.pixelsPerMeter*t.worldSize;this._previousCameraAltitude=n;const r=i!=null?n-i:Number.MAX_VALUE;if(Math.abs(r)<2)return this._exaggeration;const o=t.zoom,s=this._style.terrain;if(!this._previousUpdateTimestamp)return s.getExaggeration(o);let a=o-this._previousZoom;const l=this._previousUpdateTimestamp;let c=o;this._evaluationZoom!=null&&(c=this._evaluationZoom,Math.abs(o-c)>.5&&(a=.5*(o-c+a)),a*r<0&&(c+=a)),this._evaluationZoom=c;const u=s.getExaggeration(c),h=u===s.getExaggeration(Math.max(0,c-.1));if(h&&Math.abs(u-this._exaggeration)<.01)return u;let d=Math.min(.1,.00375*(this._updateTimestamp-l));return(h||u<.1||Math.abs(a)<1e-4)&&(d=Math.min(.2,4*d)),ze(this._exaggeration,u,d)}resetTileLookupCache(t){this._findCoveringTileCache[t]={}}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_onStyleDataEvent(t){t.coord&&t.dataType==="source"?this._clearRenderCacheForTile(t.sourceCacheId,t.coord):t.dataType==="style"&&(this.invalidateRenderCache=!0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this._previousCameraAltitude=void 0)}_disable(){if(this.enabled&&(this.enabled=!1,this._sharedDepthStencil=void 0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(const t in this._style._mergedSourceCaches)this._style._mergedSourceCaches[t].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this._emptyDepthBufferTexture&&this._emptyDepthBufferTexture.destroy(),this.pool.forEach(t=>t.fb.destroy()),this.pool=[],this._depthFBO&&(this._depthFBO.destroy(),this._depthFBO=void 0,this._depthTexture=void 0),this.framebufferCopyTexture&&this.framebufferCopyTexture.destroy()}_source(){return this.enabled?this.sourceCache:null}isUsingMockSource(){return this.sourceCache===this._mockSourceCache}exaggeration(){return this._exaggeration}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){const t=2*this.proxySourceCache.getSource().tileSize;return[t,t]}set useVertexMorphing(t){this._useVertexMorphing=t}updateTileBinding(t){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;const i=this.proxySourceCache,n=this.painter.transform;this._initializing&&(this._initializing=n._centerAltitude===0&&this.getAtPointOrZero(ui.fromLngLat(n.center),-1)===-1,this._emptyDEMTextureDirty=!this._initializing);const r=this.proxyCoords=i.getIds().map(l=>{const c=i.getTileByID(l).tileID;return c.projMatrix=n.calculateProjMatrix(c.toUnwrapped()),c});(function(l,c){const u=c.transform.pointCoordinate(c.transform.getCameraPoint()),h=new G(u.x,u.y);l.sort((d,p)=>{if(p.overscaledZ-d.overscaledZ)return p.overscaledZ-d.overscaledZ;const _=new G(d.canonical.x+(1<<d.canonical.z)*d.wrap,d.canonical.y),g=new G(p.canonical.x+(1<<p.canonical.z)*p.wrap,p.canonical.y),y=h.mult(1<<d.canonical.z);return y.x-=.5,y.y-=.5,y.distSqr(_)-y.distSqr(g)})})(r,this.painter);const o=this.proxyToSource||{};this.proxyToSource={},r.forEach(l=>{this.proxyToSource[l.key]={}}),this.terrainTileForTile={};const s=this._style._mergedSourceCaches;for(const l in s){const c=s[l];if(!c.used||(c!==this.sourceCache&&this.resetTileLookupCache(c.id),this._setupProxiedCoordsForOrtho(c,t[l],o),c.usedForTerrain))continue;const u=t[l];c.getSource().reparseOverscaled&&this._assignTerrainTiles(u)}this.proxiedCoords[i.id]=r.map(l=>new dw(l,l.key,this.orthoMatrix)),this._assignTerrainTiles(r),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(o),this.renderingToTexture=!1;const a={};this._visibleDemTiles=[];for(const l of this.proxyCoords){const c=this.terrainTileForTile[l.key];if(!c)continue;const u=c.tileID.key;u in a||(this._visibleDemTiles.push(c),a[u]=u)}}_assignTerrainTiles(t){this._initializing||t.forEach(i=>{if(this.terrainTileForTile[i.key])return;const n=this._findTileCoveringTileID(i,this.sourceCache);n&&(this.terrainTileForTile[i.key]=n)})}_prepareDEMTextures(){const t=this.painter.context,i=t.gl;for(const n in this.terrainTileForTile){const r=this.terrainTileForTile[n],o=r.dem;!o||r.demTexture&&!r.needsDEMTextureUpload||(t.activeTexture.set(i.TEXTURE1),rw(this.painter,r,o))}}_prepareDemTileUniforms(t,i,n,r){if(!i||i.demTexture==null)return!1;const o=t.tileID.canonical,s=Math.pow(2,i.tileID.canonical.z-o.z),a=r||"";return n[`u_dem_tl${a}`]=[o.x*s%1,o.y*s%1],n[`u_dem_scale${a}`]=s,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}get emptyDepthBufferTexture(){const t=this.painter.context,i=t.gl;if(!this._emptyDepthBufferTexture){const n=new Ln({width:1,height:1},Uint8Array.of(255,255,255,255));this._emptyDepthBufferTexture=new mn(t,n,i.RGBA,{premultiply:!1})}return this._emptyDepthBufferTexture}_getLoadedAreaMinimum(){let t=0;const i=this._visibleDemTiles.reduce((n,r)=>{if(!r.dem)return n;const o=r.dem.tree.minimums[0];return o>0&&t++,n+o},0);return t?i/t:0}_updateEmptyDEMTexture(){const t=this.painter.context,i=t.gl;t.activeTexture.set(i.TEXTURE2);const n=this._getLoadedAreaMinimum(),[r,o]=(()=>{const a=new nv({width:1,height:1},new Float32Array([n]));return[i.R32F,a]})();this._emptyDEMTextureDirty=!1;let s=this._emptyDEMTexture;return s?s.update(o,{premultiply:!1}):s=this._emptyDEMTexture=new mn(t,o,r,{premultiply:!1}),s}setupElevationDraw(t,i,n){const r=this.painter.context,o=r.gl,s={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_exaggeration:0};s.u_exaggeration=this.exaggeration();let a=null,l=null,c=1;if(n&&n.morphing&&this._useVertexMorphing){const d=n.morphing.srcDemTile,p=n.morphing.dstDemTile;c=n.morphing.phase,d&&p&&(this._prepareDemTileUniforms(t,d,s,"_prev")&&(l=d),this._prepareDemTileUniforms(t,p,s)&&(a=p))}const u=d=>d&&d.demTexture&&this.painter.linearFloatFilteringSupported()?o.LINEAR:o.NEAREST,h=d=>{s.u_dem_size=d.size[0]===1?1:d.size[0]-2};if(l&&a)r.activeTexture.set(o.TEXTURE2),a.demTexture.bind(u(a),o.CLAMP_TO_EDGE),r.activeTexture.set(o.TEXTURE4),l.demTexture.bind(u(l),o.CLAMP_TO_EDGE),a.demTexture&&h(a.demTexture),s.u_dem_lerp=c;else{a=this.terrainTileForTile[t.tileID.key],r.activeTexture.set(o.TEXTURE2);const d=this._prepareDemTileUniforms(t,a,s)?a.demTexture:this.emptyDEMTexture;d.bind(u(a),o.CLAMP_TO_EDGE),h(d)}if(r.activeTexture.set(o.TEXTURE3),n&&n.useDepthForOcclusion?(this._depthTexture&&this._depthTexture.bind(o.NEAREST,o.CLAMP_TO_EDGE),this._depthFBO&&(s.u_depth_size_inv=[1/this._depthFBO.width,1/this._depthFBO.height])):(this.emptyDepthBufferTexture.bind(o.NEAREST,o.CLAMP_TO_EDGE),s.u_depth_size_inv=[1,1]),n&&n.useMeterToDem&&a){const d=(1<<a.tileID.canonical.z)*Gi(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;s.u_meter_to_dem=d}if(n&&n.labelPlaneMatrixInv&&(s.u_label_plane_matrix_inv=n.labelPlaneMatrixInv),i.setTerrainUniformValues(r,s),this.painter.transform.projection.name==="globe"){const d=this.globeUniformValues(this.painter.transform,t.tileID.canonical,n&&n.useDenormalizedUpVectorScale);i.setGlobeUniformValues(r,d)}}globeUniformValues(t,i,n){const r=t.projection;return{u_tile_tl_up:r.upVector(i,0,0),u_tile_tr_up:r.upVector(i,pt,0),u_tile_br_up:r.upVector(i,pt,pt),u_tile_bl_up:r.upVector(i,0,pt),u_tile_up_scale:n?dh(1):r.upVectorScale(i,t.center.lat,t.worldSize).metersToTile}}renderToBackBuffer(t){const i=this.painter,n=this.painter.context;t.length!==0&&(n.bindFramebuffer.set(null),n.viewport.set([0,0,i.width,i.height]),i.gpuTimingDeferredRenderStart(),this.renderingToTexture=!1,function(r,o,s,a,l){if(r.transform.projection.name==="globe")(function(c,u,h,d,p){const _=c.context,g=_.gl;let y,x;const b=c.transform,M=R1(c,_,b),E=(H,O)=>{if(x===O)return;const X=[cw[O],"PROJECTION_GLOBE_VIEW"];M&&X.push("CUSTOM_ANTIALIASING");const K=c.isTileAffectedByFog(H);y=c.getOrCreateProgram("globeRaster",{defines:X,overrideFog:K}),x=O},T=c.colorModeForRenderPass(),S=new Ie(g.LEQUAL,Ie.ReadWrite,c.depthRangeFor3D);Vl.update(p);const D=z1(b),z=[Fn(b.center.lng),jn(b.center.lat)],L=c.globeSharedBuffers,R=[b.width*ke.devicePixelRatio,b.height*ke.devicePixelRatio],N=Float32Array.from(b.globeMatrix),U={useDenormalizedUpVectorScale:!0};{const H=c.transform,O=uw(H.zoom,u.exaggeration(),u.sourceCache._source.tileSize);x=-1;const X=g.TRIANGLES;for(const K of d){const ot=h.getTile(K),$=Ke.disabled,Y=u.prevTerrainTileForTile[K.key],at=u.terrainTileForTile[K.key];lw(Y,at)&&Vl.newMorphing(K.key,Y,at,p,250),_.activeTexture.set(g.TEXTURE0),ot.texture&&ot.texture.bind(g.LINEAR,g.CLAMP_TO_EDGE);const ut=Vl.getMorphValuesForProxy(K.key),ct=ut?1:0;ut&&zr(U,{morphing:{srcDemTile:ut.from,dstDemTile:ut.to,phase:Re(ut.phase)}});const bt=fh(K.canonical),Mt=BE(bt.getCenter().lat),Et=O1(K.canonical,bt,Mt,H.worldSize/H._pixelsPerMercatorPixel),ft=js(Fr(K.canonical)),kt=aw(H.expandedFarZProjMatrix,N,D,ft,Wn(H.zoom),z,H.frustumCorners.TL,H.frustumCorners.TR,H.frustumCorners.BR,H.frustumCorners.BL,H.globeCenterInViewSpace,H.globeRadius,R,O,Et);if(E(K,ct),y&&(u.setupElevationDraw(ot,y,U),c.uploadCommonUniforms(_,y,K.toUnwrapped()),L)){const[Qt,te,oe]=L.getGridBuffers(Mt,O!==0);y.draw(c,X,S,$,T,ti.backCCW,kt,"globe_raster",Qt,te,oe)}}}if(L&&(c.renderDefaultNorthPole||c.renderDefaultSouthPole)){const H=["GLOBE_POLES","PROJECTION_GLOBE_VIEW"];M&&H.push("CUSTOM_ANTIALIASING"),y=c.getOrCreateProgram("globeRaster",{defines:H});for(const O of d){const{x:X,y:K,z:ot}=O.canonical,$=K===0,Y=K===(1<<ot)-1,[at,ut,ct,bt]=L.getPoleBuffers(ot,!1);if(bt&&($||Y)){const Mt=h.getTile(O);_.activeTexture.set(g.TEXTURE0),Mt.texture&&Mt.texture.bind(g.LINEAR,g.CLAMP_TO_EDGE);let Et=L1(ot,X,b);const ft=js(Fr(O.canonical)),kt=(Qt,te)=>Qt.draw(c,g.TRIANGLES,S,Ke.disabled,T,ti.disabled,aw(b.expandedFarZProjMatrix,Et,Et,ft,0,z,b.frustumCorners.TL,b.frustumCorners.TR,b.frustumCorners.BR,b.frustumCorners.BL,b.globeCenterInViewSpace,b.globeRadius,R,0),"globe_pole_raster",te,ct,bt);u.setupElevationDraw(Mt,y,U),c.uploadCommonUniforms(_,y,O.toUnwrapped()),$&&c.renderDefaultNorthPole&&kt(y,at),Y&&c.renderDefaultSouthPole&&(Et=st.scale(st.create(),Et,[1,-1,1]),kt(y,ut))}}}})(r,o,s,a,l);else{const c=r.context,u=c.gl;let h,d;const p=r.shadowRenderer,_=Ul(r,r.longestCutoffRange),g=T=>{if(d===T)return;const S=[];S.push(cw[T]),_.shouldRenderCutoff&&S.push("RENDER_CUTOFF"),h=r.getOrCreateProgram("terrainRaster",{defines:S}),d=T},y=r.colorModeForRenderPass(),x=new Ie(u.LEQUAL,Ie.ReadWrite,r.depthRangeFor3D);Vl.update(l);const b=r.transform,M=uw(b.zoom,o.exaggeration(),o.sourceCache._source.tileSize);let E=[0,0,0];if(p){const T=r.style.directionalLight,S=r.style.ambientLight;T&&S&&(E=M_(T,S))}{d=-1;const T=u.TRIANGLES,[S,D]=[o.gridIndexBuffer,o.gridSegments];for(const z of a){const L=s.getTile(z),R=Ke.disabled,N=o.prevTerrainTileForTile[z.key],U=o.terrainTileForTile[z.key];lw(N,U)&&Vl.newMorphing(z.key,N,U,l,250),c.activeTexture.set(u.TEXTURE0),L.texture&&L.texture.bind(u.LINEAR,u.CLAMP_TO_EDGE);const H=Vl.getMorphValuesForProxy(z.key),O=H?1:0;let X;H&&(X={morphing:{srcDemTile:H.from,dstDemTile:H.to,phase:Re(H.phase)}});const K=sw(z.projMatrix,fC(z.canonical,b.renderWorldCopies)?M/10:M,E);if(g(O),!h)continue;o.setupElevationDraw(L,h,X);const ot=z.toUnwrapped();p&&p.setupShadows(ot,h),r.uploadCommonUniforms(c,h,ot,null,_),h.draw(r,T,x,R,y,ti.backCCW,K,"terrain_raster",o.gridBuffer,S,D)}}}}(i,this,this.proxySourceCache,t,this._updateTimestamp),this.renderingToTexture=!0,i.gpuTimingDeferredRenderEnd(),t.splice(0,t.length))}renderBatch(t){if(this._drapedRenderBatches.length===0)return t+1;this.renderingToTexture=!0;const i=this.painter,n=this.painter.context,r=this.proxySourceCache,o=this.proxiedCoords[r.id],s=this._drapedRenderBatches.shift(),a=i.style.order,l=[];let c=0;for(const u of o){const h=r.getTileByID(u.proxyTileKey),d=r.proxyCachedFBO[u.key]?r.proxyCachedFBO[u.key][t]:void 0,p=d!==void 0?r.renderCache[d]:this.pool[c++],_=d!==void 0;if(h.texture=p.tex,_&&!p.dirty){l.push(h.tileID);continue}let g;n.bindFramebuffer.set(p.fb.framebuffer),this.renderedToTile=!1,p.dirty&&(n.clear({color:Ye.transparent,stencil:0}),p.dirty=!1);for(let y=s.start;y<=s.end;++y){const x=i.style._mergedLayers[a[y]];if(x.isHidden(i.transform.zoom))continue;const b=i.style.getLayerSourceCache(x),M=b?this.proxyToSource[u.key][b.id]:[u];if(!M)continue;const E=M;n.viewport.set([0,0,p.fb.width,p.fb.height]),g!==(b?b.id:null)&&(this._setupStencil(p,M,x,b),g=b?b.id:null),i.renderLayer(i,b,x,E)}if(this._drapedRenderBatches.length===0)for(const y of this._pendingGroundEffectLayers){const x=i.style._mergedLayers[a[y]];if(x.isHidden(i.transform.zoom))continue;const b=i.style.getLayerSourceCache(x),M=b?this.proxyToSource[u.key][b.id]:[u];if(!M)continue;const E=M;n.viewport.set([0,0,p.fb.width,p.fb.height]),g!==(b?b.id:null)&&(this._setupStencil(p,M,x,b),g=b?b.id:null),i.renderLayer(i,b,x,E)}this.renderedToTile?(p.dirty=!0,l.push(h.tileID)):_||--c,c===5&&(c=0,this.renderToBackBuffer(l))}return this.renderToBackBuffer(l),this.renderingToTexture=!1,n.bindFramebuffer.set(null),n.viewport.set([0,0,i.width,i.height]),s.end+1}postRender(){}isLayerOrderingCorrect(t){const i=t.order.length;let n=-1,r=i;for(let o=0;o<i;++o)this._style.isLayerDraped(t._mergedLayers[t.order[o]])?n=Math.max(n,o):r=Math.min(r,o);return r>n}getMinElevationBelowMSL(){let t=0;return this._visibleDemTiles.filter(i=>i.dem).forEach(i=>{t=Math.min(t,i.dem.tree.minimums[0])}),t===0?t:(t-30)*this._exaggeration}raycast(t,i,n){if(!this._visibleDemTiles)return null;const r=this._visibleDemTiles.filter(o=>o.dem).map(o=>{const s=o.tileID,a=1<<s.overscaledZ,{x:l,y:c}=s.canonical,u=l/a,h=(l+1)/a,d=c/a,p=(c+1)/a;return{minx:u,miny:d,maxx:h,maxy:p,t:o.dem.tree.raycastRoot(u,d,h,p,t,i,n),tile:o}});r.sort((o,s)=>(o.t!==null?o.t:Number.MAX_VALUE)-(s.t!==null?s.t:Number.MAX_VALUE));for(const o of r){if(o.t==null)return null;const s=o.tile.dem.tree.raycast(o.minx,o.miny,o.maxx,o.maxy,t,i,n);if(s!=null)return s}return null}_createFBO(){const t=this.painter.context,i=t.gl,n=this.drapeBufferSize;t.activeTexture.set(i.TEXTURE0);const r=new mn(t,{width:n[0],height:n[1],data:null},i.RGBA);r.bind(i.LINEAR,i.CLAMP_TO_EDGE);const o=t.createFramebuffer(n[0],n[1],!0,null);return o.colorAttachment.set(r.texture),o.depthAttachment=new T3(t,o.framebuffer),this._sharedDepthStencil===void 0?(this._sharedDepthStencil=t.createRenderbuffer(t.gl.DEPTH_STENCIL,n[0],n[1]),this._stencilRef=0,o.depthAttachment.set(this._sharedDepthStencil),t.clear({stencil:0})):o.depthAttachment.set(this._sharedDepthStencil),t.extTextureFilterAnisotropic&&i.texParameterf(i.TEXTURE_2D,t.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,t.extTextureFilterAnisotropicMax),{fb:o,tex:r,dirty:!1}}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._style.hasLightTransitions())return!0;for(const t in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[t].hasTransition())return!0;return this._style.order.some(t=>{const i=this._style._mergedLayers[t],n=i.isHidden(this.painter.transform.zoom);return i.type==="custom"?!n&&i.shouldRedrape():!n&&i.hasTransition()})}_clearLineLayersFromRenderCache(){let t=!1;for(const n of this._style.getSources())if(n instanceof Tb){t=!0;break}if(!t)return;const i={};for(let n=0;n<this._style.order.length;++n){const r=this._style._mergedLayers[this._style.order[n]],o=this._style.getLayerSourceCache(r);if(o&&!i[o.id]&&!r.isHidden(this.painter.transform.zoom)&&r.type==="line"&&r.widthExpression()instanceof ks){i[o.id]=!0;for(const s of this.proxyCoords){const a=this.proxyToSource[s.key][o.id];if(a)for(const l of a)this._clearRenderCacheForTile(o.id,l)}}}}_clearRasterLayersFromRenderCache(){let t=!1;for(const n in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[n]._source instanceof t_){t=!0;break}if(!t)return;const i={};for(let n=0;n<this._style.order.length;++n){const r=this._style._mergedLayers[this._style.order[n]],o=this._style.getLayerSourceCache(r);if(!o||i[o.id]||r.isHidden(this.painter.transform.zoom)||r.type!=="raster")continue;const s=r.paint.get("raster-fade-duration");for(const a of this.proxyCoords){const l=this.proxyToSource[a.key][o.id];if(l)for(const c of l){const u=hw(o.getTile(c),o.findLoadedParent(c,0),o,this.painter.transform,s);(u.opacity!==1||u.mix!==0)&&this._clearRenderCacheForTile(o.id,c)}}}}_setupDrapedRenderBatches(){const t=this._style.order,i=t.length;if(i===0)return;const n=[];this._pendingGroundEffectLayers=[];let r,o=0,s=this._style._mergedLayers[t[o]];for(;!this._style.isLayerDraped(s)&&s.isHidden(this.painter.transform.zoom)&&++o<i;)s=this._style._mergedLayers[t[o]];for(;o<i;++o){const a=this._style._mergedLayers[t[o]];a.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(a)?r===void 0&&(r=o):(a.type==="fill-extrusion"&&this._pendingGroundEffectLayers.push(o),r!==void 0&&(n.push({start:r,end:o-1}),r=void 0)))}if(r!==void 0&&n.push({start:r,end:o-1}),n.length!==0){const a=n[n.length-1];this._pendingGroundEffectLayers.every(c=>c>a.end)||J("fill-extrusion with flood lighting and/or ground ambient occlusion should be moved to be on top of all draped layers.")}this._drapedRenderBatches=n}_setupRenderCache(t){const i=this.proxySourceCache;if(this._shouldDisableRenderCache()||this.invalidateRenderCache){if(this.invalidateRenderCache=!1,i.renderCache.length>i.renderCachePool.length){const s=Object.values(i.proxyCachedFBO);i.proxyCachedFBO={};for(let a=0;a<s.length;++a){const l=Object.values(s[a]);i.renderCachePool.push(...l)}}return}this._clearRasterLayersFromRenderCache();const n=this.proxyCoords,r=this._tilesDirty;for(let s=n.length-1;s>=0;s--){const a=n[s];if(i.getTileByID(a.key),i.proxyCachedFBO[a.key]!==void 0){const l=t[a.key],c=this.proxyToSource[a.key];let u=0;for(const h in c){const d=c[h],p=l[h];if(!p||p.length!==d.length||d.some((_,g)=>_!==p[g]||r[h]&&r[h].hasOwnProperty(_.key))){u=-1;break}++u}for(const h in i.proxyCachedFBO[a.key])i.renderCache[i.proxyCachedFBO[a.key][h]].dirty=u<0||u!==Object.values(l).length}}const o=[...this._drapedRenderBatches];o.sort((s,a)=>a.end-a.start-(s.end-s.start));for(const s of o)for(const a of n){if(i.proxyCachedFBO[a.key])continue;let l=i.renderCachePool.pop();l===void 0&&i.renderCache.length<50&&(l=i.renderCache.length,i.renderCache.push(this._createFBO())),l!==void 0&&(i.proxyCachedFBO[a.key]={},i.proxyCachedFBO[a.key][s.start]=l,i.renderCache[l].dirty=!0)}this._tilesDirty={}}_setupStencil(t,i,n,r){if(!r||!this._sourceTilesOverlap[r.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));const o=this.painter.context,s=o.gl;if(i.length<=1)return void(this._overlapStencilType=!1);let a;if(n.isTileClipped())a=i.length,this._overlapStencilMode.test={func:s.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(i[0].overscaledZ>i[i.length-1].overscaledZ))return void(this._overlapStencilType=!1);a=1,this._overlapStencilMode.test={func:s.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+a>255&&(o.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=a,this._overlapStencilMode.ref=this._stencilRef,n.isTileClipped()&&this._renderTileClippingMasks(i,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return this._overlapStencilType==="Clip"||this._overlapStencilType==="Mask"}stencilModeForRTTOverlap(t){return this.renderingToTexture&&this._overlapStencilType?(this._overlapStencilType==="Clip"&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[t.key]),this._overlapStencilMode):Ke.disabled}_renderTileClippingMasks(t,i){const n=this.painter,r=this.painter.context,o=r.gl;n._tileClippingMaskIDs={},r.setColorMode(Ti.disabled),r.setDepthMode(Ie.disabled);const s=n.getOrCreateProgram("clippingMask");for(const a of t){const l=n._tileClippingMaskIDs[a.key]=--i;s.draw(n,o.TRIANGLES,Ie.disabled,new Ke({func:o.ALWAYS,mask:0},l,255,o.KEEP,o.KEEP,o.REPLACE),Ti.disabled,ti.disabled,v_(a.projMatrix),"$clipping",n.tileExtentBuffer,n.quadTriangleIndexBuffer,n.tileExtentSegments)}}pointCoordinate(t){const i=this.painter.transform;if(t.x<0||t.x>i.width||t.y<0||t.y>i.height)return null;const n=[t.x,t.y,1,1];Ni.transformMat4(n,n,i.pixelMatrixInverse),Ni.scale(n,n,1/n[3]),n[0]/=i.worldSize,n[1]/=i.worldSize;const r=i._camera.position,o=Gi(1,i.center.lat),s=[r[0],r[1],r[2]/o,0],a=Z.subtract([],n.slice(0,3),s);Z.normalize(a,a);const l=this.raycast(s,a,this._exaggeration);return l!==null&&l?(Z.scaleAndAdd(s,s,a,l),s[3]=s[2],s[2]*=o,s):null}drawDepth(){const t=this.painter,i=t.context,n=this.proxySourceCache,r=Math.ceil(t.width),o=Math.ceil(t.height);if(!this._depthFBO||this._depthFBO.width===r&&this._depthFBO.height===o||(this._depthFBO.destroy(),this._depthFBO=void 0,this._depthTexture=void 0),!this._depthFBO){const s=i.gl,a=i.createFramebuffer(r,o,!0,"renderbuffer");i.activeTexture.set(s.TEXTURE0);const l=new mn(i,{width:r,height:o,data:null},s.RGBA);l.bind(s.NEAREST,s.CLAMP_TO_EDGE),a.colorAttachment.set(l.texture);const c=i.createRenderbuffer(i.gl.DEPTH_COMPONENT16,r,o);a.depthAttachment.set(c),this._depthFBO=a,this._depthTexture=l}i.bindFramebuffer.set(this._depthFBO.framebuffer),i.viewport.set([0,0,r,o]),function(s,a,l,c){if(s.transform.projection.name==="globe")return;const u=s.context,h=u.gl;u.clear({depth:1});const d=s.getOrCreateProgram("terrainDepth"),p=new Ie(h.LESS,Ie.ReadWrite,s.depthRangeFor3D);for(const _ of c){const g=l.getTile(_),y=sw(_.projMatrix,0,[0,0,0]);a.setupElevationDraw(g,d),d.draw(s,h.TRIANGLES,p,Ke.disabled,Ti.unblended,ti.backCCW,y,"terrain_depth",a.gridBuffer,a.gridIndexBuffer,a.gridNoSkirtSegments)}}(t,this,n,this.proxyCoords)}_setupProxiedCoordsForOrtho(t,i,n){if(t.getSource()instanceof to)return this._setupProxiedCoordsForImageSource(t,i,n);this._findCoveringTileCache[t.id]=this._findCoveringTileCache[t.id]||{};const r=this.proxiedCoords[t.id]=[],o=this.proxyCoords;for(let a=0;a<o.length;a++){const l=o[a],c=this._findTileCoveringTileID(l,t);if(c){const u=this._createProxiedId(l,c,n[l.key]&&n[l.key][t.id]);r.push(u),this.proxyToSource[l.key][t.id]=[u]}}let s=!1;for(let a=0;a<i.length;a++){const l=t.getTile(i[a]);if(!l||!l.hasData())continue;const c=this._findTileCoveringTileID(l.tileID,this.proxySourceCache);if(c&&c.tileID.canonical.z!==l.tileID.canonical.z){const u=this.proxyToSource[c.tileID.key][t.id],h=this._createProxiedId(c.tileID,l,n[c.tileID.key]&&n[c.tileID.key][t.id]);u?u.splice(u.length-1,0,h):this.proxyToSource[c.tileID.key][t.id]=[h],r.push(h),s=!0}}this._sourceTilesOverlap[t.id]=s}_setupProxiedCoordsForImageSource(t,i,n){if(!t.getSource().loaded())return;const r=this.proxiedCoords[t.id]=[],o=this.proxyCoords,s=t.getSource(),a=s.tileID;if(!a)return;const l=new G(a.x,a.y)._div(1<<a.z),c=s.coordinates.map(ui.fromLngLat).reduce((h,d)=>(h.min.x=Math.min(h.min.x,d.x-l.x),h.min.y=Math.min(h.min.y,d.y-l.y),h.max.x=Math.max(h.max.x,d.x-l.x),h.max.y=Math.max(h.max.y,d.y-l.y),h),{min:new G(Number.MAX_VALUE,Number.MAX_VALUE),max:new G(-Number.MAX_VALUE,-Number.MAX_VALUE)}),u=(h,d)=>{const p=h.wrap+h.canonical.x/(1<<h.canonical.z),_=h.canonical.y/(1<<h.canonical.z),g=pt/(1<<h.canonical.z),y=d.wrap+d.canonical.x/(1<<d.canonical.z),x=d.canonical.y/(1<<d.canonical.z);return p+g<y+c.min.x||p>y+c.max.x||_+g<x+c.min.y||_>x+c.max.y};for(let h=0;h<o.length;h++){const d=o[h];for(let p=0;p<i.length;p++){const _=t.getTile(i[p]);if(!_||!_.hasData()||u(d,_.tileID))continue;const g=this._createProxiedId(d,_,n[d.key]&&n[d.key][t.id]),y=this.proxyToSource[d.key][t.id];y?y.push(g):this.proxyToSource[d.key][t.id]=[g],r.push(g)}}}_createProxiedId(t,i,n){let r=this.orthoMatrix;if(n){const o=n.find(s=>s.key===i.tileID.key);if(o)return o}if(i.tileID.key!==t.key){const o=t.canonical.z-i.tileID.canonical.z;let s,a,l;r=st.create();const c=i.tileID.wrap-t.wrap<<t.overscaledZ;o>0?(s=pt>>o,a=s*((i.tileID.canonical.x<<o)-t.canonical.x+c),l=s*((i.tileID.canonical.y<<o)-t.canonical.y)):(s=pt<<-o,a=pt*(i.tileID.canonical.x-(t.canonical.x+c<<-o)),l=pt*(i.tileID.canonical.y-(t.canonical.y<<-o))),st.ortho(r,0,s,0,s,0,1),st.translate(r,r,[a,l,0])}return new dw(i.tileID,t.key,r)}_findTileCoveringTileID(t,i){let n=i.getTile(t);if(n&&n.hasData())return n;const r=this._findCoveringTileCache[i.id],o=r[t.key];if(n=o?i.getTileByID(o):null,n&&n.hasData()||o===null)return n;let s=n?n.tileID:t,a=s.overscaledZ;const l=i.getSource().minzoom,c=[];if(!o){const h=i.getSource().maxzoom;if(t.canonical.z>=h){const d=t.canonical.z-h;i.getSource().reparseOverscaled?(a=Math.max(t.canonical.z+2,i.transform.tileZoom),s=new Si(a,t.wrap,h,t.canonical.x>>d,t.canonical.y>>d)):d!==0&&(a=h,s=new Si(a,t.wrap,h,t.canonical.x>>d,t.canonical.y>>d))}s.key!==t.key&&(c.push(s.key),n=i.getTile(s))}const u=h=>{c.forEach(d=>{r[d]=h}),c.length=0};for(a-=1;a>=l&&(!n||!n.hasData());a--){n&&u(n.tileID.key);const h=s.calculateScaledKey(a);if(n=i.getTileByID(h),n&&n.hasData())break;const d=r[h];if(d===null)break;d===void 0?c.push(h):n=i.getTileByID(d)}return u(n?n.tileID.key:null),n&&n.hasData()?n:null}findDEMTileFor(t){return this.enabled?this._findTileCoveringTileID(t,this.sourceCache):null}prepareDrawTile(){this.renderedToTile=!0}_clearRenderCacheForTile(t,i){let n=this._tilesDirty[t];n||(n=this._tilesDirty[t]={}),n[i.key]=!0}}function gC(e,t,i){const n=function(a,l,c){const u=Z.dot(l,a),h=Z.dot(c,[.2126,.7152,.0722]),d=(_,g,y)=>(1-y)*_+y*g,p=d(1-.3*Math.min(h,1),1,Math.min(u+1,1));return d(.92,1,Math.asin(Lt(l[2],-1,1))/Math.PI+.5)*p}(e,[0,0,1],t),r=[0,0,0];Z.scale(r,i.slice(0,3),n);const o=[0,0,0];Z.scale(o,t.slice(0,3),e[2]);const s=[0,0,0];return Z.add(s,r,o),Vi(s)}const yC=["fill","fillOutline","fillPattern","line","linePattern","background","backgroundPattern","hillshade","raster"],vC=["stars","fillExtrusion","fillExtrusionGroundEffect","model","symbolSDF","symbolIcon","symbolTextAndIcon"];class fw{static cacheKey(t,i,n,r){let o=`${i}${r?r.cacheKey:""}`;for(const s of n)t.usedDefines.includes(s)&&(o+=`/${s}`);return o}constructor(t,i,n,r,o,s){const a=t.gl;this.program=a.createProgram(),this.configuration=r,this.name=i,this.fixedDefines=[...s];const l=r?r.getBinderAttributes():[],c=(n.staticAttributes||[]).concat(l);let u=r?r.defines():[];u=u.concat(s.map(y=>`#define ${y}`));const h=`#version 300 es
`;let d=h+u.concat("precision mediump float;",iw,ew.fragmentSource).join(`
`);for(const y of n.fragmentIncludes)d+=`
${gd[y]}`;d+=`
${n.fragmentSource}`;let p=h+u.concat("precision highp float;",iw,ew.vertexSource).join(`
`);for(const y of n.vertexIncludes)p+=`
${gd[y]}`;p+=`
${n.vertexSource}`;const _=a.createShader(a.FRAGMENT_SHADER);if(a.isContextLost())return void(this.failedToCreate=!0);a.shaderSource(_,d),a.compileShader(_),a.attachShader(this.program,_);const g=a.createShader(a.VERTEX_SHADER);if(a.isContextLost())this.failedToCreate=!0;else{a.shaderSource(g,p),a.compileShader(g),a.attachShader(this.program,g),this.attributes={},this.numAttributes=c.length;for(let y=0;y<this.numAttributes;y++)if(c[y]){const x=c[y].startsWith("a_")?c[y]:`a_${c[y]}`;a.bindAttribLocation(this.program,y,x),this.attributes[x]=y}a.linkProgram(this.program),a.deleteShader(g),a.deleteShader(_),this.fixedUniforms=o(t),this.binderUniforms=r?r.getUniforms(t):[],s.includes("TERRAIN")&&(this.terrainUniforms=(y=>({u_dem:new ei(y),u_dem_prev:new ei(y),u_dem_tl:new ii(y),u_dem_scale:new Nt(y),u_dem_tl_prev:new ii(y),u_dem_scale_prev:new Nt(y),u_dem_size:new Nt(y),u_dem_lerp:new Nt(y),u_exaggeration:new Nt(y),u_depth:new ei(y),u_depth_size_inv:new ii(y),u_meter_to_dem:new Nt(y),u_label_plane_matrix_inv:new Ne(y)}))(t)),s.includes("GLOBE")&&(this.globeUniforms=(y=>({u_tile_tl_up:new je(y),u_tile_tr_up:new je(y),u_tile_br_up:new je(y),u_tile_bl_up:new je(y),u_tile_up_scale:new Nt(y)}))(t)),s.includes("FOG")&&(this.fogUniforms=(y=>({u_fog_matrix:new Ne(y),u_fog_range:new ii(y),u_fog_color:new Mr(y),u_fog_horizon_blend:new Nt(y),u_fog_vertical_limit:new ii(y),u_fog_temporal_offset:new Nt(y),u_frustum_tl:new je(y),u_frustum_tr:new je(y),u_frustum_br:new je(y),u_frustum_bl:new je(y),u_globe_pos:new je(y),u_globe_radius:new Nt(y),u_globe_transition:new Nt(y),u_is_globe:new ei(y),u_viewport:new ii(y)}))(t)),s.includes("RENDER_CUTOFF")&&(this.cutoffUniforms=(y=>({u_cutoff_params:new Mr(y)}))(t)),s.includes("LIGHTING_3D_MODE")&&(this.lightsUniforms=(y=>({u_lighting_ambient_color:new je(y),u_lighting_directional_dir:new je(y),u_lighting_directional_color:new je(y),u_ground_radiance:new je(y)}))(t)),s.includes("RENDER_SHADOWS")&&(this.shadowUniforms=(y=>({u_light_matrix_0:new Ne(y),u_light_matrix_1:new Ne(y),u_fade_range:new ii(y),u_shadow_normal_offset:new je(y),u_shadow_intensity:new Nt(y),u_shadow_texel_size:new Nt(y),u_shadow_map_resolution:new Nt(y),u_shadow_direction:new je(y),u_shadow_bias:new je(y),u_shadowmap_0:new ei(y),u_shadowmap_1:new ei(y)}))(t))}}setTerrainUniformValues(t,i){if(!this.terrainUniforms)return;const n=this.terrainUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const r in i)n[r]&&n[r].set(this.program,r,i[r])}}setGlobeUniformValues(t,i){if(!this.globeUniforms)return;const n=this.globeUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const r in i)n[r]&&n[r].set(this.program,r,i[r])}}setFogUniformValues(t,i){if(!this.fogUniforms)return;const n=this.fogUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const r in i)n[r].set(this.program,r,i[r])}}setCutoffUniformValues(t,i){if(!this.cutoffUniforms)return;const n=this.cutoffUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const r in i)n[r].set(this.program,r,i[r])}}setLightsUniformValues(t,i){if(!this.lightsUniforms)return;const n=this.lightsUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const r in i)n[r].set(this.program,r,i[r])}}setShadowUniformValues(t,i){if(this.failedToCreate||!this.shadowUniforms)return;const n=this.shadowUniforms;t.program.set(this.program);for(const r in i)n[r].set(this.program,r,i[r])}_drawDebugWireframe(t,i,n,r,o,s,a,l,c,u){const h=t.options.wireframe;if(h.terrain===!1&&h.layers2D===!1&&h.layers3D===!1)return;const d=t.context;if(!(()=>!(!h.terrain||this.name!=="terrainRaster"&&this.name!=="globeRaster")||!(!h.layers2D||t._terrain&&t._terrain.renderingToTexture||!yC.includes(this.name))||!(!h.layers3D||!vC.includes(this.name)))())return;const p=d.gl,_=t.wireframeDebugCache.getLinesFromTrianglesBuffer(t.frameCounter,o,d);if(!_)return;const g=[...this.fixedDefines];g.push("DEBUG_WIREFRAME");const y=t.getOrCreateProgram(this.name,{config:this.configuration,defines:g});d.program.set(y.program);const x=(E,T,S)=>{if(T[E]&&S[E])for(const D in T[E])S[E][D]&&S[E][D].set(S.program,D,T[E][D].current)};c&&c.setUniforms(y.program,d,y.binderUniforms,a,{zoom:l}),x("fixedUniforms",this,y),x("terrainUniforms",this,y),x("globeUniforms",this,y),x("fogUniforms",this,y),x("lightsUniforms",this,y),x("shadowUniforms",this,y),_.bind(),d.setColorMode(new Ti([p.ONE,p.ONE_MINUS_SRC_ALPHA,p.ZERO,p.ONE],Ye.transparent,[!0,!0,!0,!1])),d.setDepthMode(new Ie(i.func===p.LESS?p.LEQUAL:i.func,Ie.ReadOnly,i.range)),d.setStencilMode(Ke.disabled);const b=3*s.primitiveLength*2,M=3*s.primitiveOffset*2*2;u&&u>1?p.drawElementsInstanced(p.LINES,b,p.UNSIGNED_SHORT,M,u):p.drawElements(p.LINES,b,p.UNSIGNED_SHORT,M),o.bind(),d.program.set(this.program),d.setDepthMode(i),d.setStencilMode(n),d.setColorMode(r)}draw(t,i,n,r,o,s,a,l,c,u,h,d,p,_,g,y){const x=t.context,b=x.gl;if(this.failedToCreate)return;x.program.set(this.program),x.setDepthMode(n),x.setStencilMode(r),x.setColorMode(o),x.setCullFace(s);for(const T of Object.keys(this.fixedUniforms))this.fixedUniforms[T].set(this.program,T,a[T]);_&&_.setUniforms(this.program,x,this.binderUniforms,d,{zoom:p});const M={[b.LINES]:2,[b.TRIANGLES]:3,[b.LINE_STRIP]:1}[i],E=y&&y>0?1:void 0;for(const T of h.get()){const S=T.vaos||(T.vaos={});(S[l]||(S[l]=new cC)).bind(x,this,c,_?_.getPaintVertexBuffers():[],u,T.vertexOffset,g||[],E),y&&y>1?b.drawElementsInstanced(i,T.primitiveLength*M,b.UNSIGNED_SHORT,T.primitiveOffset*M*2,y):b.drawElements(i,T.primitiveLength*M,b.UNSIGNED_SHORT,T.primitiveOffset*M*2),i===b.TRIANGLES&&this._drawDebugWireframe(t,n,r,o,u,T,d,p,_,y)}}}function pw(e,t){const i=Math.pow(2,t.tileID.overscaledZ),n=t.tileSize*Math.pow(2,e.transform.tileZoom)/i,r=n*(t.tileID.canonical.x+t.tileID.wrap*i),o=n*t.tileID.canonical.y;return{u_image:0,u_texsize:t.imageAtlasTexture?t.imageAtlasTexture.size:[0,0],u_tile_units_to_pixels:1/za(t,1,e.transform.tileZoom),u_pixel_coord_upper:[r>>16,o>>16],u_pixel_coord_lower:[65535&r,65535&o]}}const xC=st.create(),mw=(e,t,i,n,r,o,s,a,l,c,u,h,d,p,_,g)=>{const y=t.style.light,x=y.properties.get("position"),b=[x.x,x.y,x.z],M=_r.create();y.properties.get("anchor")==="viewport"&&(_r.fromRotation(M,-t.transform.angle),Z.transformMat3(b,b,M));const E=y.properties.get("color"),T=t.transform,S={u_matrix:e,u_lightpos:b,u_lightintensity:y.properties.get("intensity"),u_lightcolor:[E.r,E.g,E.b],u_vertical_gradient:+i,u_opacity:n,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:xC,u_merc_center:[0,0],u_up_dir:[0,0,0],u_height_lift:0,u_ao:r,u_edge_radius:o,u_flood_light_color:h,u_vertical_scale:d,u_flood_light_intensity:p,u_ground_shadow_factor:_,u_emissive_strength:g};return T.projection.name==="globe"&&(S.u_tile_id=[s.canonical.x,s.canonical.y,1<<s.canonical.z],S.u_zoom_transition=l,S.u_inv_rot_matrix=u,S.u_merc_center=c,S.u_up_dir=T.projection.upVector(new Yr(0,0,0),c[0]*pt,c[1]*pt),S.u_height_lift=a),S},bC=(e,t,i)=>({u_matrix:e,u_edge_radius:t,u_vertical_scale:i}),wC=(e,t,i,n,r,o,s,a,l,c,u,h,d,p)=>{const _=mw(e,t,i,n,r,o,s,l,c,u,h,d,p,1,[0,0,0],0),g={u_height_factor:-Math.pow(2,s.overscaledZ)/a.tileSize/8};return Vt(_,pw(t,a),g)},_w=(e,t)=>({u_matrix:e,u_emissive_strength:t}),gw=(e,t,i,n)=>Vt(_w(e,t),pw(i,n)),TC=(e,t,i)=>({u_matrix:e,u_world:i,u_emissive_strength:t}),MC=(e,t,i,n,r)=>Vt(gw(e,t,i,n),{u_world:r}),EC=(e,t,i,n)=>{const r=pt/i.tileSize;return{u_matrix:e,u_camera_to_center_distance:t.getCameraToCenterDistance(n),u_extrude_scale:[t.pixelsToGLUnits[0]/r,t.pixelsToGLUnits[1]/r]}},yw=(e,t,i=1)=>({u_matrix:e,u_color:t,u_overlay:0,u_overlay_scale:i}),SC=st.create(),AC=(e,t,i,n,r,o,s)=>{const a=e.transform,l=a.projection.name==="globe",c=l?P1(a.zoom,t.canonical)*a._pixelsPerMercatorPixel:za(i,1,o),u={u_matrix:t.projMatrix,u_extrude_scale:c,u_intensity:s,u_inv_rot_matrix:SC,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};if(l){u.u_inv_rot_matrix=n,u.u_merc_center=r,u.u_tile_id=[t.canonical.x,t.canonical.y,1<<t.canonical.z],u.u_zoom_transition=Wn(a.zoom);const h=r[0]*pt,d=r[1]*pt;u.u_up_dir=a.projection.upVector(new Yr(0,0,0),h,d)}return u},vw=(e,t,i,n,r,o,s,a,l,c,u,h,d,p,_,g,y,x,b,M,E,T)=>{return{u_matrix:e,u_normalize_matrix:t,u_globe_matrix:i,u_merc_matrix:n,u_grid_matrix:r,u_tl_parent:o,u_scale_parent:u,u_fade_t:h.mix,u_opacity:h.opacity*d.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:d.paint.get("raster-brightness-min"),u_brightness_high:d.paint.get("raster-brightness-max"),u_saturation_factor:(D=d.paint.get("raster-saturation"),D>0?1-1/(1.001-D):-D),u_contrast_factor:(S=d.paint.get("raster-contrast"),S>0?1/(1-S):1+S),u_spin_weights:IC(d.paint.get("raster-hue-rotate")),u_perspective_transform:p,u_raster_elevation:_,u_tl_br:s,u_zoom_transition:a,u_merc_center:l,u_cutoff_params:c,u_colorization_mix:CC(y,b),u_colorization_offset:DC(x,b),u_color_ramp:g,u_texture_offset:[E/(M+2*E),M/(M+2*E)],u_texture_res:[M+2*E,M+2*E],u_emissive_strength:T};var S,D};function IC(e){e*=Math.PI/180;const t=Math.sin(e),i=Math.cos(e);return[(2*i+1)/3,(-Math.sqrt(3)*t-i+1)/3,(Math.sqrt(3)*t-i+1)/3]}function CC([e,t,i,n],[r,o]){if(r===o)return[0,0,0,0];const s=259/257/(o-r);return[e*s,t*s,i*s,n*s]}function DC(e,[t,i]){return t===i?0:((e-t)/(i-t)*259-1)/257}const xw=st.create(),bw=(e,t,i,n,r,o,s,a,l,c,u,h,d,p,_,g,y,x)=>{const b=r.transform,M={u_is_size_zoom_constant:+(e==="constant"||e==="source"),u_is_size_feature_constant:+(e==="constant"||e==="camera"),u_size_t:t?t.uSizeT:0,u_size:t?t.uSize:0,u_camera_to_center_distance:b.getCameraToCenterDistance(g),u_rotate_symbol:+i,u_aspect_ratio:b.width/b.height,u_fade_change:r.options.fadeDuration?r.symbolFadeChange:1,u_matrix:o,u_label_plane_matrix:s,u_coord_matrix:a,u_is_text:+l,u_pitch_with_map:+n,u_texsize:c,u_texture:0,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:xw,u_merc_center:[0,0],u_camera_forward:[0,0,0],u_ecef_origin:[0,0,0],u_tile_matrix:xw,u_up_vector:[0,-1,0],u_icon_transition:x||0,u_icon_saturation:y};return g.name==="globe"&&(M.u_tile_id=[u.canonical.x,u.canonical.y,1<<u.canonical.z],M.u_zoom_transition=h,M.u_inv_rot_matrix=p,M.u_merc_center=d,M.u_camera_forward=b._camera.forward(),M.u_ecef_origin=function(E,T){const S=[0,0,0],D=js(Fr(T.canonical));return Z.transformMat4(S,S,D),Z.transformMat4(S,S,E),S}(b.globeMatrix,u.toUnwrapped()),M.u_tile_matrix=Float32Array.from(b.globeMatrix),M.u_up_vector=_),M},ww=(e,t,i,n,r,o,s,a,l,c,u,h,d,p,_,g,y)=>Vt(bw(e,t,i,n,r,o,s,a,l,c,h,d,p,_,g,y,1),{u_gamma_scale:n?r.transform.getCameraToCenterDistance(y)*Math.cos(r.terrain?0:r.transform._pitch):1,u_device_pixel_ratio:ke.devicePixelRatio,u_is_halo:+u,undefined:void 0}),PC=(e,t,i,n,r,o,s,a,l,c,u,h,d,p,_,g)=>Vt(ww(e,t,i,n,r,o,s,a,!0,l,!0,u,h,d,p,_,g),{u_texsize_icon:c,u_texture_icon:1}),kC=(e,t,i,n)=>({u_matrix:e,u_emissive_strength:t,u_opacity:i,u_color:n}),zC=(e,t,i,n,r,o,s)=>Vt(function(a,l,c,u){const h=c.imageManager.getPattern(a.toString(),l),{width:d,height:p}=c.imageManager.getPixelSize(l),_=Math.pow(2,u.tileID.overscaledZ),g=u.tileSize*Math.pow(2,c.transform.tileZoom)/_,y=g*(u.tileID.canonical.x+u.tileID.wrap*_),x=g*u.tileID.canonical.y;return{u_image:0,u_pattern_tl:h.tl,u_pattern_br:h.br,u_texsize:[d,p],u_pattern_size:h.displaySize,u_tile_units_to_pixels:1/za(u,1,c.transform.tileZoom),u_pixel_coord_upper:[y>>16,x>>16],u_pixel_coord_lower:[65535&y,65535&x]}}(r,o,n,s),{u_matrix:e,u_emissive_strength:t,u_opacity:i}),Ir={BaseColor:5,MetallicRoughness:6,Normal:7,Occlusion:8,Emission:9,ShadowMap0:10},x_=(e,t,i,n,r,o,s,a,l,c,u,h,d=[0,0,0])=>{const p=n.style.light,_=p.properties.get("position"),g=[-_.x,-_.y,_.z],y=_r.create();p.properties.get("anchor")==="viewport"&&(_r.fromRotation(y,-n.transform.angle),Z.transformMat3(g,g,y));const x=c.alphaMode==="MASK",b=p.properties.get("color"),M=h.paint.get("model-ambient-occlusion-intensity"),E=h.paint.get("model-color").constantOr(Ye.white),T=h.paint.get("model-color-mix-intensity").constantOr(0);return{u_matrix:e,u_lighting_matrix:t,u_normal_matrix:i,u_lightpos:g,u_lightintensity:p.properties.get("intensity"),u_lightcolor:[b.r,b.g,b.b],u_camera_pos:d,u_opacity:r,u_baseTextureIsAlpha:0,u_alphaMask:+x,u_alphaCutoff:c.alphaCutoff,u_baseColorFactor:[o.r,o.g,o.b,o.a],u_emissiveFactor:[s[0],s[1],s[2],1],u_metallicFactor:a,u_roughnessFactor:l,u_baseColorTexture:Ir.BaseColor,u_metallicRoughnessTexture:Ir.MetallicRoughness,u_normalTexture:Ir.Normal,u_occlusionTexture:Ir.Occlusion,u_emissionTexture:Ir.Emission,u_color_mix:[E.r,E.g,E.b,T],u_aoIntensity:M,u_emissive_strength:u}},Tw=new Float32Array(16),Mw=(e,t=Tw,i=Tw)=>({u_matrix:e,u_instance:t,u_node_matrix:i}),LC={fillExtrusion:e=>({u_matrix:new Ne(e),u_lightpos:new je(e),u_lightintensity:new Nt(e),u_lightcolor:new je(e),u_vertical_gradient:new Nt(e),u_opacity:new Nt(e),u_edge_radius:new Nt(e),u_ao:new ii(e),u_tile_id:new je(e),u_zoom_transition:new Nt(e),u_inv_rot_matrix:new Ne(e),u_merc_center:new ii(e),u_up_dir:new je(e),u_height_lift:new Nt(e),u_flood_light_color:new je(e),u_vertical_scale:new Nt(e),u_flood_light_intensity:new Nt(e),u_ground_shadow_factor:new je(e),u_emissive_strength:new Nt(e)}),fillExtrusionDepth:e=>({u_matrix:new Ne(e),u_edge_radius:new Nt(e),u_vertical_scale:new Nt(e)}),fillExtrusionPattern:e=>({u_matrix:new Ne(e),u_lightpos:new je(e),u_lightintensity:new Nt(e),u_lightcolor:new je(e),u_vertical_gradient:new Nt(e),u_height_factor:new Nt(e),u_edge_radius:new Nt(e),u_ao:new ii(e),u_tile_id:new je(e),u_zoom_transition:new Nt(e),u_inv_rot_matrix:new Ne(e),u_merc_center:new ii(e),u_up_dir:new je(e),u_height_lift:new Nt(e),u_image:new ei(e),u_texsize:new ii(e),u_pixel_coord_upper:new ii(e),u_pixel_coord_lower:new ii(e),u_tile_units_to_pixels:new Nt(e),u_opacity:new Nt(e)}),fillExtrusionGroundEffect:e=>({u_matrix:new Ne(e),u_opacity:new Nt(e),u_ao_pass:new Nt(e),u_meter_to_tile:new Nt(e),u_ao:new ii(e),u_flood_light_intensity:new Nt(e),u_flood_light_color:new je(e),u_attenuation:new Nt(e),u_edge_radius:new Nt(e),u_fb:new ei(e),u_fb_size:new Nt(e)}),fill:e=>({u_matrix:new Ne(e),u_emissive_strength:new Nt(e)}),fillPattern:e=>({u_matrix:new Ne(e),u_emissive_strength:new Nt(e),u_image:new ei(e),u_texsize:new ii(e),u_pixel_coord_upper:new ii(e),u_pixel_coord_lower:new ii(e),u_tile_units_to_pixels:new Nt(e)}),fillOutline:e=>({u_matrix:new Ne(e),u_emissive_strength:new Nt(e),u_world:new ii(e)}),fillOutlinePattern:e=>({u_matrix:new Ne(e),u_emissive_strength:new Nt(e),u_world:new ii(e),u_image:new ei(e),u_texsize:new ii(e),u_pixel_coord_upper:new ii(e),u_pixel_coord_lower:new ii(e),u_tile_units_to_pixels:new Nt(e)}),circle:e=>({u_camera_to_center_distance:new Nt(e),u_extrude_scale:new Lp(e),u_device_pixel_ratio:new Nt(e),u_matrix:new Ne(e),u_inv_rot_matrix:new Ne(e),u_merc_center:new ii(e),u_tile_id:new je(e),u_zoom_transition:new Nt(e),u_up_dir:new je(e),u_emissive_strength:new Nt(e)}),collisionBox:e=>({u_matrix:new Ne(e),u_camera_to_center_distance:new Nt(e),u_extrude_scale:new ii(e)}),collisionCircle:e=>({u_matrix:new Ne(e),u_inv_matrix:new Ne(e),u_camera_to_center_distance:new Nt(e),u_viewport_size:new ii(e)}),debug:e=>({u_color:new gl(e),u_matrix:new Ne(e),u_overlay:new ei(e),u_overlay_scale:new Nt(e)}),clippingMask:e=>({u_matrix:new Ne(e)}),heatmap:e=>({u_extrude_scale:new Nt(e),u_intensity:new Nt(e),u_matrix:new Ne(e),u_inv_rot_matrix:new Ne(e),u_merc_center:new ii(e),u_tile_id:new je(e),u_zoom_transition:new Nt(e),u_up_dir:new je(e)}),heatmapTexture:e=>({u_image:new ei(e),u_color_ramp:new ei(e),u_opacity:new Nt(e)}),hillshade:e=>({u_matrix:new Ne(e),u_image:new ei(e),u_latrange:new ii(e),u_light:new ii(e),u_shadow:new gl(e),u_highlight:new gl(e),u_emissive_strength:new Nt(e),u_accent:new gl(e)}),hillshadePrepare:e=>({u_matrix:new Ne(e),u_image:new ei(e),u_dimension:new ii(e),u_zoom:new Nt(e)}),line:e=>({u_matrix:new Ne(e),u_pixels_to_tile_units:new Lp(e),u_device_pixel_ratio:new Nt(e),u_units_to_pixels:new ii(e),u_dash_image:new ei(e),u_gradient_image:new ei(e),u_image_height:new Nt(e),u_texsize:new ii(e),u_tile_units_to_pixels:new Nt(e),u_alpha_discard_threshold:new Nt(e),u_trim_offset:new ii(e),u_emissive_strength:new Nt(e)}),linePattern:e=>({u_matrix:new Ne(e),u_texsize:new ii(e),u_pixels_to_tile_units:new Lp(e),u_device_pixel_ratio:new Nt(e),u_image:new ei(e),u_units_to_pixels:new ii(e),u_tile_units_to_pixels:new Nt(e),u_alpha_discard_threshold:new Nt(e)}),raster:e=>({u_matrix:new Ne(e),u_normalize_matrix:new Ne(e),u_globe_matrix:new Ne(e),u_merc_matrix:new Ne(e),u_grid_matrix:new zp(e),u_tl_parent:new ii(e),u_scale_parent:new Nt(e),u_fade_t:new Nt(e),u_opacity:new Nt(e),u_image0:new ei(e),u_image1:new ei(e),u_brightness_low:new Nt(e),u_brightness_high:new Nt(e),u_saturation_factor:new Nt(e),u_contrast_factor:new Nt(e),u_spin_weights:new je(e),u_perspective_transform:new ii(e),u_raster_elevation:new Nt(e),u_tl_br:new Mr(e),u_zoom_transition:new Nt(e),u_merc_center:new ii(e),u_cutoff_params:new Mr(e),u_colorization_mix:new Mr(e),u_colorization_offset:new Nt(e),u_color_ramp:new ei(e),u_texture_offset:new ii(e),u_texture_res:new ii(e),u_emissive_strength:new Nt(e)}),symbolIcon:e=>({u_is_size_zoom_constant:new ei(e),u_is_size_feature_constant:new ei(e),u_size_t:new Nt(e),u_size:new Nt(e),u_camera_to_center_distance:new Nt(e),u_rotate_symbol:new ei(e),u_aspect_ratio:new Nt(e),u_fade_change:new Nt(e),u_matrix:new Ne(e),u_label_plane_matrix:new Ne(e),u_coord_matrix:new Ne(e),u_is_text:new ei(e),u_pitch_with_map:new ei(e),u_texsize:new ii(e),u_tile_id:new je(e),u_zoom_transition:new Nt(e),u_inv_rot_matrix:new Ne(e),u_merc_center:new ii(e),u_camera_forward:new je(e),u_tile_matrix:new Ne(e),u_up_vector:new je(e),u_ecef_origin:new je(e),u_texture:new ei(e),u_icon_transition:new Nt(e),u_icon_saturation:new Nt(e)}),symbolSDF:e=>({u_is_size_zoom_constant:new ei(e),u_is_size_feature_constant:new ei(e),u_size_t:new Nt(e),u_size:new Nt(e),u_camera_to_center_distance:new Nt(e),u_rotate_symbol:new ei(e),u_aspect_ratio:new Nt(e),u_fade_change:new Nt(e),u_matrix:new Ne(e),u_label_plane_matrix:new Ne(e),u_coord_matrix:new Ne(e),u_is_text:new ei(e),u_pitch_with_map:new ei(e),u_texsize:new ii(e),u_texture:new ei(e),u_gamma_scale:new Nt(e),u_device_pixel_ratio:new Nt(e),u_tile_id:new je(e),u_zoom_transition:new Nt(e),u_inv_rot_matrix:new Ne(e),u_merc_center:new ii(e),u_camera_forward:new je(e),u_tile_matrix:new Ne(e),u_up_vector:new je(e),u_ecef_origin:new je(e),u_is_halo:new ei(e)}),symbolTextAndIcon:e=>({u_is_size_zoom_constant:new ei(e),u_is_size_feature_constant:new ei(e),u_size_t:new Nt(e),u_size:new Nt(e),u_camera_to_center_distance:new Nt(e),u_rotate_symbol:new ei(e),u_aspect_ratio:new Nt(e),u_fade_change:new Nt(e),u_matrix:new Ne(e),u_label_plane_matrix:new Ne(e),u_coord_matrix:new Ne(e),u_is_text:new ei(e),u_pitch_with_map:new ei(e),u_texsize:new ii(e),u_texsize_icon:new ii(e),u_texture:new ei(e),u_texture_icon:new ei(e),u_gamma_scale:new Nt(e),u_device_pixel_ratio:new Nt(e),u_is_halo:new ei(e)}),background:e=>({u_matrix:new Ne(e),u_emissive_strength:new Nt(e),u_opacity:new Nt(e),u_color:new gl(e)}),backgroundPattern:e=>({u_matrix:new Ne(e),u_emissive_strength:new Nt(e),u_opacity:new Nt(e),u_image:new ei(e),u_pattern_tl:new ii(e),u_pattern_br:new ii(e),u_texsize:new ii(e),u_pattern_size:new ii(e),u_pixel_coord_upper:new ii(e),u_pixel_coord_lower:new ii(e),u_tile_units_to_pixels:new Nt(e)}),terrainRaster:ow,terrainDepth:ow,skybox:e=>({u_matrix:new Ne(e),u_sun_direction:new je(e),u_cubemap:new ei(e),u_opacity:new Nt(e),u_temporal_offset:new Nt(e)}),skyboxGradient:e=>({u_matrix:new Ne(e),u_color_ramp:new ei(e),u_center_direction:new je(e),u_radius:new Nt(e),u_opacity:new Nt(e),u_temporal_offset:new Nt(e)}),skyboxCapture:e=>({u_matrix_3f:new zp(e),u_sun_direction:new je(e),u_sun_intensity:new Nt(e),u_color_tint_r:new Mr(e),u_color_tint_m:new Mr(e),u_luminance:new Nt(e)}),globeRaster:e=>({u_proj_matrix:new Ne(e),u_globe_matrix:new Ne(e),u_normalize_matrix:new Ne(e),u_merc_matrix:new Ne(e),u_zoom_transition:new Nt(e),u_merc_center:new ii(e),u_image0:new ei(e),u_grid_matrix:new zp(e),u_skirt_height:new Nt(e),u_frustum_tl:new je(e),u_frustum_tr:new je(e),u_frustum_br:new je(e),u_frustum_bl:new je(e),u_globe_pos:new je(e),u_globe_radius:new Nt(e),u_viewport:new ii(e)}),globeAtmosphere:e=>({u_frustum_tl:new je(e),u_frustum_tr:new je(e),u_frustum_br:new je(e),u_frustum_bl:new je(e),u_horizon:new Nt(e),u_transition:new Nt(e),u_fadeout_range:new Nt(e),u_color:new Mr(e),u_high_color:new Mr(e),u_space_color:new Mr(e),u_temporal_offset:new Nt(e),u_horizon_angle:new Nt(e)}),model:e=>({u_matrix:new Ne(e),u_lighting_matrix:new Ne(e),u_normal_matrix:new Ne(e),u_lightpos:new je(e),u_lightintensity:new Nt(e),u_lightcolor:new je(e),u_camera_pos:new je(e),u_opacity:new Nt(e),u_baseColorFactor:new Mr(e),u_emissiveFactor:new Mr(e),u_metallicFactor:new Nt(e),u_roughnessFactor:new Nt(e),u_baseTextureIsAlpha:new ei(e),u_alphaMask:new ei(e),u_alphaCutoff:new Nt(e),u_baseColorTexture:new ei(e),u_metallicRoughnessTexture:new ei(e),u_normalTexture:new ei(e),u_occlusionTexture:new ei(e),u_emissionTexture:new ei(e),u_color_mix:new Mr(e),u_aoIntensity:new Nt(e),u_emissive_strength:new Nt(e)}),modelDepth:e=>({u_matrix:new Ne(e),u_instance:new Ne(e),u_node_matrix:new Ne(e)}),groundShadow:e=>({u_matrix:new Ne(e),u_ground_shadow_factor:new je(e)}),stars:e=>({u_matrix:new Ne(e),u_up:new je(e),u_right:new je(e),u_intensity_multiplier:new Nt(e)})};let xd;function Ew(e,t,i,n,r,o,s){const a=e.context,l=a.gl,c=e.transform,u=e.getOrCreateProgram("collisionBox"),h=[];let d=0,p=0;for(let E=0;E<n.length;E++){const T=n[E],S=t.getTile(T),D=S.getBucket(i);if(!D)continue;const z=ZI(T,D,c);let L=z;r[0]===0&&r[1]===0||(L=e.translatePosMatrix(z,S,r,o));const R=s?D.textCollisionBox:D.iconCollisionBox,N=D.collisionCircleArray;if(N.length>0){const U=st.create(),H=L;st.mul(U,D.placementInvProjMatrix,c.glCoordMatrix),st.mul(U,U,D.placementViewportMatrix),h.push({circleArray:N,circleOffset:p,transform:H,invTransform:U,projection:D.getProjection()}),d+=N.length/4,p=d}R&&(e.terrain&&e.terrain.setupElevationDraw(S,u),u.draw(e,l.LINES,Ie.disabled,Ke.disabled,e.colorModeForRenderPass(),ti.disabled,EC(L,c,S,D.getProjection()),i.id,R.layoutVertexBuffer,R.indexBuffer,R.segments,null,c.zoom,null,[R.collisionVertexBuffer,R.collisionVertexBufferExt]))}if(!s||!h.length)return;const _=e.getOrCreateProgram("collisionCircle"),g=new wp;g.resize(4*d),g._trim();let y=0;for(const E of h)for(let T=0;T<E.circleArray.length/4;T++){const S=4*T,D=E.circleArray[S+0],z=E.circleArray[S+1],L=E.circleArray[S+2],R=E.circleArray[S+3];g.emplace(y++,D,z,L,R,0),g.emplace(y++,D,z,L,R,1),g.emplace(y++,D,z,L,R,2),g.emplace(y++,D,z,L,R,3)}(!xd||xd.length<2*d)&&(xd=function(E){const T=2*E,S=new Rn;S.resize(T),S._trim();for(let D=0;D<T;D++){const z=6*D;S.uint16[z+0]=4*D+0,S.uint16[z+1]=4*D+1,S.uint16[z+2]=4*D+2,S.uint16[z+3]=4*D+2,S.uint16[z+4]=4*D+3,S.uint16[z+5]=4*D+0}return S}(d));const x=a.createIndexBuffer(xd,!0),b=a.createVertexBuffer(g,nA.members,!0);for(const E of h){const T={u_matrix:E.transform,u_inv_matrix:E.invTransform,u_camera_to_center_distance:(M=c).getCameraToCenterDistance(E.projection),u_viewport_size:[M.width,M.height]};_.draw(e,l.TRIANGLES,Ie.disabled,Ke.disabled,e.colorModeForRenderPass(),ti.disabled,T,i.id,b,x,Fi.simpleSegment(0,2*E.circleOffset,E.circleArray.length,E.circleArray.length/2),null,c.zoom)}var M;b.destroy(),x.destroy()}const Sw=st.create();function RC({width:e,height:t,anchor:i,textOffset:n,textScale:r},o){const{horizontalAlign:s,verticalAlign:a}=Rh(i),l=-(s-.5)*e,c=-(a-.5)*t,u=Pm(i,n);return new G((l/r+u[0])*o,(c/r+u[1])*o)}function OC(e,t,i,n,r,o,s,a,l,c,u){const h=e.text.placedSymbolArray,d=e.text.dynamicLayoutVertexArray,p=e.icon.dynamicLayoutVertexArray,_={},g=e.getProjection(),y=f_(a,g,o),x=o.elevation,b=g.upVectorScale(a.canonical,o.center.lat,o.worldSize).metersToTile;d.clear();for(let M=0;M<h.length;M++){const E=h.get(M),{tileAnchorX:T,tileAnchorY:S,numGlyphs:D}=E,z=E.hidden||!E.crossTileID||e.allowVerticalPlacement&&!E.placedOrientation?null:n[E.crossTileID];if(z){let L=0,R=0,N=0;if(x){const at=x?x.getAtTileOffset(a,T,S):0,[ut,ct,bt]=g.upVector(a.canonical,T,S);L=at*ut*b,R=at*ct*b,N=at*bt*b}let[U,H,O,X]=uo(E.projectedAnchorX+L,E.projectedAnchorY+R,E.projectedAnchorZ+N,i?y:s);const K=_x(o.getCameraToCenterDistance(g),X);let ot=r.evaluateSizeForFeature(e.textSizeData,c,E)*K/$n;i&&(ot*=e.tilePixelRatio/l);const $=RC(z,ot);i?({x:U,y:H,z:O}=g.projectTilePoint(T+$.x,S+$.y,a.canonical),[U,H,O]=uo(U+L,H+R,O+N,s)):(t&&$._rotate(-o.angle),U+=$.x,H+=$.y,O=0);const Y=e.allowVerticalPlacement&&E.placedOrientation===un.vertical?Math.PI/2:0;for(let at=0;at<D;at++)Rl(d,U,H,O,Y);u&&E.associatedIconIndex>=0&&(_[E.associatedIconIndex]={x:U,y:H,z:O,angle:Y})}else Bl(D,d)}if(u){p.clear();const M=e.icon.placedSymbolArray;for(let E=0;E<M.length;E++){const T=M.get(E),{numGlyphs:S}=T,D=_[E];if(T.hidden||!D)Bl(S,p);else{const{x:z,y:L,z:R,angle:N}=D;for(let U=0;U<S;U++)Rl(p,z,L,R,N)}}e.icon.dynamicLayoutVertexBuffer.updateData(p)}e.text.dynamicLayoutVertexBuffer.updateData(d)}function BC(e,t,i){return i.iconsInText&&t?"symbolTextAndIcon":e?"symbolSDF":"symbolIcon"}function Aw(e,t,i,n,r,o,s,a,l,c,u,h,d){const p=e.context,_=p.gl,g=e.transform,y=a==="map",x=l==="map",b=y&&i.layout.get("symbol-placement")!=="point",M=y&&!x&&!b,E=i.layout.get("symbol-sort-key").constantOr(1)!==void 0;let T=!1;const S=e.depthModeForSublayer(0,Ie.ReadOnly),D=[Fn(g.center.lng),jn(g.center.lat)],z=i.layout.get("text-variable-anchor"),L=g.projection.name==="globe",R=[],N=[0,-1,0];let U=N;!L&&!g.mercatorFromTransition||y||(U=function(H){const O=H._camera.getWorldToCamera(H.worldSize,1),X=st.multiply([],O,H.globeMatrix);st.invert(X,X);const K=[0,0,0],ot=[0,1,0,0];return Ni.transformMat4(ot,ot,X),K[0]=ot[0],K[1]=ot[1],K[2]=ot[2],Z.normalize(K,K),K}(g));for(const H of n){const O=t.getTile(H),X=O.getBucket(i);if(!X||X.projection.name==="mercator"&&L)continue;const K=r?X.text:X.icon;if(!K||X.fullyClipped||!K.segments.get().length)continue;const ot=K.programConfigurations.get(i.id),$=r||X.sdfIcons,Y=r?X.textSizeData:X.iconSizeData,at=x||g.pitch!==0,ut=ko(Y,g.zoom);let ct,bt,Mt,Et,ft=[0,0],kt=null;if(r)bt=O.glyphAtlasTexture?O.glyphAtlasTexture:null,Mt=_.LINEAR,ct=O.glyphAtlasTexture?O.glyphAtlasTexture.size:[0,0],X.iconsInText&&(ft=O.imageAtlasTexture?O.imageAtlasTexture.size:[0,0],kt=O.imageAtlasTexture?O.imageAtlasTexture:null,Et=at||e.options.rotating||e.options.zooming||Y.kind==="composite"||Y.kind==="camera"?_.LINEAR:_.NEAREST);else{const sn=i.layout.get("icon-size").constantOr(0)!==1||X.iconsNeedLinear;bt=O.imageAtlasTexture?O.imageAtlasTexture:null,Mt=$||e.options.rotating||e.options.zooming||sn||at?_.LINEAR:_.NEAREST,ct=O.imageAtlasTexture?O.imageAtlasTexture.size:[0,0]}const Qt=X.projection.name==="globe",te=Qt?U:N,oe=Qt?Wn(g.zoom):0,ce=f_(H,X.getProjection(),g),Ce=g.calculatePixelsToTileUnitsMatrix(O),ge=td(ce,O.tileID.canonical,x,y,g,X.getProjection(),Ce),bi=e.terrain&&x&&b?st.invert(st.create(),ge):Sw,ni=mx(ce,O.tileID.canonical,x,y,g,X.getProjection(),Ce),De=z&&X.hasTextData(),we=X.hasIconTextFit()&&De&&X.hasIconData();if(b){const sn=g.elevation,Ri=sn?sn.getAtTileOffsetFunc(H,g.center.lat,g.worldSize,X.getProjection()):null,Jn=px(ce,O.tileID.canonical,x,y,g,X.getProjection(),Ce);R3(X,ce,e,r,Jn,ni,x,c,Ri,H)}const ye=b||r&&z||we,si=e.translatePosMatrix(ce,O,o,s),pi=ye?Sw:ge,$e=e.translatePosMatrix(ni,O,o,s,!0),qi=X.getProjection().createInversionMatrix(g,H.canonical),An=i.paint.get("icon-image-cross-fade").constantOr(0),Ui=[];e.terrainRenderModeElevated()&&x&&Ui.push("PITCH_WITH_MAP_TERRAIN"),Qt&&(Ui.push("PROJECTION_GLOBE_VIEW"),ye&&Ui.push("PROJECTED_POS_ON_VIEWPORT")),An>0&&Ui.push("ICON_TRANSITION"),K.zOffsetVertexBuffer&&Ui.push("Z_OFFSET");const nn=$&&i.paint.get(r?"text-halo-width":"icon-halo-width").constantOr(1)!==0;let Dn;$?Dn=X.iconsInText?PC(Y.kind,ut,M,x,e,si,pi,$e,ct,ft,H,oe,D,qi,te,X.getProjection()):ww(Y.kind,ut,M,x,e,si,pi,$e,r,ct,!0,H,oe,D,qi,te,X.getProjection()):(u<1&&Ui.push("SATURATION"),Dn=bw(Y.kind,ut,M,x,e,si,pi,$e,r,ct,H,oe,D,qi,te,X.getProjection(),u,An));const In={program:e.getOrCreateProgram(BC($,r,X),{config:ot,defines:Ui}),buffers:K,uniformValues:Dn,atlasTexture:bt,atlasTextureIcon:kt,atlasInterpolation:Mt,atlasInterpolationIcon:Et,isSDF:$,hasHalo:nn,tile:O,labelPlaneMatrixInv:bi};if(E&&X.canOverlap){T=!0;const sn=K.segments.get();for(const Ri of sn)R.push({segments:new Fi([Ri]),sortKey:Ri.sortKey,state:In})}else R.push({segments:K.segments,sortKey:0,state:In})}T&&R.sort((H,O)=>H.sortKey-O.sortKey);for(const H of R){const O=H.state;if(e.terrain&&e.terrain.setupElevationDraw(O.tile,O.program,{useDepthForOcclusion:g.depthOcclusionForSymbolsAndCircles,labelPlaneMatrixInv:O.labelPlaneMatrixInv}),p.activeTexture.set(_.TEXTURE0),O.atlasTexture&&O.atlasTexture.bind(O.atlasInterpolation,_.CLAMP_TO_EDGE),O.atlasTextureIcon&&(p.activeTexture.set(_.TEXTURE1),O.atlasTextureIcon&&O.atlasTextureIcon.bind(O.atlasInterpolationIcon,_.CLAMP_TO_EDGE)),e.uploadCommonLightUniforms(e.context,O.program),O.hasHalo){const X=O.uniformValues;X.u_is_halo=1,b_(O.buffers,H.segments,i,e,O.program,S,h,d,X,2),X.u_is_halo=0}else{if(O.isSDF){const X=O.uniformValues;O.hasHalo&&(X.u_is_halo=1,b_(O.buffers,H.segments,i,e,O.program,S,h,d,X,1)),X.u_is_halo=0}b_(O.buffers,H.segments,i,e,O.program,S,h,d,O.uniformValues,1)}}}function b_(e,t,i,n,r,o,s,a,l,c){const u=[e.dynamicLayoutVertexBuffer,e.opacityVertexBuffer,e.iconTransitioningVertexBuffer,e.globeExtVertexBuffer,e.zOffsetVertexBuffer];r.draw(n,n.context.gl.TRIANGLES,o,s,a,ti.disabled,l,i.id,e.layoutVertexBuffer,e.indexBuffer,t,i.paint,n.transform.zoom,e.programConfigurations.get(i.id),u,c)}function Iw(e,t,i,n,r,o,s){const a=e.context.gl,l=i.paint.get("fill-pattern"),c=l&&l.constantOr(1);let u,h,d,p,_;s?(h=c&&!i.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",u=a.LINES):(h=c?"fillPattern":"fill",u=a.TRIANGLES);for(const g of n){const y=t.getTile(g);if(c&&!y.patternsLoaded())continue;const x=y.getBucket(i);if(!x)continue;e.prepareDrawTile();const b=x.programConfigurations.get(i.id),M=e.isTileAffectedByFog(g),E=e.getOrCreateProgram(h,{config:b,overrideFog:M});c&&(e.context.activeTexture.set(a.TEXTURE0),y.imageAtlasTexture&&y.imageAtlasTexture.bind(a.LINEAR,a.CLAMP_TO_EDGE),b.updatePaintBuffers());const T=l.constantOr(null);if(T&&y.imageAtlas){const z=y.imageAtlas.patternPositions[T.toString()];z&&b.setConstantPatternPositions(z)}const S=e.translatePosMatrix(g.projMatrix,y,i.paint.get("fill-translate"),i.paint.get("fill-translate-anchor")),D=i.paint.get("fill-emissive-strength");if(s){p=x.indexBuffer2,_=x.segments2;const z=e.terrain&&e.terrain.renderingToTexture?e.terrain.drapeBufferSize:[a.drawingBufferWidth,a.drawingBufferHeight];d=h==="fillOutlinePattern"&&c?MC(S,D,e,y,z):TC(S,D,z)}else p=x.indexBuffer,_=x.segments,d=c?gw(S,D,e,y):_w(S,D);e.uploadCommonUniforms(e.context,E,g.toUnwrapped()),E.draw(e,u,r,e.stencilModeForClipping(g),o,ti.disabled,d,i.id,x.layoutVertexBuffer,p,_,i.paint,e.transform.zoom,b,void 0)}}function bd(e,t,i,n,r,o,s,a){i.resetLayerRenderingStats();const l=e.context,c=l.gl,u=e.transform,h=i.paint.get("fill-extrusion-pattern"),d=h.constantOr(1),p=i.paint.get("fill-extrusion-opacity"),_=e.style.enable3dLights(),g=i.paint.get(_&&!d?"fill-extrusion-ambient-occlusion-wall-radius":"fill-extrusion-ambient-occlusion-radius"),y=[i.paint.get("fill-extrusion-ambient-occlusion-intensity"),g],x=i.layout.get("fill-extrusion-edge-radius"),b=x>0&&!i.paint.get("fill-extrusion-rounded-roof"),M=b?0:x,E=u.projection.name==="globe"?Kx():0,T=u.projection.name==="globe",S=T?Wn(u.zoom):0,D=[Fn(u.center.lng),jn(u.center.lat)],z=i.paint.get("fill-extrusion-flood-light-color").toArray01().slice(0,3),L=i.paint.get("fill-extrusion-flood-light-intensity"),R=i.paint.get("fill-extrusion-vertical-scale"),N=Ul(e,i.paint.get("fill-extrusion-cutoff-fade-range")),U=i.paint.get("fill-extrusion-emissive-strength"),H=[];let O;T&&H.push("PROJECTION_GLOBE_VIEW"),y[0]>0&&H.push("FAUX_AO"),b&&H.push("ZERO_ROOF_RADIUS"),a&&H.push("HAS_CENTROID"),L>0&&H.push("FLOOD_LIGHT"),N.shouldRenderCutoff&&H.push("RENDER_CUTOFF");const X=e.renderPass==="shadow",K=e.shadowRenderer,ot=X&&!!K;e.shadowRenderer&&(e.shadowRenderer.useNormalOffset=!0);let $=[0,0,0];if(K){const ut=e.style.directionalLight,ct=e.style.ambientLight;ut&&ct&&($=M_(ut,ct)),O=H.concat(["SHADOWS_SINGLE_CASCADE"])}const Y=ot?"fillExtrusionDepth":d?"fillExtrusionPattern":"fillExtrusion",at=i.getLayerRenderingStats();for(const ut of n){const ct=t.getTile(ut),bt=ct.getBucket(i);if(!bt||bt.projection.name!==u.projection.name)continue;let Mt=!1;K&&(Mt=K.getMaxCascadeForTile(ut.toUnwrapped())===0);const Et=e.isTileAffectedByFog(ut),ft=bt.programConfigurations.get(i.id),kt=e.getOrCreateProgram(Y,{config:ft,defines:Mt?O:H,overrideFog:Et});if(e.terrain&&e.terrain.setupElevationDraw(ct,kt,{useMeterToDem:!0}),!bt.centroidVertexBuffer){const ge=kt.attributes.a_centroid_pos;ge!==void 0&&c.vertexAttrib2f(ge,0,0)}!X&&K&&K.setupShadows(ct.tileID.toUnwrapped(),kt,"vector-tile",ct.tileID.overscaledZ),d&&(e.context.activeTexture.set(c.TEXTURE0),ct.imageAtlasTexture&&ct.imageAtlasTexture.bind(c.LINEAR,c.CLAMP_TO_EDGE),ft.updatePaintBuffers());const Qt=h.constantOr(null);if(Qt&&ct.imageAtlas){const ge=ct.imageAtlas.patternPositions[Qt.toString()];ge&&ft.setConstantPatternPositions(ge)}const te=i.paint.get("fill-extrusion-vertical-gradient");let oe;if(X&&K){if(jC(ct.tileID,bt,e))continue;const ge=K.calculateShadowPassMatrixFromTile(ct.tileID.toUnwrapped());oe=bC(ge,M,R)}else{const ge=e.translatePosMatrix(ut.expandedProjMatrix,ct,i.paint.get("fill-extrusion-translate"),i.paint.get("fill-extrusion-translate-anchor")),bi=u.projection.createInversionMatrix(u,ut.canonical);oe=d?wC(ge,e,te,p,y,M,ut,ct,E,S,D,bi,z,R):mw(ge,e,te,p,y,M,ut,E,S,D,bi,z,R,L,$,U)}e.uploadCommonUniforms(l,kt,ut.toUnwrapped(),null,N);let ce=bt.segments;if(u.projection.name==="mercator"&&!X&&(ce=bt.getVisibleSegments(ct.tileID,e.terrain,e.transform.getFrustum(0)),!ce.get().length))continue;if(at)if(X)for(const ge of ce.get())at.numRenderedVerticesInShadowPass+=ge.primitiveLength;else for(const ge of ce.get())at.numRenderedVerticesInTransparentPass+=ge.primitiveLength;const Ce=[];(e.terrain||a)&&Ce.push(bt.centroidVertexBuffer),T&&Ce.push(bt.layoutVertexExtBuffer),kt.draw(e,l.gl.TRIANGLES,r,o,s,ti.backCCW,oe,i.id,bt.layoutVertexBuffer,bt.indexBuffer,ce,i.paint,e.transform.zoom,ft,Ce)}e.shadowRenderer&&(e.shadowRenderer.useNormalOffset=!1)}function jl(e,t,i,n,r,o,s,a,l,c,u,h,d,p,_,g,y,x,b){const M=e.context,E=M.gl,T=e.transform,S=e.transform.zoom,D=[],z=Ul(e,i.paint.get("fill-extrusion-cutoff-fade-range"));c==="clear"?(D.push("CLEAR_SUBPASS"),b&&(D.push("CLEAR_FROM_TEXTURE"),M.activeTexture.set(E.TEXTURE0),b.bind(E.LINEAR,E.CLAMP_TO_EDGE))):c==="sdf"&&D.push("SDF_SUBPASS"),y&&D.push("HAS_CENTROID"),z.shouldRenderCutoff&&D.push("RENDER_CUTOFF");const L=i.layout.get("fill-extrusion-edge-radius"),R=(N,U,H,O,X)=>{const K=U.programConfigurations.get(i.id),ot=e.isTileAffectedByFog(N),$=e.getOrCreateProgram("fillExtrusionGroundEffect",{config:K,defines:D,overrideFog:ot}),Y=((ut,ct,bt,Mt,Et,ft,kt,Qt,te,oe,ce)=>({u_matrix:ct,u_opacity:bt,u_ao_pass:Mt?1:0,u_meter_to_tile:Et,u_ao:ft,u_flood_light_intensity:kt,u_flood_light_color:Qt,u_attenuation:te,u_edge_radius:oe,u_fb:0,u_fb_size:ce}))(0,O,u,l,X,[h,d*X],p,_,g,S>=17?0:L*X,b?b.size[0]:0),at=[];y&&at.push(U.hiddenByLandmarkVertexBuffer),e.uploadCommonUniforms(M,$,N.toUnwrapped(),null,z),$.draw(e,M.gl.TRIANGLES,r,o,s,a,Y,i.id,U.vertexBuffer,U.indexBuffer,H,i.paint,S,K,at)};for(const N of n){const U=t.getTile(N),H=U.getBucket(i);if(!H||H.projection.name!==T.projection.name||!H.groundEffect||H.groundEffect&&!H.groundEffect.hasData())continue;const O=H.groundEffect,X=1/H.tileToMeter;{const K=e.translatePosMatrix(N.projMatrix,U,i.paint.get("fill-extrusion-translate"),i.paint.get("fill-extrusion-translate-anchor")),ot=O.getDefaultSegment();R(N,O,ot,K,X)}if(x)for(let K=0;K<4;K++){const ot=T1[K](N),$=t.getTile(ot);if(!$)continue;const Y=$.getBucket(i);if(!Y||Y.projection.name!==T.projection.name||!Y.groundEffect||Y.groundEffect&&!Y.groundEffect.hasData())continue;const at=Y.groundEffect;let ut,ct;K===0?(ut=[-pt,0,0],ct=1):K===1?(ut=[pt,0,0],ct=0):K===2?(ut=[0,-pt,0],ct=3):(ut=[0,pt,0],ct=2);const bt=at.regionSegments[ct];if(!bt)continue;const Mt=new Float32Array(16);st.translate(Mt,N.projMatrix,ut),R(N,at,bt,e.translatePosMatrix(Mt,U,i.paint.get("fill-extrusion-translate"),i.paint.get("fill-extrusion-translate-anchor")),X)}}}function FC(e,t,i,n,r,o,s){n.centroidVertexArray.length===0&&n.createCentroidsBuffer();const a=o?o.findDEMTileFor(i):null;if(!(a&&a.dem||s))return;const l=x=>{const b=t.getSource().minzoom,M=T=>{const S=t.getTileByID(T);if(S&&S.hasData())return S.getBucket(r)},E=[0,-1,1];for(const T of E){if(x.overscaledZ+T<b)continue;const S=M(x.calculateScaledKey(x.overscaledZ+T));if(S)return S}},c=[0,0,0],u=(x,b)=>(c[0]=Math.min(x.min.y,b.min.y),c[1]=Math.max(x.max.y,b.max.y),c[2]=pt-b.min.x>x.max.x?b.min.x-pt:x.max.x,c),h=(x,b)=>(c[0]=Math.min(x.min.x,b.min.x),c[1]=Math.max(x.max.x,b.max.x),c[2]=pt-b.min.y>x.max.y?b.min.y-pt:x.max.y,c),d=[(x,b)=>u(x,b),(x,b)=>u(b,x),(x,b)=>h(x,b),(x,b)=>h(b,x)],p=(x,b,M,E,T,S,D)=>{if(!o)return 0;const z=[[S?M:x,S?x:M,0],[S?M:b,S?b:M,0]],L=D<0?pt+D:D,R=[S?L:(x+b)/2,S?(x+b)/2:L,0];return M===0&&D<0||M!==0&&D>0?o.getForTilePoints(T,[R],!0,E):z.push(R),o.getForTilePoints(i,z,!0,a),Math.max(z[0][2],z[1][2],R[2])/o.exaggeration()};for(let x=0;x<4;x++){const b=n.borderFeatureIndices[x];if(b.length===0)continue;const M=T1[x](i),E=l(M);if(!(E&&E instanceof ou)||n.borderDoneWithNeighborZ[x]===E.canonical.z)continue;E.centroidVertexArray.length===0&&E.createCentroidsBuffer();const T=o?o.findDEMTileFor(M):null;if(!(T&&T.dem||s))continue;const S=(x<2?1:5)-x,D=E.borderDoneWithNeighborZ[S]!==n.canonical.z,z=E.borderFeatureIndices[S];let L=0;if(n.canonical.z!==E.canonical.z){for(const R of b)n.showCentroid(n.featuresOnBorder[R]);if(D)for(const R of z)E.showCentroid(E.featuresOnBorder[R]);n.borderDoneWithNeighborZ[x]=E.canonical.z,E.borderDoneWithNeighborZ[S]=n.canonical.z}for(const R of b){const N=n.featuresOnBorder[R],U=n.centroidData[N.centroidDataIndex],H=N.borders[x];let O;for(;L<z.length;){O=E.featuresOnBorder[z[L]];const X=O.borders[S];if(X[1]>H[0]+3||X[0]>H[0]-3)break;E.showCentroid(O),L++}if(O&&L<z.length){const X=L;let K=0;for(;!(O.borders[S][0]>H[1]-3)&&(K++,++L!==z.length);)O=E.featuresOnBorder[z[L]];if(O=E.featuresOnBorder[z[X]],K>1){const Y=O.borders[S];Math.abs(H[0]-Y[0])<3&&Math.abs(H[1]-Y[1])<3&&(K=1,L=X+1)}else if(K===0){n.showCentroid(N);continue}const ot=E.centroidData[O.centroidDataIndex];s&&K===1&&(((g=U).flags|(y=ot).flags)&Ro?(g.flags|=Ro,y.flags|=Ro):(g.flags&=2147483647,y.flags&=2147483647));let $=new G(0,0);if(K>1)L=X;else if(T&&T.dem&&!(N.intersectsCount()>1||O.intersectsCount()>1)){const Y=d[x](U,ot),at=x%2?pt-1:0;_=p(Y[0],Math.min(pt-1,Y[1]),at,T,M,x<2,Y[2]),$=new G(Math.ceil(7*(_+450)),0)}U.centroidXY=ot.centroidXY=$,n.writeCentroidToBuffer(U),E.writeCentroidToBuffer(ot)}else n.showCentroid(N)}n.borderDoneWithNeighborZ[x]=E.canonical.z,E.borderDoneWithNeighborZ[S]=n.canonical.z}var _,g,y;(n.needsCentroidUpdate||!n.centroidVertexBuffer&&n.centroidVertexArray.length!==0)&&n.uploadCentroid(e)}const NC=[1,0,0],UC=[0,1,0],VC=[0,0,1];function jC(e,t,i){const n=i.transform,r=i.shadowRenderer;if(!r)return!0;const o=e.toUnwrapped(),s=n.tileSize*r._cascades[i.currentShadowCascade].scale;let a=t.maxHeight;if(n.elevation){const g=n.elevation.getMinMaxForTile(e);g&&(a+=g.max)}const l=[...r.shadowDirection];l[2]=-l[2];const c=r.computeSimplifiedTileShadowVolume(o,a,s,l);if(!c)return!1;const u=[NC,UC,VC,l,[l[0],0,l[2]],[0,l[1],l[2]]],h=n.projection.name==="globe",d=n.scaleZoom(s),p=cs.fromInvProjectionMatrix(n.invProjMatrix,n.worldSize,d,!h),_=r.getCurrentCascadeFrustum();return p.intersectsPrecise(c.vertices,c.planes,u)===0||_.intersectsPrecise(c.vertices,c.planes,u)===0}function GC(e){const t=e._nearZ,i=e.projection.farthestPixelDistance(e),n=i-t,r=.2*e.height,o=t+r;return[t,i,(o-r-t)/n,(o-t)/n]}const qC=new Ye(1,0,0,1),ZC=new Ye(0,1,0,1),HC=new Ye(0,0,1,1),WC=new Ye(1,0,1,1),$C=new Ye(0,1,1,1);function XC(e,t,i){const n=e.context,r=e.transform,o=n.gl,s=r.projection.name==="globe",a=s?["PROJECTION_GLOBE_VIEW"]:[];let l=i.projMatrix;if(s&&Wn(r.zoom)>0){const R=nm(I1(i.canonical,r));l=st.multiply(new Float32Array(16),r.globeMatrix,R),st.multiply(l,r.projMatrix,l)}const c=e.getOrCreateProgram("debug",{defines:a}),u=t.getTileByID(i.key);e.terrain&&e.terrain.setupElevationDraw(u,c);const h=Ie.disabled,d=Ke.disabled,p=e.colorModeForRenderPass(),_="$debug";n.activeTexture.set(o.TEXTURE0),e.emptyTexture.bind(o.LINEAR,o.CLAMP_TO_EDGE),s?u._makeGlobeTileDebugBuffers(e.context,r):u._makeDebugTileBoundsBuffers(e.context,r.projection);const g=u._tileDebugBuffer||e.debugBuffer,y=u._tileDebugIndexBuffer||e.debugIndexBuffer,x=u._tileDebugSegments||e.debugSegments;c.draw(e,o.LINE_STRIP,h,d,p,ti.disabled,yw(l,Ye.red),_,g,y,x,null,null,null,[u._globeTileDebugBorderBuffer]);const b=u.latestRawTileData,M=Math.floor((b&&b.byteLength||0)/1024),E=t.getTile(i).tileSize,T=512/Math.min(E,512)*(i.overscaledZ/r.zoom)*.5;let S=i.canonical.toString();i.overscaledZ!==i.canonical.z&&(S+=` => ${i.overscaledZ}`),S+=` ${M}kb`,function(R,N){R.initDebugOverlayCanvas();const U=R.debugOverlayCanvas,H=R.context.gl,O=R.debugOverlayCanvas.getContext("2d");O.clearRect(0,0,U.width,U.height),O.shadowColor="white",O.shadowBlur=2,O.lineWidth=1.5,O.strokeStyle="white",O.textBaseline="top",O.font="bold 36px Open Sans, sans-serif",O.fillText(N,5,5),O.strokeText(N,5,5),R.debugOverlayTexture.update(U),R.debugOverlayTexture.bind(H.LINEAR,H.CLAMP_TO_EDGE)}(e,S);const D=u._tileDebugTextBuffer||e.debugBuffer,z=u._tileDebugTextIndexBuffer||e.quadTriangleIndexBuffer,L=u._tileDebugTextSegments||e.debugSegments;c.draw(e,o.TRIANGLES,h,d,Ti.alphaBlended,ti.disabled,yw(l,Ye.transparent,T),_,D,z,L,null,null,null,[u._globeTileDebugTextBuffer])}function Cw(e,t,i,n){wd(e,0,t+i/2,e.transform.width,i,n)}function Dw(e,t,i,n){wd(e,t-i/2,0,i,e.transform.height,n)}function wd(e,t,i,n,r,o){const s=e.context,a=s.gl;a.enable(a.SCISSOR_TEST),a.scissor(t*ke.devicePixelRatio,i*ke.devicePixelRatio,n*ke.devicePixelRatio,r*ke.devicePixelRatio),s.clear({color:o}),a.disable(a.SCISSOR_TEST)}const YC=zi([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:KC}=YC;function ia(e,t,i,n){e.emplaceBack(t,i,n)}class Pw{constructor(t){this.vertexArray=new Aa,this.indices=new Rn,ia(this.vertexArray,-1,-1,1),ia(this.vertexArray,1,-1,1),ia(this.vertexArray,-1,1,1),ia(this.vertexArray,1,1,1),ia(this.vertexArray,-1,-1,-1),ia(this.vertexArray,1,-1,-1),ia(this.vertexArray,-1,1,-1),ia(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=t.createVertexBuffer(this.vertexArray,KC),this.indexBuffer=t.createIndexBuffer(this.indices),this.segment=Fi.simpleSegment(0,0,36,12)}}function Gl(e,t,i,n,r,o){const s=e.context.gl,a=t.paint.get("sky-atmosphere-color"),l=t.paint.get("sky-atmosphere-halo-color"),c=t.paint.get("sky-atmosphere-sun-intensity"),u=((h,d,p,_,g)=>({u_matrix_3f:h,u_sun_direction:d,u_sun_intensity:p,u_color_tint_r:[_.r,_.g,_.b,_.a],u_color_tint_m:[g.r,g.g,g.b,g.a],u_luminance:5e-5}))(_r.fromMat4(_r.create(),n),r,c,a,l);s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_CUBE_MAP_POSITIVE_X+o,t.skyboxTexture,0),i.draw(e,s.TRIANGLES,Ie.disabled,Ke.disabled,Ti.unblended,ti.frontCW,u,"skyboxCapture",t.skyboxGeometry.vertexBuffer,t.skyboxGeometry.indexBuffer,t.skyboxGeometry.segment)}const JC=zi([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]);class QC{constructor(t){const i=new Sa;i.emplaceBack(-1,1,1,0,0),i.emplaceBack(1,1,1,1,0),i.emplaceBack(1,-1,1,1,1),i.emplaceBack(-1,-1,1,0,1);const n=new Rn;n.emplaceBack(0,1,2),n.emplaceBack(2,3,0),this.vertexBuffer=t.createVertexBuffer(i,JC.members),this.indexBuffer=t.createIndexBuffer(n),this.segments=Fi.simpleSegment(0,0,4,2)}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy()}}const tD=zi([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_size_scale",components:1},{type:"Float32",name:"a_fade_opacity",components:1}]);class eD{constructor(){this.colorModeAlphaBlendedWriteRGB=new Ti([1,Jh,1,Jh],Ye.transparent,[!0,!0,!0,!1]),this.colorModeWriteAlpha=new Ti([1,0,1,0],Ye.transparent,[!1,!1,!1,!0])}update(t){const i=t.context;if(!this.atmosphereBuffer){this.atmosphereBuffer=new QC(i);const n=100,r=200,o=function(u){const h=Xf(30),d=[];for(let p=0;p<16e3;++p){const _=2*Math.PI*h(),g=Math.acos(1-2*h())-.5*Math.PI;d.push(Z.fromValues(Math.cos(g)*Math.cos(_),Math.cos(g)*Math.sin(_),Math.sin(g)))}return d}(),s=Xf(300),a=new Sp,l=new Rn;let c=0;for(let u=0;u<o.length;++u){const h=Z.scale([],o[u],200),d=Math.max(0,1+.01*n*(1*s()-.5)),p=Math.max(0,1+.01*r*(1*s()-.5));a.emplaceBack(h[0],h[1],h[2],-1,-1,d,p),a.emplaceBack(h[0],h[1],h[2],1,-1,d,p),a.emplaceBack(h[0],h[1],h[2],1,1,d,p),a.emplaceBack(h[0],h[1],h[2],-1,1,d,p),l.emplaceBack(c+0,c+1,c+2),l.emplaceBack(c+0,c+2,c+3),c+=4}this.starsVx=i.createVertexBuffer(a,tD.members),this.starsIdx=i.createIndexBuffer(l),this.starsSegments=Fi.simpleSegment(0,0,a.length,l.length)}}destroy(){this.atmosphereBuffer&&this.atmosphereBuffer.destroy(),this.starsVx&&this.starsVx.destroy(),this.starsIdx&&this.starsIdx.destroy()}drawAtmosphereGlow(t,i){const n=t.context,r=n.gl,o=t.transform,s=new Ie(r.LEQUAL,Ie.ReadOnly,[0,1]),a=Wn(o.zoom),l=i.properties.get("color").toArray01(),c=i.properties.get("high-color").toArray01(),u=i.properties.get("space-color").toArray01PremultipliedAlpha(),h=5e-4,d=Lt((i.properties.get("horizon-blend")-0)/1*.2495+h,5e-4,.25),p=R1(t,n,o)&&d===h?o.worldSize/(2*Math.PI*1.025)-1:o.globeRadius,_=t.frameCounter/1e3%1,g=Z.length(o.globeCenterInViewSpace),y=Math.sqrt(Math.pow(g,2)-Math.pow(p,2)),x=Math.acos(y/g),b=M=>{const E=o.projection.name==="globe"?["PROJECTION_GLOBE_VIEW","FOG"]:["FOG"];M&&E.push("ALPHA_PASS");const T=t.getOrCreateProgram("globeAtmosphere",{defines:E}),S=((z,L,R,N,U,H,O,X,K,ot,$,Y)=>({u_frustum_tl:z,u_frustum_tr:L,u_frustum_br:R,u_frustum_bl:N,u_horizon:U,u_transition:H,u_fadeout_range:O,u_color:X,u_high_color:K,u_space_color:ot,u_temporal_offset:$,u_horizon_angle:Y}))(o.frustumCorners.TL,o.frustumCorners.TR,o.frustumCorners.BR,o.frustumCorners.BL,o.frustumCorners.horizon,a,d,l,c,u,_,x);t.uploadCommonUniforms(n,T);const D=this.atmosphereBuffer;D&&T.draw(t,r.TRIANGLES,s,Ke.disabled,M?this.colorModeWriteAlpha:this.colorModeAlphaBlendedWriteRGB,ti.backCW,S,M?"atmosphere_glow_alpha":"atmosphere_glow",D.vertexBuffer,D.indexBuffer,D.segments)};b(!1),b(!0)}drawStars(t,i){const n=Lt(i.properties.get("star-intensity"),0,1);if(n===0)return;const r=t.context,o=r.gl,s=t.transform,a=t.getOrCreateProgram("stars"),l=nr.identity([]);nr.rotateX(l,l,-s._pitch),nr.rotateZ(l,l,-s.angle),nr.rotateX(l,l,wt(s._center.lat)),nr.rotateY(l,l,-wt(s._center.lng));const c=st.fromQuat(new Float32Array(16),l),u=st.multiply([],s.starsProjMatrix,c),h=_r.fromMat4([],c),d=_r.invert([],h),p=[0,1,0];Z.transformMat3(p,p,d),Z.scale(p,p,.15);const _=[1,0,0];Z.transformMat3(_,_,d),Z.scale(_,_,.15);const g=((y,x,b,M)=>({u_matrix:Float32Array.from(y),u_up:x,u_right:b,u_intensity_multiplier:M}))(u,p,_,n);t.uploadCommonUniforms(r,a),this.starsVx&&this.starsIdx&&a.draw(t,o.TRIANGLES,Ie.disabled,Ke.disabled,this.colorModeAlphaBlendedWriteRGB,ti.disabled,g,"atmosphere_stars",this.starsVx,this.starsIdx,this.starsSegments)}}function kw(e,t){const i=[...e],n=t.cameraWorldSizeForFog/t.worldSize,r=st.identity([]);return st.scale(r,r,[n,n,1]),st.multiply(i,r,i),st.multiply(i,t.worldToFogMatrix,i),i}function w_(e,t,i,n){const r=i.material,o=n.context,{baseColorTexture:s,metallicRoughnessTexture:a}=r.pbrMetallicRoughness,{normalTexture:l,occlusionTexture:c,emissionTexture:u}=r;function h(d,p,_){if(d&&(e.push(p),o.activeTexture.set(o.gl.TEXTURE0+_),d.gfxTexture)){const{minFilter:g,magFilter:y,wrapS:x,wrapT:b}=d.sampler;d.gfxTexture.bindExtraParam(g,y,x,b)}}h(s,"HAS_TEXTURE_u_baseColorTexture",Ir.BaseColor),h(a,"HAS_TEXTURE_u_metallicRoughnessTexture",Ir.MetallicRoughness),h(l,"HAS_TEXTURE_u_normalTexture",Ir.Normal),h(c,"HAS_TEXTURE_u_occlusionTexture",Ir.Occlusion),h(u,"HAS_TEXTURE_u_emissionTexture",Ir.Emission),i.texcoordBuffer&&(e.push("HAS_ATTRIBUTE_a_uv_2f"),t.push(i.texcoordBuffer)),i.colorBuffer&&(e.push(i.colorBuffer.itemSize===12?"HAS_ATTRIBUTE_a_color_3f":"HAS_ATTRIBUTE_a_color_4f"),t.push(i.colorBuffer)),i.normalBuffer&&(e.push("HAS_ATTRIBUTE_a_normal_3f"),t.push(i.normalBuffer)),i.pbrBuffer&&(e.push("HAS_ATTRIBUTE_a_pbr"),e.push("HAS_ATTRIBUTE_a_heightBasedEmissiveStrength"),t.push(i.pbrBuffer)),r.alphaMode!=="OPAQUE"&&r.alphaMode!=="MASK"||e.push("UNPREMULT_TEXTURE_IN_SHADER"),r.defined||e.push("DIFFUSE_SHADED"),e.push("USE_STANDARD_DERIVATIVES")}function Td(e,t,i,n,r,o){const s=i.paint.get("model-opacity"),a=t.context,l=new Ie(t.context.gl.LEQUAL,Ie.ReadWrite,t.depthRangeFor3D),c=t.transform,u=e.mesh,h=u.material,d=h.pbrMetallicRoughness,p=t.style.fog;let _;_=t.transform.projection.zAxisUnit==="pixels"?[...e.nodeModelMatrix]:st.multiply([],n.zScaleMatrix,e.nodeModelMatrix),st.multiply(_,n.negCameraPosMatrix,_);const g=st.invert([],_);st.transpose(g,g);const y=i.paint.get("model-emissive-strength").constantOr(0),x=x_(new Float32Array(e.worldViewProjection),new Float32Array(_),new Float32Array(g),t,s,d.baseColorFactor,h.emissiveFactor,d.metallicFactor,d.roughnessFactor,h,y,i),b={defines:[]},M=[];w_(b.defines,M,u,t);const E=t.shadowRenderer;E&&(E.useNormalOffset=!1);let T=null;if(p){const z=kw(e.nodeModelMatrix,t.transform);if(T=new Float32Array(z),c.projection.name!=="globe"){const L=u.aabb.min,R=u.aabb.max,[N,U]=p.getOpacityForBounds(z,L[0],L[1],R[0],R[1]);b.overrideFog=N>=Oa||U>=Oa}}const S=Ul(t,i.paint.get("model-cutoff-fade-range"));S.shouldRenderCutoff&&b.defines.push("RENDER_CUTOFF");const D=t.getOrCreateProgram("model",b);t.uploadCommonUniforms(a,D,null,T,S),t.renderPass!=="shadow"&&E&&E.setupShadowsFromMatrix(e.nodeModelMatrix,D),D.draw(t,a.gl.TRIANGLES,l,r,o,u.material.doubleSided?ti.disabled:ti.backCCW,x,i.id,u.vertexBuffer,u.indexBuffer,u.segments,i.paint,t.transform.zoom,void 0,M)}function zw(e,t,i,n,r,o,s){let a;a=e.projection.name==="globe"?Sx(i,e):[...i],st.multiply(a,a,t.matrix);const l=st.multiply([],n,a);if(t.meshes)for(const c of t.meshes){if(c.material.alphaMode!=="BLEND"){s.push({mesh:c,depth:0,modelIndex:r,worldViewProjection:l,nodeModelMatrix:a});continue}const u=Z.transformMat4([],c.centroid,l);u[2]>0&&o.push({mesh:c,depth:u[2],modelIndex:r,worldViewProjection:l,nodeModelMatrix:a})}if(t.children)for(const c of t.children)zw(e,c,i,n,r,o,s)}function T_(e,t,i,n){const r=i.shadowRenderer;if(!r)return;const o=r.getShadowPassDepthMode(),s=r.getShadowPassColorMode(),a=r.calculateShadowPassMatrixFromMatrix(t),l=Mw(a);i.getOrCreateProgram("modelDepth",{defines:["DEPTH_TEXTURE"]}).draw(i,i.context.gl.TRIANGLES,o,Ke.disabled,s,ti.backCCW,l,n.id,e.vertexBuffer,e.indexBuffer,e.segments,n.paint,i.transform.zoom,void 0,void 0)}function iD(e,t,i){const n=t.updateZoomBasedPaintProperties(),r=function(o,s,a){let l,c,u,h=o.terrain?o.terrain.exaggeration():0;if(o.terrain&&h>0){const d=o.terrain,p=d.findDEMTileFor(a);p&&p.dem?l=Cl.create(d,a,p):h=0}if(h===0&&(s.terrainElevationMin=0,s.terrainElevationMax=0),h===s.validForExaggeration&&(h===0||l&&l._demTile&&l._demTile.tileID===s.validForDEMTile.id&&l._dem._timestamp===s.validForDEMTile.timestamp))return!1;for(const d in s.instancesPerModel){const p=s.instancesPerModel[d];for(let _=0;_<p.instancedDataArray.length;++_){const g=(l?h*l.getElevationAt(0|p.instancedDataArray.float32[16*_],0|p.instancedDataArray.float32[16*_+1],!0,!0):0)+p.instancesEvaluatedElevation[_];p.instancedDataArray.float32[16*_+6]=g,c=c?Math.min(s.terrainElevationMin,g):g,u=u?Math.max(s.terrainElevationMax,g):g}}return s.terrainElevationMin=c||0,s.terrainElevationMax=u||0,s.validForExaggeration=h,s.validForDEMTile=l&&l._demTile?{id:l._demTile.tileID,timestamp:l._dem._timestamp}:{id:void 0,timestamp:0},!0}(e,t,i);(n||r)&&(t.uploaded=!1,t.upload(e.context))}const Bo={shadowUniformsInitialized:!1,useSingleShadowCascade:!1,tileMatrix:new Float64Array(16),shadowTileMatrix:new Float32Array(16),aabb:new en([0,0,0],[pt,pt,0])};function nD(e,t){const i=1<<e.canonical.z,n=t.getFreeCameraOptions().position,r=t.elevation,o=e.canonical.x/i,s=(e.canonical.x+1)/i,a=e.canonical.y/i,l=(e.canonical.y+1)/i;let c=t._centerAltitude;if(r){const p=r.getMinMaxForTile(e);p&&p.max>c&&(c=p.max)}const u=Lt(n.x,o,s)-n.x,h=Lt(n.y,a,l)-n.y,d=Gi(c,t.center.lat)-n.z;return t._zoomFromMercatorZ(Math.sqrt(u*u+h*h+d*d))}function Lw(e,t,i,n,r,o,s){const a=e.context,l=e.renderPass==="shadow",c=e.shadowRenderer,u=l&&c?c.getShadowPassDepthMode():new Ie(a.gl.LEQUAL,Ie.ReadWrite,e.depthRangeFor3D),h=e.isTileAffectedByFog(o);if(i.meshes)for(const d of i.meshes){const p=["MODEL_POSITION_ON_GPU"],_=[];let g,y,x;n.instancedDataArray.length>20&&p.push("INSTANCED_ARRAYS");const b=Ul(e,t.paint.get("model-cutoff-fade-range"));if(b.shouldRenderCutoff&&p.push("RENDER_CUTOFF"),l&&c)g=e.getOrCreateProgram("modelDepth",{defines:p}),y=Mw(s.shadowTileMatrix,s.shadowTileMatrix,Float32Array.from(i.matrix)),x=c.getShadowPassColorMode();else{w_(p,_,d,e),g=e.getOrCreateProgram("model",{defines:p,overrideFog:h});const E=d.material,T=E.pbrMetallicRoughness,S=t.paint.get("model-opacity"),D=t.paint.get("model-emissive-strength").constantOr(0);y=x_(o.expandedProjMatrix,Float32Array.from(i.matrix),new Float32Array(16),e,S,T.baseColorFactor,E.emissiveFactor,T.metallicFactor,T.roughnessFactor,E,D,t,r),c&&(s.shadowUniformsInitialized?g.setShadowUniformValues(a,c.getShadowUniformValues()):(c.setupShadows(o.toUnwrapped(),g,"model-tile",o.overscaledZ),s.shadowUniformsInitialized=!0)),x=b.shouldRenderCutoff||S<1||E.alphaMode!=="OPAQUE"?Ti.alphaBlended:Ti.unblended}e.uploadCommonUniforms(a,g,o.toUnwrapped(),null,b);const M=d.material.doubleSided?ti.disabled:ti.backCCW;if(n.instancedDataArray.length>20)_.push(n.instancedDataBuffer),g.draw(e,a.gl.TRIANGLES,u,Ke.disabled,x,M,y,t.id,d.vertexBuffer,d.indexBuffer,d.segments,t.paint,e.transform.zoom,void 0,_,n.instancedDataArray.length);else{const E=l?"u_instance":"u_normal_matrix";for(let T=0;T<n.instancedDataArray.length;++T)y[E]=new Float32Array(n.instancedDataArray.arrayBuffer,64*T,16),g.draw(e,a.gl.TRIANGLES,u,Ke.disabled,x,M,y,t.id,d.vertexBuffer,d.indexBuffer,d.segments,t.paint,e.transform.zoom,void 0,_)}}if(i.children)for(const d of i.children)Lw(e,t,d,n,r,o,s)}const rD=[1,-1,1];function oD(e,t,i,n){if(!i.modelManager)return!0;const r=i.modelManager;if(!i.shadowRenderer)return!0;const o=i.shadowRenderer,s=t.aabb;let a=!0,l=e.maxHeight;if(l===0){let u=0;for(const h in e.instancesPerModel){const d=r.getModel(h,n);d?u=Math.max(u,Math.max(Math.max(d.aabb.max[0],d.aabb.max[1]),d.aabb.max[2])):a=!1}l=e.maxScale*u*1.41+e.maxVerticalOffset,a&&(e.maxHeight=l)}s.max[2]=l,s.min[2]+=e.terrainElevationMin,s.max[2]+=e.terrainElevationMax,Z.transformMat4(s.min,s.min,t.tileMatrix),Z.transformMat4(s.max,s.max,t.tileMatrix);const c=s.intersects(o.getCurrentCascadeFrustum());return i.currentShadowCascade===0&&(e.isInsideFirstShadowMapFrustum=c===2),c===0}class sD{}class aD{constructor(){this._storage=new Map}getLinesFromTrianglesBuffer(t,i,n){{const h=this._storage.get(i.id);if(h)return h.lastUsedFrameIdx=t,h.buf}const r=n.gl,o=r.getBufferParameter(r.ELEMENT_ARRAY_BUFFER,r.BUFFER_SIZE),s=new ArrayBuffer(o),a=new Int16Array(s);r.getBufferSubData(r.ELEMENT_ARRAY_BUFFER,0,new Int16Array(s));const l=new Os;for(let h=0;h<o/2;h+=3){const d=a[h],p=a[h+1],_=a[h+2];l.emplaceBack(d,p),l.emplaceBack(p,_),l.emplaceBack(_,d)}const c=n.bindVertexArrayOES.current,u=new sD;return u.buf=new Qs(n,l),u.lastUsedFrameIdx=t,this._storage.set(i.id,u),n.bindVertexArrayOES.set(c),u.buf}update(t){for(const[i,n]of this._storage)t-n.lastUsedFrameIdx>30&&(n.buf.destroy(),this._storage.delete(i))}destroy(){for(const[t,i]of this._storage)i.buf.destroy(),this._storage.delete(t)}}const Rw={symbol:function(e,t,i,n,r){if(e.renderPass!=="translucent")return;const o=Ke.disabled,s=e.colorModeForRenderPass();i.layout.get("text-variable-anchor")&&function(a,l,c,u,h,d,p){const _=l.transform,g=h==="map",y=d==="map";for(const x of a){const b=u.getTile(x),M=b.getBucket(c);if(!M||!M.text||!M.text.segments.get().length)continue;const E=ko(M.textSizeData,_.zoom),T=f_(x,M.getProjection(),_),S=_.calculatePixelsToTileUnitsMatrix(b),D=td(T,b.tileID.canonical,y,g,_,M.getProjection(),S),z=M.hasIconTextFit()&&M.hasIconData();if(E){const L=Math.pow(2,_.zoom-b.tileID.overscaledZ);OC(M,g,y,p,rA,_,D,x,L,E,z)}}}(n,e,i,t,i.layout.get("text-rotation-alignment"),i.layout.get("text-pitch-alignment"),r),i.paint.get("icon-opacity").constantOr(1)!==0&&Aw(e,t,i,n,!1,i.paint.get("icon-translate"),i.paint.get("icon-translate-anchor"),i.layout.get("icon-rotation-alignment"),i.layout.get("icon-pitch-alignment"),i.layout.get("icon-keep-upright"),i.paint.get("icon-color-saturation"),o,s),i.paint.get("text-opacity").constantOr(1)!==0&&Aw(e,t,i,n,!0,i.paint.get("text-translate"),i.paint.get("text-translate-anchor"),i.layout.get("text-rotation-alignment"),i.layout.get("text-pitch-alignment"),i.layout.get("text-keep-upright"),i.paint.get("icon-color-saturation"),o,s),t.map.showCollisionBoxes&&(Ew(e,t,i,n,i.paint.get("text-translate"),i.paint.get("text-translate-anchor"),!0),Ew(e,t,i,n,i.paint.get("icon-translate"),i.paint.get("icon-translate-anchor"),!1))},circle:function(e,t,i,n){if(e.renderPass!=="translucent")return;const r=i.paint.get("circle-opacity"),o=i.paint.get("circle-stroke-width"),s=i.paint.get("circle-stroke-opacity"),a=i.layout.get("circle-sort-key").constantOr(1)!==void 0,l=i.paint.get("circle-emissive-strength");if(r.constantOr(1)===0&&(o.constantOr(1)===0||s.constantOr(1)===0))return;const c=e.context,u=c.gl,h=e.transform,d=e.depthModeForSublayer(0,Ie.ReadOnly),p=Ke.disabled,_=e.colorModeForDrapableLayerRenderPass(l),g=h.projection.name==="globe",y=[Fn(h.center.lng),jn(h.center.lat)],x=[];for(let M=0;M<n.length;M++){const E=n[M],T=t.getTile(E),S=T.getBucket(i);if(!S||S.projection.name!==h.projection.name)continue;const D=S.programConfigurations.get(i.id),z=K1(i),L=e.isTileAffectedByFog(E);g&&z.push("PROJECTION_GLOBE_VIEW");const R=e.getOrCreateProgram("circle",{config:D,defines:z,overrideFog:L}),N=S.layoutVertexBuffer,U=S.globeExtVertexBuffer,H=S.indexBuffer,O=h.projection.createInversionMatrix(h,E.canonical),X={programConfiguration:D,program:R,layoutVertexBuffer:N,globeExtVertexBuffer:U,indexBuffer:H,uniformValues:JE(e,E,T,O,y,i),tile:T};if(a){const K=S.segments.get();for(const ot of K)x.push({segments:new Fi([ot]),sortKey:ot.sortKey,state:X})}else x.push({segments:S.segments,sortKey:0,state:X})}a&&x.sort((M,E)=>M.sortKey-E.sortKey);const b={useDepthForOcclusion:h.depthOcclusionForSymbolsAndCircles};for(const M of x){const{programConfiguration:E,program:T,layoutVertexBuffer:S,globeExtVertexBuffer:D,indexBuffer:z,uniformValues:L,tile:R}=M.state,N=M.segments;e.terrain&&e.terrain.setupElevationDraw(R,T,b),e.uploadCommonUniforms(c,T,R.tileID.toUnwrapped()),T.draw(e,u.TRIANGLES,d,p,_,ti.disabled,L,i.id,S,z,N,i.paint,h.zoom,E,[D])}},heatmap:function(e,t,i,n){if(i.paint.get("heatmap-opacity")!==0)if(e.renderPass==="offscreen"){const r=e.context,o=r.gl,s=Ke.disabled,a=new Ti([o.ONE,o.ONE,o.ONE,o.ONE],Ye.transparent,[!0,!0,!0,!0]);(function(p,_,g,y){const x=p.gl,b=_.width*y,M=_.height*y;p.activeTexture.set(x.TEXTURE1),p.viewport.set([0,0,b,M]);let E=g.heatmapFbo;if(!E||E&&(E.width!==b||E.height!==M)){E&&E.destroy();const T=x.createTexture();x.bindTexture(x.TEXTURE_2D,T),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_WRAP_S,x.CLAMP_TO_EDGE),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_WRAP_T,x.CLAMP_TO_EDGE),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_MIN_FILTER,x.LINEAR),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_MAG_FILTER,x.LINEAR),E=g.heatmapFbo=p.createFramebuffer(b,M,!0,null),function(S,D,z,L,R,N){const U=S.gl;U.texImage2D(U.TEXTURE_2D,0,S.extRenderToTextureHalfFloat?U.RGBA16F:U.RGBA,R,N,0,U.RGBA,S.extRenderToTextureHalfFloat?U.HALF_FLOAT:U.UNSIGNED_BYTE,null),L.colorAttachment.set(z)}(p,0,T,E,b,M)}else x.bindTexture(x.TEXTURE_2D,E.colorAttachment.get()),p.bindFramebuffer.set(E.framebuffer)})(r,e,i,e.transform.projection.name==="globe"?.5:.25),r.clear({color:Ye.transparent});const l=e.transform,c=l.projection.name==="globe",u=c?["PROJECTION_GLOBE_VIEW"]:[],h=c?ti.frontCCW:ti.disabled,d=[Fn(l.center.lng),jn(l.center.lat)];for(let p=0;p<n.length;p++){const _=n[p];if(t.hasRenderableParent(_))continue;const g=t.getTile(_),y=g.getBucket(i);if(!y||y.projection.name!==l.projection.name)continue;const x=e.isTileAffectedByFog(_),b=y.programConfigurations.get(i.id),M=e.getOrCreateProgram("heatmap",{config:b,defines:u,overrideFog:x}),{zoom:E}=e.transform;e.terrain&&e.terrain.setupElevationDraw(g,M),e.uploadCommonUniforms(r,M,_.toUnwrapped());const T=l.projection.createInversionMatrix(l,_.canonical);M.draw(e,o.TRIANGLES,Ie.disabled,s,a,h,AC(e,_,g,T,d,E,i.paint.get("heatmap-intensity")),i.id,y.layoutVertexBuffer,y.indexBuffer,y.segments,i.paint,e.transform.zoom,b,c?[y.globeExtVertexBuffer]:null)}r.viewport.set([0,0,e.width,e.height])}else e.renderPass==="translucent"&&(e.context.setColorMode(e.colorModeForRenderPass()),function(r,o){const s=r.context,a=s.gl,l=o.heatmapFbo;if(!l)return;s.activeTexture.set(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,l.colorAttachment.get()),s.activeTexture.set(a.TEXTURE1);let c=o.colorRampTexture;c||(c=o.colorRampTexture=new mn(s,o.colorRamp,a.RGBA)),c.bind(a.LINEAR,a.CLAMP_TO_EDGE),r.getOrCreateProgram("heatmapTexture").draw(r,a.TRIANGLES,Ie.disabled,Ke.disabled,r.colorModeForRenderPass(),ti.disabled,((u,h,d,p)=>({u_image:0,u_color_ramp:1,u_opacity:h.paint.get("heatmap-opacity")}))(0,o),o.id,r.viewportBuffer,r.quadTriangleIndexBuffer,r.viewportSegments,o.paint,r.transform.zoom)}(e,i))},line:function(e,t,i,n){if(e.renderPass!=="translucent")return;const r=i.paint.get("line-opacity"),o=i.paint.get("line-width");if(r.constantOr(1)===0||o.constantOr(1)===0)return;const s=i.paint.get("line-emissive-strength"),a=e.depthModeForSublayer(0,Ie.ReadOnly),l=e.colorModeForDrapableLayerRenderPass(s),c=e.terrain&&e.terrain.renderingToTexture?1:ke.devicePixelRatio,u=i.paint.get("line-dasharray"),h=u.constantOr(1),d=i.layout.get("line-cap"),p=i.paint.get("line-pattern"),_=p.constantOr(1),g=i.paint.get("line-pattern").constantOr(1),y=i.paint.get("line-opacity").constantOr(1)!==1;let x=!g&&y;const b=i.paint.get("line-gradient"),M=_?"linePattern":"line",E=e.context,T=E.gl,S=rb(i);e.terrain&&e.terrain.clipOrMaskOverlapStencilType()&&(x=!1);for(const D of n){const z=t.getTile(D);if(_&&!z.patternsLoaded())continue;const L=z.getBucket(i);if(!L)continue;e.prepareDrawTile();const R=L.programConfigurations.get(i.id),N=e.isTileAffectedByFog(D),U=e.getOrCreateProgram(M,{config:R,defines:S,overrideFog:N}),H=p.constantOr(null);if(H&&z.imageAtlas){const ut=z.imageAtlas.patternPositions[H.toString()];ut&&R.setConstantPatternPositions(ut)}const O=u.constantOr(null),X=d.constantOr(null);if(!_&&O&&X&&z.lineAtlas){const ut=z.lineAtlas.getDash(O,X);ut&&R.setConstantPatternPositions(ut)}let[K,ot]=i.paint.get("line-trim-offset");(X==="round"||X==="square")&&K!==ot&&(K===0&&(K-=1),ot===1&&(ot+=1));const $=e.terrain?D.projMatrix:null,Y=_?nI(e,z,i,$,c):iI(e,z,i,$,L.lineClipsArray.length,c,[K,ot]);if(b){const ut=L.gradients[i.id];let ct=ut.texture;if(i.gradientVersion!==ut.version){let bt=256;if(i.stepInterpolant){const Mt=t.getSource().maxzoom,Et=D.canonical.z===Mt?Math.ceil(1<<e.transform.maxZoom-D.canonical.z):1;bt=Lt(Oe(L.maxLineLength/pt*1024*Et),256,E.maxTextureSize)}ut.gradient=xh({expression:i.gradientExpression(),evaluationKey:"lineProgress",resolution:bt,image:ut.gradient||void 0,clips:L.lineClipsArray}),ut.texture?ut.texture.update(ut.gradient):ut.texture=new mn(E,ut.gradient,T.RGBA),ut.version=i.gradientVersion,ct=ut.texture}E.activeTexture.set(T.TEXTURE1),ct.bind(i.stepInterpolant?T.NEAREST:T.LINEAR,T.CLAMP_TO_EDGE)}h&&(E.activeTexture.set(T.TEXTURE0),z.lineAtlasTexture&&z.lineAtlasTexture.bind(T.LINEAR,T.REPEAT),R.updatePaintBuffers()),_&&(E.activeTexture.set(T.TEXTURE0),z.imageAtlasTexture&&z.imageAtlasTexture.bind(T.LINEAR,T.CLAMP_TO_EDGE),R.updatePaintBuffers()),e.uploadCommonUniforms(E,U,D.toUnwrapped());const at=ut=>{U.draw(e,T.TRIANGLES,a,ut,l,ti.disabled,Y,i.id,L.layoutVertexBuffer,L.indexBuffer,L.segments,i.paint,e.transform.zoom,R,[L.layoutVertexBuffer2])};if(x){const ut=e.stencilModeForClipping(D).ref;ut===0&&e.terrain&&E.clear({stencil:0});const ct={func:T.EQUAL,mask:255};Y.u_alpha_discard_threshold=.8,at(new Ke(ct,ut,255,T.KEEP,T.KEEP,T.INVERT)),Y.u_alpha_discard_threshold=0,at(new Ke(ct,ut,255,T.KEEP,T.KEEP,T.KEEP))}else at(e.stencilModeForClipping(D))}x&&(e.resetStencilClippingMasks(),e.terrain&&E.clear({stencil:0}))},fill:function(e,t,i,n){const r=i.paint.get("fill-color"),o=i.paint.get("fill-opacity");if(o.constantOr(1)===0)return;const s=i.paint.get("fill-emissive-strength"),a=e.colorModeForDrapableLayerRenderPass(s),l=i.paint.get("fill-pattern"),c=e.opaquePassEnabledForLayer()&&!l.constantOr(1)&&r.constantOr(Ye.transparent).a===1&&o.constantOr(0)===1?"opaque":"translucent";if(e.renderPass===c){const u=e.depthModeForSublayer(1,e.renderPass==="opaque"?Ie.ReadWrite:Ie.ReadOnly);Iw(e,t,i,n,u,a,!1)}if(e.renderPass==="translucent"&&i.paint.get("fill-antialias")){const u=e.depthModeForSublayer(i.getPaintProperty("fill-outline-color")?2:0,Ie.ReadOnly);Iw(e,t,i,n,u,a,!0)}},"fill-extrusion":function(e,t,i,n){const r=i.paint.get("fill-extrusion-opacity"),o=e.context,s=o.gl,a=e.terrain,l=a&&a.renderingToTexture,c=i.paint.get("fill-extrusion-cutoff-fade-range");if(r===0)return;const u=e.conflationActive&&e.layerUsedInConflation(i,t.getSource());if(u&&function(h,d,p,_){for(const g of _){const y=d.getTile(g).getBucket(p);y&&(y.updateReplacement(g,h.replacementSource),y.uploadCentroid(h.context))}}(e,t,i,n),a||u)for(const h of n){const d=t.getTile(h).getBucket(i);d&&FC(e.context,t,h,d,i,a,u)}if(e.renderPass==="shadow"&&e.shadowRenderer){const h=e.shadowRenderer;if(a&&r<.65&&i._transitionablePaint._values["fill-extrusion-opacity"].value.expression instanceof ks)return;const d=h.getShadowPassDepthMode(),p=h.getShadowPassColorMode();bd(e,t,i,n,d,Ke.disabled,p,u)}else if(e.renderPass==="translucent"){const h=!i.paint.get("fill-extrusion-pattern").constantOr(1);if(!l){const d=new Ie(e.context.gl.LEQUAL,Ie.ReadWrite,e.depthRangeFor3D);c===0&&r===1&&h?bd(e,t,i,n,d,Ke.disabled,Ti.unblended,u):(bd(e,t,i,n,d,Ke.disabled,Ti.disabled,u),bd(e,t,i,n,d,e.stencilModeFor3D(),e.colorModeForRenderPass(),u),e.resetStencilClippingMasks())}if(e.style.enable3dLights()&&h&&(!a&&e.transform.projection.name!=="globe"||l)){const d=i.paint.get("fill-extrusion-opacity"),p=i.paint.get("fill-extrusion-ambient-occlusion-intensity"),_=i.paint.get("fill-extrusion-ambient-occlusion-ground-radius"),g=i.paint.get("fill-extrusion-flood-light-intensity"),y=i.paint.get("fill-extrusion-flood-light-color").toArray01().slice(0,3),x=p>0&&_>0,b=g>0,M=(T,S,D)=>(1-D)*T+D*S,E=T=>{const S=e.depthModeForSublayer(1,Ie.ReadOnly,s.LEQUAL,!0),D=i.paint.get(T?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),z=M(.1,3,D),L=e._showOverdrawInspector;if(!L){const R=new Ke({func:s.ALWAYS,mask:255},255,255,s.KEEP,s.KEEP,s.REPLACE),N=new Ti([s.ONE,s.ONE,s.ONE,s.ONE],Ye.transparent,[!1,!1,!1,!0],s.MIN);jl(e,t,i,n,S,R,N,ti.disabled,T,"sdf",d,p,_,g,y,z,u,!1)}{const R=L?Ke.disabled:new Ke({func:s.EQUAL,mask:255},255,255,s.KEEP,s.DECR,s.DECR),N=L?e.colorModeForRenderPass():new Ti([s.ONE_MINUS_DST_ALPHA,s.DST_ALPHA,s.ONE,s.ONE],Ye.transparent,[!0,!0,!0,!0]);jl(e,t,i,n,S,R,N,ti.disabled,T,"color",d,p,_,g,y,z,u,!1)}};if(l){const T=(S,D,z)=>{const L=e.depthModeForSublayer(1,Ie.ReadOnly,s.LEQUAL,!1),R=i.paint.get(S?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),N=M(.1,3,R);{const U=new Ti([s.ONE,s.ONE,s.ONE,s.ONE],Ye.transparent,[!1,!1,!1,!0]);jl(e,t,i,n,L,Ke.disabled,U,ti.disabled,S,"clear",d,p,_,g,y,N,u,D)}{const U=new Ke({func:s.ALWAYS,mask:255},255,255,s.KEEP,s.KEEP,s.REPLACE),H=new Ti([s.ONE,s.ONE,s.ONE,s.ONE],Ye.transparent,[!1,!1,!1,!0],s.MIN);jl(e,t,i,n,L,U,H,ti.disabled,S,"sdf",d,p,_,g,y,N,u,D)}{const U=S?s.ZERO:s.ONE_MINUS_DST_ALPHA,H=new Ke({func:s.EQUAL,mask:255},255,255,s.KEEP,s.DECR,s.DECR),O=new Ti([U,s.DST_ALPHA,s.ONE_MINUS_DST_ALPHA,s.ZERO],Ye.transparent,[!0,!0,!0,!0]);jl(e,t,i,n,L,H,O,ti.disabled,S,"color",d,p,_,g,y,N,u,D)}{const U=new Ti([s.ONE,s.ONE,s.ONE,S?s.ZERO:s.ONE],Ye.transparent,[!1,!1,!1,!0],S?s.FUNC_ADD:s.MAX);jl(e,t,i,n,L,Ke.disabled,U,ti.disabled,S,"clear",d,p,_,g,y,N,u,D,z)}};if(x||b){let S;if(e.prepareDrawTile(),a){const D=a.drapeBufferSize[0],z=a.drapeBufferSize[1];S=a.framebufferCopyTexture,S&&(!S||S.size[0]===D&&S.size[1]===z)||(S&&S.destroy(),S=a.framebufferCopyTexture=new mn(o,new Ln({width:D,height:z}),s.RGBA)),S.bind(s.LINEAR,s.CLAMP_TO_EDGE),s.copyTexImage2D(s.TEXTURE_2D,0,s.RGBA,0,0,D,z,0)}x&&T(!0,!1,S),b&&T(!1,!0,S)}}else x&&E(!0),b&&E(!1)}}},hillshade:function(e,t,i,n){if(e.renderPass!=="offscreen"&&e.renderPass!=="translucent"||e.style.disableElevatedTerrain)return;const r=e.context,o=e.terrain&&e.terrain.renderingToTexture,[s,a]=e.renderPass!=="translucent"||o?[{},n]:e.stencilConfigForOverlap(n);for(const l of a){const c=t.getTile(l);if(c.needsHillshadePrepare&&e.renderPass==="offscreen")dC(e,c,i);else if(e.renderPass==="translucent"){const u=e.depthModeForSublayer(0,Ie.ReadOnly),h=i.paint.get("hillshade-emissive-strength"),d=e.colorModeForDrapableLayerRenderPass(h),p=o&&e.terrain?e.terrain.stencilModeForRTTOverlap(l):s[l.overscaledZ];hC(e,l,c,i,u,p,d)}}r.viewport.set([0,0,e.width,e.height]),e.resetStencilClippingMasks()},raster:function(e,t,i,n,r,o){if(e.renderPass!=="translucent"||i.paint.get("raster-opacity")===0)return;const s=e.context,a=s.gl,l=t.getSource(),c=function(D,z,L){const R=D.paint.get("raster-color"),N=[],U=D.paint.get("raster-resampling"),H=D.paint.get("raster-color-mix"),O=D.paint.get("raster-color-range"),X=[H[0],H[1],H[2],0],K=H[3],ot=U==="nearest"?L.NEAREST:L.LINEAR;if(R&&N.push("RASTER_COLOR"),R){z.activeTexture.set(L.TEXTURE2);let $=D.colorRampTexture;$||($=D.colorRampTexture=new mn(z,D.colorRamp,L.RGBA)),$.bind(L.LINEAR,L.CLAMP_TO_EDGE)}return{mix:X,range:O,offset:K,defines:N,resampling:ot}}(i,s,a),u=c.defines,h=e.transform.projection.name==="globe";let d=!1;if(l instanceof to&&!n.length){if(!h)return;if(l.onNorthPole)d=!0,u.push("GLOBE_POLES");else{if(!l.onSouthPole)return;d=!0,u.push("GLOBE_POLES")}}const p=i.paint.get("raster-emissive-strength"),_=e.colorModeForDrapableLayerRenderPass(p),g=e.terrain&&e.terrain.renderingToTexture,y=l instanceof to&&i.paint.get("raster-elevation")!==0,x=!e.options.moving,b=i.paint.get("raster-resampling")==="nearest"?a.NEAREST:a.LINEAR;if(d){const D=t.getSource();if(!(D instanceof to))return;const z=D.texture;if(!z)return;const L=e.globeSharedBuffers;if(!L)return;const R=new Ie(a.LEQUAL,Ie.ReadWrite,e.depthRangeFor3D),N=Float32Array.from(e.transform.expandedFarZProjMatrix);let U=L1(0,0,e.transform);const H=Float32Array.from(js(Fr(new Yr(0,0,0)))),O={opacity:1,mix:0};e.terrain&&e.terrain.prepareDrawTile(),s.activeTexture.set(a.TEXTURE0),z.bind(b,a.CLAMP_TO_EDGE),s.activeTexture.set(a.TEXTURE1),z.bind(b,a.CLAMP_TO_EDGE),z.useMipmap&&s.extTextureFilterAnisotropic&&e.transform.pitch>20&&a.texParameterf(a.TEXTURE_2D,s.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,s.extTextureFilterAnisotropicMax);const[X,K,ot,$]=L.getPoleBuffers(0,!0);let Y;D.onNorthPole?(Y=X,e.renderDefaultNorthPole=!1):(U=st.scale(st.create(),U,[1,-1,1]),Y=K,e.renderDefaultSouthPole=!1);const at=((ct,bt,Mt,Et,ft,kt,Qt,te,oe,ce,Ce,ge)=>vw(ct,bt,Mt,new Float32Array(16),new Float32Array(9),[0,0],[0,0,0,0],0,[0,0],[0,0,0,0],1,Et,ft,kt||[0,0],Qt,2,oe,ce,Ce,1,0,ge))(N,H,U,O,i,D.perspectiveTransform||[0,0],i.paint.get("raster-elevation"),0,c.mix,c.offset,c.range,p),ut=e.getOrCreateProgram("raster",{defines:c.defines});return e.uploadCommonUniforms(s,ut,null),void ut.draw(e,a.TRIANGLES,R,Ke.disabled,_,ti.disabled,at,i.id,Y,ot,$)}if(!n.length)return;const[M,E]=l instanceof to||g?[{},n]:e.stencilConfigForOverlap(n),T=E[E.length-1].overscaledZ,S=y&&h;S&&c.defines.push("PROJECTION_GLOBE_VIEW"),y&&c.defines.push("RENDER_CUTOFF");for(const D of E){const z=D.toUnwrapped(),L=t.getTile(D);if(g&&(!L||!L.hasData())||!L.texture)continue;let R,N;g?(R=Ie.disabled,N=D.projMatrix):y?(R=new Ie(a.LEQUAL,Ie.ReadWrite,e.depthRangeFor3D),N=h?Float32Array.from(e.transform.expandedFarZProjMatrix):e.transform.calculateProjMatrix(z,x)):(R=e.depthModeForSublayer(D.overscaledZ-T,i.paint.get("raster-opacity")===1?Ie.ReadWrite:Ie.ReadOnly,a.LESS),N=e.transform.calculateProjMatrix(z,x));const U=e.terrain&&g?e.terrain.stencilModeForRTTOverlap(D):M[D.overscaledZ],H=o?0:i.paint.get("raster-fade-duration");L.registerFadeDuration(H);const O=t.findLoadedParent(D,0),X=hw(L,O,t,e.transform,H);let K,ot;e.terrain&&e.terrain.prepareDrawTile(),s.activeTexture.set(a.TEXTURE0),L.texture&&L.texture.bind(b,a.CLAMP_TO_EDGE),s.activeTexture.set(a.TEXTURE1),O?(O.texture&&O.texture.bind(b,a.CLAMP_TO_EDGE),K=Math.pow(2,O.tileID.overscaledZ-L.tileID.overscaledZ),ot=[L.tileID.canonical.x*K%1,L.tileID.canonical.y*K%1]):L.texture&&L.texture.bind(b,a.CLAMP_TO_EDGE),L.texture&&L.texture.useMipmap&&s.extTextureFilterAnisotropic&&e.transform.pitch>20&&a.texParameterf(a.TEXTURE_2D,s.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,s.extTextureFilterAnisotropicMax);const $=e.transform,Y=l instanceof to?l.perspectiveTransform:[0,0],at=y?GC($):[0,0,0,0];let ut,ct,bt,Mt,Et,ft;if(S&&l instanceof to&&l.coordinates.length>3){ut=Float32Array.from(js(Fr(new Yr(0,0,0)))),ct=Float32Array.from($.globeMatrix),bt=Float32Array.from(z1($)),Mt=[Fn($.center.lng),jn($.center.lat)],ft=[Fn(l.coordinates[1][0]),jn(l.coordinates[1][1]),Fn(l.coordinates[3][0]),jn(l.coordinates[3][1])];const oe=new Er(l.coordinates[1],l.coordinates[3]);Et=Float32Array.from(O1(new Yr(0,0,0),oe,0,$.worldSize/e.transform._pixelsPerMercatorPixel))}else ut=new Float32Array(16),ct=new Float32Array(9),bt=new Float32Array(16),Mt=[0,0],Et=new Float32Array(16),ft=[0,0,0,0];const kt=vw(N,ut,ct,bt,Et,ot||[0,0],ft,Wn(e.transform.zoom),Mt,at,K||1,X,i,Y,y?i.paint.get("raster-elevation"):0,2,c.mix,c.offset,c.range,1,0,p),Qt=e.isTileAffectedByFog(D),te=e.getOrCreateProgram("raster",{defines:c.defines,overrideFog:Qt});if(e.uploadCommonUniforms(s,te,z),l instanceof to){if(g||!h)l.boundsBuffer&&l.boundsSegments&&te.draw(e,a.TRIANGLES,R,Ke.disabled,_,ti.disabled,kt,i.id,l.boundsBuffer,e.quadTriangleIndexBuffer,l.boundsSegments);else if(e.globeSharedBuffers){const[oe,ce,Ce]=e.globeSharedBuffers.getGridBuffers(0,!1);te.draw(e,a.TRIANGLES,R,Ke.disabled,_,ti.frontCCW,kt,i.id,oe,ce,Ce),te.draw(e,a.TRIANGLES,R,Ke.disabled,_,ti.backCCW,kt,i.id,oe,ce,Ce)}}else{const{tileBoundsBuffer:oe,tileBoundsIndexBuffer:ce,tileBoundsSegments:Ce}=e.getTileBoundsBuffers(L);te.draw(e,a.TRIANGLES,R,U,_,ti.disabled,kt,i.id,oe,ce,Ce)}}e.resetStencilClippingMasks()},background:function(e,t,i,n){const r=i.paint.get("background-color"),o=i.paint.get("background-opacity"),s=i.paint.get("background-emissive-strength");if(o===0)return;const a=e.context,l=a.gl,c=e.transform,u=c.tileSize,h=i.paint.get("background-pattern");if(e.isPatternMissing(h,i.scope))return;const d=!h&&r.a===1&&o===1&&e.opaquePassEnabledForLayer()?"opaque":"translucent";if(e.renderPass!==d)return;const p=Ke.disabled,_=e.depthModeForSublayer(0,d==="opaque"?Ie.ReadWrite:Ie.ReadOnly),g=e.colorModeForDrapableLayerRenderPass(s),y=h?"backgroundPattern":"background";let x,b=n;b||(x=e.getBackgroundTiles(),b=Object.values(x).map(M=>M.tileID)),h&&(a.activeTexture.set(l.TEXTURE0),e.imageManager.bind(e.context,i.scope));for(const M of b){const E=e.isTileAffectedByFog(M),T=e.getOrCreateProgram(y,{overrideFog:E}),S=M.toUnwrapped(),D=n?M.projMatrix:e.transform.calculateProjMatrix(S);e.prepareDrawTile();const z=t?t.getTile(M):x?x[M.key]:new Jc(M,u,c.zoom,e),L=h?zC(D,s,o,e,h,i.scope,{tileID:M,tileSize:u}):kC(D,s,o,r);e.uploadCommonUniforms(a,T,S);const{tileBoundsBuffer:R,tileBoundsIndexBuffer:N,tileBoundsSegments:U}=e.getTileBoundsBuffers(z);T.draw(e,l.TRIANGLES,_,p,g,ti.disabled,L,i.id,R,N,U)}},sky:function(e,t,i){const n=e._atmosphere?Wn(e.transform.zoom):1,r=i.paint.get("sky-opacity")*n;if(r===0)return;const o=e.context,s=i.paint.get("sky-type"),a=new Ie(o.gl.LEQUAL,Ie.ReadOnly,[0,1]),l=e.frameCounter/1e3%1;s==="atmosphere"?e.renderPass==="offscreen"?i.needsSkyboxCapture(e)&&(function(c,u,h,d){const p=c.context,_=p.gl;let g=u.skyboxFbo;if(!g){g=u.skyboxFbo=p.createFramebuffer(32,32,!0,null),u.skyboxGeometry=new Pw(p),u.skyboxTexture=p.gl.createTexture(),_.bindTexture(_.TEXTURE_CUBE_MAP,u.skyboxTexture),_.texParameteri(_.TEXTURE_CUBE_MAP,_.TEXTURE_WRAP_S,_.CLAMP_TO_EDGE),_.texParameteri(_.TEXTURE_CUBE_MAP,_.TEXTURE_WRAP_T,_.CLAMP_TO_EDGE),_.texParameteri(_.TEXTURE_CUBE_MAP,_.TEXTURE_MIN_FILTER,_.LINEAR),_.texParameteri(_.TEXTURE_CUBE_MAP,_.TEXTURE_MAG_FILTER,_.LINEAR);for(let M=0;M<6;++M)_.texImage2D(_.TEXTURE_CUBE_MAP_POSITIVE_X+M,0,_.RGBA,32,32,0,_.RGBA,_.UNSIGNED_BYTE,null)}p.bindFramebuffer.set(g.framebuffer),p.viewport.set([0,0,32,32]);const y=u.getCenter(c,!0),x=c.getOrCreateProgram("skyboxCapture"),b=new Float64Array(16);st.identity(b),st.rotateY(b,b,.5*-Math.PI),Gl(c,u,x,b,y,0),st.identity(b),st.rotateY(b,b,.5*Math.PI),Gl(c,u,x,b,y,1),st.identity(b),st.rotateX(b,b,.5*-Math.PI),Gl(c,u,x,b,y,2),st.identity(b),st.rotateX(b,b,.5*Math.PI),Gl(c,u,x,b,y,3),st.identity(b),Gl(c,u,x,b,y,4),st.identity(b),st.rotateY(b,b,Math.PI),Gl(c,u,x,b,y,5),p.viewport.set([0,0,c.width,c.height])}(e,i),i.markSkyboxValid(e)):e.renderPass==="sky"&&function(c,u,h,d,p){const _=c.context,g=_.gl,y=c.transform,x=c.getOrCreateProgram("skybox");_.activeTexture.set(g.TEXTURE0),g.bindTexture(g.TEXTURE_CUBE_MAP,u.skyboxTexture);const b=((M,E,T,S,D)=>({u_matrix:M,u_sun_direction:E,u_cubemap:0,u_opacity:S,u_temporal_offset:D}))(y.skyboxMatrix,u.getCenter(c,!1),0,d,p);c.uploadCommonUniforms(_,x),x.draw(c,g.TRIANGLES,h,Ke.disabled,c.colorModeForRenderPass(),ti.backCW,b,"skybox",u.skyboxGeometry.vertexBuffer,u.skyboxGeometry.indexBuffer,u.skyboxGeometry.segment)}(e,i,a,r,l):s==="gradient"&&e.renderPass==="sky"&&function(c,u,h,d,p){const _=c.context,g=_.gl,y=c.transform,x=c.getOrCreateProgram("skyboxGradient");u.skyboxGeometry||(u.skyboxGeometry=new Pw(_)),_.activeTexture.set(g.TEXTURE0);let b=u.colorRampTexture;b||(b=u.colorRampTexture=new mn(_,u.colorRamp,g.RGBA)),b.bind(g.LINEAR,g.CLAMP_TO_EDGE);const M=((E,T,S,D,z)=>({u_matrix:E,u_color_ramp:0,u_center_direction:T,u_radius:wt(S),u_opacity:D,u_temporal_offset:z}))(y.skyboxMatrix,u.getCenter(c,!1),u.paint.get("sky-gradient-radius"),d,p);c.uploadCommonUniforms(_,x),x.draw(c,g.TRIANGLES,h,Ke.disabled,c.colorModeForRenderPass(),ti.backCW,M,"skyboxGradient",u.skyboxGeometry.vertexBuffer,u.skyboxGeometry.indexBuffer,u.skyboxGeometry.segment)}(e,i,a,r,l)},debug:function(e,t,i){for(let n=0;n<i.length;n++)XC(e,t,i[n])},custom:function(e,t,i,n){const r=e.context,o=i.implementation;if(!e.transform.projection.unsupportedLayers||!e.transform.projection.unsupportedLayers.includes("custom")||e.terrain&&(e.terrain.renderingToTexture||e.renderPass==="offscreen")&&i.isLayerDraped(t)){if(e.renderPass==="offscreen"){const s=o.prerender;if(s){if(e.setCustomLayerDefaults(),r.setColorMode(e.colorModeForRenderPass()),e.transform.projection.name==="globe"){const a=e.transform.pointMerc;s.call(o,r.gl,e.transform.customLayerMatrix(),e.transform.getProjection(),e.transform.globeToMercatorMatrix(),Wn(e.transform.zoom),[a.x,a.y],e.transform.pixelsPerMeterRatio)}else s.call(o,r.gl,e.transform.customLayerMatrix());r.setDirty(),e.setBaseState()}}else if(e.renderPass==="translucent"){if(e.terrain&&e.terrain.renderingToTexture){const a=o.renderToTile;if(a){const l=n[0].canonical,c=new ui(l.x+n[0].wrap*(1<<l.z),l.y,l.z);r.setDepthMode(Ie.disabled),r.setStencilMode(Ke.disabled),r.setColorMode(e.colorModeForRenderPass()),e.setCustomLayerDefaults(),a.call(o,r.gl,c),r.setDirty(),e.setBaseState()}return}e.setCustomLayerDefaults(),r.setColorMode(e.colorModeForRenderPass()),r.setStencilMode(Ke.disabled);const s=o.renderingMode==="3d"?new Ie(e.context.gl.LEQUAL,Ie.ReadWrite,e.depthRangeFor3D):e.depthModeForSublayer(0,Ie.ReadOnly);if(r.setDepthMode(s),e.transform.projection.name==="globe"){const a=e.transform.pointMerc;o.render(r.gl,e.transform.customLayerMatrix(),e.transform.getProjection(),e.transform.globeToMercatorMatrix(),Wn(e.transform.zoom),[a.x,a.y],e.transform.pixelsPerMeterRatio)}else o.render(r.gl,e.transform.customLayerMatrix());r.setDirty(),e.setBaseState(),r.bindFramebuffer.set(null)}}else J("Custom layers are not yet supported with this projection. Use mercator or globe to enable usage of custom layers.")},model:function(e,t,i,n){if(e.renderPass==="opaque")return;const r=i.paint.get("model-opacity");if(r===0)return;const o=i.paint.get("model-cast-shadows");if(e.renderPass==="shadow"&&(!o||e.terrain&&r<.65&&i._transitionablePaint._values["model-opacity"].value.expression instanceof ks))return;const s=e.shadowRenderer,a=i.paint.get("model-receive-shadows");s&&(s.useNormalOffset=!0,a||(s.enabled=!1));const l=()=>{s&&(s.useNormalOffset=!0,a||(s.enabled=!0))},c=t.getSource();if(e.renderPass==="light-beam"&&c.type!=="batched-model")return;if(c.type==="vector"||c.type==="geojson")return function(x,b,M,E){const T=x.transform;if(T.projection.name!=="mercator")return void J(`Drawing 3D models for ${T.projection.name} projection is not yet implemented`);const S=T.getFreeCameraOptions().position;if(!x.modelManager)return;const D=x.modelManager,z=x.shadowRenderer;if(!M._unevaluatedLayout._values.hasOwnProperty("model-id"))return;const L=M._unevaluatedLayout._values["model-id"],R={...M.layout.get("model-id").parameters};for(const N of E){const U=b.getTile(N).getBucket(M);if(!U||U.projection.name!==T.projection.name)continue;const H=nD(N,T);R.zoom=H;const O=L.possiblyEvaluate(R);if(iD(x,U,N),Bo.shadowUniformsInitialized=!1,Bo.useSingleShadowCascade=!!z&&z.getMaxCascadeForTile(N.toUnwrapped())===0,x.renderPass==="shadow"&&z){if(x.currentShadowCascade===1&&U.isInsideFirstShadowMapFrustum)continue;const ot=T.calculatePosMatrix(N.toUnwrapped(),T.worldSize);if(Bo.tileMatrix.set(ot),Bo.shadowTileMatrix=Float32Array.from(z.calculateShadowPassMatrixFromMatrix(ot)),Bo.aabb.min.fill(0),Bo.aabb.max[0]=Bo.aabb.max[1]=pt,Bo.aabb.max[2]=0,oD(U,Bo,x,M.scope))continue}const X=1<<N.canonical.z,K=[((S.x-N.wrap)*X-N.canonical.x)*pt,(S.y*X-N.canonical.y)*pt,S.z*X*pt];for(let ot in U.instancesPerModel){const $=U.instancesPerModel[ot];$.features.length>0&&(ot=O.evaluate($.features[0].feature,{}));const Y=D.getModel(ot,M.scope);if(Y&&Y.uploaded)for(const at of Y.nodes)Lw(x,M,at,$,K,N,Bo)}}}(e,t,i,n),void l();if(!c.loaded())return;if(c.type==="batched-model")return function(x,b,M,E){const T=x.context,S=x.transform,D=x.style.fog,z=x.shadowRenderer;if(S.projection.name!=="mercator")return void J(`Drawing 3D landmark models for ${S.projection.name} projection is not yet implemented`);const L=x.transform.getFreeCameraOptions().position,R=Z.scale([],[L.x,L.y,L.z],x.transform.worldSize);Z.negate(R,R);const N=st.identity([]),U=qs(S.center.lat,S.zoom),H=st.fromScaling([],[1,1,1/U]);st.translate(N,N,R);const O=M.paint.get("model-opacity"),X=new Ie(T.gl.LEQUAL,Ie.ReadWrite,x.depthRangeFor3D),K=new Ie(T.gl.LEQUAL,Ie.ReadOnly,x.depthRangeFor3D),ot=function($,Y){for(const at of E){const ut=b.getTile(at).getBucket(M);if(!ut||!ut.uploaded)continue;let ct=!1;z&&(ct=z.getMaxCascadeForTile(at.toUnwrapped())===0);const bt=S.calculatePosMatrix(at.toUnwrapped(),S.worldSize),Mt=ut.modelTraits;for(const Et of ut.getNodesInfo()){if(Et.hiddenByReplacement||!Et.node.meshes)continue;const ft=Et.node,kt=x.renderPass==="light-beam",Qt=[...bt],te=Et.evaluatedScale;let oe=0;x.terrain&&ft.elevation&&(oe=ft.elevation*x.terrain.exaggeration()),st.translate(Qt,Qt,[(ft.anchor?ft.anchor[0]:0)*(te[0]-1),(ft.anchor?ft.anchor[1]:0)*(te[1]-1),oe]),te!==O3&&st.scale(Qt,Qt,te),st.multiply(Qt,Qt,ft.matrix);const ce=st.multiply([],H,Qt);st.multiply(ce,N,ce);const Ce=st.invert([],ce);st.transpose(Ce,Ce),st.scale(Ce,Ce,rD);const ge=st.multiply([],S.expandedFarZProjMatrix,Qt);for(let bi=0;bi<ft.meshes.length;++bi){const ni=ft.meshes[bi],De=bi===ft.lightMeshIndex;if(De){if(!kt&&!x.terrain&&x.shadowRenderer){x.currentLayer<x.firstLightBeamLayer&&(x.firstLightBeamLayer=x.currentLayer);continue}}else if(kt)continue;const we={defines:[]},ye=[];w_(we.defines,ye,ni,x),4&Mt||we.defines.push("DIFFUSE_SHADED"),ct&&we.defines.push("SHADOWS_SINGLE_CASCADE");const si=x.renderPass==="shadow";if(si){T_(ni,Qt,x,M);continue}let pi=null;if(D){const Dn=kw(Qt,x.transform);if(pi=new Float32Array(Dn),S.projection.name!=="globe"){const In=ni.aabb.min,sn=ni.aabb.max,[Ri,Jn]=D.getOpacityForBounds(Dn,In[0],In[1],sn[0],sn[1]);we.overrideFog=Ri>=Oa||Jn>=Oa}}const $e=x.getOrCreateProgram("model",we);!si&&z&&(z.useNormalOffset=!!ni.normalBuffer,z.setupShadowsFromMatrix(Qt,$e,z.useNormalOffset)),x.uploadCommonUniforms(T,$e,at.toUnwrapped(),pi);const qi=ni.material,An=qi.pbrMetallicRoughness;An.metallicFactor=.9,An.roughnessFactor=.5;const Ui=0,nn=x_(new Float32Array(ge),new Float32Array(ce),new Float32Array(Ce),x,O,An.baseColorFactor,qi.emissiveFactor,An.metallicFactor,An.roughnessFactor,qi,Ui,M);$e.draw(x,T.gl.TRIANGLES,Y&&!De?X:K,Ke.disabled,$?De||O<1||Et.hasTranslucentParts?Ti.alphaBlended:Ti.unblended:Ti.disabled,ti.backCCW,nn,M.id,ni.vertexBuffer,ni.indexBuffer,ni.segments,M.paint,x.transform.zoom,void 0,ye)}}}};(function($,Y,at,ut){const ct=$.terrain?$.terrain.exaggeration():0,bt=$.transform.zoom;for(const Mt of ut){const Et=Y.getTile(Mt).getBucket(at);Et&&($.conflationActive&&Et.updateReplacement(Mt,$.replacementSource),Et.evaluateScale($,at),$.terrain&&ct>0&&Et.elevationUpdate($.terrain,ct,Mt,at.source),Et.needsReEvaluation($,bt,at)&&Et.evaluate(at))}})(x,b,M,E),O===1?ot(!0,!0):(ot(!1,!0),ot(!0,!1))}(e,t,i,n),void l();const u=c.getModels(),h=[],d=e.transform.getFreeCameraOptions().position,p=Z.scale([],[d.x,d.y,d.z],e.transform.worldSize);Z.negate(p,p);const _=[],g=[];let y=0;for(const x of u){const b=i.paint.get("model-rotation").constantOr(null),M=i.paint.get("model-scale").constantOr(null),E=i.paint.get("model-translation").constantOr(null);x.computeModelMatrix(e,b,M,E,!0,!0,!1);const T=st.identity([]),S=qs(x.position.lat,e.transform.zoom),D=st.fromScaling([],[1,1,1/S]);st.translate(T,T,p),h.push({zScaleMatrix:D,negCameraPosMatrix:T});for(const z of x.nodes)zw(e.transform,z,x.matrix,e.transform.expandedFarZProjMatrix,y,_,g);y++}if(_.sort((x,b)=>b.depth-x.depth),e.renderPass!=="shadow"){if(r===1)for(const x of g)Td(x,e,i,h[x.modelIndex],Ke.disabled,e.colorModeForRenderPass());else{for(const x of g)Td(x,e,i,h[x.modelIndex],Ke.disabled,Ti.disabled);for(const x of g)Td(x,e,i,h[x.modelIndex],e.stencilModeFor3D(),e.colorModeForRenderPass());e.resetStencilClippingMasks()}for(const x of _)Td(x,e,i,h[x.modelIndex],Ke.disabled,e.colorModeForRenderPass());l()}else{for(const x of g)T_(x.mesh,x.nodeModelMatrix,e,i);for(const x of _)T_(x.mesh,x.nodeModelMatrix,e,i);l()}}},Ow={modelUpload:function(e,t,i){const n=t.getSource();if(!n.loaded())return;if(n.type==="vector"||n.type==="geojson")return void(e.modelManager&&e.modelManager.upload(e,i));if(n.type==="batched-model")return;const r=n.getModels();for(const o of r)o.upload(e.context)}};class lD{constructor(t,i,n){this.context=new E3(t,i),this.transform=n,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this.setup(),this.numSublayers=co.maxUnderzooming+co.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.deferredRenderGpuTimeQueries=[],this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={},this.conflationActive=!1,this.replacementSource=new j3,this.longestCutoffRange=0,this.minCutoffZoom=0,this._fogVisible=!1,this._cachedTileFogOpacities={},this._shadowRenderer=new hD(this),this._wireframeDebugCache=new aD,this.renderDefaultNorthPole=!0,this.renderDefaultSouthPole=!0}updateTerrain(t,i){const n=!!t&&!!t.terrain&&this.transform.projection.supportsTerrain;if(!(n||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new _C(this,t));const r=this._terrain;this.transform.elevation=n?r:null,r.update(t,this.transform,i),this.transform.elevation&&!r.enabled&&(this.transform.elevation=null)}_updateFog(t){const i=t.fog;if(!i||this.transform.projection.name==="globe"||i.getOpacity(this.transform.pitch)<1||i.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);const[n,r]=i.getFovAdjustedRange(this.transform._fov);if(n>r)return void(this.transform.fogCullDistSq=null);const o=n+.78*(r-n);this.transform.fogCullDistSq=o*o}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled?this._terrain:null}get shadowRenderer(){return this._shadowRenderer&&this._shadowRenderer.enabled?this._shadowRenderer:null}get wireframeDebugCache(){return this._wireframeDebugCache}resize(t,i){if(this.width=t*ke.devicePixelRatio,this.height=i*ke.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const n of this.style.order)this.style._mergedLayers[n].resize()}setup(){const t=this.context,i=new Tr;i.emplaceBack(0,0),i.emplaceBack(pt,0),i.emplaceBack(0,pt),i.emplaceBack(pt,pt),this.tileExtentBuffer=t.createVertexBuffer(i,Us.members),this.tileExtentSegments=Fi.simpleSegment(0,0,4,2);const n=new Tr;n.emplaceBack(0,0),n.emplaceBack(pt,0),n.emplaceBack(0,pt),n.emplaceBack(pt,pt),this.debugBuffer=t.createVertexBuffer(n,Us.members),this.debugSegments=Fi.simpleSegment(0,0,4,5);const r=new Tr;r.emplaceBack(-1,-1),r.emplaceBack(1,-1),r.emplaceBack(-1,1),r.emplaceBack(1,1),this.viewportBuffer=t.createVertexBuffer(r,Us.members),this.viewportSegments=Fi.simpleSegment(0,0,4,2);const o=new Ea;o.emplaceBack(0,0,0,0),o.emplaceBack(pt,0,pt,0),o.emplaceBack(0,pt,0,pt),o.emplaceBack(pt,pt,pt,pt),this.mercatorBoundsBuffer=t.createVertexBuffer(o,Bm.members),this.mercatorBoundsSegments=Fi.simpleSegment(0,0,4,2);const s=new Rn;s.emplaceBack(0,1,2),s.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=t.createIndexBuffer(s);const a=new Dc;for(const c of[0,1,3,2,0])a.emplaceBack(c);this.debugIndexBuffer=t.createIndexBuffer(a),this.emptyTexture=new mn(t,new Ln({width:1,height:1},Uint8Array.of(0,0,0,0)),t.gl.RGBA),this.identityMat=st.create();const l=this.context.gl;this.stencilClearMode=new Ke({func:l.ALWAYS,mask:0},0,255,l.ZERO,l.ZERO,l.ZERO),this.loadTimeStamps.push(I.performance.now())}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(t){return t._makeTileBoundsBuffers(this.context,this.transform.projection),t._tileBoundsBuffer?{tileBoundsBuffer:t._tileBoundsBuffer,tileBoundsIndexBuffer:t._tileBoundsIndexBuffer,tileBoundsSegments:t._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){const t=this.context.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs={},this.getOrCreateProgram("clippingMask").draw(this,t.TRIANGLES,Ie.disabled,this.stencilClearMode,Ti.disabled,ti.disabled,v_(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs={})}_renderTileClippingMasks(t,i,n){if(!i||this.currentStencilSource===i.id||!t.isTileClipped()||!n||n.length===0)return;if(this._tileClippingMaskIDs&&!this.terrain){let a=!1;for(const l of n)if(this._tileClippingMaskIDs[l.key]===void 0){a=!0;break}if(!a)return}this.currentStencilSource=i.id;const r=this.context,o=r.gl;this.nextStencilID+n.length>256&&this.clearStencil(),r.setColorMode(Ti.disabled),r.setDepthMode(Ie.disabled);const s=this.getOrCreateProgram("clippingMask");this._tileClippingMaskIDs={};for(const a of n){const l=i.getTile(a),c=this._tileClippingMaskIDs[a.key]=this.nextStencilID++,{tileBoundsBuffer:u,tileBoundsIndexBuffer:h,tileBoundsSegments:d}=this.getTileBoundsBuffers(l);s.draw(this,o.TRIANGLES,Ie.disabled,new Ke({func:o.ALWAYS,mask:0},c,255,o.KEEP,o.KEEP,o.REPLACE),Ti.disabled,ti.disabled,v_(a.projMatrix),"$clipping",u,h,d)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const t=this.nextStencilID++,i=this.context.gl;return new Ke({func:i.NOTEQUAL,mask:255},t,255,i.KEEP,i.KEEP,i.REPLACE)}stencilModeForClipping(t){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(t);const i=this.context.gl;return new Ke({func:i.EQUAL,mask:255},this._tileClippingMaskIDs[t.key],0,i.KEEP,i.KEEP,i.REPLACE)}stencilConfigForOverlap(t){const i=this.context.gl,n=t.sort((s,a)=>a.overscaledZ-s.overscaledZ),r=n[n.length-1].overscaledZ,o=n[0].overscaledZ-r+1;if(o>1){this.currentStencilSource=void 0,this.nextStencilID+o>256&&this.clearStencil();const s={};for(let a=0;a<o;a++)s[a+r]=new Ke({func:i.GEQUAL,mask:255},a+this.nextStencilID,255,i.KEEP,i.KEEP,i.REPLACE);return this.nextStencilID+=o,[s,n]}return[{[r]:Ke.disabled},n]}colorModeForRenderPass(){const t=this.context.gl;return this._showOverdrawInspector?new Ti([t.CONSTANT_COLOR,t.ONE,t.CONSTANT_COLOR,t.ONE],new Ye(.125,.125,.125,0),[!0,!0,!0,!0]):this.renderPass==="opaque"?Ti.unblended:Ti.alphaBlended}colorModeForDrapableLayerRenderPass(t){const i=this.context.gl;return(()=>this.style&&this.style.enable3dLights()&&this.terrain&&this.terrain.renderingToTexture)()&&this.renderPass==="translucent"?new Ti([i.ONE,i.ONE_MINUS_SRC_ALPHA,i.CONSTANT_ALPHA,i.ONE_MINUS_SRC_ALPHA],new Ye(0,0,0,t===void 0?0:t),[!0,!0,!0,!0]):this.colorModeForRenderPass()}depthModeForSublayer(t,i,n,r=!1){if(!this.opaquePassEnabledForLayer()&&!r)return Ie.disabled;const o=1-((1+this.currentLayer)*this.numSublayers+t)*this.depthEpsilon;return new Ie(n||this.context.gl.LEQUAL,i,[o,o])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}render(t,i){this._wireframeDebugCache.update(this.frameCounter),this.style=t,this.options=i;const n=this.style._mergedLayers,r=this.style.order,o=r.map(T=>n[T]),s=this.style._mergedSourceCaches;this.imageManager=t.imageManager,this.modelManager=t.modelManager,this.symbolFadeChange=t.placement.symbolFadeChange(ke.now()),this.imageManager.beginFrame();let a=0,l=!1;for(const T in s){const S=s[T];S.used&&(S.prepare(this.context),S.getSource().usedInConflation&&++a)}const c={},u={},h={},d={},p={};for(const T in s){const S=s[T];c[T]=S.getVisibleCoordinates(),u[T]=c[T].slice().reverse(),h[T]=S.getVisibleCoordinates(!0).reverse(),d[T]=S.getShadowCasterCoordinates(),p[T]=S.sortCoordinatesByDistance(c[T])}const _=T=>{const S=this.style.getLayerSourceCache(T);return S&&S.used?S.getSource():null};if(a){const T=[];for(const S of o)this.layerUsedInConflation(S,_(S))&&T.push(S);if(T&&T.length>1){const S=[];for(const D of T){const z=this.style.getLayerSourceCache(D);z&&z.used&&z.getSource().usedInConflation&&S.push({layer:D.fqid,cache:z})}this.replacementSource.setSources(S),l=!0}}l||this.replacementSource.clear(),this.conflationActive=l,this.minCutoffZoom=0,this.longestCutoffRange=0;for(const T of o){const S=T.cutoffRange();if(this.longestCutoffRange=Math.max(S,this.longestCutoffRange),S>0){const D=_(T);D&&(this.minCutoffZoom=Math.max(D.minzoom,this.minCutoffZoom)),T.minzoom&&(this.minCutoffZoom=Math.max(T.minzoom,this.minCutoffZoom))}}this.opaquePassCutoff=1/0;for(let T=0;T<o.length;T++)if(o[T].is3D()){this.opaquePassCutoff=T;break}const g=this.style&&this.style.fog;g?(this._fogVisible=g.getOpacity(this.transform.pitch)!==0,this._fogVisible&&this.transform.projection.name!=="globe"&&(this._fogVisible=g.isVisibleOnFrustum(this.transform.cameraFrustum))):this._fogVisible=!1,this._cachedTileFogOpacities={},this.terrain&&(this.terrain.updateTileBinding(h),this.opaquePassCutoff=0);const y=this._shadowRenderer;if(y){y.updateShadowParameters(this.transform,this.style.directionalLight);for(const T in s)for(const S of c[T]){let D={min:0,max:0};this.terrain&&(D=this.terrain.getMinMaxForTile(S)||D),y.addShadowReceiver(S.toUnwrapped(),D.min,D.max)}}this.transform.projection.name!=="globe"||this.globeSharedBuffers||(this.globeSharedBuffers=new UE(this.context));for(const T of o){if(T.isHidden(this.transform.zoom))continue;const S=t.getLayerSourceCache(T);this.uploadLayer(this,T,S)}if(this.style.fog&&this.transform.projection.supportsFog?(this._atmosphere||(this._atmosphere=new eD),this._atmosphere.update(this)):this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),!Ho.has(this.context.gl))return;this.renderPass="offscreen";for(const T of o){const S=t.getLayerSourceCache(T);if(!T.hasOffscreenPass()||T.isHidden(this.transform.zoom))continue;const D=S?u[S.id]:void 0;(T.type==="custom"||T.type==="raster"||T.isSky()||D&&D.length)&&this.renderLayer(this,S,T,D)}this.depthRangeFor3D=[0,1-(o.length+2)*this.numSublayers*this.depthEpsilon];const x=this.terrain;x&&(this.style.hasSymbolLayers()||this.style.hasCircleLayers())&&!this.transform.isOrthographic&&x.drawDepth(),this._shadowRenderer&&(this.renderPass="shadow",this._shadowRenderer.drawShadowPass(this.style,d)),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]);const b=this.transform.projection.name==="globe"||this.transform.isHorizonVisible(),M=(()=>{if(i.showOverdrawInspector)return Ye.black;if(this.style.fog&&this.transform.projection.supportsFog&&!b){const T=this.style.fog.properties.get("color").toArray01();return new Ye(...T)}if(this.style.fog&&this.transform.projection.supportsFog&&b){const T=this.style.fog.properties.get("space-color").toArray01();return new Ye(...T)}return Ye.transparent})();if(this.context.clear({color:M,depth:1}),this.clearStencil(),this._showOverdrawInspector=i.showOverdrawInspector,this.renderPass="opaque",this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&b&&this._atmosphere.drawStars(this,this.style.fog),!this.terrain)for(this.currentLayer=r.length-1;this.currentLayer>=0;this.currentLayer--){const T=o[this.currentLayer],S=t.getLayerSourceCache(T);if(T.isSky())continue;const D=S?(T.is3D()?p:u)[S.id]:void 0;this._renderTileClippingMasks(T,S,D),this.renderLayer(this,S,T,D)}if(this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&b&&this._atmosphere.drawAtmosphereGlow(this,this.style.fog),this.renderPass="sky",(!this._atmosphere||Wn(this.transform.zoom)>0)&&(this.transform.projection.name==="globe"||this.transform.isHorizonVisible()))for(this.currentLayer=0;this.currentLayer<r.length;this.currentLayer++){const T=o[this.currentLayer],S=t.getLayerSourceCache(T);T.isSky()&&this.renderLayer(this,S,T,S?u[S.id]:void 0)}this.renderPass="translucent",this.currentLayer=0,this.firstLightBeamLayer=Number.MAX_SAFE_INTEGER;let E=0;for(y&&(E=y.getShadowCastingLayerCount());this.currentLayer<r.length;){const T=o[this.currentLayer],S=t.getLayerSourceCache(T);if(T.isSky()){++this.currentLayer;continue}if(x&&this.style.isLayerDraped(T)){if(T.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=x.renderBatch(this.currentLayer);continue}let D;if(S&&(D=(T.type==="symbol"?h:T.is3D()?p:u)[S.id]),this._renderTileClippingMasks(T,S,S?c[S.id]:void 0),this.renderLayer(this,S,T,D),!x&&y&&E>0&&T.hasShadowPass()&&--E==0&&(y.drawGroundShadows(),this.firstLightBeamLayer<=this.currentLayer)){const z=this.currentLayer;for(this.renderPass="light-beam",this.currentLayer=this.firstLightBeamLayer;this.currentLayer<=z;this.currentLayer++){const L=o[this.currentLayer];if(!L.hasLightBeamPass())continue;const R=t.getLayerSourceCache(L);this.renderLayer(this,R,L,R?u[R.id]:void 0)}this.currentLayer=z,this.renderPass="translucent"}++this.currentLayer}if(this.terrain&&this.terrain.postRender(),this.options.showTileBoundaries||this.options.showQueryGeometry||this.options.showTileAABBs){let T=null;o.forEach(S=>{const D=t.getLayerSourceCache(S);D&&!S.isHidden(this.transform.zoom)&&D.getVisibleCoordinates().length&&(!T||T.getSource().maxzoom<D.getSource().maxzoom)&&(T=D)}),T&&this.options.showTileBoundaries&&Rw.debug(this,T,T.getVisibleCoordinates())}this.options.showPadding&&function(T){const S=T.transform.padding;Cw(T,T.transform.height-(S.top||0),3,qC),Cw(T,S.bottom||0,3,ZC),Dw(T,S.left||0,3,HC),Dw(T,T.transform.width-(S.right||0),3,WC);const D=T.transform.centerPoint;(function(z,L,R,N){wd(z,L-1,R-10,2,20,N),wd(z,L-10,R-1,20,2,N)})(T,D.x,T.transform.height-D.y,$C)}(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(I.performance.now()),this.saveCanvasCopy()),l||(this.conflationActive=!1)}uploadLayer(t,i,n){this.gpuTimingStart(i),(!t.transform.projection.unsupportedLayers||!t.transform.projection.unsupportedLayers.includes(i.type)||t.terrain&&i.type==="custom")&&Ow[`${i.type}Upload`]&&Ow[`${i.type}Upload`](t,n,i.scope),this.gpuTimingEnd()}renderLayer(t,i,n,r){n.isHidden(this.transform.zoom)||(n.type==="background"||n.type==="sky"||n.type==="custom"||n.type==="model"||n.type==="raster"||r&&r.length)&&(this.id=n.id,this.gpuTimingStart(n),(!t.transform.projection.unsupportedLayers||!t.transform.projection.unsupportedLayers.includes(n.type)||t.terrain&&n.type==="custom")&&Rw[n.type](t,i,n,r,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(t){if(!this.options.gpuTiming)return;const i=this.context.extTimerQuery,n=this.context.gl;let r=this.gpuTimers[t.id];r||(r=this.gpuTimers[t.id]={calls:0,cpuTime:0,query:n.createQuery()}),r.calls++,n.beginQuery(i.TIME_ELAPSED_EXT,r.query)}gpuTimingDeferredRenderStart(){if(this.options.gpuTimingDeferredRender){const t=this.context.extTimerQuery,i=this.context.gl,n=i.createQuery();this.deferredRenderGpuTimeQueries.push(n),i.beginQuery(t.TIME_ELAPSED_EXT,n)}}gpuTimingDeferredRenderEnd(){this.options.gpuTimingDeferredRender&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}gpuTimingEnd(){this.options.gpuTiming&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}collectGpuTimers(){const t=this.gpuTimers;return this.gpuTimers={},t}collectDeferredRenderGpuQueries(){const t=this.deferredRenderGpuTimeQueries;return this.deferredRenderGpuTimeQueries=[],t}queryGpuTimers(t){const i={};for(const n in t){const r=t[n],o=this.context.extTimerQuery,s=o.getQueryParameter(r.query,this.context.gl.QUERY_RESULT)/1e6;o.deleteQueryEXT(r.query),i[n]=s}return i}queryGpuTimeDeferredRender(t){if(!this.options.gpuTimingDeferredRender)return 0;const i=this.context.extTimerQuery,n=this.context.gl;let r=0;for(const o of t)r+=i.getQueryParameter(o,n.QUERY_RESULT)/1e6,i.deleteQueryEXT(o);return r}translatePosMatrix(t,i,n,r,o){if(!n[0]&&!n[1])return t;const s=o?r==="map"?this.transform.angle:0:r==="viewport"?-this.transform.angle:0;if(s){const c=Math.sin(s),u=Math.cos(s);n=[n[0]*u-n[1]*c,n[0]*c+n[1]*u]}const a=[o?n[0]:za(i,n[0],this.transform.zoom),o?n[1]:za(i,n[1],this.transform.zoom),0],l=new Float32Array(16);return st.translate(l,t,a),l}saveTileTexture(t){const i=t.size[0],n=this._tileTextures[i];n?n.push(t):this._tileTextures[i]=[t]}getTileTexture(t){const i=this._tileTextures[t];return i&&i.length>0?i.pop():null}isPatternMissing(t,i){return t===null||t!==void 0&&!this.imageManager.getPattern(t.toString(),i)}terrainRenderModeElevated(){return this.style&&!!this.style.getTerrain()&&!!this.terrain&&!this.terrain.renderingToTexture}linearFloatFilteringSupported(){return this.context.extTextureFloatLinear!=null}currentGlobalDefines(t,i,n){const r=n===void 0?this.terrain&&this.terrain.renderingToTexture:n,o=this.terrain&&this.terrain.exaggeration()===0,s=[];return this.style&&this.style.enable3dLights()&&(t==="globeRaster"||t==="terrainRaster"?(s.push("LIGHTING_3D_MODE"),s.push("LIGHTING_3D_ALPHA_EMISSIVENESS")):r||s.push("LIGHTING_3D_MODE")),this.renderPass==="shadow"?this._shadowMapDebug||s.push("DEPTH_TEXTURE"):this.shadowRenderer&&(this.shadowRenderer.useNormalOffset?s.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"):s.push("RENDER_SHADOWS","DEPTH_TEXTURE")),this.terrainRenderModeElevated()&&(s.push("TERRAIN"),this.linearFloatFilteringSupported()&&s.push("TERRAIN_DEM_FLOAT_FORMAT"),o&&s.push("ZERO_EXAGGERATION")),this.transform.projection.name==="globe"&&s.push("GLOBE"),!this._fogVisible||r||i!==void 0&&!i||s.push("FOG","FOG_DITHERING"),r&&s.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&s.push("OVERDRAW_INSPECTOR"),s}getOrCreateProgram(t,i){this.cache=this.cache||{};const n=i&&i.defines||[],r=i&&i.config,o=this.currentGlobalDefines(t,i&&i.overrideFog,i&&i.overrideRtt).concat(n),s=fw.cacheKey(nw[t],t,o,r);return this.cache[s]||(this.cache[s]=new fw(this.context,t,nw[t],r,LC[t],o)),this.cache[s]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const t=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(t.FUNC_ADD)}initDebugOverlayCanvas(){this.debugOverlayCanvas==null&&(this.debugOverlayCanvas=I.document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new mn(this.context,this.debugOverlayCanvas,this.context.gl.RGBA))}destroy(){this._terrain&&this._terrain.destroy(),this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy(),this._wireframeDebugCache.destroy()}prepareDrawTile(){this.terrain&&this.terrain.prepareDrawTile()}uploadCommonLightUniforms(t,i){if(this.style.enable3dLights()){const n=this.style.directionalLight,r=this.style.ambientLight;if(n&&r){const o=((s,a)=>{const l=s.properties.get("direction"),c=s.properties.get("color").toArray01(),u=s.properties.get("intensity"),h=a.properties.get("color").toArray01(),d=a.properties.get("intensity"),p=[l.x,l.y,l.z],_=ri(h,d),g=ri(c,u);return{u_lighting_ambient_color:_,u_lighting_directional_dir:p,u_lighting_directional_color:g,u_ground_radiance:gC(p,g,_)}})(n,r);i.setLightsUniformValues(t,o)}}}uploadCommonUniforms(t,i,n,r,o){if(this.uploadCommonLightUniforms(t,i),this.terrain&&this.terrain.renderingToTexture)return;const s=this.style.fog;if(s){const a=s.getOpacity(this.transform.pitch),l=((c,u,h,d,p,_,g,y,x,b,M,E)=>{const T=c.transform,S=u.properties.get("color").toArray01();S[3]=d;const D=c.frameCounter/1e3%1,[z,L]=u.properties.get("vertical-range");return{u_fog_matrix:h?T.calculateFogTileMatrix(h):E||c.identityMat,u_fog_range:u.getFovAdjustedRange(T._fov),u_fog_color:S,u_fog_horizon_blend:u.properties.get("horizon-blend"),u_fog_vertical_limit:[Math.min(z,L),L],u_fog_temporal_offset:D,u_frustum_tl:p,u_frustum_tr:_,u_frustum_br:g,u_frustum_bl:y,u_globe_pos:x,u_globe_radius:b,u_viewport:M,u_globe_transition:Wn(T.zoom),u_is_globe:+(T.projection.name==="globe")}})(this,s,n,a,this.transform.frustumCorners.TL,this.transform.frustumCorners.TR,this.transform.frustumCorners.BR,this.transform.frustumCorners.BL,this.transform.globeCenterInViewSpace,this.transform.globeRadius,[this.transform.width*ke.devicePixelRatio,this.transform.height*ke.devicePixelRatio],r);i.setFogUniformValues(t,l)}o&&i.setCutoffUniformValues(t,o.uniformValues)}setTileLoadedFlag(t){this.tileLoaded=t}saveCanvasCopy(){const t=this.canvasCopy();t&&(this.frameCopies.push(t),this.tileLoaded=!1)}canvasCopy(){const t=this.context.gl,i=t.createTexture();return t.bindTexture(t.TEXTURE_2D,i),t.copyTexImage2D(t.TEXTURE_2D,0,t.RGBA,0,0,t.drawingBufferWidth,t.drawingBufferHeight,0),i}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;const t=this.style&&this.style.fog;return!!t&&t.getOpacity(this.transform.pitch)!==0}getBackgroundTiles(){const t=this._backgroundTiles,i=this._backgroundTiles={},n=this.transform.coveringTiles({tileSize:512});for(const r of n)i[r.key]=t[r.key]||new Jc(r,512,this.transform.tileZoom,this);return i}clearBackgroundTiles(){this._backgroundTiles={}}layerUsedInConflation(t,i){return!(!t.is3D()||t.minzoom&&t.minzoom>this.transform.zoom||t.sourceLayer!=="building"&&(!i||i.type!=="batched-model"))}isTileAffectedByFog(t){if(!this.style||!this.style.fog)return!1;if(this.transform.projection.name==="globe")return!0;let i=this._cachedTileFogOpacities[t.key];return i||(this._cachedTileFogOpacities[t.key]=i=this.style.fog.getOpacityForTile(t)),i[0]>=Oa||i[1]>=Oa}}const Na=2048;class cD{constructor(t,i){this.aabb=t,this.lastCascade=i}}class uD{add(t,i){const n=this.receivers[t.key];n!==void 0?(n.aabb.min[0]=Math.min(n.aabb.min[0],i.min[0]),n.aabb.min[1]=Math.min(n.aabb.min[1],i.min[1]),n.aabb.min[2]=Math.min(n.aabb.min[2],i.min[2]),n.aabb.max[0]=Math.max(n.aabb.max[0],i.max[0]),n.aabb.max[1]=Math.max(n.aabb.max[1],i.max[1]),n.aabb.max[2]=Math.max(n.aabb.max[2],i.max[2])):this.receivers[t.key]=new cD(i,null)}clear(){this.receivers={}}get(t){return this.receivers[t.key]}computeRequiredCascades(t,i,n){const r=en.fromPoints(t.points);let o=0;for(const s in this.receivers){const a=this.receivers[s];if(!a||!r.intersectsAabb(a.aabb))continue;a.aabb.min=r.closestPoint(a.aabb.min),a.aabb.max=r.closestPoint(a.aabb.max);const l=a.aabb.getCorners();for(let c=0;c<n.length;c++){let u=!0;for(const h of l){const d=[h[0]*i,h[1]*i,h[2]];if(Z.transformMat4(d,d,n[c].matrix),d[0]<-1||d[0]>1||d[1]<-1||d[1]>1){u=!1;break}}if(a.lastCascade=c,o=Math.max(o,c),u)break}}return o+1}}class hD{constructor(t){this.painter=t,this._enabled=!1,this._shadowLayerCount=0,this._numCascadesToRender=0,this._cascades=[],this._groundShadowTiles=[],this._receivers=new uD,this._depthMode=new Ie(t.context.gl.LEQUAL,Ie.ReadWrite,[0,1]),this._uniformValues={u_light_matrix_0:new Float32Array(16),u_light_matrix_1:new Float32Array(16),u_shadow_intensity:0,u_fade_range:[0,0],u_shadow_normal_offset:[1,1,1],u_shadow_texel_size:1,u_shadow_map_resolution:1,u_shadow_direction:[0,0,1],u_shadow_bias:[36e-5,.0012,.012],u_shadowmap_0:0,u_shadowmap_1:0},this.useNormalOffset=!1}destroy(){for(const t of this._cascades)t.texture.destroy(),t.framebuffer.destroy();this._cascades=[]}updateShadowParameters(t,i){const n=this.painter;if(this._enabled=!1,this._shadowLayerCount=0,this._receivers.clear(),!i||!i.properties)return;const r=i.properties.get("shadow-intensity");if(!i.shadowsEnabled()||r<=0||(this._shadowLayerCount=n.style.order.reduce((p,_)=>{const g=n.style._mergedLayers[_];return p+(g.hasShadowPass()&&!g.isHidden(t.zoom)?1:0)},0),this._enabled=this._shadowLayerCount>0,!this._enabled))return;const o=n.context,s=Na,a=Na;if(this._cascades.length===0)for(let p=0;p<2;++p){const _=n._shadowMapDebug,g=o.gl,y=o.createFramebuffer(s,a,_,"texture"),x=new mn(o,{width:s,height:a,data:null},g.DEPTH_COMPONENT);if(y.depthAttachment.set(x.texture),_){const b=new mn(o,{width:s,height:a,data:null},g.RGBA);y.colorAttachment.set(b.texture)}this._cascades.push({framebuffer:y,texture:x,matrix:[],far:0,boundingSphereRadius:0,frustum:new cs,scale:0})}this.shadowDirection=Bw(i);let l=0;if(t.elevation){const p=t.elevation,_=[1e4,-1e4];p.visibleDemTiles.filter(g=>g.dem).forEach(g=>{const y=g.dem.tree;_[0]=Math.min(_[0],y.minimums[0]),_[1]=Math.max(_[1],y.maximums[0])}),_[0]!==1e4&&(l=(_[1]-_[0])*p.exaggeration())}const c=1.5*t.cameraToCenterDistance,u=3*c,h=new Float64Array(16);for(let p=0;p<2;++p){const _=this._cascades[p];let g=t.height/50,y=1;p===0?y=c:(g=c,y=u);const[x,b]=dD(t,this.shadowDirection,g,y,Na,l);_.scale=t.scale,_.matrix=x,_.boundingSphereRadius=b,st.invert(h,_.matrix),_.frustum=cs.fromInvProjectionMatrix(h,1,0,!0),_.far=y}this._uniformValues.u_fade_range=[.75*this._cascades[1].far,this._cascades[1].far],this._uniformValues.u_shadow_intensity=r,this._uniformValues.u_shadow_direction=[this.shadowDirection[0],this.shadowDirection[1],this.shadowDirection[2]],this._uniformValues.u_shadow_texel_size=.00048828125,this._uniformValues.u_shadow_map_resolution=Na,this._uniformValues.u_shadowmap_0=Ir.ShadowMap0,this._uniformValues.u_shadowmap_1=Ir.ShadowMap0+1,this._groundShadowTiles=n.transform.coveringTiles({tileSize:512,renderWorldCopies:!0});const d=n.transform.elevation;for(const p of this._groundShadowTiles){let _={min:0,max:0};if(d){const g=d.getMinMaxForTile(p);g&&(_=g)}this.addShadowReceiver(p.toUnwrapped(),_.min,_.max)}}get enabled(){return this._enabled}set enabled(t){this._enabled=t}drawShadowPass(t,i){if(!this._enabled)return;const n=this.painter,r=n.context;this._numCascadesToRender=this._receivers.computeRequiredCascades(n.transform.getFrustum(0),n.transform.worldSize,this._cascades),r.viewport.set([0,0,Na,Na]);for(let o=0;o<this._numCascadesToRender;++o){n.currentShadowCascade=o,r.bindFramebuffer.set(this._cascades[o].framebuffer.framebuffer),r.clear({color:Ye.white,depth:1});for(const s of t.order){const a=t._mergedLayers[s];if(!a.hasShadowPass()||a.isHidden(n.transform.zoom))continue;const l=t.getLayerSourceCache(a),c=l?i[l.id]:void 0;(a.type==="model"||c&&c.length)&&n.renderLayer(n,l,a,c)}}n.currentShadowCascade=0}drawGroundShadows(){if(!this._enabled)return;const t=this.painter,i=t.style,n=t.context,r=i.directionalLight,o=i.ambientLight;if(!r||!o)return;const s=[],a=Ul(t,t.longestCutoffRange);a.shouldRenderCutoff&&s.push("RENDER_CUTOFF");const l=M_(r,o),c=new Ie(n.gl.LEQUAL,Ie.ReadOnly,t.depthRangeFor3D);for(const u of this._groundShadowTiles){const h=u.toUnwrapped(),d=t.isTileAffectedByFog(u),p=t.getOrCreateProgram("groundShadow",{defines:s,overrideFog:d});this.setupShadows(h,p),t.uploadCommonUniforms(n,p,h,null,a);const _={u_matrix:t.transform.calculateProjMatrix(h),u_ground_shadow_factor:l};p.draw(t,n.gl.TRIANGLES,c,Ke.disabled,Ti.multiply,ti.disabled,_,"ground_shadow",t.tileExtentBuffer,t.quadTriangleIndexBuffer,t.tileExtentSegments,{},t.transform.zoom,null,null)}}getShadowPassColorMode(){return this.painter._shadowMapDebug?Ti.unblended:Ti.disabled}getShadowPassDepthMode(){return this._depthMode}getShadowCastingLayerCount(){return this._shadowLayerCount}calculateShadowPassMatrixFromTile(t){const i=this.painter.transform,n=i.calculatePosMatrix(t,i.worldSize);return st.multiply(n,this._cascades[this.painter.currentShadowCascade].matrix,n),Float32Array.from(n)}calculateShadowPassMatrixFromMatrix(t){return st.multiply(t,this._cascades[this.painter.currentShadowCascade].matrix,t),Float32Array.from(t)}setupShadows(t,i,n,r=0){if(!this._enabled)return;const o=this.painter.transform,s=this.painter.context,a=s.gl,l=this._uniformValues,c=new Float64Array(16),u=o.calculatePosMatrix(t,o.worldSize);for(let h=0;h<2;h++)st.multiply(c,this._cascades[h].matrix,u),l[h===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(c),s.activeTexture.set(a.TEXTURE0+Ir.ShadowMap0+h),this._cascades[h].texture.bind(a.NEAREST,a.CLAMP_TO_EDGE);if(this.useNormalOffset=!!n,this.useNormalOffset){const h=Fc(t.canonical),d=2/o.tileSize*pt/Na,p=d*this._cascades[0].boundingSphereRadius,_=d*this._cascades[1].boundingSphereRadius,g=(n==="vector-tile"?1:3)/Math.pow(2,r-t.canonical.z-(1-o.zoom+Math.floor(o.zoom)));l.u_shadow_normal_offset=[h,p*g,_*g],l.u_shadow_bias=[6e-5,.0012,.012]}else l.u_shadow_bias=[36e-5,.0012,.012];i.setShadowUniformValues(s,l)}setupShadowsFromMatrix(t,i,n=!1){if(!this._enabled)return;const r=this.painter.context,o=r.gl,s=this._uniformValues,a=new Float64Array(16);for(let l=0;l<2;l++)st.multiply(a,this._cascades[l].matrix,t),s[l===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(a),r.activeTexture.set(o.TEXTURE0+Ir.ShadowMap0+l),this._cascades[l].texture.bind(o.NEAREST,o.CLAMP_TO_EDGE);this.useNormalOffset=n,n?(s.u_shadow_normal_offset=[1,5,5],s.u_shadow_bias=[6e-5,.0012,.012]):s.u_shadow_bias=[36e-5,.0012,.012],i.setShadowUniformValues(r,s)}getShadowUniformValues(){return this._uniformValues}getCurrentCascadeFrustum(){return this._cascades[this.painter.currentShadowCascade].frustum}computeSimplifiedTileShadowVolume(t,i,n,r){if(r[2]>=0)return{};const o=function(l,c,u){const h=u/(1<<l.canonical.z);return new en([l.canonical.x*h+l.wrap*u,l.canonical.y*h+l.wrap*u,0],[(l.canonical.x+1)*h+l.wrap*u,(l.canonical.y+1)*h+l.wrap*u,c])}(t,i,n).getCorners(),s=i/-r[2];r[0]<0?(Z.add(o[0],o[0],[r[0]*s,0,0]),Z.add(o[3],o[3],[r[0]*s,0,0])):r[0]>0&&(Z.add(o[1],o[1],[r[0]*s,0,0]),Z.add(o[2],o[2],[r[0]*s,0,0])),r[1]<0?(Z.add(o[0],o[0],[0,r[1]*s,0]),Z.add(o[1],o[1],[0,r[1]*s,0])):r[1]>0&&(Z.add(o[2],o[2],[0,r[1]*s,0]),Z.add(o[3],o[3],[0,r[1]*s,0]));const a={};return a.vertices=o,a.planes=[Md(o[1],o[0],o[4]),Md(o[2],o[1],o[5]),Md(o[3],o[2],o[6]),Md(o[0],o[3],o[7])],a}addShadowReceiver(t,i,n){this._receivers.add(t,en.fromTileIdAndHeight(t,i,n))}getMaxCascadeForTile(t){const i=this._receivers.get(t);return i&&i.lastCascade?i.lastCascade:0}}function Md(e,t,i){const n=Z.sub([],i,t),r=Z.sub([],e,t),o=Z.cross([],n,r),s=Z.length(o);return s===0?[0,0,1,0]:(Z.scale(o,o,1/s),[o[0],o[1],o[2],-Z.dot(o,t)])}function Bw(e){const t=e.properties.get("direction"),i=ie(t.x,t.y,t.z);i[2]=Lt(i[2],0,75);const n=ee([i[0],i[1],i[2]]);return Z.fromValues(n.x,n.y,n.z)}function M_(e,t){const i=e.properties.get("color"),n=e.properties.get("intensity"),r=e.properties.get("direction"),o=[r.x,r.y,r.z],s=t.properties.get("color"),a=t.properties.get("intensity"),l=Math.max(Z.dot([0,0,1],o),0),c=[0,0,0];Z.scale(c,s.toArray01Linear().slice(0,3),a);const u=[0,0,0];return Z.scale(u,i.toArray01Linear().slice(0,3),l*n),Vi([c[0]>0?c[0]/(c[0]+u[0]):0,c[1]>0?c[1]/(c[1]+u[1]):0,c[2]>0?c[2]/(c[2]+u[2]):0])}function dD(e,t,i,n,r,o){const s=e.zoom,a=e.scale,l=e.worldSize,c=1/l,u=e.aspect,h=Math.sqrt(1+u*u)*Math.tan(.5*e.fovX),d=h*h,p=n-i,_=n+i;let g,y;d>p/_?(g=n,y=n*h):(g=.5*_*(1+d),y=.5*Math.sqrt(p*p+2*(n*n+i*i)*d+_*_*d*d));const x=e.projection.pixelsPerMeter(e.center.lat,l),b=e._camera.getCameraToWorldMercator(),M=[0,0,-g*c];Z.transformMat4(M,M,b);let E=y*c;const T=e._edgeInsets;if(!(T.left===0&&T.top===0&&T.right===0&&T.bottom===0||T.left===T.right&&T.top===T.bottom)){const ut=e._camera.getWorldToCamera(e.worldSize,e.projection.zAxisUnit==="meters"?x:1),ct=e._camera.getCameraToClipPerspective(e._fov,e.width/e.height,i,n);ct[8]=2*-e.centerOffset.x/e.width,ct[9]=2*e.centerOffset.y/e.height;const bt=new Float64Array(16);st.mul(bt,ct,ut);const Mt=new Float64Array(16);st.invert(Mt,bt);const Et=cs.fromInvProjectionMatrix(Mt,l,s,!0);for(const ft of Et.points){const kt=((S=ft)[0]/=a,S[1]/=a,S[2]=Gi(S[2],e._center.lat),S);E=Math.max(E,Z.len(Z.subtract([],M,kt)))}}var S;E*=r/(r-1);const D=Math.acos(t[2]),z=Math.atan2(-t[0],-t[1]),L=new Qh;L.position=M,L.setPitchBearing(D,z);const R=L.getWorldToCamera(l,x),N=E*l,U=Math.min(e._mercatorZfromZoom(17)*l*-2,-2*N),H=L.getCameraToClipOrthographic(-N,N,-N,N,U,(N+o*x)/t[2]),O=new Float64Array(16);st.multiply(O,H,R);const X=Z.fromValues(Math.floor(1e6*M[0])/1e6*l,Math.floor(1e6*M[1])/1e6*l,0),K=.5*r,ot=[0,0,0];Z.transformMat4(ot,X,O),Z.scale(ot,ot,K);const $=[Math.floor(ot[0]),Math.floor(ot[1]),Math.floor(ot[2])],Y=[0,0,0];Z.sub(Y,ot,$),Z.scale(Y,Y,-1/K);const at=new Float64Array(16);return st.identity(at),st.translate(at,at,Y),st.multiply(O,at,O),[O,N]}class fD extends Mn{constructor(t){super(),this.requestManager=t,this.models={"":{}},this.numModelsLoading={}}loadModel(t,i){return Pb(this.requestManager.transformRequest(i,xt.Model).url).then(n=>{if(!n)return;const r=c_(n),o=new Ax(t,void 0,void 0,r);return o.computeBoundsAndApplyParent(),o}).catch(n=>{this.fire(new Ae(new Error(`Could not load model ${t} from ${i}: ${n.message}`)))})}load(t,i){this.models[i]||(this.models[i]={});const n=Object.keys(t);this.numModelsLoading[i]=(this.numModelsLoading[i]||0)+n.length;const r=[];for(const o of n)r.push(this.loadModel(o,t[o]));Promise.allSettled(r).then(o=>{for(let s=0;s<o.length;s++){const{status:a,value:l}=o[s];a==="fulfilled"&&l&&(this.models[i][n[s]]=l)}this.numModelsLoading[i]-=n.length,this.fire(new jt("data",{dataType:"style"}))}).catch(o=>{this.fire(new Ae(new Error(`Could not load models: ${o.message}`)))})}isLoaded(){for(const t in this.numModelsLoading)if(this.numModelsLoading[t]>0)return!1;return!0}hasModel(t,i){return!!this.getModel(t,i)}getModel(t,i){return this.models[i]||(this.models[i]={}),this.models[i][t]}addModel(t,i,n){this.models[n]||(this.models[n]={}),this.hasModel(t,n)&&this.removeModel(t,n),this.load({[t]:this.requestManager.normalizeModelURL(i)},n)}addModels(t,i){const n={};for(const r in t)n[r]=this.requestManager.normalizeModelURL(t[r]);this.load(n,i)}removeModel(t,i){this.models[i]||(this.models[i]={});const n=this.models[i][t];delete this.models[i][t],n.destroy()}listModels(t){return this.models[t]||(this.models[t]={}),Object.keys(this.models[t])}upload(t,i){this.models[i]||(this.models[i]={});for(const n in this.models[i])this.models[i][n].upload(t.context)}}const du=(e,t)=>$u(e,t&&t.filter(i=>i.identifier!=="source.canvas")),pD=Ve(Pi,["addLayer","removeLayer","setLights","setPaintProperty","setLayoutProperty","setSlot","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setProjection","setCamera","addImport","removeImport","setImportUrl","setImportData","setImportConfig"]),mD=Ve(Pi,["setCenter","setZoom","setBearing","setPitch"]),Fw={version:8,layers:[],sources:{}},Nw={duration:300,delay:0},_D=new Set(["fill","line","background","hillshade","raster"]);class fo extends Mn{constructor(t,i={}){super(),this.map=t,this.scope=i.scope||"",this.fragments=[],this.importDepth=i.importDepth||0,this.importsCache=i.importsCache||new Map,this.resolvedImports=i.resolvedImports||new Set,this.transition=Vt({},Nw),this._buildingIndex=new NI(this),this.crossTileSymbolIndex=new lC,this._mergedOrder=[],this._drapedFirstOrder=[],this._mergedLayers={},this._mergedSourceCaches={},this._mergedOtherSourceCaches={},this._mergedSymbolSourceCaches={},this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this._changes=i.styleChanges||new JM,this.dispatcher=i.dispatcher?i.dispatcher:new Ba(cu(),this),i.imageManager?this.imageManager=i.imageManager:(this.imageManager=new pI,this.imageManager.setEventedParent(this)),this.imageManager.createScope(this.scope),this.glyphManager=i.glyphManager?i.glyphManager:new Pl(t._requestManager,i.localFontFamily?2:i.localIdeographFontFamily?1:0,i.localFontFamily||i.localIdeographFontFamily),i.modelManager?this.modelManager=i.modelManager:(this.modelManager=new fD(t._requestManager),this.modelManager.setEventedParent(this)),this._layers={},this._serializedLayers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this._loaded=!1,this._precompileDone=!1,this._shouldPrecompile=!1,this._availableImages=[],this._order=[],this._markersNeedUpdate=!1,this.options=new Map,this._configDependentLayers=new Set,this._config=i.config,this.dispatcher.broadcast("setReferrer",Rt());const n=this;this._rtlTextPluginCallback=fo.registerForPluginStateChange(r=>{n.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:r.pluginStatus,pluginURL:r.pluginURL},(o,s)=>{if(N0(o),s&&s.every(a=>a))for(const a in n._sourceCaches){const l=n._sourceCaches[a],c=l.getSource().type;c!=="vector"&&c!=="geojson"||l.reload()}})}),this.on("data",r=>{if(r.dataType!=="source"||r.sourceDataType!=="metadata")return;const o=this.getOwnSource(r.sourceId);if(o&&o.vectorLayerIds)for(const s in this._layers){const a=this._layers[s];a.source===o.id&&this._validateLayer(a)}})}loadURL(t,i={}){this.fire(new jt("dataloading",{dataType:"style"}));const n=typeof i.validate=="boolean"?i.validate:!li(t);t=this.map._requestManager.normalizeStyleURL(t,i.accessToken),this.resolvedImports.add(t);const r=this.importsCache.get(t);if(r)return this._load(r,n);const o=this.map._requestManager.transformRequest(t,xt.Style);this._request=Ut(o,(s,a)=>{if(this._request=null,s)this.fire(new Ae(s));else if(a)return this.importsCache.set(t,a),this._load(a,n)})}loadJSON(t,i={}){this.fire(new jt("dataloading",{dataType:"style"})),this._request=ke.frame(()=>{this._request=null,this._load(t,i.validate!==!1)})}loadEmpty(){this.fire(new jt("dataloading",{dataType:"style"})),this._load(Fw,!1)}_loadImports(t,i){if(this.importDepth>=4)return J("Style doesn't support nesting deeper than 5"),Promise.resolve();const n=[];for(const r of t){const o=this._createFragmentStyle(r),s=new Promise(l=>{o.once("style.import.load",l),o.once("error",l)}).then(()=>this.mergeAll());if(n.push(s),this.resolvedImports.has(r.url)){o.loadEmpty();continue}const a=r.data||this.importsCache.get(r.url);a?o.loadJSON(a,{validate:i}):r.url?o.loadURL(r.url,{validate:i}):o.loadEmpty(),this.fragments.push({style:o,id:r.id,config:r.config})}return Promise.allSettled(n)}_createFragmentStyle(t){const i=this.scope?cr(t.id,this.scope):t.id,n=new fo(this.map,{scope:i,styleChanges:this._changes,importDepth:this.importDepth+1,importsCache:this.importsCache,resolvedImports:new Set(this.resolvedImports),dispatcher:this.dispatcher,imageManager:this.imageManager,glyphManager:this.glyphManager,modelManager:this.modelManager,config:t.config});return n.setEventedParent(this.map,{style:n}),n}_reloadImports(){this.mergeAll(),this._updateMapProjection(),this.map._triggerCameraUpdate(this.camera),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options});const t=this.isRootStyle();this._shouldPrecompile=t,this.fire(new jt(t?"style.load":"style.import.load"))}_load(t,i){const n=t.schema;if(this.isRootStyle()&&(t.fragment||n&&t.fragment!==!1)){const s=Vt({},Fw,{imports:[{id:"basemap",data:t,url:""}]});return void this._load(s,i)}if(this.setConfig(this._config,n),i&&du(this,dl(t)))return;this._loaded=!0,this.stylesheet=F(t);for(const s in t.sources)this.addSource(s,t.sources[s],{validate:!1,isInitialLoad:!0});t.sprite?this._loadSprite(t.sprite):(this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0})),this.glyphManager.setURL(t.glyphs,this.scope);const r=Ob(this.stylesheet.layers);if(this._order=r.map(s=>s.id),this.stylesheet.light&&J("The `light` root property is deprecated, prefer using `lights` with `flat` light type instead."),this.stylesheet.lights)if(this.stylesheet.lights.length===1&&this.stylesheet.lights[0].type==="flat"){const s=this.stylesheet.lights[0];this.light=new cb(s.properties,s.id)}else this.setLights(this.stylesheet.lights);this.light||(this.light=new cb(this.stylesheet.light)),this._layers={},this._serializedLayers={};for(const s of r){const a=ad(s,this.options);a.setScope(this.scope),a.isConfigDependent&&this._configDependentLayers.add(a.fqid),a.setEventedParent(this,{layer:{id:a.id}}),this._layers[a.id]=a,this._serializedLayers[a.id]=a.serialize();const l=this.getOwnLayerSourceCache(a),c=!!this.directionalLight&&this.directionalLight.shadowsEnabled();l&&a.canCastShadows()&&c&&(l.castsShadows=!0)}this.stylesheet.models&&this.modelManager.addModels(this.stylesheet.models,this.scope);const o=this.stylesheet.terrain;o&&(this.disableElevatedTerrain===void 0&&(this.disableElevatedTerrain=ke.hasCanvasFingerprintNoise()),this.disableElevatedTerrain?J("Terrain and hillshade are disabled because of Canvas2D limitations when fingerprinting protection is enabled (e.g. in private browsing mode)."):this.terrainSetForDrapingOnly()||this._createTerrain(o,1)),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this.stylesheet.transition&&this.setTransition(this.stylesheet.transition),this.fire(new jt("data",{dataType:"style"})),t.imports?this._loadImports(t.imports,i).then(()=>this._reloadImports()):this._reloadImports()}isRootStyle(){return this.importDepth===0}mergeAll(){let t,i,n,r,o,s,a,l;this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(c=>{if(c.stylesheet){if(c.light!=null&&(t=c.light),c.stylesheet.lights)for(const u of c.stylesheet.lights)u.type==="ambient"&&c.ambientLight!=null&&(i=c.ambientLight),u.type==="directional"&&c.directionalLight!=null&&(n=c.directionalLight);r=this._prioritizeTerrain(r,c.terrain,c.stylesheet.terrain),c.stylesheet.fog&&c.fog!=null&&(o=c.fog),c.stylesheet.camera!=null&&(l=c.stylesheet.camera),c.stylesheet.projection!=null&&(s=c.stylesheet.projection),c.stylesheet.transition!=null&&(a=c.stylesheet.transition)}}),this.light=t,this.ambientLight=i,this.directionalLight=n,this.fog=o,r===null?delete this.terrain:this.terrain=r,this.camera=l||{"camera-projection":"perspective"},this.projection=s||{name:"mercator"},this.transition=Vt({},Nw,a),this.mergeSources(),this.mergeLayers()}forEachFragmentStyle(t){const i=n=>{for(const r of n.fragments)i(r.style);t(n)};i(this)}_prioritizeTerrain(t,i,n){const r=t&&t.drapeRenderMode===0;return n===null?i&&i.drapeRenderMode===0?i:r?t:null:i!=null&&(!t||r||i&&i.drapeRenderMode===1)?i:t}mergeTerrain(){let t;this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(i=>{t=this._prioritizeTerrain(t,i.terrain,i.stylesheet.terrain)}),t===null?delete this.terrain:this.terrain=t}mergeProjection(){let t;this.forEachFragmentStyle(i=>{i.stylesheet.projection!=null&&(t=i.stylesheet.projection)}),this.projection=t||{name:"mercator"}}mergeSources(){const t={},i={},n={};this.forEachFragmentStyle(r=>{for(const o in r._sourceCaches){const s=cr(o,r.scope);t[s]=r._sourceCaches[o]}for(const o in r._otherSourceCaches){const s=cr(o,r.scope);i[s]=r._otherSourceCaches[o]}for(const o in r._symbolSourceCaches){const s=cr(o,r.scope);n[s]=r._symbolSourceCaches[o]}}),this._mergedSourceCaches=t,this._mergedOtherSourceCaches=i,this._mergedSymbolSourceCaches=n}mergeLayers(){const t={},i=[],n={};this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this.forEachFragmentStyle(o=>{for(const s of o._order){const a=o._layers[s];if(a.type==="slot"){const l=Ju(s);if(t[l])continue;t[l]=[]}a.slot&&t[a.slot]?t[a.slot].push(a):i.push(a)}}),this._mergedOrder=[];const r=(o=[])=>{for(const s of o)if(s.type==="slot"){const a=Ju(s.id);t[a]&&r(t[a])}else{const a=cr(s.id,s.scope);this._mergedOrder.push(a),n[a]=s,s.is3D()&&(this._has3DLayers=!0),s.type==="circle"&&(this._hasCircleLayers=!0),s.type==="symbol"&&(this._hasSymbolLayers=!0)}};r(i),this._mergedLayers=n,this.updateDrapeFirstLayers(),this._buildingIndex.processLayersChanged()}terrainSetForDrapingOnly(){return!!this.terrain&&this.terrain.drapeRenderMode===0}getCamera(){return this.stylesheet.camera}setCamera(t){return this.stylesheet.camera=Vt({},this.stylesheet.camera,t),this.camera=this.stylesheet.camera,this}setProjection(t){t?this.stylesheet.projection=t:delete this.stylesheet.projection,this.mergeProjection(),this._updateMapProjection()}applyProjectionUpdate(){this._loaded&&(this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),this.map.transform.projection.requiresDraping?this.getTerrain()||this.stylesheet.terrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null))}_updateMapProjection(){this.isRootStyle()&&(this.map._useExplicitProjection?this.applyProjectionUpdate():this.map._prioritizeAndUpdateProjection(null,this.projection))}_loadSprite(t){this._spriteRequest=function(i,n,r){let o,s,a;const l=ke.devicePixelRatio>1?"@2x":"";let c=Ut(n.transformRequest(n.normalizeSpriteURL(i,l,".json"),xt.SpriteJSON),(d,p)=>{c=null,a||(a=d,o=p,h())}),u=Ee(n.transformRequest(n.normalizeSpriteURL(i,l,".png"),xt.SpriteImage),(d,p)=>{u=null,a||(a=d,s=p,h())});function h(){if(a)r(a);else if(o&&s){const d=ke.getImageData(s),p={};for(const _ in o){const{width:g,height:y,x,y:b,sdf:M,pixelRatio:E,stretchX:T,stretchY:S,content:D}=o[_],z=new Ln({width:g,height:y});Ln.copy(d,z,{x,y:b},{x:0,y:0},{width:g,height:y}),p[_]={data:z,pixelRatio:E,sdf:M,stretchX:T,stretchY:S,content:D}}r(null,p)}}return{cancel(){c&&(c.cancel(),c=null),u&&(u.cancel(),u=null)}}}(t,this.map._requestManager,(i,n)=>{if(this._spriteRequest=null,i)this.fire(new Ae(i));else if(n)for(const r in n)this.imageManager.addImage(r,this.scope,n[r]);this.imageManager.setLoaded(!0,this.scope),this._availableImages=this.imageManager.listImages(this.scope),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages}),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new jt("data",{dataType:"style"}))})}_validateLayer(t){const i=this.getOwnSource(t.source);if(!i)return;const n=t.sourceLayer;n&&(i.type==="geojson"||i.vectorLayerIds&&i.vectorLayerIds.indexOf(n)===-1)&&this.fire(new Ae(new Error(`Source layer "${n}" does not exist on source "${i.id}" as specified by style layer "${t.id}"`)))}loaded(){if(!this._loaded||Object.keys(this._changes.getUpdatedSourceCaches()).length)return!1;for(const t in this._sourceCaches)if(!this._sourceCaches[t].loaded())return!1;if(!this.imageManager.isLoaded()||!this.modelManager.isLoaded())return!1;for(const{style:t}of this.fragments)if(!t.loaded())return!1;return!0}_serializeImports(){if(this.stylesheet.imports)return this.stylesheet.imports.map((t,i)=>{const n=this.fragments[i];return n&&n.style&&(t.data=n.style.serialize()),t})}_serializeSources(){const t={};for(const i in this._sourceCaches){const n=this._sourceCaches[i].getSource();t[n.id]||(t[n.id]=n.serialize())}return t}_serializeLayers(t){const i=[];for(const n of t){const r=this._layers[n];r&&r.type!=="custom"&&i.push(r.serialize())}return i}hasLightTransitions(){return!(!this.light||!this.light.hasTransition())||!(!this.ambientLight||!this.ambientLight.hasTransition())||!(!this.directionalLight||!this.directionalLight.hasTransition())}hasFogTransition(){return!!this.fog&&this.fog.hasTransition()}hasTransitions(){if(this.hasLightTransitions()||this.hasFogTransition())return!0;for(const t in this._sourceCaches)if(this._sourceCaches[t].hasTransition())return!0;for(const t in this._layers)if(this._layers[t].hasTransition())return!0;return!1}get order(){return this.terrain?this._drapedFirstOrder:this._mergedOrder}isLayerDraped(t){return!!this.terrain&&(typeof t.isLayerDraped=="function"?t.isLayerDraped(this.getLayerSourceCache(t)):_D.has(t.type))}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading")}_checkLayer(t){const i=this.getOwnLayer(t);if(i)return i;this.fire(new Ae(new Error(`The layer '${t}' does not exist in the map's style.`)))}_checkSource(t){const i=this.getOwnSource(t);if(i)return i;this.fire(new Ae(new Error(`The source '${t}' does not exist in the map's style.`)))}update(t){if(!this._loaded)return;this.ambientLight&&this.ambientLight.recalculate(t),this.directionalLight&&this.directionalLight.recalculate(t);const i=this.calculateLightsBrightness();t.brightness=i||0,i!==this._brightness&&(this._brightness=i,this.dispatcher.broadcast("setBrightness",i));const n=this._changes.isDirty();if(this._changes.isDirty()){const o=this._changes.getLayerUpdatesByScope();for(const s in o){const{updatedIds:a,removedIds:l}=o[s];(a||l)&&this._updateWorkerLayers(s,a,l)}this.updateSourceCaches(),this._updateTilesForChangedImages(),this.updateLayers(t),this.light&&this.light.updateTransitions(t),this.ambientLight&&this.ambientLight.updateTransitions(t),this.directionalLight&&this.directionalLight.updateTransitions(t),this.fog&&this.fog.updateTransitions(t),this._changes.reset()}const r={};for(const o in this._mergedSourceCaches){const s=this._mergedSourceCaches[o];r[o]=s.used,s.used=!1}for(const o of this._mergedOrder){const s=this._mergedLayers[o];if(s.recalculate(t,this._availableImages),!s.isHidden(t.zoom)){const a=this.getLayerSourceCache(s);a&&(a.used=!0)}if(!this._precompileDone&&this._shouldPrecompile)for(let a=s.minzoom||0;a<(s.maxzoom||25.5);a++){const l=this.map.painter;if(l){const c=s.getProgramIds();if(!c)continue;for(const u of c){const h=s.getDefaultProgramParams(u,t.zoom);h&&(l.style=this,this.fog&&(l._fogVisible=!0,h.overrideFog=!0,l.getOrCreateProgram(u,h)),l._fogVisible=!1,h.overrideFog=!1,l.getOrCreateProgram(u,h),(this.stylesheet.terrain||this.stylesheet.projection&&this.stylesheet.projection.name==="globe")&&(h.overrideRtt=!0,l.getOrCreateProgram(u,h)))}}}}this._shouldPrecompile&&(this._precompileDone=!0);for(const o in r){const s=this._mergedSourceCaches[o];r[o]!==s.used&&s.getSource().fire(new jt("data",{sourceDataType:"visibility",dataType:"source",sourceId:s.getSource().id}))}this.light&&this.light.recalculate(t),this.terrain&&this.terrain.recalculate(t),this.fog&&this.fog.recalculate(t),this.z=t.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),n&&this.fire(new jt("data",{dataType:"style"}))}_updateTilesForChangedImages(){const t=this._changes.getUpdatedImages();if(t.length){for(const i in this._sourceCaches)this._sourceCaches[i].reloadTilesForDependencies(["icons","patterns"],t);this._changes.resetUpdatedImages()}}_updateWorkerLayers(t,i,n){const r=this.getFragmentStyle(t);r&&this.dispatcher.broadcast("updateLayers",{layers:i?r._serializeLayers(i):[],scope:t,removedIds:n||[],options:r.options})}setState(t){if(this._checkLoaded(),du(this,dl(t)))return!1;(t=F(t)).layers=Ob(t.layers);const i=function(r,o){if(!r)return[{command:Pi.setStyle,args:[o]}];let s=[];try{if(!Tt(r.version,o.version))return[{command:Pi.setStyle,args:[o]}];Tt(r.center,o.center)||s.push({command:Pi.setCenter,args:[o.center]}),Tt(r.zoom,o.zoom)||s.push({command:Pi.setZoom,args:[o.zoom]}),Tt(r.bearing,o.bearing)||s.push({command:Pi.setBearing,args:[o.bearing]}),Tt(r.pitch,o.pitch)||s.push({command:Pi.setPitch,args:[o.pitch]}),Tt(r.sprite,o.sprite)||s.push({command:Pi.setSprite,args:[o.sprite]}),Tt(r.glyphs,o.glyphs)||s.push({command:Pi.setGlyphs,args:[o.glyphs]}),Tt(r.imports,o.imports)||function(h=[],d=[],p){d=d||[];const _=(h=h||[]).map(dd),g=d.map(dd),y=h.reduce(fd,{}),x=d.reduce(fd,{}),b=_.slice();let M,E,T,S;for(M=0,E=0;M<_.length;M++)T=_[M],x.hasOwnProperty(T)?E++:(p.push({command:Pi.removeImport,args:[T]}),b.splice(b.indexOf(T,E),1));for(M=0,E=0;M<g.length;M++)T=g[g.length-1-M],b[b.length-1-M]!==T&&(y.hasOwnProperty(T)?(p.push({command:Pi.removeImport,args:[T]}),b.splice(b.lastIndexOf(T,b.length-E),1)):E++,S=b[b.length-M],p.push({command:Pi.addImport,args:[x[T],S]}),b.splice(b.length-M,0,T));for(const D of d){const z=y[D.id];if(!z||Tt(z,D))continue;Tt(z.config,D.config)||p.push({command:Pi.setImportConfig,args:[D.id,D.config]}),Tt(z.url,D.url)||p.push({command:Pi.setImportUrl,args:[D.id,D.url]});const L=D.data;Tt(z&&z.data,L)||p.push({command:Pi.setImportData,args:[D.id,L]})}}(r.imports,o.imports,s),Tt(r.transition,o.transition)||s.push({command:Pi.setTransition,args:[o.transition]}),Tt(r.light,o.light)||s.push({command:Pi.setLight,args:[o.light]}),Tt(r.fog,o.fog)||s.push({command:Pi.setFog,args:[o.fog]}),Tt(r.projection,o.projection)||s.push({command:Pi.setProjection,args:[o.projection]}),Tt(r.lights,o.lights)||s.push({command:Pi.setLights,args:[o.lights]}),Tt(r.camera,o.camera)||s.push({command:Pi.setCamera,args:[o.camera]});const a={},l=[];(function(h,d,p,_){let g;for(g in d=d||{},h=h||{})h.hasOwnProperty(g)&&(d.hasOwnProperty(g)||Fb(g,p,_));for(g in d){if(!d.hasOwnProperty(g))continue;const y=d[g];h.hasOwnProperty(g)?Tt(h[g],y)||(h[g].type==="geojson"&&y.type==="geojson"&&jI(h,d,g)?p.push({command:Pi.setGeoJSONSourceData,args:[g,y.data]}):VI(g,d,p,_)):Bb(g,d,p)}})(r.sources,o.sources,l,a);const c=[];r.layers&&r.layers.forEach(h=>{h.source&&a[h.source]?s.push({command:Pi.removeLayer,args:[h.id]}):c.push(h)});let u=r.terrain;u&&a[u.source]&&(s.push({command:Pi.setTerrain,args:[void 0]}),u=void 0),s=s.concat(l),Tt(u,o.terrain)||s.push({command:Pi.setTerrain,args:[o.terrain]}),function(h,d,p){d=d||[];const _=(h=h||[]).map(dd),g=d.map(dd),y=h.reduce(fd,{}),x=d.reduce(fd,{}),b=_.slice(),M=Object.create(null);let E,T,S,D,z,L,R;for(E=0,T=0;E<_.length;E++)S=_[E],x.hasOwnProperty(S)?T++:(p.push({command:Pi.removeLayer,args:[S]}),b.splice(b.indexOf(S,T),1));for(E=0,T=0;E<g.length;E++)S=g[g.length-1-E],b[b.length-1-E]!==S&&(y.hasOwnProperty(S)?(p.push({command:Pi.removeLayer,args:[S]}),b.splice(b.lastIndexOf(S,b.length-T),1)):T++,L=b[b.length-E],p.push({command:Pi.addLayer,args:[x[S],L]}),b.splice(b.length-E,0,S),M[S]=!0);for(E=0;E<g.length;E++)if(S=g[E],D=y[S],z=x[S],!M[S]&&!Tt(D,z))if(Tt(D.source,z.source)&&Tt(D["source-layer"],z["source-layer"])&&Tt(D.type,z.type)){for(R in hd(D.layout,z.layout,p,S,null,Pi.setLayoutProperty),hd(D.paint,z.paint,p,S,null,Pi.setPaintProperty),Tt(D.slot,z.slot)||p.push({command:Pi.setSlot,args:[S,z.slot]}),Tt(D.filter,z.filter)||p.push({command:Pi.setFilter,args:[S,z.filter]}),Tt(D.minzoom,z.minzoom)&&Tt(D.maxzoom,z.maxzoom)||p.push({command:Pi.setLayerZoomRange,args:[S,z.minzoom,z.maxzoom]}),D)D.hasOwnProperty(R)&&R!=="layout"&&R!=="paint"&&R!=="filter"&&R!=="metadata"&&R!=="minzoom"&&R!=="maxzoom"&&R!=="slot"&&(R.indexOf("paint.")===0?hd(D[R],z[R],p,S,R.slice(6),Pi.setPaintProperty):Tt(D[R],z[R])||p.push({command:Pi.setLayerProperty,args:[S,R,z[R]]}));for(R in z)z.hasOwnProperty(R)&&!D.hasOwnProperty(R)&&R!=="layout"&&R!=="paint"&&R!=="filter"&&R!=="metadata"&&R!=="minzoom"&&R!=="maxzoom"&&R!=="slot"&&(R.indexOf("paint.")===0?hd(D[R],z[R],p,S,R.slice(6),Pi.setPaintProperty):Tt(D[R],z[R])||p.push({command:Pi.setLayerProperty,args:[S,R,z[R]]}))}else p.push({command:Pi.removeLayer,args:[S]}),L=b[b.lastIndexOf(S)+1],p.push({command:Pi.addLayer,args:[z,L]})}(c,o.layers,s)}catch(a){console.warn("Unable to compute style diff:",a),s=[{command:Pi.setStyle,args:[o]}]}return s}(this.serialize(),t).filter(r=>!(r.command in mD));if(i.length===0)return!1;const n=i.filter(r=>!(r.command in pD));if(n.length>0)throw new Error(`Unimplemented: ${n.map(r=>r.command).join(", ")}.`);return i.forEach(r=>{this[r.command].apply(this,r.args)}),this.stylesheet=t,this.mergeAll(),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),!0}addImage(t,i){return this.getImage(t)?this.fire(new Ae(new Error("An image with this name already exists."))):(this.imageManager.addImage(t,this.scope,i),this._afterImageUpdated(t),this)}updateImage(t,i){this.imageManager.updateImage(t,this.scope,i)}getImage(t){return this.imageManager.getImage(t,this.scope)}removeImage(t){return this.getImage(t)?(this.imageManager.removeImage(t,this.scope),this._afterImageUpdated(t),this):this.fire(new Ae(new Error("No image with this name exists.")))}_afterImageUpdated(t){this._availableImages=this.imageManager.listImages(this.scope),this._changes.updateImage(t),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages}),this.fire(new jt("data",{dataType:"style"}))}listImages(){return this._checkLoaded(),this._availableImages.slice()}addModel(t,i,n={}){return this._checkLoaded(),this._validate(ZM,`models.${t}`,i,null,n)||(this.modelManager.addModel(t,i,this.scope),this._changes.setDirty()),this}hasModel(t){return this.modelManager.hasModel(t,this.scope)}removeModel(t){return this.hasModel(t)?(this.modelManager.removeModel(t,this.scope),this):this.fire(new Ae(new Error("No model with this ID exists.")))}listModels(){return this._checkLoaded(),this.modelManager.listModels(this.scope)}addSource(t,i,n={}){if(this._checkLoaded(),this.getOwnSource(t)!==void 0)throw new Error(`There is already a source with ID "${t}".`);if(!i.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(i).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(i.type)>=0&&this._validate(BM,`sources.${t}`,i,null,n))return;this.map&&this.map._collectResourceTiming&&(i.collectResourceTiming=!0);const r=h_(t,i,this.dispatcher,this);r.scope=this.scope,r.setEventedParent(this,()=>({isSourceLoaded:this._isSourceCacheLoaded(r.id),source:r.serialize(),sourceId:r.id}));const o=s=>{const a=(s?"symbol:":"other:")+r.id,l=cr(a,this.scope),c=this._sourceCaches[a]=new co(l,r,s);(s?this._symbolSourceCaches:this._otherSourceCaches)[r.id]=c,c.onAdd(this.map)};o(!1),i.type!=="vector"&&i.type!=="geojson"||o(!0),r.onAdd&&r.onAdd(this.map),n.isInitialLoad||(this.mergeSources(),this._changes.setDirty())}removeSource(t){this._checkLoaded();const i=this.getOwnSource(t);if(!i)throw new Error("There is no source with this ID");for(const r in this._layers)if(this._layers[r].source===t)return this.fire(new Ae(new Error(`Source "${t}" cannot be removed while layer "${r}" is using it.`)));if(this.terrain&&this.terrain.scope===this.scope&&this.terrain.get().source===t)return this.fire(new Ae(new Error(`Source "${t}" cannot be removed while terrain is using it.`)));const n=this.getOwnSourceCaches(t);for(const r of n){const o=Ju(r.id);delete this._sourceCaches[o],this._changes.discardSourceCacheUpdate(r.id),r.fire(new jt("data",{sourceDataType:"metadata",dataType:"source",sourceId:r.getSource().id})),r.setEventedParent(null),r.clearTiles()}return delete this._otherSourceCaches[t],delete this._symbolSourceCaches[t],this.mergeSources(),i.setEventedParent(null),i.onRemove&&i.onRemove(this.map),this._changes.setDirty(),this}setGeoJSONSourceData(t,i){this._checkLoaded(),this.getOwnSource(t).setData(i),this._changes.setDirty()}getOwnSource(t){const i=this.getOwnSourceCache(t);return i&&i.getSource()}getOwnSources(){const t=[];for(const i in this._otherSourceCaches){const n=this.getOwnSourceCache(i);n&&t.push(n.getSource())}return t}setLights(t){if(this._checkLoaded(),!t)return delete this.ambientLight,void delete this.directionalLight;const i=this._getTransitionParameters();for(const r of t){if(this._validate(NM,"lights",r))return;switch(r.type){case"ambient":if(this.ambientLight){const o=this.ambientLight;o.set(r),o.updateTransitions(i)}else this.ambientLight=new _b(r,wI,this.scope,this.options);break;case"directional":if(this.directionalLight){const o=this.directionalLight;o.set(r),o.updateTransitions(i)}else this.directionalLight=new _b(r,TI,this.scope,this.options)}}const n=new dn(this.z||0,i);this.ambientLight&&this.ambientLight.recalculate(n),this.directionalLight&&this.directionalLight.recalculate(n),this._brightness=this.calculateLightsBrightness(),this.dispatcher.broadcast("setBrightness",this._brightness)}calculateLightsBrightness(){const t=this.directionalLight,i=this.ambientLight;if(!t||!i)return;const n=h=>.2126*(h[0]<=.03928?h[0]/12.92:Math.pow((h[0]+.055)/1.055,2.4))+.7152*(h[1]<=.03928?h[1]/12.92:Math.pow((h[1]+.055)/1.055,2.4))+.0722*(h[2]<=.03928?h[2]/12.92:Math.pow((h[2]+.055)/1.055,2.4)),r=t.properties.get("color").toArray01(),o=t.properties.get("intensity"),s=t.properties.get("direction"),a=1-ie(s.x,s.y,s.z)[2]/90,l=n(r)*o*a,c=i.properties.get("color").toArray01(),u=i.properties.get("intensity");return(l+n(c)*u)/2}getBrightness(){return this._brightness}getLights(){if(!this.enable3dLights())return null;const t=[];return this.directionalLight&&t.push(this.directionalLight.get()),this.ambientLight&&t.push(this.ambientLight.get()),t}enable3dLights(){return!!this.ambientLight&&!!this.directionalLight}getFragmentStyle(t){if(!t)return this;if(G0(t)){const i=function(o){const s=o.indexOf(Ku);return s>=0?o.slice(s+1):""}(t),n=this.fragments.find(({id:o})=>o===i);if(!n)throw new Error(`Style import not found: ${t}`);const r=Ju(t);return n.style.getFragmentStyle(r)}{const i=this.fragments.find(({id:n})=>n===t);if(!i)throw new Error(`Style import not found: ${t}`);return i.style}}getConfigProperty(t,i){const n=this.getFragmentStyle(t);if(!n)return null;const r=n.options.get(i),o=r?r.value||r.default:null;return o?o.serialize():null}setConfigProperty(t,i,n){const r=Ps(n);if(r.result!=="success")return void du(this,r.value);const o=r.value.expression,s=this.getFragmentStyle(t);if(!s)return;const a=s.options.get(i);a&&(s.options.set(i,{...a,value:o}),s.updateConfigDependencies())}setConfig(t,i){if(this._config=t,t||i)if(i){this.options.clear();for(const n in i){let r,o;const s=Ps(i[n].default);if(s.result==="success"&&(r=s.value.expression),t&&t[n]!==void 0){const d=Ps(t[n]);d.result==="success"&&(o=d.value.expression)}const{minValue:a,maxValue:l,stepValue:c,type:u,values:h}=i[n];r?this.options.set(n,{default:r,value:o,minValue:a,maxValue:l,stepValue:c,type:u,values:h}):this.fire(new Ae(new Error(`No schema defined for config option "${n}".`)))}}else this.fire(new Ae(new Error("Attempting to set config for a style without schema.")))}updateConfigDependencies(){for(const t of this._configDependentLayers){const i=this.getLayer(t);i&&(i.possiblyEvaluateVisibility(),this._updateLayer(i))}this.ambientLight&&this.ambientLight.scope===this.scope&&this.ambientLight.updateConfig(this.options),this.directionalLight&&this.directionalLight.scope===this.scope&&this.directionalLight.updateConfig(this.options),this._changes.setDirty()}addLayer(t,i,n={}){this._checkLoaded();const r=t.id;if(this._layers[r])return void this.fire(new Ae(new Error(`Layer with id "${r}" already exists on this map`)));let o;if(t.type==="custom"){if(du(this,function(u){const h=[],d=u.id;return d===void 0&&h.push({message:`layers.${d}: missing required property "id"`}),u.render===void 0&&h.push({message:`layers.${d}: missing required method "render"`}),u.renderingMode&&u.renderingMode!=="2d"&&u.renderingMode!=="3d"&&h.push({message:`layers.${d}: property "renderingMode" must be either "2d" or "3d"`}),h}(t)))return;o=ad(t,this.options)}else{if(typeof t.source=="object"&&(this.addSource(r,t.source),t=Vt(t=F(t),{source:r})),this._validate(jM,`layers.${r}`,t,{arrayIndex:-1},n))return;o=ad(t,this.options),this._validateLayer(o),o.setEventedParent(this,{layer:{id:r}}),this._serializedLayers[o.id]=o.serialize()}o.isConfigDependent&&this._configDependentLayers.add(o.fqid),o.setScope(this.scope);let s=this._order.length;if(i){const u=this._order.indexOf(i);if(u===-1)return void this.fire(new Ae(new Error(`Layer with id "${i}" does not exist on this map.`)));o.slot===this._layers[i].slot?s=u:J(`Layer with id "${i}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(s,0,r),this._layerOrderChanged=!0,this._layers[r]=o;const a=this.getOwnLayerSourceCache(o),l=!!this.directionalLight&&this.directionalLight.shadowsEnabled();a&&o.canCastShadows()&&l&&(a.castsShadows=!0);const c=this._changes.getRemovedLayer(o);if(c&&o.source&&a&&o.type!=="custom"){this._changes.discardLayerRemoval(o);const u=cr(o.source,o.scope);c.type!==o.type?this._changes.updateSourceCache(u,"clear"):(this._changes.updateSourceCache(u,"reload"),a.pause())}this._updateLayer(o),o.onAdd&&o.onAdd(this.map),o.scope=this.scope,this.mergeLayers()}moveLayer(t,i){this._checkLoaded();const n=this._checkLayer(t);if(!n||t===i)return;const r=this._order.indexOf(t);this._order.splice(r,1);let o=this._order.length;if(i){const s=this._order.indexOf(i);if(s===-1)return void this.fire(new Ae(new Error(`Layer with id "${i}" does not exist on this map.`)));n.slot===this._layers[i].slot?o=s:J(`Layer with id "${i}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(o,0,t),this._changes.setDirty(),this._layerOrderChanged=!0,this.mergeLayers()}removeLayer(t){this._checkLoaded();const i=this._checkLayer(t);if(!i)return;i.setEventedParent(null);const n=this._order.indexOf(t);this._order.splice(n,1),delete this._layers[t],delete this._serializedLayers[t],this._changes.setDirty(),this._layerOrderChanged=!0,this._configDependentLayers.delete(i.fqid),this._changes.removeLayer(i);const r=this.getOwnLayerSourceCache(i);if(r&&r.castsShadows){let o=!1;for(const s in this._layers)if(this._layers[s].source===i.source&&this._layers[s].canCastShadows()){o=!0;break}r.castsShadows=o}i.onRemove&&i.onRemove(this.map),this.mergeLayers()}getOwnLayer(t){return this._layers[t]}hasLayer(t){return t in this._mergedLayers}hasLayerType(t){for(const i in this._layers)if(this._layers[i].type===t)return!0;return!1}setLayerZoomRange(t,i,n){this._checkLoaded();const r=this._checkLayer(t);r&&(r.minzoom===i&&r.maxzoom===n||(i!=null&&(r.minzoom=i),n!=null&&(r.maxzoom=n),this._updateLayer(r)))}setSlot(t,i){this._checkLoaded();const n=this._checkLayer(t);n&&n.slot!==i&&(n.slot=i,this._updateLayer(n))}setFilter(t,i,n={}){this._checkLoaded();const r=this._checkLayer(t);if(r&&!Tt(r.filter,i))return i==null?(r.filter=void 0,void this._updateLayer(r)):void(this._validate(op,`layers.${r.id}.filter`,i,{layerType:r.type},n)||(r.filter=F(i),this._updateLayer(r)))}getFilter(t){const i=this._checkLayer(t);if(i)return F(i.filter)}setLayoutProperty(t,i,n,r={}){this._checkLoaded();const o=this._checkLayer(t);o&&(Tt(o.getLayoutProperty(i),n)||(o.setLayoutProperty(i,n,r),o.isConfigDependent&&this._configDependentLayers.add(o.fqid),this._updateLayer(o)))}getLayoutProperty(t,i){const n=this._checkLayer(t);if(n)return n.getLayoutProperty(i)}setPaintProperty(t,i,n,r={}){this._checkLoaded();const o=this._checkLayer(t);if(!o||Tt(o.getPaintProperty(i),n))return;const s=o.setPaintProperty(i,n,r);o.isConfigDependent&&this._configDependentLayers.add(o.fqid),s&&this._updateLayer(o),this._changes.updatePaintProperties(o)}getPaintProperty(t,i){const n=this._checkLayer(t);if(n)return n.getPaintProperty(i)}setFeatureState(t,i){this._checkLoaded();const n=t.source,r=t.sourceLayer,o=this._checkSource(n);if(!o)return;const s=o.type;if(s==="geojson"&&r)return void this.fire(new Ae(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if(s==="vector"&&!r)return void this.fire(new Ae(new Error("The sourceLayer parameter must be provided for vector source types.")));t.id===void 0&&this.fire(new Ae(new Error("The feature id parameter must be provided.")));const a=this.getOwnSourceCaches(n);for(const l of a)l.setFeatureState(r,t.id,i)}removeFeatureState(t,i){this._checkLoaded();const n=t.source,r=this._checkSource(n);if(!r)return;const o=r.type,s=o==="vector"?t.sourceLayer:void 0;if(o==="vector"&&!s)return void this.fire(new Ae(new Error("The sourceLayer parameter must be provided for vector source types.")));if(i&&typeof t.id!="string"&&typeof t.id!="number")return void this.fire(new Ae(new Error("A feature id is required to remove its specific state property.")));const a=this.getOwnSourceCaches(n);for(const l of a)l.removeFeatureState(s,t.id,i)}getFeatureState(t){this._checkLoaded();const i=t.source,n=t.sourceLayer,r=this._checkSource(i);if(r){if(r.type!=="vector"||n)return t.id===void 0&&this.fire(new Ae(new Error("The feature id parameter must be provided."))),this.getOwnSourceCaches(i)[0].getFeatureState(n,t.id);this.fire(new Ae(new Error("The sourceLayer parameter must be provided for vector source types.")))}}setTransition(t){return this.stylesheet.transition=Vt({},this.stylesheet.transition,t),this.transition=this.stylesheet.transition,this}getTransition(){return Vt({},this.stylesheet.transition)}serialize(){this._checkLoaded();const t=this.getTerrain(),i=t&&this.terrain&&this.terrain.scope===this.scope?t:this.stylesheet.terrain;return Dt({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,imports:this._serializeImports(),schema:this.stylesheet.schema,camera:this.stylesheet.camera,light:this.stylesheet.light,lights:this.stylesheet.lights,terrain:i,fog:this.stylesheet.fog,center:this.stylesheet.center,zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:this._serializeSources(),layers:this._serializeLayers(this._order)},n=>n!==void 0)}_updateLayer(t){this._changes.updateLayer(t);const i=this.getLayerSourceCache(t),n=cr(t.source,t.scope),r=this._changes.getUpdatedSourceCaches();t.source&&!r[n]&&i&&i.getSource().type!=="raster"&&(this._changes.updateSourceCache(n,"reload"),i.pause()),t.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(t){const i=a=>this._mergedLayers[a].type==="fill-extrusion",n=this.order,r={},o=[];for(let a=n.length-1;a>=0;a--){const l=n[a];if(i(l)){r[l]=a;for(const c of t){const u=c[l];if(u)for(const h of u)o.push(h)}}}o.sort((a,l)=>l.intersectionZ-a.intersectionZ);const s=[];for(let a=n.length-1;a>=0;a--){const l=n[a];if(i(l))for(let c=o.length-1;c>=0;c--){const u=o[c].feature;if(r[u.layer.id]<a)break;s.push(u),o.pop()}else for(const c of t){const u=c[l];if(u)for(const h of u)s.push(h.feature)}}return s}queryRenderedFeatures(t,i,n){i&&i.filter&&this._validate(op,"queryRenderedFeatures.filter",i.filter,null,i),i.scope=this.scope,i.availableImages=this._availableImages,i.serializedLayers=this._serializedLayers;const r={};if(i&&i.layers){if(!Array.isArray(i.layers))return this.fire(new Ae(new Error("parameters.layers must be an Array."))),[];for(const c of i.layers){const u=this._mergedLayers[c];if(!u)return this.fire(new Ae(new Error(`The layer '${c}' does not exist in the map's style and cannot be queried for features.`))),[];r[u.source]=!0}}const o=[],s=i.serializedLayers||{},a=i&&i.layers?i.layers.some(c=>{const u=this.getLayer(c);return u&&u.is3D()}):this.has3DLayers(),l=Ym.createFromScreenPoints(t,n);for(const c in this._mergedSourceCaches){const u=this._mergedSourceCaches[c].getSource();if(!u||u.scope!==i.scope)continue;const h=this._mergedSourceCaches[c].getSource().id;i.layers&&!r[h]||o.push(BI(this._mergedSourceCaches[c],this._mergedLayers,s,l,i,n,a,!!this.map._showQueryGeometry))}return this.placement&&o.push(function(c,u,h,d,p,_,g){const y={},x=_.queryRenderedSymbols(d),b=[];for(const M of Object.keys(x).map(Number))b.push(g[M]);b.sort(Lb);for(const M of b){const E=M.featureIndex.lookupSymbolFeatures(x[M.bucketInstanceId],u,M.bucketIndex,M.sourceLayerIndex,p.filter,p.layers,p.availableImages,c);for(const T in E){const S=y[T]=y[T]||[],D=E[T];D.sort((z,L)=>{const R=M.featureSortOrder;if(R){const N=R.indexOf(z.featureIndex);return R.indexOf(L.featureIndex)-N}return L.featureIndex-z.featureIndex});for(const z of D)S.push(z)}}for(const M in y)y[M].forEach(E=>{const T=E.feature,S=h(c[M]);if(!S)return;const D=S.getFeatureState(T.layer["source-layer"],T.id);T.source=T.layer.source,T.layer["source-layer"]&&(T.sourceLayer=T.layer["source-layer"]),T.state=D});return y}(this._mergedLayers,s,this.getLayerSourceCache.bind(this),l.screenGeometry,i,this.placement.collisionIndex,this.placement.retainedQueryData)),this._flattenAndSortRenderedFeatures(o)}querySourceFeatures(t,i){i&&i.filter&&this._validate(op,"querySourceFeatures.filter",i.filter,null,i);const n=this.getOwnSourceCaches(t);let r=[];for(const o of n)r=r.concat(FI(o,i));return r}addSourceType(t,i,n){return fo.getSourceType(t)?n(new Error(`A source type called "${t}" already exists.`)):(fo.setSourceType(t,i),i.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:t,url:i.workerSourceURL},n):n(null,null))}getFlatLight(){return this.light.getLight()}setFlatLight(t,i,n={}){this._checkLoaded();const r=this.light.getLight();let o=!1;for(const a in t)if(!Tt(t[a],r[a])){o=!0;break}if(!o)return;const s=this._getTransitionParameters();this.light.setLight(t,i,n),this.light.updateTransitions(s)}getTerrain(){return this.terrain&&this.terrain.drapeRenderMode===1?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}setTerrain(t,i=1){if(this._checkLoaded(),!t)return delete this.terrain,t===null?this.stylesheet.terrain=null:delete this.stylesheet.terrain,this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);let n=t;const r=t.source==null;if(i===1){if(typeof n.source=="object"){const a="terrain-dem-src";this.addSource(a,n.source),n=F(n),n=Vt(n,{source:a})}const o=Vt({},n),s={};if(this.terrain&&r){o.source=this.terrain.get().source;const a=this.terrain?this.getFragmentStyle(this.terrain.scope):null;a&&(s.style=a.serialize())}if(this._validate(UM,"terrain",o,s))return}if(!this.terrain||this.terrain.scope!==this.scope&&!r||this.terrain&&i!==this.terrain.drapeRenderMode){if(!n)return;this._createTerrain(n,i),this.fire(new jt("data",{dataType:"style"}))}else{const o=this.terrain,s=o.get();for(const a of Object.keys(rt.terrain))!n.hasOwnProperty(a)&&rt.terrain[a].default&&(n[a]=rt.terrain[a].default);for(const a in t)if(!Tt(t[a],s[a])){o.set(t,this.options),this.stylesheet.terrain=t;const l=this._getTransitionParameters({duration:0});o.updateTransitions(l),this.fire(new jt("data",{dataType:"style"}));break}}this.mergeTerrain(),this.updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(t){const i=this.fog=new vI(t,this.map.transform);this.stylesheet.fog=i.get();const n=this._getTransitionParameters({duration:0});i.updateTransitions(n)}_updateMarkersOpacity(){this.map._markers.length!==0&&this.map._requestDomTask(()=>{for(const t of this.map._markers)t._evaluateOpacity()})}getFog(){return this.fog?this.fog.get():null}setFog(t){if(this._checkLoaded(),!t)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){const i=this.fog;if(!Tt(i.get(),t)){i.set(t),this.stylesheet.fog=i.get();const n=this._getTransitionParameters({duration:0});i.updateTransitions(n)}}else this._createFog(t);this._markersNeedUpdate=!0}_getTransitionParameters(t){return{now:ke.now(),transition:Vt(this.transition,t)}}updateDrapeFirstLayers(){if(!this.terrain)return;const t=[],i=[];for(const n in this._mergedLayers)this.isLayerDraped(this._mergedLayers[n])?t.push(n):i.push(n);this._drapedFirstOrder=[],this._drapedFirstOrder.push(...t),this._drapedFirstOrder.push(...i)}_createTerrain(t,i){const n=this.terrain=new gI(t,i,this.scope,this.options);i===1&&(this.stylesheet.terrain=t),this.mergeTerrain(),this.updateDrapeFirstLayers(),this._force3DLayerUpdate();const r=this._getTransitionParameters({duration:0});n.updateTransitions(r)}_force3DLayerUpdate(){for(const t in this._layers){const i=this._layers[t];i.type==="fill-extrusion"&&this._updateLayer(i)}}_forceSymbolLayerUpdate(){for(const t in this._layers){const i=this._layers[t];i.type==="symbol"&&this._updateLayer(i)}}_validate(t,i,n,r,o={}){if(o&&o.validate===!1)return!1;const s=Vt({},this.serialize());return du(this,t.call(dl,Vt({key:i,style:s,value:n,styleSpec:rt},r)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),fp.off("pluginStateChange",this._rtlTextPluginCallback);for(const t in this._mergedLayers)this._mergedLayers[t].setEventedParent(null);for(const t in this._mergedSourceCaches)this._mergedSourceCaches[t].clearTiles(),this._mergedSourceCaches[t].setEventedParent(null);this.setEventedParent(null),delete this.fog,delete this.terrain,delete this.ambientLight,delete this.directionalLight,this.isRootStyle()&&(this.imageManager.setEventedParent(null),this.modelManager.setEventedParent(null),this.dispatcher.remove())}clearSource(t){const i=this.getSourceCaches(t);for(const n of i)n.clearTiles()}clearSources(){for(const t in this._mergedSourceCaches)this._mergedSourceCaches[t].clearTiles()}reloadSource(t){const i=this.getSourceCaches(t);for(const n of i)n.resume(),n.reload()}reloadSources(){for(const t of this.getSources())t.reload&&t.reload()}updateSources(t){let i;this.directionalLight&&(i=Bw(this.directionalLight));for(const n in this._mergedSourceCaches)this._mergedSourceCaches[n].update(t,void 0,void 0,i)}_generateCollisionBoxes(){for(const t in this._sourceCaches){const i=this._sourceCaches[t];i.resume(),i.reload()}}_updatePlacement(t,i,n,r,o=!1){let s=!1,a=!1;const l={},c={};for(const u of this._mergedOrder){const h=this._mergedLayers[u];if(h.type!=="symbol")continue;const d=cr(h.source,h.scope);let p=l[d];if(!p){const g=this.getLayerSourceCache(h);if(!g)continue;const y=g.getRenderableIds(!0).map(x=>g.getTileByID(x));c[d]=y.slice(),p=l[d]=y.sort((x,b)=>b.tileID.overscaledZ-x.tileID.overscaledZ||(x.tileID.isLessThan(b.tileID)?-1:1))}const _=this.crossTileSymbolIndex.addLayer(h,p,t.center.lng,t.projection);s=s||_}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._mergedOrder),o=o||this._layerOrderChanged||n===0,this._layerOrderChanged&&this.fire(new jt("neworder")),(o||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(ke.now(),t.zoom))&&(this.pauseablePlacement=new rC(t,this._mergedOrder,o,i,n,r,this.placement,this.fog&&t.projection.supportsFog?this.fog.state:null,this._buildingIndex),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._mergedOrder,this._mergedLayers,l,c),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(ke.now()),a=!0),s&&this.pauseablePlacement.placement.setStale()),a||s)for(const u of this._mergedOrder){const h=this._mergedLayers[u];h.type==="symbol"&&this.placement.updateLayerOpacities(h,l[cr(h.source,h.scope)])}return!this.pauseablePlacement.isDone()||this.placement.hasTransitions(ke.now())}_releaseSymbolFadeTiles(){for(const t in this._sourceCaches)this._sourceCaches[t].releaseSymbolFadeTiles()}addImport(t){this._checkLoaded();const i=this.stylesheet.imports=this.stylesheet.imports||[];return i.findIndex(({id:r})=>r===t.id)!==-1?this.fire(new Ae(new Error(`Import with id '${t.id}' already exists in the map's style.`))):(i.push(t),this._loadImports([t],!0),this)}setImportUrl(t,i){this._checkLoaded();const n=this.stylesheet.imports||[],r=this.getImportIndex(t);if(r===-1)return this;n[r].url=i;const o=this.fragments[r];return o.style=this._createFragmentStyle(n[r]),o.style.on("style.import.load",()=>this.mergeAll()),o.style.loadURL(i),this}setImportData(t,i){this._checkLoaded();const n=this.getImportIndex(t),r=this.stylesheet.imports||[];return n===-1?this:i?(this.fragments[n].style.setState(i),this._reloadImports(),this):(delete r[n].data,this.setImportUrl(t,r[n].url))}setImportConfig(t,i){this._checkLoaded();const n=this.getImportIndex(t),r=this.stylesheet.imports||[];if(n===-1)return this;i?r[n].config=i:delete r[n].config;const o=this.fragments[n],s=o.style.stylesheet&&o.style.stylesheet.schema;return o.config=i,o.style.setConfig(i,s),o.style.updateConfigDependencies(),this}removeImport(t){this._checkLoaded();const i=this.stylesheet.imports||[],n=this.getImportIndex(t);return n===-1||(i.splice(n,1),this.fragments[n].style._remove(),this.fragments.splice(n,1),this._reloadImports()),this}getImportIndex(t){const i=(this.stylesheet.imports||[]).findIndex(n=>n.id===t);return i===-1&&this.fire(new Ae(new Error(`Import '${t}' does not exist in the map's style and cannot be updated.`))),i}getLayer(t){return this._mergedLayers[t]}getSources(){const t=[];for(const i in this._mergedOtherSourceCaches){const n=this._mergedOtherSourceCaches[i];n&&t.push(n.getSource())}return t}getSource(t,i){const n=this.getSourceCache(t,i);return n&&n.getSource()}getLayerSource(t){const i=this.getLayerSourceCache(t);return i&&i.getSource()}getSourceCache(t,i){const n=cr(t,i);return this._mergedOtherSourceCaches[n]}getLayerSourceCache(t){const i=cr(t.source,t.scope);return t.type==="symbol"?this._mergedSymbolSourceCaches[i]:this._mergedOtherSourceCaches[i]}getSourceCaches(t){const i=[];return this._mergedOtherSourceCaches[t]&&i.push(this._mergedOtherSourceCaches[t]),this._mergedSymbolSourceCaches[t]&&i.push(this._mergedSymbolSourceCaches[t]),i}updateSourceCaches(){const t=this._changes.getUpdatedSourceCaches();for(const i in t){const n=t[i];n==="reload"?this.reloadSource(i):n==="clear"&&this.clearSource(i)}}updateLayers(t){const i=this._changes.getUpdatedPaintProperties();for(const n of i){const r=this.getLayer(n);r&&r.updateTransitions(t)}}getImages(t,i,n){this.imageManager.getImages(i.icons,i.scope,n),this._updateTilesForChangedImages();const r=o=>{o&&o.setDependencies(i.tileID.key,i.type,i.icons)};r(this._otherSourceCaches[i.source]),r(this._symbolSourceCaches[i.source])}getGlyphs(t,i,n){this.glyphManager.getGlyphs(i.stacks,i.scope,n)}getResource(t,i,n){return Ft(i,n)}getOwnSourceCache(t){return this._otherSourceCaches[t]}getOwnLayerSourceCache(t){return t.type==="symbol"?this._symbolSourceCaches[t.source]:this._otherSourceCaches[t.source]}getOwnSourceCaches(t){const i=[];return this._otherSourceCaches[t]&&i.push(this._otherSourceCaches[t]),this._symbolSourceCaches[t]&&i.push(this._symbolSourceCaches[t]),i}_isSourceCacheLoaded(t){const i=this.getOwnSourceCaches(t);return i.length===0?(this.fire(new Ae(new Error(`There is no source with ID '${t}'`))),!1):i.every(n=>n.loaded())}has3DLayers(){return this._has3DLayers}hasSymbolLayers(){return this._hasSymbolLayers}hasCircleLayers(){return this._hasCircleLayers}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}}function Uw(e,t){let i=!1,n=null;const r=()=>{n=null,i&&(e(),n=setTimeout(r,t),i=!1)};return()=>(i=!0,n||r(),n)}fo.getSourceType=function(e){return u_[e]},fo.setSourceType=function(e,t){u_[e]=t},fo.registerForPluginStateChange=function(e){return e({pluginStatus:wr,pluginURL:Ls}),fp.on("pluginStateChange",e),e};class gD{constructor(t){this._hashName=t&&encodeURIComponent(t),Xe(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=Uw(this._updateHashUnthrottled.bind(this),300)}addTo(t){return this._map=t,I.addEventListener("hashchange",this._onHashChange,!1),t.on("moveend",this._updateHash),this}remove(){return this._map?(this._map.off("moveend",this._updateHash),I.removeEventListener("hashchange",this._onHashChange,!1),clearTimeout(this._updateHash()),this._map=void 0,this):this}getHashString(){const t=this._map;if(!t)return"";const i=Vw(t);if(this._hashName){const n=this._hashName;let r=!1;const o=I.location.hash.slice(1).split("&").map(s=>{const a=s.split("=")[0];return a===n?(r=!0,`${a}=${i}`):s}).filter(s=>s);return r||o.push(`${n}=${i}`),`#${o.join("&")}`}return`#${i}`}_getCurrentHash(){const t=I.location.hash.replace("#","");if(this._hashName){let i;return t.split("&").map(n=>n.split("=")).forEach(n=>{n[0]===this._hashName&&(i=n)}),(i&&i[1]||"").split("/")}return t.split("/")}_onHashChange(){const t=this._map;if(!t)return!1;const i=this._getCurrentHash();if(i.length>=3&&!i.some(n=>isNaN(n))){const n=t.dragRotate.isEnabled()&&t.touchZoomRotate.isEnabled()?+(i[3]||0):t.getBearing();return t.jumpTo({center:[+i[2],+i[1]],zoom:+i[0],bearing:n,pitch:+(i[4]||0)}),!0}return!1}_updateHashUnthrottled(){const t=I.location.href.replace(/(#.+)?$/,this.getHashString());I.history.replaceState(I.history.state,null,t)}}function Vw(e,t){const i=e.getCenter(),n=Math.round(100*e.getZoom())/100,r=Math.ceil((n*Math.LN2+Math.log(512/360/.5))/Math.LN10),o=Math.pow(10,r),s=Math.round(i.lng*o)/o,a=Math.round(i.lat*o)/o,l=e.getBearing(),c=e.getPitch();let u=t?`/${s}/${a}/${n}`:`${n}/${a}/${s}`;return(l||c)&&(u+="/"+Math.round(10*l)/10),c&&(u+=`/${Math.round(c)}`),u}const Ed={linearity:.3,easing:Pe(0,0,.3,1)},yD=Vt({deceleration:2500,maxSpeed:1400},Ed),vD=Vt({deceleration:20,maxSpeed:1400},Ed),xD=Vt({deceleration:1e3,maxSpeed:360},Ed),bD=Vt({deceleration:1e3,maxSpeed:90},Ed);class wD{constructor(t){this._map=t,this.clear()}clear(){this._inertiaBuffer=[]}record(t){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:ke.now(),settings:t})}_drainInertiaBuffer(){const t=this._inertiaBuffer,i=ke.now();for(;t.length>0&&i-t[0].time>160;)t.shift()}_onMoveEnd(t){if(this._map._prefersReducedMotion()||(this._drainInertiaBuffer(),this._inertiaBuffer.length<2))return;const i={zoom:0,bearing:0,pitch:0,pan:new G(0,0),pinchAround:void 0,around:void 0};for(const{settings:o}of this._inertiaBuffer)i.zoom+=o.zoomDelta||0,i.bearing+=o.bearingDelta||0,i.pitch+=o.pitchDelta||0,o.panDelta&&i.pan._add(o.panDelta),o.around&&(i.around=o.around),o.pinchAround&&(i.pinchAround=o.pinchAround);const n=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,r={};if(i.pan.mag()){const o=Ad(i.pan.mag(),n,Vt({},yD,t||{}));r.offset=i.pan.mult(o.amount/i.pan.mag()),r.center=this._map.transform.center,Sd(r,o)}if(i.zoom){const o=Ad(i.zoom,n,vD);r.zoom=this._map.transform.zoom+o.amount,Sd(r,o)}if(i.bearing){const o=Ad(i.bearing,n,xD);r.bearing=this._map.transform.bearing+Lt(o.amount,-179,179),Sd(r,o)}if(i.pitch){const o=Ad(i.pitch,n,bD);r.pitch=this._map.transform.pitch+o.amount,Sd(r,o)}if(r.zoom||r.bearing){const o=i.pinchAround===void 0?i.around:i.pinchAround;r.around=o?this._map.unproject(o):this._map.getCenter()}return this.clear(),r.noMoveStart=!0,r}}function Sd(e,t){(!e.duration||e.duration<t.duration)&&(e.duration=t.duration,e.easing=t.easing)}function Ad(e,t,i){const{maxSpeed:n,linearity:r,deceleration:o}=i,s=Lt(e*r/(t/1e3),-n,n),a=Math.abs(s)/(o*r);return{easing:i.easing,duration:1e3*a,amount:s*(a/2)}}class Nr extends jt{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,i,n,r={}){const o=Xo(i.getCanvasContainer(),n);super(t,Vt({point:o,lngLat:i.unproject(o),originalEvent:n},r)),this._defaultPrevented=!1,this.target=i}}class Id extends jt{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,i,n){const r=t==="touchend"?n.changedTouches:n.touches,o=fa(i.getCanvasContainer(),r),s=o.map(l=>i.unproject(l)),a=o.reduce((l,c,u,h)=>l.add(c.div(h.length)),new G(0,0));super(t,{points:o,point:a,lngLats:s,lngLat:i.unproject(a),originalEvent:n}),this._defaultPrevented=!1}}class TD extends jt{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,i,n){super(t,{originalEvent:n}),this._defaultPrevented=!1}}class MD{constructor(t,i){this._map=t,this._clickTolerance=i.clickTolerance}reset(){this._mousedownPos=void 0}wheel(t){return this._firePreventable(new TD(t.type,this._map,t))}mousedown(t,i){return this._mousedownPos=i,this._firePreventable(new Nr(t.type,this._map,t))}mouseup(t){this._map.fire(new Nr(t.type,this._map,t))}preclick(t){const i=Vt({},t);i.type="preclick",this._map.fire(new Nr(i.type,this._map,i))}click(t,i){this._mousedownPos&&this._mousedownPos.dist(i)>=this._clickTolerance||(this.preclick(t),this._map.fire(new Nr(t.type,this._map,t)))}dblclick(t){return this._firePreventable(new Nr(t.type,this._map,t))}mouseover(t){this._map.fire(new Nr(t.type,this._map,t))}mouseout(t){this._map.fire(new Nr(t.type,this._map,t))}touchstart(t){return this._firePreventable(new Id(t.type,this._map,t))}touchmove(t){this._map.fire(new Id(t.type,this._map,t))}touchend(t){this._map.fire(new Id(t.type,this._map,t))}touchcancel(t){this._map.fire(new Id(t.type,this._map,t))}_firePreventable(t){if(this._map.fire(t),t.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class ED{constructor(t){this._map=t}reset(){this._delayContextMenu=!1,this._contextMenuEvent=void 0}mousemove(t){this._map.fire(new Nr(t.type,this._map,t))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new Nr("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(t){this._delayContextMenu?this._contextMenuEvent=t:this._map.fire(new Nr(t.type,this._map,t)),this._map.listens("contextmenu")&&t.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class SD{constructor(t,i){this._map=t,this._el=t.getCanvasContainer(),this._container=t.getContainer(),this._clickTolerance=i.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(t,i){this.isEnabled()&&t.shiftKey&&t.button===0&&(da(),this._startPos=this._lastPos=i,this._active=!0)}mousemoveWindow(t,i){if(!this._active)return;const n=i,r=this._startPos,o=this._lastPos;if(!r||!o||o.equals(n)||!this._box&&n.dist(r)<this._clickTolerance)return;this._lastPos=n,this._box||(this._box=vi("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",t));const s=Math.min(r.x,n.x),a=Math.max(r.x,n.x),l=Math.min(r.y,n.y),c=Math.max(r.y,n.y);this._map._requestDomTask(()=>{this._box&&(this._box.style.transform=`translate(${s}px,${l}px)`,this._box.style.width=a-s+"px",this._box.style.height=c-l+"px")})}mouseupWindow(t,i){if(!this._active)return;const n=this._startPos,r=i;if(n&&t.button===0){if(this.reset(),To(),n.x!==r.x||n.y!==r.y)return this._map.fire(new jt("boxzoomend",{originalEvent:t})),{cameraAnimation:o=>o.fitScreenCoordinates(n,r,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",t)}}keydown(t){this._active&&t.keyCode===27&&(this.reset(),this._fireEvent("boxzoomcancel",t))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),cc(),delete this._startPos,delete this._lastPos}_fireEvent(t,i){return this._map.fire(new jt(t,{originalEvent:i}))}}function E_(e,t){const i={};for(let n=0;n<e.length;n++)i[e[n].identifier]=t[n];return i}class AD{constructor(t){this.reset(),this.numTouches=t.numTouches}reset(){this.centroid=void 0,this.startTime=0,this.touches={},this.aborted=!1}touchstart(t,i,n){(this.centroid||n.length>this.numTouches)&&(this.aborted=!0),this.aborted||(this.startTime===0&&(this.startTime=t.timeStamp),n.length===this.numTouches&&(this.centroid=function(r){const o=new G(0,0);for(const s of r)o._add(s);return o.div(r.length)}(i),this.touches=E_(n,i)))}touchmove(t,i,n){if(this.aborted||!this.centroid)return;const r=E_(n,i);for(const o in this.touches){const s=r[o];(!s||s.dist(this.touches[o])>30)&&(this.aborted=!0)}}touchend(t,i,n){if((!this.centroid||t.timeStamp-this.startTime>500)&&(this.aborted=!0),n.length===0){const r=!this.aborted&&this.centroid;if(this.reset(),r)return r}}}class S_{constructor(t){this.singleTap=new AD(t),this.numTaps=t.numTaps,this.reset()}reset(){this.lastTime=1/0,this.lastTap=void 0,this.count=0,this.singleTap.reset()}touchstart(t,i,n){this.singleTap.touchstart(t,i,n)}touchmove(t,i,n){this.singleTap.touchmove(t,i,n)}touchend(t,i,n){const r=this.singleTap.touchend(t,i,n);if(r){const o=t.timeStamp-this.lastTime<500,s=!this.lastTap||this.lastTap.dist(r)<30;if(o&&s||this.reset(),this.count++,this.lastTime=t.timeStamp,this.lastTap=r,this.count===this.numTaps)return this.reset(),r}}}class ID{constructor(){this._zoomIn=new S_({numTouches:1,numTaps:2}),this._zoomOut=new S_({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(t,i,n){this._zoomIn.touchstart(t,i,n),this._zoomOut.touchstart(t,i,n)}touchmove(t,i,n){this._zoomIn.touchmove(t,i,n),this._zoomOut.touchmove(t,i,n)}touchend(t,i,n){const r=this._zoomIn.touchend(t,i,n),o=this._zoomOut.touchend(t,i,n);return r?(this._active=!0,t.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:s=>s.easeTo({duration:300,zoom:s.getZoom()+1,around:s.unproject(r)},{originalEvent:t})}):o?(this._active=!0,t.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:s=>s.easeTo({duration:300,zoom:s.getZoom()-1,around:s.unproject(o)},{originalEvent:t})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}const CD={0:1,2:2};class A_{constructor(t){this.reset(),this._clickTolerance=t.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,this._lastPoint=void 0,this._eventButton=void 0}_correctButton(t,i){return!1}_move(t,i){return{}}mousedown(t,i){if(this._lastPoint)return;const n=Qa(t);this._correctButton(t,n)&&(this._lastPoint=i,this._eventButton=n)}mousemoveWindow(t,i){const n=this._lastPoint;if(n){if(t.preventDefault(),this._eventButton!=null&&function(r,o){const s=CD[o];return r.buttons===void 0||(r.buttons&s)!==s}(t,this._eventButton))this.reset();else if(this._moved||!(i.dist(n)<this._clickTolerance))return this._moved=!0,this._lastPoint=i,this._move(n,i)}}mouseupWindow(t){this._lastPoint&&Qa(t)===this._eventButton&&(this._moved&&To(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class DD extends A_{mousedown(t,i){super.mousedown(t,i),this._lastPoint&&(this._active=!0)}_correctButton(t,i){return i===0&&!t.ctrlKey}_move(t,i){return{around:i,panDelta:i.sub(t)}}}class jw extends A_{_correctButton(t,i){return i===0&&t.ctrlKey||i===2}_move(t,i){const n=.8*(i.x-t.x);if(n)return this._active=!0,{bearingDelta:n}}contextmenu(t){t.preventDefault()}}class Gw extends A_{_correctButton(t,i){return i===0&&t.ctrlKey||i===2}_move(t,i){const n=-.5*(i.y-t.y);if(n)return this._active=!0,{pitchDelta:n}}contextmenu(t){t.preventDefault()}}class PD{constructor(t,i){this._map=t,this._el=t.getCanvasContainer(),this._minTouches=1,this._clickTolerance=i.clickTolerance||1,this.reset(),Xe(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new G(0,0)}touchstart(t,i,n){return this._calculateTransform(t,i,n)}touchmove(t,i,n){if(this._active&&!(n.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(n.length===1&&!de())return void this._showTouchPanBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return t.cancelable&&t.preventDefault(),this._calculateTransform(t,i,n)}}touchend(t,i,n){this._calculateTransform(t,i,n),this._active&&n.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(t,i,n){n.length>0&&(this._active=!0);const r=E_(n,i),o=new G(0,0),s=new G(0,0);let a=0;for(const c in r){const u=r[c],h=this._touches[c];h&&(o._add(u),s._add(u.sub(h)),a++,r[c]=u)}if(this._touches=r,a<this._minTouches||!s.mag())return;const l=s.div(a);return this._sum._add(l),this._sum.mag()<this._clickTolerance?void 0:{around:o.div(a),panDelta:l}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=vi("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","null")},500)}}class I_{constructor(){this.reset()}reset(){this._active=!1,this._firstTwoTouches=void 0}_start(t){}_move(t,i,n){return{}}touchstart(t,i,n){this._firstTwoTouches||n.length<2||(this._firstTwoTouches=[n[0].identifier,n[1].identifier],this._start([i[0],i[1]]))}touchmove(t,i,n){const r=this._firstTwoTouches;if(!r)return;t.preventDefault();const[o,s]=r,a=Cd(n,i,o),l=Cd(n,i,s);if(!a||!l)return;const c=this._aroundCenter?null:a.add(l).div(2);return this._move([a,l],c,t)}touchend(t,i,n){if(!this._firstTwoTouches)return;const[r,o]=this._firstTwoTouches,s=Cd(n,i,r),a=Cd(n,i,o);s&&a||(this._active&&To(),this.reset())}touchcancel(){this.reset()}enable(t){this._enabled=!0,this._aroundCenter=!!t&&t.around==="center"}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function Cd(e,t,i){for(let n=0;n<e.length;n++)if(e[n].identifier===i)return t[n]}function qw(e,t){return Math.log(e/t)/Math.LN2}class kD extends I_{reset(){super.reset(),this._distance=0,this._startDistance=0}_start(t){this._startDistance=this._distance=t[0].dist(t[1])}_move(t,i){const n=this._distance;if(this._distance=t[0].dist(t[1]),this._active||!(Math.abs(qw(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:qw(this._distance,n),pinchAround:i}}}function Zw(e,t){return 180*e.angleWith(t)/Math.PI}class zD extends I_{reset(){super.reset(),this._minDiameter=0,this._startVector=void 0,this._vector=void 0}_start(t){this._startVector=this._vector=t[0].sub(t[1]),this._minDiameter=t[0].dist(t[1])}_move(t,i){const n=this._vector;if(this._vector=t[0].sub(t[1]),n&&(this._active||!this._isBelowThreshold(this._vector)))return this._active=!0,{bearingDelta:Zw(this._vector,n),pinchAround:i}}_isBelowThreshold(t){this._minDiameter=Math.min(this._minDiameter,t.mag());const i=25/(Math.PI*this._minDiameter)*360,n=this._startVector;if(!n)return!1;const r=Zw(t,n);return Math.abs(r)<i}}function C_(e){return Math.abs(e.y)>Math.abs(e.x)}class LD extends I_{constructor(t){super(),this._map=t}reset(){super.reset(),this._valid=void 0,this._firstMove=void 0,this._lastPoints=void 0}_start(t){this._lastPoints=t,C_(t[0].sub(t[1]))&&(this._valid=!1)}_move(t,i,n){const r=this._lastPoints;if(!r)return;const o=t[0].sub(r[0]),s=t[1].sub(r[1]);return this._map._cooperativeGestures&&!de()&&n.touches.length<3||(this._valid=this.gestureBeginsVertically(o,s,n.timeStamp),!this._valid)?void 0:(this._lastPoints=t,this._active=!0,{pitchDelta:(o.y+s.y)/2*-.5})}gestureBeginsVertically(t,i,n){if(this._valid!==void 0)return this._valid;const r=t.mag()>=2,o=i.mag()>=2;if(!r&&!o)return;if(!r||!o)return this._firstMove==null&&(this._firstMove=n),n-this._firstMove<100&&void 0;const s=t.y>0==i.y>0;return C_(t)&&C_(i)&&s}}const RD={panStep:100,bearingStep:15,pitchStep:10};class OD{constructor(){const t=RD;this._panStep=t.panStep,this._bearingStep=t.bearingStep,this._pitchStep=t.pitchStep,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(t){if(t.altKey||t.ctrlKey||t.metaKey)return;let i=0,n=0,r=0,o=0,s=0;switch(t.keyCode){case 61:case 107:case 171:case 187:i=1;break;case 189:case 109:case 173:i=-1;break;case 37:t.shiftKey?n=-1:(t.preventDefault(),o=-1);break;case 39:t.shiftKey?n=1:(t.preventDefault(),o=1);break;case 38:t.shiftKey?r=1:(t.preventDefault(),s=-1);break;case 40:t.shiftKey?r=-1:(t.preventDefault(),s=1);break;default:return}return this._rotationDisabled&&(n=0,r=0),{cameraAnimation:a=>{const l=a.getZoom();a.easeTo({duration:300,easeId:"keyboardHandler",easing:BD,zoom:i?Math.round(l)+i*(t.shiftKey?2:1):l,bearing:a.getBearing()+n*this._bearingStep,pitch:a.getPitch()+r*this._pitchStep,offset:[-o*this._panStep,-s*this._panStep],center:a.getCenter()},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function BD(e){return e*(2-e)}const Hw=4.000244140625;class FD{constructor(t,i){this._map=t,this._el=t.getCanvasContainer(),this._handler=i,this._delta=0,this._lastDelta=0,this._defaultZoomRate=.01,this._wheelZoomRate=.0022222222222222222,Xe(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert"],this)}setZoomRate(t){this._defaultZoomRate=t}setWheelZoomRate(t){this._wheelZoomRate=t}isEnabled(){return!!this._enabled}isActive(){return this._active||this._finishTimeout!==void 0}isZooming(){return!!this._zooming}enable(t){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!t&&t.around==="center",this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(t){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(t.ctrlKey||t.metaKey||this.isZooming()||de()))return void this._showBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let i=t.deltaMode===I.WheelEvent.DOM_DELTA_LINE?40*t.deltaY:t.deltaY;const n=ke.now(),r=n-(this._lastWheelEventTime||0);this._lastWheelEventTime=n,i!==0&&i%Hw==0?this._type="wheel":i!==0&&Math.abs(i)<4?this._type="trackpad":r>400?(this._type=null,this._lastValue=i,this._timeout=setTimeout(this._onTimeout,40,t)):this._type||(this._type=Math.abs(r*i)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,i+=this._lastValue)),t.shiftKey&&i&&(i/=4),this._type&&(this._lastWheelEvent=t,this._delta-=i,this._active||this._start(t)),t.preventDefault()}_onTimeout(t){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(t)}_start(t){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const i=Xo(this._el,t);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:i,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;const t=this._map.transform;this._type==="wheel"&&t.projection.wrap&&(t._center.lng>=180||t._center.lng<=-180)&&(this._prevEase=null,this._easing=null,this._lastWheelEvent=null,this._lastWheelEventTime=0);const i=()=>t._terrainEnabled()&&this._aroundCoord?t.computeZoomRelativeTo(this._aroundCoord):t.zoom;if(this._delta!==0){const c=this._type==="wheel"&&Math.abs(this._delta)>Hw?this._wheelZoomRate:this._defaultZoomRate;let u=2/(1+Math.exp(-Math.abs(this._delta*c)));this._delta<0&&u!==0&&(u=1/u);const h=i(),d=Math.pow(2,h),p=typeof this._targetZoom=="number"?t.zoomScale(this._targetZoom):d;this._targetZoom=Math.min(t.maxZoom,Math.max(t.minZoom,t.scaleZoom(p*u))),this._type==="wheel"&&(this._startZoom=h,this._easing=this._smoothOutEasing(200)),this._lastDelta=this._delta,this._delta=0}const n=typeof this._targetZoom=="number"?this._targetZoom:i(),r=this._startZoom,o=this._easing;let s,a=!1;if(this._type==="wheel"&&r&&o){const c=Math.min((ke.now()-this._lastWheelEventTime)/200,1);s=ze(r,n,o(c)),c<1?this._frameId||(this._frameId=!0):a=!0}else s=n,a=!0;this._active=!0,a&&(this._active=!1,this._finishTimeout=setTimeout(()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout},200));let l=s-i();return l*this._lastDelta<0&&(l=0),{noInertia:!0,needsRenderFrame:!a,zoomDelta:l,around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(t){let i=be;if(this._prevEase){const n=this._prevEase,r=(ke.now()-n.start)/n.duration,o=n.easing(r+.01)-n.easing(r),s=.27/Math.sqrt(o*o+1e-4)*.01;i=Pe(s,Math.sqrt(.0729-s*s),.25,1)}return this._prevEase={start:ke.now(),duration:t,easing:i},i}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=vi("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(I.navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","null")},200)}}class ND{constructor(t,i){this._clickZoom=t,this._tapZoom=i}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class UD{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(t,i){return t.preventDefault(),{cameraAnimation:n=>{n.easeTo({duration:300,zoom:n.getZoom()+(t.shiftKey?-1:1),around:n.unproject(i)},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class VD{constructor(){this._tap=new S_({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,this._swipePoint=void 0,this._swipeTouch=0,this._tapTime=0,this._tap.reset()}touchstart(t,i,n){this._swipePoint||(this._tapTime&&t.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?n.length>0&&(this._swipePoint=i[0],this._swipeTouch=n[0].identifier):this._tap.touchstart(t,i,n))}touchmove(t,i,n){if(this._tapTime){if(this._swipePoint){if(n[0].identifier!==this._swipeTouch)return;const r=i[0],o=r.y-this._swipePoint.y;return this._swipePoint=r,t.preventDefault(),this._active=!0,{zoomDelta:o/128}}}else this._tap.touchmove(t,i,n)}touchend(t,i,n){this._tapTime?this._swipePoint&&n.length===0&&this.reset():this._tap.touchend(t,i,n)&&(this._tapTime=t.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class jD{constructor(t,i,n){this._el=t,this._mousePan=i,this._touchPan=n}enable(t){this._inertiaOptions=t||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class GD{constructor(t,i,n){this._pitchWithRotate=t.pitchWithRotate,this._mouseRotate=i,this._mousePitch=n}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class qD{constructor(t,i,n,r){this._el=t,this._touchZoom=i,this._touchRotate=n,this._tapDragZoom=r,this._rotationDisabled=!1,this._enabled=!0}enable(t){this._touchZoom.enable(t),this._rotationDisabled||this._touchRotate.enable(t),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}const Dd=e=>e.zoom||e.drag||e.pitch||e.rotate;class ZD extends jt{}class HD{constructor(){this.constants=[1,1,.01],this.radius=0}setup(t,i){const n=Z.sub([],i,t);this.radius=Z.length(n[2]<0?Z.div([],n,this.constants):[n[0],n[1],0])}projectRay(t){Z.div(t,t,this.constants),Z.normalize(t,t),Z.mul(t,t,this.constants);const i=Z.scale([],t,this.radius);if(i[2]>0){const n=Z.scale([],[0,0,1],Z.dot(i,[0,0,1])),r=Z.scale([],Z.normalize([],[i[0],i[1],0]),this.radius),o=Z.add([],i,Z.scale([],Z.sub([],Z.add([],r,n),i),2));i[0]=o[0],i[1]=o[1]}return i}}function Pd(e){return e.panDelta&&e.panDelta.mag()||e.zoomDelta||e.bearingDelta||e.pitchDelta}class WD{constructor(t,i){this._map=t,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new wD(t),this._bearingSnap=i.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new HD,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(i),Xe(["handleEvent","handleWindowEvent"],this);const n=this._el;this._listeners=[[n,"touchstart",{passive:!0}],[n,"touchmove",{passive:!1}],[n,"touchend",void 0],[n,"touchcancel",void 0],[n,"mousedown",void 0],[n,"mousemove",void 0],[n,"mouseup",void 0],[I.document,"mousemove",{capture:!0}],[I.document,"mouseup",void 0],[n,"mouseover",void 0],[n,"mouseout",void 0],[n,"dblclick",void 0],[n,"click",void 0],[n,"keydown",{capture:!1}],[n,"keyup",void 0],[n,"wheel",{passive:!1}],[n,"contextmenu",void 0],[I,"blur",void 0]];for(const[r,o,s]of this._listeners)r.addEventListener(o,r===I.document?this.handleWindowEvent:this.handleEvent,s)}destroy(){for(const[t,i,n]of this._listeners)t.removeEventListener(i,t===I.document?this.handleWindowEvent:this.handleEvent,n)}_addDefaultHandlers(t){const i=this._map,n=i.getCanvasContainer();this._add("mapEvent",new MD(i,t));const r=i.boxZoom=new SD(i,t);this._add("boxZoom",r);const o=new ID,s=new UD;i.doubleClickZoom=new ND(s,o),this._add("tapZoom",o),this._add("clickZoom",s);const a=new VD;this._add("tapDragZoom",a);const l=i.touchPitch=new LD(i);this._add("touchPitch",l);const c=new jw(t),u=new Gw(t);i.dragRotate=new GD(t,c,u),this._add("mouseRotate",c,["mousePitch"]),this._add("mousePitch",u,["mouseRotate"]);const h=new DD(t),d=new PD(i,t);i.dragPan=new jD(n,h,d),this._add("mousePan",h),this._add("touchPan",d,["touchZoom","touchRotate"]);const p=new zD,_=new kD;i.touchZoomRotate=new qD(n,_,p,a),this._add("touchRotate",p,["touchPan","touchZoom"]),this._add("touchZoom",_,["touchPan","touchRotate"]),this._add("blockableMapEvent",new ED(i));const g=i.scrollZoom=new FD(i,this);this._add("scrollZoom",g,["mousePan"]);const y=i.keyboard=new OD;this._add("keyboard",y);for(const x of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])t.interactive&&t[x]&&i[x].enable(t[x])}_add(t,i,n){this._handlers.push({handlerName:t,handler:i,allowed:n}),this._handlersById[t]=i}stop(t){if(!this._updatingCamera){for(const{handler:i}of this._handlers)i.reset();this._inertia.clear(),this._fireEvents({},{},t),this._changes=[],this._originalZoom=void 0}}isActive(){for(const{handler:t}of this._handlers)if(t.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!Dd(this._eventsInProgress)||this.isZooming()}_isDragging(){return!!this._eventsInProgress.drag}_blockedByActive(t,i,n){for(const r in t)if(r!==n&&(!i||i.indexOf(r)<0))return!0;return!1}handleWindowEvent(t){this.handleEvent(t,`${t.type}Window`)}_getMapTouches(t){const i=[];for(const n of t)this._el.contains(n.target)&&i.push(n);return i}handleEvent(t,i){this._updatingCamera=!0;const n=t.type==="renderFrame",r=n?void 0:t,o={needsRenderFrame:!1},s={},a={},l=t.touches?this._getMapTouches(t.touches):void 0,c=l?fa(this._el,l):n?void 0:Xo(this._el,t);for(const{handlerName:d,handler:p,allowed:_}of this._handlers){if(!p.isEnabled())continue;let g;this._blockedByActive(a,_,d)?p.reset():p[i||t.type]&&(g=p[i||t.type](t,c,l),this.mergeHandlerResult(o,s,g,d,r),g&&g.needsRenderFrame&&this._triggerRenderFrame()),(g||p.isActive())&&(a[d]=p)}const u={};for(const d in this._previousActiveHandlers)a[d]||(u[d]=r);this._previousActiveHandlers=a,(Object.keys(u).length||Pd(o))&&(this._changes.push([o,s,u]),this._triggerRenderFrame()),(Object.keys(a).length||Pd(o))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:h}=o;h&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],h(this._map))}mergeHandlerResult(t,i,n,r,o){if(!n)return;Vt(t,n);const s={handlerName:r,originalEvent:n.originalEvent||o};n.zoomDelta!==void 0&&(i.zoom=s),n.panDelta!==void 0&&(i.drag=s),n.pitchDelta!==void 0&&(i.pitch=s),n.bearingDelta!==void 0&&(i.rotate=s)}_applyChanges(){const t={},i={},n={};for(const[r,o,s]of this._changes)r.panDelta&&(t.panDelta=(t.panDelta||new G(0,0))._add(r.panDelta)),r.zoomDelta&&(t.zoomDelta=(t.zoomDelta||0)+r.zoomDelta),r.bearingDelta&&(t.bearingDelta=(t.bearingDelta||0)+r.bearingDelta),r.pitchDelta&&(t.pitchDelta=(t.pitchDelta||0)+r.pitchDelta),r.around!==void 0&&(t.around=r.around),r.aroundCoord!==void 0&&(t.aroundCoord=r.aroundCoord),r.pinchAround!==void 0&&(t.pinchAround=r.pinchAround),r.noInertia&&(t.noInertia=r.noInertia),Vt(i,o),Vt(n,s);this._updateMapTransform(t,i,n),this._changes=[]}_updateMapTransform(t,i,n){const r=this._map,o=r.transform,s=b=>[b.x,b.y,b.z];if((b=>{const M=this._eventsInProgress.drag;return M&&!this._handlersById[M.handlerName].isActive()})()&&!Pd(t)){const b=o.zoom;o.cameraElevationReference="sea",this._originalZoom!=null&&o._orthographicProjectionAtLowPitch&&o.projection.name!=="globe"&&o.pitch===0?(o.cameraElevationReference="ground",o.zoom=this._originalZoom):(o.recenterOnTerrain(),o.cameraElevationReference="ground"),b!==o.zoom&&this._map._update(!0)}if(o._isCameraConstrained&&r._stop(!0),!Pd(t))return void this._fireEvents(i,n,!0);let{panDelta:a,zoomDelta:l,bearingDelta:c,pitchDelta:u,around:h,aroundCoord:d,pinchAround:p}=t;o._isCameraConstrained&&(l>0&&(l=0),o._isCameraConstrained=!1),p!==void 0&&(h=p),(l||(b=>i[b]&&!this._eventsInProgress[b])("drag"))&&h&&(this._dragOrigin=s(o.pointCoordinate3D(h)),this._originalZoom=o.zoom,this._trackingEllipsoid.setup(o._camera.position,this._dragOrigin)),o.cameraElevationReference="sea",r._stop(!0),h=h||r.transform.centerPoint,c&&(o.bearing+=c),u&&(o.pitch+=u),o._updateCameraState();const _=[0,0,0];if(a)if(o.projection.name==="mercator"){const b=this._trackingEllipsoid.projectRay(o.screenPointToMercatorRay(h).dir),M=this._trackingEllipsoid.projectRay(o.screenPointToMercatorRay(h.sub(a)).dir);_[0]=M[0]-b[0],_[1]=M[1]-b[1]}else{const b=o.pointCoordinate(h);if(o.projection.name==="globe"){a=a.rotate(-o.angle);const M=o._pixelsPerMercatorPixel/o.worldSize;_[0]=-a.x*sm(On(b.y))*M,_[1]=-a.y*sm(o.center.lat)*M}else{const M=o.pointCoordinate(h.sub(a));b&&M&&(_[0]=M.x-b.x,_[1]=M.y-b.y)}}const g=o.zoom,y=[0,0,0];if(l){const b=s(d||o.pointCoordinate3D(h)),M={dir:Z.normalize([],Z.sub([],b,o._camera.position))};if(M.dir[2]<0){const E=o.zoomDeltaToMovement(b,l);Z.scale(y,M.dir,E)}}const x=Z.add(_,_,y);o._translateCameraConstrained(x),l&&Math.abs(o.zoom-g)>1e-4&&o.recenterOnTerrain(),o.cameraElevationReference="ground",this._map._update(),t.noInertia||this._inertia.record(t),this._fireEvents(i,n,!0)}_fireEvents(t,i,n){const r=Dd(this._eventsInProgress),o=Dd(t),s={};for(const u in t){const{originalEvent:h}=t[u];this._eventsInProgress[u]||(s[`${u}start`]=h),this._eventsInProgress[u]=t[u]}!r&&o&&this._fireEvent("movestart",o.originalEvent);for(const u in s)this._fireEvent(u,s[u]);o&&this._fireEvent("move",o.originalEvent);for(const u in t){const{originalEvent:h}=t[u];this._fireEvent(u,h)}const a={};let l;for(const u in this._eventsInProgress){const{handlerName:h,originalEvent:d}=this._eventsInProgress[u];this._handlersById[h].isActive()||(delete this._eventsInProgress[u],l=i[h]||d,a[`${u}end`]=l)}for(const u in a)this._fireEvent(u,a[u]);const c=Dd(this._eventsInProgress);if(n&&(r||o)&&!c){this._updatingCamera=!0;const u=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),h=d=>d!==0&&-this._bearingSnap<d&&d<this._bearingSnap;u?(h(u.bearing||this._map.getBearing())&&(u.bearing=0),this._map.easeTo(u,{originalEvent:l})):(this._map.fire(new jt("moveend",{originalEvent:l})),h(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(t,i){this._map.fire(new jt(t,i?{originalEvent:i}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add(t=>{this._frameId=void 0,this.handleEvent(new ZD("renderFrame",{timeStamp:t})),this._applyChanges()})}_triggerRenderFrame(){this._frameId===void 0&&(this._frameId=this._requestFrame())}}const Ww="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class $D extends Mn{constructor(t,i){super(),this._moving=!1,this._zooming=!1,this.transform=t,this._bearingSnap=i.bearingSnap,this._respectPrefersReducedMotion=i.respectPrefersReducedMotion!==!1,Xe(["_renderFrameCallback"],this)}getCenter(){return new Le(this.transform.center.lng,this.transform.center.lat)}setCenter(t,i){return this.jumpTo({center:t},i)}panBy(t,i,n){return t=G.convert(t).mult(-1),this.panTo(this.transform.center,Vt({offset:t},i),n)}panTo(t,i,n){return this.easeTo(Vt({center:t},i),n)}getZoom(){return this.transform.zoom}setZoom(t,i){return this.jumpTo({zoom:t},i),this}zoomTo(t,i,n){return this.easeTo(Vt({zoom:t},i),n)}zoomIn(t,i){return this.zoomTo(this.getZoom()+1,t,i),this}zoomOut(t,i){return this.zoomTo(this.getZoom()-1,t,i),this}getBearing(){return this.transform.bearing}setBearing(t,i){return this.jumpTo({bearing:t},i),this}getPadding(){return this.transform.padding}setPadding(t,i){return this.jumpTo({padding:t},i),this}rotateTo(t,i,n){return this.easeTo(Vt({bearing:t},i),n)}resetNorth(t,i){return this.rotateTo(0,Vt({duration:1e3},t),i),this}resetNorthPitch(t,i){return this.easeTo(Vt({bearing:0,pitch:0,duration:1e3},t),i),this}snapToNorth(t,i){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(t,i):this}getPitch(){return this.transform.pitch}setPitch(t,i){return this.jumpTo({pitch:t},i),this}cameraForBounds(t,i){t=Er.convert(t);const n=i&&i.bearing||0,r=i&&i.pitch||0,o=t.getNorthWest(),s=t.getSouthEast();return this._cameraForBounds(this.transform,o,s,n,r,i)}_extendCameraOptions(t){const i={top:0,bottom:0,right:0,left:0};if(typeof(t=Vt({padding:i,offset:[0,0],maxZoom:this.transform.maxZoom},t)).padding=="number"){const n=t.padding;t.padding={top:n,bottom:n,right:n,left:n}}return t.padding=Vt(i,t.padding),t}_minimumAABBFrustumDistance(t,i){const n=i.max[0]-i.min[0],r=i.max[1]-i.min[1];return n/r>t.aspect?n/(2*Math.tan(.5*t.fovX)*t.aspect):r/(2*Math.tan(.5*t.fovY)*t.aspect)}_cameraForBoundsOnGlobe(t,i,n,r,o,s){const a=t.clone(),l=this._extendCameraOptions(s);a.bearing=r,a.pitch=o;const c=Le.convert(i),u=Le.convert(n),h=.5*(c.lat+u.lat),d=.5*(c.lng+u.lng),p=gr(h,d),_=Z.normalize([],p),g=Z.normalize([],Z.cross([],_,[0,1,0])),y=Z.cross([],g,_),x=[g[0],g[1],g[2],0,y[0],y[1],y[2],0,_[0],_[1],_[2],0,0,0,0,1],b=[p,gr(c.lat,c.lng),gr(u.lat,c.lng),gr(u.lat,u.lng),gr(c.lat,u.lng),gr(h,c.lng),gr(h,u.lng),gr(c.lat,d),gr(u.lat,d)];let M=en.fromPoints(b.map(Y=>[Z.dot(g,Y),Z.dot(y,Y),Z.dot(_,Y)]));const E=Z.transformMat4([],M.center,x);Z.squaredLength(E)===0&&Z.set(E,0,0,1),Z.normalize(E,E),Z.scale(E,E,dr),a.center=function([Y,at,ut]){const ct=Math.hypot(Y,at,ut),bt=Math.atan2(Y,ut),Mt=.5*Math.PI-Math.acos(-at/ct);return new Le(ne(bt),ne(Mt))}(E);const T=a.getWorldToCameraMatrix(),S=st.invert(new Float64Array(16),T);M=en.applyTransform(M,st.multiply([],T,x)),Z.transformMat4(E,E,T);const D=.5*(M.max[2]-M.min[2]),z=this._minimumAABBFrustumDistance(a,M),L=Z.scale([],[0,0,1],D),R=Z.add(L,E,L),N=z+(a.pitch===0?0:Z.distance(E,R)),U=a.globeCenterInViewSpace,H=Z.sub([],E,[U[0],U[1],U[2]]);Z.normalize(H,H),Z.scale(H,H,N);const O=Z.add([],E,H);Z.transformMat4(O,O,S);const X=wl/dr,K=Z.length(O),ot=Gi(Math.max(K*X-wl,Number.EPSILON),0),$=Math.min(a.zoomFromMercatorZAdjusted(ot),l.maxZoom);return $>.5*(Oc+Vs)?(a.setProjection({name:"mercator"}),a.zoom=$,this._cameraForBounds(a,i,n,r,o,s)):{center:a.center,zoom:$,bearing:r,pitch:o}}queryTerrainElevation(t,i){const n=this.transform.elevation;return n?(i=Vt({},{exaggerated:!0},i),n.getAtPoint(ui.fromLngLat(t),null,i.exaggerated)):null}_cameraForBounds(t,i,n,r,o,s){if(t.projection.name==="globe")return this._cameraForBoundsOnGlobe(t,i,n,r,o,s);const a=t.clone(),l=this._extendCameraOptions(s),c=a.padding;a.bearing=r,a.pitch=o;const u=Le.convert(i),h=Le.convert(n),d=new Le(u.lng,h.lat),p=new Le(h.lng,u.lat),_=a.project(u),g=a.project(h),y=this.queryTerrainElevation(u),x=this.queryTerrainElevation(h),b=this.queryTerrainElevation(d),M=this.queryTerrainElevation(p),E=[[_.x,_.y,Math.min(y||0,x||0,b||0,M||0)],[g.x,g.y,Math.max(y||0,x||0,b||0,M||0)]];let T=en.fromPoints(E);const S=a.getWorldToCameraMatrix(),D=st.invert(new Float64Array(16),S);T=en.applyTransform(T,S);const z=Z.sub([],T.max,T.min),L=c.left||0,R=c.right||0,N=c.bottom||0,U=c.top||0,{left:H,right:O,top:X,bottom:K}=l.padding,ot=.5*(L+R),$=.5*(U+N),Y=Math.min(a.scaleZoom(a.scale*Math.min((a.width-(L+R+H+O))/z[0],(a.height-(N+U+K+X))/z[1])),l.maxZoom),at=a.scale/a.zoomScale(Y);T=new en([T.min[0]-(H+ot)*at,T.min[1]-(K+$)*at,T.min[2]],[T.max[0]+(O+ot)*at,T.max[1]+(X+$)*at,T.max[2]]);const ut=.5*z[2],ct=this._minimumAABBFrustumDistance(a,T),bt=[0,0,1,0];Ni.transformMat4(bt,bt,S),Ni.normalize(bt,bt);const Mt=Z.scale([],bt,ct+ut),Et=Z.add([],T.center,Mt),ft=(typeof l.offset.x=="number"&&typeof l.offset.y=="number"?new G(l.offset.x,l.offset.y):G.convert(l.offset)).rotate(-wt(r));T.center[0]-=ft.x*at,T.center[1]+=ft.y*at,Z.transformMat4(T.center,T.center,D),Z.transformMat4(Et,Et,D);const kt=[T.center[0],T.center[1],Et[2]*a.pixelsPerMeter];Z.scale(kt,kt,1/a.worldSize);const Qt=Sr(kt[0]),te=On(kt[1]),oe=Math.min(a._zoomFromMercatorZ(kt[2]),l.maxZoom),ce=new Le(Qt,te);return a.mercatorFromTransition&&oe<.5*(Oc+Vs)?(a.setProjection({name:"globe"}),a.zoom=oe,this._cameraForBounds(a,i,n,r,o,s)):{center:ce,zoom:oe,bearing:r,pitch:o}}fitBounds(t,i,n){const r=this.cameraForBounds(t,i);return this._fitInternal(r,i,n)}fitScreenCoordinates(t,i,n,r,o){const s=G.convert(t),a=G.convert(i),l=new G(Math.min(s.x,a.x),Math.min(s.y,a.y)),c=new G(Math.max(s.x,a.x),Math.max(s.y,a.y));if(this.transform.projection.name==="mercator"&&this.transform.anyCornerOffEdge(s,a))return this;const u=this.transform.pointLocation3D(l),h=this.transform.pointLocation3D(c),d=this.transform.pointLocation3D(new G(l.x,c.y)),p=this.transform.pointLocation3D(new G(c.x,l.y)),_=[Math.min(u.lng,h.lng,d.lng,p.lng),Math.min(u.lat,h.lat,d.lat,p.lat)],g=[Math.max(u.lng,h.lng,d.lng,p.lng),Math.max(u.lat,h.lat,d.lat,p.lat)],y=r&&r.pitch?r.pitch:this.getPitch(),x=this._cameraForBounds(this.transform,_,g,n,y,r);return this._fitInternal(x,r,o)}_fitInternal(t,i,n){return t?(delete(i=Vt(t,i)).padding,i.linear?this.easeTo(i,n):this.flyTo(i,n)):this}jumpTo(t,i){this.stop();const n=t.preloadOnly?this.transform.clone():this.transform;let r=!1,o=!1,s=!1;return"zoom"in t&&n.zoom!==+t.zoom&&(r=!0,n.zoom=+t.zoom),t.center!==void 0&&(n.center=Le.convert(t.center)),"bearing"in t&&n.bearing!==+t.bearing&&(o=!0,n.bearing=+t.bearing),"pitch"in t&&n.pitch!==+t.pitch&&(s=!0,n.pitch=+t.pitch),t.padding==null||n.isPaddingEqual(t.padding)||(n.padding=t.padding),t.preloadOnly?(this._preloadTiles(n),this):(this.fire(new jt("movestart",i)).fire(new jt("move",i)),r&&this.fire(new jt("zoomstart",i)).fire(new jt("zoom",i)).fire(new jt("zoomend",i)),o&&this.fire(new jt("rotatestart",i)).fire(new jt("rotate",i)).fire(new jt("rotateend",i)),s&&this.fire(new jt("pitchstart",i)).fire(new jt("pitch",i)).fire(new jt("pitchend",i)),this.fire(new jt("moveend",i)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||J(Ww),this.transform.getFreeCameraOptions()}setFreeCameraOptions(t,i){const n=this.transform;if(!n.projection.supportsFreeCamera)return J(Ww),this;this.stop();const r=n.zoom,o=n.pitch,s=n.bearing;n.setFreeCameraOptions(t);const a=r!==n.zoom,l=o!==n.pitch,c=s!==n.bearing;return this.fire(new jt("movestart",i)).fire(new jt("move",i)),a&&this.fire(new jt("zoomstart",i)).fire(new jt("zoom",i)).fire(new jt("zoomend",i)),c&&this.fire(new jt("rotatestart",i)).fire(new jt("rotate",i)).fire(new jt("rotateend",i)),l&&this.fire(new jt("pitchstart",i)).fire(new jt("pitch",i)).fire(new jt("pitchend",i)),this.fire(new jt("moveend",i)),this}easeTo(t,i){this._stop(!1,t.easeId),((t=Vt({offset:[0,0],duration:500,easing:be},t)).animate===!1||this._prefersReducedMotion(t))&&(t.duration=0);const n=this.transform,r=this.getZoom(),o=this.getBearing(),s=this.getPitch(),a=this.getPadding(),l="zoom"in t?+t.zoom:r,c="bearing"in t?this._normalizeBearing(t.bearing,o):o,u="pitch"in t?+t.pitch:s,h="padding"in t?t.padding:n.padding,d=G.convert(t.offset);let p,_,g;if(n.projection.name==="globe"){const L=ui.fromLngLat(n.center),R=d.rotate(-n.angle);L.x+=R.x/n.worldSize,L.y+=R.y/n.worldSize;const N=L.toLngLat(),U=Le.convert(t.center||N);this._normalizeCenter(U),p=n.centerPoint.add(R),_=new G(L.x,L.y).mult(n.worldSize),g=new G(Fn(U.lng),jn(U.lat)).mult(n.worldSize).sub(_)}else{p=n.centerPoint.add(d);const L=n.pointLocation(p),R=Le.convert(t.center||L);this._normalizeCenter(R),_=n.project(L),g=n.project(R).sub(_)}const y=n.zoomScale(l-r);let x,b;t.around&&(x=Le.convert(t.around),b=n.locationPoint(x));const M=this._zooming||l!==r,E=this._rotating||o!==c,T=this._pitching||u!==s,S=!n.isPaddingEqual(h),D=L=>R=>{if(M&&(L.zoom=ze(r,l,R)),E&&(L.bearing=ze(o,c,R)),T&&(L.pitch=ze(s,u,R)),S&&(L.interpolatePadding(a,h,R),p=L.centerPoint.add(d)),x)L.setLocationAtPoint(x,b);else{const N=L.zoomScale(L.zoom-r),U=l>r?Math.min(2,y):Math.max(.5,y),H=Math.pow(U,1-R),O=L.unproject(_.add(g.mult(R*H)).mult(N));L.setLocationAtPoint(L.renderWorldCopies?O.wrap():O,p)}return t.preloadOnly||this._fireMoveEvents(i),L};if(t.preloadOnly){const L=this._emulate(D,t.duration,n);return this._preloadTiles(L),this}const z={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=M,this._rotating=E,this._pitching=T,this._padding=S,this._easeId=t.easeId,this._prepareEase(i,t.noMoveStart,z),this._ease(D(n),L=>{n.cameraElevationReference==="sea"&&n.recenterOnTerrain(),this._afterEase(i,L)},t),this}_prepareEase(t,i,n={}){this._moving=!0,this.transform.cameraElevationReference="sea",this.transform._orthographicProjectionAtLowPitch&&this.transform.pitch===0&&this.transform.projection.name!=="globe"&&(this.transform.cameraElevationReference="ground"),i||n.moving||this.fire(new jt("movestart",t)),this._zooming&&!n.zooming&&this.fire(new jt("zoomstart",t)),this._rotating&&!n.rotating&&this.fire(new jt("rotatestart",t)),this._pitching&&!n.pitching&&this.fire(new jt("pitchstart",t))}_fireMoveEvents(t){this.fire(new jt("move",t)),this._zooming&&this.fire(new jt("zoom",t)),this._rotating&&this.fire(new jt("rotate",t)),this._pitching&&this.fire(new jt("pitch",t))}_afterEase(t,i){if(this._easeId&&i&&this._easeId===i)return;this._easeId=void 0,this.transform.cameraElevationReference="ground";const n=this._zooming,r=this._rotating,o=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,n&&this.fire(new jt("zoomend",t)),r&&this.fire(new jt("rotateend",t)),o&&this.fire(new jt("pitchend",t)),this.fire(new jt("moveend",t))}flyTo(t,i){if(this._prefersReducedMotion(t)){const Y=Ve(t,["center","zoom","bearing","pitch","around"]);return this.jumpTo(Y,i)}this.stop(),t=Vt({offset:[0,0],speed:1.2,curve:1.42,easing:be},t);const n=this.transform,r=this.getZoom(),o=this.getBearing(),s=this.getPitch(),a=this.getPadding(),l="zoom"in t?Lt(+t.zoom,n.minZoom,n.maxZoom):r,c="bearing"in t?this._normalizeBearing(t.bearing,o):o,u="pitch"in t?+t.pitch:s,h="padding"in t?t.padding:n.padding,d=n.zoomScale(l-r),p=G.convert(t.offset);let _=n.centerPoint.add(p);const g=n.pointLocation(_),y=Le.convert(t.center||g);this._normalizeCenter(y);const x=n.project(g),b=n.project(y).sub(x);let M=t.curve;const E=Math.max(n.width,n.height),T=E/d,S=b.mag();if("minZoom"in t){const Y=Lt(Math.min(t.minZoom,r,l),n.minZoom,n.maxZoom),at=E/n.zoomScale(Y-r);M=Math.sqrt(at/S*2)}const D=M*M;function z(Y){const at=(T*T-E*E+(Y?-1:1)*D*D*S*S)/(2*(Y?T:E)*D*S);return Math.log(Math.sqrt(at*at+1)-at)}function L(Y){return(Math.exp(Y)-Math.exp(-Y))/2}function R(Y){return(Math.exp(Y)+Math.exp(-Y))/2}const N=z(0);let U=function(Y){return R(N)/R(N+M*Y)},H=function(Y){return E*((R(N)*(L(at=N+M*Y)/R(at))-L(N))/D)/S;var at},O=(z(1)-N)/M;if(Math.abs(S)<1e-6||!isFinite(O)){if(Math.abs(E-T)<1e-6)return this.easeTo(t,i);const Y=T<E?-1:1;O=Math.abs(Math.log(T/E))/M,H=function(){return 0},U=function(at){return Math.exp(Y*M*at)}}t.duration="duration"in t?+t.duration:1e3*O/("screenSpeed"in t?+t.screenSpeed/M:+t.speed),t.maxDuration&&t.duration>t.maxDuration&&(t.duration=0);const X=o!==c,K=u!==s,ot=!n.isPaddingEqual(h),$=Y=>at=>{const ut=at*O,ct=1/U(ut);Y.zoom=at===1?l:r+Y.scaleZoom(ct),X&&(Y.bearing=ze(o,c,at)),K&&(Y.pitch=ze(s,u,at)),ot&&(Y.interpolatePadding(a,h,at),_=Y.centerPoint.add(p));const bt=at===1?y:Y.unproject(x.add(b.mult(H(ut))).mult(ct));return Y.setLocationAtPoint(Y.renderWorldCopies?bt.wrap():bt,_),Y._updateCameraOnTerrain(),t.preloadOnly||this._fireMoveEvents(i),Y};if(t.preloadOnly){const Y=this._emulate($,t.duration,n);return this._preloadTiles(Y),this}return this._zooming=!0,this._rotating=X,this._pitching=K,this._padding=ot,this._prepareEase(i,!1),this._ease($(n),()=>this._afterEase(i),t),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_stop(t,i){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),this._easeFrameId=void 0,this._onEaseFrame=void 0),this._onEaseEnd){const n=this._onEaseEnd;this._onEaseEnd=void 0,n.call(this,i)}if(!t){const n=this.handlers;n&&n.stop(!1)}return this}_ease(t,i,n){n.animate===!1||n.duration===0?(t(1),i()):(this._easeStart=ke.now(),this._easeOptions=n,this._onEaseFrame=t,this._onEaseEnd=i,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){const t=Math.min((ke.now()-this._easeStart)/this._easeOptions.duration,1),i=this._onEaseFrame;i&&i(this._easeOptions.easing(t)),t<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(t,i){t=Me(t,-180,180);const n=Math.abs(t-i);return Math.abs(t-360-i)<n&&(t-=360),Math.abs(t+360-i)<n&&(t+=360),t}_normalizeCenter(t){const i=this.transform;if(i.maxBounds||i.projection.name!=="globe"&&!i.renderWorldCopies)return;const n=t.lng-i.center.lng;t.lng+=n>180?-360:n<-180?360:0}_prefersReducedMotion(t){return this._respectPrefersReducedMotion&&ke.prefersReducedMotion&&!(t&&t.essential)}_emulate(t,i,n){const r=Math.ceil(15*i/1e3),o=[],s=t(n.clone());for(let a=0;a<=r;a++){const l=s(a/r);o.push(l.clone())}return o}}class $w{constructor(t={}){this.options=t,Xe(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(t){const i=this.options&&this.options.compact;return this._map=t,this._container=vi("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=vi("button","mapboxgl-ctrl-attrib-button",this._container),vi("span","mapboxgl-ctrl-icon",this._compactButton).setAttribute("aria-hidden","true"),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._setElementTitle(this._compactButton,"ToggleAttribution"),this._innerContainer=vi("div","mapboxgl-ctrl-attrib-inner",this._container),i&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),i===void 0&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_setElementTitle(t,i){const n=this._map._getUIString(`AttributionControl.${i}`);t.removeAttribute("title"),t.firstElementChild&&t.firstElementChild.setAttribute("title",n)}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let t=this._editLink;t||(t=this._editLink=this._container.querySelector(".mapbox-improve-map"));const i=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||j.ACCESS_TOKEN}];if(t){const n=i.reduce((r,o,s)=>(o.value&&(r+=`${o.key}=${o.value}${s<i.length-1?"&":""}`),r),"?");t.href=`${j.FEEDBACK_URL}/${n}#${Vw(this._map,!0)}`,t.rel="noopener nofollow",this._setElementTitle(t,"MapFeedback")}}_updateData(t){!t||t.sourceDataType!=="metadata"&&t.sourceDataType!=="visibility"&&t.dataType!=="style"||(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let t=[];if(this._map.style.stylesheet){const r=this._map.style.stylesheet;this.styleOwner=r.owner,this.styleId=r.id}const i=this._map.style._mergedSourceCaches;for(const r in i){const o=i[r];if(o.used){const s=o.getSource();s.attribution&&t.indexOf(s.attribution)<0&&t.push(s.attribution)}}t.sort((r,o)=>r.length-o.length),t=t.filter((r,o)=>{for(let s=o+1;s<t.length;s++)if(t[s].indexOf(r)>=0)return!1;return!0}),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?t=[...this.options.customAttribution,...t]:t.unshift(this.options.customAttribution));const n=t.join(" | ");n!==this._attribHTML&&(this._attribHTML=n,t.length?(this._innerContainer.innerHTML=n,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}}class Xw{constructor(){Xe(["_updateLogo","_updateCompact"],this)}onAdd(t){this._map=t,this._container=vi("div","mapboxgl-ctrl");const i=vi("a","mapboxgl-ctrl-logo");return i.target="_blank",i.rel="noopener nofollow",i.href="https://www.mapbox.com/",i.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),i.setAttribute("rel","noopener nofollow"),this._container.appendChild(i),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(t){t&&t.sourceDataType!=="metadata"||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;const t=this._map.style._sourceCaches;if(Object.entries(t).length===0)return!0;for(const i in t){const n=t[i].getSource();if(n.hasOwnProperty("mapbox_logo")&&!n.mapbox_logo)return!1}return!0}_updateCompact(){const t=this._container.children;if(t.length){const i=t[0];this._map.getCanvasContainer().offsetWidth<250?i.classList.add("mapboxgl-compact"):i.classList.remove("mapboxgl-compact")}}}class Yw{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(t){const i=++this._id;return this._queue.push({callback:t,id:i,cancelled:!1}),i}remove(t){const i=this._currentlyRunning,n=i?this._queue.concat(i):this._queue;for(const r of n)if(r.id===t)return void(r.cancelled=!0)}run(t=0){const i=this._currentlyRunning=this._queue;this._queue=[];for(const n of i)if(!n.cancelled&&(n.callback(t),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}function Kw(e,t,i){if(e=new Le(e.lng,e.lat),t){const n=new Le(e.lng-360,e.lat),r=new Le(e.lng+360,e.lat),o=360*Math.ceil(Math.abs(e.lng-i.center.lng)/360),s=i.locationPoint(e).distSqr(t),a=t.x<0||t.y<0||t.x>i.width||t.y>i.height;i.locationPoint(n).distSqr(t)<s&&(a||Math.abs(n.lng-i.center.lng)<o)?e=n:i.locationPoint(r).distSqr(t)<s&&(a||Math.abs(r.lng-i.center.lng)<o)&&(e=r)}for(;Math.abs(e.lng-i.center.lng)>180;){const n=i.locationPoint(e);if(n.x>=0&&n.y>=0&&n.x<=i.width&&n.y<=i.height)break;e.lng>i.center.lng?e.lng-=360:e.lng+=360}return e}const D_={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"};class P_ extends Mn{constructor(t,i){if(super(),(t instanceof I.HTMLElement||i)&&(t=Vt({element:t},i)),Xe(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this),this._anchor=t&&t.anchor||"center",this._color=t&&t.color||"#3FB1CE",this._scale=t&&t.scale||1,this._draggable=t&&t.draggable||!1,this._clickTolerance=t&&t.clickTolerance||0,this._isDragging=!1,this._state="inactive",this._rotation=t&&t.rotation||0,this._rotationAlignment=t&&t.rotationAlignment||"auto",this._pitchAlignment=t&&t.pitchAlignment&&t.pitchAlignment||"auto",this._updateMoving=()=>this._update(!0),this._occludedOpacity=t&&t.occludedOpacity||.2,t&&t.element)this._element=t.element,this._offset=G.convert(t&&t.offset||[0,0]);else{this._defaultMarker=!0,this._element=vi("div");const o=41,s=27,a=Se("svg",{display:"block",height:o*this._scale+"px",width:s*this._scale+"px",viewBox:`0 0 ${s} ${o}`},this._element),l=Se("radialGradient",{id:"shadowGradient"},Se("defs",{},a));Se("stop",{offset:"10%","stop-opacity":.4},l),Se("stop",{offset:"100%","stop-opacity":.05},l),Se("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},a),Se("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},a),Se("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},a),Se("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},a),this._offset=G.convert(t&&t.offset||[0,-14])}this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.hasAttribute("role")||this._element.setAttribute("role","img"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",o=>{o.preventDefault()}),this._element.addEventListener("mousedown",o=>{o.preventDefault()});const n=this._element.classList;for(const o in D_)n.remove(`mapboxgl-marker-anchor-${o}`);n.add(`mapboxgl-marker-anchor-${this._anchor}`);const r=t&&t.className?t.className.trim().split(/\s+/):[];n.add(...r),this._popup=null}addTo(t){return t===this._map||(this.remove(),this._map=t,t.getCanvasContainer().appendChild(this._element),t.on("move",this._updateMoving),t.on("moveend",this._update),t.on("remove",this._clearFadeTimer),t._addMarker(this),this.setDraggable(this._draggable),this._update(),t.on("click",this._onMapClick)),this}remove(){const t=this._map;return t&&(t.off("click",this._onMapClick),t.off("move",this._updateMoving),t.off("moveend",this._update),t.off("mousedown",this._addDragHandler),t.off("touchstart",this._addDragHandler),t.off("mouseup",this._onUp),t.off("touchend",this._onUp),t.off("mousemove",this._onMove),t.off("touchmove",this._onMove),t.off("remove",this._clearFadeTimer),t._removeMarker(this),this._map=void 0),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(t){return this._lngLat=Le.convert(t),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}getElement(){return this._element}setPopup(t){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),t){if(!("offset"in t.options)){const r=Math.sqrt(Math.pow(13.5,2)/2);t.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[r,-1*(38.1-13.5+r)],"bottom-right":[-r,-1*(38.1-13.5+r)],left:[13.5,-1*(38.1-13.5)],right:[-13.5,-1*(38.1-13.5)]}:this._offset}this._popup=t,t._marker=this,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(t){const i=t.code,n=t.charCode||t.keyCode;i!=="Space"&&i!=="Enter"&&n!==32&&n!==13||this.togglePopup()}_onMapClick(t){const i=t.originalEvent.target,n=this._element;this._popup&&(i===n||n.contains(i))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){const t=this._popup;return t?(t.isOpen()?(t.remove(),this._element.setAttribute("aria-expanded","false")):this._map&&(t.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this}_behindTerrain(){const t=this._map,i=this._pos;if(!t||!i)return!1;const n=t.unproject(i),r=t.getFreeCameraOptions();if(!r.position)return!1;const o=r.position.toLngLat();return o.distanceTo(n)<.9*o.distanceTo(this._lngLat)}_evaluateOpacity(){const t=this._map;if(!t)return;const i=this._pos;if(!i||i.x<0||i.x>t.transform.width||i.y<0||i.y>t.transform.height)return void this._clearFadeTimer();const n=t.unproject(i);let r;t._showingGlobe()&&mh(t.transform,this._lngLat)?r=0:(r=1-t._queryFogOpacity(n),t.transform._terrainEnabled()&&t.getTerrain()&&this._behindTerrain()&&(r*=this._occludedOpacity)),this._element.style.opacity=`${r}`,this._element.style.pointerEvents=r>0?"auto":"none",this._popup&&this._popup._setOpacity(r),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_updateDOM(){const t=this._pos;if(!t||!this._map)return;const i=this._offset.mult(this._scale);this._element.style.transform=`
            translate(${t.x}px,${t.y}px)
            ${D_[this._anchor]}
            ${this._calculateXYTransform()} ${this._calculateZTransform()}
            translate(${i.x}px,${i.y}px)
        `}_calculateXYTransform(){const t=this._pos,i=this._map,n=this.getPitchAlignment();if(!i||!t||n!=="map")return"";if(!i._showingGlobe()){const l=i.getPitch();return l?`rotateX(${l}deg)`:""}const r=ne(F1(i.transform,this._lngLat)),o=t.sub(B1(i.transform)),s=Math.abs(o.x)+Math.abs(o.y);if(s===0)return"";const a=r/s;return`rotateX(${-o.y*a}deg) rotateY(${o.x*a}deg)`}_calculateZTransform(){const t=this._pos,i=this._map;if(!i||!t)return"";let n=0;const r=this.getRotationAlignment();if(r==="map")if(i._showingGlobe()){const o=i.project(new Le(this._lngLat.lng,this._lngLat.lat+.001)),s=i.project(new Le(this._lngLat.lng,this._lngLat.lat-.001)).sub(o);n=ne(Math.atan2(s.y,s.x))-90}else n=-i.getBearing();else if(r==="horizon"){const o=Fe(4,6,i.getZoom()),s=B1(i.transform);s.y+=o*i.transform.height;const a=t.sub(s),l=ne(Math.atan2(a.y,a.x));n=(l>90?l-270:l+90)*(1-o)}return n+=this._rotation,n?`rotateZ(${n}deg)`:""}_update(t){I.cancelAnimationFrame(this._updateFrameId);const i=this._map;i&&(i.transform.renderWorldCopies&&(this._lngLat=Kw(this._lngLat,this._pos,i.transform)),this._pos=i.project(this._lngLat),t===!0?this._updateFrameId=I.requestAnimationFrame(()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())}):this._pos=this._pos.round(),i._requestDomTask(()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),(i._showingGlobe()||i.getTerrain()||i.getFog())&&!this._fadeTimer&&(this._fadeTimer=setTimeout(this._evaluateOpacity.bind(this),60)))}))}getOffset(){return this._offset}setOffset(t){return this._offset=G.convert(t),this._update(),this}addClassName(t){return this._element.classList.add(t),this}removeClassName(t){return this._element.classList.remove(t),this}toggleClassName(t){return this._element.classList.toggle(t)}_onMove(t){const i=this._map;if(!i)return;const n=this._pointerdownPos,r=this._positionDelta;if(n&&r){if(!this._isDragging){const o=this._clickTolerance||i._clickTolerance;if(t.point.dist(n)<o)return;this._isDragging=!0}this._pos=t.point.sub(r),this._lngLat=i.unproject(this._pos),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none",this._state==="pending"&&(this._state="active",this.fire(new jt("dragstart"))),this.fire(new jt("drag"))}}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1;const t=this._map;t&&(t.off("mousemove",this._onMove),t.off("touchmove",this._onMove)),this._state==="active"&&this.fire(new jt("dragend")),this._state="inactive"}_addDragHandler(t){const i=this._map,n=this._pos;i&&n&&this._element.contains(t.originalEvent.target)&&(t.preventDefault(),this._positionDelta=t.point.sub(n),this._pointerdownPos=t.point,this._state="pending",i.on("mousemove",this._onMove),i.on("touchmove",this._onMove),i.once("mouseup",this._onUp),i.once("touchend",this._onUp))}setDraggable(t){this._draggable=!!t;const i=this._map;return i&&(t?(i.on("mousedown",this._addDragHandler),i.on("touchstart",this._addDragHandler)):(i.off("mousedown",this._addDragHandler),i.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(t){return this._rotation=t||0,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(t){return this._rotationAlignment=t||"auto",this._update(),this}getRotationAlignment(){return this._rotationAlignment==="auto"||this._rotationAlignment==="horizon"&&this._map&&!this._map._showingGlobe()?"viewport":this._rotationAlignment}setPitchAlignment(t){return this._pitchAlignment=t||"auto",this._update(),this}getPitchAlignment(){return this._pitchAlignment==="auto"?this.getRotationAlignment():this._pitchAlignment}setOccludedOpacity(t){return this._occludedOpacity=t||.2,this._update(),this}getOccludedOpacity(){return this._occludedOpacity}}const XD={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px"},YD=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function Jw(e=new G(0,0),t="bottom"){if(typeof e=="number"){const i=Math.round(Math.sqrt(.5*Math.pow(e,2)));switch(t){case"top":return new G(0,e);case"top-left":return new G(i,i);case"top-right":return new G(-i,i);case"bottom":return new G(0,-e);case"bottom-left":return new G(i,-i);case"bottom-right":return new G(-i,-i);case"left":return new G(e,0);case"right":return new G(-e,0)}return new G(0,0)}return e instanceof G||Array.isArray(e)?G.convert(e):G.convert(e[t]||[0,0])}class KD{constructor(t){this.jumpTo(t)}getValue(t){if(t<=this._startTime)return this._start;if(t>=this._endTime)return this._end;const i=Re((t-this._startTime)/(this._endTime-this._startTime));return this._start*(1-i)+this._end*i}isEasing(t){return t>=this._startTime&&t<=this._endTime}jumpTo(t){this._startTime=-1/0,this._endTime=-1/0,this._start=t,this._end=t}easeTo(t,i,n){this._start=this.getValue(i),this._end=t,this._startTime=i,this._endTime=i+n}}const JD={"AttributionControl.ToggleAttribution":"Toggle attribution","AttributionControl.MapFeedback":"Map feedback","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox logo","Map.Title":"Map","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use ⌘ + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"},QD={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,performanceMetricsCollection:!0,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,antialias:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,minTileCacheSize:null,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,respectPrefersReducedMotion:!0,crossSourceCollisions:!0,collectResourceTiming:!1,testMode:!1},tP={showCompass:!0,showZoom:!0,visualizePitch:!1};class eP{constructor(t,i,n=!1){this._clickTolerance=10,this.element=i,this.mouseRotate=new jw({clickTolerance:t.dragRotate._mouseRotate._clickTolerance}),this.map=t,n&&(this.mousePitch=new Gw({clickTolerance:t.dragRotate._mousePitch._clickTolerance})),Xe(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),i.addEventListener("mousedown",this.mousedown),i.addEventListener("touchstart",this.touchstart,{passive:!1}),i.addEventListener("touchmove",this.touchmove),i.addEventListener("touchend",this.touchend),i.addEventListener("touchcancel",this.reset)}down(t,i){this.mouseRotate.mousedown(t,i),this.mousePitch&&this.mousePitch.mousedown(t,i),da()}move(t,i){const n=this.map,r=this.mouseRotate.mousemoveWindow(t,i),o=r&&r.bearingDelta;if(o&&n.setBearing(n.getBearing()+o),this.mousePitch){const s=this.mousePitch.mousemoveWindow(t,i),a=s&&s.pitchDelta;a&&n.setPitch(n.getPitch()+a)}}off(){const t=this.element;t.removeEventListener("mousedown",this.mousedown),t.removeEventListener("touchstart",this.touchstart,{passive:!1}),t.removeEventListener("touchmove",this.touchmove),t.removeEventListener("touchend",this.touchend),t.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){cc(),I.removeEventListener("mousemove",this.mousemove),I.removeEventListener("mouseup",this.mouseup)}mousedown(t){this.down(Vt({},t,{ctrlKey:!0,preventDefault:()=>t.preventDefault()}),Xo(this.element,t)),I.addEventListener("mousemove",this.mousemove),I.addEventListener("mouseup",this.mouseup)}mousemove(t){this.move(t,Xo(this.element,t))}mouseup(t){this.mouseRotate.mouseupWindow(t),this.mousePitch&&this.mousePitch.mouseupWindow(t),this.offTemp()}touchstart(t){t.targetTouches.length!==1?this.reset():(this._startPos=this._lastPos=fa(this.element,t.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>t.preventDefault()},this._startPos))}touchmove(t){t.targetTouches.length!==1?this.reset():(this._lastPos=fa(this.element,t.targetTouches)[0],this.move({preventDefault:()=>t.preventDefault()},this._lastPos))}touchend(t){t.targetTouches.length===0&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}const iP={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1},nP={maxWidth:100,unit:"metric"},rP={kilometer:"km",meter:"m",mile:"mi",foot:"ft","nautical-mile":"nm"},kd={version:B,supported:Ms,setRTLTextPlugin:function(e,t,i=!1){if(wr===lp||wr===cp||wr===up)throw new Error("setRTLTextPlugin cannot be called multiple times.");Ls=ke.resolveURL(e),wr=lp,hp=t,dp(),i||U0()},getRTLTextPluginStatus:pp,Map:class extends $D{constructor(e){Ka.mark(Zr.create);const t=e;if((e=Vt({},QD,e)).minZoom!=null&&e.maxZoom!=null&&e.minZoom>e.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(e.minPitch!=null&&e.maxPitch!=null&&e.minPitch>e.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(e.minPitch!=null&&e.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(e.maxPitch!=null&&e.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(e.antialias&&function(i){const n=i.navigator?i.navigator.userAgent:null;return!!function(r){if(ue==null){const o=r.navigator?r.navigator.userAgent:null;ue=!!r.safari||!(!o||!(/\b(iPad|iPhone|iPod)\b/.test(o)||o.match("Safari")&&!o.match("Chrome")))}return ue}(i)&&n&&(n.match("Version/15.4")||n.match("Version/15.5")||n.match(/CPU (OS|iPhone OS) (15_4|15_5) like Mac OS X/))}(I)&&(e.antialias=!1,J("Antialiasing is disabled for this WebGL context to avoid browser bug: https://github.com/mapbox/mapbox-gl-js/issues/11609")),super(new Zm(e.minZoom,e.maxZoom,e.minPitch,e.maxPitch,e.renderWorldCopies),e),this._interactive=e.interactive,this._minTileCacheSize=e.minTileCacheSize,this._maxTileCacheSize=e.maxTileCacheSize,this._failIfMajorPerformanceCaveat=e.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=e.preserveDrawingBuffer,this._antialias=e.antialias,this._trackResize=e.trackResize,this._bearingSnap=e.bearingSnap,this._refreshExpiredTiles=e.refreshExpiredTiles,this._fadeDuration=e.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=e.crossSourceCollisions,this._collectResourceTiming=e.collectResourceTiming,this._language=this._parseLanguage(e.language),this._worldview=e.worldview,this._renderTaskQueue=new Yw,this._domRenderTaskQueue=new Yw,this._controls=[],this._markers=[],this._popups=[],this._mapId=ae(),this._locale=Vt({},JD,e.locale),this._clickTolerance=e.clickTolerance,this._cooperativeGestures=e.cooperativeGestures,this._performanceMetricsCollection=e.performanceMetricsCollection,this._containerWidth=0,this._containerHeight=0,this._averageElevationLastSampledAt=-1/0,this._averageElevationExaggeration=0,this._averageElevation=new KD(0),this._interactionRange=[1/0,-1/0],this._visibilityHidden=0,this._useExplicitProjection=!1,this._requestManager=new fe(e.transformRequest,e.accessToken,e.testMode),this._silenceAuthErrors=!!e.testMode,this._contextCreateOptions=e.contextCreateOptions?{...e.contextCreateOptions}:{},typeof e.container=="string"){if(this._container=I.document.getElementById(e.container),!this._container)throw new Error(`Container '${e.container.toString()}' not found.`)}else{if(!(e.container instanceof I.HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=e.container}if(this._container.childNodes.length>0&&J("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),e.maxBounds&&this.setMaxBounds(e.maxBounds),Xe(["_onWindowOnline","_onWindowResize","_onVisibilityChange","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._setupPainter(),this.painter===void 0)throw new Error("Failed to initialize WebGL.");if(this.on("move",()=>this._update(!1)),this.on("moveend",()=>this._update(!1)),this.on("zoom",()=>this._update(!0)),I!==void 0&&(this._fullscreenchangeEvent="onfullscreenchange"in I.document?"fullscreenchange":"webkitfullscreenchange",I.addEventListener("online",this._onWindowOnline,!1),I.addEventListener("resize",this._onWindowResize,!1),I.addEventListener("orientationchange",this._onWindowResize,!1),I.addEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),I.addEventListener("visibilitychange",this._onVisibilityChange,!1)),this.handlers=new WD(this,e),this._localFontFamily=e.localFontFamily,this._localIdeographFontFamily=e.localIdeographFontFamily,(e.style||!e.testMode)&&this.setStyle(e.style||j.DEFAULT_STYLE,{localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),e.projection&&this.setProjection(e.projection),e.hash&&(this._hash=new gD(typeof e.hash=="string"&&e.hash||void 0).addTo(this)),!this._hash||!this._hash._onHashChange()){t.center==null&&t.zoom==null||(this.transform._unmodified=!1),this.jumpTo({center:e.center,zoom:e.zoom,bearing:e.bearing,pitch:e.pitch});const i=e.bounds;i&&(this.resize(),this.fitBounds(i,Vt({},e.fitBoundsOptions,{duration:0})))}this.resize(),e.attributionControl&&this.addControl(new $w({customAttribution:e.customAttribution})),this._logoControl=new Xw,this.addControl(this._logoControl,e.logoPosition),this.on("style.load",()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet)}),this.on("data",i=>{this._update(i.dataType==="style"),this.fire(new jt(`${i.dataType}data`,i))}),this.on("dataloading",i=>{this.fire(new jt(`${i.dataType}dataloading`,i))})}_getMapId(){return this._mapId}addControl(e,t){if(t===void 0&&(t=e.getDefaultPosition?e.getDefaultPosition():"top-right"),!e||!e.onAdd)return this.fire(new Ae(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const i=e.onAdd(this);this._controls.push(e);const n=this._controlPositions[t];return t.indexOf("bottom")!==-1?n.insertBefore(i,n.firstChild):n.appendChild(i),this}removeControl(e){if(!e||!e.onRemove)return this.fire(new Ae(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const t=this._controls.indexOf(e);return t>-1&&this._controls.splice(t,1),e.onRemove(this),this}hasControl(e){return this._controls.indexOf(e)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(e){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));const t=!this._moving;return t&&this.fire(new jt("movestart",e)).fire(new jt("move",e)),this.fire(new jt("resize",e)),t&&this.fire(new jt("moveend",e)),this}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(e){return this.transform.setMaxBounds(Er.convert(e)),this._update()}setMinZoom(e){if((e=e??-2)>=-2&&e<=this.transform.maxZoom)return this.transform.minZoom=e,this._update(),this.getZoom()<e?this.setZoom(e):this.fire(new jt("zoomstart")).fire(new jt("zoom")).fire(new jt("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(e){if((e=e??22)>=this.transform.minZoom)return this.transform.maxZoom=e,this._update(),this.getZoom()>e?this.setZoom(e):this.fire(new jt("zoomstart")).fire(new jt("zoom")).fire(new jt("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(e){if((e=e??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(e>=0&&e<=this.transform.maxPitch)return this.transform.minPitch=e,this._update(),this.getPitch()<e?this.setPitch(e):this.fire(new jt("pitchstart")).fire(new jt("pitch")).fire(new jt("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(e){if((e=e??85)>85)throw new Error("maxPitch must be less than or equal to 85");if(e>=this.transform.minPitch)return this.transform.maxPitch=e,this._update(),this.getPitch()>e?this.setPitch(e):this.fire(new jt("pitchstart")).fire(new jt("pitch")).fire(new jt("pitchend")),this;throw new Error("maxPitch must be greater than or equal to minPitch")}getMaxPitch(){return this.transform.maxPitch}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(e){return this.transform.renderWorldCopies=e,this.transform.renderWorldCopies||this._forceMarkerAndPopupUpdate(!0),this._update()}getLanguage(){return this._language}_parseLanguage(e){return e==="auto"?I.navigator.language:Array.isArray(e)?e.length===0?void 0:e.map(t=>t==="auto"?I.navigator.language:t):e}setLanguage(e){const t=this._parseLanguage(e);if(!this.style||t===this._language)return this;this._language=t,this.style.reloadSources();for(const i of this._controls)i._setLanguage&&i._setLanguage(this._language);return this}getWorldview(){return this._worldview}setWorldview(e){return this.style&&e!==this._worldview?(this._worldview=e,this.style.reloadSources(),this):this}getProjection(){return this.transform.mercatorFromTransition?{name:"globe",center:[0,0]}:this.transform.getProjection()}_showingGlobe(){return this.transform.projection.name==="globe"}setProjection(e){return this._lazyInitEmptyStyle(),e?typeof e=="string"&&(e={name:e}):e=null,this._useExplicitProjection=!!e,this._prioritizeAndUpdateProjection(e,this.style.projection)}_updateProjectionTransition(){if(this.getProjection().name!=="globe")return;const e=this.transform,t=e.projection.name;let i;t==="globe"&&e.zoom>=Vs?(e.setMercatorFromTransition(),i=!0):t==="mercator"&&e.zoom<Vs&&(e.setProjection({name:"globe"}),i=!0),i&&(this.style.applyProjectionUpdate(),this.style._forceSymbolLayerUpdate())}_prioritizeAndUpdateProjection(e,t){return this._updateProjection(e||t||{name:"mercator"})}_updateProjection(e){let t;return t=e.name==="globe"&&this.transform.zoom>=Vs?this.transform.setMercatorFromTransition():this.transform.setProjection(e),this.style.applyProjectionUpdate(),t&&(this.painter.clearBackgroundTiles(),this.style.clearSources(),this._update(!0),this._forceMarkerAndPopupUpdate(!0)),this}project(e){return this.transform.locationPoint3D(Le.convert(e))}unproject(e){return this.transform.pointLocation3D(G.convert(e))}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()||!1}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()||!1}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()||!1}_isDragging(){return this.handlers&&this.handlers._isDragging()||!1}_createDelegatedListener(e,t,i){if(e==="mouseenter"||e==="mouseover"){let n=!1;const r=s=>{const a=t.filter(c=>this.getLayer(c)),l=a.length?this.queryRenderedFeatures(s.point,{layers:a}):[];l.length?n||(n=!0,i.call(this,new Nr(e,this,s.originalEvent,{features:l}))):n=!1},o=()=>{n=!1};return{layers:new Set(t),listener:i,delegates:{mousemove:r,mouseout:o}}}if(e==="mouseleave"||e==="mouseout"){let n=!1;const r=s=>{const a=t.filter(l=>this.getLayer(l));(a.length?this.queryRenderedFeatures(s.point,{layers:a}):[]).length?n=!0:n&&(n=!1,i.call(this,new Nr(e,this,s.originalEvent)))},o=s=>{n&&(n=!1,i.call(this,new Nr(e,this,s.originalEvent)))};return{layers:new Set(t),listener:i,delegates:{mousemove:r,mouseout:o}}}{const n=r=>{const o=t.filter(a=>this.getLayer(a)),s=o.length?this.queryRenderedFeatures(r.point,{layers:o}):[];s.length&&(r.features=s,i.call(this,r),delete r.features)};return{layers:new Set(t),listener:i,delegates:{[e]:n}}}}on(e,t,i){if(i===void 0)return super.on(e,t);if(Array.isArray(t)||(t=[t]),t){for(const r of t)if(!this._isValidId(r))return this}const n=this._createDelegatedListener(e,t,i);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[e]=this._delegatedListeners[e]||[],this._delegatedListeners[e].push(n);for(const r in n.delegates)this.on(r,n.delegates[r]);return this}once(e,t,i){if(i===void 0)return super.once(e,t);if(Array.isArray(t)||(t=[t]),t){for(const r of t)if(!this._isValidId(r))return this}const n=this._createDelegatedListener(e,t,i);for(const r in n.delegates)this.once(r,n.delegates[r]);return this}off(e,t,i){if(i===void 0)return super.off(e,t);t=new Set(Array.isArray(t)?t:[t]);for(const o of t)if(!this._isValidId(o))return this;const n=(o,s)=>{if(o.size!==s.size)return!1;for(const a of o)if(!s.has(a))return!1;return!0},r=this._delegatedListeners?this._delegatedListeners[e]:void 0;return r&&(o=>{for(let s=0;s<o.length;s++){const a=o[s];if(a.listener===i&&n(a.layers,t)){for(const l in a.delegates)this.off(l,a.delegates[l]);return o.splice(s,1),this}}})(r),this}queryRenderedFeatures(e,t){if(!this.style)return[];if(t!==void 0||e===void 0||e instanceof G||Array.isArray(e)||(t=e,e=void 0),e=e||[[0,0],[this.transform.width,this.transform.height]],(t=t||{}).layers&&Array.isArray(t.layers)){for(const i of t.layers)if(!this._isValidId(i))return[]}return this.style.queryRenderedFeatures(e,t,this.transform)}querySourceFeatures(e,t){return this._isValidId(e)?this.style.querySourceFeatures(e,t):[]}isPointOnSurface(e){const{name:t}=this.transform.projection;return t!=="globe"&&t!=="mercator"&&J(`${t} projection does not support isPointOnSurface, this API may behave unexpectedly.`),this.transform.isPointOnSurface(G.convert(e))}setStyle(e,t){return(t=Vt({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},t)).diff!==!1&&t.localIdeographFontFamily===this._localIdeographFontFamily&&t.localFontFamily===this._localFontFamily&&this.style&&e?(this._diffStyle(e,t),this):(this._localIdeographFontFamily=t.localIdeographFontFamily,this._localFontFamily=t.localFontFamily,this._updateStyle(e,t))}_getUIString(e){const t=this._locale[e];if(t==null)throw new Error(`Missing UI string '${e}'`);return t}_updateStyle(e,t){return this.style&&(this.style.setEventedParent(null),this.style._remove(),this.style=void 0),e&&(this.style=new fo(this,t||{}),this.style.setEventedParent(this,{style:this.style}),typeof e=="string"?this.style.loadURL(e):this.style.loadJSON(e)),this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new fo(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}_diffStyle(e,t){if(typeof e=="string"){const i=this._requestManager.normalizeStyleURL(e),n=this._requestManager.transformRequest(i,xt.Style);Ut(n,(r,o)=>{r?this.fire(new Ae(r)):o&&this._updateDiff(o,t)})}else typeof e=="object"&&this._updateDiff(e,t)}_updateDiff(e,t){try{this.style.setState(e)&&this._update(!0)}catch(i){J(`Unable to perform style diff: ${i.message||i.error||i}.  Rebuilding the style from scratch.`),this._updateStyle(e,t)}}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():(J("There is no style added to the map."),!1)}_isValidId(e){return e==null?(this.fire(new Ae(new Error("IDs can't be empty."))),!1):!G0(e)||(this.fire(new Ae(new Error(`IDs can't contain special symbols: "${e}".`))),!1)}addSource(e,t){return this._isValidId(e)?(this._lazyInitEmptyStyle(),this.style.addSource(e,t),this._update(!0)):this}isSourceLoaded(e){return!!this._isValidId(e)&&!!this.style&&this.style._isSourceCacheLoaded(e)}areTilesLoaded(){const e=this.style&&this.style._sourceCaches;for(const t in e){const i=e[t]._tiles;for(const n in i){const r=i[n];if(r.state!=="loaded"&&r.state!=="errored")return!1}}return!0}addSourceType(e,t,i){this._lazyInitEmptyStyle(),this.style.addSourceType(e,t,i)}removeSource(e){return this._isValidId(e)?(this.style.removeSource(e),this._updateTerrain(),this._update(!0)):this}getSource(e){return this._isValidId(e)?this.style.getOwnSource(e):null}addImage(e,t,{pixelRatio:i=1,sdf:n=!1,stretchX:r,stretchY:o,content:s}={}){if(this._lazyInitEmptyStyle(),t instanceof I.HTMLImageElement||I.ImageBitmap&&t instanceof I.ImageBitmap){const{width:a,height:l,data:c}=ke.getImageData(t);this.style.addImage(e,{data:new Ln({width:a,height:l},c),pixelRatio:i,stretchX:r,stretchY:o,content:s,sdf:n,version:0})}else if(t.width===void 0||t.height===void 0)this.fire(new Ae(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));else{const{width:a,height:l}=t,c=t;this.style.addImage(e,{data:new Ln({width:a,height:l},new Uint8Array(c.data)),pixelRatio:i,stretchX:r,stretchY:o,content:s,sdf:n,version:0,userImage:c}),c.onAdd&&c.onAdd(this,e)}}updateImage(e,t){this._lazyInitEmptyStyle();const i=this.style.getImage(e);if(!i)return void this.fire(new Ae(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const n=t instanceof I.HTMLImageElement||I.ImageBitmap&&t instanceof I.ImageBitmap?ke.getImageData(t):t,{width:r,height:o}=n;r!==void 0&&o!==void 0?r===i.data.width&&o===i.data.height?(i.data.replace(n.data,!(t instanceof I.HTMLImageElement||I.ImageBitmap&&t instanceof I.ImageBitmap)),this.style.updateImage(e,i)):this.fire(new Ae(new Error(`The width and height of the updated image (${r}, ${o})
                must be that same as the previous version of the image
                (${i.data.width}, ${i.data.height})`))):this.fire(new Ae(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")))}hasImage(e){return e?!!this.style&&!!this.style.getImage(e):(this.fire(new Ae(new Error("Missing required image id"))),!1)}removeImage(e){this.style.removeImage(e)}loadImage(e,t){Ee(this._requestManager.transformRequest(e,xt.Image),(i,n)=>{t(i,n instanceof I.HTMLImageElement?ke.getImageData(n):n)})}listImages(){return this.style.listImages()}addModel(e,t){this._lazyInitEmptyStyle(),this.style.addModel(e,t)}hasModel(e){return e?this.style.hasModel(e):(this.fire(new Ae(new Error("Missing required model id"))),!1)}removeModel(e){this.style.removeModel(e)}listModels(){return this.style.listModels()}addLayer(e,t){return this._isValidId(e.id)?(this._lazyInitEmptyStyle(),this.style.addLayer(e,t),this._update(!0)):this}moveLayer(e,t){return this._isValidId(e)?(this.style.moveLayer(e,t),this._update(!0)):this}removeLayer(e){return this._isValidId(e)?(this.style.removeLayer(e),this._update(!0)):this}getLayer(e){return this._isValidId(e)?this.style.getOwnLayer(e):null}setLayerZoomRange(e,t,i){return this._isValidId(e)?(this.style.setLayerZoomRange(e,t,i),this._update(!0)):this}setFilter(e,t,i={}){return this._isValidId(e)?(this.style.setFilter(e,t,i),this._update(!0)):this}getFilter(e){return this._isValidId(e)?this.style.getFilter(e):null}setPaintProperty(e,t,i,n={}){return this._isValidId(e)?(this.style.setPaintProperty(e,t,i,n),this._update(!0)):this}getPaintProperty(e,t){return this._isValidId(e)?this.style.getPaintProperty(e,t):null}setLayoutProperty(e,t,i,n={}){return this._isValidId(e)?(this.style.setLayoutProperty(e,t,i,n),this._update(!0)):this}getLayoutProperty(e,t){return this._isValidId(e)?this.style.getLayoutProperty(e,t):null}getConfigProperty(e,t){return this.style.getConfigProperty(e,t)}setConfigProperty(e,t,i){return this.style.setConfigProperty(e,t,i),this._update(!0)}setLights(e){if(this._lazyInitEmptyStyle(),e&&e.length===1&&e[0].type==="flat"){const t=e[0];t.properties?this.style.setFlatLight(t.properties,t.id,{}):this.style.setFlatLight({},"flat")}else this.style.setLights(e),this.painter.terrain&&(this.painter.terrain.invalidateRenderCache=!0);return this._update(!0)}getLights(){const e=this.style.getLights()||[];return e.length===0&&e.push({id:this.style.light.id,type:"flat",properties:this.style.getFlatLight()}),e}setLight(e,t={}){return console.log("The `map.setLight` function is deprecated, prefer using `map.setLights` with `flat` light type instead."),this.setLights([{id:"flat",type:"flat",properties:e}])}getLight(){return console.log("The `map.getLight` function is deprecated, prefer using `map.getLights` instead."),this.style.getFlatLight()}setTerrain(e){return this._lazyInitEmptyStyle(),!e&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(e),this._averageElevationLastSampledAt=-1/0,this._update(!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(e){return this._lazyInitEmptyStyle(),this.style.setFog(e),this._update(!0)}getFog(){return this.style?this.style.getFog():null}setCamera(e){return this.style.setCamera(e),this._triggerCameraUpdate(e)}_triggerCameraUpdate(e){return this._update(this.transform.setOrthographicProjectionAtLowPitch(e["camera-projection"]==="orthographic"))}getCamera(){return this.style.camera}_queryFogOpacity(e){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(Le.convert(e),this.transform):0}setFeatureState(e,t){return this._isValidId(e.source)?(this.style.setFeatureState(e,t),this._update()):this}removeFeatureState(e,t){return this._isValidId(e.source)?(this.style.removeFeatureState(e,t),this._update()):this}getFeatureState(e){return this._isValidId(e.source)?this.style.getFeatureState(e):null}_updateContainerDimensions(){if(!this._container)return;const e=this._container.getBoundingClientRect().width||400,t=this._container.getBoundingClientRect().height||300;let i,n,r,o=this._container;for(;o&&(!n||!r);){const s=I.getComputedStyle(o).transform;s&&s!=="none"&&(i=s.match(/matrix.*\((.+)\)/)[1].split(", "),i[0]&&i[0]!=="0"&&i[0]!=="1"&&(n=i[0]),i[3]&&i[3]!=="0"&&i[3]!=="1"&&(r=i[3])),o=o.parentElement}this._containerWidth=n?Math.abs(e/n):e,this._containerHeight=r?Math.abs(t/r):t}_detectMissingCSS(){I.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")!=="rgb(250, 128, 114)"&&J("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupContainer(){const e=this._container;e.classList.add("mapboxgl-map"),(this._missingCSSCanary=vi("div","mapboxgl-canary",e)).style.visibility="hidden",this._detectMissingCSS();const t=this._canvasContainer=vi("div","mapboxgl-canvas-container",e);this._canvas=vi("canvas","mapboxgl-canvas",t),this._interactive&&(t.classList.add("mapboxgl-interactive"),this._canvas.setAttribute("tabindex","0")),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);const i=this._controlContainer=vi("div","mapboxgl-control-container",e),n=this._controlPositions={};["top-left","top-right","bottom-left","bottom-right"].forEach(r=>{n[r]=vi("div",`mapboxgl-ctrl-${r}`,i)}),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(e,t){const i=ke.devicePixelRatio||1;this._canvas.width=i*Math.ceil(e),this._canvas.height=i*Math.ceil(t),this._canvas.style.width=`${e}px`,this._canvas.style.height=`${t}px`}_addMarker(e){this._markers.push(e)}_removeMarker(e){const t=this._markers.indexOf(e);t!==-1&&this._markers.splice(t,1)}_addPopup(e){this._popups.push(e)}_removePopup(e){const t=this._popups.indexOf(e);t!==-1&&this._popups.splice(t,1)}_setupPainter(){const e=Vt({},Ms.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),t=this._canvas.getContext("webgl2",e);t?(Wo(t,!0),this.painter=new lD(t,this._contextCreateOptions,this.transform),this.on("data",i=>{i.dataType==="source"&&this.painter.setTileLoadedFlag(!0)}),Q.testSupport(t)):this.fire(new Ae(new Error("Failed to initialize WebGL")))}_contextLost(e){e.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new jt("webglcontextlost",{originalEvent:e}))}_contextRestored(e){this._setupPainter(),this.resize(),this._update(),this.fire(new jt("webglcontextrestored",{originalEvent:e}))}_onMapScroll(e){if(e.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}_update(e){return this.style?(this._styleDirty=this._styleDirty||e,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(e){return this._update(),this._renderTaskQueue.add(e)}_cancelRenderFrame(e){this._renderTaskQueue.remove(e)}_requestDomTask(e){!this.loaded()||this.loaded()&&!this.isMoving()?e():this._domRenderTaskQueue.add(e)}_render(e){let t;this.fire(new jt("renderstart"));const i=this.painter.context.extTimerQuery,n=ke.now(),r=this.painter.context.gl;if(this.listens("gpu-timing-frame")&&(t=r.createQuery(),r.beginQuery(i.TIME_ELAPSED_EXT,t)),this.painter.context.setDirty(),this.painter.setBaseState(),(this.isMoving()||this.isRotating()||this.isZooming())&&(this._interactionRange[0]=Math.min(this._interactionRange[0],I.performance.now()),this._interactionRange[1]=Math.max(this._interactionRange[1],I.performance.now())),this._renderTaskQueue.run(e),this._domRenderTaskQueue.run(e),this._removed)return;this._updateProjectionTransition();const o=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;const l=this.transform.zoom,c=this.transform.pitch,u=ke.now(),h=new dn(l,{now:u,fadeDuration:o,pitch:c,transition:this.style.transition});this.style.update(h)}this.style&&this.style.hasFogTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0);let s=!1;if(this.style&&this._sourcesDirty?(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),s=this._updateAverageElevation(n),this.style.updateSources(this.transform),this._forceMarkerAndPopupUpdate()):s=this._updateAverageElevation(n),this._placementDirty=this.style&&this.style._updatePlacement(this.painter.transform,this.showCollisionBoxes,o,this._crossSourceCollisions),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,wireframe:{terrain:this.showTerrainWireframe,layers2D:this.showLayers2DWireframe,layers3D:this.showLayers3DWireframe},showOverdrawInspector:this._showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,showTileAABBs:this.showTileAABBs,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:o,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),gpuTimingDeferredRender:!!this.listens("gpu-timing-deferred-render"),speedIndexTiming:this.speedIndexTiming}),this.fire(new jt("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,this.fire(new jt("load"))),this.style&&this.style.hasTransitions()&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),t){const l=ke.now()-n;r.endQuery(i.TIME_ELAPSED_EXT),setTimeout(()=>{const c=r.getQueryParameter(t,r.QUERY_RESULT)/1e6;r.deleteQuery(t),this.fire(new jt("gpu-timing-frame",{cpuTime:l,gpuTime:c})),I.performance.mark("frame-gpu",{startTime:n,detail:{gpuTime:c}})},50)}if(this.listens("gpu-timing-layer")){const l=this.painter.collectGpuTimers();setTimeout(()=>{const c=this.painter.queryGpuTimers(l);this.fire(new jt("gpu-timing-layer",{layerTimes:c}))},50)}if(this.listens("gpu-timing-deferred-render")){const l=this.painter.collectDeferredRenderGpuQueries();setTimeout(()=>{const c=this.painter.queryGpuTimeDeferredRender(l);this.fire(new jt("gpu-timing-deferred-render",{gpuTime:c}))},50)}const a=this._sourcesDirty||this._styleDirty||this._placementDirty||s;if(a||this._repaint)this.triggerRepaint();else{const l=!this.isMoving()&&this.loaded();if(l&&(s=this._updateAverageElevation(n,!0)),s)this.triggerRepaint();else if(this._triggerFrame(!1),l&&(this.fire(new jt("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){const c=this._calculateSpeedIndex();this.fire(new jt("speedindexcompleted",{speedIndex:c})),this.speedIndexTiming=!1}}!this._loaded||this._fullyLoaded||a||(this._fullyLoaded=!0,Ka.mark(Zr.fullLoad),this._performanceMetricsCollection&&sc(this._requestManager._customAccessToken,{width:this.painter.width,height:this.painter.height,interactionRange:this._interactionRange,visibilityHidden:this._visibilityHidden,terrainEnabled:!!this.painter.style.getTerrain(),fogEnabled:!!this.painter.style.getFog(),projection:this.getProjection().name,zoom:this.transform.zoom,renderer:this.painter.context.renderer,vendor:this.painter.context.vendor}),this._authenticate())}_forceMarkerAndPopupUpdate(e){for(const t of this._markers)e&&!this.getRenderWorldCopies()&&(t._lngLat=t._lngLat.wrap()),t._update();for(const t of this._popups)!e||this.getRenderWorldCopies()||t._trackPointer||(t._lngLat=t._lngLat.wrap()),t._update()}_updateAverageElevation(e,t=!1){const i=r=>(this.transform.averageElevation=r,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return this.transform.averageElevation!==0&&i(0);const n=this.transform.elevation&&this.transform.elevation.exaggeration()!==this._averageElevationExaggeration;if(n||(t||e-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(e)){const r=this.transform.averageElevation;let o=this.transform.sampleAverageElevation();this.transform.elevation&&(this._averageElevationExaggeration=this.transform.elevation.exaggeration()),isNaN(o)?o=0:this._averageElevationLastSampledAt=e;const s=Math.abs(r-o);if(s>1){if(this._isInitialLoad||n)return this._averageElevation.jumpTo(o),i(o);this._averageElevation.easeTo(o,e,300)}else if(s>1e-4)return this._averageElevation.jumpTo(o),i(o)}return!!this._averageElevation.isEasing(e)&&i(this._averageElevation.getValue(e))}_authenticate(){ua(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,e=>{if(e&&(e.message===yi||e.status===401)){const t=this.painter.context.gl;Wo(t,!1),this._logoControl instanceof Xw&&this._logoControl._updateLogo(),t&&t.clear(t.DEPTH_BUFFER_BIT|t.COLOR_BUFFER_BIT|t.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new Ae(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}}),ws(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,()=>{})}_updateTerrain(){const e=this._isDragging();this.painter.updateTerrain(this.style,e)}_calculateSpeedIndex(){const e=this.painter.canvasCopy(),t=this.painter.getCanvasCopiesAndTimestamps();t.timeStamps.push(performance.now());const i=this.painter.context.gl,n=i.createFramebuffer();function r(o){i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,o,0);const s=new Uint8Array(i.drawingBufferWidth*i.drawingBufferHeight*4);return i.readPixels(0,0,i.drawingBufferWidth,i.drawingBufferHeight,i.RGBA,i.UNSIGNED_BYTE,s),s}return i.bindFramebuffer(i.FRAMEBUFFER,n),this._canvasPixelComparison(r(e),t.canvasCopies.map(r),t.timeStamps)}_canvasPixelComparison(e,t,i){let n=i[1]-i[0];const r=e.length/4;for(let o=0;o<t.length;o++){const s=t[o];let a=0;for(let l=0;l<s.length;l+=4)s[l]===e[l]&&s[l+1]===e[l+1]&&s[l+2]===e[l+2]&&s[l+3]===e[l+3]&&(a+=1);n+=(i[o+2]-i[o+1])*(1-a/r)}return n}remove(){this._hash&&this._hash.remove();for(const t of this._controls)t.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.painter.destroy(),this.handlers&&this.handlers.destroy(),this.handlers=void 0,this.setStyle(null),I!==void 0&&(I.removeEventListener("resize",this._onWindowResize,!1),I.removeEventListener("orientationchange",this._onWindowResize,!1),I.removeEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),I.removeEventListener("online",this._onWindowOnline,!1),I.removeEventListener("visibilitychange",this._onVisibilityChange,!1));const e=this.painter.context.gl.getExtension("WEBGL_lose_context");e&&e.loseContext(),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvasContainer.remove(),this._controlContainer.remove(),this._missingCSSCanary.remove(),this._canvas=void 0,this._canvasContainer=void 0,this._controlContainer=void 0,this._missingCSSCanary=void 0,this._container.classList.remove("mapboxgl-map"),this._container.removeEventListener("scroll",this._onMapScroll,!1),Ho.delete(this.painter.context.gl),this._removed=!0,this.fire(new jt("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(e){this._renderNextFrame=this._renderNextFrame||e,this.style&&!this._frame&&(this._frame=ke.frame(t=>{const i=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,i&&this._render(t)}))}_preloadTiles(e){return Ii(this.style?Object.values(this.style._sourceCaches):[],(t,i)=>t._preloadTiles(e,i),()=>{this.triggerRepaint()}),this}_onWindowOnline(){this._update()}_onWindowResize(e){this._trackResize&&this.resize({originalEvent:e})._update()}_onVisibilityChange(){I.document.visibilityState==="hidden"&&this._visibilityHidden++}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(e){this._showTileBoundaries!==e&&(this._showTileBoundaries=e,this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(e){this._showTerrainWireframe!==e&&(this._showTerrainWireframe=e,this._update())}get showLayers2DWireframe(){return!!this._showLayers2DWireframe}set showLayers2DWireframe(e){this._showLayers2DWireframe!==e&&(this._showLayers2DWireframe=e,this._update())}get showLayers3DWireframe(){return!!this._showLayers3DWireframe}set showLayers3DWireframe(e){this._showLayers3DWireframe!==e&&(this._showLayers3DWireframe=e,this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(e){this._speedIndexTiming!==e&&(this._speedIndexTiming=e,this._update())}get showPadding(){return!!this._showPadding}set showPadding(e){this._showPadding!==e&&(this._showPadding=e,this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(e){this._showCollisionBoxes!==e&&(this._showCollisionBoxes=e,e?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(e){this._showOverdrawInspector!==e&&(this._showOverdrawInspector=e,this._update())}get repaint(){return!!this._repaint}set repaint(e){this._repaint!==e&&(this._repaint=e,this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(e){this._vertices=e,this._update()}get showTileAABBs(){return!!this._showTileAABBs}set showTileAABBs(e){this._showTileAABBs!==e&&(this._showTileAABBs=e,e&&this._update())}_setCacheLimits(e,t){(function(i,n){tn=i,ln=n})(e,t)}get version(){return B}},NavigationControl:class{constructor(e){this.options=Vt({},tP,e),this._container=vi("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",t=>t.preventDefault()),this.options.showZoom&&(Xe(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",t=>{this._map&&this._map.zoomIn({},{originalEvent:t})}),vi("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",t=>{this._map&&this._map.zoomOut({},{originalEvent:t})}),vi("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(Xe(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",t=>{const i=this._map;i&&(this.options.visualizePitch?i.resetNorthPitch({},{originalEvent:t}):i.resetNorth({},{originalEvent:t}))}),this._compassIcon=vi("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}_updateZoomButtons(){const e=this._map;if(!e)return;const t=e.getZoom(),i=t===e.getMaxZoom(),n=t===e.getMinZoom();this._zoomInButton.disabled=i,this._zoomOutButton.disabled=n,this._zoomInButton.setAttribute("aria-disabled",i.toString()),this._zoomOutButton.setAttribute("aria-disabled",n.toString())}_rotateCompassArrow(){const e=this._map;if(!e)return;const t=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(e.transform.pitch*(Math.PI/180)),.5)}) rotateX(${e.transform.pitch}deg) rotateZ(${e.transform.angle*(180/Math.PI)}deg)`:`rotate(${e.transform.angle*(180/Math.PI)}deg)`;e._requestDomTask(()=>{this._compassIcon&&(this._compassIcon.style.transform=t)})}onAdd(e){return this._map=e,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),e.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&e.on("pitch",this._rotateCompassArrow),e.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new eP(e,this._compass,this.options.visualizePitch)),this._container}onRemove(){const e=this._map;e&&(this._container.remove(),this.options.showZoom&&e.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&e.off("pitch",this._rotateCompassArrow),e.off("rotate",this._rotateCompassArrow),this._handler&&this._handler.off(),this._handler=void 0),this._map=void 0)}_createButton(e,t){const i=vi("button",e,this._container);return i.type="button",i.addEventListener("click",t),i}_setButtonTitle(e,t){if(!this._map)return;const i=this._map._getUIString(`NavigationControl.${t}`);e.setAttribute("aria-label",i),e.firstElementChild&&e.firstElementChild.setAttribute("title",i)}},GeolocateControl:class extends Mn{constructor(e){super(),this.options=Vt({geolocation:I.navigator.geolocation},iP,e),Xe(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation","_onDeviceOrientation"],this),this._updateMarkerRotationThrottled=Uw(this._updateMarkerRotation,20),this._numberOfWatches=0}onAdd(e){return this._map=e,this._container=vi("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkGeolocationSupport(this._setupUI),this._container}onRemove(){this._geolocationWatchID!==void 0&&(this.options.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,this._numberOfWatches=0,this._noTimeout=!1}_checkGeolocationSupport(e){const t=(i=!!this.options.geolocation)=>{this._supportsGeolocation=i,e(i)};this._supportsGeolocation!==void 0?e(this._supportsGeolocation):I.navigator.permissions!==void 0?I.navigator.permissions.query({name:"geolocation"}).then(i=>t(i.state!=="denied")).catch(()=>t()):t()}_isOutOfMapMaxBounds(e){const t=this._map.getMaxBounds(),i=e.coords;return!!t&&(i.longitude<t.getWest()||i.longitude>t.getEast()||i.latitude<t.getSouth()||i.latitude>t.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(e){if(this._map){if(this._isOutOfMapMaxBounds(e))return this._setErrorState(),this.fire(new jt("outofmaxbounds",e)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=e,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&this._watchState!=="OFF"&&this._updateMarker(e),this.options.trackUserLocation&&this._watchState!=="ACTIVE_LOCK"||this._updateCamera(e),this.options.showUserLocation&&this._userLocationDotMarker.removeClassName("mapboxgl-user-location-dot-stale"),this.fire(new jt("geolocate",e)),this._finish()}}_updateCamera(e){const t=new Le(e.coords.longitude,e.coords.latitude),i=e.coords.accuracy,n=Vt({bearing:this._map.getBearing()},this.options.fitBoundsOptions);this._map.fitBounds(t.toBounds(i),n,{geolocateSource:!0})}_updateMarker(e){if(e){const t=new Le(e.coords.longitude,e.coords.latitude);this._accuracyCircleMarker.setLngLat(t).addTo(this._map),this._userLocationDotMarker.setLngLat(t).addTo(this._map),this._accuracy=e.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){const e=this._map.transform,t=Gi(1,e._center.lat)*e.worldSize,i=Math.ceil(2*this._accuracy*t);this._circleElement.style.width=`${i}px`,this._circleElement.style.height=`${i}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&typeof this._heading=="number"?(this._userLocationDotMarker.setRotation(this._heading),this._userLocationDotMarker.addClassName("mapboxgl-user-location-show-heading")):(this._userLocationDotMarker.removeClassName("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(e){if(this._map){if(this.options.trackUserLocation)if(e.code===1){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const t=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t),this._geolocationWatchID!==void 0&&this._clearWatch()}else{if(e.code===3&&this._noTimeout)return;this._setErrorState()}this._watchState!=="OFF"&&this.options.showUserLocation&&this._userLocationDotMarker.addClassName("mapboxgl-user-location-dot-stale"),this.fire(new jt("error",e)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(e){if(this._map!==void 0){if(this._container.addEventListener("contextmenu",t=>t.preventDefault()),this._geolocateButton=vi("button","mapboxgl-ctrl-geolocate",this._container),vi("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",e===!1){J("Geolocation support is not available so the GeolocateControl will be disabled.");const t=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t)}else{const t=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=vi("div","mapboxgl-user-location"),this._dotElement.appendChild(vi("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(vi("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new P_({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=vi("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new P_({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",t=>{t.geolocateSource||this._watchState!=="ACTIVE_LOCK"||t.originalEvent&&t.originalEvent.type==="resize"||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new jt("trackuserlocationend")))})}}_onDeviceOrientation(e){this._userLocationDotMarker&&(e.webkitCompassHeading?this._heading=e.webkitCompassHeading:e.absolute===!0&&(this._heading=-1*e.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return J("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new jt("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":this._numberOfWatches--,this._noTimeout=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new jt("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new jt("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if(this._watchState==="OFF"&&this._geolocationWatchID!==void 0)this._clearWatch();else if(this._geolocationWatchID===void 0){let e;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),this._numberOfWatches++,this._numberOfWatches>1?(e={maximumAge:6e5,timeout:0},this._noTimeout=!0):(e=this.options.positionOptions,this._noTimeout=!1),this._geolocationWatchID=this.options.geolocation.watchPosition(this._onSuccess,this._onError,e),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else this.options.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=setTimeout(this._finish,1e4);return!0}_addDeviceOrientationListener(){const e=()=>{I.addEventListener("ondeviceorientationabsolute"in I?"deviceorientationabsolute":"deviceorientation",this._onDeviceOrientation)};I.DeviceMotionEvent!==void 0&&typeof I.DeviceMotionEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(t=>{t==="granted"&&e()}).catch(console.error):e()}_clearWatch(){this.options.geolocation.clearWatch(this._geolocationWatchID),I.removeEventListener("deviceorientation",this._onDeviceOrientation),I.removeEventListener("deviceorientationabsolute",this._onDeviceOrientation),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:$w,ScaleControl:class{constructor(e){this.options=Vt({},nP,e),this._isNumberFormatSupported=function(){try{return new Intl.NumberFormat("en",{style:"unit",unitDisplay:"short",unit:"meter"}),!0}catch{return!1}}(),Xe(["_update","_setScale","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_update(){const e=this.options.maxWidth||100,t=this._map,i=t._containerHeight/2,n=t._containerWidth/2-e/2,r=t.unproject([n,i]),o=t.unproject([n+e,i]),s=r.distanceTo(o);if(this.options.unit==="imperial"){const a=3.2808*s;a>5280?this._setScale(e,a/5280,"mile"):this._setScale(e,a,"foot")}else this.options.unit==="nautical"?this._setScale(e,s/1852,"nautical-mile"):s>=1e3?this._setScale(e,s/1e3,"kilometer"):this._setScale(e,s,"meter")}_setScale(e,t,i){this._map._requestDomTask(()=>{const n=function(o){const s=Math.pow(10,`${Math.floor(o)}`.length-1);let a=o/s;return a=a>=10?10:a>=5?5:a>=3?3:a>=2?2:a>=1?1:function(l){const c=Math.pow(10,Math.ceil(-Math.log(l)/Math.LN10));return Math.round(l*c)/c}(a),s*a}(t),r=n/t;this._container.innerHTML=this._isNumberFormatSupported&&i!=="nautical-mile"?new Intl.NumberFormat(this._language,{style:"unit",unitDisplay:"short",unit:i}).format(n):`${n}&nbsp;${rP[i]}`,this._container.style.width=e*r+"px"})}onAdd(e){return this._map=e,this._language=e.getLanguage(),this._container=vi("div","mapboxgl-ctrl mapboxgl-ctrl-scale",e.getContainer()),this._container.dir="auto",this._map.on("move",this._update),this._update(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._update),this._map=void 0}_setLanguage(e){this._language=e,this._update()}setUnit(e){this.options.unit=e,this._update()}},FullscreenControl:class{constructor(e){this._fullscreen=!1,e&&e.container&&(e.container instanceof I.HTMLElement?this._container=e.container:J("Full screen control 'container' must be a DOM element.")),Xe(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in I.document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in I.document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(e){return this._map=e,this._container||(this._container=this._map.getContainer()),this._controlContainer=vi("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",J("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,I.document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!I.document.fullscreenEnabled&&!I.document.webkitFullscreenEnabled)}_setupUI(){const e=this._fullscreenButton=vi("button","mapboxgl-ctrl-fullscreen",this._controlContainer);vi("span","mapboxgl-ctrl-icon",e).setAttribute("aria-hidden","true"),e.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),I.document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){const e=this._getTitle();this._fullscreenButton.setAttribute("aria-label",e),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",e)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(I.document.fullscreenElement||I.document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?I.document.exitFullscreen?I.document.exitFullscreen():I.document.webkitCancelFullScreen&&I.document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},Popup:class extends Mn{constructor(e){super(),this.options=Vt(Object.create(XD),e),Xe(["_update","_onClose","remove","_onMouseEvent"],this),this._classList=new Set(e&&e.className?e.className.trim().split(/\s+/):[])}addTo(e){return this._map&&this.remove(),this._map=e,this.options.closeOnClick&&e.on("preclick",this._onClose),this.options.closeOnMove&&e.on("move",this._onClose),e.on("remove",this.remove),this._update(),e._addPopup(this),this._focusFirstElement(),this._trackPointer?(e.on("mousemove",this._onMouseEvent),e.on("mouseup",this._onMouseEvent),e._canvasContainer.classList.add("mapboxgl-track-pointer")):e.on("move",this._update),this.fire(new jt("open")),this}isOpen(){return!!this._map}remove(){this._content&&this._content.remove(),this._container&&(this._container.remove(),this._container=void 0);const e=this._map;return e&&(e.off("move",this._update),e.off("move",this._onClose),e.off("preclick",this._onClose),e.off("click",this._onClose),e.off("remove",this.remove),e.off("mousemove",this._onMouseEvent),e.off("mouseup",this._onMouseEvent),e.off("drag",this._onMouseEvent),e._canvasContainer&&e._canvasContainer.classList.remove("mapboxgl-track-pointer"),e._removePopup(this),this._map=void 0),this.fire(new jt("close")),this}getLngLat(){return this._lngLat}setLngLat(e){this._lngLat=Le.convert(e),this._pos=null,this._trackPointer=!1,this._update();const t=this._map;return t&&(t.on("move",this._update),t.off("mousemove",this._onMouseEvent),t._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}trackPointer(){this._trackPointer=!0,this._pos=null,this._update();const e=this._map;return e&&(e.off("move",this._update),e.on("mousemove",this._onMouseEvent),e.on("drag",this._onMouseEvent),e._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(e){return this.setDOMContent(I.document.createTextNode(e))}setHTML(e){const t=I.document.createDocumentFragment(),i=I.document.createElement("body");let n;for(i.innerHTML=e;n=i.firstChild,n;)t.appendChild(n);return this.setDOMContent(t)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(e){return this.options.maxWidth=e,this._update(),this}setDOMContent(e){let t=this._content;if(t)for(;t.hasChildNodes();)t.firstChild&&t.removeChild(t.firstChild);else t=this._content=vi("div","mapboxgl-popup-content",this._container||void 0);if(t.appendChild(e),this.options.closeButton){const i=this._closeButton=vi("button","mapboxgl-popup-close-button",t);i.type="button",i.setAttribute("aria-label","Close popup"),i.setAttribute("aria-hidden","true"),i.innerHTML="&#215;",i.addEventListener("click",this._onClose)}return this._update(),this._focusFirstElement(),this}addClassName(e){return this._classList.add(e),this._updateClassList(),this}removeClassName(e){return this._classList.delete(e),this._updateClassList(),this}setOffset(e){return this.options.offset=e,this._update(),this}toggleClassName(e){let t;return this._classList.delete(e)?t=!1:(this._classList.add(e),t=!0),this._updateClassList(),t}_onMouseEvent(e){this._update(e.point)}_getAnchor(e){if(this.options.anchor)return this.options.anchor;const t=this._map,i=this._container,n=this._pos;if(!t||!i||!n)return"bottom";const r=i.offsetWidth,o=i.offsetHeight,s=n.x<r/2,a=n.x>t.transform.width-r/2;if(n.y+e<o)return s?"top-left":a?"top-right":"top";if(n.y>t.transform.height-o){if(s)return"bottom-left";if(a)return"bottom-right"}return s?"left":a?"right":"bottom"}_updateClassList(){const e=this._container;if(!e)return;const t=[...this._classList];t.push("mapboxgl-popup"),this._anchor&&t.push(`mapboxgl-popup-anchor-${this._anchor}`),this._trackPointer&&t.push("mapboxgl-popup-track-pointer"),e.className=t.join(" ")}_update(e){const t=this._map,i=this._content;if(!t||!this._lngLat&&!this._trackPointer||!i)return;let n=this._container;if(n||(n=this._container=vi("div","mapboxgl-popup",t.getContainer()),this._tip=vi("div","mapboxgl-popup-tip",n),n.appendChild(i)),this.options.maxWidth&&n.style.maxWidth!==this.options.maxWidth&&(n.style.maxWidth=this.options.maxWidth),t.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=Kw(this._lngLat,this._pos,t.transform)),!this._trackPointer||e){const r=this._pos=this._trackPointer&&e?e:t.project(this._lngLat),o=Jw(this.options.offset),s=this._anchor=this._getAnchor(o.y),a=Jw(this.options.offset,s),l=r.add(a).round();t._requestDomTask(()=>{this._container&&s&&(this._container.style.transform=`${D_[s]} translate(${l.x}px,${l.y}px)`)})}if(!this._marker&&t._showingGlobe()){const r=mh(t.transform,this._lngLat)?0:1;this._setOpacity(r)}this._updateClassList()}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const e=this._container.querySelector(YD);e&&e.focus()}_onClose(){this.remove()}_setOpacity(e){this._container&&(this._container.style.opacity=`${e}`),this._content&&(this._content.style.pointerEvents=e?"auto":"none")}},Marker:P_,Style:fo,LngLat:Le,LngLatBounds:Er,Point:G,MercatorCoordinate:ui,FreeCameraOptions:cx,Evented:Mn,config:j,prewarm:function(){cu().acquire(e_)},clearPrewarmedResources:function(){const e=lu;e&&(e.isPreloaded()&&e.numActive()===1?(e.release(e_),lu=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},get accessToken(){return j.ACCESS_TOKEN},set accessToken(e){j.ACCESS_TOKEN=e},get baseApiUrl(){return j.API_URL},set baseApiUrl(e){j.API_URL=e},get workerCount(){return Nl.workerCount},set workerCount(e){Nl.workerCount=e},get maxParallelImageRequests(){return j.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(e){j.MAX_PARALLEL_IMAGE_REQUESTS=e},clearStorage(e){(function(t){if(!Di())return;const i=I.caches.delete(Ei);t&&i.catch(t).then(()=>t())})(e)},workerUrl:"",workerClass:null,get dracoUrl(){return Mb()},set dracoUrl(e){(function(t){i_=ke.resolveURL(t),n_||(n_=new Ba(cu(),new Mn)),n_.broadcast("setDracoUrl",i_)})(e)},setNow:ke.setNow,restoreNow:ke.restoreNow};P.A=mb,P.D=zh,P.E=pt,P.F=Mm,P.K=_d,P.O=Si,P.P=G,P.T=Lx,P.V=Ih,P.a=Ah,P.b=dv,P.c=ad,P.d=class extends Mn{constructor(e,t,i,n,r,o){super(),this.actor=e,this.layerIndex=t,this.availableImages=i,this.loadVectorData=r||wb,this.loading={},this.loaded={},this.deduped=new bb(e.scheduler),this.isSpriteLoaded=n,this.scheduler=e.scheduler,this.brightness=o}loadTile(e,t){const i=e.uid,n=e&&e.request,r=n&&n.collectResourceTiming,o=this.loading[i]=new MI(e);o.abort=this.loadVectorData(e,(s,a)=>{const l=!this.loading[i];if(delete this.loading[i],l||s||!a)return o.status="done",l||(this.loaded[i]=o),t(s);const c=a.rawData,u={};a.expires&&(u.expires=a.expires),a.cacheControl&&(u.cacheControl=a.cacheControl),o.vectorTile=a.vectorTile||new wm(new kh(c));const h=()=>{o.parse(o.vectorTile,this.layerIndex,this.availableImages,this.actor,(d,p)=>{if(d||!p)return t(d);const _={};if(r){const g=$o(n);g.length>0&&(_.resourceTiming=JSON.parse(JSON.stringify(g)))}t(null,Vt({rawTileData:c.slice(0)},p,u,_))})};this.isSpriteLoaded?h():this.once("isSpriteLoaded",()=>{this.scheduler?this.scheduler.add(h,{type:"parseTile",isSymbolTile:e.isSymbolTile,zoom:e.tileZoom}):h()}),this.loaded=this.loaded||{},this.loaded[i]=o})}reloadTile(e,t){const i=this.loaded,n=e.uid,r=this;if(i&&i[n]){const o=i[n];o.showCollisionBoxes=e.showCollisionBoxes,o.projection=e.projection,o.brightness=e.brightness,o.tileTransform=ka(e.tileID.canonical,e.projection),o.extraShadowCaster=e.extraShadowCaster;const s=(a,l)=>{const c=o.reloadCallback;c&&(delete o.reloadCallback,o.parse(o.vectorTile,r.layerIndex,this.availableImages,r.actor,c)),t(a,l)};o.status==="parsing"?o.reloadCallback=s:o.status==="done"&&(o.vectorTile?o.parse(o.vectorTile,this.layerIndex,this.availableImages,this.actor,s):s())}else t(null,void 0)}abortTile(e,t){const i=e.uid,n=this.loading[i];n&&(n.abort&&n.abort(),delete this.loading[i]),t()}removeTile(e,t){const i=this.loaded,n=e.uid;i&&i[n]&&delete i[n],t()}},P.e=Ps,P.f=$o,P.g=dt,P.h=Ut,P.i=Ht,P.j=function(e,t){const i=c_(e);for(const n of i){for(const r of n.meshes)LI(r);n.lights&&(n.lightMeshIndex=n.meshes.length,n.meshes.push(RI(n.lights,t)))}return i},P.k=dn,P.l=function(e){let t=0;if(new Uint32Array(e,0,1)[0]!==Sb){const i=new Uint32Array(e,0,7),[,,n,r,o,s]=i;t=i.byteLength+r+o+s+o,(n!==e.byteLength||t>=e.byteLength)&&J("Invalid b3dm header information.")}return Db(e,t)},P.m=jh,P.n=$r,P.o=jt,P.p=Zt,P.q=function(e){Ji(),hn&&hn.then(t=>{t.keys().then(i=>{for(let n=0;n<i.length-e;n++)t.delete(i[n])})})},P.r=Rb,P.s=kd,P.t=Fc,P.v=Oi,P.w=I}),C(["./shared"],function(P){function I(Dt){if(typeof Dt=="number"||typeof Dt=="boolean"||typeof Dt=="string"||Dt==null)return JSON.stringify(Dt);if(Array.isArray(Dt)){let q="[";for(const J of Dt)q+=`${I(J)},`;return`${q}]`}let F="{";for(const q of Object.keys(Dt).sort())F+=`${q}:${I(Dt[q])},`;return`${F}}`}function B(Dt){let F="";for(const q of P.r)F+=`/${I(Dt[q])}`;return F}class V{constructor(F){this.keyCache={},this._layers={},this._layerConfigs={},F&&this.replace(F)}replace(F,q){this._layerConfigs={},this._layers={},this.update(F,[],q)}update(F,q,J){this._options=J;for(const Ct of F){this._layerConfigs[Ct.id]=Ct;const ee=this._layers[Ct.id]=P.c(Ct,this._options);ee.setScope(this.scope),ee.compileFilter(),this.keyCache[Ct.id]&&delete this.keyCache[Ct.id]}for(const Ct of q)delete this.keyCache[Ct],delete this._layerConfigs[Ct],delete this._layers[Ct];this.familiesBySource={};const At=function(Ct,ee){const ie={};for(let Xt=0;Xt<Ct.length;Xt++){const ue=ee&&ee[Ct[Xt].id]||B(Ct[Xt]);ee&&(ee[Ct[Xt].id]=ue);let de=ie[ue];de||(de=ie[ue]=[]),de.push(Ct[Xt])}const Pt=[];for(const Xt in ie)Pt.push(ie[Xt]);return Pt}(P.v(this._layerConfigs),this.keyCache);for(const Ct of At){const ee=Ct.map(di=>this._layers[di.id]),ie=ee[0];if(ie.visibility==="none")continue;const Pt=ie.source||"";let Xt=this.familiesBySource[Pt];Xt||(Xt=this.familiesBySource[Pt]={});const ue=ie.sourceLayer||"_geojsonTileLayer";let de=Xt[ue];de||(de=Xt[ue]=[]),de.push(ee)}}}class j{loadTile(F,q){const{uid:J,encoding:At,rawImageData:Ct,padding:ee}=F,ie=P.w.ImageBitmap&&Ct instanceof P.w.ImageBitmap?this.getImageData(Ct,ee):Ct;q(null,new P.D(J,ie,At,ee<1))}getImageData(F,q){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(F.width,F.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d",{willReadFrequently:!0})),this.offscreenCanvas.width=F.width,this.offscreenCanvas.height=F.height,this.offscreenCanvasContext.drawImage(F,0,0,F.width,F.height);const J=this.offscreenCanvasContext.getImageData(-q,-q,F.width+2*q,F.height+2*q);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),J}}function Q(Dt,F){if(Dt.length!==0){et(Dt[0],F);for(var q=1;q<Dt.length;q++)et(Dt[q],!F)}}function et(Dt,F){for(var q=0,J=0,At=0,Ct=Dt.length,ee=Ct-1;At<Ct;ee=At++){var ie=(Dt[At][0]-Dt[ee][0])*(Dt[ee][1]+Dt[At][1]),Pt=q+ie;J+=Math.abs(q)>=Math.abs(ie)?q-Pt+ie:ie-Pt+q,q=Pt}q+J>=0!=!!F&&Dt.reverse()}var it=P.g(function Dt(F,q){var J,At=F&&F.type;if(At==="FeatureCollection")for(J=0;J<F.features.length;J++)Dt(F.features[J],q);else if(At==="GeometryCollection")for(J=0;J<F.geometries.length;J++)Dt(F.geometries[J],q);else if(At==="Feature")Dt(F.geometry,q);else if(At==="Polygon")Q(F.coordinates,q);else if(At==="MultiPolygon")for(J=0;J<F.coordinates.length;J++)Q(F.coordinates[J],q);return F});const lt=P.V.prototype.toGeoJSON;var _t={exports:{}},ht=P.p,Bt=P.a.VectorTileFeature,dt=It;function It(Dt,F){this.options=F||{},this.features=Dt,this.length=Dt.length}function Wt(Dt,F){this.id=typeof Dt.id=="number"?Dt.id:void 0,this.type=Dt.type,this.rawGeometry=Dt.type===1?[Dt.geometry]:Dt.geometry,this.properties=Dt.tags,this.extent=F||4096}It.prototype.feature=function(Dt){return new Wt(this.features[Dt],this.options.extent)},Wt.prototype.loadGeometry=function(){var Dt=this.rawGeometry;this.geometry=[];for(var F=0;F<Dt.length;F++){for(var q=Dt[F],J=[],At=0;At<q.length;At++)J.push(new ht(q[At][0],q[At][1]));this.geometry.push(J)}return this.geometry},Wt.prototype.bbox=function(){this.geometry||this.loadGeometry();for(var Dt=this.geometry,F=1/0,q=-1/0,J=1/0,At=-1/0,Ct=0;Ct<Dt.length;Ct++)for(var ee=Dt[Ct],ie=0;ie<ee.length;ie++){var Pt=ee[ie];F=Math.min(F,Pt.x),q=Math.max(q,Pt.x),J=Math.min(J,Pt.y),At=Math.max(At,Pt.y)}return[F,J,q,At]},Wt.prototype.toGeoJSON=Bt.prototype.toGeoJSON;var zt=P.b,Zt=dt;function $t(Dt){var F=new zt;return function(q,J){for(var At in q.layers)J.writeMessage(3,G,q.layers[At])}(Dt,F),F.finish()}function G(Dt,F){var q;F.writeVarintField(15,Dt.version||1),F.writeStringField(1,Dt.name||""),F.writeVarintField(5,Dt.extent||4096);var J={keys:[],values:[],keycache:{},valuecache:{}};for(q=0;q<Dt.length;q++)J.feature=Dt.feature(q),F.writeMessage(2,Tt,J);var At=J.keys;for(q=0;q<At.length;q++)F.writeStringField(3,At[q]);var Ct=J.values;for(q=0;q<Ct.length;q++)F.writeMessage(4,ai,Ct[q])}function Tt(Dt,F){var q=Dt.feature;q.id!==void 0&&F.writeVarintField(1,q.id),F.writeMessage(2,mt,Dt),F.writeVarintField(3,q.type),F.writeMessage(4,ne,q)}function mt(Dt,F){var q=Dt.feature,J=Dt.keys,At=Dt.values,Ct=Dt.keycache,ee=Dt.valuecache;for(var ie in q.properties){var Pt=q.properties[ie],Xt=Ct[ie];if(Pt!==null){Xt===void 0&&(J.push(ie),Ct[ie]=Xt=J.length-1),F.writeVarint(Xt);var ue=typeof Pt;ue!=="string"&&ue!=="boolean"&&ue!=="number"&&(Pt=JSON.stringify(Pt));var de=ue+":"+Pt,di=ee[de];di===void 0&&(At.push(Pt),ee[de]=di=At.length-1),F.writeVarint(di)}}}function Ot(Dt,F){return(F<<3)+(7&Dt)}function wt(Dt){return Dt<<1^Dt>>31}function ne(Dt,F){for(var q=Dt.loadGeometry(),J=Dt.type,At=0,Ct=0,ee=q.length,ie=0;ie<ee;ie++){var Pt=q[ie],Xt=1;J===1&&(Xt=Pt.length),F.writeVarint(Ot(1,Xt));for(var ue=J===3?Pt.length-1:Pt.length,de=0;de<ue;de++){de===1&&J!==1&&F.writeVarint(Ot(2,ue-1));var di=Pt[de].x-At,Ci=Pt[de].y-Ct;F.writeVarint(wt(di)),F.writeVarint(wt(Ci)),At+=di,Ct+=Ci}J===3&&F.writeVarint(Ot(7,1))}}function ai(Dt,F){var q=typeof Dt;q==="string"?F.writeStringField(1,Dt):q==="boolean"?F.writeBooleanField(7,Dt):q==="number"&&(Dt%1!=0?F.writeDoubleField(3,Dt):Dt<0?F.writeSVarintField(6,Dt):F.writeVarintField(5,Dt))}_t.exports=$t,_t.exports.fromVectorTileJs=$t,_t.exports.fromGeojsonVt=function(Dt,F){F=F||{};var q={};for(var J in Dt)q[J]=new Zt(Dt[J].features,F),q[J].name=J,q[J].version=F.version,q[J].extent=F.extent;return $t({layers:q})},_t.exports.GeoJSONWrapper=Zt;var Re=P.g(_t.exports);const Je={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:Dt=>Dt},We=Math.fround||(Pe=new Float32Array(1),Dt=>(Pe[0]=+Dt,Pe[0]));var Pe;const be=3,Lt=5,Fe=6;class Me{constructor(F){this.options=Object.assign(Object.create(Je),F),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(F){const{log:q,minZoom:J,maxZoom:At}=this.options;q&&console.time("total time");const Ct=`prepare ${F.length} points`;q&&console.time(Ct),this.points=F;const ee=[];for(let Pt=0;Pt<F.length;Pt++){const Xt=F[Pt];if(!Xt.geometry)continue;const[ue,de]=Xt.geometry.coordinates,di=We(Vt(ue)),Ci=We(Ve(de));ee.push(di,Ci,1/0,Pt,-1,1),this.options.reduce&&ee.push(0)}let ie=this.trees[At+1]=this._createTree(ee);q&&console.timeEnd(Ct);for(let Pt=At;Pt>=J;Pt--){const Xt=+Date.now();ie=this.trees[Pt]=this._createTree(this._cluster(ie,Pt)),q&&console.log("z%d: %d clusters in %dms",Pt,ie.numItems,+Date.now()-Xt)}return q&&console.timeEnd("total time"),this}getClusters(F,q){let J=((F[0]+180)%360+360)%360-180;const At=Math.max(-90,Math.min(90,F[1]));let Ct=F[2]===180?180:((F[2]+180)%360+360)%360-180;const ee=Math.max(-90,Math.min(90,F[3]));if(F[2]-F[0]>=360)J=-180,Ct=180;else if(J>Ct){const de=this.getClusters([J,At,180,ee],q),di=this.getClusters([-180,At,Ct,ee],q);return de.concat(di)}const ie=this.trees[this._limitZoom(q)],Pt=ie.range(Vt(J),Ve(ee),Vt(Ct),Ve(At)),Xt=ie.data,ue=[];for(const de of Pt){const di=this.stride*de;ue.push(Xt[di+Lt]>1?Ii(Xt,di,this.clusterProps):this.points[Xt[di+be]])}return ue}getChildren(F){const q=this._getOriginId(F),J=this._getOriginZoom(F),At="No cluster with the specified id.",Ct=this.trees[J];if(!Ct)throw new Error(At);const ee=Ct.data;if(q*this.stride>=ee.length)throw new Error(At);const ie=this.options.radius/(this.options.extent*Math.pow(2,J-1)),Pt=Ct.within(ee[q*this.stride],ee[q*this.stride+1],ie),Xt=[];for(const ue of Pt){const de=ue*this.stride;ee[de+4]===F&&Xt.push(ee[de+Lt]>1?Ii(ee,de,this.clusterProps):this.points[ee[de+be]])}if(Xt.length===0)throw new Error(At);return Xt}getLeaves(F,q,J){const At=[];return this._appendLeaves(At,F,q=q||10,J=J||0,0),At}getTile(F,q,J){const At=this.trees[this._limitZoom(F)],Ct=Math.pow(2,F),{extent:ee,radius:ie}=this.options,Pt=ie/ee,Xt=(J-Pt)/Ct,ue=(J+1+Pt)/Ct,de={features:[]};return this._addTileFeatures(At.range((q-Pt)/Ct,Xt,(q+1+Pt)/Ct,ue),At.data,q,J,Ct,de),q===0&&this._addTileFeatures(At.range(1-Pt/Ct,Xt,1,ue),At.data,Ct,J,Ct,de),q===Ct-1&&this._addTileFeatures(At.range(0,Xt,Pt/Ct,ue),At.data,-1,J,Ct,de),de.features.length?de:null}getClusterExpansionZoom(F){let q=this._getOriginZoom(F)-1;for(;q<=this.options.maxZoom;){const J=this.getChildren(F);if(q++,J.length!==1)break;F=J[0].properties.cluster_id}return q}_appendLeaves(F,q,J,At,Ct){const ee=this.getChildren(q);for(const ie of ee){const Pt=ie.properties;if(Pt&&Pt.cluster?Ct+Pt.point_count<=At?Ct+=Pt.point_count:Ct=this._appendLeaves(F,Pt.cluster_id,J,At,Ct):Ct<At?Ct++:F.push(ie),F.length===J)break}return Ct}_createTree(F){const q=new P.K(F.length/this.stride|0,this.options.nodeSize,Float32Array);for(let J=0;J<F.length;J+=this.stride)q.add(F[J],F[J+1]);return q.finish(),q.data=F,q}_addTileFeatures(F,q,J,At,Ct,ee){for(const ie of F){const Pt=ie*this.stride,Xt=q[Pt+Lt]>1;let ue,de,di;if(Xt)ue=Oi(q,Pt,this.clusterProps),de=q[Pt],di=q[Pt+1];else{const ri=this.points[q[Pt+be]];ue=ri.properties;const[Vi,Ei]=ri.geometry.coordinates;de=Vt(Vi),di=Ve(Ei)}const Ci={type:1,geometry:[[Math.round(this.options.extent*(de*Ct-J)),Math.round(this.options.extent*(di*Ct-At))]],tags:ue};let Xi;Xi=Xt||this.options.generateId?q[Pt+be]:this.points[q[Pt+be]].id,Xi!==void 0&&(Ci.id=Xi),ee.features.push(Ci)}}_limitZoom(F){return Math.max(this.options.minZoom,Math.min(Math.floor(+F),this.options.maxZoom+1))}_cluster(F,q){const{radius:J,extent:At,reduce:Ct,minPoints:ee}=this.options,ie=J/(At*Math.pow(2,q)),Pt=F.data,Xt=[],ue=this.stride;for(let de=0;de<Pt.length;de+=ue){if(Pt[de+2]<=q)continue;Pt[de+2]=q;const di=Pt[de],Ci=Pt[de+1],Xi=F.within(Pt[de],Pt[de+1],ie),ri=Pt[de+Lt];let Vi=ri;for(const Ei of Xi){const tn=Ei*ue;Pt[tn+2]>q&&(Vi+=Pt[tn+Lt])}if(Vi>ri&&Vi>=ee){let Ei,tn=di*ri,ln=Ci*ri,hn=-1;const Be=((de/ue|0)<<5)+(q+1)+this.points.length;for(const Di of Xi){const Ji=Di*ue;if(Pt[Ji+2]<=q)continue;Pt[Ji+2]=q;const Un=Pt[Ji+Lt];tn+=Pt[Ji]*Un,ln+=Pt[Ji+1]*Un,Pt[Ji+4]=Be,Ct&&(Ei||(Ei=this._map(Pt,de,!0),hn=this.clusterProps.length,this.clusterProps.push(Ei)),Ct(Ei,this._map(Pt,Ji)))}Pt[de+4]=Be,Xt.push(tn/Vi,ln/Vi,1/0,Be,-1,Vi),Ct&&Xt.push(hn)}else{for(let Ei=0;Ei<ue;Ei++)Xt.push(Pt[de+Ei]);if(Vi>1)for(const Ei of Xi){const tn=Ei*ue;if(!(Pt[tn+2]<=q)){Pt[tn+2]=q;for(let ln=0;ln<ue;ln++)Xt.push(Pt[tn+ln])}}}}return Xt}_getOriginId(F){return F-this.points.length>>5}_getOriginZoom(F){return(F-this.points.length)%32}_map(F,q,J){if(F[q+Lt]>1){const ee=this.clusterProps[F[q+Fe]];return J?Object.assign({},ee):ee}const At=this.points[F[q+be]].properties,Ct=this.options.map(At);return J&&Ct===At?Object.assign({},Ct):Ct}}function Ii(Dt,F,q){return{type:"Feature",id:Dt[F+be],properties:Oi(Dt,F,q),geometry:{type:"Point",coordinates:[(J=Dt[F],360*(J-.5)),rn(Dt[F+1])]}};var J}function Oi(Dt,F,q){const J=Dt[F+Lt],At=J>=1e4?`${Math.round(J/1e3)}k`:J>=1e3?Math.round(J/100)/10+"k":J,Ct=Dt[F+Fe],ee=Ct===-1?{}:Object.assign({},q[Ct]);return Object.assign(ee,{cluster:!0,cluster_id:Dt[F+be],point_count:J,point_count_abbreviated:At})}function Vt(Dt){return Dt/360+.5}function Ve(Dt){const F=Math.sin(Dt*Math.PI/180),q=.5-.25*Math.log((1+F)/(1-F))/Math.PI;return q<0?0:q>1?1:q}function rn(Dt){const F=(180-360*Dt)*Math.PI/180;return 360*Math.atan(Math.exp(F))/Math.PI-90}var ae={exports:{}};ae.exports=function(){function Dt(xt,St,Rt,Ft){for(var Ut,Ht=Ft,Kt=Rt-St>>1,qt=Rt-St,se=xt[St],Yt=xt[St+1],Ee=xt[Rt],yi=xt[Rt+1],fe=St+3;fe<Rt;fe+=3){var li=F(xt[fe],xt[fe+1],se,Yt,Ee,yi);if(li>Ht)Ut=fe,Ht=li;else if(li===Ht){var Ki=Math.abs(fe-Kt);Ki<qt&&(Ut=fe,qt=Ki)}}Ht>Ft&&(Ut-St>3&&Dt(xt,St,Ut,Ft),xt[Ut+2]=Ht,Rt-Ut>3&&Dt(xt,Ut,Rt,Ft))}function F(xt,St,Rt,Ft,Ut,Ht){var Kt=Ut-Rt,qt=Ht-Ft;if(Kt!==0||qt!==0){var se=((xt-Rt)*Kt+(St-Ft)*qt)/(Kt*Kt+qt*qt);se>1?(Rt=Ut,Ft=Ht):se>0&&(Rt+=Kt*se,Ft+=qt*se)}return(Kt=xt-Rt)*Kt+(qt=St-Ft)*qt}function q(xt,St,Rt,Ft){var Ut={id:xt===void 0?null:xt,type:St,geometry:Rt,tags:Ft,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};return function(Ht){var Kt=Ht.geometry,qt=Ht.type;if(qt==="Point"||qt==="MultiPoint"||qt==="LineString")J(Ht,Kt);else if(qt==="Polygon"||qt==="MultiLineString")for(var se=0;se<Kt.length;se++)J(Ht,Kt[se]);else if(qt==="MultiPolygon")for(se=0;se<Kt.length;se++)for(var Yt=0;Yt<Kt[se].length;Yt++)J(Ht,Kt[se][Yt])}(Ut),Ut}function J(xt,St){for(var Rt=0;Rt<St.length;Rt+=3)xt.minX=Math.min(xt.minX,St[Rt]),xt.minY=Math.min(xt.minY,St[Rt+1]),xt.maxX=Math.max(xt.maxX,St[Rt]),xt.maxY=Math.max(xt.maxY,St[Rt+1])}function At(xt,St,Rt,Ft){if(St.geometry){var Ut=St.geometry.coordinates,Ht=St.geometry.type,Kt=Math.pow(Rt.tolerance/((1<<Rt.maxZoom)*Rt.extent),2),qt=[],se=St.id;if(Rt.promoteId?se=St.properties[Rt.promoteId]:Rt.generateId&&(se=Ft||0),Ht==="Point")Ct(Ut,qt);else if(Ht==="MultiPoint")for(var Yt=0;Yt<Ut.length;Yt++)Ct(Ut[Yt],qt);else if(Ht==="LineString")ee(Ut,qt,Kt,!1);else if(Ht==="MultiLineString"){if(Rt.lineMetrics){for(Yt=0;Yt<Ut.length;Yt++)ee(Ut[Yt],qt=[],Kt,!1),xt.push(q(se,"LineString",qt,St.properties));return}ie(Ut,qt,Kt,!1)}else if(Ht==="Polygon")ie(Ut,qt,Kt,!0);else{if(Ht!=="MultiPolygon"){if(Ht==="GeometryCollection"){for(Yt=0;Yt<St.geometry.geometries.length;Yt++)At(xt,{id:se,geometry:St.geometry.geometries[Yt],properties:St.properties},Rt,Ft);return}throw new Error("Input data is not a valid GeoJSON object.")}for(Yt=0;Yt<Ut.length;Yt++){var Ee=[];ie(Ut[Yt],Ee,Kt,!0),qt.push(Ee)}}xt.push(q(se,Ht,qt,St.properties))}}function Ct(xt,St){St.push(Pt(xt[0])),St.push(Xt(xt[1])),St.push(0)}function ee(xt,St,Rt,Ft){for(var Ut,Ht,Kt=0,qt=0;qt<xt.length;qt++){var se=Pt(xt[qt][0]),Yt=Xt(xt[qt][1]);St.push(se),St.push(Yt),St.push(0),qt>0&&(Kt+=Ft?(Ut*Yt-se*Ht)/2:Math.sqrt(Math.pow(se-Ut,2)+Math.pow(Yt-Ht,2))),Ut=se,Ht=Yt}var Ee=St.length-3;St[2]=1,Dt(St,0,Ee,Rt),St[Ee+2]=1,St.size=Math.abs(Kt),St.start=0,St.end=St.size}function ie(xt,St,Rt,Ft){for(var Ut=0;Ut<xt.length;Ut++){var Ht=[];ee(xt[Ut],Ht,Rt,Ft),St.push(Ht)}}function Pt(xt){return xt/360+.5}function Xt(xt){var St=Math.sin(xt*Math.PI/180),Rt=.5-.25*Math.log((1+St)/(1-St))/Math.PI;return Rt<0?0:Rt>1?1:Rt}function ue(xt,St,Rt,Ft,Ut,Ht,Kt,qt){if(Ft/=St,Ht>=(Rt/=St)&&Kt<Ft)return xt;if(Kt<Rt||Ht>=Ft)return null;for(var se=[],Yt=0;Yt<xt.length;Yt++){var Ee=xt[Yt],yi=Ee.geometry,fe=Ee.type,li=Ut===0?Ee.minX:Ee.minY,Ki=Ut===0?Ee.maxX:Ee.maxY;if(li>=Rt&&Ki<Ft)se.push(Ee);else if(!(Ki<Rt||li>=Ft)){var ki=[];if(fe==="Point"||fe==="MultiPoint")de(yi,ki,Rt,Ft,Ut);else if(fe==="LineString")di(yi,ki,Rt,Ft,Ut,!1,qt.lineMetrics);else if(fe==="MultiLineString")Xi(yi,ki,Rt,Ft,Ut,!1);else if(fe==="Polygon")Xi(yi,ki,Rt,Ft,Ut,!0);else if(fe==="MultiPolygon")for(var Qi=0;Qi<yi.length;Qi++){var vn=[];Xi(yi[Qi],vn,Rt,Ft,Ut,!0),vn.length&&ki.push(vn)}if(ki.length){if(qt.lineMetrics&&fe==="LineString"){for(Qi=0;Qi<ki.length;Qi++)se.push(q(Ee.id,fe,ki[Qi],Ee.tags));continue}fe!=="LineString"&&fe!=="MultiLineString"||(ki.length===1?(fe="LineString",ki=ki[0]):fe="MultiLineString"),fe!=="Point"&&fe!=="MultiPoint"||(fe=ki.length===3?"Point":"MultiPoint"),se.push(q(Ee.id,fe,ki,Ee.tags))}}}return se.length?se:null}function de(xt,St,Rt,Ft,Ut){for(var Ht=0;Ht<xt.length;Ht+=3){var Kt=xt[Ht+Ut];Kt>=Rt&&Kt<=Ft&&(St.push(xt[Ht]),St.push(xt[Ht+1]),St.push(xt[Ht+2]))}}function di(xt,St,Rt,Ft,Ut,Ht,Kt){for(var qt,se,Yt=Ci(xt),Ee=Ut===0?Vi:Ei,yi=xt.start,fe=0;fe<xt.length-3;fe+=3){var li=xt[fe],Ki=xt[fe+1],ki=xt[fe+2],Qi=xt[fe+3],vn=xt[fe+4],Gn=Ut===0?li:Ki,xn=Ut===0?Qi:vn,gn=!1;Kt&&(qt=Math.sqrt(Math.pow(li-Qi,2)+Math.pow(Ki-vn,2))),Gn<Rt?xn>Rt&&(se=Ee(Yt,li,Ki,Qi,vn,Rt),Kt&&(Yt.start=yi+qt*se)):Gn>Ft?xn<Ft&&(se=Ee(Yt,li,Ki,Qi,vn,Ft),Kt&&(Yt.start=yi+qt*se)):ri(Yt,li,Ki,ki),xn<Rt&&Gn>=Rt&&(se=Ee(Yt,li,Ki,Qi,vn,Rt),gn=!0),xn>Ft&&Gn<=Ft&&(se=Ee(Yt,li,Ki,Qi,vn,Ft),gn=!0),!Ht&&gn&&(Kt&&(Yt.end=yi+qt*se),St.push(Yt),Yt=Ci(xt)),Kt&&(yi+=qt)}var kn=xt.length-3;li=xt[kn],Ki=xt[kn+1],ki=xt[kn+2],(Gn=Ut===0?li:Ki)>=Rt&&Gn<=Ft&&ri(Yt,li,Ki,ki),kn=Yt.length-3,Ht&&kn>=3&&(Yt[kn]!==Yt[0]||Yt[kn+1]!==Yt[1])&&ri(Yt,Yt[0],Yt[1],Yt[2]),Yt.length&&St.push(Yt)}function Ci(xt){var St=[];return St.size=xt.size,St.start=xt.start,St.end=xt.end,St}function Xi(xt,St,Rt,Ft,Ut,Ht){for(var Kt=0;Kt<xt.length;Kt++)di(xt[Kt],St,Rt,Ft,Ut,Ht,!1)}function ri(xt,St,Rt,Ft){xt.push(St),xt.push(Rt),xt.push(Ft)}function Vi(xt,St,Rt,Ft,Ut,Ht){var Kt=(Ht-St)/(Ft-St);return xt.push(Ht),xt.push(Rt+(Ut-Rt)*Kt),xt.push(1),Kt}function Ei(xt,St,Rt,Ft,Ut,Ht){var Kt=(Ht-Rt)/(Ut-Rt);return xt.push(St+(Ft-St)*Kt),xt.push(Ht),xt.push(1),Kt}function tn(xt,St){for(var Rt=[],Ft=0;Ft<xt.length;Ft++){var Ut,Ht=xt[Ft],Kt=Ht.type;if(Kt==="Point"||Kt==="MultiPoint"||Kt==="LineString")Ut=ln(Ht.geometry,St);else if(Kt==="MultiLineString"||Kt==="Polygon"){Ut=[];for(var qt=0;qt<Ht.geometry.length;qt++)Ut.push(ln(Ht.geometry[qt],St))}else if(Kt==="MultiPolygon")for(Ut=[],qt=0;qt<Ht.geometry.length;qt++){for(var se=[],Yt=0;Yt<Ht.geometry[qt].length;Yt++)se.push(ln(Ht.geometry[qt][Yt],St));Ut.push(se)}Rt.push(q(Ht.id,Kt,Ut,Ht.tags))}return Rt}function ln(xt,St){var Rt=[];Rt.size=xt.size,xt.start!==void 0&&(Rt.start=xt.start,Rt.end=xt.end);for(var Ft=0;Ft<xt.length;Ft+=3)Rt.push(xt[Ft]+St,xt[Ft+1],xt[Ft+2]);return Rt}function hn(xt,St){if(xt.transformed)return xt;var Rt,Ft,Ut,Ht=1<<xt.z,Kt=xt.x,qt=xt.y;for(Rt=0;Rt<xt.features.length;Rt++){var se=xt.features[Rt],Yt=se.geometry,Ee=se.type;if(se.geometry=[],Ee===1)for(Ft=0;Ft<Yt.length;Ft+=2)se.geometry.push(Be(Yt[Ft],Yt[Ft+1],St,Ht,Kt,qt));else for(Ft=0;Ft<Yt.length;Ft++){var yi=[];for(Ut=0;Ut<Yt[Ft].length;Ut+=2)yi.push(Be(Yt[Ft][Ut],Yt[Ft][Ut+1],St,Ht,Kt,qt));se.geometry.push(yi)}}return xt.transformed=!0,xt}function Be(xt,St,Rt,Ft,Ut,Ht){return[Math.round(Rt*(xt*Ft-Ut)),Math.round(Rt*(St*Ft-Ht))]}function Di(xt,St,Rt,Ft,Ut){for(var Ht=St===Ut.maxZoom?0:Ut.tolerance/((1<<St)*Ut.extent),Kt={features:[],numPoints:0,numSimplified:0,numFeatures:0,source:null,x:Rt,y:Ft,z:St,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0},qt=0;qt<xt.length;qt++){Kt.numFeatures++,Ji(Kt,xt[qt],Ht,Ut);var se=xt[qt].minX,Yt=xt[qt].minY,Ee=xt[qt].maxX,yi=xt[qt].maxY;se<Kt.minX&&(Kt.minX=se),Yt<Kt.minY&&(Kt.minY=Yt),Ee>Kt.maxX&&(Kt.maxX=Ee),yi>Kt.maxY&&(Kt.maxY=yi)}return Kt}function Ji(xt,St,Rt,Ft){var Ut=St.geometry,Ht=St.type,Kt=[];if(Ht==="Point"||Ht==="MultiPoint")for(var qt=0;qt<Ut.length;qt+=3)Kt.push(Ut[qt]),Kt.push(Ut[qt+1]),xt.numPoints++,xt.numSimplified++;else if(Ht==="LineString")Un(Kt,Ut,xt,Rt,!1,!1);else if(Ht==="MultiLineString"||Ht==="Polygon")for(qt=0;qt<Ut.length;qt++)Un(Kt,Ut[qt],xt,Rt,Ht==="Polygon",qt===0);else if(Ht==="MultiPolygon")for(var se=0;se<Ut.length;se++){var Yt=Ut[se];for(qt=0;qt<Yt.length;qt++)Un(Kt,Yt[qt],xt,Rt,!0,qt===0)}if(Kt.length){var Ee=St.tags||null;if(Ht==="LineString"&&Ft.lineMetrics){for(var yi in Ee={},St.tags)Ee[yi]=St.tags[yi];Ee.mapbox_clip_start=Ut.start/Ut.size,Ee.mapbox_clip_end=Ut.end/Ut.size}var fe={geometry:Kt,type:Ht==="Polygon"||Ht==="MultiPolygon"?3:Ht==="LineString"||Ht==="MultiLineString"?2:1,tags:Ee};St.id!==null&&(fe.id=St.id),xt.features.push(fe)}}function Un(xt,St,Rt,Ft,Ut,Ht){var Kt=Ft*Ft;if(Ft>0&&St.size<(Ut?Kt:Ft))Rt.numPoints+=St.length/3;else{for(var qt=[],se=0;se<St.length;se+=3)(Ft===0||St[se+2]>Kt)&&(Rt.numSimplified++,qt.push(St[se]),qt.push(St[se+1])),Rt.numPoints++;Ut&&function(Yt,Ee){for(var yi=0,fe=0,li=Yt.length,Ki=li-2;fe<li;Ki=fe,fe+=2)yi+=(Yt[fe]-Yt[Ki])*(Yt[fe+1]+Yt[Ki+1]);if(yi>0===Ee)for(fe=0,li=Yt.length;fe<li/2;fe+=2){var ki=Yt[fe],Qi=Yt[fe+1];Yt[fe]=Yt[li-2-fe],Yt[fe+1]=Yt[li-1-fe],Yt[li-2-fe]=ki,Yt[li-1-fe]=Qi}}(qt,Ht),xt.push(qt)}}function Vn(xt,St){var Rt=(St=this.options=function(Ut,Ht){for(var Kt in Ht)Ut[Kt]=Ht[Kt];return Ut}(Object.create(this.options),St)).debug;if(Rt&&console.time("preprocess data"),St.maxZoom<0||St.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(St.promoteId&&St.generateId)throw new Error("promoteId and generateId cannot be used together.");var Ft=function(Ut,Ht){var Kt=[];if(Ut.type==="FeatureCollection")for(var qt=0;qt<Ut.features.length;qt++)At(Kt,Ut.features[qt],Ht,qt);else At(Kt,Ut.type==="Feature"?Ut:{geometry:Ut},Ht);return Kt}(xt,St);this.tiles={},this.tileCoords=[],Rt&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",St.indexMaxZoom,St.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),(Ft=function(Ut,Ht){var Kt=Ht.buffer/Ht.extent,qt=Ut,se=ue(Ut,1,-1-Kt,Kt,0,-1,2,Ht),Yt=ue(Ut,1,1-Kt,2+Kt,0,-1,2,Ht);return(se||Yt)&&(qt=ue(Ut,1,-Kt,1+Kt,0,-1,2,Ht)||[],se&&(qt=tn(se,1).concat(qt)),Yt&&(qt=qt.concat(tn(Yt,-1)))),qt}(Ft,St)).length&&this.splitTile(Ft,0,0,0),Rt&&(Ft.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}function Bn(xt,St,Rt){return 32*((1<<xt)*Rt+St)+xt}return Vn.prototype.options={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0},Vn.prototype.splitTile=function(xt,St,Rt,Ft,Ut,Ht,Kt){for(var qt=[xt,St,Rt,Ft],se=this.options,Yt=se.debug;qt.length;){Ft=qt.pop(),Rt=qt.pop(),St=qt.pop(),xt=qt.pop();var Ee=1<<St,yi=Bn(St,Rt,Ft),fe=this.tiles[yi];if(!fe&&(Yt>1&&console.time("creation"),fe=this.tiles[yi]=Di(xt,St,Rt,Ft,se),this.tileCoords.push({z:St,x:Rt,y:Ft}),Yt)){Yt>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",St,Rt,Ft,fe.numFeatures,fe.numPoints,fe.numSimplified),console.timeEnd("creation"));var li="z"+St;this.stats[li]=(this.stats[li]||0)+1,this.total++}if(fe.source=xt,Ut){if(St===se.maxZoom||St===Ut)continue;var Ki=1<<Ut-St;if(Rt!==Math.floor(Ht/Ki)||Ft!==Math.floor(Kt/Ki))continue}else if(St===se.indexMaxZoom||fe.numPoints<=se.indexMaxPoints)continue;if(fe.source=null,xt.length!==0){Yt>1&&console.time("clipping");var ki,Qi,vn,Gn,xn,gn,kn=.5*se.buffer/se.extent,qo=.5-kn,qr=.5+kn,yr=1+kn;ki=Qi=vn=Gn=null,xn=ue(xt,Ee,Rt-kn,Rt+qr,0,fe.minX,fe.maxX,se),gn=ue(xt,Ee,Rt+qo,Rt+yr,0,fe.minX,fe.maxX,se),xt=null,xn&&(ki=ue(xn,Ee,Ft-kn,Ft+qr,1,fe.minY,fe.maxY,se),Qi=ue(xn,Ee,Ft+qo,Ft+yr,1,fe.minY,fe.maxY,se),xn=null),gn&&(vn=ue(gn,Ee,Ft-kn,Ft+qr,1,fe.minY,fe.maxY,se),Gn=ue(gn,Ee,Ft+qo,Ft+yr,1,fe.minY,fe.maxY,se),gn=null),Yt>1&&console.timeEnd("clipping"),qt.push(ki||[],St+1,2*Rt,2*Ft),qt.push(Qi||[],St+1,2*Rt,2*Ft+1),qt.push(vn||[],St+1,2*Rt+1,2*Ft),qt.push(Gn||[],St+1,2*Rt+1,2*Ft+1)}}},Vn.prototype.getTile=function(xt,St,Rt){var Ft=this.options,Ut=Ft.extent,Ht=Ft.debug;if(xt<0||xt>24)return null;var Kt=1<<xt,qt=Bn(xt,St=(St%Kt+Kt)%Kt,Rt);if(this.tiles[qt])return hn(this.tiles[qt],Ut);Ht>1&&console.log("drilling down to z%d-%d-%d",xt,St,Rt);for(var se,Yt=xt,Ee=St,yi=Rt;!se&&Yt>0;)Yt--,Ee=Math.floor(Ee/2),yi=Math.floor(yi/2),se=this.tiles[Bn(Yt,Ee,yi)];return se&&se.source?(Ht>1&&console.log("found parent tile z%d-%d-%d",Yt,Ee,yi),Ht>1&&console.time("drilling down"),this.splitTile(se.source,Yt,Ee,yi,xt,St,Rt),Ht>1&&console.timeEnd("drilling down"),this.tiles[qt]?hn(this.tiles[qt],Ut):null):null},function(xt,St){return new Vn(xt,St)}}();var Te=P.g(ae.exports);function Oe(Dt,F){const q=Dt.tileID.canonical;if(!this._geoJSONIndex)return F(null,null);const J=this._geoJSONIndex.getTile(q.z,q.x,q.y);if(!J)return F(null,null);const At=new class{constructor(ee){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=P.E,this.length=ee.length,this._features=ee}feature(ee){return new class{constructor(ie){this._feature=ie,this.extent=P.E,this.type=ie.type,this.properties=ie.tags,"id"in ie&&!isNaN(ie.id)&&(this.id=parseInt(ie.id,10))}loadGeometry(){if(this._feature.type===1){const ie=[];for(const Pt of this._feature.geometry)ie.push([new P.P(Pt[0],Pt[1])]);return ie}{const ie=[];for(const Pt of this._feature.geometry){const Xt=[];for(const ue of Pt)Xt.push(new P.P(ue[0],ue[1]));ie.push(Xt)}return ie}}toGeoJSON(ie,Pt,Xt){return lt.call(this,ie,Pt,Xt)}}(this._features[ee])}}(J.features);let Ct=Re(At);Ct.byteOffset===0&&Ct.byteLength===Ct.buffer.byteLength||(Ct=new Uint8Array(Ct)),F(null,{vectorTile:At,rawData:Ct.buffer})}class Jt extends P.d{constructor(F,q,J,At,Ct,ee){super(F,q,J,At,Oe,ee),Ct&&(this.loadGeoJSON=Ct)}loadData(F,q){const J=F&&F.request,At=J&&J.collectResourceTiming;this.loadGeoJSON(F,(Ct,ee)=>{if(Ct||!ee)return q(Ct);if(typeof ee!="object")return q(new Error(`Input data given to '${F.source}' is not a valid GeoJSON object.`));{it(ee,!0);try{if(F.filter){const Pt=P.e(F.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if(Pt.result==="error")throw new Error(Pt.value.map(ue=>`${ue.key}: ${ue.message}`).join(", "));ee={type:"FeatureCollection",features:ee.features.filter(ue=>Pt.value.evaluate({zoom:0},ue))}}this._geoJSONIndex=F.cluster?new Me(function({superclusterOptions:Pt,clusterProperties:Xt}){if(!Xt||!Pt)return Pt;const ue={},de={},di={accumulated:null,zoom:0},Ci={properties:null},Xi=Object.keys(Xt);for(const ri of Xi){const[Vi,Ei]=Xt[ri],tn=P.e(Ei),ln=P.e(typeof Vi=="string"?[Vi,["accumulated"],["get",ri]]:Vi);ue[ri]=tn.value,de[ri]=ln.value}return Pt.map=ri=>{Ci.properties=ri;const Vi={};for(const Ei of Xi)Vi[Ei]=ue[Ei].evaluate(di,Ci);return Vi},Pt.reduce=(ri,Vi)=>{Ci.properties=Vi;for(const Ei of Xi)di.accumulated=ri[Ei],ri[Ei]=de[Ei].evaluate(di,Ci)},Pt}(F)).load(ee.features):Te(ee,F.geojsonVtOptions)}catch(Pt){return q(Pt)}this.loaded={};const ie={};if(At){const Pt=P.f(J);Pt&&(ie.resourceTiming={},ie.resourceTiming[F.source]=JSON.parse(JSON.stringify(Pt)))}q(null,ie)}})}reloadTile(F,q){const J=this.loaded;return J&&J[F.uid]?super.reloadTile(F,q):this.loadTile(F,q)}loadGeoJSON(F,q){if(F.request)P.h(F.request,q);else{if(typeof F.data!="string")return q(new Error(`Input data given to '${F.source}' is not a valid GeoJSON object.`));try{return q(null,JSON.parse(F.data))}catch{return q(new Error(`Input data given to '${F.source}' is not a valid GeoJSON object.`))}}}getClusterExpansionZoom(F,q){try{q(null,this._geoJSONIndex.getClusterExpansionZoom(F.clusterId))}catch(J){q(J)}}getClusterChildren(F,q){try{q(null,this._geoJSONIndex.getChildren(F.clusterId))}catch(J){q(J)}}getClusterLeaves(F,q){try{q(null,this._geoJSONIndex.getLeaves(F.clusterId,F.limit,F.offset))}catch(J){q(J)}}}class Xe{constructor(F,q){this.tileID=new P.O(F.tileID.overscaledZ,F.tileID.wrap,F.tileID.canonical.z,F.tileID.canonical.x,F.tileID.canonical.y),this.tileZoom=F.tileZoom,this.uid=F.uid,this.zoom=F.zoom,this.canonical=F.tileID.canonical,this.pixelRatio=F.pixelRatio,this.tileSize=F.tileSize,this.source=F.source,this.overscaling=this.tileID.overscaleFactor(),this.projection=F.projection,this.brightness=q}parse(F,q,J,At){this.status="parsing";const Ct=new P.O(J.tileID.overscaledZ,J.tileID.wrap,J.tileID.canonical.z,J.tileID.canonical.x,J.tileID.canonical.y),ee={},ie=q.familiesBySource[J.source],Pt=new P.F(Ct,J.promoteId);return Pt.bucketLayerIDs=[],P.l(F).then(Xt=>{if(!Xt)return At(new Error("Could not parse tile"));const ue=P.j(Xt,1/P.t(J.tileID.canonical)),de=Xt.json.extensionsUsed&&Xt.json.extensionsUsed.includes("MAPBOX_mesh_features"),di=new P.k(this.zoom,{brightness:this.brightness});for(const Ci in ie)for(const Xi of ie[Ci]){const ri=Xi[0],Vi=Xt.json.extensionsUsed;ri.recalculate(di,[]);const Ei=new P.T(ue,Ct,Vi&&Vi.includes("MAPBOX_mesh_features"),this.brightness);de||(Ei.needsUpload=!0),ee[ri.fqid]=Ei,Ei.evaluate(ri)}this.status="done",At(null,{buckets:ee,featureIndex:Pt})}).catch(Xt=>At(new Error(Xt.message)))}}class mi{constructor(F,q,J,At,Ct,ee){this.actor=F,this.layerIndex=q,this.brightness=ee,this.loading={},this.loaded={}}loadTile(F,q){const J=F.uid,At=this.loading[J]=new Xe(F,this.brightness);P.i(F.request,(Ct,ee)=>{const ie=!this.loading[J];return delete this.loading[J],ie||Ct?(At.status="done",ie||(this.loaded[J]=At),q(Ct)):ee&&ee.byteLength!==0?void At.parse(ee,this.layerIndex,F,(Pt,Xt)=>{At.status="done",this.loaded=this.loaded||{},this.loaded[J]=At,Pt||!Xt?q(Pt):q(null,Xt)}):(At.status="done",this.loaded[J]=At,q())})}reloadTile(F,q){const J=this.loaded,At=F.uid;if(J&&J[At]){const Ct=J[At];Ct.projection=F.projection,Ct.brightness=F.brightness;const ee=(ie,Pt)=>{Ct.reloadCallback&&(delete Ct.reloadCallback,this.loadTile(F,q)),q(ie,Pt)};Ct.status==="parsing"?Ct.reloadCallback=ee:Ct.status==="done"&&this.loadTile(F,q)}}abortTile(F,q){const J=F.uid;this.loading[J]&&delete this.loading[J],q()}removeTile(F,q){const J=this.loaded,At=F.uid;J&&J[At]&&delete J[At],q()}}class gi{constructor(F){this.self=F,this.actor=new P.A(F,this),this.layerIndexes={},this.availableImages={},this.isSpriteLoaded={},this.projections={},this.defaultProjection=P.m({name:"mercator"}),this.workerSourceTypes={vector:P.d,geojson:Jt,"batched-model":mi},this.workerSources={},this.demWorkerSources={},this.self.registerWorkerSource=(q,J)=>{if(this.workerSourceTypes[q])throw new Error(`Worker source with name "${q}" already registered.`);this.workerSourceTypes[q]=J},this.self.registerRTLTextPlugin=q=>{if(P.n.isParsed())throw new Error("RTL text plugin already registered.");P.n.applyArabicShaping=q.applyArabicShaping,P.n.processBidirectionalText=q.processBidirectionalText,P.n.processStyledBidirectionalText=q.processStyledBidirectionalText}}clearCaches(F,q,J){delete this.layerIndexes[F],delete this.availableImages[F],delete this.workerSources[F],delete this.demWorkerSources[F],J()}checkIfReady(F,q,J){J()}setReferrer(F,q){this.referrer=q}spriteLoaded(F,{scope:q,isLoaded:J}){if(this.isSpriteLoaded[F]||(this.isSpriteLoaded[F]={}),this.isSpriteLoaded[F][q]=J,this.workerSources[F]&&this.workerSources[F][q])for(const At in this.workerSources[F][q]){const Ct=this.workerSources[F][q][At];for(const ee in Ct)Ct[ee]instanceof P.d&&(Ct[ee].isSpriteLoaded=J,Ct[ee].fire(new P.o("isSpriteLoaded")))}}setImages(F,{scope:q,images:J},At){if(this.availableImages[F]||(this.availableImages[F]={}),this.availableImages[F][q]=J,this.workerSources[F]&&this.workerSources[F][q]){for(const Ct in this.workerSources[F][q]){const ee=this.workerSources[F][q][Ct];for(const ie in ee)ee[ie].availableImages=J}At()}else At()}setProjection(F,q){this.projections[F]=P.m(q)}setBrightness(F,q,J){this.brightness=q,J()}setLayers(F,q,J){this.getLayerIndex(F,q.scope).replace(q.layers,q.options),J()}updateLayers(F,q,J){this.getLayerIndex(F,q.scope).update(q.layers,q.removedIds,q.options),J()}loadTile(F,q,J){q.projection=this.projections[F]||this.defaultProjection,this.getWorkerSource(F,q.type,q.source,q.scope).loadTile(q,J)}loadDEMTile(F,q,J){this.getDEMWorkerSource(F,q.source,q.scope).loadTile(q,J)}reloadTile(F,q,J){q.projection=this.projections[F]||this.defaultProjection,this.getWorkerSource(F,q.type,q.source,q.scope).reloadTile(q,J)}abortTile(F,q,J){this.getWorkerSource(F,q.type,q.source,q.scope).abortTile(q,J)}removeTile(F,q,J){this.getWorkerSource(F,q.type,q.source,q.scope).removeTile(q,J)}removeSource(F,q,J){if(!(this.workerSources[F]&&this.workerSources[F][q.scope]&&this.workerSources[F][q.scope][q.type]&&this.workerSources[F][q.scope][q.type][q.source]))return;const At=this.workerSources[F][q.scope][q.type][q.source];delete this.workerSources[F][q.scope][q.type][q.source],At.removeSource!==void 0?At.removeSource(q,J):J()}loadWorkerSource(F,q,J){try{this.self.importScripts(q.url),J()}catch(At){J(At.toString())}}syncRTLPluginState(F,q,J){try{P.n.setState(q);const At=P.n.getPluginURL();if(P.n.isLoaded()&&!P.n.isParsed()&&At!=null){this.self.importScripts(At);const Ct=P.n.isParsed();J(Ct?void 0:new Error(`RTL Text Plugin failed to import scripts from ${At}`),Ct)}}catch(At){J(At.toString())}}setDracoUrl(F,q){this.dracoUrl=q}getAvailableImages(F,q){this.availableImages[F]||(this.availableImages[F]={});let J=this.availableImages[F][q];return J||(J=[]),J}getLayerIndex(F,q){this.layerIndexes[F]||(this.layerIndexes[F]={});let J=this.layerIndexes[F][q];return J||(J=this.layerIndexes[F][q]=new V,J.scope=q),J}getWorkerSource(F,q,J,At){if(this.workerSources[F]||(this.workerSources[F]={}),this.workerSources[F][At]||(this.workerSources[F][At]={}),this.workerSources[F][At][q]||(this.workerSources[F][At][q]={}),this.isSpriteLoaded[F]||(this.isSpriteLoaded[F]={}),!this.workerSources[F][At][q][J]){const Ct={send:(ee,ie,Pt,Xt,ue,de)=>{this.actor.send(ee,ie,Pt,F,ue,de)},scheduler:this.actor.scheduler};this.workerSources[F][At][q][J]=new this.workerSourceTypes[q](Ct,this.getLayerIndex(F,At),this.getAvailableImages(F,At),this.isSpriteLoaded[F][At],void 0,this.brightness)}return this.workerSources[F][At][q][J]}getDEMWorkerSource(F,q,J){return this.demWorkerSources[F]||(this.demWorkerSources[F]={}),this.demWorkerSources[F][J]||(this.demWorkerSources[F][J]={}),this.demWorkerSources[F][J][q]||(this.demWorkerSources[F][J][q]=new j),this.demWorkerSources[F][J][q]}enforceCacheSizeLimit(F,q){P.q(q)}getWorkerPerformanceMetrics(F,q,J){J(void 0,void 0)}}return typeof WorkerGlobalScope<"u"&&typeof self<"u"&&self instanceof WorkerGlobalScope&&(self.worker=new gi(self)),gi}),C(["./shared"],function(P){return P.s});var k=A;return k})})(WT);var tL=WT.exports;const W_=Qz(tL);class eL{constructor({className:m="",title:v="",eventHandler:w=function(){}}){this._className=m,this._title=v,this._eventHandler=w}onAdd(m){this._container=document.createElement("div"),this._container.style.display="none",this._container.className="mapboxgl-ctrl-group mapboxgl-ctrl",this._btn=document.createElement("button"),this._btn.className="mapboxgl-ctrl-icon "+this._className,this._btn.type="button",this._btn.ariaLabel="reset map",this._btn.ariaDisabled="false",this._btn.onclick=this._eventHandler;let v=document.createElement("span");return v.classList.add("mapboxgl-ctrl-icon"),v.ariaHidden="true",v.title="Reset map",v.style.backgroundImage=`url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20"><title> fullscreen </title><path fill-rule="evenodd" d="M1 1v6h2V3h4V1H1zm2 12H1v6h6v-2H3v-4zm14 4h-4v2h6v-6h-2v4zm0-16h-4v2h4v4h2V1h-2z"/></svg>')`,this._btn.appendChild(v),this._container.appendChild(this._btn),this._container}onRemove(){this._container.parentNode.removeChild(this._container)}hide(){this._container.style.display="none"}show(){this._container.style.display="inline"}}const $_=f=>{let m={center:f.getCenter(),zoom:parseFloat(f.getZoom().toFixed(3)),bearing:f.getBearing(),pitch:f.getPitch()};return m.center.lat=parseFloat(m.center.lat.toFixed(3)),m.center.lng=parseFloat(m.center.lng.toFixed(3)),m},XT=Eu([{label:"Walking 2022: Total",value:"On foot - Total_pct",group:"census"},{label:"Cycling 2022: Total",value:"Bicycle - Total_pct",group:"census"},{label:"Walking and Cycling 2022: Total",value:"Active travel - Total_pct",group:"census"},{label:"Walking 2016: Total",value:"On foot - Total_pct_16",group:"census"},{label:"Cycling 2016: Total",value:"Bicycle - Total_pct_16",group:"census"},{label:"Walking and Cycling 2016: Total",value:"Active travel - Total_pct_16",group:"census"},{label:"Change in Walking 2016-2022: Total",value:"delta_On foot - Total_pct",group:"census"},{label:"Change in Cycling 2016-2022: Total",value:"delta_Bicycle - Total_pct",group:"census"},{label:"Change in Walking & Cycling 2016-2022: Total",value:"delta_Active travel - Total_pct",group:"census"},{label:"Walking 2022: Work",value:"On foot - Work_pct",group:"census"},{label:"Cycling 2022: Work",value:"Bicycle - Work_pct",group:"census"},{label:"Walking and Cycling 2022: Work",value:"Active travel - Work_pct",group:"census"},{label:"Walking 2016: Work",value:"On foot - Work_pct_16",group:"census"},{label:"Cycling 2016: Work",value:"Bicycle - Work_pct_16",group:"census"},{label:"Walking and Cycling 2016: Work",value:"Active travel - Work_pct_16",group:"census"},{label:"Change in Walking 2016-2022: Work",value:"delta_On foot - Work_pct",group:"census"},{label:"Change in Cycling 2016-2022: Work",value:"delta_Bicycle - Work_pct",group:"census"},{label:"Change in Walking & Cycling 2016-2022: Work",value:"delta_Active travel - Work_pct",group:"census"},{label:"Walking 2022: School/college",value:"On foot - School, college or childcare_pct",group:"census"},{label:"Cycling 2022: School/college",value:"Bicycle - School, college or childcare_pct",group:"census"},{label:"Walking and Cycling 2022: School/college",value:"Active travel - School, college or childcare_pct",group:"census"},{label:"Walking 2016: School/college",value:"On foot - School, college or childcare_pct_16",group:"census"},{label:"Cycling 2016: School/college",value:"Bicycle - School, college or childcare_pct_16",group:"census"},{label:"Walking and Cycling School/college: Total",value:"Active travel - School, college or childcare_pct_16",group:"census"},{label:"Change in Walking 2016-2022: School/college",value:"delta_On foot - School, college or childcare_pct",group:"census"},{label:"Change in Cycling 2016-2022: School/college",value:"delta_Bicycle - School, college or childcare_pct",group:"census"},{label:"Change in Walking & Cycling 2016-2022: School/college",value:"delta_Active travel - School, college or childcare_pct",group:"census"},{label:"Walking 2023",value:"walk_pct",group:"google"},{label:"Cycling 2023",value:"cycle_pct",group:"google"},{label:"Walking and Cycling 2023",value:"active_pct",group:"google"},{label:"Walking",value:"walk_counter",group:"temp"},{label:"Cycling",value:"cycle_counter",group:"temp"},{label:"Walking and Cycling",value:"active_counter",group:"temp"}]),iL=Eu(["Walking","Cycling","Walking and Cycling"]),nL=Eu([{label:"Census",value:"census"},{label:"Google Trips",value:"google"},{label:"Eco Counters Data",value:"temp"}]),rL=Eu(["2022","2016","Change"]),$a=pr("census"),sg=pr("Walking"),jd=pr("2022"),oL=Eu(["Total","Work","School or College"]),Gd=pr("Total"),io=Su([$a,jd,sg,Gd],([f,m,v,w])=>{let A="",C="Total";return console.log("data mode"),console.log(w),w=="School or College"&&(C="School, college or childcare"),w=="Work"&&(C="Work"),f=="census"&&(v=="Walking"&&(A="On foot - "+C+"_pct"),v=="Cycling"&&(A="Bicycle - "+C+"_pct"),v=="Walking and Cycling"&&(A="Active travel - "+C+"_pct"),m=="Change"&&(v=="Walking"&&(A="delta_On foot - "+C+"_pct"),v=="Cycling"&&(A="delta_Bicycle - "+C+"_pct"),v=="Walking and Cycling"&&(A="delta_Active travel - "+C+"_pct")),m=="2016"&&(A=A+"_16")),f=="google"&&(v=="Walking"&&(A="walk_pct"),v=="Cycling"&&(A="cycle_pct"),v=="Walking and Cycling"&&(A="active_pct")),f=="temp"&&(v=="Walking"&&(A="walk_counter"),v=="Cycling"&&(A="cycle_counter"),v=="Walking and Cycling"&&(A="active_counter")),console.log("val:"),console.log(A),A}),sL=Su([io],([f])=>{let m=[0,.05,.1,.15,.2,.25,.3,.35,.4,.45,.5,.55,.6,.65,.7];return f.includes("delta")?(m=[-.21,-.18,-.15,-.12,-.09,-.06,-.03,0,.03,.06,.09,.12,.15,.18,.21],f.includes("Bicycle")&&(m=[-.14,-.12,-.1,-.08,-.06,-.04,-.02,0,.02,.04,.06,.08,.1,.12,.14])):f.includes("Bicycle")&&(m=[0,.015,.03,.045,.06,.075,.09,.105,.12,.135,.15,.165,.18,.195,.21]),m}),aL=Su([io],([f])=>{let m=["#003f5c","#16466d","#2f4b7c","#4a4f88","#675191","#845195","#a15195","#bc5090","#d45187","#e9547a","#f95d6a","#ff6b58","#ff7c43","#ff912b","#ffa600"];return f.includes("delta")&&(m=["#003f5c"," #1a476f","    #384c80","    #58508d","    #8178a9","    #aaa3c5","    #d4d0e2","    #ffffff","    #ffdad5","    #ffb5ad","    #ff8e86","    #ff6361","    #ff764a","    #ff8d2f","#ffa600"]),m}),bg=Su([io,XT],([f,m])=>m.filter(v=>v.value==f)[0].label);let lL=Su(io,f=>new Intl.NumberFormat("en-US",{style:"percent"}));function cL(f){let m,v,w;return{c(){m=gt("div"),this.h()},l(A){m=yt(A,"DIV",{class:!0,style:!0}),vt(m).forEach(nt),this.h()},h(){tt(m,"class","marker svelte-1ai0ux"),xe(m,"opacity",.7),xe(m,"background-color",f[0].mode=="pedestrian"?"#374c80":"#955196"),xe(m,"background-size",f[1]+"px "+f[1]+"px"),xe(m,"height",f[1]+"px"),xe(m,"width",f[1]+"px")},m(A,C){hi(A,m,C),v||(w=ur(m,"click",f[5]),v=!0)},p(A,[C]){C&1&&xe(m,"background-color",A[0].mode=="pedestrian"?"#374c80":"#955196"),C&2&&xe(m,"background-size",A[1]+"px "+A[1]+"px"),C&2&&xe(m,"height",A[1]+"px"),C&2&&xe(m,"width",A[1]+"px")},i:sr,o:sr,d(A){A&&nt(m),v=!1,w()}}}function uL(f,m,v){let w,A,C;_n(f,io,B=>v(3,A=B)),_n(f,Jl,B=>v(4,C=B));let{data:k}=m,P=0;const I=function(){Y_.set(k.id),K_.set(k.name)};return f.$$set=B=>{"data"in B&&v(0,k=B.data)},f.$$.update=()=>{f.$$.dirty&16&&v(2,w=vk().domain([0,5e4]).range([C,C*3])),f.$$.dirty&13&&(k.mode=="pedestrian"&&A=="walk_counter"||k.mode=="bike"&&A=="cycle_counter"||A=="active_counter"?v(1,P=w(k.value)):v(1,P=0))},[k,P,w,A,C,I]}class hL extends jr{constructor(m){super(),Gr(this,m,uL,cL,Vr,{data:0})}}let Fd=[-6.266155,53.4014],Tu=8,ag=[Fd[0]-.2,Fd[1]-.2,Fd[0]+.2,Fd[1]+.2],dL=_s(io),Hl;const Jl=pr(Tu);Jl.set(Tu);let Pn=null,qd=!1,j2="bridge-rail";function G2(f){let m;return f.includes("delta")?(m=[-.21,-.18,-.15,-.12,-.09,-.06,-.03,0,.03,.06,.09,.12,.15,.18,.21],f.includes("cycle")&&(m=[-.14,-.12,-.1,-.08,-.06,-.04,-.02,0,.02,.04,.06,.08,.1,.12,.14])):(m=[0,.05,.1,.15,.2,.25,.3,.35,.4,.45,.5,.55,.6,.65,.7],f.includes("cycle")&&(m=[0,.005,.01,.015,.02,.025,.03,.035,.04,.045,.05,.055,.06,.065,.07]),f.includes("Bicycle")&&(m=[0,.015,.03,.045,.06,.075,.09,.105,.12,.135,.15,.165,.18,.195,.21])),m}function q2(f){let m;return f.includes("delta")?m=["#003f5c"," #1a476f","    #384c80","    #58508d","    #8178a9","    #aaa3c5","    #d4d0e2","    #ffffff","    #ffdad5","    #ffb5ad","    #ff8e86","    #ff6361","    #ff764a","    #ff8d2f","#ffa600"]:m=["#003f5c","#16466d","#2f4b7c","#4a4f88","#675191","#845195","#a15195","#bc5090","#d45187","#e9547a","#f95d6a","#ff6b58","#ff7c43","#ff912b","#ffa600"],m}function fL(f){let m=f.split(",");return[[parseFloat(m[0]),parseFloat(m[1])],[parseFloat(m[2]),parseFloat(m[3])]]}let X_,Z2;function pL(f){X_=["On foot - Total_pct","Bicycle - Total_pct","Active travel - Total_pct","On foot - Total_pct_16","Bicycle - Total_pct_16","Active travel - Total_pct_16","delta_On foot - Total_pct","delta_Bicycle - Total_pct","delta_Active travel - Total_pct","On foot - Work_pct","Bicycle - Work_pct","Active travel - Work_pct","On foot - Work_pct_16","Bicycle - Work_pct_16","Active travel - Work_pct_16","delta_On foot - Work_pct","delta_Bicycle - Work_pct","delta_Active travel - Work_pct","On foot - School, college or childcare_pct","Bicycle - School, college or childcare_pct","Active travel - School, college or childcare_pct","On foot - School, college or childcare_pct_16","Bicycle - School, college or childcare_pct_16","Active travel - School, college or childcare_pct_16","delta_On foot - School, college or childcare_pct","delta_Bicycle - School, college or childcare_pct","delta_Active travel - School, college or childcare_pct"],Z2=["walk_pct","cycle_pct","active_pct"],F_.set("map-layer-"+dL);const m=new eL({className:"fit-bounds-button",title:"Go back to Dublin",eventHandler:()=>{vs()}});return Pn=new W_.Map({accessToken:{NVM_INC:"/Users/rudi/.nvm/versions/node/v20.11.1/include/node",MANPATH:"/Users/rudi/.nvm/versions/node/v20.11.1/share/man:/opt/homebrew/share/man:/usr/share/man:/usr/local/share/man:/Users/rudi/.nvm/versions/node/v20.11.1/share/man:/opt/homebrew/share/man::",TERM_PROGRAM:"vscode",NODE:"/Users/rudi/.nvm/versions/node/v20.11.1/bin/node",INIT_CWD:"/Users/rudi/Documents/GitHub/active_travel_new",NVM_CD_FLAGS:"-q",TERM:"xterm-256color",SHELL:"/bin/zsh",HOMEBREW_REPOSITORY:"/opt/homebrew",TMPDIR:"/var/folders/c6/jsjxnj0j6vqbnpqy37npy5dw0000gn/T/",npm_config_global_prefix:"/Users/rudi/.nvm/versions/node/v20.11.1",TERM_PROGRAM_VERSION:"1.93.1",ZDOTDIR:"/Users/rudi",ORIGINAL_XDG_CURRENT_DESKTOP:"undefined",MallocNanoZone:"0",COLOR:"1",npm_config_noproxy:"",npm_config_local_prefix:"/Users/rudi/Documents/GitHub/active_travel_new",NVM_DIR:"/Users/rudi/.nvm",USER:"rudi",COMMAND_MODE:"unix2003",npm_config_globalconfig:"/Users/rudi/.nvm/versions/node/v20.11.1/etc/npmrc",SSH_AUTH_SOCK:"/private/tmp/com.apple.launchd.FFteYWhD7t/Listeners",__CF_USER_TEXT_ENCODING:"0x1F5:0:2",npm_execpath:"/Users/rudi/.nvm/versions/node/v20.11.1/lib/node_modules/npm/bin/npm-cli.js",STARDOG_HOME:"/var/stardog",PATH:"/Users/rudi/Documents/GitHub/active_travel_new/node_modules/.bin:/Users/rudi/Documents/GitHub/node_modules/.bin:/Users/rudi/Documents/node_modules/.bin:/Users/rudi/node_modules/.bin:/Users/node_modules/.bin:/node_modules/.bin:/Users/rudi/.nvm/versions/node/v20.11.1/lib/node_modules/npm/node_modules/@npmcli/run-script/lib/node-gyp-bin:/opt/homebrew/opt/openjdk/bin:/opt/homebrew/opt/openjdk/bin:/Users/rudi/.nvm/versions/node/v20.11.1/bin:/opt/homebrew/bin:/opt/homebrew/sbin:/Library/Frameworks/Python.framework/Versions/3.9/bin:/usr/local/bin:/System/Cryptexes/App/usr/bin:/usr/bin:/bin:/usr/sbin:/sbin:/var/run/com.apple.security.cryptexd/codex.system/bootstrap/usr/local/bin:/var/run/com.apple.security.cryptexd/codex.system/bootstrap/usr/bin:/var/run/com.apple.security.cryptexd/codex.system/bootstrap/usr/appleinternal/bin:/opt/homebrew/opt/openjdk/bin:/Users/rudi/.nvm/versions/node/v20.11.1/bin:/opt/homebrew/bin:/opt/homebrew/sbin:/Library/Frameworks/Python.framework/Versions/3.9/bin",npm_package_json:"/Users/rudi/Documents/GitHub/active_travel_new/package.json",_:"/Users/rudi/Documents/GitHub/active_travel_new/node_modules/.bin/vite",npm_config_userconfig:"/Users/rudi/.npmrc",npm_config_init_module:"/Users/rudi/.npm-init.js",USER_ZDOTDIR:"/Users/rudi",__CFBundleIdentifier:"com.microsoft.VSCode",npm_command:"run-script",PWD:"/Users/rudi/Documents/GitHub/active_travel_new",npm_lifecycle_event:"build",EDITOR:"vi",npm_package_name:"dataviz-project-starter-kit",LANG:"en_US.UTF-8",npm_config_npm_version:"10.2.4",VSCODE_GIT_ASKPASS_EXTRA_ARGS:"",XPC_FLAGS:"0x0",npm_config_node_gyp:"/Users/rudi/.nvm/versions/node/v20.11.1/lib/node_modules/npm/node_modules/node-gyp/bin/node-gyp.js",npm_package_version:"0.3.0",XPC_SERVICE_NAME:"0",VSCODE_INJECTION:"1",SHLVL:"2",HOME:"/Users/rudi",VSCODE_GIT_ASKPASS_MAIN:"/Applications/Visual Studio Code.app/Contents/Resources/app/extensions/git/dist/askpass-main.js",HOMEBREW_PREFIX:"/opt/homebrew",npm_config_cache:"/Users/rudi/.npm",LOGNAME:"rudi",npm_lifecycle_script:"vite build",VSCODE_GIT_IPC_HANDLE:"/var/folders/c6/jsjxnj0j6vqbnpqy37npy5dw0000gn/T/vscode-git-92b83a983c.sock",NVM_BIN:"/Users/rudi/.nvm/versions/node/v20.11.1/bin",npm_config_user_agent:"npm/10.2.4 node/v20.11.1 darwin arm64 workspaces/false",VSCODE_GIT_ASKPASS_NODE:"/Applications/Visual Studio Code.app/Contents/Frameworks/Code Helper (Plugin).app/Contents/MacOS/Code Helper (Plugin)",GIT_ASKPASS:"/Applications/Visual Studio Code.app/Contents/Resources/app/extensions/git/dist/askpass.sh",INFOPATH:"/opt/homebrew/share/info:/opt/homebrew/share/info:",HOMEBREW_CELLAR:"/opt/homebrew/Cellar",npm_node_execpath:"/Users/rudi/.nvm/versions/node/v20.11.1/bin/node",npm_config_prefix:"/Users/rudi/.nvm/versions/node/v20.11.1",COLORTERM:"truecolor",NODE_ENV:"production"}.PUBLIC_MAPBOX_TOKEN,container:f,style:"mapbox://styles/mapbox/streets-v12",bounds:ag,minZoom:Tu,maxZoom:12,antialias:!0,dragPan:!0,dragRotate:!1,fitBoundsOptions:{padding:120}}).addControl(new W_.NavigationControl({showCompass:!1}),"bottom-right").addControl(m,"bottom-right"),{getMap:function(){return Pn},onLoad:function(){Pn.on("load",()=>{Pn.addSource("electoral-boundary-source",{type:"geojson",data:"./census_data_total.geojson"}),Pn.addSource("division-boundary-source",{type:"geojson",data:"./divisions.geojson"}),Pn.addSource("LineString",{type:"geojson",data:"./segregated_lanes.geojson"});for(let A of X_){A==_s(io)?Hl=.8:Hl=0;let C=q2(A),k=G2(A);Pn.addLayer({id:"map-layer-"+A,type:"fill",source:"electoral-boundary-source",paint:{"fill-outline-color":"black","fill-opacity":Hl,"fill-color":["case",["==",["get",A],null],"white",["step",["get",A],C[0],k[1],C[1],k[2],C[2],k[3],C[3],k[4],C[4],k[5],C[5],k[6],C[6],k[7],C[7],k[8],C[8],k[9],C[9],k[10],C[10],k[11],C[11],k[12],C[12],k[13],C[13],k[14],C[14]]]}},j2)}for(let A of Z2){A==_s(io)?Hl=.8:Hl=0;let C=q2(A),k=G2(A);Pn.addLayer({id:"map-layer-"+A,type:"fill",source:"division-boundary-source",paint:{"fill-outline-color":"black","fill-opacity":Hl,"fill-color":["case",["==",["get",A],null],"white",["step",["get",A],C[0],k[1],C[1],k[2],C[2],k[3],C[3],k[4],C[4],k[5],C[5],k[6],C[6],k[7],C[7],k[8],C[8],k[9],C[9],k[10],C[10],k[11],C[11],k[12],C[12],k[13],C[13],k[14],C[14]]]}},j2)}Pn.addLayer({id:"LineString",type:"line",source:"LineString",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#fff","line-width":0}});let v=_s(wT);console.log(v),v.map(A=>{let C=document.createElement("div");return new hL({target:C,props:{data:A}}),new W_.Marker({element:C}).setLngLat([A.lon,A.lat]).addTo(Pn).getElement()});let w=document.getElementsByClassName("marker");for(let A=0;A<w.length;A++)w[A].style.visibility="hidden";for(let A of X_)Pn.setPaintProperty("map-layer-"+A,"fill-opacity-transition",{duration:500});qd=!0}),Pn.on("click",v=>{if(!_s(io).includes("counter")){let w=Pn.queryRenderedFeatures(v.point).filter(function(A){return A.layer.id==_s(F_)});tc.set(w[0].properties),Pn.fitBounds(fL(w[0].properties.bbox),{padding:150})}}),Pn.on("zoom",()=>{if(this.isMapLoaded()){let v=$_(Pn);Jl.set(v.zoom)}}),Pn.on("load",()=>{if(this.isMapLoaded()){Pn.resize();let v=$_(Pn);m.show(),v=$_(Pn),Jl.set(v.zoom)}})},isMapLoaded:function(){return qd},resetMap(){tc.set("999999"),Pn.fitBounds(ag,{padding:35}),Jl.set(Tu)},changeActiveLayer:(v,w)=>{if(!qd)return;let A=w,C=document.getElementsByClassName("marker");if(v.includes("counter"))for(let k=0;k<C.length;k++)C[k].style.visibility="visible";else for(let k=0;k<C.length;k++)C[k].style.visibility="hidden";for(let{_:k,value:P}of A)P.includes("counter")||(Pn.setPaintProperty("map-layer-"+P,"fill-opacity",P===v?.8:0),P==v&&F_.set("map-layer-"+P))}}}function vs(){tc.set("999999"),Pn.fitBounds(ag,{padding:35}),Jl.set(Tu)}const lg=pr(null);function mL(){if(qd)if(_s(TT)==!0){Pn.setPaintProperty("LineString","line-width",2);let f="white";_s(io).includes("counter")&&(f="#333"),Pn.setPaintProperty("LineString","line-color",f)}else Pn.setPaintProperty("LineString","line-width",0)}function _L(f,m){m&&m!=="lg"&&m!=="sm"&&m!=="xs"?f.style.fontSize=m.replace("x","em"):f.style.fontSize=""}function gL(f,m,v,w,A,C=1,k="",P=""){let I=1,B=1;A&&(A=="horizontal"?I=-1:A=="vertical"?B=-1:I=B=-1),typeof f=="string"&&(f=parseFloat(f)),typeof m=="string"&&(m=parseFloat(m)),typeof v=="string"&&(v=parseFloat(v));const V=`${m*C}${k}`,j=`${v*C}${k}`;let Q=`translate(${V},${j}) scale(${I*f},${B*f})`;return w&&(Q+=` rotate(${w}${P})`),Q}function H2(f){let m,v,w,A,C,k,P;function I(j,Q){return typeof j[16][4]=="string"?vL:yL}let B=I(f),V=B(f);return{c(){m=Qn("svg"),v=Qn("g"),w=Qn("g"),V.c(),this.h()},l(j){m=tr(j,"svg",{id:!0,class:!0,style:!0,viewBox:!0,"aria-hidden":!0,role:!0,xmlns:!0});var Q=vt(m);v=tr(Q,"g",{transform:!0,"transform-origin":!0});var et=vt(v);w=tr(et,"g",{transform:!0});var it=vt(w);V.l(it),it.forEach(nt),et.forEach(nt),Q.forEach(nt),this.h()},h(){tt(w,"transform",f[15]),tt(v,"transform",A="translate("+f[16][0]/2+" "+f[16][1]/2+")"),tt(v,"transform-origin",C=f[16][0]/4+" 0"),tt(m,"id",f[1]),tt(m,"class",k="svelte-fa svelte-fa-base "+f[0]+" svelte-bvo74f"),tt(m,"style",f[2]),tt(m,"viewBox",P="0 0 "+f[16][0]+" "+f[16][1]),tt(m,"aria-hidden","true"),tt(m,"role","img"),tt(m,"xmlns","http://www.w3.org/2000/svg"),or(m,"pulse",f[8]),or(m,"svelte-fa-size-lg",f[3]==="lg"),or(m,"svelte-fa-size-sm",f[3]==="sm"),or(m,"svelte-fa-size-xs",f[3]==="xs"),or(m,"svelte-fa-fw",f[5]),or(m,"svelte-fa-pull-left",f[6]==="left"),or(m,"svelte-fa-pull-right",f[6]==="right"),or(m,"spin",f[7])},m(j,Q){hi(j,m,Q),W(m,v),W(v,w),V.m(w,null),f[23](m)},p(j,Q){B===(B=I(j))&&V?V.p(j,Q):(V.d(1),V=B(j),V&&(V.c(),V.m(w,null))),Q&32768&&tt(w,"transform",j[15]),Q&65536&&A!==(A="translate("+j[16][0]/2+" "+j[16][1]/2+")")&&tt(v,"transform",A),Q&65536&&C!==(C=j[16][0]/4+" 0")&&tt(v,"transform-origin",C),Q&2&&tt(m,"id",j[1]),Q&1&&k!==(k="svelte-fa svelte-fa-base "+j[0]+" svelte-bvo74f")&&tt(m,"class",k),Q&4&&tt(m,"style",j[2]),Q&65536&&P!==(P="0 0 "+j[16][0]+" "+j[16][1])&&tt(m,"viewBox",P),Q&257&&or(m,"pulse",j[8]),Q&9&&or(m,"svelte-fa-size-lg",j[3]==="lg"),Q&9&&or(m,"svelte-fa-size-sm",j[3]==="sm"),Q&9&&or(m,"svelte-fa-size-xs",j[3]==="xs"),Q&33&&or(m,"svelte-fa-fw",j[5]),Q&65&&or(m,"svelte-fa-pull-left",j[6]==="left"),Q&65&&or(m,"svelte-fa-pull-right",j[6]==="right"),Q&129&&or(m,"spin",j[7])},d(j){j&&nt(m),V.d(),f[23](null)}}}function yL(f){let m,v,w,A,C,k,P,I,B,V;return{c(){m=Qn("path"),k=Qn("path"),this.h()},l(j){m=tr(j,"path",{d:!0,fill:!0,"fill-opacity":!0,transform:!0}),vt(m).forEach(nt),k=tr(j,"path",{d:!0,fill:!0,"fill-opacity":!0,transform:!0}),vt(k).forEach(nt),this.h()},h(){tt(m,"d",v=f[16][4][0]),tt(m,"fill",w=f[10]||f[4]||"currentColor"),tt(m,"fill-opacity",A=f[13]!=!1?f[11]:f[12]),tt(m,"transform",C="translate("+f[16][0]/-2+" "+f[16][1]/-2+")"),tt(k,"d",P=f[16][4][1]),tt(k,"fill",I=f[9]||f[4]||"currentColor"),tt(k,"fill-opacity",B=f[13]!=!1?f[12]:f[11]),tt(k,"transform",V="translate("+f[16][0]/-2+" "+f[16][1]/-2+")")},m(j,Q){hi(j,m,Q),hi(j,k,Q)},p(j,Q){Q&65536&&v!==(v=j[16][4][0])&&tt(m,"d",v),Q&1040&&w!==(w=j[10]||j[4]||"currentColor")&&tt(m,"fill",w),Q&14336&&A!==(A=j[13]!=!1?j[11]:j[12])&&tt(m,"fill-opacity",A),Q&65536&&C!==(C="translate("+j[16][0]/-2+" "+j[16][1]/-2+")")&&tt(m,"transform",C),Q&65536&&P!==(P=j[16][4][1])&&tt(k,"d",P),Q&528&&I!==(I=j[9]||j[4]||"currentColor")&&tt(k,"fill",I),Q&14336&&B!==(B=j[13]!=!1?j[12]:j[11])&&tt(k,"fill-opacity",B),Q&65536&&V!==(V="translate("+j[16][0]/-2+" "+j[16][1]/-2+")")&&tt(k,"transform",V)},d(j){j&&(nt(m),nt(k))}}}function vL(f){let m,v,w,A;return{c(){m=Qn("path"),this.h()},l(C){m=tr(C,"path",{d:!0,fill:!0,transform:!0}),vt(m).forEach(nt),this.h()},h(){tt(m,"d",v=f[16][4]),tt(m,"fill",w=f[4]||f[9]||"currentColor"),tt(m,"transform",A="translate("+f[16][0]/-2+" "+f[16][1]/-2+")")},m(C,k){hi(C,m,k)},p(C,k){k&65536&&v!==(v=C[16][4])&&tt(m,"d",v),k&528&&w!==(w=C[4]||C[9]||"currentColor")&&tt(m,"fill",w),k&65536&&A!==(A="translate("+C[16][0]/-2+" "+C[16][1]/-2+")")&&tt(m,"transform",A)},d(C){C&&nt(m)}}}function xL(f){let m,v=f[16][4]&&H2(f);return{c(){v&&v.c(),m=Go()},l(w){v&&v.l(w),m=Go()},m(w,A){v&&v.m(w,A),hi(w,m,A)},p(w,[A]){w[16][4]?v?v.p(w,A):(v=H2(w),v.c(),v.m(m.parentNode,m)):v&&(v.d(1),v=null)},i:sr,o:sr,d(w){w&&nt(m),v&&v.d(w)}}}function bL(f,m,v){let w,A,{class:C=void 0}=m,{id:k=void 0}=m,{style:P=void 0}=m,{icon:I}=m,{size:B=void 0}=m,{color:V=void 0}=m,{fw:j=!1}=m,{pull:Q=void 0}=m,{scale:et=1}=m,{translateX:it=0}=m,{translateY:lt=0}=m,{rotate:_t=void 0}=m,{flip:ht=void 0}=m,{spin:Bt=!1}=m,{pulse:dt=!1}=m,{primaryColor:It=""}=m,{secondaryColor:Wt=""}=m,{primaryOpacity:zt=1}=m,{secondaryOpacity:Zt=.4}=m,{swapOpacity:$t=!1}=m,G;function Tt(mt){sa[mt?"unshift":"push"](()=>{G=mt,v(14,G)})}return f.$$set=mt=>{"class"in mt&&v(0,C=mt.class),"id"in mt&&v(1,k=mt.id),"style"in mt&&v(2,P=mt.style),"icon"in mt&&v(17,I=mt.icon),"size"in mt&&v(3,B=mt.size),"color"in mt&&v(4,V=mt.color),"fw"in mt&&v(5,j=mt.fw),"pull"in mt&&v(6,Q=mt.pull),"scale"in mt&&v(18,et=mt.scale),"translateX"in mt&&v(19,it=mt.translateX),"translateY"in mt&&v(20,lt=mt.translateY),"rotate"in mt&&v(21,_t=mt.rotate),"flip"in mt&&v(22,ht=mt.flip),"spin"in mt&&v(7,Bt=mt.spin),"pulse"in mt&&v(8,dt=mt.pulse),"primaryColor"in mt&&v(9,It=mt.primaryColor),"secondaryColor"in mt&&v(10,Wt=mt.secondaryColor),"primaryOpacity"in mt&&v(11,zt=mt.primaryOpacity),"secondaryOpacity"in mt&&v(12,Zt=mt.secondaryOpacity),"swapOpacity"in mt&&v(13,$t=mt.swapOpacity)},f.$$.update=()=>{f.$$.dirty&16392&&G&&B&&_L(G,B),f.$$.dirty&131072&&v(16,w=I&&I.icon||[0,0,"",[],""]),f.$$.dirty&8126464&&v(15,A=gL(et,it,lt,_t,ht,512))},[C,k,P,B,V,j,Q,Bt,dt,It,Wt,zt,Zt,$t,G,A,w,I,et,it,lt,_t,ht,Tt]}class Tn extends jr{constructor(m){super(),Gr(this,m,bL,xL,Vr,{class:0,id:1,style:2,icon:17,size:3,color:4,fw:5,pull:6,scale:18,translateX:19,translateY:20,rotate:21,flip:22,spin:7,pulse:8,primaryColor:9,secondaryColor:10,primaryOpacity:11,secondaryOpacity:12,swapOpacity:13})}}var uf={prefix:"fas",iconName:"car-side",icon:[640,512,[128663],"f5e4","M171.3 96H224v96H111.3l30.4-75.9C146.5 104 158.2 96 171.3 96zM272 192V96h81.2c9.7 0 18.9 4.4 25 12l67.2 84H272zm256.2 1L428.2 68c-18.2-22.8-45.8-36-75-36H171.3c-39.3 0-74.6 23.9-89.1 60.3L40.6 196.4C16.8 205.8 0 228.9 0 256V368c0 17.7 14.3 32 32 32H65.3c7.6 45.4 47.1 80 94.7 80s87.1-34.6 94.7-80H385.3c7.6 45.4 47.1 80 94.7 80s87.1-34.6 94.7-80H608c17.7 0 32-14.3 32-32V320c0-65.2-48.8-119-111.8-127zM434.7 368a48 48 0 1 1 90.5 32 48 48 0 1 1 -90.5-32zM160 336a48 48 0 1 1 0 96 48 48 0 1 1 0-96z"]},ra={prefix:"fas",iconName:"bicycle",icon:[640,512,[128690],"f206","M312 32c-13.3 0-24 10.7-24 24s10.7 24 24 24h25.7l34.6 64H222.9l-27.4-38C191 99.7 183.7 96 176 96H120c-13.3 0-24 10.7-24 24s10.7 24 24 24h43.7l22.1 30.7-26.6 53.1c-10-2.5-20.5-3.8-31.2-3.8C57.3 224 0 281.3 0 352s57.3 128 128 128c65.3 0 119.1-48.9 127-112h49c8.5 0 16.3-4.5 20.7-11.8l84.8-143.5 21.7 40.1C402.4 276.3 384 312 384 352c0 70.7 57.3 128 128 128s128-57.3 128-128s-57.3-128-128-128c-13.5 0-26.5 2.1-38.7 6L375.4 48.8C369.8 38.4 359 32 347.2 32H312zM458.6 303.7l32.3 59.7c6.3 11.7 20.9 16 32.5 9.7s16-20.9 9.7-32.5l-32.3-59.7c3.6-.6 7.4-.9 11.2-.9c39.8 0 72 32.2 72 72s-32.2 72-72 72s-72-32.2-72-72c0-18.6 7-35.5 18.6-48.3zM133.2 368h65c-7.3 32.1-36 56-70.2 56c-39.8 0-72-32.2-72-72s32.2-72 72-72c1.7 0 3.4 .1 5.1 .2l-24.2 48.5c-9 18.1 4.1 39.4 24.3 39.4zm33.7-48l50.7-101.3 72.9 101.2-.1 .1H166.8zm90.6-128H365.9L317 274.8 257.4 192z"]},wL={prefix:"fas",iconName:"heart-pulse",icon:[512,512,["heartbeat"],"f21e","M228.3 469.1L47.6 300.4c-4.2-3.9-8.2-8.1-11.9-12.4h87c22.6 0 43-13.6 51.7-34.5l10.5-25.2 49.3 109.5c3.8 8.5 12.1 14 21.4 14.1s17.8-5 22-13.3L320 253.7l1.7 3.4c9.5 19 28.9 31 50.1 31H476.3c-3.7 4.3-7.7 8.5-11.9 12.4L283.7 469.1c-7.5 7-17.4 10.9-27.7 10.9s-20.2-3.9-27.7-10.9zM503.7 240h-132c-3 0-5.8-1.7-7.2-4.4l-23.2-46.3c-4.1-8.1-12.4-13.3-21.5-13.3s-17.4 5.1-21.5 13.3l-41.4 82.8L205.9 158.2c-3.9-8.7-12.7-14.3-22.2-14.1s-18.1 5.9-21.8 14.8l-31.8 76.3c-1.2 3-4.2 4.9-7.4 4.9H16c-2.6 0-5 .4-7.3 1.1C3 225.2 0 208.2 0 190.9v-5.8c0-69.9 50.5-129.5 119.4-141C165 36.5 211.4 51.4 244 84l12 12 12-12c32.6-32.6 79-47.5 124.6-39.9C461.5 55.6 512 115.2 512 185.1v5.8c0 16.9-2.8 33.5-8.3 49.1z"]},oa={prefix:"fas",iconName:"person-walking",icon:[320,512,[128694,"walking"],"f554","M160 48a48 48 0 1 1 96 0 48 48 0 1 1 -96 0zM126.5 199.3c-1 .4-1.9 .8-2.9 1.2l-8 3.5c-16.4 7.3-29 21.2-34.7 38.2l-2.6 7.8c-5.6 16.8-23.7 25.8-40.5 20.2s-25.8-23.7-20.2-40.5l2.6-7.8c11.4-34.1 36.6-61.9 69.4-76.5l8-3.5c20.8-9.2 43.3-14 66.1-14c44.6 0 84.8 26.8 101.9 67.9L281 232.7l21.4 10.7c15.8 7.9 22.2 27.1 14.3 42.9s-27.1 22.2-42.9 14.3L247 287.3c-10.3-5.2-18.4-13.8-22.8-24.5l-9.6-23-19.3 65.5 49.5 54c5.4 5.9 9.2 13 11.2 20.8l23 92.1c4.3 17.1-6.1 34.5-23.3 38.8s-34.5-6.1-38.8-23.3l-22-88.1-70.7-77.1c-14.8-16.1-20.3-38.6-14.7-59.7l16.9-63.5zM68.7 398l25-62.4c2.1 3 4.5 5.8 7 8.6l40.7 44.4-14.5 36.2c-2.4 6-6 11.5-10.6 16.1L54.6 502.6c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L68.7 398z"]},TL={prefix:"fas",iconName:"euro-sign",icon:[320,512,[8364,"eur","euro"],"f153","M48.1 240c-.1 2.7-.1 5.3-.1 8v16c0 2.7 0 5.3 .1 8H32c-17.7 0-32 14.3-32 32s14.3 32 32 32H60.3C89.9 419.9 170 480 264 480h24c17.7 0 32-14.3 32-32s-14.3-32-32-32H264c-57.9 0-108.2-32.4-133.9-80H256c17.7 0 32-14.3 32-32s-14.3-32-32-32H112.2c-.1-2.6-.2-5.3-.2-8V248c0-2.7 .1-5.4 .2-8H256c17.7 0 32-14.3 32-32s-14.3-32-32-32H130.1c25.7-47.6 76-80 133.9-80h24c17.7 0 32-14.3 32-32s-14.3-32-32-32H264C170 32 89.9 92.1 60.3 176H32c-17.7 0-32 14.3-32 32s14.3 32 32 32H48.1z"]},cg={prefix:"fas",iconName:"smog",icon:[640,512,[],"f75f","M32 144c0 79.5 64.5 144 144 144H299.3c22.6 19.9 52.2 32 84.7 32s62.1-12.1 84.7-32H496c61.9 0 112-50.1 112-112s-50.1-112-112-112c-10.7 0-21 1.5-30.8 4.3C443.8 27.7 401.1 0 352 0c-32.6 0-62.4 12.2-85.1 32.3C242.1 12.1 210.5 0 176 0C96.5 0 32 64.5 32 144zM616 368H280c-13.3 0-24 10.7-24 24s10.7 24 24 24H616c13.3 0 24-10.7 24-24s-10.7-24-24-24zm-64 96H440c-13.3 0-24 10.7-24 24s10.7 24 24 24H552c13.3 0 24-10.7 24-24s-10.7-24-24-24zm-192 0H24c-13.3 0-24 10.7-24 24s10.7 24 24 24H360c13.3 0 24-10.7 24-24s-10.7-24-24-24zM224 392c0-13.3-10.7-24-24-24H96c-13.3 0-24 10.7-24 24s10.7 24 24 24H200c13.3 0 24-10.7 24-24z"]},wg={prefix:"fas",iconName:"bus",icon:[576,512,[128653],"f207","M288 0C422.4 0 512 35.2 512 80V96l0 32c17.7 0 32 14.3 32 32v64c0 17.7-14.3 32-32 32l0 160c0 17.7-14.3 32-32 32v32c0 17.7-14.3 32-32 32H416c-17.7 0-32-14.3-32-32V448H192v32c0 17.7-14.3 32-32 32H128c-17.7 0-32-14.3-32-32l0-32c-17.7 0-32-14.3-32-32l0-160c-17.7 0-32-14.3-32-32V160c0-17.7 14.3-32 32-32h0V96h0V80C64 35.2 153.6 0 288 0zM128 160v96c0 17.7 14.3 32 32 32H272V128H160c-17.7 0-32 14.3-32 32zM304 288H416c17.7 0 32-14.3 32-32V160c0-17.7-14.3-32-32-32H304V288zM144 400a32 32 0 1 0 0-64 32 32 0 1 0 0 64zm288 0a32 32 0 1 0 0-64 32 32 0 1 0 0 64zM384 80c0-8.8-7.2-16-16-16H208c-8.8 0-16 7.2-16 16s7.2 16 16 16H368c8.8 0 16-7.2 16-16z"]};function ML(f){let m,v,w="Region",A,C,k,P,I,B,V="&#9204;";return{c(){m=gt("div"),v=gt("p"),v.textContent=w,A=me(),C=gt("p"),k=qe(f[3]),P=me(),I=gt("p"),B=new rc(!1),this.h()},l(j){m=yt(j,"DIV",{class:!0});var Q=vt(m);v=yt(Q,"P",{class:!0,"data-svelte-h":!0}),Ur(v)!=="svelte-vv3ej7"&&(v.textContent=w),A=_e(Q),C=yt(Q,"P",{class:!0});var et=vt(C);k=Ze(et,f[3]),et.forEach(nt),P=_e(Q),I=yt(Q,"P",{class:!0});var it=vt(I);B=oc(it,!1),it.forEach(nt),Q.forEach(nt),this.h()},h(){tt(v,"class","label svelte-tnuu5p"),tt(C,"class","loc svelte-tnuu5p"),B.a=null,tt(I,"class","label svelte-tnuu5p"),tt(m,"class","text svelte-tnuu5p")},m(j,Q){hi(j,m,Q),W(m,v),W(m,A),W(m,C),W(C,k),W(m,P),W(m,I),B.m(V,I)},p(j,Q){Q&8&&Ai(k,j[3])},d(j){j&&nt(m)}}}function EL(f){let m,v,w="Region",A,C,k,P,I;return{c(){m=gt("div"),v=gt("p"),v.textContent=w,A=me(),C=gt("p"),k=qe(f[3]),P=me(),I=gt("p"),this.h()},l(B){m=yt(B,"DIV",{class:!0});var V=vt(m);v=yt(V,"P",{class:!0,"data-svelte-h":!0}),Ur(v)!=="svelte-vv3ej7"&&(v.textContent=w),A=_e(V),C=yt(V,"P",{class:!0});var j=vt(C);k=Ze(j,f[3]),j.forEach(nt),P=_e(V),I=yt(V,"P",{class:!0}),vt(I).forEach(nt),V.forEach(nt),this.h()},h(){tt(v,"class","label svelte-tnuu5p"),tt(C,"class","loc svelte-tnuu5p"),tt(I,"class","label svelte-tnuu5p"),tt(m,"class","text svelte-tnuu5p")},m(B,V){hi(B,m,V),W(m,v),W(m,A),W(m,C),W(C,k),W(m,P),W(m,I)},p(B,V){V&8&&Ai(k,B[3])},d(B){B&&nt(m)}}}function SL(f){let m,v,w,A="Regional info: "+f[14],C,k,P,I,B,V,j,Q,et="Commuters",it,lt,_t=f[12]+" ",ht,Bt,dt,It,Wt,zt=f[13]+" ",Zt,$t,G,Tt,mt,Ot,wt,ne,ai,Re,Je,We,Pe,be,Lt="Annual premature deaths avoided",Fe,Me,Ii=f[11]+" ",Oi,Vt,Ve,rn,ae,Te=f[10]+" ",Oe,Jt,Xe,mi,gi,Dt,F,q,J,At,Ct,ee="Annual money saved on fuel",ie,Pt,Xt=f[9]+" ",ue,de,di,Ci,Xi,ri=f[8]+" ",Vi,Ei,tn,ln,hn,Be,Di,Ji,Un,Vn,Bn,xt,St="Annual CO2 saved (Tonnes)",Rt,Ft,Ut=f[6]+" ",Ht,Kt,qt,se,Yt,Ee=f[7]+" ",yi,fe,li,Ki,ki,Qi,vn,Gn,xn,gn,kn,qo="Annual time savings (years)",qr,yr,Zo=f[4]+" ",ca,ws,_o,sc,go,ua=f[5]+" ",Ho,Wo,Zr,Ka,Ts,yo,$o,Ms="About "+f[2],Es,ha,vo,xo,zn,Ss,bo;function ac(Se,ji){return Se[3]==="Dublin"?EL:ML}let ke=ac(f),vi=ke(f);return dt=new Tn({props:{icon:ra}}),G=new Tn({props:{icon:oa}}),ne=new Tn({props:{icon:wL}}),Ve=new Tn({props:{icon:ra}}),Xe=new Tn({props:{icon:oa}}),F=new Tn({props:{icon:TL}}),di=new Tn({props:{icon:ra}}),tn=new Tn({props:{icon:oa}}),Ji=new Tn({props:{icon:cg}}),qt=new Tn({props:{icon:ra}}),li=new Tn({props:{icon:oa}}),vn=new Tn({props:{icon:uf}}),_o=new Tn({props:{icon:ra}}),Zr=new Tn({props:{icon:oa}}),{c(){m=gt("div"),v=gt("div"),w=gt("h2"),C=qe(A),k=me(),P=gt("div"),I=gt("div"),vi.c(),B=me(),V=gt("div"),j=gt("div"),Q=gt("p"),Q.textContent=et,it=me(),lt=gt("p"),ht=qe(_t),Bt=gt("span"),Zi(dt.$$.fragment),It=me(),Wt=gt("p"),Zt=qe(zt),$t=gt("span"),Zi(G.$$.fragment),Tt=me(),mt=gt("div"),Ot=gt("div"),wt=gt("h2"),Zi(ne.$$.fragment),ai=qe(" Health"),Re=me(),Je=gt("div"),We=gt("div"),Pe=gt("div"),be=gt("p"),be.textContent=Lt,Fe=me(),Me=gt("p"),Oi=qe(Ii),Vt=gt("span"),Zi(Ve.$$.fragment),rn=me(),ae=gt("p"),Oe=qe(Te),Jt=gt("span"),Zi(Xe.$$.fragment),mi=me(),gi=gt("div"),Dt=gt("h2"),Zi(F.$$.fragment),q=qe(" Financial"),J=me(),At=gt("div"),Ct=gt("p"),Ct.textContent=ee,ie=me(),Pt=gt("p"),ue=qe(Xt),de=gt("span"),Zi(di.$$.fragment),Ci=me(),Xi=gt("p"),Vi=qe(ri),Ei=gt("span"),Zi(tn.$$.fragment),ln=me(),hn=gt("div"),Be=gt("div"),Di=gt("h2"),Zi(Ji.$$.fragment),Un=qe(" CO2"),Vn=me(),Bn=gt("div"),xt=gt("p"),xt.textContent=St,Rt=me(),Ft=gt("p"),Ht=qe(Ut),Kt=gt("span"),Zi(qt.$$.fragment),se=me(),Yt=gt("p"),yi=qe(Ee),fe=gt("span"),Zi(li.$$.fragment),Ki=me(),ki=gt("div"),Qi=gt("h2"),Zi(vn.$$.fragment),Gn=qe(" Congestion"),xn=me(),gn=gt("div"),kn=gt("p"),kn.textContent=qo,qr=me(),yr=gt("p"),ca=qe(Zo),ws=gt("span"),Zi(_o.$$.fragment),sc=me(),go=gt("p"),Ho=qe(ua),Wo=gt("span"),Zi(Zr.$$.fragment),Ka=me(),Ts=gt("div"),yo=gt("div"),$o=gt("h2"),Es=qe(Ms),ha=me(),vo=gt("div"),xo=new rc(!1),this.h()},l(Se){m=yt(Se,"DIV",{class:!0});var ji=vt(m);v=yt(ji,"DIV",{class:!0});var wo=vt(v);w=yt(wo,"H2",{class:!0});var lc=vt(w);C=Ze(lc,A),lc.forEach(nt),k=_e(wo),P=yt(wo,"DIV",{class:!0});var da=vt(P);I=yt(da,"DIV",{class:!0});var cc=vt(I);vi.l(cc),cc.forEach(nt),B=_e(da),V=yt(da,"DIV",{class:!0});var Ja=vt(V);j=yt(Ja,"DIV",{class:!0});var To=vt(j);Q=yt(To,"P",{class:!0,"data-svelte-h":!0}),Ur(Q)!=="svelte-gpswxs"&&(Q.textContent=et),it=_e(To),lt=yt(To,"P",{class:!0});var Xo=vt(lt);ht=Ze(Xo,_t),Bt=yt(Xo,"SPAN",{style:!0});var fa=vt(Bt);Hi(dt.$$.fragment,fa),fa.forEach(nt),Xo.forEach(nt),It=_e(To),Wt=yt(To,"P",{class:!0});var Qa=vt(Wt);Zt=Ze(Qa,zt),$t=yt(Qa,"SPAN",{style:!0});var uc=vt($t);Hi(G.$$.fragment,uc),uc.forEach(nt),Qa.forEach(nt),To.forEach(nt),Ja.forEach(nt),da.forEach(nt),wo.forEach(nt),Tt=_e(ji),mt=yt(ji,"DIV",{class:!0});var pa=vt(mt);Ot=yt(pa,"DIV",{class:!0,style:!0});var As=vt(Ot);wt=yt(As,"H2",{class:!0});var jt=vt(wt);Hi(ne.$$.fragment,jt),ai=Ze(jt," Health"),jt.forEach(nt),Re=_e(As),Je=yt(As,"DIV",{class:!0});var Ae=vt(Je);We=yt(Ae,"DIV",{class:!0});var Mn=vt(We);Pe=yt(Mn,"DIV",{class:!0});var rt=vt(Pe);be=yt(rt,"P",{class:!0,"data-svelte-h":!0}),Ur(be)!=="svelte-svrreq"&&(be.textContent=Lt),Fe=_e(rt),Me=yt(rt,"P",{class:!0});var le=vt(Me);Oi=Ze(le,Ii),Vt=yt(le,"SPAN",{style:!0});var Mo=vt(Vt);Hi(Ve.$$.fragment,Mo),Mo.forEach(nt),le.forEach(nt),rn=_e(rt),ae=yt(rt,"P",{class:!0});var zr=vt(ae);Oe=Ze(zr,Te),Jt=yt(zr,"SPAN",{style:!0});var Cn=vt(Jt);Hi(Xe.$$.fragment,Cn),Cn.forEach(nt),zr.forEach(nt),rt.forEach(nt),Mn.forEach(nt),Ae.forEach(nt),As.forEach(nt),mi=_e(pa),gi=yt(pa,"DIV",{class:!0,style:!0});var vr=vt(gi);Dt=yt(vr,"H2",{class:!0});var hc=vt(Dt);Hi(F.$$.fragment,hc),q=Ze(hc," Financial"),hc.forEach(nt),J=_e(vr),At=yt(vr,"DIV",{class:!0});var lr=vt(At);Ct=yt(lr,"P",{class:!0,"data-svelte-h":!0}),Ur(Ct)!=="svelte-kfri9i"&&(Ct.textContent=ee),ie=_e(lr),Pt=yt(lr,"P",{class:!0});var ma=vt(Pt);ue=Ze(ma,Xt),de=yt(ma,"SPAN",{style:!0});var Iu=vt(de);Hi(di.$$.fragment,Iu),Iu.forEach(nt),ma.forEach(nt),Ci=_e(lr),Xi=yt(lr,"P",{class:!0});var Eo=vt(Xi);Vi=Ze(Eo,ri),Ei=yt(Eo,"SPAN",{style:!0});var re=vt(Ei);Hi(tn.$$.fragment,re),re.forEach(nt),Eo.forEach(nt),lr.forEach(nt),vr.forEach(nt),pa.forEach(nt),ln=_e(ji),hn=yt(ji,"DIV",{class:!0});var ci=vt(hn);Be=yt(ci,"DIV",{class:!0,style:!0});var xi=vt(Be);Di=yt(xi,"H2",{class:!0});var hr=vt(Di);Hi(Ji.$$.fragment,hr),Un=Ze(hr," CO2"),hr.forEach(nt),Vn=_e(xi),Bn=yt(xi,"DIV",{class:!0});var Lr=vt(Bn);xt=yt(Lr,"P",{class:!0,"data-svelte-h":!0}),Ur(xt)!=="svelte-ryza63"&&(xt.textContent=St),Rt=_e(Lr),Ft=yt(Lr,"P",{class:!0});var _i=vt(Ft);Ht=Ze(_i,Ut),Kt=yt(_i,"SPAN",{style:!0});var _a=vt(Kt);Hi(qt.$$.fragment,_a),_a.forEach(nt),_i.forEach(nt),se=_e(Lr),Yt=yt(Lr,"P",{class:!0});var Yo=vt(Yt);yi=Ze(Yo,Ee),fe=yt(Yo,"SPAN",{style:!0});var Is=vt(fe);Hi(li.$$.fragment,Is),Is.forEach(nt),Yo.forEach(nt),Lr.forEach(nt),xi.forEach(nt),Ki=_e(ci),ki=yt(ci,"DIV",{class:!0,style:!0});var er=vt(ki);Qi=yt(er,"H2",{class:!0});var bn=vt(Qi);Hi(vn.$$.fragment,bn),Gn=Ze(bn," Congestion"),bn.forEach(nt),xn=_e(er),gn=yt(er,"DIV",{class:!0});var Cs=vt(gn);kn=yt(Cs,"P",{class:!0,"data-svelte-h":!0}),Ur(kn)!=="svelte-1cnj7bt"&&(kn.textContent=qo),qr=_e(Cs),yr=yt(Cs,"P",{class:!0});var Ko=vt(yr);ca=Ze(Ko,Zo),ws=yt(Ko,"SPAN",{style:!0});var tl=vt(ws);Hi(_o.$$.fragment,tl),tl.forEach(nt),Ko.forEach(nt),sc=_e(Cs),go=yt(Cs,"P",{class:!0});var Jo=vt(go);Ho=Ze(Jo,ua),Wo=yt(Jo,"SPAN",{style:!0});var el=vt(Wo);Hi(Zr.$$.fragment,el),el.forEach(nt),Jo.forEach(nt),Cs.forEach(nt),er.forEach(nt),ci.forEach(nt),Ka=_e(ji),Ts=yt(ji,"DIV",{class:!0});var dc=vt(Ts);yo=yt(dc,"DIV",{class:!0});var Qo=vt(yo);$o=yt(Qo,"H2",{class:!0});var il=vt($o);Es=Ze(il,Ms),il.forEach(nt),ha=_e(Qo),vo=yt(Qo,"DIV",{class:!0});var ga=vt(vo);xo=oc(ga,!1),ga.forEach(nt),Qo.forEach(nt),dc.forEach(nt),ji.forEach(nt),this.h()},h(){tt(w,"class","dublin-header svelte-tnuu5p"),tt(I,"class","population-box item svelte-tnuu5p"),tt(Q,"class","label svelte-tnuu5p"),xe(Bt,"font-size","1.2rem"),tt(lt,"class","number-green svelte-tnuu5p"),xe($t,"font-size","1.2rem"),tt(Wt,"class","number svelte-tnuu5p"),tt(j,"class","text svelte-tnuu5p"),tt(V,"class","population-box item svelte-tnuu5p"),tt(P,"class","flex-items2 svelte-tnuu5p"),tt(v,"class","overall2 svelte-tnuu5p"),tt(wt,"class","dublin-header svelte-tnuu5p"),tt(be,"class","label svelte-tnuu5p"),xe(Vt,"font-size","1.2rem"),tt(Me,"class","number-green svelte-tnuu5p"),xe(Jt,"font-size","1.2rem"),tt(ae,"class","number svelte-tnuu5p"),tt(Pe,"class","text svelte-tnuu5p"),tt(We,"class","population-box item svelte-tnuu5p"),tt(Je,"class","flex-items svelte-tnuu5p"),tt(Ot,"class","overall2 svelte-tnuu5p"),xe(Ot,"background-color",f[0]=="prem_deaths"?"#a7c9de44":"white"),tt(Dt,"class","dublin-header svelte-tnuu5p"),tt(Ct,"class","label svelte-tnuu5p"),xe(de,"font-size","1.2rem"),tt(Pt,"class","number-green svelte-tnuu5p"),xe(Ei,"font-size","1.2rem"),tt(Xi,"class","number svelte-tnuu5p"),tt(At,"class","text svelte-tnuu5p"),tt(gi,"class","overall2 svelte-tnuu5p"),xe(gi,"background-color",f[0]=="health_exp"?"#a7c9de44":"white"),tt(mt,"class","flex-items2 svelte-tnuu5p"),tt(Di,"class","dublin-header svelte-tnuu5p"),tt(xt,"class","label svelte-tnuu5p"),xe(Kt,"font-size","1.2rem"),tt(Ft,"class","number-green svelte-tnuu5p"),xe(fe,"font-size","1.2rem"),tt(Yt,"class","number svelte-tnuu5p"),tt(Bn,"class","text svelte-tnuu5p"),tt(Be,"class","overall2 svelte-tnuu5p"),xe(Be,"background-color",f[0]=="co2"?"#a7c9de44":"white"),tt(Qi,"class","dublin-header svelte-tnuu5p"),tt(kn,"class","label svelte-tnuu5p"),xe(ws,"font-size","1.2rem"),tt(yr,"class","number-green svelte-tnuu5p"),xe(Wo,"font-size","1.2rem"),tt(go,"class","number svelte-tnuu5p"),tt(gn,"class","text svelte-tnuu5p"),tt(ki,"class","overall2 svelte-tnuu5p"),xe(ki,"background-color",f[0]=="cong"?"#a7c9de44":"white"),tt(hn,"class","flex-items2 svelte-tnuu5p"),tt($o,"class","dublin-header svelte-tnuu5p"),xo.a=null,tt(vo,"class","number2 svelte-tnuu5p"),tt(yo,"class","text2 svelte-tnuu5p"),tt(Ts,"class","overall2 svelte-tnuu5p"),tt(m,"class","container svelte-tnuu5p")},m(Se,ji){hi(Se,m,ji),W(m,v),W(v,w),W(w,C),W(v,k),W(v,P),W(P,I),vi.m(I,null),W(P,B),W(P,V),W(V,j),W(j,Q),W(j,it),W(j,lt),W(lt,ht),W(lt,Bt),Wi(dt,Bt,null),W(j,It),W(j,Wt),W(Wt,Zt),W(Wt,$t),Wi(G,$t,null),W(m,Tt),W(m,mt),W(mt,Ot),W(Ot,wt),Wi(ne,wt,null),W(wt,ai),W(Ot,Re),W(Ot,Je),W(Je,We),W(We,Pe),W(Pe,be),W(Pe,Fe),W(Pe,Me),W(Me,Oi),W(Me,Vt),Wi(Ve,Vt,null),W(Pe,rn),W(Pe,ae),W(ae,Oe),W(ae,Jt),Wi(Xe,Jt,null),W(mt,mi),W(mt,gi),W(gi,Dt),Wi(F,Dt,null),W(Dt,q),W(gi,J),W(gi,At),W(At,Ct),W(At,ie),W(At,Pt),W(Pt,ue),W(Pt,de),Wi(di,de,null),W(At,Ci),W(At,Xi),W(Xi,Vi),W(Xi,Ei),Wi(tn,Ei,null),W(m,ln),W(m,hn),W(hn,Be),W(Be,Di),Wi(Ji,Di,null),W(Di,Un),W(Be,Vn),W(Be,Bn),W(Bn,xt),W(Bn,Rt),W(Bn,Ft),W(Ft,Ht),W(Ft,Kt),Wi(qt,Kt,null),W(Bn,se),W(Bn,Yt),W(Yt,yi),W(Yt,fe),Wi(li,fe,null),W(hn,Ki),W(hn,ki),W(ki,Qi),Wi(vn,Qi,null),W(Qi,Gn),W(ki,xn),W(ki,gn),W(gn,kn),W(gn,qr),W(gn,yr),W(yr,ca),W(yr,ws),Wi(_o,ws,null),W(gn,sc),W(gn,go),W(go,Ho),W(go,Wo),Wi(Zr,Wo,null),W(m,Ka),W(m,Ts),W(Ts,yo),W(yo,$o),W($o,Es),W(yo,ha),W(yo,vo),xo.m(f[1],vo),zn=!0,Ss||(bo=[ur(v,"click",f[22]),ur(Ot,"click",f[23]),ur(gi,"click",f[24]),ur(Be,"click",f[25]),ur(ki,"click",f[26])],Ss=!0)},p(Se,[ji]){(!zn||ji&16384)&&A!==(A="Regional info: "+Se[14])&&Ai(C,A),ke===(ke=ac(Se))&&vi?vi.p(Se,ji):(vi.d(1),vi=ke(Se),vi&&(vi.c(),vi.m(I,null))),(!zn||ji&4096)&&_t!==(_t=Se[12]+" ")&&Ai(ht,_t),(!zn||ji&8192)&&zt!==(zt=Se[13]+" ")&&Ai(Zt,zt),(!zn||ji&2048)&&Ii!==(Ii=Se[11]+" ")&&Ai(Oi,Ii),(!zn||ji&1024)&&Te!==(Te=Se[10]+" ")&&Ai(Oe,Te),(!zn||ji&1)&&xe(Ot,"background-color",Se[0]=="prem_deaths"?"#a7c9de44":"white"),(!zn||ji&512)&&Xt!==(Xt=Se[9]+" ")&&Ai(ue,Xt),(!zn||ji&256)&&ri!==(ri=Se[8]+" ")&&Ai(Vi,ri),(!zn||ji&1)&&xe(gi,"background-color",Se[0]=="health_exp"?"#a7c9de44":"white"),(!zn||ji&64)&&Ut!==(Ut=Se[6]+" ")&&Ai(Ht,Ut),(!zn||ji&128)&&Ee!==(Ee=Se[7]+" ")&&Ai(yi,Ee),(!zn||ji&1)&&xe(Be,"background-color",Se[0]=="co2"?"#a7c9de44":"white"),(!zn||ji&16)&&Zo!==(Zo=Se[4]+" ")&&Ai(ca,Zo),(!zn||ji&32)&&ua!==(ua=Se[5]+" ")&&Ai(Ho,ua),(!zn||ji&1)&&xe(ki,"background-color",Se[0]=="cong"?"#a7c9de44":"white"),(!zn||ji&4)&&Ms!==(Ms="About "+Se[2])&&Ai(Es,Ms),(!zn||ji&2)&&xo.p(Se[1])},i(Se){zn||(wi(dt.$$.fragment,Se),wi(G.$$.fragment,Se),wi(ne.$$.fragment,Se),wi(Ve.$$.fragment,Se),wi(Xe.$$.fragment,Se),wi(F.$$.fragment,Se),wi(di.$$.fragment,Se),wi(tn.$$.fragment,Se),wi(Ji.$$.fragment,Se),wi(qt.$$.fragment,Se),wi(li.$$.fragment,Se),wi(vn.$$.fragment,Se),wi(_o.$$.fragment,Se),wi(Zr.$$.fragment,Se),zn=!0)},o(Se){Mi(dt.$$.fragment,Se),Mi(G.$$.fragment,Se),Mi(ne.$$.fragment,Se),Mi(Ve.$$.fragment,Se),Mi(Xe.$$.fragment,Se),Mi(F.$$.fragment,Se),Mi(di.$$.fragment,Se),Mi(tn.$$.fragment,Se),Mi(Ji.$$.fragment,Se),Mi(qt.$$.fragment,Se),Mi(li.$$.fragment,Se),Mi(vn.$$.fragment,Se),Mi(_o.$$.fragment,Se),Mi(Zr.$$.fragment,Se),zn=!1},d(Se){Se&&nt(m),vi.d(),$i(dt),$i(G),$i(ne),$i(Ve),$i(Xe),$i(F),$i(di),$i(tn),$i(Ji),$i(qt),$i(li),$i(vn),$i(_o),$i(Zr),Ss=!1,Mu(bo)}}}function AL(f,m,v){let w,A,C,k,P,I,B,V,j,Q,et,it,lt;_n(f,tc,Re=>v(20,et=Re)),_n(f,MT,Re=>v(21,it=Re)),_n(f,bg,Re=>v(14,lt=Re));let _t="",ht=la(",.0f"),Bt=la(".2f"),{cmode:dt}=m,{dmode:It}=m,Wt="",zt="",Zt="",$t="",G="Dublin",Tt;const mt=function(){v(0,_t=""),vs()},Ot=function(){v(0,_t="prem_deaths"),vs()},wt=function(){v(0,_t="health_exp"),vs()},ne=function(){v(0,_t="co2"),vs()},ai=function(){v(0,_t="cong")};return f.$$set=Re=>{"cmode"in Re&&v(15,dt=Re.cmode),"dmode"in Re&&v(16,It=Re.dmode)},f.$$.update=()=>{f.$$.dirty&2195456&&(console.log(dt),console.log(It),console.log("summzzz"),console.log(it)),f.$$.dirty&1081345&&(dt=="2016"?v(17,Zt="_16"):v(17,Zt=""),dt=="Change"?v(18,$t="delta_"):v(18,$t=""),et=="999999"&&(v(1,Wt='This data shows active travel based on the <a style="font-weight:bold"> Means of Travel data from the 2022 and 2016 census</a>, aggregated at local electoral level. Click on a <a style="font-weight:bold;color:#374c80">statistic</a> for information on how it was calculated. '),v(2,zt="this data")),_t=="prem_deaths"&&(v(1,Wt="The number of premature deaths averted this year by walking or cycling to work. For cycling, <a href='https://www.ncbi.nlm.nih.gov/pmc/articles/PMC10546027/#:~:text=Compared%20with%20non%2Dactive%20commuting,41%25%20lower%20risk%20of%20mortality.' target='_blank'>biking to work reduces the risk of premature death by 41% </a>. Walking 150 mins a week reduces this by <a href='https://bjsm.bmj.com/content/57/15/979' target='_blank'> 16%</a>. The risk of premature death between 30-70 years was estimated at 10%, which in any one year is 0.25%."),v(2,zt="premature deaths")),_t=="health_exp"&&(v(1,Wt="Total money saved this year by not commuting by car. Assumes each person cycling or walking would otherwise have a 10km commute 3.5 days a week. We use the <a href='https://www.tomtom.com/traffic-index/dublin-traffic/' target = '_blank'> calculator by TomTom</a> to estimate this cost at €401.50 per person."),v(2,zt="Fuel savings")),_t=="co2"&&(v(1,Wt="Annual CO2 saved this year by not commuting by car. Assumes each person cycling or walking would otherwise have a 10km commute 3.5 days a week and a <a href='https://climate.ec.europa.eu/eu-action/transport/road-transport-reducing-co2-emissions-vehicles/co2-emission-performance-standards-cars-and-vans_en' target = '_blank'> carbon footprint for a car as 95g CO2/km</a>"),v(2,zt="CO2 saved")),_t=="cong"&&(v(1,Wt="Total time (in years) saved by Dubliners this year by not sitting in traffic. Assumes a 10km commute 3.5 days a week. A study by Tomtom found that a daily 10km commute in Dublin resulted in <a href='https://www.tomtom.com/traffic-index/dublin-traffic/' target='_blank'> 158 hours lost to congestion. </a>"),v(2,zt="traffic avoided"))),f.$$.dirty&65536&&(It=="School or College"?v(19,Tt="School, college or childcare"):v(19,Tt=It)),f.$$.dirty&1048576&&v(3,G=et=="999999"?"Dublin":et.ED_ENGLISH),f.$$.dirty&4063232&&v(13,w=et=="999999"?Bt(100*it[$t+"On foot - "+Tt+"_pct"+Zt])+"%":Bt(100*et[$t+"On foot - "+Tt+"_pct"+Zt])+"%"),f.$$.dirty&4063232&&v(12,A=et=="999999"?Bt(100*it[$t+"Bicycle - "+Tt+"_pct"+Zt])+"%":Bt(100*et[$t+"Bicycle - "+Tt+"_pct"+Zt])+"%"),f.$$.dirty&4063232&&v(11,C=et=="999999"?ht(.001025*it[$t+"Bicycle - "+Tt+Zt]):Bt(.001025*et[$t+"Bicycle - "+Tt+Zt])),f.$$.dirty&4063232&&v(10,k=et=="999999"?ht(.001025*it[$t+"On foot - "+Tt+Zt]):Bt(.001025*et[$t+"On foot - "+Tt+Zt])),f.$$.dirty&4063232&&v(9,P=et=="999999"?"€"+ht(401.45*it[$t+"Bicycle - "+Tt+Zt]/1e6)+"m ":"€"+ht(401.45*et[$t+"Bicycle - "+Tt+Zt])),f.$$.dirty&4063232&&v(8,I=et=="999999"?"€"+ht(401.45*it[$t+"On foot - "+Tt+Zt]/1e6)+"m ":"€"+ht(401.45*et[$t+"On foot - "+Tt+Zt])),f.$$.dirty&4063232&&v(7,B=et=="999999"?ht(.3372*it[$t+"On foot - "+Tt+Zt]):ht(.3372*et[$t+"On foot - "+Tt+Zt])),f.$$.dirty&4063232&&v(6,V=et=="999999"?ht(.3372*it[$t+"Bicycle - "+Tt+Zt]):ht(.3372*et[$t+"Bicycle - "+Tt+Zt])),f.$$.dirty&4063232&&v(5,j=et=="999999"?ht(.00990867579908675*it[$t+"On foot - "+Tt+Zt]):Bt(.00990867579908675*et[$t+"On foot - "+Tt+Zt])),f.$$.dirty&4063232&&v(4,Q=et=="999999"?ht(.00990867579908675*it[$t+"Bicycle - "+Tt+Zt]):""+Bt(.00990867579908675*et[$t+"Bicycle - "+Tt+Zt]))},[_t,Wt,zt,G,Q,j,V,B,I,P,k,C,A,w,lt,dt,It,Zt,$t,Tt,et,it,mt,Ot,wt,ne,ai]}class IL extends jr{constructor(m){super(),Gr(this,m,AL,SL,Vr,{cmode:15,dmode:16})}}function W2(f,m,v){const w=f.slice();return w[12]=m[v],w}function $2(f,m,v){const w=f.slice();return w[12]=m[v],w}function X2(f){let m,v,w;return{c(){m=Qn("path"),this.h()},l(A){m=tr(A,"path",{d:!0,fill:!0,stroke:!0}),vt(m).forEach(nt),this.h()},h(){tt(m,"d",v=f[3](f[12])),tt(m,"fill",w=f[1](f[12].data[0])),tt(m,"stroke","white")},m(A,C){hi(A,m,C)},p(A,C){C&1&&v!==(v=A[3](A[12]))&&tt(m,"d",v),C&1&&w!==(w=A[1](A[12].data[0]))&&tt(m,"fill",w)},d(A){A&&nt(m)}}}function Y2(f){let m,v=f[2](f[12])+"",w,A,C;return{c(){m=Qn("text"),w=qe(v),this.h()},l(k){m=tr(k,"text",{transform:!0,x:!0,dy:!0,"text-anchor":!0,"font-size":!0,fill:!0});var P=vt(m);w=Ze(P,v),P.forEach(nt),this.h()},h(){tt(m,"transform",A=`translate(${f[4].centroid(f[12])})`),tt(m,"x",0),tt(m,"dy","0.35rem"),tt(m,"text-anchor",C=(K2(f[12])<Math.PI,"middle")),tt(m,"font-size","16px"),tt(m,"fill","#fff")},m(k,P){hi(k,m,P),W(m,w)},p(k,P){P&1&&v!==(v=k[2](k[12])+"")&&Ai(w,v),P&1&&A!==(A=`translate(${k[4].centroid(k[12])})`)&&tt(m,"transform",A),P&1&&C!==(C=(K2(k[12])<Math.PI,"middle"))&&tt(m,"text-anchor",C)},d(k){k&&nt(m)}}}function CL(f){let m,v,w,A=Yn(f[0]),C=[];for(let I=0;I<A.length;I+=1)C[I]=X2($2(f,A,I));let k=Yn(f[0]),P=[];for(let I=0;I<k.length;I+=1)P[I]=Y2(W2(f,k,I));return{c(){m=Qn("svg"),v=Qn("g");for(let I=0;I<C.length;I+=1)C[I].c();w=Go();for(let I=0;I<P.length;I+=1)P[I].c();this.h()},l(I){m=tr(I,"svg",{width:!0,height:!0,viewBox:!0});var B=vt(m);v=tr(B,"g",{class:!0});var V=vt(v);for(let j=0;j<C.length;j+=1)C[j].l(V);w=Go();for(let j=0;j<P.length;j+=1)P[j].l(V);V.forEach(nt),B.forEach(nt),this.h()},h(){tt(v,"class","chart-inner svelte-pann8v"),tt(m,"width",Zd),tt(m,"height",Hd),tt(m,"viewBox",-Zd/2+", "+-Hd/2+", "+Zd+", "+Hd),xe(m,"max-width","100%"),xe(m,"height","auto")},m(I,B){hi(I,m,B),W(m,v);for(let V=0;V<C.length;V+=1)C[V]&&C[V].m(v,null);W(v,w);for(let V=0;V<P.length;V+=1)P[V]&&P[V].m(v,null)},p(I,[B]){if(B&11){A=Yn(I[0]);let V;for(V=0;V<A.length;V+=1){const j=$2(I,A,V);C[V]?C[V].p(j,B):(C[V]=X2(j),C[V].c(),C[V].m(v,w))}for(;V<C.length;V+=1)C[V].d(1);C.length=A.length}if(B&21){k=Yn(I[0]);let V;for(V=0;V<k.length;V+=1){const j=W2(I,k,V);P[V]?P[V].p(j,B):(P[V]=Y2(j),P[V].c(),P[V].m(v,null))}for(;V<P.length;V+=1)P[V].d(1);P.length=k.length}},i:sr,o:sr,d(I){I&&nt(m),mo(C,I),mo(P,I)}}}let Zd=250,Hd=250,DL=0;function K2(f){return f.startAngle+(f.endAngle-f.startAngle)/2}function PL(f,m,v){let{data:w}=m,A={},C,k,P,I=kT().domain(["AUTOMOBILE_trips","PUBLIC_trips","CYCLING_trips","ON FOOT_trips"]).range(["#e9547a","#ff912b","#955196","#374c80"]),B=Math.min(Zd,Hd)/2-DL;const V=Kz().sort(null).value(it=>it[1]);function j(it){let lt=it.data[1]/P*100;return lt>4?lt.toFixed(0)+"%":""}const Q=U2().innerRadius(B*.6).outerRadius(B*.9),et=U2().innerRadius(B*.75).outerRadius(B*.75);return f.$$set=it=>{"data"in it&&v(5,w=it.data)},f.$$.update=()=>{if(f.$$.dirty&480){let it=Object.keys(w);v(7,k=[]),P=0,it.forEach(function(ht){ht.includes("trips")&~ht.includes("TOTAL")&&(k.push(ht),P+=w[ht],v(6,A[ht]=w[ht],A))});const _t=Object.entries(A).sort((ht,Bt)=>Bt[1]-ht[1]);v(6,A=Object.fromEntries(_t)),v(0,C=V(Object.entries(A)))}},[C,I,j,Q,et,w,A,k]}class kL extends jr{constructor(m){super(),Gr(this,m,PL,CL,Vr,{data:5})}}function zL(f){let m,v,w="Region",A,C,k,P,I,B,V="&#9204;",j,Q,et,it,lt=f[9]+" ",_t,ht,Bt,dt,It,Wt=f[10]+" ",zt,Zt,$t,G,Tt,mt=f[8]+" ",Ot,wt,ne,ai,Re,Je=f[7]+" ",We,Pe,be,Lt;return Bt=new Tn({props:{icon:ra}}),$t=new Tn({props:{icon:oa}}),ne=new Tn({props:{icon:uf}}),be=new Tn({props:{icon:wg}}),{c(){m=gt("div"),v=gt("p"),v.textContent=w,A=me(),C=gt("p"),k=qe(f[11]),P=me(),I=gt("p"),B=new rc(!1),j=me(),Q=gt("br"),et=me(),it=gt("p"),_t=qe(lt),ht=gt("span"),Zi(Bt.$$.fragment),dt=me(),It=gt("p"),zt=qe(Wt),Zt=gt("span"),Zi($t.$$.fragment),G=me(),Tt=gt("p"),Ot=qe(mt),wt=gt("span"),Zi(ne.$$.fragment),ai=me(),Re=gt("p"),We=qe(Je),Pe=gt("span"),Zi(be.$$.fragment),this.h()},l(Fe){m=yt(Fe,"DIV",{class:!0});var Me=vt(m);v=yt(Me,"P",{class:!0,"data-svelte-h":!0}),Ur(v)!=="svelte-vv3ej7"&&(v.textContent=w),A=_e(Me),C=yt(Me,"P",{class:!0});var Ii=vt(C);k=Ze(Ii,f[11]),Ii.forEach(nt),P=_e(Me),I=yt(Me,"P",{class:!0});var Oi=vt(I);B=oc(Oi,!1),Oi.forEach(nt),j=_e(Me),Q=yt(Me,"BR",{}),et=_e(Me),it=yt(Me,"P",{class:!0,style:!0});var Vt=vt(it);_t=Ze(Vt,lt),ht=yt(Vt,"SPAN",{style:!0});var Ve=vt(ht);Hi(Bt.$$.fragment,Ve),Ve.forEach(nt),Vt.forEach(nt),dt=_e(Me),It=yt(Me,"P",{class:!0,style:!0});var rn=vt(It);zt=Ze(rn,Wt),Zt=yt(rn,"SPAN",{style:!0});var ae=vt(Zt);Hi($t.$$.fragment,ae),ae.forEach(nt),rn.forEach(nt),G=_e(Me),Tt=yt(Me,"P",{class:!0,style:!0});var Te=vt(Tt);Ot=Ze(Te,mt),wt=yt(Te,"SPAN",{style:!0});var Oe=vt(wt);Hi(ne.$$.fragment,Oe),Oe.forEach(nt),Te.forEach(nt),ai=_e(Me),Re=yt(Me,"P",{class:!0,style:!0});var Jt=vt(Re);We=Ze(Jt,Je),Pe=yt(Jt,"SPAN",{style:!0});var Xe=vt(Pe);Hi(be.$$.fragment,Xe),Xe.forEach(nt),Jt.forEach(nt),Me.forEach(nt),this.h()},h(){tt(v,"class","label svelte-1p3kfkh"),tt(C,"class","loc svelte-1p3kfkh"),B.a=null,tt(I,"class","label svelte-1p3kfkh"),xe(ht,"font-size","1.2rem"),tt(it,"class","number svelte-1p3kfkh"),xe(it,"color","#955196"),xe(Zt,"font-size","1.2rem"),tt(It,"class","number svelte-1p3kfkh"),xe(It,"color","#374c80"),xe(wt,"font-size","1.2rem"),tt(Tt,"class","number svelte-1p3kfkh"),xe(Tt,"color","#e9547a"),xe(Pe,"font-size","1.2rem"),tt(Re,"class","number svelte-1p3kfkh"),xe(Re,"color","#ff912b"),tt(m,"class","text svelte-1p3kfkh")},m(Fe,Me){hi(Fe,m,Me),W(m,v),W(m,A),W(m,C),W(C,k),W(m,P),W(m,I),B.m(V,I),W(m,j),W(m,Q),W(m,et),W(m,it),W(it,_t),W(it,ht),Wi(Bt,ht,null),W(m,dt),W(m,It),W(It,zt),W(It,Zt),Wi($t,Zt,null),W(m,G),W(m,Tt),W(Tt,Ot),W(Tt,wt),Wi(ne,wt,null),W(m,ai),W(m,Re),W(Re,We),W(Re,Pe),Wi(be,Pe,null),Lt=!0},p(Fe,Me){(!Lt||Me&2048)&&Ai(k,Fe[11]),(!Lt||Me&512)&&lt!==(lt=Fe[9]+" ")&&Ai(_t,lt),(!Lt||Me&1024)&&Wt!==(Wt=Fe[10]+" ")&&Ai(zt,Wt),(!Lt||Me&256)&&mt!==(mt=Fe[8]+" ")&&Ai(Ot,mt),(!Lt||Me&128)&&Je!==(Je=Fe[7]+" ")&&Ai(We,Je)},i(Fe){Lt||(wi(Bt.$$.fragment,Fe),wi($t.$$.fragment,Fe),wi(ne.$$.fragment,Fe),wi(be.$$.fragment,Fe),Lt=!0)},o(Fe){Mi(Bt.$$.fragment,Fe),Mi($t.$$.fragment,Fe),Mi(ne.$$.fragment,Fe),Mi(be.$$.fragment,Fe),Lt=!1},d(Fe){Fe&&nt(m),$i(Bt),$i($t),$i(ne),$i(be)}}}function LL(f){let m,v,w="Region",A,C,k,P,I,B,V,j,Q,et=f[9]+" ",it,lt,_t,ht,Bt,dt=f[10]+" ",It,Wt,zt,Zt,$t,G=f[8]+" ",Tt,mt,Ot,wt,ne,ai=f[7]+" ",Re,Je,We,Pe;return _t=new Tn({props:{icon:ra}}),zt=new Tn({props:{icon:oa}}),Ot=new Tn({props:{icon:uf}}),We=new Tn({props:{icon:wg}}),{c(){m=gt("div"),v=gt("p"),v.textContent=w,A=me(),C=gt("p"),k=qe(f[11]),P=me(),I=gt("p"),B=me(),V=gt("br"),j=me(),Q=gt("p"),it=qe(et),lt=gt("span"),Zi(_t.$$.fragment),ht=me(),Bt=gt("p"),It=qe(dt),Wt=gt("span"),Zi(zt.$$.fragment),Zt=me(),$t=gt("p"),Tt=qe(G),mt=gt("span"),Zi(Ot.$$.fragment),wt=me(),ne=gt("p"),Re=qe(ai),Je=gt("span"),Zi(We.$$.fragment),this.h()},l(be){m=yt(be,"DIV",{class:!0});var Lt=vt(m);v=yt(Lt,"P",{class:!0,"data-svelte-h":!0}),Ur(v)!=="svelte-vv3ej7"&&(v.textContent=w),A=_e(Lt),C=yt(Lt,"P",{class:!0});var Fe=vt(C);k=Ze(Fe,f[11]),Fe.forEach(nt),P=_e(Lt),I=yt(Lt,"P",{class:!0}),vt(I).forEach(nt),B=_e(Lt),V=yt(Lt,"BR",{}),j=_e(Lt),Q=yt(Lt,"P",{class:!0,style:!0});var Me=vt(Q);it=Ze(Me,et),lt=yt(Me,"SPAN",{style:!0});var Ii=vt(lt);Hi(_t.$$.fragment,Ii),Ii.forEach(nt),Me.forEach(nt),ht=_e(Lt),Bt=yt(Lt,"P",{class:!0,style:!0});var Oi=vt(Bt);It=Ze(Oi,dt),Wt=yt(Oi,"SPAN",{style:!0});var Vt=vt(Wt);Hi(zt.$$.fragment,Vt),Vt.forEach(nt),Oi.forEach(nt),Zt=_e(Lt),$t=yt(Lt,"P",{class:!0,style:!0});var Ve=vt($t);Tt=Ze(Ve,G),mt=yt(Ve,"SPAN",{style:!0});var rn=vt(mt);Hi(Ot.$$.fragment,rn),rn.forEach(nt),Ve.forEach(nt),wt=_e(Lt),ne=yt(Lt,"P",{class:!0,style:!0});var ae=vt(ne);Re=Ze(ae,ai),Je=yt(ae,"SPAN",{style:!0});var Te=vt(Je);Hi(We.$$.fragment,Te),Te.forEach(nt),ae.forEach(nt),Lt.forEach(nt),this.h()},h(){tt(v,"class","label svelte-1p3kfkh"),tt(C,"class","loc svelte-1p3kfkh"),tt(I,"class","label svelte-1p3kfkh"),xe(lt,"font-size","1.2rem"),tt(Q,"class","number svelte-1p3kfkh"),xe(Q,"color","#955196"),xe(Wt,"font-size","1.2rem"),tt(Bt,"class","number svelte-1p3kfkh"),xe(Bt,"color","#374c80"),xe(mt,"font-size","1.2rem"),tt($t,"class","number svelte-1p3kfkh"),xe($t,"color","#e9547a"),xe(Je,"font-size","1.2rem"),tt(ne,"class","number svelte-1p3kfkh"),xe(ne,"color","#ff912b"),tt(m,"class","text svelte-1p3kfkh")},m(be,Lt){hi(be,m,Lt),W(m,v),W(m,A),W(m,C),W(C,k),W(m,P),W(m,I),W(m,B),W(m,V),W(m,j),W(m,Q),W(Q,it),W(Q,lt),Wi(_t,lt,null),W(m,ht),W(m,Bt),W(Bt,It),W(Bt,Wt),Wi(zt,Wt,null),W(m,Zt),W(m,$t),W($t,Tt),W($t,mt),Wi(Ot,mt,null),W(m,wt),W(m,ne),W(ne,Re),W(ne,Je),Wi(We,Je,null),Pe=!0},p(be,Lt){(!Pe||Lt&2048)&&Ai(k,be[11]),(!Pe||Lt&512)&&et!==(et=be[9]+" ")&&Ai(it,et),(!Pe||Lt&1024)&&dt!==(dt=be[10]+" ")&&Ai(It,dt),(!Pe||Lt&256)&&G!==(G=be[8]+" ")&&Ai(Tt,G),(!Pe||Lt&128)&&ai!==(ai=be[7]+" ")&&Ai(Re,ai)},i(be){Pe||(wi(_t.$$.fragment,be),wi(zt.$$.fragment,be),wi(Ot.$$.fragment,be),wi(We.$$.fragment,be),Pe=!0)},o(be){Mi(_t.$$.fragment,be),Mi(zt.$$.fragment,be),Mi(Ot.$$.fragment,be),Mi(We.$$.fragment,be),Pe=!1},d(be){be&&nt(m),$i(_t),$i(zt),$i(Ot),$i(We)}}}function RL(f){let m,v,w,A="Regional information: 2023",C,k,P,I,B,V,j,Q,et,it,lt,_t,ht,Bt,dt,It,Wt,zt,Zt,$t="Annual CO2 saved (Tonnes)",G,Tt,mt=f[5]+" ",Ot,wt,ne,ai,Re,Je=f[6]+" ",We,Pe,be,Lt,Fe,Me,Ii,Oi,Vt,Ve,rn,ae="Annual emissions (Tonnes)",Te,Oe,Jt=f[4]+" ",Xe,mi,gi,Dt,F,q=f[3]+" ",J,At,Ct,ee,ie,Pt,Xt,ue="About "+f[2],de,di,Ci,Xi,ri,Vi,Ei;const tn=[LL,zL],ln=[];function hn(Be,Di){return Be[11]==="Dublin"?0:1}return B=hn(f),V=ln[B]=tn[B](f),it=new kL({props:{data:f[12]}}),dt=new Tn({props:{icon:cg}}),ne=new Tn({props:{icon:ra}}),be=new Tn({props:{icon:oa}}),Ii=new Tn({props:{icon:cg}}),gi=new Tn({props:{icon:uf}}),Ct=new Tn({props:{icon:wg}}),{c(){m=gt("div"),v=gt("div"),w=gt("h2"),C=qe(A),k=me(),P=gt("div"),I=gt("div"),V.c(),j=me(),Q=gt("div"),et=gt("div"),Zi(it.$$.fragment),lt=me(),_t=gt("div"),ht=gt("div"),Bt=gt("h2"),Zi(dt.$$.fragment),It=qe(" CO2"),Wt=me(),zt=gt("div"),Zt=gt("p"),Zt.textContent=$t,G=me(),Tt=gt("p"),Ot=qe(mt),wt=gt("span"),Zi(ne.$$.fragment),ai=me(),Re=gt("p"),We=qe(Je),Pe=gt("span"),Zi(be.$$.fragment),Lt=me(),Fe=gt("div"),Me=gt("h2"),Zi(Ii.$$.fragment),Oi=qe(" Emissions"),Vt=me(),Ve=gt("div"),rn=gt("p"),rn.textContent=ae,Te=me(),Oe=gt("p"),Xe=qe(Jt),mi=gt("span"),Zi(gi.$$.fragment),Dt=me(),F=gt("p"),J=qe(q),At=gt("span"),Zi(Ct.$$.fragment),ee=me(),ie=gt("div"),Pt=gt("div"),Xt=gt("h2"),de=qe(ue),di=me(),Ci=gt("div"),Xi=new rc(!1),this.h()},l(Be){m=yt(Be,"DIV",{class:!0});var Di=vt(m);v=yt(Di,"DIV",{class:!0,style:!0});var Ji=vt(v);w=yt(Ji,"H2",{class:!0});var Un=vt(w);C=Ze(Un,A),Un.forEach(nt),k=_e(Ji),P=yt(Ji,"DIV",{class:!0});var Vn=vt(P);I=yt(Vn,"DIV",{class:!0});var Bn=vt(I);V.l(Bn),Bn.forEach(nt),j=_e(Vn),Q=yt(Vn,"DIV",{class:!0});var xt=vt(Q);et=yt(xt,"DIV",{class:!0,style:!0});var St=vt(et);Hi(it.$$.fragment,St),St.forEach(nt),xt.forEach(nt),Vn.forEach(nt),Ji.forEach(nt),lt=_e(Di),_t=yt(Di,"DIV",{class:!0});var Rt=vt(_t);ht=yt(Rt,"DIV",{class:!0,style:!0});var Ft=vt(ht);Bt=yt(Ft,"H2",{class:!0});var Ut=vt(Bt);Hi(dt.$$.fragment,Ut),It=Ze(Ut," CO2"),Ut.forEach(nt),Wt=_e(Ft),zt=yt(Ft,"DIV",{class:!0});var Ht=vt(zt);Zt=yt(Ht,"P",{class:!0,"data-svelte-h":!0}),Ur(Zt)!=="svelte-ryza63"&&(Zt.textContent=$t),G=_e(Ht),Tt=yt(Ht,"P",{class:!0});var Kt=vt(Tt);Ot=Ze(Kt,mt),wt=yt(Kt,"SPAN",{style:!0});var qt=vt(wt);Hi(ne.$$.fragment,qt),qt.forEach(nt),Kt.forEach(nt),ai=_e(Ht),Re=yt(Ht,"P",{class:!0});var se=vt(Re);We=Ze(se,Je),Pe=yt(se,"SPAN",{style:!0});var Yt=vt(Pe);Hi(be.$$.fragment,Yt),Yt.forEach(nt),se.forEach(nt),Ht.forEach(nt),Ft.forEach(nt),Lt=_e(Rt),Fe=yt(Rt,"DIV",{class:!0,style:!0});var Ee=vt(Fe);Me=yt(Ee,"H2",{class:!0});var yi=vt(Me);Hi(Ii.$$.fragment,yi),Oi=Ze(yi," Emissions"),yi.forEach(nt),Vt=_e(Ee),Ve=yt(Ee,"DIV",{class:!0});var fe=vt(Ve);rn=yt(fe,"P",{class:!0,"data-svelte-h":!0}),Ur(rn)!=="svelte-1fztbli"&&(rn.textContent=ae),Te=_e(fe),Oe=yt(fe,"P",{class:!0,style:!0});var li=vt(Oe);Xe=Ze(li,Jt),mi=yt(li,"SPAN",{style:!0});var Ki=vt(mi);Hi(gi.$$.fragment,Ki),Ki.forEach(nt),li.forEach(nt),Dt=_e(fe),F=yt(fe,"P",{class:!0,style:!0});var ki=vt(F);J=Ze(ki,q),At=yt(ki,"SPAN",{style:!0});var Qi=vt(At);Hi(Ct.$$.fragment,Qi),Qi.forEach(nt),ki.forEach(nt),fe.forEach(nt),Ee.forEach(nt),Rt.forEach(nt),ee=_e(Di),ie=yt(Di,"DIV",{class:!0});var vn=vt(ie);Pt=yt(vn,"DIV",{class:!0});var Gn=vt(Pt);Xt=yt(Gn,"H2",{class:!0});var xn=vt(Xt);de=Ze(xn,ue),xn.forEach(nt),di=_e(Gn),Ci=yt(Gn,"DIV",{class:!0});var gn=vt(Ci);Xi=oc(gn,!1),gn.forEach(nt),Gn.forEach(nt),vn.forEach(nt),Di.forEach(nt),this.h()},h(){tt(w,"class","dublin-header svelte-1p3kfkh"),tt(I,"class","a1 svelte-1p3kfkh"),tt(et,"class","text svelte-1p3kfkh"),xe(et,"padding-left","0px"),tt(Q,"class","a2 svelte-1p3kfkh"),tt(P,"class","flex-items3 svelte-1p3kfkh"),tt(v,"class","overall2 svelte-1p3kfkh"),xe(v,"min-width","300px"),tt(Bt,"class","dublin-header svelte-1p3kfkh"),tt(Zt,"class","label svelte-1p3kfkh"),xe(wt,"font-size","1.2rem"),tt(Tt,"class","number-green svelte-1p3kfkh"),xe(Pe,"font-size","1.2rem"),tt(Re,"class","number svelte-1p3kfkh"),tt(zt,"class","text svelte-1p3kfkh"),tt(ht,"class","overall2 svelte-1p3kfkh"),xe(ht,"background-color",f[0]=="co2"?"#a7c9de44":"white"),tt(Me,"class","dublin-header svelte-1p3kfkh"),tt(rn,"class","label svelte-1p3kfkh"),xe(mi,"font-size","1.2rem"),tt(Oe,"class","number-green svelte-1p3kfkh"),xe(Oe,"color","#e9547a"),xe(At,"font-size","1.2rem"),tt(F,"class","number svelte-1p3kfkh"),xe(F,"color","#ff912b"),tt(Ve,"class","text svelte-1p3kfkh"),tt(Fe,"class","overall2 svelte-1p3kfkh"),xe(Fe,"background-color",f[0]=="cong"?"#a7c9de44":"white"),tt(_t,"class","flex-items2 svelte-1p3kfkh"),tt(Xt,"class","dublin-header svelte-1p3kfkh"),Xi.a=null,tt(Ci,"class","number2 svelte-1p3kfkh"),tt(Pt,"class","text2 svelte-1p3kfkh"),tt(ie,"class","overall2 svelte-1p3kfkh"),tt(m,"class","container svelte-1p3kfkh")},m(Be,Di){hi(Be,m,Di),W(m,v),W(v,w),W(w,C),W(v,k),W(v,P),W(P,I),ln[B].m(I,null),W(P,j),W(P,Q),W(Q,et),Wi(it,et,null),W(m,lt),W(m,_t),W(_t,ht),W(ht,Bt),Wi(dt,Bt,null),W(Bt,It),W(ht,Wt),W(ht,zt),W(zt,Zt),W(zt,G),W(zt,Tt),W(Tt,Ot),W(Tt,wt),Wi(ne,wt,null),W(zt,ai),W(zt,Re),W(Re,We),W(Re,Pe),Wi(be,Pe,null),W(_t,Lt),W(_t,Fe),W(Fe,Me),Wi(Ii,Me,null),W(Me,Oi),W(Fe,Vt),W(Fe,Ve),W(Ve,rn),W(Ve,Te),W(Ve,Oe),W(Oe,Xe),W(Oe,mi),Wi(gi,mi,null),W(Ve,Dt),W(Ve,F),W(F,J),W(F,At),Wi(Ct,At,null),W(m,ee),W(m,ie),W(ie,Pt),W(Pt,Xt),W(Xt,de),W(Pt,di),W(Pt,Ci),Xi.m(f[1],Ci),ri=!0,Vi||(Ei=[ur(v,"click",f[15]),ur(ht,"click",f[16]),ur(Fe,"click",f[17])],Vi=!0)},p(Be,[Di]){let Ji=B;B=hn(Be),B===Ji?ln[B].p(Be,Di):(of(),Mi(ln[Ji],1,1,()=>{ln[Ji]=null}),sf(),V=ln[B],V?V.p(Be,Di):(V=ln[B]=tn[B](Be),V.c()),wi(V,1),V.m(I,null));const Un={};Di&4096&&(Un.data=Be[12]),it.$set(Un),(!ri||Di&32)&&mt!==(mt=Be[5]+" ")&&Ai(Ot,mt),(!ri||Di&64)&&Je!==(Je=Be[6]+" ")&&Ai(We,Je),(!ri||Di&1)&&xe(ht,"background-color",Be[0]=="co2"?"#a7c9de44":"white"),(!ri||Di&16)&&Jt!==(Jt=Be[4]+" ")&&Ai(Xe,Jt),(!ri||Di&8)&&q!==(q=Be[3]+" ")&&Ai(J,q),(!ri||Di&1)&&xe(Fe,"background-color",Be[0]=="cong"?"#a7c9de44":"white"),(!ri||Di&4)&&ue!==(ue="About "+Be[2])&&Ai(de,ue),(!ri||Di&2)&&Xi.p(Be[1])},i(Be){ri||(wi(V),wi(it.$$.fragment,Be),wi(dt.$$.fragment,Be),wi(ne.$$.fragment,Be),wi(be.$$.fragment,Be),wi(Ii.$$.fragment,Be),wi(gi.$$.fragment,Be),wi(Ct.$$.fragment,Be),ri=!0)},o(Be){Mi(V),Mi(it.$$.fragment,Be),Mi(dt.$$.fragment,Be),Mi(ne.$$.fragment,Be),Mi(be.$$.fragment,Be),Mi(Ii.$$.fragment,Be),Mi(gi.$$.fragment,Be),Mi(Ct.$$.fragment,Be),ri=!1},d(Be){Be&&nt(m),ln[B].d(),$i(it),$i(dt),$i(ne),$i(be),$i(Ii),$i(gi),$i(Ct),Vi=!1,Mu(Ei)}}}function OL(f,m,v){let w,A,C,k,P,I,B,V,j,Q,et,it;_n(f,tc,$t=>v(13,et=$t)),_n(f,ET,$t=>v(14,it=$t));let lt="",_t=la(",.0f"),ht=la(".2f"),Bt={"dublin-bay-north":"Dublin Bay North","dublin-bay-south":"Dublin Bay South","dublin-central":"Dublin Central","dublin-fingal-east":"Dublin Fingal East","dublin-fingal-west":"Dublin Fingal West","dublin-mid-west":"Dublin Mid West","dublin-north-west":"Dublin North West","dublin-rathdown":"Dublin Rathdown","dublin-south-central":"Dublin South Central","dublin-south-west":"Dublin South West","dublin-west":"Dublin West","dún-laoghaire":"Dún Laoghaire"},dt="",It="this data";const Wt=function(){v(0,lt=""),vs()},zt=function(){v(0,lt="co2"),vs()},Zt=function(){v(0,lt="cong"),vs()};return f.$$.update=()=>{f.$$.dirty&8193&&(console.log(et),et=="999999"&&(v(1,dt=`This view shows active travel data based on <a style="font-weight:bold">Google's modal split data of Dublin for 2023</a>, aggregated at electoral district level. This modal split data counts all trips within the Dublin boundary, in addition to those leaving and entering the Dublin boundary. Click on a <a style="font-weight:bold;color:#516dae">statistic</a> for information on how it was calculated. `),v(2,It="this data")),lt=="prem_deaths"&&(v(1,dt="The total number of potential premature deaths averted by walking or cycling. For cycling, <a href='https://www.ncbi.nlm.nih.gov/pmc/articles/PMC10546027/#:~:text=Compared%20with%20non%2Dactive%20commuting,41%25%20lower%20risk%20of%20mortality.' target='_blank'>biking to work reduces the risk of premature death by 41% </a>. Walking 150 mins a week reduces this by <a href='https://bjsm.bmj.com/content/57/15/979' target='_blank'> 16%</a>. The risk of premature death between 30-70 years was estimated at 10%."),v(2,It="premature deaths")),lt=="health_exp"&&(v(1,dt=`This view shows active travel data based on <a style="font-weight:bold">Google's modal split data of Dublin for 2023</a>, aggregated at electoral district level. Click on a <a style="font-weight:bold;color:#516dae">statistic</a> for information on how it was calculated. `),v(2,It="")),lt=="co2"&&(v(1,dt="Annual CO2 saved in a year by not taking a car. Assumes each person cycling or walking would otherwise have used a car. The equivalent automotive emissions per journey in Dublin has been calculated by Google. "),v(2,It="CO2 saved")),lt=="cong"&&(v(1,dt="The annual CO2 emissions in each region by public transport (bus) and car has been calculated by Google. Note this takes into account all trips within and across all boundaries."),v(2,It="CO2 emissions"))),f.$$.dirty&24576&&v(12,w=et=="999999"?it:et),f.$$.dirty&8192&&v(11,A=et=="999999"?"Dublin":Bt[et.ENG_NAME_VALUE]),f.$$.dirty&24576&&v(10,C=et=="999999"?ht(100*it["ON FOOT_trips"]/it.TOTAL_trips)+"%":ht(100*et.walk_pct)+"%"),f.$$.dirty&24576&&v(9,k=et=="999999"?ht(100*it.CYCLING_trips/it.TOTAL_trips)+"%":ht(100*et.cycle_pct)+"%"),f.$$.dirty&24576&&v(8,P=et=="999999"?ht(100*it.AUTOMOBILE_trips/it.TOTAL_trips)+"%":ht(100*et.AUTOMOBILE_trips/et.TOTAL_trips)+"%"),f.$$.dirty&24576&&v(7,I=et=="999999"?ht(100*it.PUBLIC_trips/it.TOTAL_trips)+"%":ht(100*et.PUBLIC_trips/et.TOTAL_trips)+"%"),f.$$.dirty&24576&&v(6,B=et=="999999"?_t(.00141941108770439*it["ON FOOT_trips"]):_t(.00141941108770439*et["ON FOOT_trips"])),f.$$.dirty&24576&&v(5,V=et=="999999"?_t(.00141941108770439*it.CYCLING_trips):_t(.00141941108770439*et.CYCLING_trips)),f.$$.dirty&24576&&v(4,j=et=="999999"?_t(it.AUTOMOBILE_gpc_co2e_tons):_t(et.AUTOMOBILE_gpc_co2e_tons)),f.$$.dirty&24576&&v(3,Q=et=="999999"?_t(it.PUBLIC_gpc_co2e_tons):_t(et.PUBLIC_gpc_co2e_tons))},[lt,dt,It,Q,j,V,B,I,P,k,C,A,w,et,it,Wt,zt,Zt]}class BL extends jr{constructor(m){super(),Gr(this,m,OL,RL,Vr,{})}}function J2(f,m,v){const w=f.slice();return w[17]=m[v],w}function Q2(f,m,v){const w=f.slice();return w[17]=m[v],w}function tT(f){let m,v,w,A,C,k,P,I,B,V,j,Q,et=Yn(f[7].ticks(5)),it=[];for(let ht=0;ht<et.length;ht+=1)it[ht]=eT(Q2(f,et,ht));let lt=Yn(f[8].ticks(4)),_t=[];for(let ht=0;ht<lt.length;ht+=1)_t[ht]=nT(J2(f,lt,ht));return{c(){m=gt("div"),v=Qn("svg"),w=Qn("g"),A=Qn("line");for(let ht=0;ht<it.length;ht+=1)it[ht].c();I=Qn("g");for(let ht=0;ht<_t.length;ht+=1)_t[ht].c();V=Qn("path"),this.h()},l(ht){m=yt(ht,"DIV",{});var Bt=vt(m);v=tr(Bt,"svg",{width:!0,height:!0});var dt=vt(v);w=tr(dt,"g",{transform:!0});var It=vt(w);A=tr(It,"line",{stroke:!0,x1:!0,x2:!0}),vt(A).forEach(nt);for(let zt=0;zt<it.length;zt+=1)it[zt].l(It);It.forEach(nt),I=tr(dt,"g",{transform:!0});var Wt=vt(I);for(let zt=0;zt<_t.length;zt+=1)_t[zt].l(Wt);Wt.forEach(nt),V=tr(dt,"path",{fill:!0,stroke:!0,"stroke-width":!0,d:!0}),vt(V).forEach(nt),dt.forEach(nt),Bt.forEach(nt),this.h()},h(){tt(A,"stroke","currentColor"),tt(A,"x1",C=f[5]-6),tt(A,"x2",k=f[0]-f[3]),tt(w,"transform",P="translate(0,"+(f[2]-f[4])+")"),tt(I,"transform",B="translate("+f[5]+",0)"),tt(V,"fill","none"),tt(V,"stroke",f[10]),tt(V,"stroke-width","2"),tt(V,"d",j=f[11](f[1])),tt(v,"width",f[0]),tt(v,"height",f[2]),Ql(()=>f[15].call(m))},m(ht,Bt){hi(ht,m,Bt),W(m,v),W(v,w),W(w,A);for(let dt=0;dt<it.length;dt+=1)it[dt]&&it[dt].m(w,null);W(v,I);for(let dt=0;dt<_t.length;dt+=1)_t[dt]&&_t[dt].m(I,null);W(v,V),Q=bT(m,f[15].bind(m))},p(ht,Bt){if(Bt&32&&C!==(C=ht[5]-6)&&tt(A,"x1",C),Bt&9&&k!==(k=ht[0]-ht[3])&&tt(A,"x2",k),Bt&704){et=Yn(ht[7].ticks(5));let dt;for(dt=0;dt<et.length;dt+=1){const It=Q2(ht,et,dt);it[dt]?it[dt].p(It,Bt):(it[dt]=eT(It),it[dt].c(),it[dt].m(w,null))}for(;dt<it.length;dt+=1)it[dt].d(1);it.length=et.length}if(Bt&20&&P!==(P="translate(0,"+(ht[2]-ht[4])+")")&&tt(w,"transform",P),Bt&4393){lt=Yn(ht[8].ticks(4));let dt;for(dt=0;dt<lt.length;dt+=1){const It=J2(ht,lt,dt);_t[dt]?_t[dt].p(It,Bt):(_t[dt]=nT(It),_t[dt].c(),_t[dt].m(I,null))}for(;dt<_t.length;dt+=1)_t[dt].d(1);_t.length=lt.length}Bt&32&&B!==(B="translate("+ht[5]+",0)")&&tt(I,"transform",B),Bt&1024&&tt(V,"stroke",ht[10]),Bt&2050&&j!==(j=ht[11](ht[1]))&&tt(V,"d",j),Bt&1&&tt(v,"width",ht[0]),Bt&4&&tt(v,"height",ht[2])},d(ht){ht&&nt(m),mo(it,ht),mo(_t,ht),Q()}}}function FL(f){let m=f[17]+":00",v;return{c(){v=qe(m)},l(w){v=Ze(w,m)},m(w,A){hi(w,v,A)},p(w,A){A&128&&m!==(m=w[17]+":00")&&Ai(v,m)},d(w){w&&nt(v)}}}function NL(f){let m=f[9](f[17])+"",v;return{c(){v=qe(m)},l(w){v=Ze(w,m)},m(w,A){hi(w,v,A)},p(w,A){A&640&&m!==(m=w[9](w[17])+"")&&Ai(v,m)},d(w){w&&nt(v)}}}function eT(f){let m,v,w,A,C;function k(B,V){return B[6]!="By hour (last 30 days)"?NL:FL}let P=k(f),I=P(f);return{c(){m=Qn("line"),A=Qn("text"),I.c(),this.h()},l(B){m=tr(B,"line",{stroke:!0,x1:!0,x2:!0,y1:!0,y2:!0}),vt(m).forEach(nt),A=tr(B,"text",{fill:!0,"text-anchor":!0,x:!0,y:!0});var V=vt(A);I.l(V),V.forEach(nt),this.h()},h(){tt(m,"stroke","currentColor"),tt(m,"x1",v=f[7](f[17])),tt(m,"x2",w=f[7](f[17])),tt(m,"y1",0),tt(m,"y2",6),tt(A,"fill","currentColor"),tt(A,"text-anchor","middle"),tt(A,"x",C=f[7](f[17])),tt(A,"y",22)},m(B,V){hi(B,m,V),hi(B,A,V),I.m(A,null)},p(B,V){V&128&&v!==(v=B[7](B[17]))&&tt(m,"x1",v),V&128&&w!==(w=B[7](B[17]))&&tt(m,"x2",w),P===(P=k(B))&&I?I.p(B,V):(I.d(1),I=P(B),I&&(I.c(),I.m(A,null))),V&128&&C!==(C=B[7](B[17]))&&tt(A,"x",C)},d(B){B&&(nt(m),nt(A)),I.d()}}}function iT(f){let m,v,w,A,C,k,P;return{c(){m=Qn("line"),C=Qn("line"),this.h()},l(I){m=tr(I,"line",{stroke:!0,"stroke-opacity":!0,"stroke-width":!0,x1:!0,x2:!0,y1:!0,y2:!0}),vt(m).forEach(nt),C=tr(I,"line",{stroke:!0,x1:!0,x2:!0,y1:!0,y2:!0}),vt(C).forEach(nt),this.h()},h(){tt(m,"stroke","currentColor"),tt(m,"stroke-opacity","0.1"),tt(m,"stroke-width","1.5px"),tt(m,"x1",0),tt(m,"x2",v=f[0]-f[5]-f[3]),tt(m,"y1",w=f[8](f[17])),tt(m,"y2",A=f[8](f[17])),tt(C,"stroke","currentColor"),tt(C,"x1",0),tt(C,"x2",-6),tt(C,"y1",k=f[8](f[17])),tt(C,"y2",P=f[8](f[17]))},m(I,B){hi(I,m,B),hi(I,C,B)},p(I,B){B&41&&v!==(v=I[0]-I[5]-I[3])&&tt(m,"x2",v),B&256&&w!==(w=I[8](I[17]))&&tt(m,"y1",w),B&256&&A!==(A=I[8](I[17]))&&tt(m,"y2",A),B&256&&k!==(k=I[8](I[17]))&&tt(C,"y1",k),B&256&&P!==(P=I[8](I[17]))&&tt(C,"y2",P)},d(I){I&&(nt(m),nt(C))}}}function nT(f){let m,v=f[12](f[17])+"",w,A,C=f[17]!==0&&iT(f);return{c(){C&&C.c(),m=Qn("text"),w=qe(v),this.h()},l(k){C&&C.l(k),m=tr(k,"text",{fill:!0,"text-anchor":!0,"dominant-baseline":!0,x:!0,y:!0});var P=vt(m);w=Ze(P,v),P.forEach(nt),this.h()},h(){tt(m,"fill","currentColor"),tt(m,"text-anchor","end"),tt(m,"dominant-baseline","middle"),tt(m,"x",-9),tt(m,"y",A=f[8](f[17]))},m(k,P){C&&C.m(k,P),hi(k,m,P),W(m,w)},p(k,P){k[17]!==0?C?C.p(k,P):(C=iT(k),C.c(),C.m(m.parentNode,m)):C&&(C.d(1),C=null),P&256&&v!==(v=k[12](k[17])+"")&&Ai(w,v),P&256&&A!==(A=k[8](k[17]))&&tt(m,"y",A)},d(k){k&&nt(m),C&&C.d(k)}}}function UL(f){let m,v=f[1]&&tT(f);return{c(){v&&v.c(),m=Go()},l(w){v&&v.l(w),m=Go()},m(w,A){v&&v.m(w,A),hi(w,m,A)},p(w,[A]){w[1]?v?v.p(w,A):(v=tT(w),v.c(),v.m(m.parentNode,m)):v&&(v.d(1),v=null)},i:sr,o:sr,d(w){w&&nt(m),v&&v.d(w)}}}function VL(f,m,v){let w,{data:A}=m,{height:C=200}=m,{marginTop:k=15}=m,{marginRight:P=30}=m,{marginBottom:I=30}=m,{marginLeft:B=80}=m,{ttype:V}=m,{width:j}=m,{plot_type:Q}=m,et;console.log(Q);let it=la(",.0f"),lt="",_t,ht;function Bt(){j=this.clientWidth,v(0,j)}return f.$$set=dt=>{"data"in dt&&v(1,A=dt.data),"height"in dt&&v(2,C=dt.height),"marginTop"in dt&&v(13,k=dt.marginTop),"marginRight"in dt&&v(3,P=dt.marginRight),"marginBottom"in dt&&v(4,I=dt.marginBottom),"marginLeft"in dt&&v(5,B=dt.marginLeft),"ttype"in dt&&v(14,V=dt.ttype),"width"in dt&&v(0,j=dt.width),"plot_type"in dt&&v(6,Q=dt.plot_type)},f.$$.update=()=>{f.$$.dirty&64&&(Q=="3 months"?v(9,et=nf("%b")):v(9,et=nf("%b '%y"))),f.$$.dirty&16384&&(V=="pedestrian"?v(10,lt="#374c80"):v(10,lt="#955196")),f.$$.dirty&1&&(console.log("width"),console.log(j)),f.$$.dirty&107&&(Q=="By hour (last 30 days)"?v(7,ht=og([0,23],[B,j-P])):v(7,ht=Bz(_P(A,dt=>new Date(dt.timestamp)),[B,j-P]))),f.$$.dirty&8214&&v(8,w=og([0,MP(A,dt=>dt.counts)],[C-I,k])),f.$$.dirty&448&&(Q=="By hour (last 30 days)"?v(11,_t=V2().x(dt=>ht(dt.time)).y(dt=>w(dt.counts))):v(11,_t=V2().x(dt=>ht(new Date(dt.timestamp))).y(dt=>w(dt.counts))))},[j,A,C,P,I,B,Q,ht,w,et,lt,_t,it,k,V,Bt]}class jL extends jr{constructor(m){super(),Gr(this,m,VL,UL,Vr,{data:1,height:2,marginTop:13,marginRight:3,marginBottom:4,marginLeft:5,ttype:14,width:0,plot_type:6})}}function GL(f,m,v){const w=f.slice();return w[23]=m[v],w}function qL(f){let m,v,w;return{c(){m=gt("option"),v=qe(f[23]),w=me(),this.h()},l(A){m=yt(A,"OPTION",{});var C=vt(m);v=Ze(C,f[23]),w=_e(C),C.forEach(nt),this.h()},h(){m.__value=f[23],Ha(m,m.__value)},m(A,C){hi(A,m,C),W(m,v),W(m,w)},p:sr,d(A){A&&nt(m)}}}function ZL(f){let m,v,w="fetching data...",A;return{c(){m=gt("div"),v=gt("p"),A=qe(w),this.h()},l(C){m=yt(C,"DIV",{class:!0});var k=vt(m);v=yt(k,"P",{class:!0});var P=vt(v);A=Ze(P,w),P.forEach(nt),k.forEach(nt),this.h()},h(){tt(v,"class","loc svelte-1ih4gwg"),tt(m,"class","text svelte-1ih4gwg")},m(C,k){hi(C,m,k),W(m,v),W(v,A)},p:sr,i:sr,o:sr,d(C){C&&nt(m)}}}function HL(f){let m,v;return m=new jL({props:{data:f[3],width:f[0]/2,ttype:f[4],plot_type:f[1]}}),{c(){Zi(m.$$.fragment)},l(w){Hi(m.$$.fragment,w)},m(w,A){Wi(m,w,A),v=!0},p(w,A){const C={};A&8&&(C.data=w[3]),A&1&&(C.width=w[0]/2),A&16&&(C.ttype=w[4]),A&2&&(C.plot_type=w[1]),m.$set(C)},i(w){v||(wi(m.$$.fragment,w),v=!0)},o(w){Mi(m.$$.fragment,w),v=!1},d(w){$i(m,w)}}}function WL(f){let m,v,w,A="Eco-Visio counter data",C,k,P,I,B,V,j="Counter name",Q,et,it,lt,_t,ht,Bt,dt="Daily "+(f[4]=="pedestrian"?"Pedestrians":"Cyclists"),It,Wt,zt,Zt=f[7](f[5]/30)+"",$t,G,Tt,mt,Ot,wt="Time Series",ne,ai,Re,Je,We,Pe,be=(f[4]=="pedestrian"?"Pedestrian ":"Cyclist ")+"counts",Lt,Fe,Me,Ii,Oi,Vt,Ve,rn,ae,Te,Oe,Jt="About "+XL,Xe,mi,gi,Dt,F,q,J,At=Yn(["By hour (last 30 days)","By week (last 3 months)","By week (last year)","By month (last 3 years)"]),Ct=[];for(let Xt=0;Xt<4;Xt+=1)Ct[Xt]=qL(GL(f,At,Xt));const ee=[HL,ZL],ie=[];function Pt(Xt,ue){return Xt[3].length>0?0:1}return Vt=Pt(f),Ve=ie[Vt]=ee[Vt](f),{c(){m=gt("div"),v=gt("div"),w=gt("h2"),C=qe(A),k=me(),P=gt("div"),I=gt("div"),B=gt("div"),V=gt("p"),V.textContent=j,Q=me(),et=gt("p"),it=qe(f[6]),lt=me(),_t=gt("div"),ht=gt("div"),Bt=gt("p"),It=qe(dt),Wt=me(),zt=gt("p"),$t=qe(Zt),G=me(),Tt=gt("div"),mt=gt("div"),Ot=gt("h2"),ne=qe(wt),ai=me(),Re=gt("div"),Je=gt("div"),We=gt("div"),Pe=gt("p"),Lt=qe(be),Fe=me(),Me=gt("div"),Ii=gt("select");for(let Xt=0;Xt<4;Xt+=1)Ct[Xt].c();Oi=me(),Ve.c(),rn=me(),ae=gt("div"),Te=gt("div"),Oe=gt("h2"),Xe=qe(Jt),mi=me(),gi=gt("div"),Dt=new rc(!1),this.h()},l(Xt){m=yt(Xt,"DIV",{class:!0});var ue=vt(m);v=yt(ue,"DIV",{class:!0});var de=vt(v);w=yt(de,"H2",{class:!0});var di=vt(w);C=Ze(di,A),di.forEach(nt),k=_e(de),P=yt(de,"DIV",{class:!0});var Ci=vt(P);I=yt(Ci,"DIV",{class:!0});var Xi=vt(I);B=yt(Xi,"DIV",{class:!0});var ri=vt(B);V=yt(ri,"P",{class:!0,"data-svelte-h":!0}),Ur(V)!=="svelte-1k95t8m"&&(V.textContent=j),Q=_e(ri),et=yt(ri,"P",{class:!0});var Vi=vt(et);it=Ze(Vi,f[6]),Vi.forEach(nt),ri.forEach(nt),Xi.forEach(nt),lt=_e(Ci),_t=yt(Ci,"DIV",{class:!0});var Ei=vt(_t);ht=yt(Ei,"DIV",{class:!0});var tn=vt(ht);Bt=yt(tn,"P",{class:!0});var ln=vt(Bt);It=Ze(ln,dt),ln.forEach(nt),Wt=_e(tn),zt=yt(tn,"P",{class:!0,style:!0});var hn=vt(zt);$t=Ze(hn,Zt),hn.forEach(nt),tn.forEach(nt),Ei.forEach(nt),Ci.forEach(nt),de.forEach(nt),G=_e(ue),Tt=yt(ue,"DIV",{class:!0,style:!0});var Be=vt(Tt);mt=yt(Be,"DIV",{class:!0});var Di=vt(mt);Ot=yt(Di,"H2",{class:!0});var Ji=vt(Ot);ne=Ze(Ji,wt),Ji.forEach(nt),ai=_e(Di),Re=yt(Di,"DIV",{class:!0});var Un=vt(Re);Je=yt(Un,"DIV",{class:!0});var Vn=vt(Je);We=yt(Vn,"DIV",{class:!0});var Bn=vt(We);Pe=yt(Bn,"P",{class:!0,style:!0});var xt=vt(Pe);Lt=Ze(xt,be),xt.forEach(nt),Bn.forEach(nt),Fe=_e(Vn),Me=yt(Vn,"DIV",{class:!0});var St=vt(Me);Ii=yt(St,"SELECT",{class:!0});var Rt=vt(Ii);for(let qt=0;qt<4;qt+=1)Ct[qt].l(Rt);Rt.forEach(nt),St.forEach(nt),Vn.forEach(nt),Un.forEach(nt),Oi=_e(Di),Ve.l(Di),Di.forEach(nt),Be.forEach(nt),rn=_e(ue),ae=yt(ue,"DIV",{class:!0});var Ft=vt(ae);Te=yt(Ft,"DIV",{class:!0});var Ut=vt(Te);Oe=yt(Ut,"H2",{class:!0});var Ht=vt(Oe);Xe=Ze(Ht,Jt),Ht.forEach(nt),mi=_e(Ut),gi=yt(Ut,"DIV",{class:!0});var Kt=vt(gi);Dt=oc(Kt,!1),Kt.forEach(nt),Ut.forEach(nt),Ft.forEach(nt),ue.forEach(nt),this.h()},h(){tt(w,"class","dublin-header svelte-1ih4gwg"),tt(V,"class","label svelte-1ih4gwg"),tt(et,"class","loc svelte-1ih4gwg"),tt(B,"class","text svelte-1ih4gwg"),tt(I,"class","a1 svelte-1ih4gwg"),tt(Bt,"class","label svelte-1ih4gwg"),tt(zt,"class","number svelte-1ih4gwg"),xe(zt,"color",f[4]!="pedestrian"?"#955196":"#374c80"),tt(ht,"class","text svelte-1ih4gwg"),tt(_t,"class","a1 svelte-1ih4gwg"),tt(P,"class","flex-items3 svelte-1ih4gwg"),tt(v,"class","overall2 svelte-1ih4gwg"),tt(Ot,"class","dublin-header svelte-1ih4gwg"),tt(Pe,"class","label svelte-1ih4gwg"),xe(Pe,"margin-bottom","0px"),tt(We,"class","a1 svelte-1ih4gwg"),tt(Ii,"class","sel svelte-1ih4gwg"),f[1]===void 0&&Ql(()=>f[13].call(Ii)),tt(Me,"class","a2 svelte-1ih4gwg"),tt(Je,"class","flex-items3 svelte-1ih4gwg"),tt(Re,"class","text svelte-1ih4gwg"),tt(mt,"class","text2 svelte-1ih4gwg"),tt(Tt,"class","overall2 svelte-1ih4gwg"),xe(Tt,"min-width","100px"),tt(Oe,"class","dublin-header svelte-1ih4gwg"),Dt.a=null,tt(gi,"class","number2 svelte-1ih4gwg"),tt(Te,"class","text2 svelte-1ih4gwg"),tt(ae,"class","overall2 svelte-1ih4gwg"),tt(m,"class","container svelte-1ih4gwg")},m(Xt,ue){hi(Xt,m,ue),W(m,v),W(v,w),W(w,C),W(v,k),W(v,P),W(P,I),W(I,B),W(B,V),W(B,Q),W(B,et),W(et,it),W(P,lt),W(P,_t),W(_t,ht),W(ht,Bt),W(Bt,It),W(ht,Wt),W(ht,zt),W(zt,$t),W(m,G),W(m,Tt),W(Tt,mt),W(mt,Ot),W(Ot,ne),W(mt,ai),W(mt,Re),W(Re,Je),W(Je,We),W(We,Pe),W(Pe,Lt),W(Je,Fe),W(Je,Me),W(Me,Ii);for(let de=0;de<4;de+=1)Ct[de]&&Ct[de].m(Ii,null);aa(Ii,f[1],!0),W(mt,Oi),ie[Vt].m(mt,null),W(m,rn),W(m,ae),W(ae,Te),W(Te,Oe),W(Oe,Xe),W(Te,mi),W(Te,gi),Dt.m($L,gi),F=!0,q||(J=[ur(v,"click",f[12]),ur(Ii,"change",f[13])],q=!0)},p(Xt,[ue]){(!F||ue&64)&&Ai(it,Xt[6]),(!F||ue&16)&&dt!==(dt="Daily "+(Xt[4]=="pedestrian"?"Pedestrians":"Cyclists"))&&Ai(It,dt),(!F||ue&32)&&Zt!==(Zt=Xt[7](Xt[5]/30)+"")&&Ai($t,Zt),(!F||ue&16)&&xe(zt,"color",Xt[4]!="pedestrian"?"#955196":"#374c80"),(!F||ue&16)&&be!==(be=(Xt[4]=="pedestrian"?"Pedestrian ":"Cyclist ")+"counts")&&Ai(Lt,be),ue&2&&aa(Ii,Xt[1]);let de=Vt;Vt=Pt(Xt),Vt===de?ie[Vt].p(Xt,ue):(of(),Mi(ie[de],1,1,()=>{ie[de]=null}),sf(),Ve=ie[Vt],Ve?Ve.p(Xt,ue):(Ve=ie[Vt]=ee[Vt](Xt),Ve.c()),wi(Ve,1),Ve.m(mt,null))},i(Xt){F||(wi(Ve),F=!0)},o(Xt){Mi(Ve),F=!1},d(Xt){Xt&&nt(m),mo(Ct,Xt),ie[Vt].d(),q=!1,Mu(J)}}}let $L="This is a live view of pedestrian and cycling counters in Dublin, accessed through the Eco-visio API. Click on a counter for pedestrian and/or cycling footfall over different time periods. Note: there are issues with some counters, which Eco-Visio are investigating.",XL="this data ";function rT(f){return f.reduce((v,w)=>v+w.counts,0)}function YL(f,m,v){let w,A,C;_n(f,io,G=>v(10,w=G)),_n(f,Y_,G=>v(11,A=G)),_n(f,K_,G=>v(6,C=G));let{width:k}=m,P="",I=la(",.0f");async function B(G){console.log("adding");let mt=await(await fetch("api/",{method:"POST",body:JSON.stringify({a:G}),headers:{"content-type":"application/json"}})).json();lP.set(mt),It=="By month (last 3 years)"&&zt(mt,"sixMonths_yearly",12*3),It=="By week (last year)"&&zt(mt,"sixMonths_weekly",12),It=="By week (last 3 months)"&&zt(mt,"sixMonths",3),It=="By hour (last 30 days)"&&zt(mt,"lastMonth",1)}let V;function j(G){G.forEach(Tt=>{V[Tt.timestamp]?V[Tt.timestamp].counts+=Tt.counts:V[Tt.timestamp]={...Tt}})}let Q=[],et=[],it=[],lt=[],_t={},ht="",Bt="",dt="",It="By week (last 3 months)",Wt="By week (last 3 months)";function zt(G,Tt,mt){if(Q=[],et=[],_t={},it=[],v(3,lt=[]),Tt=="lastMonth"){if(G.lastMonth.forEach(function(Ot){Ot.travelMode=="pedestrian"&&w=="walk_counter"&&(Q.push(Ot),v(4,ht=Ot.travelMode)),Ot.travelMode=="bike"&&w=="cycle_counter"&&(Q.push(Ot),v(4,ht=Ot.travelMode)),w=="active_counter"&&(Q.push(Ot),v(4,ht=Ot.travelMode))}),Q.length>0){V={},Q.forEach(function(Ot){j(Ot.data)}),it=Object.values(V),it.forEach(function(Ot){Ot.date=new Date(Ot.timestamp);let wt=Ot.date.getHours();wt in _t?_t[wt]+=Ot.counts:_t[wt]=Ot.counts});for(let Ot=0;Ot<24;Ot++)lt.push({time:Ot,counts:_t[Ot]});v(5,Bt=rT(lt)/mt)}}else G[Tt].forEach(function(Ot){Ot.travelMode=="pedestrian"&&w=="walk_counter"&&(et.push(Ot),v(4,ht=Ot.travelMode)),Ot.travelMode=="bike"&&w=="cycle_counter"&&(et.push(Ot),v(4,ht=Ot.travelMode)),w=="active_counter"&&(et.push(Ot),v(4,ht=Ot.travelMode))}),et.length>0&&(V={},console.log(et),console.log("filtData2"),et.forEach(function(Ot){j(Ot.data)}),v(3,lt=Object.values(V)),v(3,lt=et[0].data),lt.forEach(function(Ot){Ot.counts=Ot.traffic.counts})),v(5,Bt=rT(lt)/mt)}const Zt=function(){v(2,P=""),vs()};function $t(){It=Nd(this),v(1,It)}return f.$$set=G=>{"width"in G&&v(0,k=G.width)},f.$$.update=()=>{f.$$.dirty&3328&&w!=dt&&(K_.set("Grand Canal Cycle Path - Lock C5"),Y_.set("100043587"),B(A),v(8,dt=w)),f.$$.dirty&2562&&It!=Wt&&(v(3,lt=[]),B(A),v(9,Wt=It)),f.$$.dirty&2048&&B(A)},[k,It,P,lt,ht,Bt,C,I,dt,Wt,w,A,Zt,$t]}class KL extends jr{constructor(m){super(),Gr(this,m,YL,WL,Vr,{width:0})}}function JL(f){let m,v;return m=new KL({props:{width:f[2]}}),{c(){Zi(m.$$.fragment)},l(w){Hi(m.$$.fragment,w)},m(w,A){Wi(m,w,A),v=!0},p(w,A){const C={};A&4&&(C.width=w[2]),m.$set(C)},i(w){v||(wi(m.$$.fragment,w),v=!0)},o(w){Mi(m.$$.fragment,w),v=!1},d(w){$i(m,w)}}}function QL(f){let m,v;return m=new BL({}),{c(){Zi(m.$$.fragment)},l(w){Hi(m.$$.fragment,w)},m(w,A){Wi(m,w,A),v=!0},p:sr,i(w){v||(wi(m.$$.fragment,w),v=!0)},o(w){Mi(m.$$.fragment,w),v=!1},d(w){$i(m,w)}}}function tR(f){let m,v,w,A;function C(I){f[4](I)}function k(I){f[5](I)}let P={};return f[0]!==void 0&&(P.cmode=f[0]),f[1]!==void 0&&(P.dmode=f[1]),m=new IL({props:P}),sa.push(()=>$l(m,"cmode",C)),sa.push(()=>$l(m,"dmode",k)),{c(){Zi(m.$$.fragment)},l(I){Hi(m.$$.fragment,I)},m(I,B){Wi(m,I,B),A=!0},p(I,B){const V={};!v&&B&1&&(v=!0,V.cmode=I[0],Wl(()=>v=!1)),!w&&B&2&&(w=!0,V.dmode=I[1],Wl(()=>w=!1)),m.$set(V)},i(I){A||(wi(m.$$.fragment,I),A=!0)},o(I){Mi(m.$$.fragment,I),A=!1},d(I){$i(m,I)}}}function eR(f){let m,v,w,A;const C=[tR,QL,JL],k=[];function P(I,B){return I[3]=="census"?0:I[3]=="google"?1:2}return v=P(f),w=k[v]=C[v](f),{c(){m=gt("div"),w.c(),this.h()},l(I){m=yt(I,"DIV",{class:!0});var B=vt(m);w.l(B),B.forEach(nt),this.h()},h(){tt(m,"class","map-info svelte-n7gdnq")},m(I,B){hi(I,m,B),k[v].m(m,null),A=!0},p(I,[B]){let V=v;v=P(I),v===V?k[v].p(I,B):(of(),Mi(k[V],1,1,()=>{k[V]=null}),sf(),w=k[v],w?w.p(I,B):(w=k[v]=C[v](I),w.c()),wi(w,1),w.m(m,null))},i(I){A||(wi(w),A=!0)},o(I){Mi(w),A=!1},d(I){I&&nt(m),k[v].d()}}}function iR(f,m,v){let w;_n(f,$a,B=>v(3,w=B));let{cmode:A}=m,{dmode:C}=m,{width:k}=m;function P(B){A=B,v(0,A)}function I(B){C=B,v(1,C)}return f.$$set=B=>{"cmode"in B&&v(0,A=B.cmode),"dmode"in B&&v(1,C=B.dmode),"width"in B&&v(2,k=B.width)},[A,C,k,w,P,I]}class nR extends jr{constructor(m){super(),Gr(this,m,iR,eR,Vr,{cmode:0,dmode:1,width:2})}}function oT(f,m,v){const w=f.slice();return w[8]=m[v],w[10]=v,w}function sT(f,m,v){const w=f.slice();return w[11]=m[v],w[10]=v,w}function aT(f){let m,v,w,A,C,k,P,I,B=Yn(f[3]),V=[];for(let et=0;et<B.length;et+=1)V[et]=lT(sT(f,B,et));let j=Yn(f[1]),Q=[];for(let et=0;et<j.length;et+=1)Q[et]=cT(oT(f,j,et));return{c(){m=gt("div"),v=gt("div"),w=gt("div"),A=qe(f[2]),C=me(),k=gt("div");for(let et=0;et<V.length;et+=1)V[et].c();P=me(),I=gt("div");for(let et=0;et<Q.length;et+=1)Q[et].c();this.h()},l(et){m=yt(et,"DIV",{class:!0});var it=vt(m);v=yt(it,"DIV",{class:!0});var lt=vt(v);w=yt(lt,"DIV",{class:!0,style:!0});var _t=vt(w);A=Ze(_t,f[2]),_t.forEach(nt),C=_e(lt),k=yt(lt,"DIV",{class:!0});var ht=vt(k);for(let dt=0;dt<V.length;dt+=1)V[dt].l(ht);ht.forEach(nt),P=_e(lt),I=yt(lt,"DIV",{class:!0});var Bt=vt(I);for(let dt=0;dt<Q.length;dt+=1)Q[dt].l(Bt);Bt.forEach(nt),lt.forEach(nt),it.forEach(nt),this.h()},h(){tt(w,"class","title svelte-1t60hze"),xe(w,"text-align","center"),tt(k,"class","legend-colors svelte-1t60hze"),tt(I,"class","legend-labels svelte-1t60hze"),tt(v,"class","inside svelte-1t60hze"),tt(m,"class","container open svelte-1t60hze")},m(et,it){hi(et,m,it),W(m,v),W(v,w),W(w,A),W(v,C),W(v,k);for(let lt=0;lt<V.length;lt+=1)V[lt]&&V[lt].m(k,null);W(v,P),W(v,I);for(let lt=0;lt<Q.length;lt+=1)Q[lt]&&Q[lt].m(I,null)},p(et,it){if(it&4&&Ai(A,et[2]),it&74){B=Yn(et[3]);let lt;for(lt=0;lt<B.length;lt+=1){const _t=sT(et,B,lt);V[lt]?V[lt].p(_t,it):(V[lt]=lT(_t),V[lt].c(),V[lt].m(k,null))}for(;lt<V.length;lt+=1)V[lt].d(1);V.length=B.length}if(it&50){j=Yn(et[1]);let lt;for(lt=0;lt<j.length;lt+=1){const _t=oT(et,j,lt);Q[lt]?Q[lt].p(_t,it):(Q[lt]=cT(_t),Q[lt].c(),Q[lt].m(I,null))}for(;lt<Q.length;lt+=1)Q[lt].d(1);Q.length=j.length}},d(et){et&&nt(m),mo(V,et),mo(Q,et)}}}function lT(f){let m,v,w;return{c(){m=gt("div"),v=me(),w=gt("div"),this.h()},l(A){m=yt(A,"DIV",{class:!0}),vt(m).forEach(nt),v=_e(A),w=yt(A,"DIV",{class:!0,style:!0}),vt(w).forEach(nt),this.h()},h(){tt(m,"class","tick svelte-1t60hze"),tt(w,"class","square svelte-1t60hze"),xe(w,"background-color",f[11]),xe(w,"width",f[6](f[1],f[10])+"%")},m(A,C){hi(A,m,C),hi(A,v,C),hi(A,w,C)},p(A,C){C&8&&xe(w,"background-color",A[11]),C&2&&xe(w,"width",A[6](A[1],A[10])+"%")},d(A){A&&(nt(m),nt(v),nt(w))}}}function rR(f){let m,v=f[4](f[8])+"",w,A=`${f[5](f[1],f[10])}%`;return{c(){m=gt("div"),w=qe(v),this.h()},l(C){m=yt(C,"DIV",{class:!0});var k=vt(m);w=Ze(k,v),k.forEach(nt),this.h()},h(){tt(m,"class","label first svelte-1t60hze"),xe(m,"left",A)},m(C,k){hi(C,m,k),W(m,w)},p(C,k){k&2&&v!==(v=C[4](C[8])+"")&&Ai(w,v),k&2&&A!==(A=`${C[5](C[1],C[10])}%`)&&xe(m,"left",A)},d(C){C&&nt(m)}}}function cT(f){let m,v=f[10]%2==0&&rR(f);return{c(){v&&v.c(),m=Go()},l(w){v&&v.l(w),m=Go()},m(w,A){v&&v.m(w,A),hi(w,m,A)},p(w,A){w[10]%2==0&&v.p(w,A)},d(w){w&&nt(m),v&&v.d(w)}}}function oR(f){let m,v=f[0]<99&&aT(f);return{c(){v&&v.c(),m=Go()},l(w){v&&v.l(w),m=Go()},m(w,A){v&&v.m(w,A),hi(w,m,A)},p(w,[A]){w[0]<99?v?v.p(w,A):(v=aT(w),v.c(),v.m(m.parentNode,m)):v&&(v.d(1),v=null)},i:sr,o:sr,d(w){w&&nt(m),v&&v.d(w)}}}function sR(f,m,v){let w,A,C,k;_n(f,lL,j=>v(7,w=j)),_n(f,sL,j=>v(1,A=j)),_n(f,bg,j=>v(2,C=j)),_n(f,aL,j=>v(3,k=j));let P;function I(j){return w.format(j)}function B(j,Q){return Q==0?0:Q==j.length-1?100:(j[Q]-j[0])/P*100}function V(j,Q){return(j[Q]-j[Q-1])/P*100}return f.$$.update=()=>{f.$$.dirty&3&&(_s($a)!="temp"?v(0,P=A[A.length-1]-A[0]):v(0,P=99),console.log("range"),console.log(P))},[P,A,C,k,I,B,V]}class aR extends jr{constructor(m){super(),Gr(this,m,sR,oR,Vr,{})}}function uT(f,m,v){const w=f.slice();return w[18]=m[v],w}function hT(f,m,v){const w=f.slice();return w[18]=m[v],w}function dT(f,m,v){const w=f.slice();return w[18]=m[v],w}function fT(f){let m,v=f[18]+"",w,A,C;return{c(){m=gt("option"),w=qe(v),A=me(),this.h()},l(k){m=yt(k,"OPTION",{});var P=vt(m);w=Ze(P,v),A=_e(P),P.forEach(nt),this.h()},h(){m.__value=C=f[18],Ha(m,m.__value)},m(k,P){hi(k,m,P),W(m,w),W(m,A)},p(k,P){P&128&&v!==(v=k[18]+"")&&Ai(w,v),P&128&&C!==(C=k[18])&&(m.__value=C,Ha(m,m.__value))},d(k){k&&nt(m)}}}function pT(f){let m,v,w,A,C,k,P,I,B,V=Yn(f[9]),j=[];for(let it=0;it<V.length;it+=1)j[it]=mT(hT(f,V,it));let Q=Yn(f[10]),et=[];for(let it=0;it<Q.length;it+=1)et[it]=_T(uT(f,Q,it));return{c(){m=gt("br"),v=me(),w=gt("select");for(let it=0;it<j.length;it+=1)j[it].c();A=me(),C=gt("br"),k=me(),P=gt("select");for(let it=0;it<et.length;it+=1)et[it].c();this.h()},l(it){m=yt(it,"BR",{}),v=_e(it),w=yt(it,"SELECT",{class:!0});var lt=vt(w);for(let ht=0;ht<j.length;ht+=1)j[ht].l(lt);lt.forEach(nt),A=_e(it),C=yt(it,"BR",{}),k=_e(it),P=yt(it,"SELECT",{class:!0});var _t=vt(P);for(let ht=0;ht<et.length;ht+=1)et[ht].l(_t);_t.forEach(nt),this.h()},h(){tt(w,"class","sel svelte-10w3r3e"),f[0]===void 0&&Ql(()=>f[13].call(w)),tt(P,"class","sel svelte-10w3r3e"),f[1]===void 0&&Ql(()=>f[14].call(P))},m(it,lt){hi(it,m,lt),hi(it,v,lt),hi(it,w,lt);for(let _t=0;_t<j.length;_t+=1)j[_t]&&j[_t].m(w,null);aa(w,f[0],!0),hi(it,A,lt),hi(it,C,lt),hi(it,k,lt),hi(it,P,lt);for(let _t=0;_t<et.length;_t+=1)et[_t]&&et[_t].m(P,null);aa(P,f[1],!0),I||(B=[ur(w,"change",f[13]),ur(P,"change",f[14])],I=!0)},p(it,lt){if(lt&512){V=Yn(it[9]);let _t;for(_t=0;_t<V.length;_t+=1){const ht=hT(it,V,_t);j[_t]?j[_t].p(ht,lt):(j[_t]=mT(ht),j[_t].c(),j[_t].m(w,null))}for(;_t<j.length;_t+=1)j[_t].d(1);j.length=V.length}if(lt&513&&aa(w,it[0]),lt&1024){Q=Yn(it[10]);let _t;for(_t=0;_t<Q.length;_t+=1){const ht=uT(it,Q,_t);et[_t]?et[_t].p(ht,lt):(et[_t]=_T(ht),et[_t].c(),et[_t].m(P,null))}for(;_t<et.length;_t+=1)et[_t].d(1);et.length=Q.length}lt&1026&&aa(P,it[1])},d(it){it&&(nt(m),nt(v),nt(w),nt(A),nt(C),nt(k),nt(P)),mo(j,it),mo(et,it),I=!1,Mu(B)}}}function mT(f){let m,v=f[18]+"",w,A,C;return{c(){m=gt("option"),w=qe(v),A=me(),this.h()},l(k){m=yt(k,"OPTION",{});var P=vt(m);w=Ze(P,v),A=_e(P),P.forEach(nt),this.h()},h(){m.__value=C=f[18],Ha(m,m.__value)},m(k,P){hi(k,m,P),W(m,w),W(m,A)},p(k,P){P&512&&v!==(v=k[18]+"")&&Ai(w,v),P&512&&C!==(C=k[18])&&(m.__value=C,Ha(m,m.__value))},d(k){k&&nt(m)}}}function _T(f){let m,v=f[18]+"",w,A,C;return{c(){m=gt("option"),w=qe(v),A=me(),this.h()},l(k){m=yt(k,"OPTION",{});var P=vt(m);w=Ze(P,v),A=_e(P),P.forEach(nt),this.h()},h(){m.__value=C=f[18],Ha(m,m.__value)},m(k,P){hi(k,m,P),W(m,w),W(m,A)},p(k,P){P&1024&&v!==(v=k[18]+"")&&Ai(w,v),P&1024&&C!==(C=k[18])&&(m.__value=C,Ha(m,m.__value))},d(k){k&&nt(m)}}}function gT(f){let m,v,w,A;return w=new aR({}),{c(){m=gt("div"),v=gt("div"),Zi(w.$$.fragment),this.h()},l(C){m=yt(C,"DIV",{class:!0});var k=vt(m);v=yt(k,"DIV",{class:!0});var P=vt(v);Hi(w.$$.fragment,P),P.forEach(nt),k.forEach(nt),this.h()},h(){tt(v,"class","legend-box svelte-10w3r3e"),tt(m,"class","toggle-box svelte-10w3r3e")},m(C,k){hi(C,m,k),W(m,v),Wi(w,v,null),A=!0},i(C){A||(wi(w.$$.fragment,C),A=!0)},o(C){Mi(w.$$.fragment,C),A=!1},d(C){C&&nt(m),$i(w)}}}function lR(f){let m,v,w,A,C,k,P,I,B,V,j,Q,et,it,lt="Show bike lanes ",_t,ht,Bt,dt,It,Wt,zt,Zt=Yn(f[7]),$t=[];for(let mt=0;mt<Zt.length;mt+=1)$t[mt]=fT(dT(f,Zt,mt));let G=f[8]=="census"&&pT(f),Tt=f[2]!="temp"&&gT();return{c(){m=gt("div"),v=gt("div"),w=me(),A=gt("div"),C=gt("h2"),k=qe(f[5]),P=me(),I=gt("div"),B=gt("select");for(let mt=0;mt<$t.length;mt+=1)$t[mt].c();V=me(),G&&G.c(),j=me(),Q=gt("br"),et=me(),it=gt("label"),_t=qe(lt),ht=me(),Bt=gt("input"),dt=me(),Tt&&Tt.c(),this.h()},l(mt){m=yt(mt,"DIV",{class:!0});var Ot=vt(m);v=yt(Ot,"DIV",{id:!0,class:!0}),vt(v).forEach(nt),w=_e(Ot),A=yt(Ot,"DIV",{class:!0});var wt=vt(A);C=yt(wt,"H2",{class:!0});var ne=vt(C);k=Ze(ne,f[5]),ne.forEach(nt),wt.forEach(nt),P=_e(Ot),I=yt(Ot,"DIV",{class:!0});var ai=vt(I);B=yt(ai,"SELECT",{class:!0});var Re=vt(B);for(let We=0;We<$t.length;We+=1)$t[We].l(Re);Re.forEach(nt),V=_e(ai),G&&G.l(ai),j=_e(ai),Q=yt(ai,"BR",{}),et=_e(ai),it=yt(ai,"LABEL",{class:!0});var Je=vt(it);_t=Ze(Je,lt),Je.forEach(nt),ht=_e(ai),Bt=yt(ai,"INPUT",{type:!0,class:!0}),ai.forEach(nt),dt=_e(Ot),Tt&&Tt.l(Ot),Ot.forEach(nt),this.h()},h(){tt(v,"id","mapbox-map"),tt(v,"class","svelte-10w3r3e"),tt(C,"class","dublin-header svelte-10w3r3e"),tt(A,"class","top-banner svelte-10w3r3e"),tt(B,"class","sel svelte-10w3r3e"),f[6]===void 0&&Ql(()=>f[12].call(B)),tt(it,"class","check svelte-10w3r3e"),tt(Bt,"type","checkbox"),tt(Bt,"class","box svelte-10w3r3e"),tt(I,"class","toggles svelte-10w3r3e"),tt(m,"class","im-the-map-box svelte-10w3r3e")},m(mt,Ot){hi(mt,m,Ot),W(m,v),f[11](v),W(m,w),W(m,A),W(A,C),W(C,k),W(m,P),W(m,I),W(I,B);for(let wt=0;wt<$t.length;wt+=1)$t[wt]&&$t[wt].m(B,null);aa(B,f[6],!0),W(I,V),G&&G.m(I,null),W(I,j),W(I,Q),W(I,et),W(I,it),W(it,_t),W(I,ht),W(I,Bt),Bt.checked=f[3],W(m,dt),Tt&&Tt.m(m,null),It=!0,Wt||(zt=[ur(B,"change",f[12]),ur(Bt,"change",f[15])],Wt=!0)},p(mt,[Ot]){if((!It||Ot&32)&&Ai(k,mt[5]),Ot&128){Zt=Yn(mt[7]);let wt;for(wt=0;wt<Zt.length;wt+=1){const ne=dT(mt,Zt,wt);$t[wt]?$t[wt].p(ne,Ot):($t[wt]=fT(ne),$t[wt].c(),$t[wt].m(B,null))}for(;wt<$t.length;wt+=1)$t[wt].d(1);$t.length=Zt.length}Ot&192&&aa(B,mt[6]),mt[8]=="census"?G?G.p(mt,Ot):(G=pT(mt),G.c(),G.m(I,j)):G&&(G.d(1),G=null),Ot&8&&(Bt.checked=mt[3]),mt[2]!="temp"?Tt?Ot&4&&wi(Tt,1):(Tt=gT(),Tt.c(),wi(Tt,1),Tt.m(m,null)):Tt&&(of(),Mi(Tt,1,1,()=>{Tt=null}),sf())},i(mt){It||(wi(Tt),It=!0)},o(mt){Mi(Tt),It=!1},d(mt){mt&&nt(m),f[11](null),mo($t,mt),G&&G.d(),Tt&&Tt.d(),Wt=!1,Mu(zt)}}}function cR(f,m,v){let w,A,C,k,P,I,B;_n(f,lg,It=>v(16,w=It)),_n(f,bg,It=>v(5,A=It)),_n(f,sg,It=>v(6,C=It)),_n(f,iL,It=>v(7,k=It)),_n(f,$a,It=>v(8,P=It)),_n(f,rL,It=>v(9,I=It)),_n(f,oL,It=>v(10,B=It));let{selected:V}=m,{cmode:j}=m,{dmode:Q}=m,et=!1,it;xT(()=>{sP(lg,w=pL(it),w),w.onLoad()});function lt(It){sa[It?"unshift":"push"](()=>{it=It,v(4,it)})}function _t(){C=Nd(this),sg.set(C)}function ht(){j=Nd(this),v(0,j)}function Bt(){Q=Nd(this),v(1,Q)}function dt(){et=this.checked,v(3,et)}return f.$$set=It=>{"selected"in It&&v(2,V=It.selected),"cmode"in It&&v(0,j=It.cmode),"dmode"in It&&v(1,Q=It.dmode)},f.$$.update=()=>{f.$$.dirty&8&&(TT.set(et),mL())},[j,Q,V,et,it,A,C,k,P,I,B,lt,_t,ht,Bt,dt]}class uR extends jr{constructor(m){super(),Gr(this,m,cR,lR,Vr,{selected:2,cmode:0,dmode:1})}}function yT(f,m,v){const w=f.slice();return w[5]=m[v],w[7]=v,w}function vT(f){let m,v,w=f[5].label+"",A,C,k,P;return{c(){m=gt("li"),v=gt("span"),A=qe(w),C=me(),this.h()},l(I){m=yt(I,"LI",{style:!0,class:!0});var B=vt(m);v=yt(B,"SPAN",{class:!0});var V=vt(v);A=Ze(V,w),V.forEach(nt),C=_e(B),B.forEach(nt),this.h()},h(){tt(v,"class","svelte-zsfq7n"),xe(m,"color",f[2]==f[5].value?"white":"#A2B7C4"),tt(m,"class","svelte-zsfq7n")},m(I,B){hi(I,m,B),W(m,v),W(v,A),W(m,C),k||(P=ur(m,"click",function(){aP(f[3](f[5]))&&f[3](f[5]).apply(this,arguments)}),k=!0)},p(I,B){f=I,B&2&&w!==(w=f[5].label+"")&&Ai(A,w),B&6&&xe(m,"color",f[2]==f[5].value?"white":"#A2B7C4")},d(I){I&&nt(m),k=!1,P()}}}function hR(f){let m,v,w,A=f[0]?"&#9204;":"&#8801",C,k,P=f[0]?"":"DATA",I,B,V,j,Q,et="Data source",it,lt,_t,ht,Bt,dt=Yn(f[1]),It=[];for(let Wt=0;Wt<dt.length;Wt+=1)It[Wt]=vT(yT(f,dt,Wt));return{c(){m=gt("nav"),v=gt("button"),w=new rc(!1),C=me(),k=gt("span"),I=qe(P),B=me(),V=gt("section"),j=gt("ul"),Q=gt("h3"),Q.textContent=et,it=me(),lt=gt("hr"),_t=me();for(let Wt=0;Wt<It.length;Wt+=1)It[Wt].c();this.h()},l(Wt){m=yt(Wt,"NAV",{class:!0});var zt=vt(m);v=yt(zt,"BUTTON",{class:!0});var Zt=vt(v);w=oc(Zt,!1),C=_e(Zt),k=yt(Zt,"SPAN",{style:!0});var $t=vt(k);I=Ze($t,P),$t.forEach(nt),Zt.forEach(nt),B=_e(zt),V=yt(zt,"SECTION",{class:!0});var G=vt(V);j=yt(G,"UL",{class:!0});var Tt=vt(j);Q=yt(Tt,"H3",{class:!0,"data-svelte-h":!0}),Ur(Q)!=="svelte-11492ot"&&(Q.textContent=et),it=_e(Tt),lt=yt(Tt,"HR",{class:!0}),_t=_e(Tt);for(let mt=0;mt<It.length;mt+=1)It[mt].l(Tt);Tt.forEach(nt),G.forEach(nt),zt.forEach(nt),this.h()},h(){w.a=C,xe(k,"padding","none"),xe(k,"font-size","16px"),xe(k,"font-weight","100"),tt(v,"class","svelte-zsfq7n"),tt(Q,"class","svelte-zsfq7n"),tt(lt,"class","svelte-zsfq7n"),tt(j,"class","svelte-zsfq7n"),tt(V,"class","non-essential svelte-zsfq7n"),tt(m,"class","svelte-zsfq7n"),or(m,"expanded",f[0])},m(Wt,zt){hi(Wt,m,zt),W(m,v),w.m(A,v),W(v,C),W(v,k),W(k,I),W(m,B),W(m,V),W(V,j),W(j,Q),W(j,it),W(j,lt),W(j,_t);for(let Zt=0;Zt<It.length;Zt+=1)It[Zt]&&It[Zt].m(j,null);ht||(Bt=ur(v,"click",f[4]),ht=!0)},p(Wt,[zt]){if(zt&1&&A!==(A=Wt[0]?"&#9204;":"&#8801")&&w.p(A),zt&1&&P!==(P=Wt[0]?"":"DATA")&&Ai(I,P),zt&14){dt=Yn(Wt[1]);let Zt;for(Zt=0;Zt<dt.length;Zt+=1){const $t=yT(Wt,dt,Zt);It[Zt]?It[Zt].p($t,zt):(It[Zt]=vT($t),It[Zt].c(),It[Zt].m(j,null))}for(;Zt<It.length;Zt+=1)It[Zt].d(1);It.length=dt.length}zt&1&&or(m,"expanded",Wt[0])},i:sr,o:sr,d(Wt){Wt&&nt(m),mo(It,Wt),ht=!1,Bt()}}}function dR(f,m,v){let w,A;_n(f,nL,I=>v(1,w=I)),_n(f,$a,I=>v(2,A=I));let C=!1;const k=function(I){$a.set(I.value)},P=I=>v(0,C=!C);return setTimeout(()=>{v(0,C=!0)},1e3),[C,w,A,k,P]}class fR extends jr{constructor(m){super(),Gr(this,m,dR,hR,Vr,{})}}function pR(f){let m,v,w,A,C,k,P,I,B,V,j,Q,et,it,lt="Dublin Active Travel",_t,ht,Bt;v=new fR({});function dt(G){f[7](G)}function It(G){f[8](G)}let Wt={selected:f[1]};f[2]!==void 0&&(Wt.cmode=f[2]),f[3]!==void 0&&(Wt.dmode=f[3]),k=new uR({props:Wt}),sa.push(()=>$l(k,"cmode",dt)),sa.push(()=>$l(k,"dmode",It));function zt(G){f[9](G)}function Zt(G){f[10](G)}let $t={width:f[0]};return f[2]!==void 0&&($t.cmode=f[2]),f[3]!==void 0&&($t.dmode=f[3]),V=new nR({props:$t}),sa.push(()=>$l(V,"cmode",zt)),sa.push(()=>$l(V,"dmode",Zt)),{c(){m=gt("main"),Zi(v.$$.fragment),w=me(),A=gt("div"),C=gt("div"),Zi(k.$$.fragment),B=me(),Zi(V.$$.fragment),et=me(),it=gt("div"),_t=qe(lt),this.h()},l(G){m=yt(G,"MAIN",{class:!0});var Tt=vt(m);Hi(v.$$.fragment,Tt),w=_e(Tt),A=yt(Tt,"DIV",{class:!0});var mt=vt(A);C=yt(mt,"DIV",{class:!0});var Ot=vt(C);Hi(k.$$.fragment,Ot),B=_e(Ot),Hi(V.$$.fragment,Ot),Ot.forEach(nt),et=_e(mt),it=yt(mt,"DIV",{class:!0});var wt=vt(it);_t=Ze(wt,lt),wt.forEach(nt),mt.forEach(nt),Tt.forEach(nt),this.h()},h(){tt(C,"class","map-element svelte-159qbyu"),tt(it,"class","dashboard-title svelte-159qbyu"),tt(A,"class","container svelte-159qbyu"),Ql(()=>f[11].call(A)),tt(m,"class","svelte-159qbyu")},m(G,Tt){hi(G,m,Tt),Wi(v,m,null),W(m,w),W(m,A),W(A,C),Wi(k,C,null),W(C,B),Wi(V,C,null),W(A,et),W(A,it),W(it,_t),ht=bT(A,f[11].bind(A)),Bt=!0},p(G,[Tt]){const mt={};Tt&2&&(mt.selected=G[1]),!P&&Tt&4&&(P=!0,mt.cmode=G[2],Wl(()=>P=!1)),!I&&Tt&8&&(I=!0,mt.dmode=G[3],Wl(()=>I=!1)),k.$set(mt);const Ot={};Tt&1&&(Ot.width=G[0]),!j&&Tt&4&&(j=!0,Ot.cmode=G[2],Wl(()=>j=!1)),!Q&&Tt&8&&(Q=!0,Ot.dmode=G[3],Wl(()=>Q=!1)),V.$set(Ot)},i(G){Bt||(wi(v.$$.fragment,G),wi(k.$$.fragment,G),wi(V.$$.fragment,G),Bt=!0)},o(G){Mi(v.$$.fragment,G),Mi(k.$$.fragment,G),Mi(V.$$.fragment,G),Bt=!1},d(G){G&&nt(m),$i(v),$i(k),$i(V),ht()}}}function mR(f,m,v){let w,A,C,k,P,I;_n(f,lg,lt=>v(4,w=lt)),_n(f,XT,lt=>v(5,A=lt)),_n(f,io,lt=>v(6,C=lt)),_n(f,$a,lt=>v(1,k=lt)),_n(f,jd,lt=>v(2,P=lt)),_n(f,Gd,lt=>v(3,I=lt));let B=0;function V(lt){P=lt,jd.set(P)}function j(lt){I=lt,Gd.set(I)}function Q(lt){P=lt,jd.set(P)}function et(lt){I=lt,Gd.set(I)}function it(){B=this.clientWidth,v(0,B)}return f.$$.update=()=>{f.$$.dirty&112&&C&&w!=null&&A!=null&&(tc.set("999999"),w.changeActiveLayer(C,A),w.resetMap())},[B,k,P,I,w,A,C,V,j,Q,et,it]}class _R extends jr{constructor(m){super(),Gr(this,m,mR,pR,Vr,{})}}function gR(f){let m,v;return m=new _R({}),{c(){Zi(m.$$.fragment)},l(w){Hi(m.$$.fragment,w)},m(w,A){Wi(m,w,A),v=!0},p:sr,i(w){v||(wi(m.$$.fragment,w),v=!0)},o(w){Mi(m.$$.fragment,w),v=!1},d(w){$i(m,w)}}}function yR(f,m,v){let{data:w}=m,A=[],C;const k=async()=>{const P=await fetch("/census_data_total.json");P.ok?(C=await P.json(),cP.set(C.features)):console.error("Failed to fetch the JSON file");const I=await fetch("/sums.json");I.ok?(C=await I.json(),MT.set(C.Census[0]),ET.set(C.Google[0])):console.error("Failed to fetch the second JSON file")};return xT(function(){k(),w.traffic&&(console.log(w),w.traffic.forEach(P=>{if(P.value){let I=w.sites.filter(function(V){return V.id==P.siteId})[0],B={mode:P.travelMode,value:P.value,lat:I.location.lat,lon:I.location.lon,name:I.name,id:I.id};A.push(B)}})),wT.set(A)}),f.$$set=P=>{"data"in P&&v(0,w=P.data)},[w]}class wR extends jr{constructor(m){super(),Gr(this,m,yR,gR,Vr,{data:0})}}export{wR as component};
